<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="As JavaScript began to be used to add more and more functionality to web applications, an important limitation began to appear. When the JavaScript interpreter is working on a big task, it stays in the event loop a long time, and does not pull events from the event queue. The result is the browser stops responding to user events… and seems to be frozen. On the other hand - some programs will never end."><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Web Workers :: CIS 526 Textbook"><meta name=twitter:description content="As JavaScript began to be used to add more and more functionality to web applications, an important limitation began to appear. When the JavaScript interpreter is working on a big task, it stays in the event loop a long time, and does not pull events from the event queue. The result is the browser stops responding to user events… and seems to be frozen. On the other hand - some programs will never end."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/03-asynchronous-js/05-web-workers/embed.html"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Web Workers :: CIS 526 Textbook"><meta property="og:description" content="As JavaScript began to be used to add more and more functionality to web applications, an important limitation began to appear. When the JavaScript interpreter is working on a big task, it stays in the event loop a long time, and does not pull events from the event queue. The result is the browser stops responding to user events… and seems to be frozen. On the other hand - some programs will never end."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="Asynchronous JavaScript"><meta property="article:published_time" content="2018-08-24T10:53:26-05:00"><meta property="article:modified_time" content="2025-01-27T10:26:10-06:00"><meta itemprop=name content="Web Workers :: CIS 526 Textbook"><meta itemprop=description content="As JavaScript began to be used to add more and more functionality to web applications, an important limitation began to appear. When the JavaScript interpreter is working on a big task, it stays in the event loop a long time, and does not pull events from the event queue. The result is the browser stops responding to user events… and seems to be frozen. On the other hand - some programs will never end."><meta itemprop=datePublished content="2018-08-24T10:53:26-05:00"><meta itemprop=dateModified content="2025-01-27T10:26:10-06:00"><meta itemprop=wordCount content="1241"><title>Web Workers :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/03-asynchronous-js/05-web-workers/ rel=canonical type=text/html title="Web Workers :: CIS 526 Textbook"><link href=/cis526/03-asynchronous-js/05-web-workers/index.xml rel=alternate type=application/rss+xml title="Web Workers :: CIS 526 Textbook"><link href=/cis526/03-asynchronous-js/05-web-workers/index.print.html rel=alternate type=text/html title="Web Workers :: CIS 526 Textbook"><link href=/cis526/03-asynchronous-js/05-web-workers/tele.html rel=alternate type=text/html title="Web Workers :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1744393792 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1744393792 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1744393792 rel=stylesheet><link href=/cis526/css/auto-complete.css?1744393792 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1744393792 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1744393792 rel=stylesheet><link href=/cis526/css/fonts.css?1744393792 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1744393792 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1744393792 rel=stylesheet><link href=/cis526/css/theme-light-theme.css?1744393792 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-relearn-light.css?1744393792 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1744393792 rel=stylesheet><link href=/cis526/css/print.css?1744393792 rel=stylesheet media=print><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../..",window.relearn.relBaseUri="../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["light-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1744393792 rel=stylesheet></head><body class="mobile-support embed disableInlineCopyToClipboard" data-url=/cis526/03-asynchronous-js/05-web-workers/embed.html><div id=R-body class=default-animation><div id=R-body-overlay></div><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><p>As JavaScript began to be used to add more and more functionality to web applications, an important limitation began to appear. When the JavaScript interpreter is working on a big task, it stays in the event loop a long time, and does not pull events from the event queue. The result is the browser stops responding to user events&mldr; and seems to be frozen. On the other hand - some programs will <em>never</em> end. Consider this one:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;thinking...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>This loop has no possible exit condition, so if you ran it in the browser, it would run infinitely long&mldr; and the page would never respond to user input, because you&rsquo;d never pull any events of the event queue. One of the important discoveries in computer science, the <a href=https://en.wikipedia.org/wiki/Halting_problem rel=external target=_blank>Halting Problem</a> tackles exactly this issue - and Alan Turing&rsquo;s proof shows that a program to determine if another program will halt for all possible programs <em>cannot</em> be written.</p><p>Thus, browsers instead post warning messages after execution has run for a significant amount of time, like this one:</p><p><a href=#R-image-cfd3b9760b03648958adaca855ffc5d6 class=lightbox-link><img alt="The Chrome not responding dialog" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/3.5.1.jpg style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-cfd3b9760b03648958adaca855ffc5d6><img alt="The Chrome not responding dialog" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/3.5.1.jpg></a></p><p>So, if we want to do a long-running computation, and <em>not</em> have the browser freeze up, we needed to be able to run it separately from the thread our event loop is running on. The <a href=https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers rel=external target=_blank>web worker</a> provides just this functionality.</p><p>A web worker is essentially another JavaScript interpreter, running a script separate from the main thread. As an interpreter, it has its own event loop and its own memory space. Workers and the main thread can communicate by passing messages, which are copied onto their respective event queues. Thus, communication between the threads is <em>asynchronous</em>.</p><p><a href=#R-image-b45aefabd81f10ca4afc0c08fc1582f1 class=lightbox-link><img alt="The web worker and main thread interpreters passing messages" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/3.5.2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b45aefabd81f10ca4afc0c08fc1582f1><img alt="The web worker and main thread interpreters passing messages" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/3.5.2.png></a></p><h2 id=an-example>An Example</h2><p>You can see an example of such a web worker by using <a href=../../examples/3.5.1/index.html target=_blank>this link</a> to open another tab in your browser. This example simulates a long-running process of <strong>n</strong> seconds either in the browser&rsquo;s main thread or in a web worker. On the page is also three colored squares that when clicked, shift colors. Try changing the colors of the squares while simulating a several-second process in both ways. See how running the process on the main thread freezes the user interface?</p><h2 id=using-web-workers>Using Web Workers</h2><p>Web workers are actually very easy to use. A web worker is created by constructing a <a href=https://developer.mozilla.org/en-US/docs/Web/API/Worker rel=external target=_blank>Worker</a> object. It takes a single argument - the JavaScript file it will execute (which should be hosted on the same server). In the example, this is done with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Set up the web worker
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Worker</span><span class=p>(</span><span class=s1>&#39;stall.js&#39;</span><span class=p>);</span></span></span></code></pre></div><p>The <em>stall.js</em> file contains the script the worker will execute - we&rsquo;ll take a look at it in a minute.</p><p>Once created, you can attach a listener to the <code>Worker</code>. It has two events:</p><ul><li><code>message</code> - a deserialized message sent from the web worker</li><li><code>mesageerror</code> - a message sent from the web worker that was not serializable</li></ul><p>You can use <code>worker.addEventListener()</code> to add these, or you can assign your event listener to the event handler properties. Those properties are:</p><ul><li><code>Worker.onmessage</code> - triggered when the <code>message</code> event happens</li><li><code>Worker.onmessageerror</code> - triggered when the <code>messageerror</code> event happens</li></ul><p>Additionally, there is an error handler property:</p><ul><li><code>Worker.onerror</code></li></ul><p>Which triggers when an uncaught error occurs on the web worker.</p><p>In our example, we listen for messages using the <code>Worker.onmessage</code> property:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Set up message listener
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>worker</span><span class=p>.</span><span class=nx>onmessage</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Signal completion
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s1>&#39;#calculation-message&#39;</span><span class=p>).</span><span class=nx>textContent</span> <span class=o>=</span> <span class=sb>`Calculation complete!`</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>If the message was successfully deserialized, it&rsquo;s <code>data</code> property contains the content of the message, which can be any valid JavaScript value (an int, string, array, object, etc). This gives us a great deal of flexibility. If you need to send more than one type of message, a common strategy is to send a JavaScript object with a type property, and additional properties as needed, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>messageData1</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;greeting&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>body</span><span class=o>:</span> <span class=s2>&#34;Hello!  It&#39;s good to see you.&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>messageData2</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;set-color&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>color</span><span class=o>:</span> <span class=s2>&#34;#ffaacc&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>We can send messages <em>to</em> the web worker with <a href=https://developer.mozilla.org/en-US/docs/Web/API/Worker/postMessage rel=external target=_blank>Worker.postMessage()</a>. Again, these messages can be any valid JavaScript value:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=s2>&#34;Foo&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>({</span><span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;greetings&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=o>:</span> <span class=s2>&#34;Take me to your leader!&#34;</span><span class=p>});</span></span></span></code></pre></div><p>In our example, we send the number of seconds to wait as an integer parsed from the <code>&lt;input></code> element:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Get the number to calculate the Fibonacci number for and convert it from a string to a base 10 integer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>n</span> <span class=o>=</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s1>&#39;#n&#39;</span><span class=p>).</span><span class=nx>value</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Stall for the specified amount of time
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=nx>n</span><span class=p>);</span></span></span></code></pre></div><p>Whatever data we send as the message is <em>copied</em> into the web worker&rsquo;s memory using the <a href=https://developer.mozilla.org/en-US/docs/Web/Guide/DOM/The_structured_clone_algorithm rel=external target=_blank>structured clone</a> algorithm. We can also optionally <em>transfer</em> objects to the web worker instead of copying them by providing them as a second argument. This transfers the memory holding them from one thread to the other. This makes them unavailable on the original thread, but is much faster than copying when the object is large. It is used for sending objects like <a href=https://developer.mozilla.org/en-US/docs/Web/API/ArrayBuffer rel=external target=_blank>ArrayBuffer</a>, <a href=https://developer.mozilla.org/en-US/docs/Web/API/MessagePort rel=external target=_blank>MessagePort</a>, or <a href=https://developer.mozilla.org/en-US/docs/Web/API/ImageBitmap rel=external target=_blank>ImageBitmap</a>. Transferred objects <em>also</em> need to have a reference in the first argument.</p><h2 id=the-web-worker-context>The Web Worker Context</h2><p>For the JavaScript executing in the web worker, the context is a bit different. First, there is no document object model, as the web worker cannot make changes to the user interface. Likewise there is no global <code>window</code> object. However, many of the normal global functions and properties <em>not</em> related to the user interface are available, see <a href=https://developer.mozilla.org/en-US/docs/Web/API/Worker/Functions_and_classes_available_to_workers rel=external target=_blank>functions and classes available to web workers</a> for details.</p><p>The web worker has its own unique global scope, so any variables declared in your main thread won&rsquo;t exist here. Likewise, varibles declared in the worker will not exist in the main scope either. The global scope of the worker has mirror events and properties to the <code>Worker</code> - we can listen for messages from the main thread using the <code>onmessage</code> and <code>onmessageerror</code> properties, and send messages back to the main thread with <code>postMessage()</code>.</p><p>The complete web worker script from the example is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/** @function stall 
</span></span></span><span class=line><span class=cl><span class=cm> * Synchronously stalls for the specified amount of time 
</span></span></span><span class=line><span class=cl><span class=cm> * to simulate a long-running calculation
</span></span></span><span class=line><span class=cl><span class=cm> * @param {int} seconds - the number of seconds to stall
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>stall</span><span class=p>(</span><span class=nx>seconds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>startTime</span> <span class=o>=</span> <span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>endTime</span> <span class=o>=</span> <span class=nx>seconds</span> <span class=o>*</span> <span class=mi>1000</span> <span class=o>+</span> <span class=nx>startTime</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span> <span class=o>&gt;</span> <span class=nx>endTime</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Message handler for messages from the main thread
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>onmessage</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// stall for the specified amount of time 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>stall</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Send an answer back to the main thread
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>postMessage</span><span class=p>(</span><span class=sb>`Stalled for </span><span class=si>${</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=si>}</span><span class=sb> seconds`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Close the worker since we create a
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// new worker with each stall request.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Alternatively, we could re-use the same
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// worker.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div><p>Workers can also send AJAX requests, and spawn additional web workers! In the case of spawning additional workers, the web worker that creates the child worker is treated as the main thread.</p><h2 id=other-kinds-of-web-workers>Other kinds of Web Workers</h2><p>The web workers we&rsquo;ve discussed up to this point are basic <em>dedicated workers</em>. There are also several other kinds of specialized web workers:</p><ul><li>Shared workers are shared between several scripts, possibly even running in different <code>&lt;iframe></code> elements. These are more complex than a dedicated worker and communicate via ports. See MDN&rsquo;s <a href=https://developer.mozilla.org/en-US/docs/Web/API/SharedWorker rel=external target=_blank>SharedWorker</a> article for information.</li><li>Service workers act as proxy servers between the server and the web app, for the purpose of allowing web apps to be used offline. We&rsquo;ll discuss these later in the semester, but you can read up on them in hte mdn <a href=https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorker_API rel=external target=_blank>ServiceWorker</a> article.</li><li>Audio workers allow for direct scripting of audio processing within a web worker context. See the mdn <a href=https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API#Audio_Workers rel=external target=_blank>AudioWorker</a> article for details.</li></ul><footer class=footline></footer></article></div></main></div><script src=/cis526/js/clipboard.min.js?1744393792 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1744393792 defer></script><script src=/cis526/js/theme.js?1744393792 defer></script><script src=/cis526/js/embed-iframe.js?1744393792 defer></script></body></html>
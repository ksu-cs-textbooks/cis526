<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="Parallel Processing Made Easy"><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Asynchronous JavaScript :: CIS 526 Textbook"><meta name=twitter:description content="Parallel Processing Made Easy"><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/03-asynchronous-js/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Asynchronous JavaScript :: CIS 526 Textbook"><meta property="og:description" content="Parallel Processing Made Easy"><meta property="og:locale" content="en-us"><meta property="og:type" content="website"><meta itemprop=name content="Asynchronous JavaScript :: CIS 526 Textbook"><meta itemprop=description content="Parallel Processing Made Easy"><meta itemprop=datePublished content="2018-08-24T10:53:05-05:00"><meta itemprop=dateModified content="2023-08-10T16:48:12-05:00"><meta itemprop=wordCount content="4"><title>Asynchronous JavaScript :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/03-asynchronous-js/ rel=canonical type=text/html title="Asynchronous JavaScript :: CIS 526 Textbook"><link href=/cis526/03-asynchronous-js/index.xml rel=alternate type=application/rss+xml title="Asynchronous JavaScript :: CIS 526 Textbook"><link href=/cis526/03-asynchronous-js/tele.html rel=alternate type=text/html title="Asynchronous JavaScript :: CIS 526 Textbook"><link href=/cis526/03-asynchronous-js/embed.html rel=alternate type=text/html title="Asynchronous JavaScript :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1746463046 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1746463046 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1746463046 rel=stylesheet><link href=/cis526/css/auto-complete.css?1746463046 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1746463046 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1746463046 rel=stylesheet><link href=/cis526/css/fonts.css?1746463046 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1746463046 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1746463046 rel=stylesheet><link href=/cis526/css/theme-auto.css?1746463046 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1746463046 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1746463046 rel=stylesheet><link href=/cis526/css/print.css?1746463046 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1746463046 rel=stylesheet><script src=/cis526/js/variant.js?1746463046></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="..",window.relearn.relBaseUri="../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1746463046 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/03-asynchronous-js/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Asynchronous JavaScript</span><meta itemprop=position content="1"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/02-http/14-summary/ title="Summary (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/03-asynchronous-js/01-introduction/ title="Introduction (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable chapter narrow" tabindex=-1><div class=flex-block-wrapper><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 3</div><h1 id=asynchronous-javascript>Asynchronous JavaScript</h1><p>Parallel Processing Made Easy</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Asynchronous JavaScript</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>JavaScript makes extensive use of asynchronous processing to tackle the challenge of concurrency. This includes the events we&rsquo;ve already talked about (user events, network events and timers), but it has also been expanded to provide even more powerful features. The XMLHTTPRequest object allows JavaScript to request additional resources directly in an asynchronous manner, and the more recent Fetch API updates that approach. Web workers allow parallel JavaScript processes to be run in the browser. And new ES6 syntax and constructs like Promises and the async/await keywords make asynchronous functions easier to reason about and use. In this chapter, we will explore each of these topics.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=concurrency-approaches>Concurrency Approaches</h1><p>Concurrency means &ldquo;doing more than one thing at the same time.&rdquo; In computer science, concurrency can refer to (<a href=https://en.wikipedia.org/wiki/Concurrency_(computer_science) rel=external target=_blank>1</a>) structuring a program or algorithm so that it can be executed out-of-order or in partial order, or (<a href=https://en.wikipedia.org/wiki/Concurrent_computing rel=external target=_blank>2</a>) actually executing computations in parallel. In modern-day programming, we&rsquo;re often talking about <em>both</em>. But to help us develop a stronger understanding, let&rsquo;s look at the two ideas one-at-a-time, and then bring it together.</p><h2 id=concurrency>Concurrency</h2><p>One of the earliest concurrency problems computer science dealt with was the efficient use of early computers. Consider a mainframe computer like the <a href=https://en.wikipedia.org/wiki/PDP-1 rel=external target=_blank>PDP-1</a>, once a staple of the university computer science department. In 1963, the base price of a PDP-1 was $120,000. Adjusted for inflation, this would be a price of a bit more than <em>one million dollars</em> in 2020! That&rsquo;s a pretty big investment! Any institution, be it a university, a corporation, or a government agency that spent that kind of money would want to use their new computer as efficiently as possible.</p><p>Consider when you are working on a math assignment and using a calculator. You probably read your problem carefully, write out an equation on paper, and then type a few calculations into your calculator, and copy the results to your paper. You might write a few lines as you progress through solving the problem, then punch a new calculation into your calculator. Between computations, your calculator is sitting idle - not doing anything. Mainframe computers worked much the same way - you loaded a program, it ran, and spat out results. Until you loaded a new program, the mainframe would be idle.</p><h3 id=batch-processing>Batch Processing</h3><p>An early solution was the use of <a href=https://en.wikipedia.org/wiki/Batch_processing rel=external target=_blank>batch processing</a>, where programs were prepared ahead of time on punch-card machines or the like, and turned over to an IT department team that would then feed these programs into the computer. In this way, the IT staff could keep the computer working as long as there was batched work to do. While this approach kept the computer busy, it was not ideal for the programmers. Consider the calculator example - it would be as if you had to write out your calculations and give them to another person to enter into the calculator. And they might not get you your results for days!</p><p>Can you imagine trying to write a program that way? In the early days that was <em>exactly</em> how CS students wrote programs - they would write an entire program on punch cards, turn it in to the computer staff to be batched, and get the results once it had been run. If they made a mistake, it would require another full round of typing cards, turning them in, and waiting for results!</p><p>Batch processing is still used for some kinds of systems - such as the generation of your DARS report at K-State, for sending email campaigns, and for running jobs on Beocat and other supercomputers. However, in mainframe operations it quickly was displaced by <em>time sharing</em>.</p><h3 id=time-sharing>Time Sharing</h3><p><a href=https://en.wikipedia.org/wiki/Time-sharing rel=external target=_blank>Time-sharing</a> is an approach that has much in common with its real-estate equivalent that shares its name. In real estate, a time-share is a vacation property that is owned by multiple people, who take turns using it. In a mainframe computer system, a time sharing approach likewise means that multiple people share a single computer. In this approach, terminals (a monitor and keyboard) are hooked up to the mainframe. But there is one important difference between time-sharing real estate and computers, which is why we can call this approach <em>concurrent</em>.</p><p>Let&rsquo;s return to the example of the calculator. In the moments between your typing an expression and reading the results, another student could type in their expression, and get their results. A time-sharing mainframe does exactly that - it take a few fractions of a second to advance each users&rsquo; program, switching between different users at lightning speed. Consider a newspaper where twenty people might we writing stories at a given moment - each terminal would capture key presses, and send them to the mainframe when it gave its attention, which would update the text editor, and send the resulting screen data back to the terminal. To the individual users, it would appear the computer was only working with them. But in actuality it was updating all twenty text editor program instances in real-time (at least to human perception).</p><p>Like batch processing, time-sharing is still used in computing today. If you&rsquo;ve used the thin clients in the DUE 1114 lab, these are the current-day equivalents of those early terminals. They&rsquo;re basically a video card, monitor, and input device that are hooked up to a server that runs multiple VMs (virtual machines), one for each client, and switches between them constantly updating each.</p><h3 id=multitasking>Multitasking</h3><p>The <a href=https://en.wikipedia.org/wiki/Microcomputer rel=external target=_blank>microcomputer revolution</a> did not do away with the concept. Rather, modern operating systems still use the basic concept of the approach, though in the context of a single computer it is known as <a href=https://en.wikipedia.org/wiki/Computer_multitasking rel=external target=_blank>multitasking</a>. When you write a paper now, your operating system is switching between processes in much the same way that time-sharing switched between users. It will switch to your text editor, processing your last keystroke and updating the text on screen. Then it will shift to your music player and stream the next few thousand bytes of the song you&rsquo;re listening to the sound card. Then it will switch to your email program which checks the email server and it will start to notify you that a new email has come in. Then it will switch back to your text editor.</p><p>The thin clients in DUE 1114 (as well as the remote desktops) are therefore both time-sharing between VMs and multitasking within VMs.</p><h2 id=parallel-processing>Parallel Processing</h2><p>The second approach to concurrency involves using <em>multiple</em> computers in parallel. K-State&rsquo;s <a href="https://support.beocat.ksu.edu/BeocatDocs/index.php?title=Main_Page" rel=external target=_blank>Beocat</a> is a good example of this - a supercomputer built of a lot of individual computers. But your laptop or desktop likely is as well; if you have a multi-core CPU, you actually have multiple processors built into your CPU, and each can run separate computational processes. This, it is entirely possible that as you are writing your term paper the text editor is running on one processor, your email application is using a second one, and your music is running on a third.</p><p>In fact, modern operating systems use both multitasking and parallel processing in tandem, spreading out the work to do across however many cores are available, and swapping between active processes to on those cores. Some programs also organize their own computation to run on multiple processors - your text editor might actually be handling your input on one core, running a spellcheck on a second, and a grammar check on a third.</p><p>Remember our earlier discussion about scaling web servers? This is <em>also</em> a parallel processing approach. Incoming HTTP requests are directed by a load balancer to a less-busy server, and that server formulates the response.</p><p><a href=#R-image-0ca462c5fa0b1f1cda793f3c79652fd5 class=lightbox-link><img alt="Horizontal Scaling" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/3.2.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0ca462c5fa0b1f1cda793f3c79652fd5><img alt="Horizontal Scaling" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/3.2.1.png></a></p><h3 id=multithreading>Multithreading</h3><p>Individual programs can <em>also</em> be written to execute on multiple cores. We typically call this approach <a href=https://en.wikipedia.org/wiki/Thread_(computing)#Multithreading rel=external target=_blank>Multithreading</a>, and the individually executing portions of the program code <em>threads</em>.</p><p>These aren&rsquo;t the only ways to approach concurrency, but they are ones we commonly see in practice. Before we turn our attention to how asynchronous processes fit in though, we&rsquo;ll want to discuss some of the challenges that concurrency brings.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=concurrency-challenges>Concurrency Challenges</h1><p>Implementing concurrency in computing systems comes with some specific challenges. Consider the multitasking approach where we have your text editor and your music player running at the same time. As the text editor process yields to the music player, the data and program elements it had loaded up into working memory, needs to be cleared out and replaced with the music player&rsquo;s data and program. However, the music player&rsquo;s data and program need to be retained <em>somewhere</em> so that they can be swapped back in when the music player yields.</p><p>Modern operating systems handle this challenge by dividing working memory amongst all programs running (which is why the more programs you run, the more RAM you consume). Each running process is assigned a block of memory and <em>only</em> allowed to use that memory. Moreover, data copied into the CPU (the L2 cache, L1 cache, and registers) may also be cached in memory for later restoration. You&rsquo;ll learn more about the details of this process if you take an Operating Systems course. But it is <em>very</em> important that each running program is <em>only</em> allowed to make changes in its own assigned memory space. If it wasn&rsquo;t, it could overwrite the data of another task!</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>In fact, an OS allowing a running program to overwrite another program&rsquo;s assigned memory is a <em>security vulnerability</em>, as this can involve overwriting part of the other <em>program</em>, changing how it actually works! Viruses, trojans, and worms are often written to exploit this kind of vulnerability.</p></div></div><p>While operating systems normally manage the challenges of concurrency between running programs, when the program <em>itself</em> is written to be concurrent, the program itself must be built to avoid accidentally overwriting its own memory in unexpected ways. Consider a text editor - it might have its main thread handling user input, and a second thread handling spell checking. Now the user has typed &ldquo;A quick brow&rdquo;, and the spell checker is finding that &ldquo;brow&rdquo; is misspelled. It might try to underline the line in red, but in the intervening time, the user has deleted &ldquo;brow&rdquo;, so the underlining is no longer valid!</p><p>Or consider image data. Applying a filter to an image is a computationally costly operation - typically requiring visiting each pixel in the image, and for some filters, visiting each pixel <em>around</em> each pixel as part of the transformation. This would be a good use-case for multi-threading. But now imagine <em>two</em> filters working in parallel. One might be applying a blur, and the other a grayscale transformation. If they were overwriting the old image data with their new filtered version, and were working at the same time, they might both start from the original pixels in the upper-right-hand corner. The blur would take longer, as it needs to visit neighboring pixels. So the grayscale filter writes out the first hundred pixels, and then the blur writes out its first hundred, over-writing the grayed pixels with blurred color pixels. Eventually, the grayscale filter will get so far ahead of the blur filter that the blur filter will be reading in now-greyed out pixels, and blurring them. The result could well be a mishmash of blurred color and gray-and-white splotches.</p><p>There are many different approaches that can be used to manage this challenge. One is the use of locks - locking a section of memory so only one thread can access it while it makes changes. In the filter example, the grayscale filter could lock the image data, forcing the blur filter to wait until it finishes. Locks work well, but must be carefully designed to avoid race conditions - where two threads cannot move forward because the other thread has already locked a resource the blocked thread needs to finish its work.</p><p>Asynchronous programming is another potential solution, which we&rsquo;ll look at next.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=asynchronous-programming>Asynchronous Programming</h1><p>In asynchronous programming, memory collisions are avoided by not sharing memory between threads. A unit of work that can be done in parallel is split off and handed to another thread, and any data it needs is copied into that threads&rsquo; memory space. When the work is complete, the second thread notifies the primary thread if the work was completed successfully or not, and provides the resulting data or error.</p><p>In JavaScript, this notification is pushed into the event queue, and the main thread processes it when the event loop pulls the result off the event queue. Thus, the only memory that is shared between the code you&rsquo;ve written in the Event Loop and the code running in the asynchronous process is the memory invovled in the event queue. Keeping this memory thread-safe is managed by the JavaScript interpreter. Thus, the code you write (which runs in the Event Loop) is essentially single-threaded, even if your JavaScript application is using some form of parallel processing!</p><p>Let&rsquo;s reconsider a topic we&rsquo;ve already discussed with this new understanding - timers. When we invoke <code>setTimer()</code>, we are creating a timer that is managed asynchronously. When the timer elapses, it creates a timer &rsquo;event&rsquo; and adds it to the event queue. We can see this in the diagram below.</p><p><a href=#R-image-13bc805a612f58ebe7d5c1484661120e class=lightbox-link><img alt="The timer and event loop" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/3.4.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-13bc805a612f58ebe7d5c1484661120e><img alt="The timer and event loop" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/3.4.1.png></a></p><p>However, the timer is not actually an <em>event</em>, in the same sense that a <code>'click'</code> or <code>'keydown'</code> event is&mldr; in that those events are provided to the browser from the operating system, and the browser passes them along into the JavaScript interpreter, possibly with some transformation. In contrast, the timer is created from within the JavaScript code, though its triggering is managed asynchronously.</p><p>In fact, both timers and events represent this style of asynchronous processing - both are managed by creating <em>messages</em> that are placed on the event queue to be processed by the interpreter. But the timer provides an important example of how asynchronous programming works. Consider this code that creates a timer that triggers after 0 milliseconds:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>setTimeout</span><span class=p>(()=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Timer expired!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;I just set a timer.&#34;</span><span class=p>);</span></span></span></code></pre></div><p>What will be printed first? The &ldquo;Timer expired!&rdquo; message or the &ldquo;I just set a timer.&rdquo; message?</p><p>See for yourself - try running this code in the console (you can click the &ldquo;console&rdquo; tab below to open it).</p><p>The answer is that &ldquo;I just set a timer&rdquo; will <em>always</em> be printed first, because the second message won&rsquo;t be printed until the event loop pulls the timer message off the queue, and the line printing &ldquo;I just set a timer&rdquo; is executed as part of this pass in the event loop. The <code>setTimeout()</code> and <code>setInterval()</code> functions are what we call <em>asynchronous</em> functions, as they trigger an asynchronous process. Once that process is triggered, execution immediately continues within the event loop, while the triggered process runs in parallel. Asynchronous functions typically take a function as an argument, known as a <em>callback function</em>, which will be triggered when the message corresponding to the asynchronous process is pulled off the event queue.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>Any code appearing after a call to an asynchronous function will be executed immediately after the asynchronous function is invoked, regardless of how quickly the asynchronous process generates its message and adds it to the event queue.</p></div></div><p>As JavaScript was expanded to take on new functionality, this asynchronous mechanism was re-used. Next, we&rsquo;ll take a look at an example of this in the use of <em>web workers</em>.</p><style>.console{position:fixed;bottom:0;left:300px;box-sizing:border-box;z-index:1000;width:calc(100% - 300px);height:30vh;background-color:#8451a1;padding:1rem;transform:translateY(calc(30vh - 5px));transition:transform 1s}.console iframe{width:100%;height:100%;background-color:#fff}.console>.console-tab{position:absolute;top:-1.2rem;right:0;color:#fff;background-color:#8451a1;padding:0 2rem;border-radius:5px;cursor:pointer}.console.active{transform:none}</style><div class=console><div class=console-tab>CONSOLE</div><iframe src=https://jsconsole.com/></iframe></div><script>document.querySelector(".console-tab").addEventListener("click",e=>{console.log(e),e.target.parentElement.classList.toggle("active")})</script><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=web-workers>Web Workers</h1><p>As JavaScript began to be used to add more and more functionality to web applications, an important limitation began to appear. When the JavaScript interpreter is working on a big task, it stays in the event loop a long time, and does not pull events from the event queue. The result is the browser stops responding to user events&mldr; and seems to be frozen. On the other hand - some programs will <em>never</em> end. Consider this one:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;thinking...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>This loop has no possible exit condition, so if you ran it in the browser, it would run infinitely long&mldr; and the page would never respond to user input, because you&rsquo;d never pull any events of the event queue. One of the important discoveries in computer science, the <a href=https://en.wikipedia.org/wiki/Halting_problem rel=external target=_blank>Halting Problem</a> tackles exactly this issue - and Alan Turing&rsquo;s proof shows that a program to determine if another program will halt for all possible programs <em>cannot</em> be written.</p><p>Thus, browsers instead post warning messages after execution has run for a significant amount of time, like this one:</p><p><a href=#R-image-b1495eb213f168436d155fe872d05936 class=lightbox-link><img alt="The Chrome not responding dialog" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/3.5.1.jpg style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b1495eb213f168436d155fe872d05936><img alt="The Chrome not responding dialog" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/3.5.1.jpg></a></p><p>So, if we want to do a long-running computation, and <em>not</em> have the browser freeze up, we needed to be able to run it separately from the thread our event loop is running on. The <a href=https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers rel=external target=_blank>web worker</a> provides just this functionality.</p><p>A web worker is essentially another JavaScript interpreter, running a script separate from the main thread. As an interpreter, it has its own event loop and its own memory space. Workers and the main thread can communicate by passing messages, which are copied onto their respective event queues. Thus, communication between the threads is <em>asynchronous</em>.</p><p><a href=#R-image-9d9164da1b54f519957e7ac3b6830873 class=lightbox-link><img alt="The web worker and main thread interpreters passing messages" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/3.5.2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9d9164da1b54f519957e7ac3b6830873><img alt="The web worker and main thread interpreters passing messages" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/3.5.2.png></a></p><h2 id=an-example>An Example</h2><p>You can see an example of such a web worker by using <a href=/cis526/03-asynchronous-js/05-web-workers/../../examples/3.5.1/index.html target=_blank>this link</a> to open another tab in your browser. This example simulates a long-running process of <strong>n</strong> seconds either in the browser&rsquo;s main thread or in a web worker. On the page is also three colored squares that when clicked, shift colors. Try changing the colors of the squares while simulating a several-second process in both ways. See how running the process on the main thread freezes the user interface?</p><h2 id=using-web-workers>Using Web Workers</h2><p>Web workers are actually very easy to use. A web worker is created by constructing a <a href=https://developer.mozilla.org/en-US/docs/Web/API/Worker rel=external target=_blank>Worker</a> object. It takes a single argument - the JavaScript file it will execute (which should be hosted on the same server). In the example, this is done with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Set up the web worker
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Worker</span><span class=p>(</span><span class=s1>&#39;stall.js&#39;</span><span class=p>);</span></span></span></code></pre></div><p>The <em>stall.js</em> file contains the script the worker will execute - we&rsquo;ll take a look at it in a minute.</p><p>Once created, you can attach a listener to the <code>Worker</code>. It has two events:</p><ul><li><code>message</code> - a deserialized message sent from the web worker</li><li><code>mesageerror</code> - a message sent from the web worker that was not serializable</li></ul><p>You can use <code>worker.addEventListener()</code> to add these, or you can assign your event listener to the event handler properties. Those properties are:</p><ul><li><code>Worker.onmessage</code> - triggered when the <code>message</code> event happens</li><li><code>Worker.onmessageerror</code> - triggered when the <code>messageerror</code> event happens</li></ul><p>Additionally, there is an error handler property:</p><ul><li><code>Worker.onerror</code></li></ul><p>Which triggers when an uncaught error occurs on the web worker.</p><p>In our example, we listen for messages using the <code>Worker.onmessage</code> property:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Set up message listener
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>worker</span><span class=p>.</span><span class=nx>onmessage</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Signal completion
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s1>&#39;#calculation-message&#39;</span><span class=p>).</span><span class=nx>textContent</span> <span class=o>=</span> <span class=sb>`Calculation complete!`</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>If the message was successfully deserialized, it&rsquo;s <code>data</code> property contains the content of the message, which can be any valid JavaScript value (an int, string, array, object, etc). This gives us a great deal of flexibility. If you need to send more than one type of message, a common strategy is to send a JavaScript object with a type property, and additional properties as needed, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>messageData1</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;greeting&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>body</span><span class=o>:</span> <span class=s2>&#34;Hello!  It&#39;s good to see you.&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>messageData2</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;set-color&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>color</span><span class=o>:</span> <span class=s2>&#34;#ffaacc&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>We can send messages <em>to</em> the web worker with <a href=https://developer.mozilla.org/en-US/docs/Web/API/Worker/postMessage rel=external target=_blank>Worker.postMessage()</a>. Again, these messages can be any valid JavaScript value:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=s2>&#34;Foo&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>({</span><span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;greetings&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=o>:</span> <span class=s2>&#34;Take me to your leader!&#34;</span><span class=p>});</span></span></span></code></pre></div><p>In our example, we send the number of seconds to wait as an integer parsed from the <code>&lt;input></code> element:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Get the number to calculate the Fibonacci number for and convert it from a string to a base 10 integer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>n</span> <span class=o>=</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s1>&#39;#n&#39;</span><span class=p>).</span><span class=nx>value</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Stall for the specified amount of time
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=nx>n</span><span class=p>);</span></span></span></code></pre></div><p>Whatever data we send as the message is <em>copied</em> into the web worker&rsquo;s memory using the <a href=https://developer.mozilla.org/en-US/docs/Web/Guide/DOM/The_structured_clone_algorithm rel=external target=_blank>structured clone</a> algorithm. We can also optionally <em>transfer</em> objects to the web worker instead of copying them by providing them as a second argument. This transfers the memory holding them from one thread to the other. This makes them unavailable on the original thread, but is much faster than copying when the object is large. It is used for sending objects like <a href=https://developer.mozilla.org/en-US/docs/Web/API/ArrayBuffer rel=external target=_blank>ArrayBuffer</a>, <a href=https://developer.mozilla.org/en-US/docs/Web/API/MessagePort rel=external target=_blank>MessagePort</a>, or <a href=https://developer.mozilla.org/en-US/docs/Web/API/ImageBitmap rel=external target=_blank>ImageBitmap</a>. Transferred objects <em>also</em> need to have a reference in the first argument.</p><h2 id=the-web-worker-context>The Web Worker Context</h2><p>For the JavaScript executing in the web worker, the context is a bit different. First, there is no document object model, as the web worker cannot make changes to the user interface. Likewise there is no global <code>window</code> object. However, many of the normal global functions and properties <em>not</em> related to the user interface are available, see <a href=https://developer.mozilla.org/en-US/docs/Web/API/Worker/Functions_and_classes_available_to_workers rel=external target=_blank>functions and classes available to web workers</a> for details.</p><p>The web worker has its own unique global scope, so any variables declared in your main thread won&rsquo;t exist here. Likewise, varibles declared in the worker will not exist in the main scope either. The global scope of the worker has mirror events and properties to the <code>Worker</code> - we can listen for messages from the main thread using the <code>onmessage</code> and <code>onmessageerror</code> properties, and send messages back to the main thread with <code>postMessage()</code>.</p><p>The complete web worker script from the example is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/** @function stall 
</span></span></span><span class=line><span class=cl><span class=cm> * Synchronously stalls for the specified amount of time 
</span></span></span><span class=line><span class=cl><span class=cm> * to simulate a long-running calculation
</span></span></span><span class=line><span class=cl><span class=cm> * @param {int} seconds - the number of seconds to stall
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>stall</span><span class=p>(</span><span class=nx>seconds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>startTime</span> <span class=o>=</span> <span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>endTime</span> <span class=o>=</span> <span class=nx>seconds</span> <span class=o>*</span> <span class=mi>1000</span> <span class=o>+</span> <span class=nx>startTime</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span> <span class=o>&gt;</span> <span class=nx>endTime</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Message handler for messages from the main thread
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>onmessage</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// stall for the specified amount of time 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>stall</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Send an answer back to the main thread
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>postMessage</span><span class=p>(</span><span class=sb>`Stalled for </span><span class=si>${</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=si>}</span><span class=sb> seconds`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Close the worker since we create a
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// new worker with each stall request.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Alternatively, we could re-use the same
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// worker.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div><p>Workers can also send AJAX requests, and spawn additional web workers! In the case of spawning additional workers, the web worker that creates the child worker is treated as the main thread.</p><h2 id=other-kinds-of-web-workers>Other kinds of Web Workers</h2><p>The web workers we&rsquo;ve discussed up to this point are basic <em>dedicated workers</em>. There are also several other kinds of specialized web workers:</p><ul><li>Shared workers are shared between several scripts, possibly even running in different <code>&lt;iframe></code> elements. These are more complex than a dedicated worker and communicate via ports. See MDN&rsquo;s <a href=https://developer.mozilla.org/en-US/docs/Web/API/SharedWorker rel=external target=_blank>SharedWorker</a> article for information.</li><li>Service workers act as proxy servers between the server and the web app, for the purpose of allowing web apps to be used offline. We&rsquo;ll discuss these later in the semester, but you can read up on them in hte mdn <a href=https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorker_API rel=external target=_blank>ServiceWorker</a> article.</li><li>Audio workers allow for direct scripting of audio processing within a web worker context. See the mdn <a href=https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API#Audio_Workers rel=external target=_blank>AudioWorker</a> article for details.</li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=callbacks>Callbacks</h1><style>.console{position:fixed;bottom:0;left:300px;box-sizing:border-box;z-index:1000;width:calc(100% - 300px);height:30vh;background-color:#8451a1;padding:1rem;transform:translateY(calc(30vh - 5px));transition:transform 1s}.console iframe{width:100%;height:100%;background-color:#fff}.console>.console-tab{position:absolute;top:-1.2rem;right:0;color:#fff;background-color:#8451a1;padding:0 2rem;border-radius:5px;cursor:pointer}.console.active{transform:none}</style><div class=console><div class=console-tab>CONSOLE</div><iframe src=https://jsconsole.com/></iframe></div><script>document.querySelector(".console-tab").addEventListener("click",e=>{console.log(e),e.target.parentElement.classList.toggle("active")})</script><p>JavaScript implements its asynchronous nature through <em>callbacks</em> - functions that are invoked when an asynchronous process completes. We see this in our discussion of timers like <code>setTimeout()</code> and with our web workers with the <code>onmessage</code> event handler. These demonstrate two possible ways of setting a callback. With <code>setTimeout()</code> we pass the callback as a function parameter, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>timeElapsed</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Time has elapsed!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// Set a timer for 1 second, and trigger timeElapsed() when the timer expires
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>setTimeout</span><span class=p>(</span><span class=nx>timeElapsed</span><span class=p>,</span> <span class=mi>1000</span><span class=p>);</span></span></span></code></pre></div><p>With webworkers, we assign a function to a property of the worker (the <code>onmessage</code> variable):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>messageReceived</span><span class=p>(</span><span class=nx>message</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Received &#34;</span> <span class=o>+</span> <span class=nx>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// Set the event listener
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>onmessage</span> <span class=o>=</span> <span class=nx>messageReceived</span><span class=p>;</span></span></span></code></pre></div><p>Remember, a callback is a function, and in JavaScript, functions are first-order: we can assign them as a variable or pass them as an argument to a function! We can also define a callback asynchronously as part of the argument, as we do here:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>setTimeout</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;time elapsed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=mi>1000</span><span class=p>);</span></span></span></code></pre></div><p>Or using lambda syntax:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;time elapsed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=mi>1000</span><span class=p>);</span></span></span></code></pre></div><p>These are roughly equivalent to passing <code>timeElapsed()</code> in the first example - and you&rsquo;ll likely see all three approaches when you read others&rsquo; code.</p><h3 id=callback-hell>Callback Hell</h3><p>Callbacks are a powerful mechanism for expressing asynchronicity, but overuse can lead to difficult to read code - a situation JavaScript programmers refer to as &ldquo;callback hell&rdquo;. This problem became especially pronounced once programmers began using Node to build server-side code, as Node adopted the event-based callback asynchronous model of JavaScript for interactions with the file system,databases, etc. (we&rsquo;ll cover Node in the <a href=https://textbooks.cs.ksu.edu/cis526/04-node/ rel=external target=_blank>next chapter</a>).</p><p>Consider this example, which logs a user into a website:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>webapp</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>parseFormData</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=p>(</span><span class=nx>form</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>username</span> <span class=o>=</span> <span class=nx>form</span><span class=p>.</span><span class=nx>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>password</span> <span class=o>=</span> <span class=nx>form</span><span class=p>.</span><span class=nx>password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>findUserInDatabase</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>encryptPassword</span><span class=p>(</span><span class=nx>password</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>salt</span><span class=p>,</span> <span class=p>(</span><span class=nx>hash</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span><span class=p>(</span><span class=nx>hash</span> <span class=o>===</span> <span class=nx>user</span><span class=p>.</span><span class=nx>passwordHash</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>                    <span class=nx>res</span><span class=p>.</span><span class=nx>setCookie</span><span class=p>({</span><span class=nx>user</span><span class=o>:</span> <span class=nx>user</span><span class=p>});</span>
</span></span><span class=line><span class=cl>                    <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s2>&#34;Logged in successfully!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span>
</span></span><span class=line><span class=cl>                    <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=mi>403</span><span class=p>,</span> <span class=s2>&#34;Unknown username/password combo&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Don&rsquo;t work about the exact details of the code, but count the number of nested callbacks. There are four! And reasoning about this deeply nested code starts getting pretty challenging even for an experienced programmer. Also, handling errors in this nested structure requires thinking through the nested structure.</p><p>There are strategies to mitigate this challenge in writing your code, including:</p><ol><li>Keeping your code shallow</li><li>Modularizing your code</li><li>Handling every single error.</li></ol><p>The site <a href=http://callbackhell.com>callbackhell.com</a> offers a detailed discussion of these strategies.</p><p>As JavaScript matured, additional options were developed for handling this complexity - Promises and the <code>async</code> and <code>await</code> keywords. We&rsquo;ll talk about them next.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=promises>Promises</h1><style>.console{position:fixed;bottom:0;left:300px;box-sizing:border-box;z-index:1000;width:calc(100% - 300px);height:30vh;background-color:#8451a1;padding:1rem;transform:translateY(calc(30vh - 5px));transition:transform 1s}.console iframe{width:100%;height:100%;background-color:#fff}.console>.console-tab{position:absolute;top:-1.2rem;right:0;color:#fff;background-color:#8451a1;padding:0 2rem;border-radius:5px;cursor:pointer}.console.active{transform:none}</style><div class=console><div class=console-tab>CONSOLE</div><iframe src=https://jsconsole.com/></iframe></div><script>document.querySelector(".console-tab").addEventListener("click",e=>{console.log(e),e.target.parentElement.classList.toggle("active")})</script><p>Promises replace the callback mechanism with a JavaScript object, a <code>Promise</code>. In many ways, this is similar to the <code>XMLHttpRequest</code> object that is at the heart of <a href=https://textbooks.cs.ksu.edu/cis526/c-js/11-ajax/ rel=external target=_blank>AJAX</a>. You can think of it as a state machine that is in one of three states: <em>pending</em>, <em>fulfilled</em>, or <em>rejected</em>.</p><p>A promise can be created by wrapping an asynchronous call within a new <code>Promise</code> object. For example, we can turn a <code>setTimeout()</code> into a promise with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>threeSecondPromise</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>resolve</span><span class=p>(</span><span class=s2>&#34;Timer elapsed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=mi>300</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>We can also create a promise that immediately resolves using <code>Promise.resolve()</code>, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>fifteenPromise</span> <span class=o>=</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=mi>15</span><span class=p>);</span></span></span></code></pre></div><p>This promise is never in the <em>pending</em> state - it starts as <em>resolved</em>. Similarly, you can create a promise that starts in the <em>rejected</em> state with <code>Promise.reject()</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>failedPromise</span> <span class=o>=</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>reject</span><span class=p>(</span><span class=s2>&#34;I am a failure...&#34;</span><span class=p>);</span></span></span></code></pre></div><p>You can also pass an error object to <code>Promise.reject()</code>.</p><h4 id=using-promiseprototypethen>Using Promise.prototype.then()</h4><p>What makes promises especially useful is their <code>then()</code> method. This method is invoked when the promise finishes, and is passed whatever the promise resolved to, i.e. the string <code>"Timer elapsed"</code> in the example above. Say we want to log that result to the console:</p><div class=highlight><pre tabindex=0><code>threeSecondPromise.then(result =&gt; {console.log(result)});</code></pre></div><p>This is a rather trivial example, but we can use the same approach to define a <em>new</em> method for creating timers that might seem more comfortable for object-oriented programmers:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createTimer</span><span class=p>(</span><span class=nx>milliseconds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>resolve</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=nx>milliseconds</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>With this method, we can create a timer to do any arbitrary action, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Say &#34;Hello Delayed World&#34; after five seconds
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>createTimer</span><span class=p>(</span><span class=mi>5000</span><span class=p>).</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Hello delayed World!&#34;</span><span class=p>));</span></span></span></code></pre></div><h4 id=using-promiseprototypecatch>Using Promise.prototype.catch()</h4><p>In addition to the <code>then()</code> method, promises also provide a <code>catch()</code> method. This method handles any errors that were thrown by the promise. Consider this function that returns a promise to compute an average:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>computeAverage</span><span class=p>(</span><span class=nx>numbers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Sum the numbers
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>sum</span> <span class=o>=</span> <span class=nx>numbers</span><span class=p>.</span><span class=nx>reduce</span><span class=p>((</span><span class=nx>acc</span><span class=p>,</span> <span class=nx>value</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>acc</span> <span class=o>+</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Compute the average 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>average</span> <span class=o>=</span> <span class=nx>sum</span> <span class=o>/</span> <span class=nx>numbers</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>resolve</span><span class=p>(</span><span class=nx>average</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Try copying this code into the console, and then run some examples, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>computeAverage</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>5</span><span class=p>]).</span><span class=nx>then</span><span class=p>(</span><span class=nx>average</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;The average is&#34;</span><span class=p>,</span> <span class=nx>average</span><span class=p>));</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>computeAverage</span><span class=p>([</span><span class=mf>0.3</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mf>20.5</span><span class=p>]).</span><span class=nx>then</span><span class=p>(</span><span class=nx>average</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;The average is&#34;</span><span class=p>,</span> <span class=nx>average</span><span class=p>));</span></span></span></code></pre></div><p>But what if we use the <em>empty array</em>?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>computeAverage</span><span class=p>([]).</span><span class=nx>then</span><span class=p>(</span><span class=nx>average</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;The average is&#34;</span><span class=p>,</span> <span class=nx>average</span><span class=p>));</span></span></span></code></pre></div><p>Because the length of the empty array is 0, we are dividing by 0, and an error will be thrown. Notice the error message reads &ldquo;Uncaught (in promise)&rdquo;&mldr; we can use the <code>catch()</code> method to capture this error, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>computeAverage</span><span class=p>([])</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>average</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;The average is&#34;</span><span class=p>,</span> <span class=nx>average</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>err</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&#34;Encountered an error:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>));</span></span></span></code></pre></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>Note when chaining JavaScript method calls, our dot <code>.</code> can be separated from the object it belongs to by whitespace. This can help keep our code readable by putting it on multiple lines.</p></div></div><p>Now when we run this code, the error is handled by our <code>catch()</code>. We&rsquo;re still printing it to the console as an error - but notice the message now reads <code>"Encountered an error" ...</code>, i.e. it&rsquo;s <em>our</em> error message!</p><p>Let&rsquo;s try one more - an array that <em>cannot</em> be averaged, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>computeAverage</span><span class=p>([</span><span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=s1>&#39;banana&#39;</span><span class=p>,</span> <span class=kc>true</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>average</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;The average is&#34;</span><span class=p>,</span> <span class=nx>average</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>err</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&#34;Encountered an error:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>));</span></span></span></code></pre></div><p>Here we see the promise resolves successfully, but the result is <code>NaN</code> (not a number). This is because that is the normal result of this operation in JavaScript. But what if we want that to be treated as an error? That&rsquo;s where the <code>reject()</code> callback provided to the promise comes in - it is used to indicate the promise should fail. We&rsquo;ll need to rewrite our <code>computeAverage()</code> method to use this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>computeAverage</span><span class=p>(</span><span class=nx>numbers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Sum the numbers
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>sum</span> <span class=o>=</span> <span class=nx>numbers</span><span class=p>.</span><span class=nx>reduce</span><span class=p>((</span><span class=nx>acc</span><span class=p>,</span> <span class=nx>value</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>acc</span> <span class=o>+</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Compute the average 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>average</span> <span class=o>=</span> <span class=nx>sum</span> <span class=o>/</span> <span class=nx>numbers</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nb>isNaN</span><span class=p>(</span><span class=nx>average</span><span class=p>))</span> <span class=nx>reject</span><span class=p>(</span><span class=s2>&#34;Average cannot be computed.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=nx>resolve</span><span class=p>(</span><span class=nx>average</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Rejected promises are also handled by the <code>catch()</code> method, so if we rerun the last example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>computeAverage</span><span class=p>([</span><span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=s1>&#39;bannana&#39;</span><span class=p>,</span> <span class=kc>true</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>average</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;The average is&#34;</span><span class=p>,</span> <span class=nx>average</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>err</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&#34;Encountered an error:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>));</span></span></span></code></pre></div><p>Notice we now see our error message!</p><h4 id=chaining-promiseprototypethen-and-promiseprototypecatch>Chaining Promise.prototype.then() and Promise.prototype.catch()</h4><p>Where <code>Promise.prototype.then()</code> and <code>Promise.prototype.catch()</code> really shine is when we <em>chain</em> a series of promises together. Remember our callback hell example?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>webapp</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>parseFormData</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=p>(</span><span class=nx>form</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>username</span> <span class=o>=</span> <span class=nx>form</span><span class=p>.</span><span class=nx>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>password</span> <span class=o>=</span> <span class=nx>form</span><span class=p>.</span><span class=nx>password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>findUserInDatabase</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>encryptPassword</span><span class=p>(</span><span class=nx>password</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>salt</span><span class=p>,</span> <span class=p>(</span><span class=nx>hash</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span><span class=p>(</span><span class=nx>hash</span> <span class=o>===</span> <span class=nx>user</span><span class=p>.</span><span class=nx>passwordHash</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>                    <span class=nx>res</span><span class=p>.</span><span class=nx>setCookie</span><span class=p>({</span><span class=nx>user</span><span class=o>:</span> <span class=nx>user</span><span class=p>});</span>
</span></span><span class=line><span class=cl>                    <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s2>&#34;Logged in successfully!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span>
</span></span><span class=line><span class=cl>                    <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=mi>403</span><span class=p>,</span> <span class=s2>&#34;Unknown username/password combo&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>If each of our methods returned a promise, we could re-write this as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>webapp</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>parseFormData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>formData</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>username</span> <span class=o>=</span> <span class=nx>formData</span><span class=p>.</span><span class=nx>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>password</span> <span class=o>=</span> <span class=nx>formData</span><span class=p>.</span><span class=nx>password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>findUserInDatabase</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>user</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>encryptPassword</span><span class=p>(</span><span class=nx>password</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>salt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>hash</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>hash</span> <span class=o>===</span> <span class=nx>user</span><span class=p>.</span><span class=nx>passwordHash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>setCookie</span><span class=p>({</span><span class=nx>user</span><span class=o>:</span> <span class=nx>user</span><span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s2>&#34;Logged in successfully&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> 
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=mi>403</span><span class=p>,</span> <span class=s2>&#34;Unknown username/password combo&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>err</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=mi>500</span><span class=p>,</span> <span class=s2>&#34;A server error occurred&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span></span></span></code></pre></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>The <code>Promise.prototype.catch()</code> method catches any error or promise rejection that occurs before it in the chain - basically as soon as an error or rejection occurs, further <code>.then()</code> calls are skipped until a <code>.catch()</code> is encountered. You can also chain additional <code>.then()</code> calls after a <code>.catch()</code>, and they will be processed until another error or rejection occurs!</p></div></div><h4 id=promiseall>Promise.All()</h4><p>In addition to processing promises in serial (one after another) by chaining <code>.then()</code> methods, sometimes we want to do them in <em>parallel</em> (all at the same time). For example, say we have several independent processes (perhaps each running on a webworker or separate Node thread) that when finished, we want to average together.</p><p>The <code>Promise.All()</code> method is the answer; it returns a promise to execute an arbitrary number of promises, and when all have finished, it itself resolves to an array of their results.</p><p>Let&rsquo;s do a quick example using this method. We&rsquo;ll start by declaring a function to wrap a fake asynchronous process - basically creating a random number (between 1 and 100) after a random number of seconds (between 0 and 3):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>mockTask</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=nx>value</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>ceil</span><span class=p>(</span><span class=nb>Math</span><span class=p>.</span><span class=nx>random</span><span class=p>()</span><span class=o>*</span><span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Computed value&#34;</span><span class=p>,</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>resolve</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>random</span><span class=p>()</span> <span class=o>*</span> <span class=mi>3000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Now let&rsquo;s say we want to compute an average of the results once they&rsquo;ve finished. As <code>Promise.All()</code> returns a <code>Promise</code> that resolves to a an array of the results, we can invoke our <code>computeAverage()</code> (which we declared previously) in a chained <code>.then()</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nb>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=nx>mockTask</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>mockTask</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>mockTask</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>mockTask</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>computeAverage</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>);</span></span></span></code></pre></div><p>Note that because <code>computeAverage</code> takes as a parameter an array, and <code>console.log</code> takes as its parameter a value, and those are what the previous promises resolve to, we don&rsquo;t have to define anonymous functions to pass into <code>.then()</code> - we can pass the function name instead.</p><p>Many JavaScript programmers found this format more comfortable to write and read than a series of nested callbacks. However, the <code>async</code> and <code>await</code> syntax offers a <em>third</em> option, which we&rsquo;ll look at next.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=async-and-await>Async and Await</h1><p>The <code>async</code> and <code>await</code> keywords are probably more familiar to you from languages like C#. JavaScript introduced them to play much the same role - a function declared <code>async</code> is asynchronous, and returns a <code>Promise</code> object.</p><p>With this in mind, we can redeclare our <code>createTimer()</code> method using the <code>async</code> keyword:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>createTimer</span><span class=p>(</span><span class=nx>milliseconds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>resolve</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=nx>milliseconds</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Now, instead of using the promise directly, we can use the <code>await</code> keyword in other code to wait on the promise to resolve, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>await</span> <span class=nx>createTimer</span><span class=p>(</span><span class=mi>4000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Moving on...&#34;</span><span class=p>);</span></span></span></code></pre></div><p>Try running this in the console. Notice that the second line is not executed until the timer has elapsed after 4 seconds!</p><p>Similarly, if we need to use a value computed as part of an asynchronous process, we can place the <code>await</code> within the assignment. I.e. to reproduce the <code>Promise.All()</code> example in the previous section, we could re-write our <code>mockTask()</code> and <code>computeAverage()</code> as <code>async</code> functions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>mockTask</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=nx>value</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>ceil</span><span class=p>(</span><span class=nb>Math</span><span class=p>.</span><span class=nx>random</span><span class=p>()</span><span class=o>*</span><span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Computed value&#34;</span><span class=p>,</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>resolve</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>random</span><span class=p>()</span> <span class=o>*</span> <span class=mi>3000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>computeAverage</span><span class=p>(</span><span class=nx>numbers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Sum the numbers
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>sum</span> <span class=o>=</span> <span class=nx>numbers</span><span class=p>.</span><span class=nx>reduce</span><span class=p>((</span><span class=nx>acc</span><span class=p>,</span> <span class=nx>value</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>acc</span> <span class=o>+</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Compute the average
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>average</span> <span class=o>=</span> <span class=nx>sum</span> <span class=o>/</span> <span class=nx>numbers</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nb>isNaN</span><span class=p>(</span><span class=nx>average</span><span class=p>))</span> <span class=nx>reject</span><span class=p>(</span><span class=s2>&#34;Average cannot be computed.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=nx>resolve</span><span class=p>(</span><span class=nx>average</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>And then the code to perform the averaging could be written:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>numbers</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=nx>numbers</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=kr>await</span> <span class=nx>mockTask</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>numbers</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=kr>await</span> <span class=nx>mockTask</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>numbers</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=kr>await</span> <span class=nx>mockTask</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>numbers</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=kr>await</span> <span class=nx>mockTask</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>average</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>computeAverage</span><span class=p>(</span><span class=nx>numbers</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>average</span><span class=p>);</span></span></span></code></pre></div><p>Many imperative programmers prefer the <code>async</code> and <code>await</code> syntax, because execution of the code pauses at each <code>await</code>, so code statements are executed in the order they appear in the code. However, the actual execution model it is <em>still</em> the event-based concurrency that we introduced with callbacks. Thus, when awaiting a result, the JavaScript interpreter is free to process other incoming events pulled off the event loop.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><p>In this chapter we learned about many of the approaches and challenges involved in concurrent programming, including <em>asynchronous</em> programming. JavaScript adopts the asynchronous approach through its use of the event loop and queue, allowing asynchronous processes to be invoked, processed on separate threads, and posting their results as new messages on the event queue to be processed when the main thread gets to them.</p><p>We saw how this approach allows for multi-threaded programs in the browser through the use of web workers, each of which runs a separate JavaScript interpreter with its own event loop and queue. We also saw how communication between web workers and the main thread are handled through message passing, and how very large data buffers can be transferred instead of copied between these threads for efficiency.</p><p>Finally, we examined the callback mechanism used for asynchronous processing in JavaScript, and explored two common abstractions used to make it more programmer-friendly: promises and the async/await keywords.</p><p>In the next chapter, we&rsquo;ll explore Node.js, a server-side implementation of the JavaScript engine that makes heavy use of the JavaScript asynchronous model.</p><footer class=footline></footer></article></section></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/41163dc548a00400a9f1d4962b4227b9a8ee4d20>Aug 10, 2023</a></p></div></div><script src=/cis526/js/clipboard.min.js?1746463046 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1746463046 defer></script><script src=/cis526/js/theme.js?1746463046 defer></script></body></html>
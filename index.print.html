<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="CIS 526 Course Textbook
Nathan Bean
Kansas State University
¬© 2020
This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License."><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Web Application Development :: CIS 526 Textbook"><meta name=twitter:description content="CIS 526 Course Textbook
Nathan Bean
Kansas State University
¬© 2020
This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Web Application Development :: CIS 526 Textbook"><meta property="og:description" content="CIS 526 Course Textbook
Nathan Bean
Kansas State University
¬© 2020
This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License."><meta property="og:locale" content="en-us"><meta property="og:type" content="website"><meta itemprop=name content="Web Application Development :: CIS 526 Textbook"><meta itemprop=description content="CIS 526 Course Textbook
Nathan Bean
Kansas State University
¬© 2020
This work is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License."><meta itemprop=dateModified content="2023-08-10T16:48:12-05:00"><meta itemprop=wordCount content="23"><title>Web Application Development :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/ rel=canonical type=text/html title="Web Application Development :: CIS 526 Textbook"><link href=/cis526/index.xml rel=alternate type=application/rss+xml title="Web Application Development :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1744419069 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1744419069 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1744419069 rel=stylesheet><link href=/cis526/css/auto-complete.css?1744419069 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1744419069 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1744419069 rel=stylesheet><link href=/cis526/css/fonts.css?1744419069 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1744419069 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1744419069 rel=stylesheet><link href=/cis526/css/theme-auto.css?1744419069 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1744419069 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1744419069 rel=stylesheet><link href=/cis526/css/print.css?1744419069 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1744419069 rel=stylesheet><script src=/cis526/js/variant.js?1744419069></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath=".",window.relearn.relBaseUri="..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1744419069 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><span class=topbar-control><i class="fa-fw fas fa-chevron-left"></i></span></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/00-forward/ title="Course Information (ü°í)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable home" tabindex=-1><div class=flex-block-wrapper><article class=home><header class=headline></header><h1 id=web-application-development>Web Application Development</h1><p>CIS 526 Course Textbook</p><p>Nathan Bean</p><p>Kansas State University</p><p>¬© 2020</p><p><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png></a><br>This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Web Application Development</h1><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 0</div><h1 id=course-information>Course Information</h1><p>Getting Oriented</p><div class="box notices cstyle noiframe"><div class=box-label><i class="fa-fw fas fa-times-circle"></i> Web Only</div><div class=box-content><p>This textbook was authored for the <strong>CIS 526 - Web Application Development</strong> course at Kansas State University. This front matter is specific to that course. If you are not enrolled in the course, please disregard this section.</p></div></div><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Course Information</h1><article class=default><header class=headline></header><h1 id=course-introduction>Course Introduction</h1><div class="box notices cstyle noiframe"><div class=box-label><i class="fa-fw fas fa-times-circle"></i> Web Only</div><div class=box-content><p>This textbook was authored for the <strong>CIS 526 - Web Application Development</strong> course at Kansas State University. This front matter is specific to that course. If you are not enrolled in the course, please disregard this section.</p></div></div><h2 id=course-resources>Course Resources</h2><ul><li><a href=/cis526/00-forward/01-introduction/old/>Previous Versions</a></li><li><a href=https://textbooks.cs.ksu.edu/cis526/00-forward/06-syllabus/ rel=external target=_blank>Syllabus</a></li><li><a href=https://textbooks.cs.ksu.edu/cis526 rel=external target=_blank>Textbook</a></li></ul><p>Hello, and welcome to CIS 526 - Web Application Development, and also CC 515 - Full Stack Web Development. Even though these are two different courses in the catalog, they teach the same content and will use the same Canvas course. So, anywhere you see CIS 526 in this course, you can also mentally substitute CC 515 in its place.</p><p>My name is Nathan Bean, and I will be your instructor for this course. My contact information is shown here, and is also listed on the syllabus, and on the home page of the course on K-State Online. My email address is <a href=mailto:nhbean@ksu.edu rel=external target=_blank>nhbean@ksu.edu</a>, and it is the official method of communication for matters outside of this course, since it allows me to have a record of our conversations and respond when I&rsquo;m available. I&rsquo;ll also be available via the K-State Teams app and the K-State CS Discord server, so you can easily chat with me there.</p><p>For communication in this course, there are two basic methods that I recommend. For general questions about the course, content, getting help with labs, and any other items relevant to the course, I encourage you to use the Ed Discussion board accessible through Canvas. This allows all of us to communicate in a single space, and it also means that any questions I answer will immediately be available for the whole class. For personal issues, grading questions, or if you have something that is a &ldquo;to-do&rdquo; item for me, please email me directly.</p><p>Before we begin, I must give credit to Russell Feldhausen for expanding the content of this course and preparing many of the videos you&rsquo;ll be watching - so you&rsquo;ll be seeing his face as often (or perhaps more often) than mine.</p><p>For a brief overview of the course, there are a total of 8 modules of content, containing textbook pages, activities, tutorials, and more that you&rsquo;ll complete. In addition, throughout the semester you&rsquo;ll be working on a large-scale web application project which consists of 6 milestones. The modules are configured in K-State Canvas as gated modules, meaning that you must complete each item in the module in order before continuing. There will be one module due each week, and you may work ahead at your own pace. Finally, all work in this course must be completed and all labs graded by no later than May 3rd, 2024.</p><p>Looking ahead to the rest of this first module, you&rsquo;ll see that there are a few more items to be completed before you can move on. In the next video, Russ will discuss a bit more information about navigating through this course on Canvas, using Codio, and using the videos posted on YouTube.</p><p>One thing I highly encourage each of you to do is read the syllabus for this course in its entirety, and let me know if you have any questions. My view is that the syllabus is a contract between me as your teacher and you as a student, defining how each of us should treat each other and what we should expect from each other. I have made a few changes to my standard syllabus template for this course, and those changes are clearly highlighted. Finally, the syllabus itself is subject to change as needed as we adapt to this new course layout and format, and all changes will be clearly communicated to everyone before they take effect.</p><p>The grading in this course is very simple. First, 15% of your grade consists of completing the short activities and quizzes scattered throughout the course. Another 35% of your grade consists of completing the interactive tutorials. Finally, 50% of your grade comes from completing the 6 project milestones throughout the semester. Also, notice that the final milestone is worth double the amount of points, so it is very important that you get to the end of the course and complete that milestone. There will be some extra credit points available, mainly through the <strong>Bug Bounty</strong> assignment, which you will review as part of this module. Lastly, the standard &ldquo;90-80-70-60&rdquo; grading scale will apply, though I reserve the right to curve grades up to a higher grade level at my discretion. Therefore, you will never be required to get higher than 90% for an A, but you may get an A if you score slightly below 90% if I choose to curve the grades.</p><p>Since this is a completely online course, you may be asking yourself what is different about this course. First off, you can work ahead at your own pace, and turn in work whenever you like before the due date. However, as discussed before, you must do all the readings and assignments in order before moving on, so you cannot skip ahead.</p><p>In addition, due to the flexible online format of this class, there won&rsquo;t be any long lecture videos to watch. Instead, each module will consist of several short lessons and tutorials, each focused on a particular topic or task. Likewise, there won&rsquo;t be any textbooks formally used, but you&rsquo;ll be directed to a bevy of online resources for additional information.</p><p>What hasn&rsquo;t changed, though, is the basic concept of a college course. You&rsquo;ll still be expected to watch or read about 6 hours of content to complete each module. In addition to that, each lab assignment may require anywhere from 1 to 6 hours of work to complete. If you plan on doing a module every week, that roughly equates to 6 hours of content and 6 hours of homework each week, which is the expected workload from a 3 credit hour college course during the summer.</p><p>Also, while some of the activities will be graded automatically, much of the grading will still be done directly by me. This includes the project milestones. For each milestone, I&rsquo;ll try to give you timely feedback so you can improve on your design before the next milestone is due.</p><p>For this class, each student is required to have access to a modern web browser and a high-speed internet connection. If you have any concerns about meeting these requirements, please contact me ASAP! We may have options available through some on-campus resources to help you out.</p><p>This summer, I&rsquo;ll be working on a few updates to this course. These updates will mainly affect the second half of the course, and focus on updating a few of the items and introducing some newer technologies and libraries you may come across.</p><p>Finally, as you are aware, this course is always subject to change. While we have taught this class several times before, there may be a few hiccups as we get started due to new software and situations. The best advice I have is to look upon this graphic with the words &ldquo;Don&rsquo;t Panic&rdquo; written in large, friendly letters, and remember that it&rsquo;ll all work out in the end as long as you know where your towel is.</p><p>So, to complete this module, there are a few other things that you&rsquo;ll need to do. The next step is to watch the video on navigating Canvas and using the YouTube videos, which will give you a good idea of how to most effectively work through the content in this course.</p><p>To get to that video, click the &ldquo;Next&rdquo; button at the bottom right of this page.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Course Introduction</h1></section><article class=default><header class=headline></header><h1 id=navigating-canvas>Navigating Canvas</h1><div class="box notices cstyle noiframe"><div class=box-label><i class="fa-fw fas fa-times-circle"></i> Web Only</div><div class=box-content><p>This textbook was authored for the <strong>CIS 526 - Web Application Development</strong> course at Kansas State University. This front matter is specific to that course. If you are not enrolled in the course, please disregard this section.</p></div></div><p><a href="https://www.youtube.com/watch?v=DVXqJh0N3ss">YouTube Video</a></p><p>This course makes extensive use of several features of Canvas which you may or may not have worked with before. To give you the best experience in this course, this page will briefly describe those features and the best way to access them.</p><p>When you first access the course on Canvas, you will be shown this homepage, with my contact information and any important information about the course. This is a quick, easy reference for you if you ever need to get in touch with me.</p><p>Let‚Äôs walk through the options in the main menu to the left. First, any course announcements will be posted in the <strong>Announcements</strong> section, which is available here. Those announcements will also be configured to send emails to all students when they are posted, though in your personal Canvas settings you can disable email notifications if you so choose. Please make sure you check here often for any updates to course information.</p><p>The next section is <strong>Modules</strong>, which is where you‚Äôll primarily interact with the course. You‚Äôll notice that I‚Äôve disabled several of the common menu items in this course, such as Files and Assignments. This is to simplify things for you as students, so you remember that all the course content is available in one place.</p><p>When you first arrive at the Modules section, you‚Äôll see all of the content in the course laid out in order. If you like, you can minimize the modules you aren‚Äôt working on by clicking the arrow to the left of the module name.</p><p>As you look at each module, you‚Äôll see that it gives quite a bit of information about the course. At the top of each module is an item telling you what parts of the module you must complete to continue. In this case, it says ‚ÄúComplete All Items.‚Äù Likewise, the following modules may list a prerequisite module, which you must complete before you can access it.</p><p>Within each module is a set of items, which must be completed in listed order. Under each item you‚Äôll see information about what you must do in order to complete that item. For many of them, it will simply say ‚Äúview,‚Äù which means you must view the item at least once to continue. Others may say ‚Äúcontribute,‚Äù ‚Äúsubmit,‚Äù or give a minimum score required to continue. For assignments, it also helpfully gives the number of points available, and the due date.</p><p>Let‚Äôs click on the first item, Course Introduction, to get started. You‚Äôve already been to this page by this point. Course pages will primarily consist of readings covering the content of the course. Some may also include an embedded video; in this case the video will be followed by slides and a downloadable version of the video, and a rough script for quick reference - as is the case for this page.</p><p>When you are ready to move to the next step in a module, click the ‚ÄúNext‚Äù button at the bottom of the page. Canvas will automatically add ‚ÄúNext‚Äù and ‚ÄúPrevious‚Äù buttons to each piece of content which is accessed through the Modules section, which makes it very easy to work through the course content. I‚Äôll click through a couple of items here.</p><p>At any point, you may click on the Modules link in the menu to the left to return to the Modules section of the site. You‚Äôll notice that I‚Äôve viewed the first few items in the first module, so I can access more items here. This is handy if you want to go back and review the content you‚Äôve already seen, or if you leave and want to resume where you left off. Canvas will put green checkmarks to the right of items you‚Äôve completed.</p><p>Finally, you‚Äôll find the usual Canvas links to view your <strong>Grades</strong> in the course, as well as <strong>People</strong> listing instructors, TAs, and fellow students taking the course.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=where-to-find-help>Where to Find Help</h1><div class="box notices cstyle noiframe"><div class=box-label><i class="fa-fw fas fa-times-circle"></i> Web Only</div><div class=box-content><p>This textbook was authored for the <strong>CIS 526 - Web Application Development</strong> course at Kansas State University. This front matter is specific to that course. If you are not enrolled in the course, please disregard this section.</p></div></div><p><a href="https://www.youtube.com/watch?v=Tn7EOurEULw">YouTube Video</a></p><h4 id=resources>Resources</h4><ul><li><a href=/cis526/00-forward/03-where-to-find-help-slides/>Slides</a></li><li><a href=https://www.k-state.edu/its/helpdesk/ rel=external target=_blank>K-State IT Help Desk</a> - Email <a href=mailto:helpdesk@ksu.edu rel=external target=_blank>helpdesk@ksu.edu</a></li><li><a href=https://textbooks.cs.ksu.edu/cis526/00-forward/06-syllabus/ rel=external target=_blank>Syllabus</a></li><li><a href=http://public.online.k-state.edu/help/ rel=external target=_blank>K-State Online Canvas Help</a></li><li><a href=https://community.canvaslms.com/community/answers/guides rel=external target=_blank>Instructure Canvas Guides</a></li><li><a href=https://docs.codio.com/ rel=external target=_blank>Codio Documentation</a></li><li><a href=http://www.lib.k-state.edu/ rel=external target=_blank>K-State Libraries</a></li><li><a href=https://support.cs.ksu.edu/ rel=external target=_blank>K-State CS Support</a></li><li><a href=https://discordbot.cs.ksu.edu/ rel=external target=_blank>K-State CS Discord</a></li><li><a href=https://www.cs.ksu.edu/undergraduate/advising/ rel=external target=_blank>K-State CS Advising</a></li><li><a href=https://www.engg.ksu.edu/studentservices/ rel=external target=_blank>K-State Engineering Student Services</a></li><li><a href=https://www.k-state.edu/studentlife/ rel=external target=_blank>K-State Office of Student Life</a></li><li><a href=https://www.k-state.edu/report/ rel=external target=_blank>K-State Report It</a></li></ul><p>As you work on the materials in this course, you may run into questions or problems and need assistance. This video reviews the various types of help available to you in this course.</p><p>First and foremost, anytime you have a questions or need assistance in the course, please post in the course Discord room. It is the best place to go to get help with anything related to this course, from the tutorials and projects to issues with Codio and Canvas. Before you post on Discord, take a minute to look around and make sure the question has not already been posted before. It will save everyone quite a bit of time.</p><p>There are a few major reasons we‚Äôve chosen to use Discord in this program. Our goal is to respond as quickly as possible, and having a single place for all questions allows the instructors and the TAs to work together to answer questions and solve problems quickly. As an added bonus, it reduces the amount of email generated by the class. Discord includes lots of features to make your messages easily readable using both markdown and code blocks. Finally, by participating in discussions on Discord and helping to answer questions from your fellow students, you can earn extra credit points!</p><p>Of course, as another step you can always exercise your information-gathering skills and use online search tools such as Google to answer your question. While you are not allowed to search online for direct solutions to assignments or projects, you are more than welcome to use Google to access programming resources such as the Mozilla Developer Network, Node language documentation, CSS-Tricks, StackOverflow, and other tutorials. I can definitely assure you that programmers working in industry are often using Google and other online resources to solve problems, so there is no reason why you shouldn‚Äôt start building that skill now.</p><p>If all else fails, please email me and let me know. Make sure you clearly explain your question and the steps you&rsquo;ve taken to solve it thus far. If I feel it can be easily answered by one of the earlier steps, I may redirect you back to those before answering it directly. But, at times there are indeed questions that come up that don&rsquo;t have an easy answer, and I&rsquo;m more than happy to help answer them as needed.</p><p>Beyond Discord, there are a few resources you should be aware of. First, if you have any issues working with K-State Canvas, K-State IT resources, or any other technology related to the delivery of the course, your first source of help is the K-State IT Helpdesk. They can easily be reached via email at <a href=mailto:helpdesk@ksu.edu rel=external target=_blank>helpdesk@ksu.edu</a>. Beyond them, there are many online resources for using Canvas, all of which are linked in the resources section below the video. As a last resort, you may also want to post in Discord, but in most cases we may simply redirect you to the K-State helpdesk for assistance.</p><p>Similarly, if you have any issues using the Codio platform, you are welcome to refer to their online documentation. Their support staff offers a quick and easy chat interface where you can ask questions and get feedback within a few minutes.</p><p>Next, we have grading and administrative issues. This could include problems or mistakes in the grade you received on a project, missing course resources, or any concerns you have regarding the course and the conduct of myself and your peers. Since this is an online course, you‚Äôll be interacting with us on a variety of online platforms, and sometimes things happen that are inappropriate or offensive. There are lots of resources at K-State to help you with those situations. First and foremost, please DM me on Discord as soon as possible and let me know about your concern, if it is appropriate for me to be involved. If not, or if you‚Äôd rather talk with someone other than me about your issue, I encourage you to contact either your academic advisor, the CS department staff, College of Engineering Student Services, or the K-State Office of Student Life. Finally, if you have any concerns that you feel should be reported to K-State, you can do so at <a href=https://www.k-state.edu/report/ rel=external target=_blank>https://www.k-state.edu/report/</a>. That site also has links to a large number of resources at K-State that you can use when you need help.</p><p>Finally, if you find any errors or omissions in the course content, or have suggestions for additional resources to include in the course, DM the instructors on Discord. There are some extra credit points available for helping to improve the course, so be on the lookout for anything that you feel could be changed or improved.</p><p>So, in summary, Discord should always be your first stop when you have a question or run into a problem. For issues with Canvas or Codio, you are also welcome to refer directly to the resources for those platforms. For questions specifically related to the projects, use Discord for sure. For grading questions and errors in the course content or any other issues, please PM the instructors on Discord for assistance.</p><p>Our goal in this program is to make sure that you have the resources available to you to be successful. Please don‚Äôt be afraid to take advantage of them and ask questions whenever you want.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=what-youll-learn>What You'll Learn</h1><div class="box notices cstyle noiframe"><div class=box-label><i class="fa-fw fas fa-times-circle"></i> Web Only</div><div class=box-content><p>This textbook was authored for the <strong>CIS 526 - Web Application Development</strong> course at Kansas State University. This front matter is specific to that course. If you are not enrolled in the course, please disregard this section.</p></div></div><p>The following is an outline of the topics we will be covering and when.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>This course is still under development, so some of the content listed here may change before we reach that module.</p></div></div><h4 id=week-1-web-application-foundations>Week 1: Web Application Foundations</h4><ul><li>The Document Object Model<ul><li>Chapter 1</li><li>[Tutorial] Creating a Dialog</li></ul></li><li>HTTP<ul><li>Chapter 2</li><li>[Activity] Making Manual HTTP Requests</li></ul></li><li>Responsive Design<ul><li>Chapter B</li><li>[Tutorial] Responsive Card Layout</li></ul></li><li>Project Milestone 1<ul><li>Card Layout</li><li>Accessing Data from a Web API</li></ul></li></ul><h4 id=week-2-advanced-javascript>Week 2: Advanced JavaScript</h4><ul><li>JSON and AJAX<ul><li>[Activity] Working with JSON</li><li>[Activity] Making an AJAX Request</li></ul></li><li>Asynchronous JavaScript<ul><li>Chapter 3</li><li>[Tutorial] Web Workers</li></ul></li><li>Introduction to Node<ul><li>Chapter 4</li><li>[Tutorial] Your First Package</li><li>[Activity] Fun with Files</li></ul></li><li>Project Milestone 2<ul><li>Request Data via AJAX</li><li>Dynamically Render Page</li></ul></li></ul><h4 id=week-3-web-servers>Week 3: Web Servers</h4><ul><li>Basic Web Server<ul><li>Chapter 5</li><li>[Tutorial] Hello Web</li></ul></li><li>File Server Basics<ul><li>Chapter 5 (cont.)</li><li>[Tutorial] Node File Server</li></ul></li><li>Directory Listing<ul><li>Chapter 5 (cont.)</li><li>[Tutorial] Directory Listing</li></ul></li><li>Partial Downloads<ul><li>Chapter 5 (cont.)</li><li>Chapter C</li><li>[Activity] Regular Expressions</li><li>[Tutorial] Streaming Media</li></ul></li><li>Project Milestone 3<ul><li>Refactor Project to Node</li></ul></li></ul><h4 id=week-4-dynamic-web-servers>Week 4: Dynamic Web Servers</h4><ul><li>Server Pages<ul><li>Chapter 6</li><li>[Exercise] ECMAScript Server Pages</li><li>[Tutiroal] Image Gallery</li></ul></li><li>Uploading Data<ul><li>Chapter 6 (cont.)</li><li>[Exercise] Uploading Form Data</li><li>[Exercise] Uploading Files</li></ul></li><li>Adding State<ul><li>Chapter 6 (cont.)</li><li>[Activity] Fun with Cookies</li><li>[Tutorial] Gallery Favorites</li></ul></li></ul><h4 id=week-5-full-stack-development>Week 5: Full Stack Development</h4><ul><li>Templates<ul><li>Chapter 6 (cont.)</li><li>[Tutorial] Node Directory Listing in EJS</li><li>[Exercise] A Template By Another Name</li></ul></li><li>Full Stack Development<ul><li>Chapter 6 (cont.)</li></ul></li><li>Persistent Storage<ul><li>Chapter 7</li><li>[Tutorial] Blog Part 1</li></ul></li><li>Routing<ul><li>Chapter 8</li><li>[Tutorial] Blog Part 2</li><li>[Tutorial] Blog Part 3</li></ul></li><li>Project Milestone 4<ul><li>REfactor to Express</li><li>Add API Endpoints</li><li>Handle Requests for Items</li><li>Templates</li></ul></li></ul><h4 id=week-6-web-frameworks>Week 6: Web Frameworks</h4><ul><li>Authentication<ul><li>Chapter 9</li><li>[Tutorial] Blog Part 4</li><li>[Tutorial] Blog Part 5</li></ul></li><li>APIs<ul><li>Chapter 8 (cont.)</li><li>[Tutorial] Blog Part 6</li><li>[Exercise] Web Hook Demo</li></ul></li><li>Web Frameworks<ul><li>Chapter 10</li><li>[Tutorial] Single Page App Part 1</li><li>[Tutorial] Single Page App Part 2</li></ul></li><li>Project Milestone 5<ul><li>Implement Authentication</li><li>Restrict Form Access to Authenticated Users</li></ul></li></ul><h4 id=week-7--8-potpourri>Week 7 & 8: Potpourri</h4><ul><li>Single Sign On<ul><li>Chapter 9 (cont.)</li><li>[Tutorial] CAS Authentication</li></ul></li><li>ASP.NET MVC<ul><li>[Tutorial] ASP.NET MVC</li></ul></li><li>React & Websockets<ul><li>[Tutorial] React Chat App</li></ul></li><li>Project Milestone 6<ul><li>Mark Requests Complete</li><li>Administrator Role & Tasks</li></ul></li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=course-textbooks>Course Textbooks</h1><div class="box notices cstyle noiframe"><div class=box-label><i class="fa-fw fas fa-times-circle"></i> Web Only</div><div class=box-content><p>This textbook was authored for the <strong>CIS 526 - Web Application Development</strong> course at Kansas State University. This front matter is specific to that course. If you are not enrolled in the course, please disregard this section.</p></div></div><p>This course does not have a required print textbook. The resources presented in the modules are also organized into an online textbook that can be accessed here: <a href=https://textbooks.cs.ksu.edu/cis526 rel=external target=_blank>https://textbooks.cs.ksu.edu/cis526</a>. You may find this a useful reference if you prefer a traditional textbook layout. Additionally, since the textbook exists outside of Canvas&rsquo; access control, you can continue to utilize it after the course ends.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>Please note that the materials presented in Canvas have additional graded assignments and exercises worked into the reading order that do not appear in the online edition of the textbook. You are responsible for completing these!</p></div></div><h2 id=oreilly-for-higher-education>O&rsquo;Reilly for Higher Education</h2><p>If you are looking for additional resources to support your learning, a great resource that is available to Kansas State University students is the <a href=https://go.oreilly.com/kansas-state-university rel=external target=_blank>O&rsquo;Reilley For Higher Education</a> digital library offered through the Kansas State University Library. These include electronic editions of thousands of popular textbooks as well as videos and tutorials. As of this writing, a search for HTML returns 33,690 results, CSS 8,638 results, JavaScript 16,725 results, and Node.js 6,572 results.</p><p>There are likewise materials for other computer science topics you may have an interest in - it is a great resource for all your CS coursework. It costs you nothing (technically, your access was paid for by your tuition and fees), so you might as well make use of it!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=spring-2025-syllabus>Spring 2025 Syllabus</h1><div class="box notices cstyle noiframe"><div class=box-label><i class="fa-fw fas fa-times-circle"></i> Web Only</div><div class=box-content><p>This textbook was authored for the <strong>CIS 526 - Web Application Development | CC 515 - Full Stack Web Development</strong> course at Kansas State University. This front matter is specific to that course. If you are not enrolled in the course, please disregard this section.</p></div></div><h2 id=cis-526---web-application-development>CIS 526 - Web Application Development</h2><h2 id=cc-515---full-stack-web-development>CC 515 - Full Stack Web Development</h2><p><em>This syllabus covers both courses. They are taught using the same content.</em></p><h3 id=instructor-contact-information>Instructor Contact Information</h3><ul><li><strong>Instructor:</strong> Nathan Bean (nhbean AT ksu DOT edu)<br><em>I use <strong>he/him</strong> pronouns. Feel free to share your own pronouns with me, and I&rsquo;ll do my best to use them!</em></li><li><strong>Office:</strong> DUE 2216</li><li><strong>Phone:</strong> (785) 483-9264 (Call/Text)</li><li><strong>Website:</strong> <a href=https://nathanhbean.com rel=external target=_blank>https://nathanhbean.com</a></li><li><strong>In-Person Office Hours:</strong> TBD</li><li><strong>Virtual Office Hours:</strong> By appointment via <a href=https://ksu.zoom.us/ rel=external target=_blank>Zoom</a>.<br></li><li><strong>Instructor:</strong> Russell Feldhausen (russfeld AT ksu DOT edu)<br><em>I use <strong>he/him</strong> pronouns. Feel free to share your own pronouns with me, and I&rsquo;ll do my best to use them!</em></li><li><strong>Office:</strong> DUE 2213, but I mostly work remotely from Kansas City, MO</li><li><strong>Phone:</strong> (785) 292-3121 (Call/Text)</li><li><strong>Website:</strong> <a href=https://russfeld.me rel=external target=_blank>https://russfeld.me</a></li><li><strong>Virtual Office Hours:</strong> By appointment via <a href=https://ksu.zoom.us/ rel=external target=_blank>Zoom</a>. Schedule a meeting at <a href=https://calendly.com/russfeld rel=external target=_blank>https://calendly.com/russfeld</a></li></ul><h3 id=preferred-methods-of-communication>Preferred Methods of Communication:</h3><ul><li><strong>Email</strong>: Email is the official method of communication for this course. Any emails sent to the instructor regarding this course should be answered within one class day.</li><li><strong>Ed Discussions</strong>: For short questions and discussions of course content and assignments, Ed Discussions is preferred since questions can be asked once and answered for all students. The Ed Discussion board can be accessed through the course navigation on Canvas. Students are encouraged to post questions there and use that space for discussion, and the instructor will strive to answer questions there as well.</li><li><strong>Phone/Text:</strong> <em>Emergencies only!</em> I will do my best to respond as quickly as I can.</li></ul><h3 id=gta-contact-information>GTA Contact Information</h3><ul><li><strong>GTA:</strong> Josh Barron (jrbarron AT ksu DOT edu)</li><li><strong>Office:</strong> DUE 2208, Office Hours held in DUE 1118</li><li><strong>In-Person Office Hours:</strong> Mondays 1 - 3 PM, Tuesdays 9 - 10 AM</li><li><strong>Remote Office Hours:</strong> By appointment via <a href=https://ksu.zoom.us/ rel=external target=_blank>Zoom</a>. Schedule a meeting at <a href=https://calendly.com/joshbarron2222 rel=external target=_blank>https://calendly.com/joshbarron2222</a></li></ul><h3 id=prerequisites>Prerequisites</h3><ul><li><strong>CIS 526</strong>: CIS 501, CIS 560 (Prerequisite or Concurrent Enrollment), and either CC 120,CMST 135, or equivalent experience in HTML, CSS, and JavaScript with instructor permission.</li><li><strong>CC 515</strong>: CC 315, CC 410 (Prerequisite or Concurrent Enrollment), and either CC 120, CMST 135, or equivalent experience in HTML, CSS, and JavaScript with instructor permission.</li></ul><p><em>Students may enroll in CIS or CC courses only if they have earned a grade of C or better for each prerequisite to those courses.</em></p><h3 id=course-overview>Course Overview</h3><p>Fundamental principles and best practices of web development, user interface design, web API design, advanced web interfaces, web development frameworks, single-page web applications, web standards and accessibility issues.</p><h3 id=course-description>Course Description</h3><p>This course focuses on the creation of web applications - programs that use the core technologies of the world-wide-web to deliver interactive and dynamic user experiences. It builds upon a first course in authoring web pages using HTML/CSS/JavaScript, introduces the creation of web servers using the Node programming languages, and building sophisticated web clients using declarative component-based design frameworks like React.</p><h3 id=student-learning-outcomes>Student Learning Outcomes</h3><p>The following are the learning objectives of this course:</p><ol><li>Students will develop a thorough understanding of the http client request - server response pattern, and be able to implement multiple kinds of requests and responses, including HTML tags, browser-based JavaScript, programmatically, and with tools.</li><li>Students will understand and be able to make use of asynchronous programming, including creating original asynchronous functions and utilizing promises and the async/await key words.</li><li>Students will be able to develop traditional full-stack web applications using Node, a SQL database, and a Linux OS.</li><li>Students will be able to develop client-side [progressive] web applications using transpilation and minimization.</li><li>Students will be able to develop secure web applications using password authentication, cookies, and json web tokens.</li></ol><h3 id=major-course-topics>Major Course Topics</h3><ul><li>The Document Object Model</li><li>Responsive Web Design</li><li>JavaScript Object Serialization Notation</li><li>JavaScript Event Loop</li><li>Asynchronous functions</li><li>Promises</li><li>async/await</li><li>HTTP</li><li>AJAX & Fetch</li><li>Routing</li><li>REST</li><li>Form Serialization Formats</li><li>Developing APIs</li><li>Database Object Relational Mappers</li><li>Template Rendering</li><li>Single-page Applications</li><li>Progressive Web Applications</li></ul><h3 id=course-structure>Course Structure</h3><p>This course is divided in modules, which typically consist of a series of lesson content (as video lectures or online textbook materials) followed by a hands-on tutorial. The tutorials show how to take the ideas just discussed in the lessons and apply them in creating web applications in a step-by-step manner. Following every third module is a larger project assignment, where you will utilize the skills you&rsquo;ve been developing from the lessons and tutorials to iteratively create a web application.</p><p>For the eight-week summer course, each cluster of three modules plus project should be completed in one week. There is a lot to learn and much of the learning involved is hands-on as you work on the code for tutorials and your projects. It is recommended you set aside 10-20 hours per week to focus on this course.</p><h3 id=the-work>The Work</h3><p>There is no shortcut to becoming a great programmer or web developer. Only by <strong>doing the work</strong> will you develop the skills and knowledge to make you a successful web developer. This course is built around that principle, and gives you ample opportunity to do the work, with as much support as we can offer.</p><p><strong>Lessons:</strong> Lessons are delivered in written or video (with written transcript) form. Sprinkled between lessons are activities and quizzes that check your understanding of the readings and lecture content.</p><p><strong>Tutorials:</strong> Tutorials are delivered through Codio, and offer immediate, automatically generated feedback as you complete the assignments, letting you know if you&rsquo;ve made a mistake or skipped a step. You can run these assessments as many times as needed until you have completed the project to your satisfaction.</p><p><strong>Projects:</strong> The projects are more free-form - I want you to be able to flex your creative muscles and make a web app that both meets your customer&rsquo;s needs and reflects your own style and approach. These will be graded by hand using a rubric that focuses on functionality, code quality, accessibility, and aesthetics.</p><h3 id=grading>Grading</h3><p>In theory, each student begins the course with an A. As you submit work, you can either maintain your A (for good work) or chip away at it (for less adequate or incomplete work). In practice, each student starts with 0 points in the gradebook and works upward toward a final point total earned out of the possible number of points. IIn this course, each assignment constitutes a a portion of the final grade, as detailed below:</p><ul><li>15% - Activities & Quizzes</li><li>35% - Tutorials</li><li>50% - Projects</li></ul><p>Up to 5% of the total grade in the course is available as extra credit. See the <strong>Extra Credit - Bug Bounty</strong> and <strong>Extra Credit - Helping Hand</strong> assignments for details.</p><p>Letter grades will be assigned following the standard scale:</p><ul><li>90% - 100% ‚Üí A</li><li>80% - 89.99% ‚Üí B</li><li>70% - 79.99% ‚Üí C</li><li>60% - 59.99% ‚Üí D*</li><li>50% - 0% ‚Üí F</li></ul><p><em>* Note that CS Majors must earn a C or better to use the CIS 526 course for their degree.</em></p><h3 id=submission-regrading-and-early-grading-policy>Submission, Regrading, and Early Grading Policy</h3><p>As a rule, submissions in this course will not be graded until after they are due, even if submitted early. Students may resubmit assignments many times before the due date, and only the latest submission will be graded. For assignments submitted via GitHub release tag, only the tagged release that was submitted to Canvas will be graded, even if additional commits have been made. Students must create a new tagged release and resubmit that tag to have it graded for that assignment.</p><p>Once an assignment is graded, students are not allowed to resubmit the assignment for regrading or additional credit without special permission from the instructor to do so. In essence, students are expected to ensure their work is complete and meets the requirements before submission, not after feedback is given by the instructor during grading. However, students should use that feedback to improve future assignments and milestones.</p><p>For the programming project milestones, it is solely at the discretion of the instructor whether issues noted in the feedback for a milestone will result in grade deductions in a later milestones if they remain unresolved, though the instructor will strive to give students ample time to resolve issues before any additional grade deductions are made.</p><p>Likewise, students may ask questions of the instructor while working on the assignment and receive help, but the instructor will not perform a full code review nor give grading-level feedback until after the assignment is submitted and the due date has passed. Again, students are expected to be able to make their own judgments on the quality and completion of an assignment before submission.</p><p>That said, a student may email the instructor to request early grading on an assignment before the due date, in order to move ahead more quickly. The instructor&rsquo;s receipt of that email will effectively mean that the assignment for that student is due immediately, and all limitations above will apply as if the assignment&rsquo;s due date has now passed.</p><h3 id=collaboration-policy>Collaboration Policy</h3><p>In this course, all work submitted by a student should be created solely by the student without any outside assistance beyond the instructor and TA/GTAs. Students may seek outside help or tutoring regarding concepts presented in the course, but should not share or receive any answers, source code, program structure, or any other materials related to the course. Learning to debug problems is a vital skill, and students should strive to ask good questions and perform their own research instead of just sharing broken source code when asking for assistance.</p><p>That said, the field of web development requires the use of lots of online documentation and reference materials, and the point of the class is to learn how to effectively use those resources instead of &ldquo;reinventing the wheel from scratch&rdquo; in each assignment. Whenever content in an assignment is taken from an outside source, this should be noted somewhere in the assignment.</p><h3 id=late-work>Late Work</h3><p>In this class, there is a tremendous amount of new skills to develop in a short amount of time. Falling behind <em>will</em> jeopardize your chances of successfully completing the course. Trying to complete late assignments while also working on new material will also make it unlikely that you will retain what you are trying to learn. It is critical that you keep on-track.</p><p>Any work submitted and graded after the due date is subject to a deduction of <strong>10% of the total points possible on the assignment for each day</strong> that the assignment is late. For example, if an assignment is due on a Friday and is submitted the following Tuesday, it will be subject to a reduction of 40% of the total points possible, or 10% for each class day it was late. <em>These late penalties will be automatically entered by Canvas - contact the instructor if any grades appear to be incorrect.</em></p><p>These deductions will only be applied to grades above 50% of the total points on the assignment. So, if you scored higher than 50%, your grade will be reduced by the late penalty down to a minimum grade of 50%. If you scored lower than 50% on the assignment, no deductions will be applied.</p><p>However, even if a module is not submitted on time, it must still be completed before a student is allowed to begin the next module. So, students should take care not to get too far behind, as it may be very difficult to catch up.</p><p>All course work must be submitted, and all interactively graded materials must be graded with the instructor, on or before the last day of the semester in which the student is enrolled in the course in order for it to be graded on time. No late work will be accepted after that date.</p><p>If you have extenuating circumstances, please discuss them with the instructor as soon as they arise so other arrangements can be made. If you know you have upcoming events that will prevent you from completing work in this course, you should contact the instructor ASAP and plan on working ahead before your event instead of catching up afterwards. If you find that you are getting behind in the class, you are encouraged to speak to the instructor for options to catch up quickly.</p><h3 id=incomplete-policy>Incomplete Policy</h3><p>Students should strive to complete this course in its entirety before the end of the semester in which they are enrolled. However, since retaking the course would be costly and repetitive for students, we would like to give students a chance to succeed with a little help rather than immediately fail students who are struggling.</p><p>If you are unable to complete the course in a timely manner, please contact the instructor to discuss an incomplete grade. Incomplete grades are given solely at the instructor&rsquo;s discretion. See the official <a href=https://www.k-state.edu/registrar/students/academicpolicy/#GRADING rel=external target=_blank>K-State Grading Policy</a> for more information. In general, <em>poor time management alone is not a sufficient reason for an incomplete grade</em>.</p><p>Unless otherwise noted in writing on a signed <a href=https://www.k-state.edu/registrar/faculty-staff/forms/Incomplete%20agreement%20form.docx rel=external target=_blank>Incomplete Agreement Form</a>, the following stipulations apply to any incomplete grades given in this course:</p><ol><li>Students will be given 6 calendar weeks from the end of the enrolled semester&rsquo;s finals week to complete the course</li><li>Students understand that access to instructor and GTA assistance may be limited after the end of an academic semester due to holidays and other obligations</li><li>If a student fails to resolve an incomplete grade after 6 weeks, they will be assigned an &lsquo;F&rsquo; in the course. In addition, they will be dropped from any other courses which require the failed course as a prerequisite or corequisite.</li><li>For CC courses only:<ol><li>Students may receive at most two incompletes in Computational Core courses throughout their time in the program.</li><li>Any modules in a future CC course which depend on incomplete work will not be accessible until the previous course is finished<ol><li>For example, if a student is given an incomplete in CC 210, then all modules in CC 310 will be inaccessible until CC 210 is complete</li></ol></li></ol></li></ol><h3 id=recommended-texts--supplies>Recommended Texts & Supplies</h3><p>To participate in this course, students must have access to a modern web browser and broadband internet connection. All course materials will be provided via Canvas, Codio, and GitHub. Modules may also contain links to external resources for additional information, such as programming language documentation.</p><p>In particular you are encouraged to use:</p><ul><li><a href=https://nodejs.org/en/docs/ rel=external target=_blank>Node Docs</a> - THe documentation for the Nodejs platform and APIs.</li><li><a href=https://developer.mozilla.org rel=external target=_blank>Mozilla Developer Network</a> - A key reference explaining how browsers implement the web standards</li><li><a href=https://css-tricks.com/ rel=external target=_blank>CSS-Tricks</a> - A collection of guides and articles on using CSS to accomplish a variety of tasks</li><li><a href=https://www.w3.org/ rel=external target=_blank>w3c.org</a> - The online home of the World-Wide-Web Consortium, the organization that sets web technology standards</li></ul><p>This course offers an instructor-written textbook, which is broken up into a specific reading order and interleaved with activities and quizzes in the modules. It can also be directly accessed at <a href=https://textbooks.cs.ksu.edu/cis526 rel=external target=_blank>https://textbooks.cs.ksu.edu/cis526</a>.</p><p>Students who would like additional textbooks should refer to resources available on the <a href=https://go.oreilly.com/kansas-state-university rel=external target=_blank>O&rsquo;Reilley For Higher Education</a> digital library offered by the Kansas State University Library. These include electronic editions of popular textbooks as well as videos and tutorials.</p><h3 id=subject-to-change>Subject to Change</h3><p>The details in this syllabus are not set in stone. Due to the flexible nature of this class, adjustments may need to be made as the semester progresses, though they will be kept to a minimum. If any changes occur, the changes will be posted on the Canvas page for this course and emailed to all students.</p><h3 id=academic-honesty>Academic Honesty</h3><p>Kansas State University has an Honor and Integrity System based on personal integrity, which is presumed to be sufficient assurance that, in academic matters, one&rsquo;s work is performed honestly and without unauthorized assistance. Undergraduate and graduate students, by registration, acknowledge the jurisdiction of the Honor and Integrity System. The policies and procedures of the <a href=https://www.k-state.edu/honor/ rel=external target=_blank>Honor and Integrity System</a> apply to all full and part-time students enrolled in undergraduate and graduate courses on-campus, off-campus, and via distance learning. A component vital to the Honor and Integrity System is the inclusion of the Honor Pledge which applies to all assignments, examinations, or other course work undertaken by students. The Honor Pledge is implied, whether or not it is stated: &ldquo;On my honor, as a student, I have neither given nor received unauthorized aid on this academic work.&rdquo; A grade of XF can result from a breach of academic honesty. The F indicates failure in the course; the X indicates the reason is an Honor Pledge violation.</p><p><strong>For this course, a violation of the Honor Pledge will result in sanctions such as a 0 on the assignment or an XF in the course, depending on severity. Actively seeking unauthorized aid, such as posting lab assignments on sites such as Chegg or StackOverflow or asking another person to complete your work, even if unsuccessful, will result in an immediate XF in the course.</strong></p><p>The Codio platform can perform automatic plagiarism detection by comparing submitted projects against other students&rsquo; submissions and known solutions. That information may be used to determine if plagiarism has taken place.</p><p>In this course, <em>unauthorized aid</em> broadly consists of <em>giving or receiving code to complete assignments</em>. This could be code you share with a classmate, code you have asked a third party to write for you, or code you have found online or elsewhere.</p><p>Authorized aid - which is not a violation of the honor policy - includes
using the code snippets provided in the course materials, discussing strategies and techniques with classmates, instructors, TAs, and mentors. Additionally, you may use code snippets and algorithms found in textbooks and web sources if you clearly label them with comments indicating where the code came from and how it is being used in your project.</p><p>You should restrict your use of code libraries to those specified in the assignment description or approved by the instructor. You can ask for approval via Discord in the course channel, and if granted, this approval is valid for the entire class <em>for the specified assignment</em>.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>While code libraries are an important and common tool in professional practice, at this point in your learning they can obscure how tasks are being accomplished, leaving your foundational knowledge incomplete. It is for this reason that we restrict the use of code libraries in the course.</p></div></div><h2 id=standard-syllabus-statements>Standard Syllabus Statements</h2><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>The statements below are standard syllabus statements from K-State and our program. The latest versions are available online <a href=https://www.k-state.edu/provost/resources/teaching/course.html rel=external target=_blank>here</a>.</p></div></div><h3 id=students-with-disabilities>Students with Disabilities</h3><p>At K-State it is important that every student has access to course content and the means to demonstrate course mastery. Students with disabilities may benefit from services including accommodations provided by the Student Access Center. Disabilities can include physical, learning, executive functions, and mental health. You may register at the <a href=https://k-state.edu/accesscenter rel=external target=_blank>Student Access Center</a> or to learn more contact:</p><ul><li>Manhattan/Olathe/Global Campus ‚Äì Student Access Center<ul><li><a href=mailto:accesscenter@k-state.edu rel=external target=_blank>accesscenter@k-state.edu</a></li><li>785-532-6441</li></ul></li><li>K-State Salina Campus ‚Äì Julie Rowe; Student Success Coordinator<ul><li><a href=mailto:jarowe@k-state.edu rel=external target=_blank>jarowe@k-state.edu</a></li><li>785-820-7908</li></ul></li></ul><p>Students already registered with the Student Access Center please request your Letters of Accommodation early in the semester to provide adequate time to arrange your approved academic accommodations. Once SAC approves your Letter of Accommodation it will be e-mailed to you, and your instructor(s) for this course. Please follow up with your instructor to discuss how best to implement the approved accommodations.</p><h3 id=expectations-for-conduct>Expectations for Conduct</h3><p>All student activities in the University, including this course, are governed by the <a href=http://www.k-state.edu/sga/judicial/ rel=external target=_blank>Student Judicial Conduct Code</a> as outlined in the Student Governing Association <a href=https://www.k-state.edu/provost/resources/teaching/syllabi-statements/KSU-SGA-By-Laws-Fall-2021.pdf rel=external target=_blank>By Laws</a>, Article V, Section 3, number 2. Students who engage in behavior that disrupts the learning environment may be asked to leave the class.</p><h3 id=mutual-respect-and-inclusion-in-k-state-teaching--learning-spaces>Mutual Respect and Inclusion in K-State Teaching & Learning Spaces</h3><p>At K-State, faculty and staff are committed to creating and maintaining an inclusive and supportive learning environment for students from diverse backgrounds and perspectives. K-State courses, labs, and other virtual and physical learning spaces promote equitable opportunity to learn, participate, contribute, and succeed, regardless of age, race, color, ethnicity, nationality, genetic information, ancestry, disability, socioeconomic status, military or veteran status, immigration status, Indigenous identity, gender identity, gender expression, sexuality, religion, culture, as well as other social identities.</p><p>Faculty and staff are committed to promoting equity and believe the success of an inclusive learning environment relies on the participation, support, and understanding of all students. Students are encouraged to share their views and lived experiences as they relate to the course or their course experience, while recognizing they are doing so in a learning environment in which all are expected to engage with respect to honor the rights, safety, and dignity of others in keeping with the <a href=https://www.k-state.edu/about/values/community/ rel=external target=_blank>K-State Principles of Community</a>.</p><p>If you feel uncomfortable because of comments or behavior encountered in this class, you may bring it to the attention of your instructor, advisors, and/or mentors. If you have questions about how to proceed with a confidential process to resolve concerns, please contact the <a href=https://www.k-state.edu/diversity-inclusion/resources/student-ombudsperson/ rel=external target=_blank>Student Ombudsperson Office</a>. Violations of the <a href=https://www.k-state.edu/sga/judicial/student-code-of-conduct.html rel=external target=_blank>student code of conduct</a> can be reported using the <a href="https://cm.maxient.com/reportingform.php?KansasStateUniv&layout_id=10" rel=external target=_blank>Code of Conduct Reporting Form</a>. You can also report <a href=https://www.k-state.edu/report/discrimination/ rel=external target=_blank>discrimination, harassment or sexual harassment</a>, if needed.</p><h3 id=netiquette>Netiquette</h3><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>This is our personal policy and not a required syllabus statement from K-State. It has been adapted from <a href=https://global.k-state.edu/students/courses/netiquette/ rel=external target=_blank>this statement</a> from K-State Global Campus, and the<a href=https://www.recurse.com/manual rel=external target=_blank>Recurse Center Manual</a>. We have adapted their ideas to fit this course.</p></div></div><p>Online communication is inherently different than in-person communication. When speaking in person, many times we can take advantage of the <em>context</em> and <em>body language</em> of the person speaking to better understand what the speaker <em>means</em>, not just what is said. This information is not present when communicating online, so we must be much more careful about what we say and how we say it in order to get our meaning across.</p><p>Here are a few general rules to help us all communicate online in this course, especially while using tools such as Canvas or Discord:</p><ul><li><strong>Use a clear and meaningful subject line to announce your topic.</strong> Subject lines such as &ldquo;Question&rdquo; or &ldquo;Problem&rdquo; are not helpful. Subjects such as &ldquo;Logic Question in Project 5, Part 1 in Java&rdquo; or &ldquo;Unexpected Exception when Opening Text File in Python&rdquo; give plenty of information about your topic.</li><li><strong>Use only one topic per message.</strong> If you have multiple topics, post multiple messages so each one can be discussed independently.</li><li><strong>Be thorough, concise, and to the point.</strong> Ideally, each message should be a page or less.</li><li><strong>Include exact error messages, code snippets, or screenshots, as well as any previous steps taken to fix the problem.</strong> It is much easier to solve a problem when the exact error message or screenshot is provided. If we know what you&rsquo;ve tried so far, we can get to the root cause of the issue more quickly.</li><li><strong>Consider carefully what you write before you post it.</strong> Once a message is posted, it becomes part of the permanent record of the course and can easily be found by others.</li><li><strong>If you are lost, don&rsquo;t know an answer, or don&rsquo;t understand something, speak up!</strong> Email and Canvas both allow you to send a message privately to the instructors, so other students won&rsquo;t see that you asked a question. Don&rsquo;t be afraid to ask questions anytime, as you can choose to do so without any fear of being identified by your fellow students.</li><li><strong>Class discussions are confidential.</strong> Do not share information from the course with anyone outside of the course without explicit permission.</li><li><strong>Do not quote entire message chains; only include the relevant parts.</strong> When replying to a previous message, only quote the relevant lines in your response.</li><li><strong>Do not use all caps.</strong> It makes it look like you are shouting. Use appropriate text markup (bold, italics, etc.) to highlight a point if needed.</li><li><strong>No feigning surprise.</strong> If someone asks a question, saying things like &ldquo;I can&rsquo;t believe you don&rsquo;t know that!&rdquo; are not helpful, and only serve to make that person feel bad.</li><li><strong>No &ldquo;well-actually&rsquo;s.&rdquo;</strong> If someone makes a statement that is not entirely correct, resist the urge to offer a &ldquo;well, actually&mldr;&rdquo; correction, especially if it is not relevant to the discussion. If you can help solve their problem, feel free to provide correct information, but don&rsquo;t post a correction just for the sake of being correct.</li><li><strong>Do not correct someone&rsquo;s grammar or spelling.</strong> Again, it is not helpful, and only serves to make that person feel bad. If there is a genuine mistake that may affect the meaning of the post, please contact the person privately or let the instructors know privately so it can be resolved.</li><li><strong>Avoid subtle -isms and microaggressions.</strong> Avoid comments that could make others feel uncomfortable based on their personal identity. See the syllabus section on Diversity and Inclusion above for more information on this topic. If a comment makes you uncomfortable, please contact the instructor.</li><li><strong>Avoid sarcasm, flaming, advertisements, lingo, trolling, doxxing, and other bad online habits.</strong> They have no place in an academic environment. Tasteful humor is fine, but sarcasm can be misunderstood.</li></ul><p>As a participant in course discussions, you should also strive to honor the diversity of your classmates by adhering to the <a href=https://www.k-state.edu/about/values/community/ rel=external target=_blank>K-State Principles of Community</a>.</p><h3 id=discrimination-harassment-and-sexual-harassment>Discrimination, Harassment, and Sexual Harassment</h3><p>Kansas State University is committed to maintaining academic, housing, and work environments that are free of discrimination, harassment, and sexual harassment. Instructors support the University‚Äôs commitment by creating a safe learning environment during this course, free of conduct that would interfere with your academic opportunities. Instructors also have a <a href=https://www.k-state.edu/oie/faqs.html rel=external target=_blank>duty to report</a> any behavior they become aware of that potentially violates the University‚Äôs policy prohibiting discrimination, harassment, and sexual harassment, as outlined by <a href=https://www.k-state.edu/policies/ppm/3000/3010.html rel=external target=_blank>PPM 3010</a>.</p><p>If a student is subjected to discrimination, harassment, or sexual harassment, they are encouraged to make a non-confidential report to the University‚Äôs <a href=https://www.k-state.edu/oie/ rel=external target=_blank>Office for Institutional Equity (OIE)</a> using the <a href="https://cm.maxient.com/reportingform.php?KansasStateUniv&layout_id=34" rel=external target=_blank>online reporting form</a>. Incident disclosure is not required to receive resources at K-State. Reports that include domestic and dating violence, sexual assault, or stalking, should be considered for reporting by the complainant to the <a href=https://www.k-state.edu/police/suggest/ rel=external target=_blank>Kansas State University Police Department</a> or the <a href=https://www.rileycountypolice.org/ rel=external target=_blank>Riley County Police Department</a>. Reports made to law enforcement are separate from reports made to OIE. A complainant can choose to report to one or both entities. Confidential support and advocacy can be found with the <a href=https://www.k-state.edu/care/ rel=external target=_blank>K-State Center for Advocacy, Response, and Education (CARE)</a>. Confidential mental health services can be found with <a href=https://www.k-state.edu/counseling/ rel=external target=_blank>Lafene Counseling and Psychological Services (CAPS)</a>. Academic support can be found with the <a href=https://www.k-state.edu/studentlife/ rel=external target=_blank>Office of Student Life (OSL)</a>. OSL is a non-confidential resource. OIE also provides a <a href=https://www.k-state.edu/oie/resources.html rel=external target=_blank>comprehensive list of resources</a> on their website. If you have questions about non-confidential and confidential resources, please contact OIE at <a href=mailto:equity@ksu.edu rel=external target=_blank>equity@ksu.edu</a> or (785) 532‚Äì6220.</p><h3 id=academic-freedom-statement>Academic Freedom Statement</h3><p>Kansas State University is a community of students, faculty, and staff who work together to discover new knowledge, create new ideas, and share the results of their scholarly inquiry with the wider public. Although new ideas or research results may be controversial or challenge established views, the health and growth of any society requires frank intellectual exchange. Academic freedom protects this type of free exchange and is thus essential to any university&rsquo;s mission.</p><p>Moreover, academic freedom supports collaborative work in the pursuit of truth and the dissemination of knowledge in an environment of inquiry, respectful debate, and professionalism. Academic freedom is not limited to the classroom or to scientific and scholarly research, but extends to the life of the university as well as to larger social and political questions. It is the right and responsibility of the university community to engage with such issues.</p><h3 id=campus-safety>Campus Safety</h3><p>Kansas State University is committed to providing a safe teaching and learning environment for student and faculty members. In order to enhance your safety in the unlikely case of a campus emergency make sure that you know where and how to quickly exit your classroom and how to follow any emergency directives. Current Campus Emergency Information is available at the <a href=https://www.k-state.edu/advisories/ rel=external target=_blank>University‚Äôs Advisory</a> webpage.</p><h3 id=student-resources>Student Resources</h3><p>K-State has many resources to help contribute to student success. These resources include accommodations for academics, paying for college, student life, health and safety, and others. Check out the <a href=https://www.k-state.edu/onestop/ rel=external target=_blank>Student Guide to Help and Resources: One Stop Shop</a> for more information.</p><h3 id=student-academic-creations>Student Academic Creations</h3><p>Student academic creations are subject to Kansas State University and Kansas Board of Regents Intellectual Property Policies. For courses in which students will be creating intellectual property, the K-State policy can be found at <a href=https://www.k-state.edu/provost/universityhb/fhxr.html rel=external target=_blank>University Handbook, Appendix R: Intellectual Property Policy and Institutional Procedures (part I.E.)</a>. These policies address ownership and use of student academic creations.</p><h3 id=mental-health>Mental Health</h3><p>Your mental health and good relationships are vital to your overall well-being. Symptoms of mental health issues may include excessive sadness or worry, thoughts of death or self-harm, inability to concentrate, lack of motivation, or substance abuse. Although problems can occur anytime for anyone, you should pay extra attention to your mental health if you are feeling academic or financial stress, discrimination, or have experienced a traumatic event, such as loss of a friend or family member, sexual assault or other physical or emotional abuse.</p><p>If you are struggling with these issues, do not wait to seek assistance.</p><ul><li><a href=https://www.k-state.edu/counseling/ rel=external target=_blank>Kansas State University Counseling and Psychological Services</a> offers free and confidential services to assist you to meet these challenges.</li><li><a href=https://www.k-state.edu/lafene rel=external target=_blank>Lafene Health Center</a> has specialized nurse practitioners to assist with mental health.</li><li><a href=https://www.k-state.edu/studentlife rel=external target=_blank>The Office of Student Life</a> can direct you to additional resources.</li><li><a href=https://www.hhs.k-state.edu/familycenter/ rel=external target=_blank>K-State Family Center</a> offers individual, couple, and family counseling services on a sliding fee scale.</li><li><a href=https://www.k-state.edu/care/ rel=external target=_blank>Center for Advocacy, Response, and Education (CARE)</a> provides free and confidential assistance for those in our K-State community who have been victimized by violence.</li></ul><p>For Kansas State Salina Campus:</p><ul><li><a href=https://polytechnic.k-state.edu/studentlife/health/counseling.html rel=external target=_blank>Kansas State Salina Counseling Services</a> offers free and confidential services to assist you to meet these challenges.</li><li><a href=https://www.salina.k-state.edu/student-life/ rel=external target=_blank>The Kansas State Salina Office of Student Life</a> can direct you to additional resources.</li><li><a href=https://www.k-state.edu/oie/documents/SalinaResourceSupportWheel.pdf rel=external target=_blank>The Kansas State Salina Campus</a> offers several services for students, including health services, counseling, and academic assistance.</li></ul><p>For Global Campus/K-State Online:</p><ul><li>K-State Online students have free access to mental health counseling with <a href=https://www.k-state.edu/lafene/programs/myssp.html rel=external target=_blank>My SSP</a> - 24/7 support via chat and phone.</li><li>The <a href=https://www.k-state.edu/studentlife/ rel=external target=_blank>Office of Student Life</a> can direct you to additional resources.</li></ul><h3 id=university-excused-absences>University Excused Absences</h3><p>K-State has a <a href=https://www.k-state.edu/provost/universityhb/fhsecf.html rel=external target=_blank>University Excused Absence policy (Section F62)</a>. Class absence(s) will be handled between the instructor and the student unless there are other university offices involved. For university excused absences, instructors shall provide the student the opportunity to make up missed assignments, activities, and/or attendance specific points that contribute to the course grade, unless they decide to excuse those missed assignments from the student‚Äôs course grade. Please see the policy for a complete list of university excused absences and how to obtain one. Students are encouraged to contact their instructor regarding their absences.</p><h3 id=copyright-notice>Copyright Notice</h3><p>¬© The materials in this online course fall under the protection of all intellectual property, copyright and trademark laws of the U.S. The digital materials included here come with the legal permissions and releases of the copyright holders. These course materials should be used for educational purposes only; the contents should not be distributed electronically or otherwise beyond the confines of this online course. The URLs listed here do not suggest endorsement of either the site owners or the contents found at the sites. Likewise, mentioned brands (products and services) do not suggest endorsement. Students own copyright to what they create.</p><p>Original content in the course textbook at <a href=https://textbooks.cs.ksu.edu/cis526 rel=external target=_blank>https://textbooks.cs.ksu.edu/cis526</a> is licensed under a Creative Commons BY-SA license by Nathan Bean unless otherwise stated.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Spring 2025 Syllabus</h1></section></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 1</div><h1 id=the-document-object-model>The Document Object Model</h1><p>HTML, CSS, and JavaScript in the Browser</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of The Document Object Model</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>At this point, you should be familiar with the big three technologies of the world-wide-web <em>HTML</em>, <em>CSS</em>, and <em>JavaScript</em> (Feel free to visit the appendices for a quick review). These three technologies work together to create the web pages you interact with every day. Each has a role to play in defining the final appearance of a web page:</p><ul><li>Hyper-Text Markup Language (HTML) provides the structure and content</li><li>Cascading Style Sheets (CSS) determine how that content should appear visually</li><li>JavaScript provides interactivity, allowing both the structure and appearance of the page to change dynamically</li></ul><p>We often refer to this division of responsibility as the <a href=https://en.wikipedia.org/wiki/Separation_of_concerns rel=external target=_blank>separation of concerns</a>. By placing all responsibility for appearance on a CSS file, we can refresh the look of a web application simply by replacing the old CSS file with a new one. Similarly, we can create a new page in our site that looks and feels like the rest of the site by creating a new HTML page that links to the site&rsquo;s existing CSS files.</p><p>While you have written HTML, CSS, and JavaScript files in your prior learning experiences, you might not have thought about just how these files are processed, and those styling rules applied. In this chapter we will explore this topic in detail, while introducing some more advanced uses for each.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=document-object-model>Document Object Model</h1><p>The Document Object Model (or DOM) is a data structure representing the content of a web page, created by the browser as it parses the website. The browser then makes this data structure accessible to scripts running on the page. The DOM is essentially a tree composed of objects representing the HTML elements and text on the page.</p><p>Consider this HTML:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Hello DOM!<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>link</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;site.css&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;banner&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>Hello DOM!<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                The Document Object Model (DOM) is a programming API for HTML and XML documents. It defines the logical structure of documents and the way a document is accessed and manipulated. In the DOM specification, the term &#34;document&#34; is used in the broad sense - increasingly, XML is being used as a way of representing many different kinds of information that may be stored in diverse systems, and much of this would traditionally be seen as data rather than as documents. Nevertheless, XML presents this data as documents, and the DOM may be used to manage this data.
</span></span><span class=line><span class=cl>            <span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;https://www.w3.org/TR/WD-DOM/introduction.html&#34;</span><span class=p>&gt;</span>From w3.org&#39;s What is the Document Object Model?<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div><p>When it is parsed by the browser, it is transformed into this tree:</p><p><a href=#R-image-7c40ee7021872531e805a54efc220829 class=lightbox-link><img alt="The DOM for the supplied HTML" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.2.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7c40ee7021872531e805a54efc220829><img alt="The DOM for the supplied HTML" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.2.1.png></a></p><h3 id=the-dom-tree-and-developer-tools>The DOM Tree and Developer Tools</h3><p>Most browsers also expose the DOM tree through their developer tools. Try opening the example page in Chrome or your favorite browser using <a href=/cis526/01-the-dom/02-document-object-model/../../examples/1.2.1/index.html target=_blank>this link</a>.</p><p>Now open the developer tools for your browser:</p><ul><li><strong>Chrome</strong> <code>CTRL + SHIFT + i</code> or right-click and select &lsquo;Inspect&rsquo; from the context menu.</li><li><strong>Edge</strong> <code>CTRL + SHIFT + i</code> or right-click and select &lsquo;Inspect element&rsquo; from the context menu.</li><li><strong>Firefox</strong> <code>CTRL + SHIFT + i</code> or right-click and select &lsquo;Inspect Element&rsquo; from the context menu.</li><li><strong>Safari</strong> Developer tools must be enabled. See the <a href=https://support.apple.com/guide/safari/use-the-developer-tools-in-the-develop-menu-sfri20948/mac rel=external target=_blank>Safari User Guide</a></li></ul><p>You should see a new panel open in your browser, and under its &rsquo;elements&rsquo; tab the DOM tree is displayed:</p><p><a href=#R-image-738019afe1b32d33b2d87fac93fbee8b class=lightbox-link><img alt="The Elements tab of the Chrome Developer Tools" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.2.2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-738019afe1b32d33b2d87fac93fbee8b><img alt="The Elements tab of the Chrome Developer Tools" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.2.2.png></a></p><p>Collapsed nodes can be expanded by clicking on the arrow next to them. Try moving your mouse around the nodes in the DOM tree, and you&rsquo;ll see the corresponding element highlighted in the page. You can also <em>dynamically edit</em> the DOM tree from the elements tab by right-clicking on a node.</p><p>Try right-clicking on the <code>&lt;h1></code> node and selecting &rsquo;edit text&rsquo;. Change the text to &ldquo;Hello Browser DOM&rdquo;. See how it changes the page?</p><p>The page is rendered from the DOM, so editing the DOM changes how the page appears. However, the initial structure of the DOM is derived from the loaded HTML. This means if we refresh the page, any changes we made to the DOM using the developer tools will be lost, and the page will return to its original state. Give it a try - hit the refresh button.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>For convenience, this textbook will use the <a href=https://www.google.com/chrome rel=external target=_blank>Chrome browser</a> for all developer tool reference images and discussions, but the other browsers offer much of the same functionality. If you prefer to use a different browser&rsquo;s web tools, look up the details in that browser&rsquo;s documentation.</p></div></div><p>You&rsquo;ve now seen how the browser creates the DOM tree by parsing the HTML document and that DOM tree is used to render the page. Next, we&rsquo;ll look at how styles interact with the DOM to modify how it is displayed.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=css-and-the-dom>CSS and the DOM</h1><p>Cascading style sheets (CSS) also interact with the DOM. Consider this CSS code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>.</span><span class=nc>banner</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>border</span><span class=p>:</span> <span class=mi>4</span><span class=kt>px</span> <span class=kc>solid</span> <span class=kc>gold</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>border-radius</span><span class=p>:</span> <span class=mi>5</span><span class=kt>rem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>background-color</span><span class=p>:</span> <span class=kc>goldenrod</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>padding</span><span class=p>:</span> <span class=mi>5</span><span class=kt>rem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>color</span><span class=p>:</span> <span class=kc>brown</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nc>banner</span> <span class=o>&gt;</span> <span class=nt>h1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>font-style</span><span class=p>:</span> <span class=kc>italic</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nc>banner</span> <span class=nt>p</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>text-decoration</span><span class=p>:</span> <span class=kc>line-through</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>font-size</span><span class=p>:</span> <span class=mf>1.2</span><span class=kt>rem</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>When it is placed in the <em>site.css</em> file referenced by the HTML we discussed in the last section, the rules it defines are evaluated in terms of the DOM tree. The result is the page now looks like this:</p><p><a href=#R-image-63e4a31cf22bdf7bcadb085d9c5438d5 class=lightbox-link><img alt="The styled example page" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.3.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-63e4a31cf22bdf7bcadb085d9c5438d5><img alt="The styled example page" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.3.1.png></a></p><p>Now let&rsquo;s talk about how this CSS code and the DOM interact.</p><p>Consider the selector <code>.banner</code>. It looks for any element whose class attribute includes the string <code>"banner"</code>. Hence, it matches the <code>&lt;div></code> element, adding a color, background color, border, and padding. This visualization of the DOM tree indicates the selected node in yellow:</p><p><a href=#R-image-5f65244ad51fce04f00e2c24ec4096f5 class=lightbox-link><img alt="DOM tree visualization with marked .banner node" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.3.2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5f65244ad51fce04f00e2c24ec4096f5><img alt="DOM tree visualization with marked .banner node" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.3.2.png></a></p><p>Notice how the text in both the <code>&lt;h1></code> element and the <code>&lt;p></code> element are a reddish color? That color is the one defined in the <code>.banner</code> rule: <code>color: #754907</code>. The rule applies not only to the selected node, but to <em>all its descendants in the DOM tree</em>. This is the &lsquo;cascading&rsquo; part of cascading style sheets - the rules flow down the DOM tree until they are overridden by more specific css rules in descendant nodes.</p><p>The second way CSS interacts with the DOM tree is through the CSS selectors themselves.</p><p>For example, the selector <code>.banner > h1</code> uses the <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/Child_combinator rel=external target=_blank>child combinator</a> - the <code>></code> symbol between <code>.banner</code> and <code>h1</code>. This indicates that the rule will be applied to any <code>&lt;h1></code> nodes that are <em>direct children</em> of the node with the class of <code>"banner"</code>. As we can see from the DOM tree, the sole <code>&lt;h1></code> tag is a child of the <code>&lt;div.banner></code> node, so this rule is applied to it:</p><p><a href=#R-image-ac9d250988ea986679a316a512572216 class=lightbox-link><img alt="DOM tree visualization with marked .banner > h1 node" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.3.3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ac9d250988ea986679a316a512572216><img alt="DOM tree visualization with marked .banner > h1 node" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.3.3.png></a></p><p>Similarly, the <code>.banner p</code> tag uses the <a href=https://developer.mozilla.org/en-US/docs/Learn/CSS/Building_blocks/Selectors/Combinators rel=external target=_blank>descendant combinator</a> - the space between the <code>.banner</code> and <code>p</code>. This indicates that the rule will be applied to any <code>&lt;p></code> nodes that are <em>descended from</em> the node with the class of <code>"banner"</code>. This will apply no matter how far down the tree those nodes appear. Thus, if we added more <code>&lt;p></code> elements inside of a <code>&lt;div></code> that was a child of the <code>&lt;div.banner></code> node, it would apply to them as well.</p><p><a href=#R-image-9d5e23d9128882a80fb06a33303b0982 class=lightbox-link><img alt="DOM tree visualization with marked .banner p nodes" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.3.4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9d5e23d9128882a80fb06a33303b0982><img alt="DOM tree visualization with marked .banner p nodes" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.3.4.png></a></p><p>You can see the example with the styling applied by following <a href=/cis526/01-the-dom/03-css-and-the-dom/../../examples/1.3.1/index.html target=_blank>this link</a>. Try adding the div and two paragraphs with the developer tools. See how the styles are automatically applied to the new nodes in the DOM tree?</p><h3 id=css-and-developer-tools>CSS and Developer Tools</h3><p>Speaking of developer tools, there is another handy tab that deals with CSS, the &lsquo;Styles&rsquo; tab. It displays <em>all</em> the css rules applied to a specific node. Select one of your new <code>&lt;p></code> elements. Notice how the styles tab shows the css rule <code>.banner p</code> that we&rsquo;ve been discussing? Moreover, it tells you which CSS file and which line in that file the rule is found on.</p><p><a href=#R-image-3fd93132a985160ecbb3d1e03ecd8d7a class=lightbox-link><img alt="Styles tab in developer tools" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.3.5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3fd93132a985160ecbb3d1e03ecd8d7a><img alt="Styles tab in developer tools" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.3.5.png></a></p><p>If you scroll down, it also shows you the rules inherited (cascaded) from the <code>.banner</code> rule:</p><p><a href=#R-image-d68a497066fddd88b6a4528a06b0151b class=lightbox-link><img alt="Inherited rules" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.3.6.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d68a497066fddd88b6a4528a06b0151b><img alt="Inherited rules" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.3.6.png></a></p><p>If you scroll clear to the bottom, you will also see a visualization of the <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Box_Model/Introduction_to_the_CSS_box_model rel=external target=_blank>box model</a> as it is applied to this element.</p><p><a href=#R-image-c57be2232bbc8ba645757a4ef7bf51c2 class=lightbox-link><img alt="Custom style in developer tools" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.3.7.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c57be2232bbc8ba645757a4ef7bf51c2><img alt="Custom style in developer tools" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.3.7.png></a></p><p>This can be very handy for debugging margin/padding/border issues.</p><p>Now scroll back up to the top of the styles tab. Notice the <code>element.style {}</code> rule? This displays inline CSS on the element, and we can also add our own inline CSS directly from the developer tools. Add the property key/value pair <code>text-decoration: none</code>. Notice what happens to the paragraph&rsquo;s text? Also, notice how the <em>now overridden</em> rule has been struck through in the rule below.</p><p><a href=#R-image-5cba9ae15707dc150b04d9bc17d01677 class=lightbox-link><img alt="Custom style in developer tools" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.3.8.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5cba9ae15707dc150b04d9bc17d01677><img alt="Custom style in developer tools" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.3.8.png></a></p><p>This can be very handy for quickly trying out different style combinations without needing to add them to the CSS file. Much like changes to the DOM, these are not saved - refresh the page and they are gone.</p><p>Finally, notice that when the mouse hovers over a CSS property key/value pair, a checkbox appears next to it? If you uncheck the box, the property ceases to be applied. This can also be very handy for debugging CSS problems.</p><p>Now that we&rsquo;ve seen how CSS interacts with the DOM tree, it&rsquo;s time to turn our attention to the third web technology - JavaScript.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=javascript-and-the-dom>JavaScript and the DOM</h1><p>The DOM tree is also accessible from JavaScript running in the page. It is accessed through the global <a href=https://developer.mozilla.org/en-US/docs/Web/API/Window rel=external target=_blank>window</a> object, i.e. <code>window.document</code> or <code>document</code>.</p><p>Let&rsquo;s use the &lsquo;Console&rsquo; tab of the developer tools to access this object. Open the previous example page again from <a href=/cis526/01-the-dom/04-js-and-the-dom/../../examples/1.3.1/index.html target=_blank>this link</a>. Click the console tab to open the expanded console, or use the console area in the bottom panel of the elements tab:</p><p><a href=#R-image-97035be8ea9fac3488da381aefc126f0 class=lightbox-link><img alt="The console tab in the developer tools" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.4.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-97035be8ea9fac3488da381aefc126f0><img alt="The console tab in the developer tools" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.4.1.png></a></p><p>With the console open, type:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&gt;</span> <span class=nb>document</span></span></span></code></pre></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>When instructed to type something into the console, I will use the <code>></code> symbol to represent the cursor prompt. You do <em>not</em> need to type it.</p></div></div><p>Once you hit the enter key, the console will report the value of the expression <code>document</code>, which exposes the document object. You can click the arrow next to the <code>#document</code> to expose its properties:</p><p><a href=#R-image-51f3dd602aba4f7f773ae64acfd7131f class=lightbox-link><img alt="The reported document object" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.4.2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-51f3dd602aba4f7f773ae64acfd7131f><img alt="The reported document object" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.4.2.png></a></p><p>The document is an instance of the <a href=https://developer.mozilla.org/en-US/docs/Web/API/document rel=external target=_blank>Document</a> class. It is the entry point (and the root) of the DOM tree data structure. It also implements the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Node rel=external target=_blank>Node</a> and <a href=https://developer.mozilla.org/en-US/docs/Web/API/EventTarget rel=external target=_blank>EventTarget</a> interfaces, which we&rsquo;ll discuss next.</p><h2 id=the-node-interface>The Node Interface</h2><p>All nodes in the DOM tree implement the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Node rel=external target=_blank>Node</a> interface. This interface provides methods for traversing and manipulating the DOM tree. For example, each node has a property <code>parentElement</code> that references is parent in the DOM tree, a property <code>childNodes</code> that returns a <a href=https://developer.mozilla.org/en-US/docs/Web/API/NodeList rel=external target=_blank>NodeList</a> of all the Node&rsquo;s children, as well as properties referencing the <code>firstChild</code>, <code>lastChild</code>, <code>previousSibling</code>, and <code>nextSibling</code>.</p><p>Let&rsquo;s try walking the tree manually. In the console, type:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&gt;</span> <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>firstElementChild</span><span class=p>.</span><span class=nx>firstElementChild</span></span></span></code></pre></div><p>The <code>body</code> property of the document directly references the <code>&lt;body></code> element of the webpage, which also implements the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Node rel=external target=_blank>Node</a> interface. The <code>firstElementChild</code> references the first HTML element that is a child of the node, so in using that twice, we are drilling down to the <code>&lt;h1></code> element.</p><p><a href=#R-image-25cf0c03dd3c01918ce54f46422e6e26 class=lightbox-link><img alt="The reported h1 object" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.4.3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-25cf0c03dd3c01918ce54f46422e6e26><img alt="The reported h1 object" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.4.3.png></a></p><h2 id=the-eventtarget-interface>The EventTarget Interface</h2><p>Each node in the DOM tree also implements the <code>EventTarget</code> interface. This allows arbitrary events to be attached to any element on the page. For example, we can add a click event to the <code>&lt;h1></code> element. In the console, type:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&gt;</span> <span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>firstElementChild</span><span class=p>.</span><span class=nx>firstElementChild</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;click&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>e</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>target</span> <span class=o>+</span> <span class=s1>&#39; clicked!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>The first argument to <a href=https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener rel=external target=_blank>EventTarget.addEventListener</a> is the event to listen for, and the second is a function to execute when the event happens. Here we&rsquo;ll just log the event to the console.</p><p>Now try clicking on the <em>Hello DOM!</em> <code>&lt;h1></code> element. You should see the event being logged:</p><p><a href=#R-image-bb96ae064550383b8ea96c316778dc75 class=lightbox-link><img alt="The logged event" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.4.4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-bb96ae064550383b8ea96c316778dc75><img alt="The logged event" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.4.4.png></a></p><p>We can also remove event listeners with <a href=https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/removeEventListener rel=external target=_blank>EventTarget.removeEventListener</a> and trigger them programmatically with <a href=https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/dispatchEvent rel=external target=_blank>EventTarget.dispatchEvent</a>.</p><h2 id=querying-the-dom>Querying the DOM</h2><p>While we can use the properties of a node to walk the DOM tree manually, this can result in some very ugly code. Instead, the <a href=https://developer.mozilla.org/en-US/docs/Web/API/document rel=external target=_blank>Document</a> object provides a number of methods that allow you to search the DOM tree for a specific value. For example:</p><ul><li><a href=https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementsByTagName rel=external target=_blank>Document.getElementsByTagName</a> returns a list of elements with a specific tag name, i.e. <code>document.getElementsByTagName('p')</code> will return a list of all <code>&lt;p></code> elements in the DOM.</li><li><a href=https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementsByClassName rel=external target=_blank>Document.getElementsByClassName</a> returns a list of elements with a specific name listed in its class attribute, i.e. <code>document.getElementsByClassName('banner')</code> will return a list containing the <code>&lt;div.banner></code> element.</li><li><a href=https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementById rel=external target=_blank>Document.getElementById</a> returns a single element with the specified id attribute.</li></ul><p>In addition to those methods, the Document object also supplies two methods that take a CSS selector. These are:</p><ul><li><a href=https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelector rel=external target=_blank>Document.querySelector</a> which returns the first matching element in the DOM.</li><li><a href=https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelectorAll rel=external target=_blank>Document.querySelectorAll</a> which returns a list of all matching elements.</li></ul><p>Let&rsquo;s try selecting the <code>&lt;h1></code> tag using the <code>querySelector</code> method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&gt;</span> <span class=kd>var</span> <span class=nx>header</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s1>&#39;h1&#39;</span><span class=p>);</span></span></span></code></pre></div><p>Much easier than <code>document.body.firstElementChild.firstElementChild</code> isn&rsquo;t it?</p><h2 id=manipulating-dom-elements>Manipulating DOM Elements</h2><p>All HTML elements in the DOM also implement the <a href=https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement rel=external target=_blank>HTMLElement</a> interface, which also provides access to the element&rsquo;s attributes and styling. So when we retrieve an element from the DOM tree, we can modify these.</p><p>Let&rsquo;s tweak the color of the <code>&lt;h1></code> element we saved a reference to in the <code>header</code> variable:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>header</span><span class=p>.</span><span class=nx>style</span><span class=p>.</span><span class=nx>color</span> <span class=o>=</span> <span class=s1>&#39;blue&#39;</span><span class=p>;</span></span></span></code></pre></div><p>This will turn the header blue:</p><p><a href=#R-image-39a27ffdceb5c94bae431d5a9cfcb3ce class=lightbox-link><img alt="The blue header" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.4.5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-39a27ffdceb5c94bae431d5a9cfcb3ce><img alt="The blue header" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.4.5.png></a></p><p>All of the CSS properties can be manipulated through the <code>style</code> property.</p><p>In addition, we can access the element&rsquo;s <code>classList</code> property, which provides an <code>add()</code> and <code>remove()</code> methods that add/remove class names from the element. This way we can define a set of CSS properties for a specific class, and turn that class on and off for an element in the DOM tree, effectively applying all those properties at once.</p><h2 id=modifying-the-dom>Modifying the DOM</h2><p>We can create new elements with the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Document/createElement rel=external target=_blank>Document.createElement</a> method. It takes the name of the new tag to create as a string, and an optional options map (a JavaScript object). Let&rsquo;s create a new <code>&lt;p></code> tag. In the console:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&gt;</span> <span class=kd>var</span> <span class=nx>p</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>);</span></span></span></code></pre></div><p>Now let&rsquo;s give it some text:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>p</span><span class=p>.</span><span class=nx>textContent</span> <span class=o>=</span> <span class=s2>&#34;Tra-la-la&#34;</span><span class=p>;</span></span></span></code></pre></div><p>Up to this point, our new <code>&lt;p></code> tag isn&rsquo;t rendered, because it isn&rsquo;t part of the DOM tree. But we can use the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Node/appendChild rel=external target=_blank>Node.appendChild</a> method to add it to an existing node in the tree. Let&rsquo;s add it to the <code>&lt;div.banner></code> element. Type this command into the console:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s1>&#39;div.banner&#39;</span><span class=p>).</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>p</span><span class=p>);</span></span></span></code></pre></div><p>As soon as it is appended, it appears on the page:</p><p><a href=#R-image-12120d02f81d51512965bb81ae32fe7a class=lightbox-link><img alt="The new p element" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.4.6.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-12120d02f81d51512965bb81ae32fe7a><img alt="The new p element" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.4.6.png></a></p><p>Note too that the CSS rules already in place are automatically applied!</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>The popular <a href=https://jquery.com/ rel=external target=_blank>JQuery</a> library was created primarily as a tool to make DOM querying and manipulation easier at a time when browsers were not all adopting the w3c standards consistently. It provided a simple interface that worked identically in all commonly used browsers.</p><p>The JQuery function (commonly aliased to <code>$()</code>) operates much like the <code>querySelectorAll()</code>, taking a CSS selector as an argument and returning a collection of matching elements wrapped in a JQuery helper object. The helper object provided methods to access and alter the attributes, style, events, and content of the element, each returning the updated object allowing for functions to be &lsquo;chained&rsquo; into a single expression.</p><p>The above example, rewritten in JQuery, might be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>$</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>).</span><span class=nx>text</span><span class=p>(</span><span class=s1>&#39;Tra-la-la&#39;</span><span class=p>).</span><span class=nx>appendTo</span><span class=p>(</span><span class=s1>&#39;div.banner&#39;</span><span class=p>);</span></span></span></code></pre></div><p>While modern browsers are much more consistent at supporting standardized JavaScript, JQuery remains a popular library and one you will likely encounter. Thus, while this text focuses on &lsquo;vanilla&rsquo; JavaScript, we&rsquo;ll also occasionally call out JQuery approaches in blocks like this one.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=javascript-events>JavaScript Events</h1><p>It should be no surprise that JavaScript features events - after all, we&rsquo;ve already seen how the <a href=https://developer.mozilla.org/en-US/docs/Web/API/EventTarget rel=external target=_blank>EventTarget</a> interface allows us to attach event listeners to elements in the DOM tree. What might not be clear yet is how events are handled by JavaScript. JavaScript uses an <em>event loop</em> to process events. This is similar to Windows and other operating systems also handle events.</p><p>An event loop expressed in code looks something like:</p><div class=highlight><pre tabindex=0><code>function main
    initialize()
    while message != quit
        message := get_next_message()
        process_message(message)
    end while
end function</code></pre></div><p>It&rsquo;s basically an infinite loop that responds to messages, one message at a time. It might be more useful to see a visual representation:</p><p><a href=#R-image-053bf56586aee58e1db800a5530e20af class=lightbox-link><img alt="The JS Event Loop" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.6.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-053bf56586aee58e1db800a5530e20af><img alt="The JS Event Loop" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.6.1.png></a></p><p>Here we see not just the event loop, but also the <em>event queue</em>. This is a queue that holds events until the event loop is ready to process them. It works like the first-in-first-out queues you built in your data structures course (although it may also consider priorities of events).</p><p>On the far right are some common sources for JavaScript events - user input, the network, and timers. These are often managed by the operating system, and with modern multiple-processor computers can happen <em>concurrently</em>, i.e. <em>at the same time</em>. This is one reason the queue is so important - it allows JavaScript to process the events <em>one at a time</em>.</p><p>When the JavaScript VM has finished executing its current work, it pulls the next event from the event queue. This event is processed by the corresponding <em>event listener</em> function that either 1) you wrote, or 2) is the default action. If neither exists, the event is discarded.</p><h3 id=an-example>An Example</h3><p>Consider when the user clicks on a link on your page, let&rsquo;s say <code>&lt;a id="demo" href="https://google.com">Google it!&lt;/a></code>. This creates a &lsquo;click&rsquo; event for the <code>&lt;a></code> tag clicked on. Now let&rsquo;s assume you&rsquo;ve written an event handler and attached it to that anchor tag:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;demo&#39;</span><span class=p>).</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;click&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>e</span><span class=p>.</span><span class=nx>preventDefault</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>alert</span><span class=p>(</span><span class=s1>&#39;You clicked the &#34;Google it!&#34; link.&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>The anonymous function <code>function(e) {...}</code> attached to the <code>&lt;a></code>&rsquo;s &lsquo;click&rsquo; event is invoked, with the event details being passed as the parameter <code>e</code>. Anchor tags have a default behavior - they open the linked page. So the line <code>e.preventDefault();</code> informs JavaScript <em>not</em> to use this default behavior. Then we trigger an alert with the string <code>'You clicked the "Google it!" link.'</code>.</p><p>If we hadn&rsquo;t attached the event listener, then the page would have used the default response - loading a new page into the browser in the place of our current page.</p><p>If we clicked on an element that didn&rsquo;t have a default action (like a <code>&lt;p></code> element) and you haven&rsquo;t attached a listener the event is discarded and does nothing.</p><h3 id=concurrency-in-javascript>Concurrency in JavaScript</h3><p>An important takeaway from the discussion of the event loop is that the actual processing of JavaScript code is always <em>single-threaded</em>. This avoids many of the common challenges of multi-threaded code. You don&rsquo;t need to create semaphores, locks, and other multi-threading synchronization tools as your code will always be executing in a single thread.</p><p>However, JavaScript <em>does</em> retain many of the benefits of concurrency within its model. For example, when the DOM is loading and encounters an element referencing an external resource (i.e. a <code>video</code>, <code>img</code>, <code>link</code>, or <code>script</code> element), it triggers a request to retrieve that resource through the browser. The browser does so <em>while the JavaScript code continues executing</em>. When the resource is fully downloaded by the browser, it creates a <code>'load'</code> event with the details, and adds it to the JavaScript event queue. Multiple files are therefore downloaded <em>concurrently</em>, but our JavaScript handles the results one-by-one in a single-threaded manner.</p><p>Think of the JavaScript event loop as a busy manager that only works on one thing at a time. The manager might send several workers out to get information. When they return, they form a line in front of the manager&rsquo;s desk and wait patiently. Once the manager is finished with the task they have been working on, they take the report from the first worker in line, and starts doing what is needed to be done with the returned information. Once the manager finishes that, the next employee will report, and so on.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>Although the JavaScript execution model is single-threaded, there are ways of introducing multi-threaded programming in JavaScript - specifically, the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API rel=external target=_blank>Web Workers</a> in the browser and <a href=https://nodejs.org/api/worker_threads.html rel=external target=_blank>Worker Threads</a> in Node. These technologies essentially run additional JavaScript interpreters in parallel and enable communiation between them using events.</p></div></div><h2 id=common-events>Common Events</h2><p>There are many kinds of events in JavaScript; you can find a complete list in the <a href=https://developer.mozilla.org/en-US/docs/Web/Events rel=external target=_blank>MDN docs</a>. However some of the ones you will likely find yourself using are:</p><ul><li><p><a href=https://developer.mozilla.org/en-US/docs/Web/Events/load rel=external target=_blank>load</a> - Triggered when a resource (i.e. an image, video, stylesheet, script) has finished loading. You can also listen for the load event on the <code>document</code> itself; here it will be triggered after <em>all</em> the resources on the page are loaded.</p></li><li><p><a href=https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/change_event rel=external target=_blank>change</a> The value of an <code>&lt;input></code>, <code>&lt;textarea></code>, or <code>&lt;select></code> has changed</p></li><li><p><a href=https://developer.mozilla.org/en-US/docs/Web/Events/focus rel=external target=_blank>focus</a> triggered when an input gains focus (is the currently selected input)</p></li><li><p><a href=https://developer.mozilla.org/en-US/docs/Web/Events/blur rel=external target=_blank>blur</a> triggered when an input loses focus</p></li><li><p><a href=https://developer.mozilla.org/en-US/docs/Web/Events/click rel=external target=_blank>click</a> The primary mouse button was clicked. On old browsers this might trigger for any button</p></li><li><p><a href=https://developer.mozilla.org/en-US/docs/Web/Events/contextmenu rel=external target=_blank>contextmenu</a> The right mouse button was clicked</p></li><li><p><a href=https://developer.mozilla.org/en-US/docs/Web/Events/mousedown rel=external target=_blank>mousedown</a> A mouse button was pressed</p></li><li><p><a href=https://developer.mozilla.org/en-US/docs/Web/Events/mouseup rel=external target=_blank>mouseup</a> A mouse button was released</p></li></ul><h2 id=timers>Timers</h2><p>Timers play a special role in JavaScript&rsquo;s concurrency model, and in many ways behave like events. For example, to cause the phrase &ldquo;Hello time!&rdquo; to be logged to the console in three seconds, you would write the code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>setTimeout</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Hello time!&#34;</span><span class=p>)},</span> <span class=mi>3000</span><span class=p>);</span></span></span></code></pre></div><p>You will notice that the <a href=https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout rel=external target=_blank>setTimeout()</a> method takes a function to execute at that future point in time, much like attaching an event handler. The second argument is the number of milliseconds in the future for this event to occur. The timer works like an event, when the time expires, a corresponding event is added to the event queue, to trigger the delayed function.</p><p>An important side-effect of this approach is that you only know the timer&rsquo;s result won&rsquo;t happen <em>before</em> the delay you specify, but if the JavaScript virtual machine is engaged in a long-running process, it may be longer before your timer event is triggered.</p><p>For events you need to do on a regular interval, use <a href=https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setInterval rel=external target=_blank>setInterval()</a> instead. This will invoke the supplied function at each elapsing of the supplied interval. It also returns a unique id that can be supplied to <a href=https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/clearInterval rel=external target=_blank>clearInterval()</a> to stop the timed event.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>You may find yourself reading code that uses a value of <code>0</code> milliseconds with <code>setTimeout()</code>, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>setTimeout</span><span class=p>(</span><span class=nx>doSomething</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span></span></span></code></pre></div><p>You might be wondering why. You might wonder if it is equivalent to:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>doSomething</span><span class=p>();</span></span></span></code></pre></div><p>And while it might appear that way, the answer is <em>no</em>. Remember, <code>setTimeout()</code> creates an event in the event queue that executes after the specified delay. Thus, <code>doSomething()</code> will execute <em>immediately</em>, but <code>setTimeout(doSomething())</code> will continue to execute all code <em>after</em> the line until execution finishes, and <em>then</em> will invoke <code>doSomething()</code>.</p><p>Thus, JavaScript programmers often use this technique to trigger an action immediately after the current code finishes executing.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=the-dom-and-external-resource-loading>The DOM and External Resource Loading</h1><p>One of the important aspects of working with HTML is understanding that an HTML page is <em>more</em> than just the HTML. It also involves a collection of resources that are external to the HTML document, but displayed or utilized by the document. These include elements like <code>&lt;link></code>, <code>&lt;script></code>, <code>&lt;video></code>, <code>&lt;img></code>, and <code>&lt;source></code> with <code>src</code> or <code>href</code> attributes set.</p><p>As the DOM tree is parsed and loaded and these external resources are encountered, the browser requests those resources as well. Modern browsers typically make these requests in parallel for faster loading times.</p><p>Once the HTML document has been completely parsed, the <code>window</code> triggers the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Window/DOMContentLoaded_event rel=external target=_blank>DOMContentLoaded</a> event. This means the HTML document has been completely parsed and added to the DOM tree. However, the external resources <em>may not have all been loaded at this point</em>.</p><p>Once those resources are loaded, a separate <a href=https://developer.mozilla.org/en-US/docs/Web/API/Window/load_event rel=external target=_blank>Load</a> event is triggered, also on the <code>window</code>.</p><p>Thus, if you have JavaScript that should only be invoked <em>after</em> the page has fully loaded, you can place it inside an event listener tied to the <code>load</code> event, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nb>window</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;load&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// TODO: Add your code here ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span></span></span></code></pre></div><p>Or, if you want it invoked after the DOM is fully parsed, but external resources may still be loading:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nb>window</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;DOMContentLoaded&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// TODO: Add your code here ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span></span></span></code></pre></div><p>The former - waiting for all resources to load - tends to be the most common. The reason is simple, if you are loading multiple JavaScript files, i.e. a couple of libraries and your own custom code, using the <code>'load'</code> event ensures they have all loaded before you start executing your logic.</p><p>Consider the popular <a href=https://jquery.com/ rel=external target=_blank>JQuery</a> library, which provides shorthand methods for querying and modifying the DOM. It provides a <code>JQuery()</code> function that is also aliased to the <code>$</code>. The JQuery code to show a popup element might be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#popup&#39;</span><span class=p>).</span><span class=nx>show</span><span class=p>();</span></span></span></code></pre></div><p>But if the JQuery library isn&rsquo;t loaded yet, the <code>$</code> is not defined, and this logic will crash the JavaScript interpreter. Any remaining JavaScript will be ignored, and your page won&rsquo;t work as expected. But re-writing that to trigger after all resources have loaded, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nb>window</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;load&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// This code only is executed once all resources have been loaded
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#popup&#39;</span><span class=p>).</span><span class=nx>show</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Ensures the JQuery library is available before your code is run.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>JavaScript is an extremely flexible language that has evolved over time. One side effect of this evolution is that there are often multiple ways to express the same idea. For example, listening for the <code>window</code>&rsquo;s <code>'load'</code> event can be written many different ways:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// Using the onload property
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nb>window</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{...}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Using onload property and lambda syntax 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nb>window</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{...}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Using the addEventListener and lambda syntax
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nb>window</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;load&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Using the JQuery library 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>JQuery</span><span class=p>(</span><span class=kd>function</span><span class=p>(){...});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Using the JQuery library with lambda syntax 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>JQuery</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{...});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Using the JQuery library with $ alias
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>$</span><span class=p>(</span><span class=kd>function</span><span class=p>(){...});</span></span></span></code></pre></div><p>You are free to use whichever approach you like, but need to be able to interpret other programmers&rsquo; code when they use a different approach.</p></div></div><h2 id=loading-resources-_after_-the-dom-is-loaded>Loading Resources <em>after</em> the DOM is loaded</h2><p>There are really <em>two</em> ways to load resources into an HTML page from your JavaScript code. One is indirect, and the other direct. The indirect method simply involves creating DOM elements linked to an outside resource, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>image</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;img&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>image</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=s1>&#39;smile.png&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>img</span><span class=p>);</span></span></span></code></pre></div><p>In this case, when the new <code>&lt;img></code> element has its <code>src</code> attribute set, the image is requested by the browser. Attaching it to the DOM will result in the image being displayed once it loads.</p><p>If we want to know when the image is loaded, we can use the <code>load</code> event:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>image</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;img&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>image</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;load&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;loaded image&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>image</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=s1>&#39;smile.png&#39;</span><span class=p>;</span></span></span></code></pre></div><p>Notice too that we add the event listener <em>before</em> we set the <code>src</code> attribute. If we did it the other way around, the resource may already be loaded before the listener takes effect - and it would never be invoked!</p><p>However, this approach can be cumbersome, and limits us to what resources can be bound to HTML elements. For more flexibility, we need to make the request directly, using AJAX. We&rsquo;ll take a look at doing so after we cover HTTP in more depth.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><p>In this chapter, we reviewed the Document Object Model (the DOM), the tree-like structure of HTML elements built by the browser as it parses an HTML document. We discussed how CSS rules are applied to nodes in this tree to determine how the final webpage will be rendered, and how JavaScript can be used to manipulate and transform the DOM (and the resulting webpage appearance).</p><p>We also discussed how JavaScript events work, and how this event-driven approach is the basis for implementing concurrency within the language. We&rsquo;ll see this more as we delve into Node.js, which utilizes the same event-based concurrency model, in future chapters.</p><p>Finally, we discussed how supplemental files (images, videos, CSS files, JavaScript files) are loaded by the browser concurrently. We saw how this can affect the functioning of JavaScript that depends on certain parts of the page already having been loaded, and saw how we can use the <code>load</code> event to delay running scripts until these extra files have completed loading.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 2</div><h1 id=hyper-text-transfer-protocol>Hyper-Text Transfer Protocol</h1><p>Etiquette for Web Servers and Clients</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Hyper-Text Transfer Protocol</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>At the heart of the world wide web is the Hyper-Text Transfer Protocol (HTTP). This is a protocol defining how HTTP servers (which host web pages) interact with HTTP clients (which display web pages).</p><p>It starts with a request initiated from the web browser (the client). This request is sent over the Internet using the TCP protocol to a web server. Once the web server receives the request, it must decide the appropriate response - ideally sending the requested resource back to the browser to be displayed. The following diagram displays this typical request-response pattern.</p><p><a href=#R-image-419f0579b8af70a1f3d6310053af5069 class=lightbox-link><img alt="HTTP&rsquo;s request-response pattern" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/2.0.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-419f0579b8af70a1f3d6310053af5069><img alt="HTTP&rsquo;s request-response pattern" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/2.0.1.png></a></p><p>This HTTP request-response pattern is at the core of how all web applications communicate. Even those that use websockets begin with an HTTP request.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>The HTTP standard, along with many other web technologies, is maintained by the <a href=https://www.w3.org/ rel=external target=_blank>World-Wide-Web Consortium</a> (abbreviated W3C), stakeholders who create and maintain web standards. The full description of the Hyper-Text Transfer Protocol can be found here <a href=https://www.w3.org/Protocols/ rel=external target=_blank>w3c&rsquo;s protocols page</a>.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=browser-requests>Browser Requests</h1><p>Before we get too deep in the details of what a request is, and how it works, let&rsquo;s explore the primary kind of request you&rsquo;re already used to making - requests originating from a browser. Every time you use a browser to browse the Internet, you are creating a series of HTTP (or HTTPS) requests that travel across the networks between you and a web server, which responds to your requests.</p><p>To help illustrate how these requests are made, we&rsquo;ll once again turn to our developer tools. Open the example page <a href=/cis526/02-http/02-browser-requests/../../examples/2.2.1/index.html target=_blank>this link</a>. On that tab, open your developer tools with <code>CTRL + SHIFT + i</code> or by right-clicking the page and selecting &ldquo;Inspect&rdquo; from the context menu. Then choose the &ldquo;Network&rdquo; tab:</p><p><a href=#R-image-51d5a2d8145355ec9f72d0b1def5029b class=lightbox-link><img alt="Selecting the network tab in the developer tools" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/2.2.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-51d5a2d8145355ec9f72d0b1def5029b><img alt="Selecting the network tab in the developer tools" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/2.2.1.png></a></p><p>The network tab displays details about each request the browser makes. Initially it will probably be empty, as it does not log requests while not open. Try refreshing the page - you should see it populate with information:</p><p><a href=#R-image-dc3e23c0f35a6e5d29e6184dc60032fc class=lightbox-link><img alt="The populated network tab" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/2.2.2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-dc3e23c0f35a6e5d29e6184dc60032fc><img alt="The populated network tab" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/2.2.2.png></a></p><p>The first entry is the page itself - the HTML file. But then you should see entries for <em>site.css</em>, <em>brazil.gif</em>, <em>fiber-4814456_960_720.jpg</em>, <em>jquery-3.5.1.slim.min.js</em>, and <em>site.js</em>. Each of these entries represents an additional resource the browser fetched from the web in order to display the page.</p><p>Take, for example, the two images <em>brazil.gif</em> and <em>fiber-4814456_960_720.jpg</em>. These correspond to <code>&lt;img></code> tags in the HTML file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#34;Paper scene from the film Brazil&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;brazil.gif&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#34;Fiber optic cables&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.pixabay.com/photo/2020/02/03/00/12/fiber-4814456_960_720.jpg&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        </span></span></code></pre></div><p>The important takeaway here is that the image is requested <em>separately</em> from the HTML file. As the browser reads the page and encounters the <code>&lt;img></code> tag, it makes an additional request for the resource supplied in its <code>src</code> attribute. When that second request finishes, the downloaded image is added to the web page.</p><p>Notice too that while one image was on our webserver, the other is retrieved from <a href=https://pixabay.com rel=external target=_blank>Pixabay.com</a>&rsquo;s server.</p><p>Similarly, we have two JavaScript files:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://code.jquery.com/jquery-3.5.1.slim.min.js&#34;</span> <span class=na>integrity</span><span class=o>=</span><span class=s>&#34;sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=&#34;</span> <span class=na>crossorigin</span><span class=o>=</span><span class=s>&#34;anonymous&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;site.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div><p>As with the images, one is hosted on our website, <em>site.js</em>, and one is hosted on another server, <a href=https://code.jquery.com/jquery-3.5.1.slim.min.js rel=external target=_blank>jquery.com</a>.</p><p>Both the Pixabay image and the jQuery library are hosted by a <a href=https://en.wikipedia.org/wiki/Content_delivery_network rel=external target=_blank>Content Delivery Network</a>- a network of proxy servers that are distributed geographically in such a way that a request for a resource they hold can be processed from a nearby server. Remember that the theoretical maximum speed for internet transmissions is the speed of light (for fiber optics) or electrons in copper wiring. Communication is further slowed at each network switch encountered. Serving files from a nearby server can prove very efficient at speeding up page loads because of the shorter distance and smaller number of switches involved.</p><p>A second benefit of using a CDN to request the JQuery library is that if the browser has previously downloaded the library when visiting another site it will have cached it. Using the cached version instead of making a new request is <em>much</em> faster. Your app will benefit by faster page loads that use less bandwidth.</p><p>Notice too that the jQuery <code>&lt;script></code> element also uses the <code>integrity</code> attribute to allow the browser to determine if the library downloaded was tampered with by comparing cryptographic tokens. This is an application of <a href=https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity rel=external target=_blank>Subresource Integrity</a>, a feature that helps protect your users. As JavaScript can transform the DOM, there are incentives for malicious agents to supplant real libraries with fakes that abuse this power. As a web developer you should be aware of this, and use all the tools at your disposal to keep your users safe.</p><p>You can use the network tab to help debug issues with resources. Click on one of the requested resources, and it will open up details about the request:</p><p><a href=#R-image-2501d8a0ae6ba2b2b035f78ef02b15c7 class=lightbox-link><img alt="Request details in the Network Tab" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/2.2.3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2501d8a0ae6ba2b2b035f78ef02b15c7><img alt="Request details in the Network Tab" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/2.2.3.png></a></p><p>Notice that it reports the status code along with details about the request and response, and provides a preview of the requested resource. We&rsquo;ll cover what these all are over the remainder of this chapter. As you learn about each topic, you may want to revisit the tab with the example to see how these details correspond to what you are learning.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=request-format>Request Format</h1><p>So now that we&rsquo;ve seen HTTP Requests in action, let&rsquo;s examine what they <em>are</em>. A HTTP Request is just a stream of text that follows a specific format and sent from a client to a server.</p><p><a href=#R-image-c1e92debf84d321f17aac0b1a2a34e55 class=lightbox-link><img alt="Http Request as a stream of text" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/2.3.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c1e92debf84d321f17aac0b1a2a34e55><img alt="Http Request as a stream of text" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/2.3.1.png></a></p><p>It consists of one or more lines terminated by a CRLF (a carriage return and a line feed character, typically written <code>\r\n</code> in most programming languages).</p><ol><li>A <em>request-line</em> describing the request</li><li>Additional optional lines containing HTTP headers. These specify details of the request or describe the body of the request</li><li>A blank line, which indicates the end of the request headers</li><li>An optional body, containing any data belonging of the request, like a file upload or form submission. The exact nature of the body is described by the headers.</li></ol><h2 id=the-request-line>The Request-Line</h2><p>The request-line follows the format</p><p><code>Request-Line = Method SP Request-URI SP HTTP-Version CRLF</code></p><p>The <em>Method</em> refers to the HTTP Request Method (often GET or POST).</p><p><em>SP</em> refers to the space character.</p><p>The <em>Request-URI</em> is a Universal Request Indicator, and is typically a URL or can be the asterisk character (*), which refers to the server instead of a specific resource.</p><p><em>HTTP-Version</em> refers to the version of the HTTP protocol that will be used for the request. Currently three versions of the protocol exist: <code>HTTP/1.0</code>, <code>HTTP/1.1</code>, and <code>HTTP/2.0</code>. Most websites currently use HTTP/1.1 (HTTP/2.0 introduces many changes to make HTTP more efficient, at the cost of human readability. Currently it is primarily used by high-traffic websites).</p><p>Finally, the <em>CRLF</em> indicates a carriage return followed by a line feed.</p><p>For example, if we were requesting the about.html page of a server, the request-line string would be:</p><p><code>GET /about.html HTTP/1.1\r\n</code></p><h2 id=the-headers>The Headers</h2><p>Header lines consist of key-value pairs, typically in the form</p><p><code>Header = Key: Value CRLF</code></p><p>Headers provide details about the request, for example, if we wanted to specify we can handle the <em>about.html</em> page data compressed with the gzip algorithm, we would add the header:</p><p><code>Accept-Encoding: compress, gzip\r\n</code></p><p>The server would then know it could send us a zipped version of the file, resulting in less data being sent from the server to the client.</p><p>If our request includes a body (often form data or a file upload), we need to specify what that upload data is with a Content-Type header and its size with a Content-Length header, i.e.:</p><p><code>Content-Length: 26012 Content-Type: image/gif</code></p><h2 id=a-blank-line>A Blank Line</h2><p>The header section is followed by a blank line (a CRLF with no characters before it). This helps separate the request metadata from the request body.</p><h2 id=the-request-body>The Request Body</h2><p>The body of the request can be text (as is the case for most forms) or binary data (as in an image upload). This is why the Content-Type header is so important for requests with a body; it lets the server know how to process the data. Similarly, the Content-Length header lets us know how many bytes to expect the body to consist of.</p><p>It is also acceptable to have no body - this is commonly the case with a GET request. If there is no body, then there are also no required headers. A simple get request can therefore consist of only the request-line and blank line, i.e.:</p><p><code>GET /about.html HTTP/1.1\r\n\r\n</code></p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>The HTTP/1.1 request definition can be found in <a href=https://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html#sec5 rel=external target=_blank>W3C RFC 2616 Section 5</a></p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=request-methods>Request Methods</h1><p>The first line of the HTTP request includes the <strong>request method</strong>, which indicates what kind of action the request is making of the web server (these methods are also known as <strong>HTTP Verbs</strong>). The two most common are <em>GET</em> and <em>POST</em>, as these are supported by most browsers.</p><h3 id=commonly-used-http-methods>Commonly Used HTTP Methods</h3><p>The following requests are those most commonly used in web development. As noted before GET and POST requests are the most commonly used by web browsers, while GET, PUT, PATCH, and DELETE are used by RESTful APIs. Finally, HEAD can be used to optimize web communications by minimizing unnecessary data transfers.</p><h4 id=get>GET</h4><p>A <em>GET</em> request seeks to retrieve a specific resource from the web server - often an HTML document or binary file. GET requests typically have no body and are simply used to retrieve data. If the request is successful, the response will typically provide the requested resource in its body.</p><h4 id=head>HEAD</h4><p>A <em>HEAD</em> request is similar to a GET request, except the response is not expected to provide a body. This can be used to verify the type of content of the resource, the size of the resource, or other metadata provided in the response header, without downloading the full data of the resource.</p><h4 id=post>POST</h4><p>The <em>POST</em> request submits an entity to the resource, i.e. uploading a file or form data. It typically will have a body, which is the upload or form.</p><h4 id=put>PUT</h4><p>The <em>PUT</em> request is similar to a POST request, in that it submits an entity as its body. It has a more strict semantic meaning though; a PUT request is intended to <em>replace</em> the specified resource in its entirety.</p><h4 id=patch>PATCH</h4><p>The <em>PATCH</em> request is also similar to POST and PUT requests - it submits an entity as its body. However, its semantic meaning is to only apply partial modifications to the specified entity.</p><h4 id=delete>DELETE</h4><p>As you might expect, the DELETE method is used to delete the specified resource from the server.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>Additional methods include <em>CONNECT</em>, which establishes a tunnel to a server; <em>OPTIONS</em>, which identifies communications options with a resource, and <em>TRACE</em>, which performs a message loop-back test to the target resource. HTTP Methods are defined in <a href=https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html rel=external target=_blank>W3C&rsquo;s RFC2616</a>.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=uris-and-urls>URIs and URLs</h1><p>Before a web request can be made, the browser needs to know where the resource requested can be found. This is the role that a Universal Resource Locator (a URL) plays. A URL is a specific kind of Universal Resource Indicator (URI) that specifies how a specific resource can be retrieved.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p><strong>URLs and URIs</strong>
The terms URL and URI are often used interchangeably in practice. However, a URL is a specific subset of URIs that indicate <em>how to retrieve a resource over a network</em>; while a URI identifies a unique resource, it does not necessarily indicate how to retrieve it. For example, a book&rsquo;s ISBN can be represented as a URI in the form <em>urn:isbn:0130224189</em>. But this URI cannot be put into a browser&rsquo;s Location to retrieve the associated book.</p></div></div><p>A URI consists of several parts, according to the definition (elements in brackets are optional):</p><p><code>URI = scheme:[//[userinfo@]host[:port]]path[?query][#fragment]</code></p><p>Let&rsquo;s break this down into individual parts:</p><p><strong>scheme:</strong> The scheme refers to the resource is identified and (potentially) accessed. For web development, the primary schemes we deal with are <em>http</em> (hyper-text transfer protocol), <em>https</em> (secure hyper-text transfer protocol), and <em>file</em> (indicating a file opened from the local computer).</p><p><strong>userinfo:</strong> The userinfo is used to identify a specific user. It consists of a username optionally followed by a colon (<code>:</code>) and password. We will discuss its use in the section on HTTP authentication, but note that this approach is rarely used today, and carries potential security risks.</p><p><strong>host:</strong> The host consists of either a fully quantified domain name (i.e. google.com, cs.ksu.edu, or gdc.ksu.edu) or an ip address (i.e. <code>172.217.1.142</code> or <code>[2607:f8b0:4004:803::200e]</code>). IPv4 addresses <em>must</em> be separated by periods, and IPv6 addresses must be closed in brackets. Additionally, web developers will often use the loopback host, <code>localhost</code>, which refers to the local machine rather than a location on the network.</p><p><strong>port:</strong> The port refers to the port number on the host machine. If it is not specified (which is typical), the default port for the scheme is assumed: port 80 for HTTP, and port 443 for HTTPS.</p><p><strong>path:</strong> The path refers to the path to the desired resource on the server. It consists of segments separated by forward slashes (<code>/</code>).</p><p><strong>query:</strong> The query consists of optional collection of key-value pairs (expressed as key:value), separated by ampersands (<code>&</code>), and preceded by a question mark (<code>?</code>). The query string is used to supply modifiers to the requested resource (for example, applying a filter or searching for a term).</p><p><strong>fragment:</strong> The fragment is an optional string proceeded by a hashtag (<code>#</code>). It identifies a portion of the resource to retrieve. It is most often used to auto-scroll to a section of an HTML document, and also for navigation in some single-page web applications.</p><p>Thus, the URL <code>https://google.com</code> indicates we want to use the secure HTTP scheme to access the server at google.com using its port 443. This should retrieve Google&rsquo;s main page.</p><p>Similarly, the url <code>https://google.com/search?q=HTML</code> will open a Google search result page for the term HTML (Google uses the key <code>q</code> to identify search terms).</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=request-headers>Request Headers</h1><p>Request headers take the form of key-value pairs, separated by colons <code>:</code> and terminated with a CRLF (a carriage return and line feed character). For example:</p><div class=highlight><pre tabindex=0><code>Accept-Encoding: gzip</code></pre></div><p>Indicates that the browser knows how to accept content compressed in the <a href=https://en.wikipedia.org/wiki/Gzip rel=external target=_blank>Gzip format</a>.</p><p>Note that request headers are a subset of <em>message headers</em> that apply specifically to requests. There are also message headers that apply only to HTTP responses, and some that apply to both.</p><p>As HTTP is intended as an extensible protocol, there are a <em>lot</em> of potential headers. IANA maintains the <a href=https://www.iana.org/assignments/message-headers/message-headers.xhtml rel=external target=_blank>official list of message headers</a> as well as <a href=https://www.iana.org/assignments/message-headers/message-headers.xhtml rel=external target=_blank>a list of proposed message headers</a>. You can also find a categorized list in the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers rel=external target=_blank>MDN Documentation</a></p><p>While there are many possible request headers, some of the more commonly used are:</p><p><strong>Accept</strong> Specifies the types a server can send back, its value is a MIME type.</p><p><strong>Accept-Charset</strong> Specifies the character set a browser understands.</p><p><strong>Accept-Encoding</strong> Informs the server about encoding algorithms the client can process (most typically compression types)</p><p><strong>Accept-Language</strong> Hints to the server what language content should be sent in.</p><p><strong>Authorization</strong> Supplies credentials to authenticate the user to the server. Will be covered in the authentication chapter.</p><p><strong>Content-Length</strong> The length of the request body sent, in octets</p><p><strong>Content-Type</strong> The MIME type of the request body</p><p><strong>Content-Encoding</strong> The encoding method of the request body</p><p><strong>Cookie</strong> Sends a site cookie - see the section on cookies later</p><p><strong>User-Agent</strong> A string identifying the agent making the request (typically a browser name and version)</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=request-body>Request Body</h1><p>After the request headers and an extra CRLF (carriage return and line feed) is the request body.</p><p>For GET and DELETE requests, there is no body. For POST, PUT, and PATCH, however, this section should contain the data being sent to the server. If there is a body, the headers should include <code>Content-Type</code> and <code>Content-Length</code>. The <code>Content-Length</code> is always provided as a count of <a href=https://en.wikipedia.org/wiki/Octet_(computing) rel=external target=_blank>octets</a> (a set of eight bits). Thus, binary data is sent as an <em>octet stream</em>. Text data is typically sent in <a href=https://en.wikipedia.org/wiki/UTF-8 rel=external target=_blank>UTF-8 encoding</a>.</p><p>Two body formats bear special mention: <code>application/x-www-form-urlencoded</code> and <code>multipart/form-data</code>. These encodings are commonly used for submitting HTML forms, and will be covered in more detail in the Form Data chapter.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=response-format>Response Format</h1><p>Similar to an HTTP Request, an HTTP response is typically a stream of text and possibly data:</p><p><a href=#R-image-8309ad2dfce3056a377dce82ac077255 class=lightbox-link><img alt="HTTP Response as a stream of text and data" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/2.8.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8309ad2dfce3056a377dce82ac077255><img alt="HTTP Response as a stream of text and data" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/2.8.1.png></a></p><p>It consists of one or more lines of text, terminated by a CRLF (sequential carriage return and line feed characters):</p><ol><li>A <em>status-line</em> indicating the HTTP protocol, the status code, and a textual status</li><li>Optional lines containing the Response Headers. These specify the details of the response or describe the response body</li><li>A blank line, indicating the end of the response metadata</li><li>An optional response body. This will typically be the text of an HTML file, or binary data for an image or other file type, or a block of bytes for streaming data.</li></ol><h2 id=the-status-line>The Status-Line</h2><p>The status-line follows the format</p><p><code>Status-Line = HTTP-Version SP Status-Code SP Reason-Phrase CRLF</code></p><p>The <em>HTTP-Version</em> indicates the version of the HTTP protocol that is being used (HTTP/1.0, HTTP/1.1, or HTTP/2.0).</p><p><em>SP</em> refers to a space character.</p><p>The <em>Status-Code</em> is a three-digit numeric representation of the response status. Common codes include 200 (OK), 404 (Not Found), and 500 (Server Error).</p><p>The <em>Reason-Phrase</em> is a plain-text explanation of the status code.</p><h2 id=response-headers>Response Headers</h2><p>Just like HTTP Requests, a HTTP response can contain headers describing the response. If the response has a body, a Content-Type and Content-Length header would be expected.</p><h2 id=a-blank-line>A Blank Line</h2><p>The header section is followed by a blank line (a CRLF with no characters before it). This helps separate the response metadata from the response body.</p><h2 id=response-body>Response Body</h2><p>The response body contains the data of the response. it might be text (as is typically the case with HTML, CSS, or JavaScript), or a binary file (an image, video, or executable). Additionally, it might only be a sequence of bytes, as is the case for streaming media.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>The full HTTP/1.1 response definition can be found in <a href=https://www.w3.org/Protocols/rfc2616/rfc2616-sec6.html#sec6 rel=external target=_blank>W3C RFC 2616 Section 6</a>.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=status-codes>Status Codes</h1><p>The <em>status-line</em> consists of a numeric code, followed by a space, and then a human-readable status message that goes with the code. The codes themselves are 3-digit numbers, with the first number indicating a general category the response status falls into. Essentially, the status code indicates that the request is being fulfilled, or the reason it cannot be.</p><h3 id=1xx-status-codes>1XX Status Codes</h3><p>Codes falling in the 100&rsquo;s provide some kind of information, often in response to a <code>HEAD</code> or upgrade request. See the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Status rel=external target=_blank>MDN Documentation</a> for a full list.</p><h3 id=2xx-status-codes>2XX Status Codes</h3><p>Codes in the 200&rsquo;s indicate success in some form. These include:</p><p><strong><code>200 OK</code></strong> A status of 200 indicates the request was successful. This is by far the most common response.</p><p><strong><code>201 Created</code></strong> Issued in response to a successful POST request, indicates the resource POSTed to the server has been created.</p><p><strong><code>202 Accepted</code></strong> Indicates the request was received but not yet acted upon. This is used for batch-style processes. An example you may be familiar with is submitting a DARS report request - the DARS server, upon receiving one, adds it to a list of reports to process and then sends a <code>202</code> response indicating it was added to the list, and should be available at some future point.</p><p>There are additional 200 status codes. See the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Status rel=external target=_blank>MDN Documentation</a> for a full list.</p><h3 id=3xx-status-codes>3XX Status Codes</h3><p>Codes in the 300&rsquo;s indicate redirects. These should be used in conjunction with a <code>Location</code> response header to notify the user-agent where to redirect. The three most common are:</p><p><strong><code>301 Moved Permanently</code></strong> Indicates the requested resource is now permanently available at a different URI. The new URI should be provided in the response, and the user-agent may want to update bookmarks and caches.</p><p><strong><code>302 Found</code></strong> Also redirects the user to a different URI, but this redirect should be considered temporary and the original URI used for further requests.</p><p><strong><code>304 Not Modified</code></strong> Indicates the requested resource has not changed, and therefore the user-agent can use its cached version. By sending a 304, the server does not need to send a potentially large resource and consume unnecessary bandwidth.</p><p>There are additional 300 status codes. See the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Status rel=external target=_blank>MDN Documentation</a> for a full list.</p><h3 id=4xx-status-codes>4XX Status Codes</h3><p>Codes in the 400&rsquo;s indicate client errors. These center around badly formatted requests and authentication status.</p><p><strong><code>400 Bad Request</code></strong> is a request that is poorly formatted and cannot be understood.</p><p><strong><code>401 Unauthorized</code></strong> means the user has not been authenticated, and needs to log in.</p><p><strong><code>403 Forbidden</code></strong> means the user does not have permissions to access the requested resource.</p><p><strong><code>404 Not Found</code></strong> means the requested resource is not found on the server.</p><p>There are <em>many</em> additional 400 status codes. See the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Status rel=external target=_blank>MDN Documentation</a> for a full list.</p><h3 id=5xx-status-codes>5XX Status Codes</h3><p>Status codes in the 500&rsquo;s indicate server errors.</p><p><strong><code>500 Server Error</code></strong> is a generic code for &ldquo;something went wrong in the server.&rdquo;</p><p><strong><code>501 Not Implemented</code></strong> indicates the server does not know how to handle the request method.</p><p><strong><code>503 Service Unavailable</code></strong> indicates the server is not able to handle the request at the moment due to being down, overloaded, or some other temporary condition.</p><p>There are additional 500 status codes. See the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Status rel=external target=_blank>MDN Documentation</a> for a full list.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=response-headers>Response Headers</h1><p>Response headers take the form of key-value pairs, separated by colons <code>:</code> and terminated with a CRLF (a carriage return and line feed character), just like Request Headers (both are types of Message Headers). For example, this header:</p><div class=highlight><pre tabindex=0><code>Expires: Wed, 12 Jun 2019 08:00:00 CST</code></pre></div><p>indicates to the browser that this content will expire June 12, 2019 at 8AM Central Standard Time. The browser can use this value when populating its cache, allowing it to use the cached version until the expiration time, reducing the need to make requests.</p><p>Note that response headers are a subset of <em>message headers</em> that apply specifically to requests. As we&rsquo;ve seen there are also message headers that apply only to HTTP requests, and some that apply to both.</p><p>As HTTP is intended as an extensible protocol, there are a <em>lot</em> of potential headers. IANA maintains the <a href=https://www.iana.org/assignments/message-headers/message-headers.xhtml rel=external target=_blank>official list of message headers</a> as well as <a href=https://www.iana.org/assignments/message-headers/message-headers.xhtml rel=external target=_blank>a list of proposed message headers</a>. You can also find a categorized list in the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers rel=external target=_blank>MDN Documentation</a></p><p>While there are many possible response headers, some of the more commonly used are:</p><p><strong>Allow</strong> Lists the HTTP Methods that can be used with the server</p><p><strong>Content-Length</strong> The length of the response body sent, in octets</p><p><strong>Content-Type</strong> The MIME type of the response body</p><p><strong>Content-Encoding</strong> The encoding method of the response body</p><p><strong>Location</strong> Used in conjunction with redirects (a 301 or 302 status code) to indicate where the user-agent should be redirected to.</p><p><strong>Server</strong> Contains information about the server handling the request.</p><p><strong>Set-Cookie</strong> Sets a cookie for this server on the client. The client will send back the cookie on subsequent requests using the <code>Cookie</code> header.</p><p>We&rsquo;ll make use of these headers as we start writing web servers.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=response-body>Response Body</h1><p>After the response headers and an extra CRLF (carriage return and line feed) is the response body.</p><p>The body is typically text (for HTML, CSS, JavaScript, and other text files) or binary data (for images, video, and other file types).</p><p>Setting the <code>Content-Type</code> and <code>Content-Length</code> headers lets the web client know what kind of data, and how much of it, should be expected. If these headers are not supplied in the response, the browser may treat the body as a blob of binary data, and only offer to save it.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=http-20>HTTP 2.0</h1><p>You may have noticed that the earlier parts of this chapter focused on HTTP version 1.1, while mentioning version 2.0. You might wonder why we didn&rsquo;t instead look at version 2.0 - and it&rsquo;s a valid question.</p><p>In short, HTTP 2.0 was created to make the request-response pattern of the web more efficient. One method it uses to do so is switching from text-based representations of requests and responses to binary-based representations. As you probably remember from working with File I/O, binary files are much smaller than the equivalent text file. The same is true of HTTP requests and responses. But the structure of HTTP 2.0 Requests and Responses are identical to HTTP 1.1 - they are simply binary (an hence, harder to read).</p><p>But this is not the only improvement in HTTP 2.0. Consider the request-response pattern we discussed earlier in the chapter:</p><p><a href=#R-image-15db202db155cc6f4e9d55a1b64cbfbb class=lightbox-link><img alt="HTTP 2.0&rsquo;s request-response pattern" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/2.11.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-15db202db155cc6f4e9d55a1b64cbfbb><img alt="HTTP 2.0&rsquo;s request-response pattern" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/2.11.1.png></a></p><p>To display a webpage, the browser must first request the page&rsquo;s HTML data. As it processes the returned HTML, it will likely encounter HTML <code>&lt;img></code>, <code>&lt;link></code>, and <code>&lt;src></code> tags that refer to other resources on the server. To get these resources, it will need to make additional requests. For a modern webpage, this can add up quickly! Consider a page with 20 images, 3 CSS files, and 2 JavaScript files. That&rsquo;s 25 separate requests!</p><p>One of the big improvements between HTTP/1.0 and HTTP/1.1 was that HTTP/1.1 does not close its connection to the server immediately - it leaves a channel open for a few seconds. This allows it to request these additional files without needing to re-open the connection between the browser and the server.</p><p>HTTP/2.0 takes this thought a step farther, by trying to anticipate the browser&rsquo;s additional requests. In the HTTP/2.0 protocol, when a browser requests an HTML page, the server can <em>push</em> the additional, linked files as part of the response. Thus, the entire page content can be retrieved with a single request instead of multiple, separate requests. This minimizes network traffic, allowing the server to handle more requests, and speeds up the process of rendering pages on a client&rsquo;s machine.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=statelessness-and-scaling>Statelessness and Scaling</h1><p>One final point to make about Hyper-Text Transfer Protocol. It is a <em>stateless</em> protocol. What this means is that the server does not need to keep track of previous requests - each request is treated as though it was the first time a request has been made.</p><p>This approach is important for several reasons. One, if a server must keep track of previous requests, the amount of memory required would grow quickly, especially for popular web sites. We could very quickly grow past the memory capacity of the server hardware, causing the webserver to crash.</p><p><a href=#R-image-9c96f09a9d8c255b8971c59e7445b54d class=lightbox-link><img alt="Scaling strategies" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/2.12.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9c96f09a9d8c255b8971c59e7445b54d><img alt="Scaling strategies" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/2.12.1.png></a></p><p>A second important reason is how we <em>scale</em> web applications to handle more visitors. We can do <em>vertical scaling</em> - increasing the power of the server hardware - or <em>horizontal scaling</em> - adding additional servers to handle incoming requests. Not surprisingly, the second option is the most cost-effective. But for it to work, requests need to be handed quickly to the first available server - there is no room for making sure a subsequent request is routed to the same server.</p><p>Thus, HTTP was designed as a <em>stateless</em> protocol, in that each new HTTP request is treated as being completely independent from all previous requests from the same client. This means that when using horizontal scaling, if the first request from client BOB is processed by server NANCY, and the second request from BOB is processed by server MARGE, there is no need for MARGE to know how NANCY responded. This stateless property was critical to making the world-wide-web even possible with the earliest internet technologies.</p><p>Of course, you probably have experience with websites that <em>do</em> seem to keep track of state - i.e. online stores, Canvas, etc. One of the challenges of the modern web was building state on top of a stateless protocol; we&rsquo;ll discuss the strategies used to do so in later chapters.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><p>In this chapter, we explored the Hyper-Text Transfer Protocol (HTTP), the technology used to exchange data across the web. We saw how requests and responses are simply well-structured streams of text or data exchanged across a packet-switched network. We examined the structure of these requests, and saw how they all use a similar pattern of a request or response line, a series of headers carrying metadata about the request or response, and an optional body.</p><p>We also discussed HTTP request methods like GET and POST, and HTTP response codes like a 404 and what these terms mean. We explored how HTTP has evolved from HTTP 1.0 to 1.1 to 2.0. And we discussed how HTTP is a stateless protocol, and how that statelessness is key to making websites that can serve thousands if not millions of users.</p><p>We&rsquo;ll continue to reference the content of this chapter as we move forward, as HTTP is one of the core web technologies along with HTML, CSS, and JavaScript.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 3</div><h1 id=asynchronous-javascript>Asynchronous JavaScript</h1><p>Parallel Processing Made Easy</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Asynchronous JavaScript</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>JavaScript makes extensive use of asynchronous processing to tackle the challenge of concurrency. This includes the events we&rsquo;ve already talked about (user events, network events and timers), but it has also been expanded to provide even more powerful features. The XMLHTTPRequest object allows JavaScript to request additional resources directly in an asynchronous manner, and the more recent Fetch API updates that approach. Web workers allow parallel JavaScript processes to be run in the browser. And new ES6 syntax and constructs like Promises and the async/await keywords make asynchronous functions easier to reason about and use. In this chapter, we will explore each of these topics.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=concurrency-approaches>Concurrency Approaches</h1><p>Concurrency means &ldquo;doing more than one thing at the same time.&rdquo; In computer science, concurrency can refer to (<a href=https://en.wikipedia.org/wiki/Concurrency_(computer_science) rel=external target=_blank>1</a>) structuring a program or algorithm so that it can be executed out-of-order or in partial order, or (<a href=https://en.wikipedia.org/wiki/Concurrent_computing rel=external target=_blank>2</a>) actually executing computations in parallel. In modern-day programming, we&rsquo;re often talking about <em>both</em>. But to help us develop a stronger understanding, let&rsquo;s look at the two ideas one-at-a-time, and then bring it together.</p><h2 id=concurrency>Concurrency</h2><p>One of the earliest concurrency problems computer science dealt with was the efficient use of early computers. Consider a mainframe computer like the <a href=https://en.wikipedia.org/wiki/PDP-1 rel=external target=_blank>PDP-1</a>, once a staple of the university computer science department. In 1963, the base price of a PDP-1 was $120,000. Adjusted for inflation, this would be a price of a bit more than <em>one million dollars</em> in 2020! That&rsquo;s a pretty big investment! Any institution, be it a university, a corporation, or a government agency that spent that kind of money would want to use their new computer as efficiently as possible.</p><p>Consider when you are working on a math assignment and using a calculator. You probably read your problem carefully, write out an equation on paper, and then type a few calculations into your calculator, and copy the results to your paper. You might write a few lines as you progress through solving the problem, then punch a new calculation into your calculator. Between computations, your calculator is sitting idle - not doing anything. Mainframe computers worked much the same way - you loaded a program, it ran, and spat out results. Until you loaded a new program, the mainframe would be idle.</p><h3 id=batch-processing>Batch Processing</h3><p>An early solution was the use of <a href=https://en.wikipedia.org/wiki/Batch_processing rel=external target=_blank>batch processing</a>, where programs were prepared ahead of time on punch-card machines or the like, and turned over to an IT department team that would then feed these programs into the computer. In this way, the IT staff could keep the computer working as long as there was batched work to do. While this approach kept the computer busy, it was not ideal for the programmers. Consider the calculator example - it would be as if you had to write out your calculations and give them to another person to enter into the calculator. And they might not get you your results for days!</p><p>Can you imagine trying to write a program that way? In the early days that was <em>exactly</em> how CS students wrote programs - they would write an entire program on punch cards, turn it in to the computer staff to be batched, and get the results once it had been run. If they made a mistake, it would require another full round of typing cards, turning them in, and waiting for results!</p><p>Batch processing is still used for some kinds of systems - such as the generation of your DARS report at K-State, for sending email campaigns, and for running jobs on Beocat and other supercomputers. However, in mainframe operations it quickly was displaced by <em>time sharing</em>.</p><h3 id=time-sharing>Time Sharing</h3><p><a href=https://en.wikipedia.org/wiki/Time-sharing rel=external target=_blank>Time-sharing</a> is an approach that has much in common with its real-estate equivalent that shares its name. In real estate, a time-share is a vacation property that is owned by multiple people, who take turns using it. In a mainframe computer system, a time sharing approach likewise means that multiple people share a single computer. In this approach, terminals (a monitor and keyboard) are hooked up to the mainframe. But there is one important difference between time-sharing real estate and computers, which is why we can call this approach <em>concurrent</em>.</p><p>Let&rsquo;s return to the example of the calculator. In the moments between your typing an expression and reading the results, another student could type in their expression, and get their results. A time-sharing mainframe does exactly that - it take a few fractions of a second to advance each users&rsquo; program, switching between different users at lightning speed. Consider a newspaper where twenty people might we writing stories at a given moment - each terminal would capture key presses, and send them to the mainframe when it gave its attention, which would update the text editor, and send the resulting screen data back to the terminal. To the individual users, it would appear the computer was only working with them. But in actuality it was updating all twenty text editor program instances in real-time (at least to human perception).</p><p>Like batch processing, time-sharing is still used in computing today. If you&rsquo;ve used the thin clients in the DUE 1114 lab, these are the current-day equivalents of those early terminals. They&rsquo;re basically a video card, monitor, and input device that are hooked up to a server that runs multiple VMs (virtual machines), one for each client, and switches between them constantly updating each.</p><h3 id=multitasking>Multitasking</h3><p>The <a href=https://en.wikipedia.org/wiki/Microcomputer rel=external target=_blank>microcomputer revolution</a> did not do away with the concept. Rather, modern operating systems still use the basic concept of the approach, though in the context of a single computer it is known as <a href=https://en.wikipedia.org/wiki/Computer_multitasking rel=external target=_blank>multitasking</a>. When you write a paper now, your operating system is switching between processes in much the same way that time-sharing switched between users. It will switch to your text editor, processing your last keystroke and updating the text on screen. Then it will shift to your music player and stream the next few thousand bytes of the song you&rsquo;re listening to the sound card. Then it will switch to your email program which checks the email server and it will start to notify you that a new email has come in. Then it will switch back to your text editor.</p><p>The thin clients in DUE 1114 (as well as the remote desktops) are therefore both time-sharing between VMs and multitasking within VMs.</p><h2 id=parallel-processing>Parallel Processing</h2><p>The second approach to concurrency involves using <em>multiple</em> computers in parallel. K-State&rsquo;s <a href="https://support.beocat.ksu.edu/BeocatDocs/index.php?title=Main_Page" rel=external target=_blank>Beocat</a> is a good example of this - a supercomputer built of a lot of individual computers. But your laptop or desktop likely is as well; if you have a multi-core CPU, you actually have multiple processors built into your CPU, and each can run separate computational processes. This, it is entirely possible that as you are writing your term paper the text editor is running on one processor, your email application is using a second one, and your music is running on a third.</p><p>In fact, modern operating systems use both multitasking and parallel processing in tandem, spreading out the work to do across however many cores are available, and swapping between active processes to on those cores. Some programs also organize their own computation to run on multiple processors - your text editor might actually be handling your input on one core, running a spellcheck on a second, and a grammar check on a third.</p><p>Remember our earlier discussion about scaling web servers? This is <em>also</em> a parallel processing approach. Incoming HTTP requests are directed by a load balancer to a less-busy server, and that server formulates the response.</p><p><a href=#R-image-78da10a329960a00eafefcb9e759a907 class=lightbox-link><img alt="Horizontal Scaling" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/3.2.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-78da10a329960a00eafefcb9e759a907><img alt="Horizontal Scaling" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/3.2.1.png></a></p><h3 id=multithreading>Multithreading</h3><p>Individual programs can <em>also</em> be written to execute on multiple cores. We typically call this approach <a href=https://en.wikipedia.org/wiki/Thread_(computing)#Multithreading rel=external target=_blank>Multithreading</a>, and the individually executing portions of the program code <em>threads</em>.</p><p>These aren&rsquo;t the only ways to approach concurrency, but they are ones we commonly see in practice. Before we turn our attention to how asynchronous processes fit in though, we&rsquo;ll want to discuss some of the challenges that concurrency brings.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=concurrency-challenges>Concurrency Challenges</h1><p>Implementing concurrency in computing systems comes with some specific challenges. Consider the multitasking approach where we have your text editor and your music player running at the same time. As the text editor process yields to the music player, the data and program elements it had loaded up into working memory, needs to be cleared out and replaced with the music player&rsquo;s data and program. However, the music player&rsquo;s data and program need to be retained <em>somewhere</em> so that they can be swapped back in when the music player yields.</p><p>Modern operating systems handle this challenge by dividing working memory amongst all programs running (which is why the more programs you run, the more RAM you consume). Each running process is assigned a block of memory and <em>only</em> allowed to use that memory. Moreover, data copied into the CPU (the L2 cache, L1 cache, and registers) may also be cached in memory for later restoration. You&rsquo;ll learn more about the details of this process if you take an Operating Systems course. But it is <em>very</em> important that each running program is <em>only</em> allowed to make changes in its own assigned memory space. If it wasn&rsquo;t, it could overwrite the data of another task!</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>In fact, an OS allowing a running program to overwrite another program&rsquo;s assigned memory is a <em>security vulnerability</em>, as this can involve overwriting part of the other <em>program</em>, changing how it actually works! Viruses, trojans, and worms are often written to exploit this kind of vulnerability.</p></div></div><p>While operating systems normally manage the challenges of concurrency between running programs, when the program <em>itself</em> is written to be concurrent, the program itself must be built to avoid accidentally overwriting its own memory in unexpected ways. Consider a text editor - it might have its main thread handling user input, and a second thread handling spell checking. Now the user has typed &ldquo;A quick brow&rdquo;, and the spell checker is finding that &ldquo;brow&rdquo; is misspelled. It might try to underline the line in red, but in the intervening time, the user has deleted &ldquo;brow&rdquo;, so the underlining is no longer valid!</p><p>Or consider image data. Applying a filter to an image is a computationally costly operation - typically requiring visiting each pixel in the image, and for some filters, visiting each pixel <em>around</em> each pixel as part of the transformation. This would be a good use-case for multi-threading. But now imagine <em>two</em> filters working in parallel. One might be applying a blur, and the other a grayscale transformation. If they were overwriting the old image data with their new filtered version, and were working at the same time, they might both start from the original pixels in the upper-right-hand corner. The blur would take longer, as it needs to visit neighboring pixels. So the grayscale filter writes out the first hundred pixels, and then the blur writes out its first hundred, over-writing the grayed pixels with blurred color pixels. Eventually, the grayscale filter will get so far ahead of the blur filter that the blur filter will be reading in now-greyed out pixels, and blurring them. The result could well be a mishmash of blurred color and gray-and-white splotches.</p><p>There are many different approaches that can be used to manage this challenge. One is the use of locks - locking a section of memory so only one thread can access it while it makes changes. In the filter example, the grayscale filter could lock the image data, forcing the blur filter to wait until it finishes. Locks work well, but must be carefully designed to avoid race conditions - where two threads cannot move forward because the other thread has already locked a resource the blocked thread needs to finish its work.</p><p>Asynchronous programming is another potential solution, which we&rsquo;ll look at next.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=asynchronous-programming>Asynchronous Programming</h1><p>In asynchronous programming, memory collisions are avoided by not sharing memory between threads. A unit of work that can be done in parallel is split off and handed to another thread, and any data it needs is copied into that threads&rsquo; memory space. When the work is complete, the second thread notifies the primary thread if the work was completed successfully or not, and provides the resulting data or error.</p><p>In JavaScript, this notification is pushed into the event queue, and the main thread processes it when the event loop pulls the result off the event queue. Thus, the only memory that is shared between the code you&rsquo;ve written in the Event Loop and the code running in the asynchronous process is the memory invovled in the event queue. Keeping this memory thread-safe is managed by the JavaScript interpreter. Thus, the code you write (which runs in the Event Loop) is essentially single-threaded, even if your JavaScript application is using some form of parallel processing!</p><p>Let&rsquo;s reconsider a topic we&rsquo;ve already discussed with this new understanding - timers. When we invoke <code>setTimer()</code>, we are creating a timer that is managed asynchronously. When the timer elapses, it creates a timer &rsquo;event&rsquo; and adds it to the event queue. We can see this in the diagram below.</p><p><a href=#R-image-ee1a73ed419d6a26b5d18da24d784702 class=lightbox-link><img alt="The timer and event loop" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/3.4.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ee1a73ed419d6a26b5d18da24d784702><img alt="The timer and event loop" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/3.4.1.png></a></p><p>However, the timer is not actually an <em>event</em>, in the same sense that a <code>'click'</code> or <code>'keydown'</code> event is&mldr; in that those events are provided to the browser from the operating system, and the browser passes them along into the JavaScript interpreter, possibly with some transformation. In contrast, the timer is created from within the JavaScript code, though its triggering is managed asynchronously.</p><p>In fact, both timers and events represent this style of asynchronous processing - both are managed by creating <em>messages</em> that are placed on the event queue to be processed by the interpreter. But the timer provides an important example of how asynchronous programming works. Consider this code that creates a timer that triggers after 0 milliseconds:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>setTimeout</span><span class=p>(()=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Timer expired!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;I just set a timer.&#34;</span><span class=p>);</span></span></span></code></pre></div><p>What will be printed first? The &ldquo;Timer expired!&rdquo; message or the &ldquo;I just set a timer.&rdquo; message?</p><p>See for yourself - try running this code in the console (you can click the &ldquo;console&rdquo; tab below to open it).</p><p>The answer is that &ldquo;I just set a timer&rdquo; will <em>always</em> be printed first, because the second message won&rsquo;t be printed until the event loop pulls the timer message off the queue, and the line printing &ldquo;I just set a timer&rdquo; is executed as part of this pass in the event loop. The <code>setTimeout()</code> and <code>setInterval()</code> functions are what we call <em>asynchronous</em> functions, as they trigger an asynchronous process. Once that process is triggered, execution immediately continues within the event loop, while the triggered process runs in parallel. Asynchronous functions typically take a function as an argument, known as a <em>callback function</em>, which will be triggered when the message corresponding to the asynchronous process is pulled off the event queue.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>Any code appearing after a call to an asynchronous function will be executed immediately after the asynchronous function is invoked, regardless of how quickly the asynchronous process generates its message and adds it to the event queue.</p></div></div><p>As JavaScript was expanded to take on new functionality, this asynchronous mechanism was re-used. Next, we&rsquo;ll take a look at an example of this in the use of <em>web workers</em>.</p><style>.console{position:fixed;bottom:0;left:300px;box-sizing:border-box;z-index:1000;width:calc(100% - 300px);height:30vh;background-color:#8451a1;padding:1rem;transform:translateY(calc(30vh - 5px));transition:transform 1s}.console iframe{width:100%;height:100%;background-color:#fff}.console>.console-tab{position:absolute;top:-1.2rem;right:0;color:#fff;background-color:#8451a1;padding:0 2rem;border-radius:5px;cursor:pointer}.console.active{transform:none}</style><div class=console><div class=console-tab>CONSOLE</div><iframe src=https://jsconsole.com/></iframe></div><script>document.querySelector(".console-tab").addEventListener("click",e=>{console.log(e),e.target.parentElement.classList.toggle("active")})</script><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=web-workers>Web Workers</h1><p>As JavaScript began to be used to add more and more functionality to web applications, an important limitation began to appear. When the JavaScript interpreter is working on a big task, it stays in the event loop a long time, and does not pull events from the event queue. The result is the browser stops responding to user events&mldr; and seems to be frozen. On the other hand - some programs will <em>never</em> end. Consider this one:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;thinking...&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>This loop has no possible exit condition, so if you ran it in the browser, it would run infinitely long&mldr; and the page would never respond to user input, because you&rsquo;d never pull any events of the event queue. One of the important discoveries in computer science, the <a href=https://en.wikipedia.org/wiki/Halting_problem rel=external target=_blank>Halting Problem</a> tackles exactly this issue - and Alan Turing&rsquo;s proof shows that a program to determine if another program will halt for all possible programs <em>cannot</em> be written.</p><p>Thus, browsers instead post warning messages after execution has run for a significant amount of time, like this one:</p><p><a href=#R-image-5122807c9931132ae30b6e9067d6881f class=lightbox-link><img alt="The Chrome not responding dialog" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/3.5.1.jpg style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5122807c9931132ae30b6e9067d6881f><img alt="The Chrome not responding dialog" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/3.5.1.jpg></a></p><p>So, if we want to do a long-running computation, and <em>not</em> have the browser freeze up, we needed to be able to run it separately from the thread our event loop is running on. The <a href=https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers rel=external target=_blank>web worker</a> provides just this functionality.</p><p>A web worker is essentially another JavaScript interpreter, running a script separate from the main thread. As an interpreter, it has its own event loop and its own memory space. Workers and the main thread can communicate by passing messages, which are copied onto their respective event queues. Thus, communication between the threads is <em>asynchronous</em>.</p><p><a href=#R-image-0dbb5f1fb532b3b16bf4b968612ed609 class=lightbox-link><img alt="The web worker and main thread interpreters passing messages" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/3.5.2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0dbb5f1fb532b3b16bf4b968612ed609><img alt="The web worker and main thread interpreters passing messages" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/3.5.2.png></a></p><h2 id=an-example>An Example</h2><p>You can see an example of such a web worker by using <a href=/cis526/03-asynchronous-js/05-web-workers/../../examples/3.5.1/index.html target=_blank>this link</a> to open another tab in your browser. This example simulates a long-running process of <strong>n</strong> seconds either in the browser&rsquo;s main thread or in a web worker. On the page is also three colored squares that when clicked, shift colors. Try changing the colors of the squares while simulating a several-second process in both ways. See how running the process on the main thread freezes the user interface?</p><h2 id=using-web-workers>Using Web Workers</h2><p>Web workers are actually very easy to use. A web worker is created by constructing a <a href=https://developer.mozilla.org/en-US/docs/Web/API/Worker rel=external target=_blank>Worker</a> object. It takes a single argument - the JavaScript file it will execute (which should be hosted on the same server). In the example, this is done with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Set up the web worker
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>worker</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Worker</span><span class=p>(</span><span class=s1>&#39;stall.js&#39;</span><span class=p>);</span></span></span></code></pre></div><p>The <em>stall.js</em> file contains the script the worker will execute - we&rsquo;ll take a look at it in a minute.</p><p>Once created, you can attach a listener to the <code>Worker</code>. It has two events:</p><ul><li><code>message</code> - a deserialized message sent from the web worker</li><li><code>mesageerror</code> - a message sent from the web worker that was not serializable</li></ul><p>You can use <code>worker.addEventListener()</code> to add these, or you can assign your event listener to the event handler properties. Those properties are:</p><ul><li><code>Worker.onmessage</code> - triggered when the <code>message</code> event happens</li><li><code>Worker.onmessageerror</code> - triggered when the <code>messageerror</code> event happens</li></ul><p>Additionally, there is an error handler property:</p><ul><li><code>Worker.onerror</code></li></ul><p>Which triggers when an uncaught error occurs on the web worker.</p><p>In our example, we listen for messages using the <code>Worker.onmessage</code> property:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Set up message listener
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>worker</span><span class=p>.</span><span class=nx>onmessage</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Signal completion
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s1>&#39;#calculation-message&#39;</span><span class=p>).</span><span class=nx>textContent</span> <span class=o>=</span> <span class=sb>`Calculation complete!`</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>If the message was successfully deserialized, it&rsquo;s <code>data</code> property contains the content of the message, which can be any valid JavaScript value (an int, string, array, object, etc). This gives us a great deal of flexibility. If you need to send more than one type of message, a common strategy is to send a JavaScript object with a type property, and additional properties as needed, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>messageData1</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;greeting&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>body</span><span class=o>:</span> <span class=s2>&#34;Hello!  It&#39;s good to see you.&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>messageData2</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;set-color&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>color</span><span class=o>:</span> <span class=s2>&#34;#ffaacc&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>We can send messages <em>to</em> the web worker with <a href=https://developer.mozilla.org/en-US/docs/Web/API/Worker/postMessage rel=external target=_blank>Worker.postMessage()</a>. Again, these messages can be any valid JavaScript value:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=s2>&#34;Foo&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>({</span><span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;greetings&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=o>:</span> <span class=s2>&#34;Take me to your leader!&#34;</span><span class=p>});</span></span></span></code></pre></div><p>In our example, we send the number of seconds to wait as an integer parsed from the <code>&lt;input></code> element:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Get the number to calculate the Fibonacci number for and convert it from a string to a base 10 integer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>n</span> <span class=o>=</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s1>&#39;#n&#39;</span><span class=p>).</span><span class=nx>value</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Stall for the specified amount of time
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>worker</span><span class=p>.</span><span class=nx>postMessage</span><span class=p>(</span><span class=nx>n</span><span class=p>);</span></span></span></code></pre></div><p>Whatever data we send as the message is <em>copied</em> into the web worker&rsquo;s memory using the <a href=https://developer.mozilla.org/en-US/docs/Web/Guide/DOM/The_structured_clone_algorithm rel=external target=_blank>structured clone</a> algorithm. We can also optionally <em>transfer</em> objects to the web worker instead of copying them by providing them as a second argument. This transfers the memory holding them from one thread to the other. This makes them unavailable on the original thread, but is much faster than copying when the object is large. It is used for sending objects like <a href=https://developer.mozilla.org/en-US/docs/Web/API/ArrayBuffer rel=external target=_blank>ArrayBuffer</a>, <a href=https://developer.mozilla.org/en-US/docs/Web/API/MessagePort rel=external target=_blank>MessagePort</a>, or <a href=https://developer.mozilla.org/en-US/docs/Web/API/ImageBitmap rel=external target=_blank>ImageBitmap</a>. Transferred objects <em>also</em> need to have a reference in the first argument.</p><h2 id=the-web-worker-context>The Web Worker Context</h2><p>For the JavaScript executing in the web worker, the context is a bit different. First, there is no document object model, as the web worker cannot make changes to the user interface. Likewise there is no global <code>window</code> object. However, many of the normal global functions and properties <em>not</em> related to the user interface are available, see <a href=https://developer.mozilla.org/en-US/docs/Web/API/Worker/Functions_and_classes_available_to_workers rel=external target=_blank>functions and classes available to web workers</a> for details.</p><p>The web worker has its own unique global scope, so any variables declared in your main thread won&rsquo;t exist here. Likewise, varibles declared in the worker will not exist in the main scope either. The global scope of the worker has mirror events and properties to the <code>Worker</code> - we can listen for messages from the main thread using the <code>onmessage</code> and <code>onmessageerror</code> properties, and send messages back to the main thread with <code>postMessage()</code>.</p><p>The complete web worker script from the example is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/** @function stall 
</span></span></span><span class=line><span class=cl><span class=cm> * Synchronously stalls for the specified amount of time 
</span></span></span><span class=line><span class=cl><span class=cm> * to simulate a long-running calculation
</span></span></span><span class=line><span class=cl><span class=cm> * @param {int} seconds - the number of seconds to stall
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>stall</span><span class=p>(</span><span class=nx>seconds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>startTime</span> <span class=o>=</span> <span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>endTime</span> <span class=o>=</span> <span class=nx>seconds</span> <span class=o>*</span> <span class=mi>1000</span> <span class=o>+</span> <span class=nx>startTime</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span> <span class=o>&gt;</span> <span class=nx>endTime</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Message handler for messages from the main thread
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>onmessage</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// stall for the specified amount of time 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>stall</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Send an answer back to the main thread
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>postMessage</span><span class=p>(</span><span class=sb>`Stalled for </span><span class=si>${</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=si>}</span><span class=sb> seconds`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Close the worker since we create a
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// new worker with each stall request.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Alternatively, we could re-use the same
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// worker.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div><p>Workers can also send AJAX requests, and spawn additional web workers! In the case of spawning additional workers, the web worker that creates the child worker is treated as the main thread.</p><h2 id=other-kinds-of-web-workers>Other kinds of Web Workers</h2><p>The web workers we&rsquo;ve discussed up to this point are basic <em>dedicated workers</em>. There are also several other kinds of specialized web workers:</p><ul><li>Shared workers are shared between several scripts, possibly even running in different <code>&lt;iframe></code> elements. These are more complex than a dedicated worker and communicate via ports. See MDN&rsquo;s <a href=https://developer.mozilla.org/en-US/docs/Web/API/SharedWorker rel=external target=_blank>SharedWorker</a> article for information.</li><li>Service workers act as proxy servers between the server and the web app, for the purpose of allowing web apps to be used offline. We&rsquo;ll discuss these later in the semester, but you can read up on them in hte mdn <a href=https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorker_API rel=external target=_blank>ServiceWorker</a> article.</li><li>Audio workers allow for direct scripting of audio processing within a web worker context. See the mdn <a href=https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API#Audio_Workers rel=external target=_blank>AudioWorker</a> article for details.</li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=callbacks>Callbacks</h1><style>.console{position:fixed;bottom:0;left:300px;box-sizing:border-box;z-index:1000;width:calc(100% - 300px);height:30vh;background-color:#8451a1;padding:1rem;transform:translateY(calc(30vh - 5px));transition:transform 1s}.console iframe{width:100%;height:100%;background-color:#fff}.console>.console-tab{position:absolute;top:-1.2rem;right:0;color:#fff;background-color:#8451a1;padding:0 2rem;border-radius:5px;cursor:pointer}.console.active{transform:none}</style><div class=console><div class=console-tab>CONSOLE</div><iframe src=https://jsconsole.com/></iframe></div><script>document.querySelector(".console-tab").addEventListener("click",e=>{console.log(e),e.target.parentElement.classList.toggle("active")})</script><p>JavaScript implements its asynchronous nature through <em>callbacks</em> - functions that are invoked when an asynchronous process completes. We see this in our discussion of timers like <code>setTimeout()</code> and with our web workers with the <code>onmessage</code> event handler. These demonstrate two possible ways of setting a callback. With <code>setTimeout()</code> we pass the callback as a function parameter, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>timeElapsed</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Time has elapsed!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// Set a timer for 1 second, and trigger timeElapsed() when the timer expires
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>setTimeout</span><span class=p>(</span><span class=nx>timeElapsed</span><span class=p>,</span> <span class=mi>1000</span><span class=p>);</span></span></span></code></pre></div><p>With webworkers, we assign a function to a property of the worker (the <code>onmessage</code> variable):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>messageReceived</span><span class=p>(</span><span class=nx>message</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Received &#34;</span> <span class=o>+</span> <span class=nx>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// Set the event listener
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>onmessage</span> <span class=o>=</span> <span class=nx>messageReceived</span><span class=p>;</span></span></span></code></pre></div><p>Remember, a callback is a function, and in JavaScript, functions are first-order: we can assign them as a variable or pass them as an argument to a function! We can also define a callback asynchronously as part of the argument, as we do here:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>setTimeout</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;time elapsed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=mi>1000</span><span class=p>);</span></span></span></code></pre></div><p>Or using lambda syntax:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;time elapsed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=mi>1000</span><span class=p>);</span></span></span></code></pre></div><p>These are roughly equivalent to passing <code>timeElapsed()</code> in the first example - and you&rsquo;ll likely see all three approaches when you read others&rsquo; code.</p><h3 id=callback-hell>Callback Hell</h3><p>Callbacks are a powerful mechanism for expressing asynchronicity, but overuse can lead to difficult to read code - a situation JavaScript programmers refer to as &ldquo;callback hell&rdquo;. This problem became especially pronounced once programmers began using Node to build server-side code, as Node adopted the event-based callback asynchronous model of JavaScript for interactions with the file system,databases, etc. (we&rsquo;ll cover Node in the <a href=https://textbooks.cs.ksu.edu/cis526/04-node/ rel=external target=_blank>next chapter</a>).</p><p>Consider this example, which logs a user into a website:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>webapp</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>parseFormData</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=p>(</span><span class=nx>form</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>username</span> <span class=o>=</span> <span class=nx>form</span><span class=p>.</span><span class=nx>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>password</span> <span class=o>=</span> <span class=nx>form</span><span class=p>.</span><span class=nx>password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>findUserInDatabase</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>encryptPassword</span><span class=p>(</span><span class=nx>password</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>salt</span><span class=p>,</span> <span class=p>(</span><span class=nx>hash</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span><span class=p>(</span><span class=nx>hash</span> <span class=o>===</span> <span class=nx>user</span><span class=p>.</span><span class=nx>passwordHash</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>                    <span class=nx>res</span><span class=p>.</span><span class=nx>setCookie</span><span class=p>({</span><span class=nx>user</span><span class=o>:</span> <span class=nx>user</span><span class=p>});</span>
</span></span><span class=line><span class=cl>                    <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s2>&#34;Logged in successfully!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span>
</span></span><span class=line><span class=cl>                    <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=mi>403</span><span class=p>,</span> <span class=s2>&#34;Unknown username/password combo&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Don&rsquo;t work about the exact details of the code, but count the number of nested callbacks. There are four! And reasoning about this deeply nested code starts getting pretty challenging even for an experienced programmer. Also, handling errors in this nested structure requires thinking through the nested structure.</p><p>There are strategies to mitigate this challenge in writing your code, including:</p><ol><li>Keeping your code shallow</li><li>Modularizing your code</li><li>Handling every single error.</li></ol><p>The site <a href=http://callbackhell.com>callbackhell.com</a> offers a detailed discussion of these strategies.</p><p>As JavaScript matured, additional options were developed for handling this complexity - Promises and the <code>async</code> and <code>await</code> keywords. We&rsquo;ll talk about them next.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=promises>Promises</h1><style>.console{position:fixed;bottom:0;left:300px;box-sizing:border-box;z-index:1000;width:calc(100% - 300px);height:30vh;background-color:#8451a1;padding:1rem;transform:translateY(calc(30vh - 5px));transition:transform 1s}.console iframe{width:100%;height:100%;background-color:#fff}.console>.console-tab{position:absolute;top:-1.2rem;right:0;color:#fff;background-color:#8451a1;padding:0 2rem;border-radius:5px;cursor:pointer}.console.active{transform:none}</style><div class=console><div class=console-tab>CONSOLE</div><iframe src=https://jsconsole.com/></iframe></div><script>document.querySelector(".console-tab").addEventListener("click",e=>{console.log(e),e.target.parentElement.classList.toggle("active")})</script><p>Promises replace the callback mechanism with a JavaScript object, a <code>Promise</code>. In many ways, this is similar to the <code>XMLHttpRequest</code> object that is at the heart of <a href=https://textbooks.cs.ksu.edu/cis526/c-js/11-ajax/ rel=external target=_blank>AJAX</a>. You can think of it as a state machine that is in one of three states: <em>pending</em>, <em>fulfilled</em>, or <em>rejected</em>.</p><p>A promise can be created by wrapping an asynchronous call within a new <code>Promise</code> object. For example, we can turn a <code>setTimeout()</code> into a promise with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>threeSecondPromise</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>resolve</span><span class=p>(</span><span class=s2>&#34;Timer elapsed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=mi>300</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>We can also create a promise that immediately resolves using <code>Promise.resolve()</code>, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>fifteenPromise</span> <span class=o>=</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=mi>15</span><span class=p>);</span></span></span></code></pre></div><p>This promise is never in the <em>pending</em> state - it starts as <em>resolved</em>. Similarly, you can create a promise that starts in the <em>rejected</em> state with <code>Promise.reject()</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>failedPromise</span> <span class=o>=</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>reject</span><span class=p>(</span><span class=s2>&#34;I am a failure...&#34;</span><span class=p>);</span></span></span></code></pre></div><p>You can also pass an error object to <code>Promise.reject()</code>.</p><h4 id=using-promiseprototypethen>Using Promise.prototype.then()</h4><p>What makes promises especially useful is their <code>then()</code> method. This method is invoked when the promise finishes, and is passed whatever the promise resolved to, i.e. the string <code>"Timer elapsed"</code> in the example above. Say we want to log that result to the console:</p><div class=highlight><pre tabindex=0><code>threeSecondPromise.then(result =&gt; {console.log(result)});</code></pre></div><p>This is a rather trivial example, but we can use the same approach to define a <em>new</em> method for creating timers that might seem more comfortable for object-oriented programmers:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>createTimer</span><span class=p>(</span><span class=nx>milliseconds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>resolve</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=nx>milliseconds</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>With this method, we can create a timer to do any arbitrary action, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Say &#34;Hello Delayed World&#34; after five seconds
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>createTimer</span><span class=p>(</span><span class=mi>5000</span><span class=p>).</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Hello delayed World!&#34;</span><span class=p>));</span></span></span></code></pre></div><h4 id=using-promiseprototypecatch>Using Promise.prototype.catch()</h4><p>In addition to the <code>then()</code> method, promises also provide a <code>catch()</code> method. This method handles any errors that were thrown by the promise. Consider this function that returns a promise to compute an average:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>computeAverage</span><span class=p>(</span><span class=nx>numbers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Sum the numbers
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>sum</span> <span class=o>=</span> <span class=nx>numbers</span><span class=p>.</span><span class=nx>reduce</span><span class=p>((</span><span class=nx>acc</span><span class=p>,</span> <span class=nx>value</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>acc</span> <span class=o>+</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Compute the average 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>average</span> <span class=o>=</span> <span class=nx>sum</span> <span class=o>/</span> <span class=nx>numbers</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>resolve</span><span class=p>(</span><span class=nx>average</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Try copying this code into the console, and then run some examples, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>computeAverage</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>5</span><span class=p>]).</span><span class=nx>then</span><span class=p>(</span><span class=nx>average</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;The average is&#34;</span><span class=p>,</span> <span class=nx>average</span><span class=p>));</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>computeAverage</span><span class=p>([</span><span class=mf>0.3</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mf>20.5</span><span class=p>]).</span><span class=nx>then</span><span class=p>(</span><span class=nx>average</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;The average is&#34;</span><span class=p>,</span> <span class=nx>average</span><span class=p>));</span></span></span></code></pre></div><p>But what if we use the <em>empty array</em>?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>computeAverage</span><span class=p>([]).</span><span class=nx>then</span><span class=p>(</span><span class=nx>average</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;The average is&#34;</span><span class=p>,</span> <span class=nx>average</span><span class=p>));</span></span></span></code></pre></div><p>Because the length of the empty array is 0, we are dividing by 0, and an error will be thrown. Notice the error message reads &ldquo;Uncaught (in promise)&rdquo;&mldr; we can use the <code>catch()</code> method to capture this error, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>computeAverage</span><span class=p>([])</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>average</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;The average is&#34;</span><span class=p>,</span> <span class=nx>average</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>err</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&#34;Encountered an error:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>));</span></span></span></code></pre></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>Note when chaining JavaScript method calls, our dot <code>.</code> can be separated from the object it belongs to by whitespace. This can help keep our code readable by putting it on multiple lines.</p></div></div><p>Now when we run this code, the error is handled by our <code>catch()</code>. We&rsquo;re still printing it to the console as an error - but notice the message now reads <code>"Encountered an error" ...</code>, i.e. it&rsquo;s <em>our</em> error message!</p><p>Let&rsquo;s try one more - an array that <em>cannot</em> be averaged, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>computeAverage</span><span class=p>([</span><span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=s1>&#39;banana&#39;</span><span class=p>,</span> <span class=kc>true</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>average</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;The average is&#34;</span><span class=p>,</span> <span class=nx>average</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>err</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&#34;Encountered an error:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>));</span></span></span></code></pre></div><p>Here we see the promise resolves successfully, but the result is <code>NaN</code> (not a number). This is because that is the normal result of this operation in JavaScript. But what if we want that to be treated as an error? That&rsquo;s where the <code>reject()</code> callback provided to the promise comes in - it is used to indicate the promise should fail. We&rsquo;ll need to rewrite our <code>computeAverage()</code> method to use this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>computeAverage</span><span class=p>(</span><span class=nx>numbers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Sum the numbers
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>sum</span> <span class=o>=</span> <span class=nx>numbers</span><span class=p>.</span><span class=nx>reduce</span><span class=p>((</span><span class=nx>acc</span><span class=p>,</span> <span class=nx>value</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>acc</span> <span class=o>+</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Compute the average 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>average</span> <span class=o>=</span> <span class=nx>sum</span> <span class=o>/</span> <span class=nx>numbers</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nb>isNaN</span><span class=p>(</span><span class=nx>average</span><span class=p>))</span> <span class=nx>reject</span><span class=p>(</span><span class=s2>&#34;Average cannot be computed.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=nx>resolve</span><span class=p>(</span><span class=nx>average</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Rejected promises are also handled by the <code>catch()</code> method, so if we rerun the last example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>computeAverage</span><span class=p>([</span><span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=s1>&#39;bannana&#39;</span><span class=p>,</span> <span class=kc>true</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>average</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;The average is&#34;</span><span class=p>,</span> <span class=nx>average</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>err</span> <span class=p>=&gt;</span> <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&#34;Encountered an error:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>));</span></span></span></code></pre></div><p>Notice we now see our error message!</p><h4 id=chaining-promiseprototypethen-and-promiseprototypecatch>Chaining Promise.prototype.then() and Promise.prototype.catch()</h4><p>Where <code>Promise.prototype.then()</code> and <code>Promise.prototype.catch()</code> really shine is when we <em>chain</em> a series of promises together. Remember our callback hell example?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>webapp</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>parseFormData</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=p>(</span><span class=nx>form</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>username</span> <span class=o>=</span> <span class=nx>form</span><span class=p>.</span><span class=nx>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>password</span> <span class=o>=</span> <span class=nx>form</span><span class=p>.</span><span class=nx>password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>findUserInDatabase</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>encryptPassword</span><span class=p>(</span><span class=nx>password</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>salt</span><span class=p>,</span> <span class=p>(</span><span class=nx>hash</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span><span class=p>(</span><span class=nx>hash</span> <span class=o>===</span> <span class=nx>user</span><span class=p>.</span><span class=nx>passwordHash</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>                    <span class=nx>res</span><span class=p>.</span><span class=nx>setCookie</span><span class=p>({</span><span class=nx>user</span><span class=o>:</span> <span class=nx>user</span><span class=p>});</span>
</span></span><span class=line><span class=cl>                    <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s2>&#34;Logged in successfully!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span>
</span></span><span class=line><span class=cl>                    <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=mi>403</span><span class=p>,</span> <span class=s2>&#34;Unknown username/password combo&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>If each of our methods returned a promise, we could re-write this as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>webapp</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>parseFormData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>formData</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>username</span> <span class=o>=</span> <span class=nx>formData</span><span class=p>.</span><span class=nx>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>password</span> <span class=o>=</span> <span class=nx>formData</span><span class=p>.</span><span class=nx>password</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>findUserInDatabase</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>user</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>encryptPassword</span><span class=p>(</span><span class=nx>password</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>salt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>hash</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>hash</span> <span class=o>===</span> <span class=nx>user</span><span class=p>.</span><span class=nx>passwordHash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>setCookie</span><span class=p>({</span><span class=nx>user</span><span class=o>:</span> <span class=nx>user</span><span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=s2>&#34;Logged in successfully&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> 
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=mi>403</span><span class=p>,</span> <span class=s2>&#34;Unknown username/password combo&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>err</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=mi>500</span><span class=p>,</span> <span class=s2>&#34;A server error occurred&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span></span></span></code></pre></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>The <code>Promise.prototype.catch()</code> method catches any error or promise rejection that occurs before it in the chain - basically as soon as an error or rejection occurs, further <code>.then()</code> calls are skipped until a <code>.catch()</code> is encountered. You can also chain additional <code>.then()</code> calls after a <code>.catch()</code>, and they will be processed until another error or rejection occurs!</p></div></div><h4 id=promiseall>Promise.All()</h4><p>In addition to processing promises in serial (one after another) by chaining <code>.then()</code> methods, sometimes we want to do them in <em>parallel</em> (all at the same time). For example, say we have several independent processes (perhaps each running on a webworker or separate Node thread) that when finished, we want to average together.</p><p>The <code>Promise.All()</code> method is the answer; it returns a promise to execute an arbitrary number of promises, and when all have finished, it itself resolves to an array of their results.</p><p>Let&rsquo;s do a quick example using this method. We&rsquo;ll start by declaring a function to wrap a fake asynchronous process - basically creating a random number (between 1 and 100) after a random number of seconds (between 0 and 3):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>mockTask</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=nx>value</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>ceil</span><span class=p>(</span><span class=nb>Math</span><span class=p>.</span><span class=nx>random</span><span class=p>()</span><span class=o>*</span><span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Computed value&#34;</span><span class=p>,</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>resolve</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>random</span><span class=p>()</span> <span class=o>*</span> <span class=mi>3000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Now let&rsquo;s say we want to compute an average of the results once they&rsquo;ve finished. As <code>Promise.All()</code> returns a <code>Promise</code> that resolves to a an array of the results, we can invoke our <code>computeAverage()</code> (which we declared previously) in a chained <code>.then()</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nb>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=nx>mockTask</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>mockTask</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>mockTask</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>mockTask</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>computeAverage</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>);</span></span></span></code></pre></div><p>Note that because <code>computeAverage</code> takes as a parameter an array, and <code>console.log</code> takes as its parameter a value, and those are what the previous promises resolve to, we don&rsquo;t have to define anonymous functions to pass into <code>.then()</code> - we can pass the function name instead.</p><p>Many JavaScript programmers found this format more comfortable to write and read than a series of nested callbacks. However, the <code>async</code> and <code>await</code> syntax offers a <em>third</em> option, which we&rsquo;ll look at next.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=async-and-await>Async and Await</h1><p>The <code>async</code> and <code>await</code> keywords are probably more familiar to you from languages like C#. JavaScript introduced them to play much the same role - a function declared <code>async</code> is asynchronous, and returns a <code>Promise</code> object.</p><p>With this in mind, we can redeclare our <code>createTimer()</code> method using the <code>async</code> keyword:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>createTimer</span><span class=p>(</span><span class=nx>milliseconds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>resolve</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=nx>milliseconds</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Now, instead of using the promise directly, we can use the <code>await</code> keyword in other code to wait on the promise to resolve, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>await</span> <span class=nx>createTimer</span><span class=p>(</span><span class=mi>4000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Moving on...&#34;</span><span class=p>);</span></span></span></code></pre></div><p>Try running this in the console. Notice that the second line is not executed until the timer has elapsed after 4 seconds!</p><p>Similarly, if we need to use a value computed as part of an asynchronous process, we can place the <code>await</code> within the assignment. I.e. to reproduce the <code>Promise.All()</code> example in the previous section, we could re-write our <code>mockTask()</code> and <code>computeAverage()</code> as <code>async</code> functions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>mockTask</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setTimeout</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=nx>value</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>ceil</span><span class=p>(</span><span class=nb>Math</span><span class=p>.</span><span class=nx>random</span><span class=p>()</span><span class=o>*</span><span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Computed value&#34;</span><span class=p>,</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>resolve</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>random</span><span class=p>()</span> <span class=o>*</span> <span class=mi>3000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>computeAverage</span><span class=p>(</span><span class=nx>numbers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Sum the numbers
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>sum</span> <span class=o>=</span> <span class=nx>numbers</span><span class=p>.</span><span class=nx>reduce</span><span class=p>((</span><span class=nx>acc</span><span class=p>,</span> <span class=nx>value</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>acc</span> <span class=o>+</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Compute the average
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>average</span> <span class=o>=</span> <span class=nx>sum</span> <span class=o>/</span> <span class=nx>numbers</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nb>isNaN</span><span class=p>(</span><span class=nx>average</span><span class=p>))</span> <span class=nx>reject</span><span class=p>(</span><span class=s2>&#34;Average cannot be computed.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=nx>resolve</span><span class=p>(</span><span class=nx>average</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>And then the code to perform the averaging could be written:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>numbers</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl><span class=nx>numbers</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=kr>await</span> <span class=nx>mockTask</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>numbers</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=kr>await</span> <span class=nx>mockTask</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>numbers</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=kr>await</span> <span class=nx>mockTask</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>numbers</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=kr>await</span> <span class=nx>mockTask</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>average</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>computeAverage</span><span class=p>(</span><span class=nx>numbers</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>average</span><span class=p>);</span></span></span></code></pre></div><p>Many imperative programmers prefer the <code>async</code> and <code>await</code> syntax, because execution of the code pauses at each <code>await</code>, so code statements are executed in the order they appear in the code. However, the actual execution model it is <em>still</em> the event-based concurrency that we introduced with callbacks. Thus, when awaiting a result, the JavaScript interpreter is free to process other incoming events pulled off the event loop.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><p>In this chapter we learned about many of the approaches and challenges involved in concurrent programming, including <em>asynchronous</em> programming. JavaScript adopts the asynchronous approach through its use of the event loop and queue, allowing asynchronous processes to be invoked, processed on separate threads, and posting their results as new messages on the event queue to be processed when the main thread gets to them.</p><p>We saw how this approach allows for multi-threaded programs in the browser through the use of web workers, each of which runs a separate JavaScript interpreter with its own event loop and queue. We also saw how communication between web workers and the main thread are handled through message passing, and how very large data buffers can be transferred instead of copied between these threads for efficiency.</p><p>Finally, we examined the callback mechanism used for asynchronous processing in JavaScript, and explored two common abstractions used to make it more programmer-friendly: promises and the async/await keywords.</p><p>In the next chapter, we&rsquo;ll explore Node.js, a server-side implementation of the JavaScript engine that makes heavy use of the JavaScript asynchronous model.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 4</div><h1 id=introduction-to-node>Introduction to Node</h1><p>JavaScript on the Server</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Introduction to Node</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>Node is an open-source, cross-platform JavaScript runtime environment build on Google&rsquo;s V8 engine. It was created by Ryan Dahl in 2009 to allow for server-side scripting in JavaScript.</p><p><a href=#R-image-e86a92dd379da75f10257ab8693dce0a class=lightbox-link><img alt="Ryan Dahl" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/Ryan_Dahl.jpg style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e86a92dd379da75f10257ab8693dce0a><img alt="Ryan Dahl" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/Ryan_Dahl.jpg></a></p><h2 id=ecmascript-support>ECMAScript Support</h2><p>Node supports most of the features of ECMAScript 2015 (ES6), with the notable exception of ES6 modules (as Node adopted the CommonJS module approach before the ES6 proposal, and the two approaches are not interchangeable). You can learn more about Node&rsquo;s ES6 support <a href=https://nodejs.org/en/docs/es6/ rel=external target=_blank>here</a>.</p><h2 id=differences-between-browser-javascript-and-node>Differences between Browser JavaScript and Node</h2><p>While JavaScript in the browser has been deliberately sandboxed and is only allowed to interact with the current document and the Internet, Node can interact with the file system and operating system of the hosting computer. Also, because Node is not hosted in a browser, it has no Document Object Model (DOM), and no <code>document</code> or <code>window</code> global variables. To reflect this, the global namespace for Node is <code>global</code> instead of <code>window</code>.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>Node can be downloaded for Windows, Linux, and MacOS at <a href=https://nodejs.org/en/ rel=external target=_blank>https://nodejs.org/en/</a>. Documentation for Node is found at <a href=https://nodejs.org/en/docs/ rel=external target=_blank>https://nodejs.org/en/docs/</a>. On many Linux and Mac systems, multiple versions of Node can be installed and managed using <a href=https://github.com/nvm-sh/nvm rel=external target=_blank>Node Version Manager (nvm)</a>. Using nvm may be preferred on those systems since most package repositories include older and outdated versions of Node.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=event-loop--console>Event Loop & Console</h1><p>Node adopts an asynchronous event-driven approach to computing, much like JavaScript does in the browser. For example, when we set up a HTTP server in Node, we define a function to call when a HTTP request (an event) is received. As requests come in, they are added to a queue which is processed in a FIFO (first-in, first-out) manner.</p><p><a href=#R-image-af23ef4a6af4b5f3a2d7be414c84f690 class=lightbox-link><img alt="JavaScript Event Loop" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/4.2.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-af23ef4a6af4b5f3a2d7be414c84f690><img alt="JavaScript Event Loop" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/4.2.1.png></a></p><p>In addition to events, Node implements many asynchronous functions for potentially blocking operations. For example, consider file I/O. If you write a program that needs to read a file, but when it attempts to do so the file is already open in another program, your program must wait for it to become available. In the meantime, your program is <em>blocked</em>, and its execution pauses. A real-world analogue would be a checkout line at a store. If the cashier is ringing up a customer and finds an item without a price tag, they may leave their station to go find the item on the shelves. While they are away, the line is <em>blocked</em>, everyone in line must wait for the cashier to return.</p><p>There are two basic strategies to deal with potentially blocking operations - <strong>multi-threading</strong> and <strong>asynchronous processing</strong>. A multi-threading strategy involves parallelizing the task; in our store example, we&rsquo;d have additional cash registers, cashiers, and lines. Even if one line is blocked, the others continue to ring up customers. In contrast, asynchronous processing moves the potentially blocking task into another process, and continues with the task at hand. When the asynchronous process finishes, it queues its results for the main process to resume. In our store example, this would be the cashier sending another employee to find the price, suspending the sale on the register, and continuing to check out other customers while the first customer waits. When the other employee returns with a price, the cashier finishes checking out the current customer, then resumes the first customer&rsquo;s transactions.</p><p>Node uses this asynchronous model to handle most potentially blocking operations (and often provides a synchronous approach as well). When possible, the asynchronous process is handled by the operating system, but the Node runtime also maintains a pool of threads to farm tasks out to.</p><p>The Node event loop is divided into a series of phases - each queues the associated kinds of events and processes them in a round-robin fashion. This helps ensure that one kind of event can&rsquo;t overwhelm the system:</p><p><a href=#R-image-6a13a800eb3b2883a4e0e595c13345d2 class=lightbox-link><img alt="JavaScript " class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/4.2.2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6a13a800eb3b2883a4e0e595c13345d2><img alt="JavaScript " class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/4.2.2.png></a></p><p>For a more detailed breakdown of the Node event loop, check out <a href=https://medium.com/the-node-js-collection/what-you-should-know-to-really-understand-the-node-js-event-loop-and-its-metrics-c4907b19da4c rel=external target=_blank>this blog post</a> by Daniel Khan or the <a href=https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/ rel=external target=_blank>Node Event Loop Documentation</a>.</p><h2 id=console>Console</h2><p>To produce output on the terminal, Node provides a global instance of a <a href=https://nodejs.org/api/console.html rel=external target=_blank>Console</a> called <code>console</code> that is accessible throughout the code. The typical way to produce text output on the terminal in Node is using the <code>console.log()</code> method.</p><p>Node actually defines multiple log functions corresponding to different <em>log levels</em>, indicating the importance of the message. These are (in order of severity, least to most):</p><ol><li><code>console.debug()</code></li><li><code>console.info()</code></li><li><code>console.warn()</code></li><li><code>console.error()</code></li></ol><p>These are all aliases for <code>console.log()</code> (<code>console.debug()</code> and <code>console.info()</code>) or <code>console.error()</code> (<code>console.warn()</code> and <code>console.error()</code>). They don&rsquo;t really do anything different, which might lead you to wonder why they exist&mldr;</p><p>But remember, JavaScript is a <em>dynamic</em> language, so we can re-define the <code>console</code> object with our own custom implementation that <em>does</em> do something unique with these various versions. But because they exist, they can <em>also</em> be used with the built-in console. This way our code can be compatible with both approaches!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=asynchronous-functions>Asynchronous Functions</h1><p>The benefit of the asynchronous approach is that all user-written code runs in a single-threaded environment while avoiding blocking. This means for the most part, we can write code the way we are used to, with a few tweaks for asynchronous functions.</p><p>Consider the two approaches for reading and printing the contents of a file, below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Synchronous approach
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;file.txt&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Asynchronous approach
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s1>&#39;file.txt&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>data</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>In the synchronous function, the contents of the file are <em>returned</em>, and assigned to the variable <code>data</code>. Conversely, in the asynchronous approach the file contents are passed into a <em>callback</em> function that is invoked when the asynchronous process finishes (and when the callback phase of the Node event loop is reached). The function itself returns nothing (<code>undefined</code> in Node). The important difference between the two is in the first approach, the program waits for the file to be read. In the second, the program keeps executing lines of code after the asynchronous call, even though the file hasn&rsquo;t been read yet.</p><h2 id=asynchronous-callback-structure>Asynchronous Callback Structure</h2><p>In most Node libraries, the callback function provided to the asynchronous function follows the same format - the first parameter is an error value, which will be populated with text or object if an error occurred, and otherwise will be a <strong>falsy</strong> value (a value that evaluates to false, like <code>false</code>, <code>null</code>, <code>undefined</code>, or <code>0</code>). Successive arguments are the data the function was intended to retrieve - i.e. the contents of the file in the above example. Of course, if an error <em>was</em> encountered, the later values may be wrong. Thus, most programmers follow the pattern of checking for an error at the start of the callback, and halting execution if one is encountered. Rewriting the example above, we would see:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s2>&#34;file.txt&#34;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>data</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>If <code>err</code> is a <strong>truthy</strong> value (any non-falsy value, in this case an Exception object or a string), we log the error to the console and return, halting execution of the rest of the function.</p><h2 id=common-asynchronous-misconceptions>Common Asynchronous Misconceptions</h2><p>It is very important to understand that the callback is <em>executed at a future point in time</em>, and execution continues to further lines of code. Consider this example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>contents</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s2>&#34;example.txt&#34;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>contents</span> <span class=o>=</span> <span class=nx>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>contents</span><span class=p>);</span></span></span></code></pre></div><p>Assuming the file <em>example.txt</em> contains only the line <code>"hello world"</code>, what do you think is printed?</p><p>You might think that it would be <code>"hello world"</code>, but the <code>console.log(data)</code> happens <em>before</em> the callback function is executed, so it will be <code>undefined</code>. If you wanted to print the file contents, you would have to instead do something like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>contents</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s2>&#34;example.txt&#34;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>contents</span> <span class=o>=</span> <span class=nx>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>contents</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Because the logging now happens <em>inside</em> the callback value, it will only occur <em>after</em> the file has been read, and the results added to the event queue, which is where the <code>contents</code> variable is initialized.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p><a href=https://textbooks.cs.ksu.edu/cis526/03-asynchronous-js/07-promises/ rel=external target=_blank>Promises</a> and the <a href=https://textbooks.cs.ksu.edu/cis526/03-asynchronous-js/08-async-await/ rel=external target=_blank>async/await</a> keywords covered in the previous chapter are both attempts to sidestep these misconceptions by introducing new objects and syntax that provide more familiar abstractions to programmers.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=modules>Modules</h1><p>One major feature Node introduced to JavaScript was the ability to encapsulate code into separate files using <em>modules</em>. The approach adopted by Node is the <strong>CommonJS</strong> module pattern.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>Node&rsquo;s use of modules predates ECMA6&rsquo;s adoption of modules, and the CommonJS approach Node adopted is fundamentally different than the ECMA6 version. For Node 16 (installed on your Codio Box), ECMA6 modules are an optional feature that has to be enabled with a flag when invoking the node command, i.e.:</p><div class=highlight><pre tabindex=0><code>$ node --input-type=module &lt;file&gt;</code></pre></div><p>We can also enable ECMA6 module support by using the <code>.mjs</code> file extension, or by setting an option in the <code>package.json</code> file present in our project. See the <a href=https://nodejs.org/dist./v16.15.0/docs/api/esm.html#modules-ecmascript-modules rel=external target=_blank>NodeJS Documentation</a> for more information.</p></div></div><h2 id=writing-a-module>Writing a Module</h2><p>A module is simply a JavaScript file (typically saved with a <em>js</em> extension). Code within the module is locally scoped to the module; code intended to be accessed outside of the module must be explicitly <em>exported</em> by assigning it to the <code>module.exports</code> parameter. This example exports a function to print &ldquo;Hello World&rdquo;:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/* hello.js */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>helloWorld</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Hello World&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>helloWorld</span><span class=p>;</span></span></span></code></pre></div><p>You can export a value, function, or object from a module. If you don&rsquo;t specify an export, a module exports <code>undefined</code>.</p><h2 id=loading-a-module>Loading a Module</h2><p>CommonJS Modules are loaded using the <code>require()</code> function, which loads the JavaScript in the module and returns any exports from the module. Objects, functions, or even values can be exported, i.e. this example loads our earlier module, assigns the result to the variable greet, and invokes it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>greet</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;./hello&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>greet</span><span class=p>();</span></span></span></code></pre></div><p>This example will print &ldquo;Hello World&rdquo; to the console.</p><p>There are three kinds of modules you can load in Node: 1) core libraries, 2) npm packages, and 3) user-authored modules.</p><p>Core libraries are part of Node. Examples are the <em>fs</em> (file system) library, the <em>http</em> library, and the <em>crypto</em> library. A full list of libraries can be found in the <a href=https://nodejs.org/api/ rel=external target=_blank>Node documentation</a>. Node libraries are required using their name as as the argument, i.e. <code>require('fs')</code> will require the filesystem library.</p><p>Npm packages are typically open-source libraries created by the community and are downloaded using the Node Package Manager (npm). These are installed either globally, or within a <em>node_modules</em> folder created by npm within your project. Npm modules are required by their package name, i.e. <code>require('webpack')</code> will load the webpack package.</p><p>User-written modules are loaded from the filesystem, and are typically located in your project directory or subdirectories within it. They are required using the filepath to their file, i.e. <code>require('./hello.js</code>). It is important to use the period-slash (<code>./</code>) indicating current directory to distinguish files from npm packages.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=packages>Packages</h1><p>The Node Package Manager allows you to create a <em>package</em> representing your project. This is similar to Visual Studio&rsquo;s idea of a <em>project</em> - a package is a complete Node program.</p><p>Just as Visual Studio adds solution and project files, a Node package adds a file named <em>package.json</em> and a directory named <em>node_modules</em>.</p><h2 id=the-package-file>The Package File</h2><p>Every node package has in its top-level directory a file named <em>package.json</em>. This JSON file provides important information about the project, including:</p><ul><li>The name of the project</li><li>The version of the project</li><li>The author of the project</li><li>The entry point (the file that should be processed first, much like a C# <em>Program.cs</em> file or C++ <em>main.cpp</em> file). Owing to its roots as a language for developing webservers, the default is <em>index.js</em>, though it can be anything you want (many projects use <em>server.js</em> or <em>main.js</em>).</li><li>Any scripts associated with the project (often we&rsquo;ll have scripts to run and test the project)</li><li>Any dependencies of the project (these are additional packages that are copied into the <em>node_modules</em> file)</li><li>The home repository of the project (often a GitHub repository, though other options are possible)</li><li>The license under which this package is released</li></ul><p>Most of the properties of the <em>package.json</em> are optional, and there are options I have listed above are not comprehensive. The <em>package.json</em> object format is described in great detail in the <a href=https://docs.npmjs.com/files/package.json rel=external target=_blank>npm documentation</a>.</p><h2 id=semantic-versioning>Semantic Versioning</h2><p>Node packages use <a href=https://semver.org/ rel=external target=_blank>semantic versioning</a>, a numbering scheme that uses three numbers separated by periods in the pattern <code>MAJOR.MINOR.PATCH</code>. For example, your Codio Box is likely running <strong>Ubuntu 18.04.3</strong> - that is Ubuntu, major release 18, minor release 4, patch 3. If its developers found a bug or security vulnerability and fixed it, they would release a new patch version, i.e. <strong>Ubuntu 18.04.4</strong>. If they made some improvements that don&rsquo;t change the way you work with the operating system, those might be a minor release, i.e. <strong>Ubuntu 18.05.0</strong> (note that the patch release number starts over at 0). And if a major change in the way the software works was made, that would be a major release, i.e. <strong>Ubuntu 19.0.0</strong>. Additionally, you probably have seen the program listed as <strong>Ubuntu 18.04.4 LTS</strong>. The LTS is not part of semantic versioning, but indicates this is a <em>long term support</em> release, i.e. one the developers have committed to fixing problems with for a specific duration of time.</p><p>When releasing your own Node packages, you should strive to practice using semantic versioning. That way you get into the habit, and it will be easier when you become a professional developer. Another good practice is to have a <em>changelog</em> - a text or markdown file that lists the changes made in each successive version of the program, usually as a bulleted list.</p><h2 id=initializing-the-package>Initializing the Package</h2><p>You can manually create the <em>package.json</em> file, but npm also provides a wizard to make this process easier. From the terminal, while at the root directory of your project, enter the command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm init</span></span></code></pre></div><p>This will launch the wizard, asking you a series of questions used to create the project. It will also offer default options for many of the values; you can simply press the space bar to accept these. Moreover, if your directory contains an already-initialized git repository, it will use that repository&rsquo;s origin as the basis for the repository option. The wizard will create the <em>package.json</em> file in the project&rsquo;s root directory.</p><p>Next we&rsquo;ll look at some aspects of the package in more detail.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=dependencies>Dependencies</h1><p>A second great benefit of creating your project as a Node package is that dependencies can be managed using the Node Package Manager (npm). You can install any Node package with the command <code>$npm install [package name]</code>. This command looks for the corresponding package in an online repository, and if it is found, downloads it and saves it to the subdirectory <em>node_modules</em> in your package directory.</p><p>It also creates an entry in the <em>package.json</em> file corresponding to the package you installed, and also an entry in the <em>package.lock.json</em> file. The entry in your <em>package.json</em> file may specify a specific version, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-package&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;foo&#34;</span><span class=p>:</span> <span class=s2>&#34;2.1.3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;bar&#34;</span><span class=p>:</span> <span class=s2>&#34;^1.1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;doh&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.3.2&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>The <code>^</code> before the <code>"bar"</code> dependency indicates that npm can use any <em>minor release</em> after this version, i.e. we could use <strong>bar 1.2.1</strong> but not bar <strong>2.1.1</strong>. The <code>~</code> before the <code>"doh"</code> dependency indicates that npm can use any <em>patch release</em> after this version, i.e. <strong>doh 4.3.4</strong> but not <strong>doh 4.4.0</strong>. Because we specified the <em>exact</em> version for <code>"foo"</code>, it will always install <strong>foo 2.1.3</strong>. We could also indicate we will accept <em>any</em> major version with an <code>*</code>, but this is rarely used. Additionally, we can specify a git repo or a location on our hard drive, though these approaches are also not commonly used.</p><p>The reason we want the dependency information specified this way is that when we commit our package to source control, we typically <em>exclude</em> the dependencies found in <strong>node_modules</strong>. As this folder can get quite large, this saves us significant space in our repository. When you clone your package to a new location, you can re-install the dependencies with the command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install </span></span></code></pre></div><p>This will pull the latest version of each dependency package allowable. Additionally, some modules may have their own dependencies, in which case npm will strive to find a version that works for all requirements.</p><p>Finally, the <em>package.lock.json</em> contains the <em>exact</em> version of the dependencies installed. It <em>is</em> intended to be committed to your repository, and if it exists it will make the <code>npm install</code> command install the exact same packages. This can help avoid problems where two versions of a package are slightly different.</p><h2 id=development-dependency>Development Dependency</h2><p>In addition to regular dependencies, we can specify dependencies we only need during development. Adding the <code>--save-dev</code> flag to the command will add the package to a <em>development</em> dependency list in your <em>package.json</em> file. Development dependencies are only installed in the development environment; they are left out in a production environment.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><h2 id=the-npm-registry>The NPM Registry</h2><p>There are many ways to connect with dependencies, but one of the easiest and most popular is to use the <a href=https://www.npmjs.com/ rel=external target=_blank>NPM Registry</a>, a searchable, online directory of npm packages maintained by npm, Inc. You can search for keywords and (hopefully) find a project that fits your needs.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=git>Git</h1><p>Most Node packages are made available as <a href=https://git-scm.com rel=external target=_blank>git</a> repositories, and npm has built-in support for using git.</p><h2 id=the-repository-property>The Repository Property</h2><p>In your <em>package.json</em> file, you can specify a <code>"repository"</code> property, which specifies where the repository for this project exists. Consider the following example of the npm command-line interface package:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=s2>&#34;repository&#34;</span><span class=err>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span> <span class=p>:</span> <span class=s2>&#34;git&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;url&#34;</span> <span class=p>:</span> <span class=s2>&#34;https://github.com/npm/cli.git&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>For many open-source projects, the repository is located on Github, a GitHub gist, BitBucket, or a GitLab instance. These can be specified with a shorthand, which matches the corresponding <code>npm install</code> argument:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=s2>&#34;repository&#34;</span><span class=err>:</span> <span class=s2>&#34;npm/npm&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;repository&#34;</span><span class=err>:</span> <span class=s2>&#34;github:user/repo&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;repository&#34;</span><span class=err>:</span> <span class=s2>&#34;gist:11081aaa281&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;repository&#34;</span><span class=err>:</span> <span class=s2>&#34;bitbucket:user/repo&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;repository&#34;</span><span class=err>:</span> <span class=s2>&#34;gitlab:user/repo&#34;</span></span></span></code></pre></div><p>If your project folder already is set up as a git repo <em>before</em> you run <code>$npm init</code>, then the wizard will suggest using the existing repository.</p><h2 id=the-gitignore-file>The .gitignore File</h2><p>Like any git repo, there are some files you will want to exclude from version control. The most important of these is the <em>node_modules</em> folder, which we exclude for two reasons:</p><ol><li>The folder&rsquo;s contents are large, and are available from the original sources specified in your package&rsquo;s dependencies - therefore they represent significant and unnecessary glut in a repository.</li><li>Some portions of your dependencies may be compiled from C code as they are installed. Since C code is compiled into binaries for a specific target machine&rsquo;s architecture, you will encounter errors if your development and production machines are different. Re-installing packages in the production machine with <code>$npm install</code> avoids this.</li></ol><p>Therefore, you should include <em>at least</em> this line in your <em>.gitignore</em> file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>node_modules/</span></span></code></pre></div><p>It&rsquo;s also a good idea to leave out any logging files:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>logs
</span></span><span class=line><span class=cl>*.log</span></span></code></pre></div><p>You may also want to look at GitHub&rsquo;s boilerplate <a href=https://github.com/github/gitignore/blob/master/Node.gitignore rel=external target=_blank>Node .gitignore template</a>, which adds additional rules based on many popular Node frameworks (adding an ignore for a file or directory that doesn&rsquo;t exist in your project is harmless).</p><p>The <em>.gitignore</em> file should ideally be added before the repository has been created, as files already under version control override <em>.gitignore</em> rules.</p><h2 id=initializing-the-repository>Initializing the Repository</h2><p>Now we can initialize our repository with the <code>$git init</code> command in the terminal:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ git init </span></span></code></pre></div><p>Note how a <em>.git</em> directory is added to our project? This is where git stores the <strong>diff</strong> information that allows it to track versions of our code.</p><p>The <code>init</code> command adds the current directory structure (less that specified in the <em>.gitignore</em> file) to the staging list. Otherwise, we&rsquo;d need to stage these files ourselves for version tracking with the git command, <code>add .</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$git add .</span></span></code></pre></div><p>Once staged, we can commit the initial version of our package with a git <code>commit</code> command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ git commit -a -m &#34;Initial commit&#34;</span></span></code></pre></div><p>The <code>-a</code> flag indicates we are committing <em>all currently staged files</em>, alternatively you can commit files one-at-a-time, if you only want to commit one or a few files. The <code>-m</code> file indicates we are also adding a commit message, which follows in quotes (""). If we don&rsquo;t use this flag, then git will open a text editor to write the commit message in. For the Linux platform, the default is <em>vi</em>, a powerful command line text editor that has a bit of a learning curve. If you find vi has launched on you and you are uncertain how to proceed, follow these steps:</p><ol><li>Type your commit message</li><li>Hit the [ESC] key - this moves you from <em>edit</em> mode to <em>command mode</em></li><li>Type the command <code>:wq</code>. Vi commands always start with a colon (:), and can be grouped. The <code>w</code> indicates the file should be written (saved), and the <code>q</code> indicates we want to quit the editor.</li></ol><h2 id=adding-remote-repositories>Adding Remote Repositories</h2><p>If you want to host your repository on GitHub or another hosting tool (such as BitBucket or GitLab), you will need to add that repository&rsquo;s url as a <em>remote origin</em> for your local repository. You can do so with the command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ git remote add origin [repo url]</span></span></code></pre></div><p>Where <code>[repo url]</code> is the url of the remote repo. If you want to use GitHub, create an empty repository, and copy the created repository&rsquo;s link.</p><p>If you clone a repository from GitHub or another tool, the remote origin is automatically set to that parent repository. If you ever need to change the remote origin, it&rsquo;s a two-step process:</p><ol><li>Delete the current origin with the git command:<code>$git remote rm origin</code></li><li>Add your new origin with the git command: <code>$git remote add origin</code></li></ol><p>You can also add other targets than <em>origin</em> (origin is a generic target meaning the originating repository). To see all remote repositories, use the command <code>$git remote -v</code>, which lists all registered remote repositories (the <code>-v</code> flag is for <em>verbose</em>).</p><h2 id=pushing-and-pulling>Pushing and Pulling</h2><p>The <code>$git push</code> and <code>$git pull</code> commands are shorthand for pushing and pulling the master branch to and from the origin repository. The full commands can be used to push an alternate branch or to reach an alternate remote repository: <code>$git push [remote repo name] [branch name]</code>, <code>$git pull [remote repo name] [branch name]</code></p><h2 id=git-and-codio>Git and Codio</h2><p>Pushing your code to a remote repository is a good way to move it between Codio boxes. You can clone such a repository after you create it with the command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ git clone [git clone url]</span></span></code></pre></div><p>Where the <code>[git clone url]</code> is the URL of your remote repository. Cloning a repository automatically sets its remote origin repo to the repository it was cloned from.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><p>Node, and its package manager, npm, are powerful tools for developing server-side applications in JavaScript. In the past chapter, we&rsquo;ve discussed the event loop that drives Node&rsquo;s asynchronous, event-driven approach, and the asynchronous function pattern employed by many node libraries. We&rsquo;ve also talked about how Node.js code can be organized into modules, how those modules can be imported with a <code>require()</code> call, and how the node package manager (npm) can be used to download and install open-source packages locally. Finally, we&rsquo;ve discussed how to create our own local packages from our projects.</p><h2 id=resources>Resources</h2><p>Node can be downloaded from <a href=https://nodejs.org rel=external target=_blank>nodejs.org</a> or installed using <a href=https://github.com/nvm-sh/nvm rel=external target=_blank>Node Version Manager (nvm)</a>.</p><p>The latest Node documentation can be found at <a href=https://nodejs.org/en/docs/ rel=external target=_blank>https://nodejs.org/en/docs/</a></p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 5</div><h1 id=basic-web-servers>Basic Web Servers</h1><p>Serving Content via the World-Wide-Web</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Basic Web Servers</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>The first web servers were developed to fulfill a simple role - they responded to requests for HTML documents that were (hopefully) located in their physical storage by streaming the contents of those documents to the client.</p><p><a href=#R-image-676085975540599512f6255ee51ae588 class=lightbox-link><img alt="Request-Response Pattern" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/5.0.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-676085975540599512f6255ee51ae588><img alt="Request-Response Pattern" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/5.0.1.png></a></p><p>This is embodied in our request-response pattern. The client requests a resource (such as a HTML document), and receives either a status 200 response (containing the document), or an error status code explaining why it couldn&rsquo;t be retrieved.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=http-in-node>HTTP in Node</h1><p>Node was written primarily to provide tools to develop web servers. So it should come as no surprise that it supports HTTP through a built-in library, the <a href=https://nodejs.org/api/http.html rel=external target=_blank>http module</a>. This module provides support for creating <em>both</em> web servers and web clients, as well as working with http requests and responses. Let&rsquo;s start by examining the latter.</p><h2 id=node-http-request>Node HTTP Request</h2><p>Remember that a HTTP request is nothing more than a stream of text formatted according to the HTTP standards, as we discussed in <a href=https://textbooks.cs.ksu.edu/cis526/02-http/03-request-format/ rel=external target=_blank>Chapter 2</a>. Node makes this information easier to work with in your server code by parsing it into an object, an instance of <a href=https://nodejs.org/api/http.html#http_class_http_incomingmessage rel=external target=_blank>http.IncomingMessage</a>. Its properties expose the data of the request, and include:</p><ul><li><a href=https://nodejs.org/api/http.html#http_message_headers rel=external target=_blank>message.headers</a> - the request headers as a JavaScript object, with the keys corresponding to the HTTP header key, and the values corresponding to the HTTP header values.</li><li><a href=https://nodejs.org/api/http.html#http_message_method rel=external target=_blank>message.method</a> - request method, i.e. <code>'GET'</code>, <code>'POST'</code>, <code>'PUT'</code>, <code>'PATCH'</code>, or <code>'DELETE'</code></li><li><a href=https://nodejs.org/api/http.html#http_message_url rel=external target=_blank>message.url</a> - the URL string provided through the request. Note that this URL does not contain the protocol and host information (those were set during the connection opening process)</li></ul><p>You typically won&rsquo;t create an <code>http.IncomingMessage</code>, rather it will be provided to you by an instance of <code>http.Server</code>, which we&rsquo;ll talk about shortly.</p><h2 id=node-http-response>Node HTTP Response</h2><p>The HTTP response is also nothing more than a stream of text formatted according to the HTTP standards, as laid out in <a href=https://textbooks.cs.ksu.edu/cis526/02-http/08-response-format/ rel=external target=_blank>Chapter 2</a>. Node also wraps the response with an object, an instance of <a href=https://nodejs.org/api/http.html#http_class_http_serverresponse rel=external target=_blank>http.ServerResponse</a>. However, this object is used to <em>build</em> the response (which is the primary job of a web server). This process proceeds in several steps:</p><ol><li>Setting the status code & message</li><li>Setting the headers</li><li>Setting the body</li><li>Setting the trailers</li><li>Sending the response</li></ol><p>Not all of these steps are required for all responses, with the exception of the sending of the response. We&rsquo;ll discuss the process of generating a response in more detail later. As with the <code>http.IncomingMessage</code>, you won&rsquo;t directly create <code>http.ServerResponse</code> objects, instead they will be created by an instance of <code>http.Server</code>, which we&rsquo;ll look at next.</p><h2 id=node-http-server>Node HTTP Server</h2><p>The <a href=https://nodejs.org/api/http.html#http_class_http_server rel=external target=_blank>http.Server</a> class embodies the basic operating core of a webserver, which you can build upon to create your own web server implementations. Instances of <code>http.Server</code> are created with the factory method <a href=https://nodejs.org/api/http.html#http_http_createserver_options_requestlistener rel=external target=_blank>http.createServer()</a>. This method takes two parameters, the first is an optional JavaScript object with options for the server, and the second (or first, if the <code>options</code> parameter is omitted) is a callback function to invoke every time the server receives a request. As you might expect, the method returns the created <code>http.Server</code> instance.</p><p>The callback function always takes two parameters. The first is an instance of <code>http.IncomingMessage</code> (often assigned to a variable named <code>req</code>) that represents the request the server has received, and the second is an instance of <code>http.ServerResponse</code> (often assigned to available named <code>res</code>) that represents the response the server will send back to the client, once you have set all its properties. This callback is often called the <em>request handler</em>, for it decides what to do with incoming requests. Each incoming request is handled <em>asynchronously</em>, much like any event.</p><p>Once the server has been created, it needs to be told to listen for incoming requests. It will do so on a specific <a href=https://en.wikipedia.org/wiki/Port_(computer_networking) rel=external target=_blank>port</a>. This port is represented by a number between 0 and 65535. You can think of your computer as an apartment complex, and each port number corresponding to an apartment number where a specific program &ldquo;lives&rdquo;. Thus, to send a message to that particular program, you would address your letter to the apartment address using the apartment number. In this analogy, the apartment address is the <em>host address</em>, i.e. the IP address of your computer, and the specific apartment is the <em>port</em>. Certain port numbers are commonly used by specific applications or families of applications, i.e. web servers typically use port 80 for HTTP and port 443 for HTTPS connections. However, when you are developing a webserver, you&rsquo;ll typically use a non-standard port, often an address 3000 and up.</p><p>Thus, to start your webserver running on port 3000, you would invoke [server.Listen()] with that port as the first argument. An optional second argument is a callback function invoked once the server is up and running - it is usually used to log a message saying the server is running.</p><h3 id=an-example-server>An Example Server</h3><p>A quick example of a server that only responds with the message &ldquo;Hello web!&rdquo; would be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>http</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>((</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>req</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=s2>&#34;Hello web!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Server listening at port 3000&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Once the server is running, you can visit <a href=http://localhost:3000 rel=external target=_blank>http://localhost:3000</a> on the same computer to see the phrase &ldquo;Hello web!&rdquo; printed in your browser.</p><p>The <code>localhost</code> hostname is a special <em>loopback</em> host, which indicates instead of looking for a computer on the web, you&rsquo;re wanting to access the computer you&rsquo;re currently on. The <code>:3000</code> specifies the browser should make the request to the non-standard port of <code>3000</code>. If we instead used port <code>80</code>, we could omit the port in the URL, as by default the browser will use port <code>80</code> for http requests.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=request-handling>Request Handling</h1><p>An important aspect to recognize about how Node&rsquo;s http library operates is that <em>all</em> requests to the server are passed to the request handler function. Thus, you need to determine what to do with the incoming request as part of that function.</p><h2 id=working-with-the-request-object>Working with the Request Object</h2><p>You will most likely use the information contained within the <code>http.IncomingMessage</code> object supplied as the first parameter to your request handler. We often use the name <code>req</code> for this parameter, short for <em>request</em>, as it represents the incoming HTTP request.</p><p>Some of its properties we might use:</p><ul><li><p>The <code>req.method</code> parameter indicates what <a href=https://textbooks.cs.ksu.edu/cis526/02-http/04-request-methods/ rel=external target=_blank>HTTP method</a> the request is using. For example, if the method is <code>"GET"</code>, we would expect that the client is requesting a resource like an HTML page or image file. If it were a <code>"POST"</code> request, we would think they are submitting something.</p></li><li><p>The <code>req.url</code> parameter indicates the specific resource path the client is requesting, i.e. <code>"/about.html"</code> suggests they are looking for the &ldquo;about&rdquo; page. The url can have more parts than just the path. It also can contain a query string and a hash string. We&rsquo;ll talk more about these soon.</p></li><li><p>The <code>req.headers</code> parameter contains all the headers that were set on this particular request. Of specific interest are <em>authentication</em> headers (which help say who is behind the request and determine if the server should allow the request), and <em>cookie</em> headers. We&rsquo;ll talk more about this a bit further into the course, when we introduce the associated concepts.</p></li></ul><p>Generally, we use properties in combination to determine what the correct response is. As a programmer, you probably already realize that this decision-making process must involve some sort of <a href=https://en.wikipedia.org/wiki/Control_flow rel=external target=_blank>control flow</a> structure, like an <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/if...else rel=external target=_blank>if statement</a> or <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/switch rel=external target=_blank>switch case statement</a>.</p><p>Let&rsquo;s say we only want to handle <code>"GET"</code> requests for the files <em>index.html</em>, <em>site.css</em>, and <em>site.js</em>. We could write our request handler using both an <code>if else</code> statement and a <code>switch</code> statement:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>handleRequest</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>method</span> <span class=o>===</span> <span class=s2>&#34;GET&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;/index.html&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// TODO: Serve the index page 
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;/site.css&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// TODO: Serve the css file 
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;/site.js&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// TODO: Serve the js file
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// TODO: Serve a 404 Not Found response
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// TODO: Serve a 501 Not Implemented response
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Notice that at each branching point of our control flow, we serve some kind of response to the requesting web client. <em>Every</em> request should be sent a response - even unsuccessful ones. If we do not, then the browser will <em>timeout</em>, and report a timeout error to the user.</p><p><a href=#R-image-a6991aef177c90f42c98a092b115cd83 class=lightbox-link><img alt="handleRequest() flowchart" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/5.3.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a6991aef177c90f42c98a092b115cd83><img alt="handleRequest() flowchart" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/5.3.1.png></a></p><h2 id=working-with-the-response-object>Working with the Response Object</h2><p>The second half of responding to requests is putting together the response. You will use the <code>http.ServerResponse</code> object to assemble and send the response. This response consists of a <a href=https://textbooks.cs.ksu.edu/cis526/02-http/09-status-codes/ rel=external target=_blank>status code and message</a>, <a href=https://textbooks.cs.ksu.edu/cis526/02-http/10-response-headers/ rel=external target=_blank>response headers</a>, and a <a href=https://textbooks.cs.ksu.edu/cis526/02-http/11-response-body/ rel=external target=_blank>body</a> which could be text, binary data, or nothing.</p><p>There are a number of properties and methods defined in the <code>http.ServerResponse</code> to help with this, including:</p><ul><li><a href=https://nodejs.org/api/http.html#http_response_statuscode rel=external target=_blank>ServerResponse.statusCode</a> can be used to manually set the status code</li><li><a href=https://nodejs.org/api/http.html#http_response_statusmessage rel=external target=_blank>ServerResponse.statusMessage</a> can be used to manually set the status message. If the code is set but not the message, the default message for the code is used.</li><li><a href=https://nodejs.org/api/http.html#http_response_setheader_name_value rel=external target=_blank>ServerResponse.setHeader()</a> adds a header with the supplied name and value (the first and second parameters)</li><li><a href=https://nodejs.org/api/http.html#http_response_end_data_encoding_callback rel=external target=_blank>ServerResponse.end()</a> sends the request using the currently set status and headers. Takes an optional parameter which is the response body; if this parameter is supplied, an optional second parameter specifying the encoding can also be used. A final optional callback can be supplied that is called when sending the stream is complete.</li></ul><p>Consider the <strong>501 Not Implemented</strong> response in our example above. We need to send the 501 status code, but there is no need for a body or additional headers. We could use the <code>req.statusCode</code> property to set the property, and the <code>req.end()</code> method to send it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>    <span class=c1>// TODO: Serve a 501 Not Implemented response
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span> <span class=o>=</span> <span class=mi>501</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span></span></span></code></pre></div><p>The sending of a response with a body is a bit more involved. For example, to send the <em>index.html</em> file, we would need to retrieve it from the hard drive and send it as the body of a request. But as the default status code is 200, we don&rsquo;t need to specify it. However, it is a good idea to specify the <code>Content-Type</code> header with the appropriate mime-type, and then we can use the <code>res.end()</code> method with the file body once we&rsquo;ve loaded it, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>    <span class=c1>// TODO: Serve the index page 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s1>&#39;index.html&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>body</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>status</span> <span class=o>=</span> <span class=mi>500</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>setHeader</span><span class=p>(</span><span class=s2>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s2>&#34;text/html&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>setHeader</span><span class=p>(</span><span class=s2>&#34;Content-Length&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=nx>body</span><span class=p>,</span> <span class=s2>&#34;utf8&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span></span></span></code></pre></div><p>Notice too, that we need to account for the possibility of an error while loading the file <em>index.html</em>. If this happens, we send a <strong>500 Server Error</strong> status code indicating that something went wrong, and it happened on <em>our</em> end, not because of a problem in the way the client formatted the request. Notice too that we use a <code>return</code> to prevent executing the rest of our code.</p><p>We also supply the length of the response body, which will be the same as the buffer length or the length of a string sent as the body. Binary data for the web is counted in octets (eight bits) which conveniently is also how Node buffers are sized and the size of a JavaScript character.</p><h2 id=chaining-writehead-and-end>Chaining writeHead() and end()</h2><p>The <code>http.ServerResponse</code> object also has a method <code>writeHead()</code> which combines the writing of status code, message, and headers into a single step, and returns the modified object so its <code>end()</code> method can be chained. In this way, you can write the entire sending of a response on a single line. The parameters to <code>response.writeHead()</code> are the status code, an optional status message, and an optional JavaScript object representing the headers, using the keys as the header names and values as values.</p><p>Serving the css file using this approach would look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>    <span class=c1>// TODO: Serve the site css file 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s1>&#39;site.css&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>body</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span> <span class=s2>&#34;text/html&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Content-Length&#34;</span><span class=o>:</span> <span class=nx>body</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>        <span class=p>}).</span><span class=nx>end</span><span class=p>(</span><span class=nx>body</span><span class=p>,</span> <span class=s2>&#34;utf8&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span></span></span></code></pre></div><p>You can use any combination of these approaches to send responses.<div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>Some important considerations:</p><ul><li>Be aware that you can only send <em>one</em> response per request. Once a response is sent, the connection to the client is effectively closed. Thus, once <code>response.end()</code> has been invoked, it will log an error if it is attempted again.</li><li>The <code>response.writeHead()</code> method actually streams the head to the client. Thus, you cannot run <code>response.setHeader()</code> or set <code>response.statusCode</code> or <code>response.statusMessage</code> after it has been set.</li><li>Similarly, any change to the response object after <code>response.end()</code> has been invoked will log an error, as you cannot change the response once it&rsquo;s sent.</li></ul></div></div></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=the-importance-of-being-async>The Importance of Being Async</h1><p>You may have noticed that we used the asynchronous version of <code>fs.readFile()</code> in our response handler. This is critical to good performance with a Node-based webserver - any potentially blocking action taken in the request handler should be asynchronous, because <em>all incoming requests</em> must be processed on the same thread. If our event loop gets bogged down handling a blocked process, then <em>nobody gets a response</em>!</p><p>Consider if we implemented one of the file serving options using the synchronous <code>fs.readFileSync()</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>    <span class=c1>// TODO: Serve the site js file 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>var</span> <span class=nx>body</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;site.js&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span> <span class=s2>&#34;application/javascript&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Content-Length&#34;</span><span class=o>:</span> <span class=nx>body</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>      <span class=p>}).</span><span class=nx>end</span><span class=p>(</span><span class=nx>body</span><span class=p>,</span> <span class=s2>&#34;utf8&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span></span></span></code></pre></div><p>It does not look that different from the asynchronous version, but consider what happens if <em>site.js</em> cannot be opened immediately (perhaps it is locked by a system process that is modifying it). With the synchronous version, we wait for the file to become available. While we wait, incoming requests are added to our event queue&mldr; and none are processed, as the event loop is paused while we are waiting for <code>fs.readFileSync('site.js')</code> to resolve. If it takes more than three seconds, the clients that are waiting will start seeing timeouts in their browsers, and will probably assume our site is down.</p><p><a href=#R-image-c0f237a6a7c841779150313a920aba4b class=lightbox-link><img alt="Async vs Sync operations in the Event Loop" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/5.4.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c0f237a6a7c841779150313a920aba4b><img alt="Async vs Sync operations in the Event Loop" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/5.4.1.png></a></p><p>In contrast, if we used the asynchronous version, the reading of the file is handed off to another thread when <code>fs.readFile()</code> is invoked. Any additional processing to do within the event loop for this request is finished, and the next task is pulled from the event queue. Even if our request for the original file never completes, we still are serving requests as quickly as we get them.</p><p>This asynchronous approach is key to making a Node-based website perform and scale well. But it is vitally important that you, as a web developer, <em>understand</em> both why using asynchronous processes is important, and <em>how</em> to use them correctly. Because if you don&rsquo;t, your application performance can be much, much worse than with other approaches.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=caching-for-the-win>Caching for the Win</h1><p>In our example web server, we argued that asynchronous file reading was better than synchronous because reading from a file is a potentially blocking operation that can take a long time to perform. But even when it doesn&rsquo;t block, it can still take a lot of time, making it the most <em>expensive</em> part of our request handling operation in terms of the time it takes to perform.</p><p>If we really want to squeeze all the performance we can out of our server (and therefore handle as many users as possible), we need to consider the strategy of <a href=https://en.wikipedia.org/wiki/Cache_(computing) rel=external target=_blank>caching</a>. This means storing our file content in a location where access is faster - say in <em>memory</em> rather than on the <em>disk</em>. Variables in our application are stored in RAM, even variables whose contents were initialized from disk files. Thus, assigning the contents of a file to a variable effectively caches it for faster access.</p><p>Moreover, because Node variables are only accessible from the Node process, which from our perspective in the event loop is single-threaded, we don&rsquo;t have to worry about blocking once the file has been loaded. One strategy we can employ is to pre-load our files using synchronous operations, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>http</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>html</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;index.html&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>css</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;site.css&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>js</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;site.js&#39;</span><span class=p>);</span></span></span></code></pre></div><p>Now we can define our revised event handler, which uses the cached versions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>handleRequest</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>method</span> <span class=o>===</span> <span class=s2>&#34;GET&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;/index.html&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Serve the index page 
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;text/html&#39;</span><span class=p>,</span> <span class=s1>&#39;Content-Length&#39;</span><span class=o>:</span> <span class=nx>html</span><span class=p>.</span><span class=nx>length</span><span class=p>}).</span><span class=nx>end</span><span class=p>(</span><span class=nx>html</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;/site.css&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Serve the css file 
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;text/html&#39;</span><span class=p>,</span> <span class=s1>&#39;Content-Length&#39;</span><span class=o>:</span> <span class=nx>css</span><span class=p>.</span><span class=nx>length</span><span class=p>}).</span><span class=nx>end</span><span class=p>(</span><span class=nx>css</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;/site.js&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Serve the js file
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;text/html&#39;</span><span class=p>,</span> <span class=s1>&#39;Content-Length&#39;</span><span class=o>:</span> <span class=nx>js</span><span class=p>.</span><span class=nx>length</span><span class=p>}).</span><span class=nx>end</span><span class=p>(</span><span class=nx>js</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Serve a 404 Not Found response
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>404</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Serve a 501 Not Implemented response
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>501</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Finally, we create and start the server:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>(</span><span class=nx>handleRequest</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>80</span><span class=p>,</span> <span class=p>()=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Server listening on port 80&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Notice in this server implementation we use the <em>synchronous</em> <code>fs.readFileSync()</code>, and we don&rsquo;t wrap it in a <code>try ... catch</code>. That means if there is a problem loading one of the files, our Node process will crash. But as these files are loaded <em>first</em>, before the server starts, we should see the error, and realize there is a problem with our site files that needs fixed. This is one instance where it <em>does</em> make sense to use synchronous file calls.</p><p>While caching works well in this instance, like everything in computer science it doesn&rsquo;t work well in all instances. Consider if we had a server with <em>thousands</em> of files - maybe images that were each 500 Megabytes. With only a thousand images, we&rsquo;d have 500 Gigabytes to cache&mldr; which would mean our server would need a <em>lot</em> of expensive RAM. In a case like that, asynchronous file access when the file is requested makes far more sense.</p><p>Also, depending on the use pattern it may make sense to cache <em>some</em> of the most frequently requested images. With careful design, this caching can be dynamic, changing which images are cached based on how frequently they are requested while the server is running.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=index-pages>Index Pages</h1><p>The original purpose of the World-Wide-Web was to share webpages and other digital resources across the Internet. In many ways, an early web server was like a hard drive that was open to the world. Think about the HTTP methods, <code>"GET"</code> is like a file read, <code>"POST"</code> is like a write, <code>"PUT"</code> and <code>"PATCH"</code> like a file modification, and <code>"DELETE"</code> was a file erasure.</p><p>So, just like when you browse your hard drive using Windows Explorer or other software, it was necessary for these early web pages to display an <em>index</em> - a listing of all the contents of a directory. You&rsquo;ve seen similar in Codio if you ever used the &ldquo;Project Index&rdquo; option in the run menu - it displays an index of the project directory:</p><p><a href=#R-image-b3d54f2b3d5f85c2fb0cdab7f34c61d1 class=lightbox-link><img alt="Codio Project Index Page" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/5.6.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b3d54f2b3d5f85c2fb0cdab7f34c61d1><img alt="Codio Project Index Page" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/5.6.1.png></a></p><p>This is a pretty standard auto-generated directory listing - it provides the path to the directory being displayed, and all the contents of the directory as hyperlinks. Clicking on a file will open or download it, and clicking a directory will open <em>that</em> directory&rsquo;s auto-generated directory listing.</p><p>As the use of the web expanded into commercial and public life, many web developers wanted to replace auto-generated directory listing pages with a carefully designed home page. But auto-generated directory listing pages remained an important feature for many sites that served as a more traditional file server.</p><p>The compromise adopted by most web servers was that if the directory contained an HTML file named <em>index.html</em> (or sometimes <em>index</em> with any extension, i.e. <em>index.php</em>), that page would be served in leu of an auto-generated index page. Most also allow disabling the directory listing as a configuration option.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>You might be wondering about security if a web server starts exposing directory structure and files willy-nilly. Most web servers will <em>only</em> serve files in a specific directory (often called the <em>root</em> directory) and its subdirectories. In a typical configuration, this root directory is named <em>public</em> or <em>public_html</em> to reinforce the idea that it is available to anyone browsing the web.</p><p>Files that need to have access restricted to certain people should not be placed in this directory, but be placed behind an authentication mechanism (sometimes referred to as an <em>auth wall</em> or <em>pay wall</em> for subscription-based sites). We&rsquo;ll talk about this more in our chapter on authentication.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=partial-downloads>Partial Downloads</h1><p>While we normally think of downloading an entire file from the web, there are some situations where it makes sense to download only <em>part</em> of a file. One case is with a large file download that gets interrupted - it makes a lot of sense to start downloading the remaining bytes from where you left off, rather than starting over again. A second case is when you are streaming media; often the user may not watch or listen to the entire media file, so why download the bytes they don&rsquo;t need? Or if it is a live stream, we explicitly <em>can&rsquo;t</em> download the entire thing, because later parts do not yet exist!</p><h2 id=range-headers>Range Headers</h2><p>HTTP explicitly supports requesting only a part of a resource with the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Range rel=external target=_blank>Range</a> header. This allows us to specify the unit of measure (typically bytes), a starting point, and an optional end. This header is structured:</p><div class=highlight><pre tabindex=0><code>Range: &lt;unit&gt;=&lt;range-start&gt;-&lt;range-end&gt;</code></pre></div><p>Where <code>&lt;unit></code> is the unit of measure, the <code>&lt;range-start></code> is the start of the range to send, measured in the provided unit, and <code>&lt;range-end></code> is the end of the range to send.</p><p>Thus, a real-world Range header might look like:</p><div class=highlight><pre tabindex=0><code>Range: bytes=200-300</code></pre></div><p>You can also specify only the starting point (useful for resuming downloads):</p><div class=highlight><pre tabindex=0><code>Range: &lt;unit&gt;=&lt;range-start&gt;-</code></pre></div><p>Finally, you can specify multiple ranges separated by commas:</p><div class=highlight><pre tabindex=0><code>Range: &lt;unit&gt;=&lt;range1-start&gt;-&lt;range1-end&gt;, &lt;range2-start&gt;-&lt;range2-end&gt;, &lt;range3-start&gt;-</code></pre></div><p>Of course, as with all request headers, this indicates a desire by the web client. It is up to the web server to determine if it will be honored.</p><h3 id=partial-content>Partial Content</h3><p>Which brings us to the <strong>206 Partial Content</strong> response status code. If the server chooses to honor a range specified in the request header, it should respond with this status code, and the body of the response should be just the bytes requested.</p><p>In addition, the response <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Range rel=external target=_blank>Content-Range</a> header should be included with the response, specifying the actual range of bytes returned. This is similar to the Range header, but includes a the total size:</p><div class=highlight><pre tabindex=0><code>Content-Range: &lt;unit&gt; &lt;range-start&gt;-&lt;range-end&gt;/&lt;size&gt;</code></pre></div><p>An asterisk (<code>*</code>) can be used for an unknown size.</p><p>Also, the <a href=/cis526/05-web-servers/07-partial-downloads/>Content-Type</a> header should also be included, and match the type of file being streamed.</p><p>If <em>multiple</em> ranges are included in the response, the Content-Type is <code>"multipart/byteranges"</code> and the response body is formatted similarly to multipart form data.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 6</div><h1 id=dynamic-web-servers>Dynamic Web Servers</h1><p>The Web Comes of Age</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Dynamic Web Servers</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>While the first generation of webservers was used to serve static content (i.e. files), it was not long before developers began to realize that a lot more potential existed in the technologies of the web. A key realization here is that the resources served by the web server <em>don&rsquo;t need to exist</em> to be served.</p><p>Consider the directory listing from the previous chapter. It is <em>not</em> based on an existing file, but rather is <em>dynamically created</em> when requested by querying the file system of the server. This brings one clear benefit - if we add files to the directory, the next time we request the listing they will be included.</p><p><a href=#R-image-c05ef773753c136ccc527e52ba56a4fd class=lightbox-link><img alt="Request-Response Pattern" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/6.1.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c05ef773753c136ccc527e52ba56a4fd><img alt="Request-Response Pattern" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/6.1.1.png></a></p><p>Thus, we can create resources <em>dynamically</em> in response to a request. This is the core concept of a <em>dynamic web server</em>, which really means any kind of web server that generates at least some of its content dynamically. In this chapter, we will explore this class of web server.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cgi-scripts>CGI Scripts</h1><p>Before we dig too deeply into dynamic web servers, we should review our technologies used in the web. On the client side, we have HTML, CSS, and JavaScript. Managing communication between the client and server, we have HTTP. But on the server side of the equation, what standard web technologies do we use?</p><p><a href=#R-image-b1e193b3ab49de06fb5d0011fd51e065 class=lightbox-link><img alt="The Web Technologies" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/5.2.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b1e193b3ab49de06fb5d0011fd51e065><img alt="The Web Technologies" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/5.2.1.png></a></p><p>The answer is <em>none</em>. There <strong>is no standard server development language</strong>. In fact, web servers can be written in <em>almost every programming language</em>. This gives web application developers a tremendous amount of flexibility. Of course, that also means the choice of server-side technologies can quickly become overwhelming.</p><p>One technology that emerged to help manage some of this complexity was the <a href=https://en.wikipedia.org/wiki/Common_Gateway_Interface rel=external target=_blank>Common Gateway Interface (CGI)</a>, a web standard that allowed a traditional static webserver to respond to some requests by running a command-line program and piping the output to the requesting client. The CGI standard defined what variables needed to be collected by the web server and how they would be provided to the script.</p><p>The script itself could be written in any language that could communicate using stdin and stdout, though in practice most CGI scripts were written using Perl or Bash script. This strategy was popular with the system admins responsible for deploying webservers like Apache, as these scripting languages and command-line programs were familiar tools. While CGI scripts can be used to build dynamic web pages, by far their most common use was to consume forms filled out by a user, often saving the results to a file or database or sending them via email.</p><p>CGI scripts are still used today, but they do have some important limitations. First, for each kind of request that needed handled, a new script would need to be written. The open-ended nature of CGI scripts meant that over time a web application become a patchwork of programs developed by different developers, often using different languages and organizational strategies. And since running a CGI script typically means starting a separate OS process <em>for each request</em>, the CGI approach does not scale well to web applications in high demand.</p><p>Thus, web developers began seeking new strategies for building cohesive web servers to provide rich dynamic experiences.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>Your personal web space on the CS Departmental Server supports CGI scripts. So if you would like to try to develop one, you can deploy it there. More details can be found on the support <a href=https://support.cs.ksu.edu/CISDocs/wiki/Personal_Web_Pages#Dynamic_Content rel=external target=_blank>Personal Web Pages</a> entry.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=server-pages>Server Pages</h1><p>The CGI scripting approach eventually evolved into a concept known as server pages and embodied in the technologies of PHP and Microsoft‚Äôs Active Server Pages (ASP), as well as Java Server Pages, and many other less-well-known technologies. While each of these use different scripting languages, the basic idea is the same: Take a traditional static webserver functionality, and couple it with a script interpreter. When most files are requested from the server, the file is served using the same techniques we used in the last chapter. But when a script file understood by our augmented server is requested, the script file is executed, and its output is sent as the response.</p><p>This may sound a lot like the CGI Scripts we discussed before, and it certainly is, except for two major innovations. The first of these was that the same interpreter, and therefore OS process, could be used for all requests. As server hardware adopted multiple CPUs and multi-core CPUs, additional interpreter processes were added, allowing incoming requests to be responded to concurrently on separate processors.</p><h3 id=embedded-scripts>Embedded Scripts</h3><p>The second big innovation innovation was the idea of embedding script <em>directly in HTML code</em>. When the server page is interpreted, the embedded scripts would execute, and their output would be concatenated directly into the HTML that was being served.</p><p>For example, a PHP page might look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;!</span><span class=nx>DOCTYPE</span> <span class=nx>html</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>html</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=nx>head</span><span class=o>&gt;&lt;</span><span class=nx>title</span><span class=o>&gt;</span><span class=nx>PHP</span> <span class=nx>Example</span><span class=o>&lt;/</span><span class=nx>title</span><span class=o>&gt;&lt;/</span><span class=nx>head</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=nx>body</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>h1</span><span class=o>&gt;</span><span class=nx>A</span> <span class=nx>PHP</span> <span class=nx>Example</span><span class=o>&lt;/</span><span class=nx>h1</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>      <span class=k>echo</span> <span class=nx>date</span><span class=p>(</span><span class=s1>&#39;D, d M Y H:i:s&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=cp>?&gt;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>  &lt;/body&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;/html&gt;
</span></span></span></code></pre></div><p>Notice everything except the <code>&lt;?php ... ?></code> is perfectly standard HTML. But when served by an <a href=https://httpd.apache.org/ rel=external target=_blank>Apache server</a> with <a href=https://cwiki.apache.org/confluence/display/HTTPD/php rel=external target=_blank>mod_php</a> installed, the code within <code>&lt;?php ... ?></code> would be executed, and its output concatenated into the HTML that would then be served (the <code>echo</code> function prints output, and <code>date()</code> creates the current time in the specified format).</p><p>Similarly, an ASP page doing the same task would look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;&lt;</span><span class=nt>title</span><span class=p>&gt;</span>ASP Example<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>An ASP Example<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=err>&lt;</span>%
</span></span><span class=line><span class=cl>      Response.Write Now()
</span></span><span class=line><span class=cl>    %&gt;
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div><p>These files would typically be saved with a special extension that the server would recognize, i.e. <em>.php</em> for PHP files, and <em>.asp</em> for ASP files. Allowing scripts to be directly embedded within HTML made web development with these tools far faster, and as IDEs were adapted to support syntax highlighting, code completion, and other assistive features with these file types also helped prevent syntax errors in both the HTML and script code.</p><p>Active Server Pages and PHP remain commonly used technologies today, and a large portion of legacy websites built using them are still in service. In fact, your personal web space on the CS department server is running in an Apache server set up to interpret PHP files - you could add a PHP script like the one above and and it would execute when you visited the page. You can visit the support <a href=https://support.cs.ksu.edu/CISDocs/wiki/Personal_Web_Pages#Dynamic_Content rel=external target=_blank>Personal Web Pages</a> entry for details on doing so.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=custom-servers>Custom Servers</h1><p>While CGI Scripts and Server Pages offered ways to build dynamic websites using off-the shelf web server technologies (Apache, IIS), many programmers found these approaches limiting. Instead, they sought to build the entire web server as a custom program.</p><p>Node was actually developed for exactly this approach - it provides abstractions around the fundamental aspects of HTTP in its <a href=https://nodejs.org/api/http.html rel=external target=_blank>http</a> library. This library handles the listening for HTTP requests, and parses the request and uses it to populate a <a href=https://nodejs.org/api/http.html#http_class_http_clientrequest rel=external target=_blank>http.ClientRequest object</a> and provides a <a href=https://nodejs.org/api/http.html#http_class_http_serverresponse rel=external target=_blank>http.ServerResponse object</a> to prepare and send the response. These are abstractions around the HTTP Request and Response we discussed in chapter 2.</p><p>The authors of Node took advantage of the functional nature of JavaScript to make writing servers easy - we just need to provide a function to the server that takes a request/response pair. This has been our <code>handleRequest()</code> method, and we can pack it with custom logic to determine the correct <em>response</em> for the incoming <em>request</em>.</p><p>We&rsquo;ve already written a number of functions that take in a request and response object, and determine the correct response to send. This includes our <code>serveFile()</code>, and our <code>listDirectory()</code>. We can create dynamic pages in much the same way - by writing a custom function to serve the dynamic page.</p><p>For example, a very simple dynamic page could be created with this function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>serveTime</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>html</span> <span class=o>=</span> <span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>        &lt;!doctype html&gt;
</span></span></span><span class=line><span class=cl><span class=sb>        &lt;html&gt;
</span></span></span><span class=line><span class=cl><span class=sb>          &lt;head&gt;
</span></span></span><span class=line><span class=cl><span class=sb>            &lt;title&gt;Server Time&lt;/title&gt;
</span></span></span><span class=line><span class=cl><span class=sb>          &lt;/head&gt;
</span></span></span><span class=line><span class=cl><span class=sb>          &lt;body&gt;
</span></span></span><span class=line><span class=cl><span class=sb>            &lt;h1&gt;Time on the server is </span><span class=si>${</span><span class=k>new</span> <span class=nb>Date</span><span class=p>()</span><span class=si>}</span><span class=sb>&lt;/h1&gt;
</span></span></span><span class=line><span class=cl><span class=sb>          &lt;/body&gt;
</span></span></span><span class=line><span class=cl><span class=sb>        &lt;/html&gt;
</span></span></span><span class=line><span class=cl><span class=sb>    `</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>req</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span> <span class=s2>&#34;text/html&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Content-Length&#34;</span><span class=o>:</span> <span class=nx>html</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>    <span class=p>}).</span><span class=nx>end</span><span class=p>(</span><span class=nx>html</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>But for a server to be <em>dynamic</em>, we typically want more than just the ability to render a page from code. We <em>also</em> want to interact with the user in some meaningful way - and that means receiving data <em>from</em> them. In the HTTP protocol there are several ways for the user to send data:</p><ol><li><p>By the path of the request, i.e. when we request <code>https://support.cs.ksu.edu/CISDocs/wiki/Main_Page</code> the path <code>CISDocs/wiki/Main_Page</code> indicates the page we are requesting</p></li><li><p>By additional information contained in the URL, specifically the <em>query string</em> (the part of the URL that follows the <code>?</code>) and the <em>hash string</em> (the part of hte URL that follows the <code>#</code>)</p></li><li><p>By information contained in the <em>body</em> of the request</p></li></ol><p>We&rsquo;ve already looked at the path portion of the URL in describing how we can implement a file server to serve files and directories. But what about the query string and body of the request? Let&rsquo;s look at how those are handled in Node next.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=query-and-hash-strings>Query and Hash Strings</h1><p>Query strings (aka search strings) are the part of the URL that appear after the <code>?</code> and before the optional <code>#</code>. The hash string is the portion of the url after the <code>#</code>. We&rsquo;ve mentioned them a bit before, but as we dig into dynamic web servers it makes sense to do a deeper dive, as this is where they really come into play.</p><h2 id=the-hash-string>The Hash String</h2><p>First, let&rsquo;s briefly visit the hash string. It&rsquo;s traditional use is to indicate a HTML element on the page the browser should scroll to when visiting the URL. When used this way, its value is the <code>id</code> attribute of the element. The browser will automatically scroll to a position that displays the element on-screen. Thus, the traditional use of the hash string is for &ldquo;bookmarked&rdquo; links that take you to an exact section of the page, like this one which takes you to a description of your personal CS web space: <a href=https://support.cs.ksu.edu/CISDocs/wiki/Personal_Web_Pages#Dynamic_Content rel=external target=_blank>https://support.cs.ksu.edu/CISDocs/wiki/Personal_Web_Pages#Dynamic_Content</a>.</p><p>With the advent of single-page apps, it has come to serve additional purposes; but we&rsquo;ll talk about those when we visit that topic in a future chapter.</p><h2 id=the-querysearch-string>The Query/Search String</h2><p>Now, the query string is a vital tool for dynamic web pages, as it conveys information <em>beyond</em> the specific resource being asked for to the server. Consider what a dynamic webserver does - it takes an incoming request, and sends a response. In many ways, this is similar to a function call - you invoke a function, and it returns a value. With this in mind, the path of the URL is like the function name, and the query string becomes its <em>parameters</em>.</p><p>Much like parameters have a name and a value, the query string is composed of key/value pairs. Between the key and value of each pair is a <code>=</code>, and between the pairs is a <code>&</code>. Because the <code>=</code> and <code>&</code> character now have a special meaning, any that appear in the key or value are swapped with a special percent value, i.e. <code>&</code> becomes <code>%26</code> and <code>=</code> becomes <code>%3D</code>. Similarly, other characters that have special meanings in URLs are likewise swapped. This is known as URL or percent encoding, and you can see the swapped values in the table below:</p><table class=standard-table><tbody><tr><td><code>':'</code></td><td><code>'/'</code></td><td><code>'?'</code></td><td><code>'#'</code></td><td><code>'['</code></td><td><code>']'</code></td><td><code>'@'</code></td><td><code>'!'</code></td><td><code>'$'</code></td><td><code>'&'</code></td><td><code>"'"</code></td><td><code>'('</code></td><td><code>')'</code></td><td><code>'*'</code></td><td><code>'+'</code></td><td><code>','</code></td><td><code>';'</code></td><td><code>'='</code></td><td><code>'%'</code></td><td><code>' '</code></td></tr><tr><td><code>%3A</code></td><td><code>%2F</code></td><td><code>%3F</code></td><td><code>%23</code></td><td><code>%5B</code></td><td><code>%5D</code></td><td><code>%40</code></td><td><code>%21</code></td><td><code>%24</code></td><td><code>%26</code></td><td><code>%27</code></td><td><code>%28</code></td><td><code>%29</code></td><td><code>%2A</code></td><td><code>%2B</code></td><td><code>%2C</code></td><td><code>%3B</code></td><td><code>%3D</code></td><td><code>%25</code></td><td><code>%20</code> or <code>+</code></td></tr></tbody></table><p>In JavaScript, the <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent rel=external target=_blank>encodeURIComponent()</a> function can be used to apply percent encoding to a string, and the <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/decodeURIComponent rel=external target=_blank>decodeURIComponent()</a> can be used to reverse it.</p><p>Node offers the <a href=https://nodejs.org/api/querystring.html rel=external target=_blank>querystring</a> library. It offers a <a href=https://nodejs.org/api/querystring.html#querystring_querystring_parse_str_sep_eq_options rel=external target=_blank>querystring.parse()</a> method which can parse a query string into a JavaScript object with the decoded key/value pairs transformed into properties and a <a href=https://nodejs.org/api/querystring.html#querystring_querystring_stringify_obj_sep_eq_options rel=external target=_blank>querystring.stringify()</a> method which can convert a JavaScript object into an encoded query string. In addition, these methods allow you to override what characters are used as delimiters, potentially allowing you to use alternative encoding schemes.</p><h2 id=forms-and-the-query-string>Forms and the Query String</h2><p>While we can type a URL with a query string manually, by far the most common way to produce a query string is with a <code>&lt;form></code> element. When a form is submitted (the user clicks on a <code>&lt;input></code> with <code>type</code> attribute of <code>"submit"</code>), it is serialized and submitted to the server. By default, it will be sent to the same URL it was served from, using a GET request, with the fields of the form serialized as the query string.</p><p>This is why one name for the query string is the <em>search</em> string, as it is commonly used to submit search requests. For example, Google&rsquo;s search page contains a form similar to this (very simplified form):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;q&#34;</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;Google Search&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span></span></span></code></pre></div><p>Notice the form has one text input, named <code>"q"</code>. If we type in search terms, say &ldquo;k-state computer science&rdquo; and click the search button, you&rsquo;ll notice in the resulting url the query string contains <code>q=k-state+computer+science</code> (plus a lot of other key/value pairs). If you type <code>"https://www.google.com/search?q=k-state+computer+science"</code> into the address bar, you&rsquo;ll get the same page.</p><p>Notice though, that google uses <code>www.google.com/search</code> as the URL to display search results at, instead of the original <code>www.google.com</code> page. We can have a form submit to a different URL than it was served on by setting its <code>action</code> attribute to that URL.</p><p>We can also change the HTTP method used to submit the form with the <code>method</code> attribute. By default it uses a GET request, but we can instead set it to a POST request. When a POST request is used, the form is no longer encoded in the query string - it is instead sent as the body of the POST request.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=form-encoding>Form Encoding</h1><p>When a form is submitted as a POST request, its inputs are serialized according to the form&rsquo;s encoding strategy. This value is also used as the <code>Content-Type</code> header of the request. The three form encoding values are:</p><ul><li><code>application/x-www-form-urlencoded</code> (the default)</li><li><code>multipart/form-data</code> (used for file uploads)</li><li><code>text/plain</code> (used for debugging)</li></ul><p>The <code>&lt;form></code> element&rsquo;s <code>enctype</code> attribute can be set to any of these three possible values.</p><h2 id=applicationx-www-form-urlencoded>application/x-www-form-urlencoded</h2><p>This serialization format consists of key/value pairs where the keys and values are url (percent) encoded, and between each key and value is a <code>=</code> and between each pair is a <code>&</code>. In other words, it is the same encoding that is used in the query string - the only difference is the query string begins with a <code>?</code>.</p><p>Thus, the form:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>method</span><span class=o>=</span><span class=s>&#34;post&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;first&#34;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;Your first name&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;middle&#34;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;Your middle initials&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;last&#34;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;Your last name&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;number&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;age&#34;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;Your age&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;Save My Info&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span></span></span></code></pre></div><p>When submitted by John Jacob Jingleheimer Schmidt would be encoded:</p><div class=highlight><pre tabindex=0><code>first=John&amp;middle=J.+J.&amp;last=Schmidt&amp;age=30</code></pre></div><p>If we parsed this string with <a href=https://nodejs.org/api/querystring.html#querystring_querystring_parse_str_sep_eq_options rel=external target=_blank>querystring.parse()</a> the resulting JavaScript object would be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>first</span><span class=o>:</span> <span class=s2>&#34;John&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>middle</span><span class=o>:</span> <span class=s2>&#34;J. J.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>last</span><span class=o>:</span> <span class=s2>&#34;Schmidt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>age</span><span class=o>:</span> <span class=s2>&#34;30&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>It is important to note that even though age started as a numerical value, it becomes a string in the conversion process. <strong>All values submitted in a form will be interpreted as strings on the server.</strong> If we need it to be a number again, we can always use <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/parseInt rel=external target=_blank>parseInt()</a> on it.</p></div></div><h2 id=multipartform-data>multipart/form-data</h2><p>There is one limitation to the <code>application/x-www-form-urlencoded</code> encoding strategy - there is no way to include binary data, i.e. files. If you submit a form that includes an <code>&lt;input></code> of type <code>file</code> and encode it with <code>application/x-www-form-urlencoded</code>, the value supplied by the <code>&lt;input type="file"></code> will be the filename only. The actual body of the file will not be available. The reason is simple - there&rsquo;s no easy way to put raw binary data into a text file.</p><p>The <code>multipart/form-data</code> solves this in a less-than easy way. It splits the body into blocks - one for each input. Between each block is a sequence of bytes used as a separator. These boundary bytes cannot be found in any of the file data (as if it were, that block would be split up). And each block has its own header section and body section. The header defines what the input is, and what its body contains. If it was a non-file input, it will be text, and if it was a file input, the content will be the raw bytes, encoded in base64.</p><p>When the server receives this body, it must use the boundary bytes to separate the blocks, and then parse each block. There are no built-in libraries in Node for doing this, though there are many npm packages that do. We&rsquo;ll also write our own from scratch so that we get a good feel for it.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=request-body>Request Body</h1><p>While many HTTP libraries will process the entire incoming request before passing control to the program, Node&rsquo;s <code>http</code> module takes a different approach. It constructs and passes the <code>http.IncomingMessage</code> and <code>http.ServerResponse</code> objects as soon as it has received the header portion of the request. This means the body may still be being transmitted to the server as you start to process the request.</p><p>This is fine for GET requests, as they don&rsquo;t have a body. But for requests that <em>do</em> have a body, it means you have to process the incoming data yourself.</p><p>To do so, there are three events made available in the <a href=https://nodejs.org/api/http.html#http_class_http_incomingmessage rel=external target=_blank>http.IncomingMessage</a> object: <code>data</code>, <code>end</code>, and <code>error</code>.</p><p>The <code>data</code> event occurs whenever a new chunk of the body is available, and that chunk is passed to the event listener. The <code>end</code> event occurs once all the chunks have been received. And the <code>error</code> event occurs when something goes wrong. The chunks are <a href=https://nodejs.org/api/buffer.html rel=external target=_blank>Buffer</a> objects, and are always received in order.</p><p>Thus, we need to collect each chunk from each <code>data</code> event, and join them together into a single buffer at the <code>end</code> event. Thus, the basic scaffold for doing so is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>loadBody</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>chunks</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// listen for data events
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>req</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>chunk</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>chunks</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>chunk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// listen for the end event 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>req</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;end&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Combine the chunks 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>Buffer</span><span class=p>.</span><span class=nx>concat</span><span class=p>(</span><span class=nx>chunks</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// DO SOMETHING WITH DATA
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// listen for error events 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>req</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// RESPOND APPROPRIATELY TO ERROR
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Note that these events occur asynchronously, so this scaffold needs to be integrated into an appropriate asynchronous processing strategy.</p><p>You might wonder why the developers of Node chose to handle request bodies in this fashion. Most likely, it was for the degree of control it offers the programmer. Consider the case where you decide your program needs to be able to stop an upload - you can do so with <a href=https://nodejs.org/api/http.html#http_class_http_incomingmessage rel=external target=_blank>http.IncomingMessage.destroy()</a>, which immediately closes the socket connecting the client to the server, effectively terminating the upload.</p><p>This can prevent the server from doing unneeded work and consuming unnecessary bandwidth. Of course, the decision to stop an upload is highly situationally dependent - thus they leave it in your hands as the programmer.</p><p>In fact, a common Denial of Service attack known as an HTTP flood often takes advantage of POST requests to submit requests with large bodies to consume server resources. By giving the programmer the ability to stop uploads this way helps counter this kind of attack.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cookies>Cookies</h1><p>HTML was designed as a <em>stateless</em> protocol. This means that there is no expectation for the server to keep track of prior requests made to it. Each incoming HTTP request is effectively treated as if it is the <em>first</em> request ever made to the server.</p><p>This was an important consideration for making the web possible. Consider what would happen if our server needed to keep track of what every visitor did on the site - especially when you have <em>thousands</em> of unique visitors every second? You would need a lot of memory, and a mechanism to tell which user is which. That&rsquo;s a lot of extra requirements to getting a web server working.</p><p>But at the same time, you probably recognize that many of the websites you use every day <em>must be doing just that</em>. If you use Office 365 or Google Docs, they manage to store your documents, and not serve you someone else&rsquo;s when you log in. When you visit an online store and place products in your shopping basket, they remain there as you navigate around the site, loading new pages. So how are these websites providing state?</p><p>The answer that was adopted as a W3C standard - <a href=https://tools.ietf.org/html/rfc6265 rel=external target=_blank>RFC 2695</a> is <em>cookies</em>. Cookies are nothing more than text that is sent along with HTTP Requests and Responses. A server can ask a client to store a cookie with a <code>Set-Cookie</code> header. From that point on, any request the client makes of that server will include a <code>Cookie</code> header with the cookie information.</p><p>It&rsquo;s kind of like if your forgetful teacher gives you a note to show him the next time you come to office hours, to help remind him of what you talked about previously. This way, the server doesn&rsquo;t have to track state for any visitor - it can ask the visitor&rsquo;s client (their browser) to do it for them.</p><h2 id=what-is-a-cookie>What is a Cookie?</h2><p>Let&rsquo;s dig deeper into this idea and implementation of cookies.</p><p>Much like a web request or response, a cookie is nothing more than a stream of data. It gets passed between client and server through their headers. Specifically, the <code>Set-Cookie</code> header sends the cookie to the client, and the client will automatically return it in subsequent requests using the <code>Cookie</code> header.</p><p>Say we want to establish a session id, (SID), for every unique visitor to our site. We would have our server send the SID in a <code>Set-Cookie</code> header:</p><p><code>Set-Cookie: SID=234</code></p><p>The browser would store this value, and on subsequent requests <em>to the same domain</em>, include a corresponding <code>Cookie</code> header:</p><p><code>Cookie: SID=234</code></p><p>Unless the <code>Domain</code> cookie attribute is specified (see below), a cookie is only sent to the domain that it originated from. It will not be sent to subdomains, i.e. a cookie that came from <code>ksu.edu</code> will not be sent to the server with hostname <code>cs.ksu.edu</code>.</p><h3 id=structure-of-a-cookie>Structure of a Cookie</h3><p>As you might have guessed from the example, the string of a cookie is a set of key/value pairs using the equals sign (<code>=</code>) to assign the value to the key. But we can also include multiple cookie pairs using a semicolon (<code>;</code>) to separate the cookie pairs, i.e.:</p><p><code>Set-Cookie: SID=234; lang=en-US</code></p><p>Both cookie pairs are sent back in a <code>Cookie</code> header:</p><p><code>Cookie: SID=234; lang=en-US</code></p><p>We can chain multiple pairs of cookie pairs. After the last cookie pair, we need another semicolon, then any cookie attributes, also separated by semicolons. For example:</p><p><code>Set-Cookie: SID=234; lang=en-US; EXPIRES=Wed, 04 April 2019 011:30:00 CST</code></p><p>adds a cookie attribute specifying an expiration date for the cookie. The legal cookie attributes are laid out in <a href=https://tools.ietf.org/html/rfc6265 rel=external target=_blank>RFC6265</a>, but we&rsquo;ll reprint them here.</p><h4 id=cookie-attributes>Cookie Attributes</h4><p>There are a limited number of defined cookie attributes, and each changes the nature of the cookie and how a browser will work with it in an important way. Let&rsquo;s examine each in turn:</p><p><strong>Expires</strong> As you might expect, this sets an expiration date for the cookie. After the date, the browser will throw away the cookie, removing it from its internal cache. It will also stop sending the cookie with requests. If you need to erase a value in a cookie you&rsquo;ve already sent to a user, you can respond to their next request with a new <code>Set-Cookie</code> header with the <code>Expires</code> value set in the past. To avoid issues with time zones, the date supplied must conform to the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Date rel=external target=_blank>HTTP-Date</a> format set out in <a href=https://tools.ietf.org/html/rfc1123 rel=external target=_blank>RFC1123</a>.</p><p><strong>Max-Age</strong> The <code>Max-Age</code> also sets an expiration date, but in terms of a number of seconds from the current time. A value of 0 or less (negative) will remove the cookie from the browser&rsquo;s cache, and stop sending the cookie in future requests. IE 7, 8, and 9 do not support the <code>Max-Age</code> attribute; for all other browsers, <code>Max-Age</code> will take precedence over <code>Expires</code>.</p><p><strong>Domain</strong> As described above, cookies are by default sent only to the domain from which they originated, and no subdomains. If the domain is explicitly set with the <code>Domain</code> attribute, subdomains are included.</p><p><strong>Path</strong> The value of this attribute further limits what requests a cookie will be sent to. If the <code>Path</code> is specified, only requests whose url matches the value will be sent. This does include subpaths, i.e. <code>Path=/documents</code> will match the urls <code>/documents/</code>, <code>/documents/1.doc</code>, and <code>/documents/recent/a.pdf</code>.</p><p><strong>Secure</strong> Cookies including this attribute (it does not need a value) will only be sent by the browser with HTTPS requests, not HTTP requests. Note that sending the cookie over HTTPS does not encrypt the cookie data - as a header, it is sent in the clear for both HTTP and HTTPS.</p><p><strong>HttpOnly</strong> Cookies can normally be accessed by JavaScript on the client, from the <code>Document.cookie</code> property. Setting this attribute (it does not need a value) tells the browser not to make it accessible.</p><p><strong>SameSite (in Draft)</strong> This new cookie attribute is intended to help a server assert that its cookies should not be sent with any cross-site requests originating from this page (i.e. <code>&lt;script></code> tags, <code>&lt;img></code> tags, etc. whose source is a different site, or AJAX requests against other sites). This is intended to help combat cross-site scripting attacks. As you might expect, this is only supported in the newest browser versions.</p><h2 id=cookies-and-security>Cookies and Security</h2><p>As with all web technologies, we need to consider the security implications. Cookies are received and returned by the client - and we know that anything the client is responsible for can be manipulated by an adversarial agent. Let&rsquo;s think through the implications.</p><p>All cookies received by a browser and cached there. How long they are stored depends on the <code>Max-Age</code> and <code>Expires</code> attributes. Browsers are told to delete cookies older than their <code>Max-Age</code>, or whose <code>Expires</code> duration has passed. If neither of these are set, the cookie is considered a <em>session</em> cookie - it is deleted when the browser is closed (this is why you should always close a browser you use on a public computer).</p><p>While session cookies only exist in memory, cookies with expiration dates may be persisted as text files in the browser&rsquo;s data directory. If this is the case, it is a simple matter for a knowledgeable adversary with access to the computer to retrieve them. Also remember access doesn&rsquo;t necessarily mean <em>physical</em> access - malware running on your computer can effectively copy this data as well.</p><p>Moreover, cookies are just text - say for example you add the identity of your user with a cookie <code>Set-Cookie: user-id=735</code>. An adversary could sign up for a legitimate account with your application, and then manipulate their cookie to return <code>Cookie: user-id:1</code>. Since user ids are often incrementally generated primary keys in a database, it&rsquo;s a good assumption that one or two low-numbered ones will belong to administrator accounts - and this adversary has just impersonated one!</p><p>So if we need cookies to add state to our web applications, but cookies (and therefore that state) are subject to interception and manipulation - how can we protect our users and our site?</p><h2 id=strategies-for-making-cookies-safeer>Strategies for Making Cookies Safe(er)</h2><p>Some common strategies are:</p><ul><li>Use HTTPS</li><li>Store as little information in a cookie as possible</li><li>Encrypt the cookie&rsquo;s values</li><li>Sign the cookie</li><li>Use Short Lifespans</li></ul><h3 id=use-https>Use HTTPS</h3><p>Using Secure HTTP helps prevent cookies from being intercepted during transit, as the request body and headers are encrypted before they move across the transport layer of the Internet. This does not protect cookies once they arrive at a user&rsquo;s computer, however. Still, it is a great first step.</p><h3 id=storing-as-little-in-the-cookie-as-possible>Storing as Little in the Cookie as Possible</h3><p>A good general strategy is to store as little of importance in the cookie as possible. This also helps keep the size of a site&rsquo;s cookies down, which means less traffic across the network, and less to store on a user&rsquo;s computer. The RFC suggests browsers support a minimum size of 4096 bytes per cookie - but this is not a requirement.</p><p>But where do we store the session information, if not in the cookie? This is the subject of the next section, <a href=https://textbooks.cs.ksu.edu/cis526/06-dynamic-web-servers/09-sessions/ rel=external target=_blank>https://textbooks.cs.ksu.edu/cis526/06-dynamic-web-servers/09-sessions/</a>. This strategy usually entails storing nothing more than a session identifier in the cookie, and storing the actual data that corresponds to that session identifier on the server. Effectively, we make our server <em>statefull</em> instead of <em>stateless</em>.</p><h3 id=encrypting-cookie-values>Encrypting Cookie Values</h3><p>Another common strategy is encrypting the value of a cookie using a reversible encryption algorithm before sending it to the client. This kind of encryption technique is a mathematical function that can easily be reversed, provided you know the key used during the encryption process. This key should be stored in the server and never shared, only used internally to encrypt outgoing cookies and decrypt incoming ones.</p><p>This strategy only works if you don&rsquo;t need to know the cookie&rsquo;s value on the client (as the client will not have the key). Also, be wary of sending any details of the encryption with the encrypted data - anything that helps identify the encryption strategy or provides information like initialization vectors can help an adversary break the encryption. Also, check what algorithms are considered strong enough by current standards; this is always a moving target.</p><h3 id=signing-cookie-values>Signing Cookie Values</h3><p>A third common technique is signing the cookie with a hash. A hash is the result of a one-way cryptographic function - it is easy to perform but very difficult to reverse. How it works is you hash the value of the cookie, and then send both the original data&rsquo;s value and the hashed value as cookies. When you receive the cookie back from the client, you re-hash the value found in the cookie, and compare it to the hashed value in the cookie. If the two values are different, then the cookie has been modified.</p><h3 id=use-short-lifespans>Use Short Lifespans</h3><p>The above strategies only keep adversaries from modifying cookies. There is still the danger of valid cookies being captured and used by an adversary - a technique known as <a href=https://en.wikipedia.org/wiki/Session_hijacking rel=external target=_blank>session hijacking</a>. Using HTTPS can prevent session hijacking from within the network, but will not protect against cookies lifted from the client&rsquo;s computer.</p><p>Making sessions expire quickly can help mitigate some of the risk, especially when the adversary is using physical access to the computer to retrieve cookies - you wouldn&rsquo;t expect them to do this while the user is still using the computer.</p><p>But non-physical access (such as a compromised computer) can lift a cookie while it is in use. Regenerating a session identifier (assuming you are using the first strategy) on each login can help, especially if you prompt users to log in before allowing especially risky actions. Adding some additional tracking information like the originating IP address to the session and prompting the user to validate a session by logging back in when this changes can also help.</p><p>Be aware that these strategies can also be very frustrating for users who are prompted to sign in repeatedly. As always, you need to balance security concerns with user satisfaction for the kind of activities your application supports.</p><h3 id=combinations-of-the-above>Combinations of the Above</h3><p>Clearly these strategies can be used in combination, and doing so will provide a better degree of safety for your clients. But the can also increase computation time, network traffic, and user frustration within your web application. Deciding just how much security your application needs is an important part of the design process.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=sessions>Sessions</h1><p>If HTTP is stateless, how do e-commerce websites manage to keep track of the contents of your shopping cart as you navigate from page to page? The answer is the use of a <em>session</em> - a technique by which state is added to a web application.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>The term <strong>session</strong> appears a <em>lot</em> in web development, and can mean different things in different contexts. But there is a common thread in each - a session is a form of connection between the client and server.</p><p>For example, when your web client make a request from a web server, it opens a Transmission Control Protocol (TCP) session to the server, and sends the HTTP request across this connection. The session stays open until all the packets of the request are sent, and those of the response are received. In HTTP 1.1, the session can stay open for more than a single request-response pair, as it is anticipated a HTML page request will be followed by requests for resources (CSS, JavaScript, images, etc.) embedded in the page. HTTP 2.0 takes this farther, allowing the server to <em>push</em> these additional resources to the client.</p><p>The sessions we are discussing here are implemented at a higher level than TCP sessions (though they are hosted by the TCP session), and represent a single website visitor interacting with the server.</p></div></div><p>A session therefore provides a mechanism for storing information between requests, and must be unique to a specific user. All session techniques begin with a cookie, so you should be familiar with that concept.</p><p>There are three basic session techniques you will likely encounter in web development. Let&rsquo;s take a look at each.</p><h2 id=cookie-session>Cookie Session</h2><p>In a cookie session, the session information is completely stored within the cookie. This has the benefit that no state information needs to be stored on the server, and it is easy to implement.</p><p>There are several downsides to the cookie session. The first is that it comes with a limited amount of reliable storage (the standard suggests that browsers support a minimum cookie size of 4096 bytes per cookie, but there is no hard requirement). Second, cookies are somewhat vulnerable, as they can be intercepted in-transit, and they can also be recovered from a browser&rsquo;s cookie storage by a knowledgeable adversary.</p><h2 id=in-memory-cookies>In-Memory Cookies</h2><p>A second approach is to store the session data on the server using some form of memory cache. A straightforward implementation for a Node server would be to use an object, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>sessions</span> <span class=o>=</span> <span class=p>{}</span></span></span></code></pre></div><p>Each time a new visitor comes to the website, a unique ID is generated, and used as the the key for their session, and sent to the client as a cookie, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>sessionID</span> <span class=o>=</span> <span class=p>[</span><span class=nx>some</span> <span class=nx>unique</span> <span class=nx>id</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nx>res</span><span class=p>.</span><span class=nx>setHeader</span><span class=p>(</span><span class=s2>&#34;Set-Cookie&#34;</span><span class=p>,</span> <span class=sb>`session-id=</span><span class=si>${</span><span class=nx>sessionID</span><span class=si>}</span><span class=sb>; lang=en-US`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>sessions</span><span class=p>[</span><span class=nx>sessionID</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// session data here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div><p>On subsequent requests, the cookie can be retrieved from the request and used to retrieve the session data:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>cookie</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s2>&#34;cookie&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>sessionID</span> <span class=o>=</span> <span class=sr>/session-id=([^;])/</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=nx>cookie</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>session</span> <span class=o>=</span> <span class=nx>sessions</span><span class=p>[</span><span class=nx>sessionID</span><span class=p>];</span></span></span></code></pre></div><p>Because the session data is never sent in its raw form to the client, it is more secure. However, the session can still be hijacked by a malicious user who copies the cookie or guesses a valid session id. To counter this, all requests should be updated to use secure protocol (https) and the cookie should be encrypted.</p><p>Also, in-memory sessions are lost when the server reboots (as they are held in volatile memory). They should also be cleaned out periodically, as each session consumes working memory, and if a session is more than an hour old it probably will not be used again.</p><h2 id=database-sessions>Database Sessions</h2><p>When a website is backed by a database (as we&rsquo;ll cover <a href=https://textbooks.cs.ksu.edu/cis526/07-persistent-storage/03-databases/ rel=external target=_blank>soon</a>), storing the session in that database becomes an option. Functionally, it is similar to an In-Memory session, except that the database becomes the storage mechanism. Because the database offers persistent storage, the session also could be persistent (i.e. you remain &ldquo;logged on&rdquo; every time you visit from the same computer). Still, database sessions typically are cleaned out periodically to keep the sessions table from growing overlarge.</p><p>Database sessions are a good choice if your website is already using a database. For a website with registered users, the session id can be the user&rsquo;s id, as defined in the database schema.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=template-rendering>Template Rendering</h1><p>While skilled programmers may have chafed at the restrictions imposed by server pages, there was one aspect that came to be greatly valued - the ability to embed script directly in HTML, and have it evaluated and concatenated into the HTML text.</p><h2 id=template-libraries>Template Libraries</h2><p>This is where template libraries come in. A template library allows you to write your HTML content <em>as HTML in a separate file</em> with a special syntax to inject dynamic programming script. This is often some variation of <code>&lt;></code> or <code>{}</code>. This approach allows you to validate the HTML, as the script portions are ignored as unknown tags (when using <code>&lt;></code>) or as static text.</p><p>When the server is running, these templates are rendered, evaluating any code and supplying the applicable variables. This process generates the HTML snippet.</p><p>This is similar to what server pages do. However, server pages represent an <em>integrated</em> approach - the server page framework defined all aspects of how you could interact with the OS, the web server, and other programs. In contrast, a template library provides the option of using templates within any project - obviously for generating HTML as part of a dynamic website, but potentially for other kinds of applications as well.</p><p>Thus, a template rendering library gives us a lot of flexibility in how and when we use it. For example, in using the <a href=https://ejs.co/ rel=external target=_blank>Embedded JavaScript</a> template library, we could rewrite our directory listing as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!doctype html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Directory Listing<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>h2</span><span class=p>&gt;</span>Directory Listing for <span class=err>&lt;</span>%= pathname %&gt;<span class=p>&lt;/</span><span class=nt>h2</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;display: flex; flex-direction: column; padding: 2rem 0&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% entries.forEach((entry) =&gt;{ %&gt;
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;&lt;%= path.posix.join(pathname, entry) %&gt;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>&lt;</span>%= entry %&gt;
</span></span><span class=line><span class=cl>            <span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% }) %&gt;
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% if (pathname !== &#34;/&#34;) { %&gt;
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;&lt;%= path.dirname(pathname) %&gt;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                Parent directory
</span></span><span class=line><span class=cl>            <span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% } %&gt;
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div><p>Notice how we can embed the JavaScript <em>directly into the file</em>. In a Node server, we can use this template to render html:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Build the dynamic HTML snippets
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pathname</span><span class=o>:</span> <span class=nx>pathname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>entries</span><span class=o>:</span> <span class=nx>entries</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>path</span><span class=o>:</span> <span class=nx>path</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=nx>ejs</span><span class=p>.</span><span class=nx>renderFile</span><span class=p>(</span><span class=s2>&#34;templates/directory-listing.ejs&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>html</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=c1>// TODO: render the HTML in the string variable html
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span></span></span></code></pre></div><p>While this may <em>seem</em> like just as much work as the concatenation approach, where it really shines is the ability to combine multiple templates, separating parts of the pages out into different, reusable template files. These are typically separated into two categories based on how they are used, <em>partials</em> and <em>layouts</em>.</p><h3 id=partials>Partials</h3><p>A partial is simply a <em>part</em> of a larger page. For example, the entries we are rendering in the listing could be defined in their own template file, <em>directory-listing-entry.ejs</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;&lt;%= path %&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=err>&lt;</span>%= entry %&gt;
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span></span></span></code></pre></div><p>And then <em>included</em> in the <em>directory-listing.ejs</em> template:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!doctype html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Directory Listing<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>h2</span><span class=p>&gt;</span>Directory Listing for <span class=err>&lt;</span>%= pathname %&gt;<span class=p>&lt;/</span><span class=nt>h2</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;display: flex; flex-direction: column; padding: 2rem 0&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% entries.forEach((entry) =&gt;{ %&gt;
</span></span><span class=line><span class=cl>            <span class=err>&lt;</span>%- include(&#39;directory-listing-entry&#39; {entry: entry, path: path.posix.join(pathname, entry) }) %&gt;
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% }) %&gt;
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% if (pathname !== &#34;/&#34;) { %&gt;
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;&lt;%= path.dirname(pathname) %&gt;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                Parent directory
</span></span><span class=line><span class=cl>            <span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% } %&gt;
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div><p>While this may seem overkill for this simple example, it works incredibly well for complex objects. It also makes our code far more modular - we can use the same partial in many parts of our web application.</p><h3 id=layouts>Layouts</h3><p>A second common use of templates is to define a <em>layout</em> - the parts that every page holds in common. Consider this template file, <em>layout.ejs</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!doctype html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span><span class=err>&lt;</span>%= title %&gt;<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>%- include(&#39;header&#39;) %&gt;
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>%- content %&gt;
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>%- include(&#39;footer&#39;) %&gt;
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div><p>Now our directory listing can focus entirely on the directory listing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>h2</span><span class=p>&gt;</span>Directory Listing for <span class=err>&lt;</span>%= pathname %&gt;<span class=p>&lt;/</span><span class=nt>h2</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;display: flex; flex-direction: column; padding: 2rem 0&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=err>&lt;</span>% entries.forEach((entry) =&gt;{ %&gt;
</span></span><span class=line><span class=cl>    <span class=err>&lt;</span>%- include(&#39;directory-listing-entry&#39; {entry: entry, path: path.posix.join(pathname, entry) }) %&gt;
</span></span><span class=line><span class=cl><span class=err>&lt;</span>% }) %&gt;
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=err>&lt;</span>% if (pathname !== &#34;/&#34;) { %&gt;
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;&lt;%= path.dirname(pathname) %&gt;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        Parent directory
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=err>&lt;</span>% } %&gt;</span></span></code></pre></div><p>And we can render our page using the layout:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Build the dynamic HTML snippets
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pathname</span><span class=o>:</span> <span class=nx>pathname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>entries</span><span class=o>:</span> <span class=nx>entries</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>path</span><span class=o>:</span> <span class=nx>path</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=nx>ejs</span><span class=p>.</span><span class=nx>renderFile</span><span class=p>(</span><span class=s2>&#34;templates/directory-listing.ejs&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>content</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// TODO: handle error
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>ejs</span><span class=p>.</span><span class=nx>renderFile</span><span class=p>(</span><span class=s2>&#34;templates/layout.ejs&#34;</span><span class=p>,</span> <span class=p>{</span><span class=nx>content</span><span class=o>:</span> <span class=nx>content</span><span class=p>},</span> <span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>html</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// TODO: render the HTML in the string variable html
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>This layout can be re-used by all pages within our site, allowing us to write the HTML shared in common by the whole website once.</p><p>Also, while these examples show reading the template files as the response is being generated, most template engines support <em>compiling</em> the templates into a function that can be called at any time. This effectively caches the template, and also speeds up the rendering process dramatically.</p><h3 id=concise-templating-languages>Concise Templating Languages</h3><p>Some template libraries have leveraged the compilation idea to provide a more concise syntax for generating HTML code. For example, the directory listing written using <a href=https://pugjs.org/api/getting-started.html rel=external target=_blank>Pug</a> templates would be:</p><div class=highlight><pre tabindex=0><code class=language-pug data-lang=pug>doctype html
html(lang=&#34;en&#34;)
    head
        title= Directory Listing
    body
        h2= &#39;Directory Listing for &#39; + pathname 
        div(style=&#34;display: flex; flex-direction: column; padding: 2rem 0&#34;)
        each entry in entries
            a(href=/cis526/06-dynamic-web-servers/10-template-rendering/path.posix.join(pathname, entry)) entry 
        if pathname !== &#34;/&#34;
            a(href=/cis526/06-dynamic-web-servers/10-template-rendering/path.dirname(pathname))
                Parent directory</code></pre></div><p>Concise templating languages can significantly reduce the amount of typing involved in creating web pages, but they come with a trade-off. As you can see from the code above, learning Pug effectively requires you to learn a new programming language, including its own iteration and conditional syntax.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>EJS is just one template library available in JavaScript. Some of the most popular ones include:</p><ul><li><a href=https://mustache.github.io/ rel=external target=_blank>Mustache</a></li><li><a href=https://handlebarsjs.com/ rel=external target=_blank>Handlebars</a></li><li><a href=https://mozilla.github.io/nunjucks/ rel=external target=_blank>Nunjucks</a></li><li><a href=http://underscorejs.org/ rel=external target=_blank>Underscore</a></li><li><a href=https://pugjs.org/api/getting-started.html rel=external target=_blank>Pug</a></li></ul><p>It is useful to compare how these different libraries approach templates as there are often large differences, not only in syntax but also in function.</p></div></div><h2 id=components>Components</h2><p>A newer approach, popularized by the <a href=https://reactjs.org/ rel=external target=_blank>React</a> framework, emphasizes building <em>components</em> rather than <em>pages</em>. A component can be thought of as a single control or widget on a page. While conceptually similar to the partials described above, it organizes its structure, styling, and scripting into a cohesive and reuseable whole.</p><p>This represents a move away from the separation of concerns we described earlier. It often incorporates aspects of <a href=https://en.wikipedia.org/wiki/Declarative_programming rel=external target=_blank>declarative programming</a> rather than thinking of programming in terms of control flow. This component-based approach also lends itself to developing <a href=https://en.wikipedia.org/wiki/Progressive_web_application rel=external target=_blank>progressive web applications</a>, which only download the script needed to run the portion of the app the user is interacting with at a given time.</p><p>As this approach is significantly different from the more traditional templating libraries, we&rsquo;ll discuss these ideas in a later chapter.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=script-injection>Script Injection</h1><p>Whenever we render content created by users, we open the door to <em>script injection</em>, a kind of attack where a malicious user adds script tags to the content they are posting. Consider this form:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;post&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>   <span class=p>&lt;</span><span class=nt>label</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;comment&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>textarea</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;comment&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>textarea</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span></span></span></code></pre></div><p>The intent is to allow the user to post comments on the page. But a malicious user could enter something like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>What an awesome site <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://malic.ous/dangerous-script.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div><p>If we concatenate this string directly into the webpage, we will serve the <code>&lt;script></code> tag the user included, which means that <em>dangerous-script.js</em> will run on our page! That means it can potentially access our site&rsquo;s cookies, and make AJAX requests from our site. This script will run on the page for <em>all</em> visitors!</p><p>This attack is known as <a href=https://www.softwaretestinghelp.com/javascript-injection-tutorial/ rel=external target=_blank>script injection</a>, and is something you <strong>MUST</strong> prevent. So how can we prevent it? There are several strategies:</p><ol><li>HTML Escaping</li><li>Block Lists</li><li>Allow Lists</li><li>Markdown or other Markup Languages</li></ol><h3 id=html-escaping>HTML Escaping</h3><p>The simplest is to &ldquo;escape&rdquo; html tags by replacing the <code>&lt;</code> and <code>></code> characters with their html code equivalents, <code>&amp;lt;</code> (less than symbol) and <code>&amp;gt;</code> (greater than symbol). By replacing the opening and closing brackets with the equivalent HTML code, the browser will render the tags as ordinary strings, instead of as HTML. Thus, the above example will render on the page as:</p><blockquote><p>What an awesome site &lt;script src=&ldquo;<a href="http://malic.ous/dangerous-script.js%22></script" rel=external target=_blank>http://malic.ous/dangerous-script.js">&lt;/script</a>></p></blockquote><p>This can be accomplished in JavaScript with the <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replace rel=external target=_blank>String.prototype.replace()</a> method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>sanitizedHtmlString</span> <span class=o>=</span> <span class=nx>htmlString</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/&lt;/g</span><span class=p>,</span> <span class=s1>&#39;&amp;lt;&#39;</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/&gt;/g</span><span class=p>,</span> <span class=s1>&#39;&amp;gt&#39;</span><span class=p>);</span></span></span></code></pre></div><p>The <code>replace()</code> method takes either a regular expression or string to search for - and a string to replace the occurrences with. Here we use regular expressions with the global flag, so that <em>all</em> occurrences will be replaced. We also take advantage of the fact that it returns the modified string to do <a href=https://en.wikipedia.org/wiki/Method_chaining rel=external target=_blank>method chaining</a>, invoking a second <code>replace()</code> call on the string returned from the first call.</p><p>The downside to this approach is that <em>all</em> html in the string is reinterpreted as plain text. This means our comments won&rsquo;t support HTML codes like <code>&lt;b></code> and <code>&lt;i></code>, limiting the ability of users to customize their responses.</p><h3 id=allow-lists>Allow Lists</h3><p>Allow lists (also called &ldquo;whitelists&rdquo;) are a technique to allow only certain tags to be embedded into the page. This approach is more involved, as we must first <em>parse</em> the HTML string the same way a browser would to determine what tags it contains, and then remove any tags that don&rsquo;t appear in our allow list.</p><p>Instead of writing your own code to do this, it is common practice to use a well-maintained and tested open-source library. For example, the NPM package <a href=https://www.npmjs.com/package/sanitize-html rel=external target=_blank>sanitize-html</a> provides this ability.</p><h3 id=block-lists>Block Lists</h3><p>Block lists (also called &ldquo;blacklists&rdquo;) are a similar technique, but rather than specifying a list of <em>allowed</em> tags, you specify a list of <em>disallowed</em> tags. These are then stripped from html strings. This approach is slightly less robust, as new tags are added to the HTML standard will need to be evaluated and potentially added to the block list.</p><h3 id=markdown-or-other-markup-languages>Markdown or other Markup Languages</h3><p>A final option is to have users write their contributions using Markdown or another markup language which is transformed <em>into</em> JavaScript. Markdown (used by GitHub and many other websites) is probably the best-known of these, and provides equivalents to bold, italic, headings, links, and images:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-md data-lang=md><span class=line><span class=cl><span class=gh># This is transformed into a h1 element 
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gu>## This is transformed into a h2 element
</span></span></span><span class=line><span class=cl><span class=gu></span><span class=k>&gt; </span><span class=ge>This is transformed into a blockquote 
</span></span></span><span class=line><span class=cl><span class=ge></span>_this is italicized_ <span class=ge>*as is this*</span>
</span></span><span class=line><span class=cl><span class=gs>__this is bold__</span> <span class=gs>**as is this**</span>
</span></span><span class=line><span class=cl><span class=k>*</span> this
</span></span><span class=line><span class=cl><span class=k>*</span> is
</span></span><span class=line><span class=cl><span class=k>*</span> an 
</span></span><span class=line><span class=cl><span class=k>*</span> unordered 
</span></span><span class=line><span class=cl><span class=k>*</span> list
</span></span><span class=line><span class=cl><span class=k>1.</span> this
</span></span><span class=line><span class=cl><span class=k>2.</span> is 
</span></span><span class=line><span class=cl><span class=k>3.</span> a 
</span></span><span class=line><span class=cl><span class=k>4.</span> numbered
</span></span><span class=line><span class=cl>5. list</span></span></code></pre></div><p>As it does not have conversions for <code>&lt;script></code> and other dangerous tags, HTML generated from it is relatively &ldquo;safe&rdquo; (it is still necessary to escape HTML in the original markup string though).</p><p>As with allow/block lists, Markdown and the like are usually processed with an outside library, like <a href=https://www.npmjs.com/package/markdown rel=external target=_blank>markdown-js</a>. There are similar libraries for most modern programming languages.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=full-stack-development>Full Stack Development</h1><p>Server pages represented one approach to tackling the dynamic web server challenge, and one that was especially suitable for those web developers who primarily worked with static HTML, CSS, and JavaScript backgrounds.</p><p>For those that were already skilled programmers, the custom server approach provided less confinement and greater control. But it came at a cost - the programmer had to author the entire server. Writing a server from scratch is both a <em>lot</em> of work, and also introduces many more points where design issues can lead to poor performance and vulnerable web apps.</p><p>Thus, a third approach was developed, which leveraged existing and well-suited technologies to handle some aspects of the web app needs. We can separate the needed functionality into three primary areas, each of which is tackled with a different technology:</p><ol><li>Serving static content</li><li>Creating and serving dynamic content</li><li>Providing persistent data storage</li></ol><h2 id=serving-static-content>Serving Static Content</h2><p>We&rsquo;ve already discussed file servers extensively, and even discussed some options for optimizing their performance - like caching the most frequently requested files. There are a number of software packages that have been developed and optimized for this task. Some of the best known are:</p><ul><li><a href=https://httpd.apache.org/ rel=external target=_blank>The Apache HTTP Server Project</a>, an open-source server project originally launched in 1995, and consistently the most popular server software on the Internet. The CS department website is hosted on an Apache server, as is your personal web site on the departmental server.</li><li><a href=https://www.iis.net/ rel=external target=_blank>Internet Information Services (IIS)</a>, Microsoft&rsquo;s flagship web server bundled with the Windows Server operating system.</li><li><a href=https://www.nginx.com/ rel=external target=_blank>Nginx</a> is also open-source, and intended to be a lighter-weight alternative to Apache HTTP.</li></ul><h2 id=creating-and-serving-dynamic-content>Creating and Serving Dynamic Content</h2><p>Creating and serving dynamic content is typically done by writing a custom application. As pointed out above, this can be done using any programming language. The strategies employed in such web server designs depend greatly upon the choice of language - for example, Node webservers rely heavily on asynchronous operation.</p><p>Some interpreted programming languages are typically managed by a web server like Apache, which utilizes plug-ins to run <a href=https://cwiki.apache.org/confluence/display/HTTPD/PHP rel=external target=_blank>PHP</a>, <a href=https://www.modruby.net/ rel=external target=_blank>Ruby</a>, or <a href=http://modpython.org/ rel=external target=_blank>Python</a>. Similarly, IIS runs ASP.NET program scripts written in C# or Visual Basic. This helps offset some of the time penalty incurred by creating the dynamic content with an interpreted programming language, as static content benefits from the server optimizations.</p><p>In contrast, other languages are more commonly used to write a web server that handles <em>both</em> static and dynamic content. This includes more system-oriented languages like <a href=https://isocpp.org/ rel=external target=_blank>C/C++</a>, <a href=https://www.java.com/ rel=external target=_blank>Java</a>, and <a href=https://golang.org/ rel=external target=_blank>Go</a> and more interpreted languages like <a href=https://nodejs.org/ rel=external target=_blank>Node.js</a>.</p><p>In either case, the programming language is often combined with a <em>framework</em> written in that language that provides support for building a web application. Some of the best-known frameworks (and their languages) are:</p><ul><li><a href=https://expressjs.com/ rel=external target=_blank>Express</a> (JavaScript)</li><li><a href=https://laravel.com/ rel=external target=_blank>Laravel</a> (PHP)</li><li><a href=https://flask.palletsprojects.com/en/2.0.x/ rel=external target=_blank>Flask</a> (Python)</li><li><a href=https://www.djangoproject.com/ rel=external target=_blank>Django</a> (Python)</li><li><a href=https://dotnet.microsoft.com/apps/aspnet rel=external target=_blank>ASP.NET</a> (C#)</li><li><a href=https://rubyonrails.org/ rel=external target=_blank>Ruby on Rails</a> (Ruby)</li><li><a href=https://grails.org/ rel=external target=_blank>Grails</a> (Java/Groovy)</li><li><a href=https://spring.io/ rel=external target=_blank>Spring</a> (Java)</li><li><a href=https://www.phoenixframework.org/ rel=external target=_blank>Phoenix</a> (Elixir)</li></ul><h2 id=providing-persistent-data-storage>Providing Persistent Data Storage</h2><p>While a file system is the traditional route for persistent storage of data in files, as we saw in our discussion of static file servers, holding data in memory can vastly improve server performance. However, memory is <em>volatile</em> (it is flushed when the hardware is powered down), so an ideal system combines long-term, file-based storage with in-memory caching. Additionally, <em>structured access</em> to that data (allowing it to be queried systematically and efficiently) can also greatly improve performance of a webserver.</p><p>This role is typically managed by some flavor of database application. Relational databases like the open-source <a href=https://www.mysql.com/ rel=external target=_blank>MySQL</a> and <a href=https://www.postgresql.org/ rel=external target=_blank>PostgresSQL</a>, and closed-source <a href=https://www.microsoft.com/en-us/sql-server/ rel=external target=_blank>SQL Server</a> and <a href=https://www.oracle.com/database/ rel=external target=_blank>Oracle Database</a> remain popular options. However, NoSQL databases like <a href=https://www.mongodb.com/ rel=external target=_blank>MongoDB</a> and <a href=https://couchdb.apache.org/ rel=external target=_blank>CouchDB</a> are gaining a greater market share and are ideal for certain kinds of applications. Cloud-based persistence solutions like <a href=https://firebase.google.com/ rel=external target=_blank>Google Firebase</a> are also providing new alternatives.</p><h2 id=the-stack>The Stack</h2><p>This combination of software, programming language, along with the operating system running them have come to be referred to as a <strong>stack</strong>. Web developers who understood and worked with all of the parts came to be known as <strong>full-stack developers</strong>.</p><p>Clearly, there are a <em>lot</em> of possible combinations of technologies to create a stack, so it was important to know <em>which</em> stacks with which a developer was working. For convenience, the stacks often came to be referred to by acronyms. Some common stacks you will hear of are:</p><ul><li><strong>LAMP (Linux, Apache, MySQL, PHP)</strong> - the granddaddy of stacks, composed entirely of open-source, free software packages.</li><li><strong>LEMP (Linux, Nginx, MySQL, PHP)</strong> - basically LAMP substituting the Nginx server for Apache</li><li><strong>MEAN (MongoDB, Express, Angular, Node)</strong> - Also entirely open-source</li></ul><p>Microsoft has their own traditional stack <strong>ASP.NET</strong>, which is built on Windows Server (the OS), IIS (Internet Information Services, the webserver), a .NET language like C# or Visual Basic, and MSSQL. With the launch of .NET Core, you can now also build a .NET stack running on a Linux OS.</p><p>Additionally, frameworks like <a href=https://www.djangoproject.com/ rel=external target=_blank>Django</a>, <a href=https://rubyonrails.org/ rel=external target=_blank>Ruby on Rails</a>, <a href=https://expressjs.com/ rel=external target=_blank>Express</a>, <a href=https://laravel.com/ rel=external target=_blank>Laravel</a>, etc. often incorporate preferred stacks (though some parts, specifically the server and database, can typically be swapped out).</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>Somewhat confusingly, cloud technologies often replace the traditional webserver role completely, leaving the client-side JavaScript talking to a number of web services. We&rsquo;ll discuss this approach in a few chapters.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><p>In this chapter we have learned about several approaches to creating dynamic web servers, including <em>server pages</em>, <em>custom web servers</em>, and <em>full stack development</em>, often using a <em>web development framework</em>. We also learned how dynamic webservers can handle data and file uploads from HTML forms, as well as some security concerns involved. We also saw how state can be introduced to web apps using <em>cookies</em> and <em>sessions</em>.</p><p>In the next few chapters, we&rsquo;ll explore these ideas in more detail.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 7</div><h1 id=persistent-storage>Persistent Storage</h1><p>Tupperware for the Web</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Persistent Storage</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>Of course, what made dynamic web servers interesting was that they could provide content built <em>dynamically</em>. In this approach, the HTML the server sends as a response does not need to be stored on the server as a HTML file, rather it can be constructed when a request is made.</p><p>That said, most web applications still need a persistent storage mechanism to use in dynamically creating those pages. If we&rsquo;re dealing with a forum, we need to store the text for the posts. If we&rsquo;re running an e-commerce site, we aren&rsquo;t making up products, we&rsquo;re selling those already in our inventory.</p><p>Thus, we need some kind of storage mechanism to hold the information we need to create our dynamic pages. We could use a variable and hold those values in memory, but we&rsquo;d also need a mechanism to <em>persist</em> those values when our server restarts (as the contents of volatile memory are lost when power is no longer supplied to RAM).</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=data-serialization>Data Serialization</h1><p>Perhaps the simplest persistent storage mechanism we can adopt is to use a combination of an in-memory variable and a file. For example, we could set up a simple database mechanism as a Node module:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** @module database 
</span></span></span><span class=line><span class=cl><span class=cm> * A simple in-memory database implementation, 
</span></span></span><span class=line><span class=cl><span class=cm> * providing a mechanism for getting and saving 
</span></span></span><span class=line><span class=cl><span class=cm> * a database object
</span></span></span><span class=line><span class=cl><span class=cm> */</span> 
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>get</span><span class=p>,</span> <span class=nx>set</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// We retrieve and deserialize the database from 
</span></span></span><span class=line><span class=cl><span class=c1>// a file named data.json.  We deliberately don&#39;t 
</span></span></span><span class=line><span class=cl><span class=c1>// catch errors, as if this process fails, we want 
</span></span></span><span class=line><span class=cl><span class=c1>// to stop the server loading process
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>fileData</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;data.json&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>fileData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** @function get()
</span></span></span><span class=line><span class=cl><span class=cm> * Returns the database object 
</span></span></span><span class=line><span class=cl><span class=cm> * @returns {object} data - the data object
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>get</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** @function set()
</span></span></span><span class=line><span class=cl><span class=cm> * Saves the provided object as the database data, 
</span></span></span><span class=line><span class=cl><span class=cm> * overwriting the current object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {object} newData - the object to save 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {function} callback - triggered after save 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>set</span><span class=p>(</span><span class=nx>newData</span><span class=p>,</span> <span class=nx>callback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Here we don&#39;t want the server to crash on 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// an error, so we do wrap it in a try/catch
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>fileData</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>newData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>fs</span><span class=p>.</span><span class=nx>writeFile</span><span class=p>(</span><span class=s2>&#34;data.json&#34;</span><span class=p>,</span> <span class=nx>fileData</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// If there was an error writing the data, we pass it 
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// forward in the callback and don&#39;t save the changes
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// to the data object
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>callback</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// If there was no error, we save the changes to the 
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// module&#39;s data object (the variable data declared above)
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>data</span> <span class=o>=</span> <span class=nx>newData</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Then we invoke the callback to notify of success by sending 
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// a value of null for the error
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>callback</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If we catch an error in the JSON stringification process,
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// we&#39;ll pass it through the callback 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>callback</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>In this module, we exploit a feature of Node&rsquo;s <a href=https://nodejs.org/en/knowledge/getting-started/what-is-require/ rel=external target=_blank>require</a>, in that it <em>caches</em> the value returned by the <code>require()</code> function for each unique argument. So the first time we use <code>require('./database')</code>, we process the above code. Node internally stores the result (an object with the <code>get()</code> and <code>set()</code> method) in its module cache, and the next time we use <code>require('./database')</code> in our program, this object is what is required. Effectively, you end up using the same <code>data</code> variable every time you <code>require('./database')</code>. This is an application of the <a href=https://en.wikipedia.org/wiki/Singleton_pattern rel=external target=_blank>Singleton Pattern</a> in a form unique to Node.</p><h2 id=refactoring-for-better-error-prevention>Refactoring for Better Error Prevention</h2><p>While this module can work well, it does suffer from a number of limitations. Perhaps the most important to recognize is that the <code>get()</code> method returns a reference to our aforementioned <code>data</code> variable - so if you change the value of the variable, you change it for all future <code>get()</code> function calls, while sidestepping the persistent file write embodied in our <code>set()</code>. Instead of providing a reference, we could instead provide a copy. A simple trick to do so in JavaScript is to serialize and then deserialize the object (turning it into a JSON string and then back into an object). The refactored <code>get()</code> would then look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/** @function get()
</span></span></span><span class=line><span class=cl><span class=cm> * Returns A COPY OF the database object 
</span></span></span><span class=line><span class=cl><span class=cm> * @returns {object} data - A COPY OF the data object
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>get</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Note that there is a possibility this process can fail, so it really should be wrapped in a <code>try/catch</code> and refactored to use a callback to pass on this possible error and the data object:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/** @function get()
</span></span></span><span class=line><span class=cl><span class=cm> * Provides a copy of the data object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {function} callback - Provides as the first parameter any errors, 
</span></span></span><span class=line><span class=cl><span class=cm> * and as the second a copy of the data object.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>get</span><span class=p>(</span><span class=nx>callback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>dataCopy</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nx>callback</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>dataCopy</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>callback</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Notice that with this refactoring, we are using the same pattern common to the Node modules we&rsquo;ve been working with. There is a second benefit here is that if we needed to convert our <code>get()</code> from a synchronous to asynchronous implementation, our function definition won&rsquo;t change (the <code>set()</code> is already asynchronous, as we use the asynchronous <code>fs.writeFile()</code>).</p><h2 id=other-limitations>Other Limitations</h2><p>This database implementation is still pretty basic - we retrieve an entire object rather than just the portion of the database we need, and we write the entire database on every change as well. If our database gets to be very large, this will become an expensive operation.</p><p>There is also a lot of missed opportunity for optimizing how we get the specific data we need. As you have learned in your algorithms and data structures course, the right search algorithm, coupled with the right data structure, can vastly improve how quickly your program can run. If we think about the work that a webserver does, the retrieval of data for building dynamic HTML based on it is easily one of the most time-consuming aspects, so optimizing here can make each page creation move much faster. Faster page creation means shorter response times, and more users served per minute with less processing power. That, in turn means less electricity, less bandwidth, and less hardware is required to run your website. In heavily utilized websites, this can equate to a lot of savings! And for websites hosted on elastic hosting services (those that only charge for the resources you use), it can also result in significant savings.</p><p>Thus, we might want to spend more time developing a robust database program that would offer these kinds of optimizations. Or, we could do what most full-stack developers do, and use an already existing database program that was designed with these kinds of optimizations in mind. We&rsquo;ll take a look at that approach next.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=databases>Databases</h1><p>As we suggested in the previous section, using an already existing database application is a very common strategy for full-stack web development. Doing so has clear benefits - such programs are typically stable, secure, and optimized for data storage and retrieval. They are well beyond what we can achieve ourselves without a significant investment of time, and avoids the necessity of &ldquo;reinventing the wheel&rdquo;.</p><p>That said, making effective use of a third-party database system <em>does</em> require you to develop familiarity with how the database operates and is organized. Gaining the benefits of a database&rsquo;s optimizations requires structuring your data in the way its developers anticipated, and likewise retrieving it in such a manner. The exact details involved vary between database systems and are beyond the scope of this course, which is why you have a database course in your required curriculum. Here I will just introduce the details of how to integrate the use of a database into your web development efforts, and I&rsquo;ll leave the learning of how to best optimize your database structure and queries for that course.</p><p>In the web development world, we primarily work with two kinds of databases, which have a very different conceptual starting point that determines their structure. These are <a href=https://en.wikipedia.org/wiki/Relational_database rel=external target=_blank>Relational Databases</a> and <a href=https://en.wikipedia.org/wiki/Document-oriented_database rel=external target=_blank>Document-oriented Databases</a> (sometimes called No-SQL databases). There is a third category, <a href=https://en.wikipedia.org/wiki/Object_database rel=external target=_blank>Object-oriented Databases</a> that are not widely adopted, and a slew of less-well known and utilized technologies. There are also cloud services that take over the role traditionally filled by databases, which we&rsquo;ll save for a later chapter. For now, we&rsquo;ll focus on the first two, as these are the most commonly adopted in the web development industry.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=relational-databases>Relational Databases</h1><p>Relational databases (also called SQL databases) provide a highly-structured storage mechanism. Data is organized into <em>tables</em>, with each column representing a single value and data type, and each row representing one entry. Conceptually, this organization is similar to tables you have seen in Excel and on the web. An example <em>persons</em> table is listed below:</p><table><thead><tr><th>id</th><th>First</th><th>Last</th></tr></thead><tbody><tr><td>0</td><td>Lisa</td><td>Merkowsky</td></tr><tr><td>1</td><td>Frank</td><td>Stiles</td></tr><tr><td>3</td><td>Mary</td><td>Cotts</td></tr></tbody></table><p>Relational databases are often called SQL databases as we use <em>Structured Query Language (SQL)</em> to communicate with them. This is a domain-specific language similar to the LINQ you may have learned about in CIS 400 (actually, LINQ derives much of its syntax from SQL). Queries are streamed to a relational database across a socket or other connection, much like HTTP requests and responses are. The response is received also as text which must be parsed to be used.</p><p>SQL is used to construct the structure of the database. For example, we could create the above table with the SQL command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>persons</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>Last</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>First</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span></span></span></code></pre></div><p>SQL is also used to <em>query</em> the database. For example, to find all people with the last name &ldquo;Smith&rdquo;, we would use the query:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>persons</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=k>last</span><span class=o>=</span><span class=s1>&#39;Smith&#39;</span><span class=p>;</span></span></span></code></pre></div><p>You will learn more about writing SQL queries in the CIS 560 or CC 520 course. You can also find an excellent guide on <a href=https://www.w3schools.com/sql/ rel=external target=_blank>W3C schools</a>, with interactive tutorials. We&rsquo;ll briefly cover some of the most important aspects of relational databases for web developers here, but you would be wise to seek out additional learning opportunities. Understanding relational databases well can make a great deal of difference in how performant your web applications are.</p><p>The key to performance in relational databases is the use of <em>keys</em> and <em>indices</em>. A key is a column whose values are unique (not allowed to be repeated). For example, the <code>id</code> column in the table above is a key. Specifically, it is a sequential primary key - for each row we add to the table it increases, and its value is determined by the database. Note the jump from <code>1</code> to <code>3</code> - there is no guarantee the keys will always be exactly one more than the previous one (though it commonly is), and if we delete rows from a table, the keys remain the same.</p><h3 id=indices>Indices</h3><p>An index is a specialized data structure that makes searching for data faster. Consider the above table. If we wanted to find all people with the last name &ldquo;Smith&rdquo;, we&rsquo;d need to iterate over each row, looking for &ldquo;Smith&rdquo;. That is a linear $O(n)$ complexity. It would work quickly in our example, but when our table has thousands or millions of rows (not uncommon for large web apps), it would be painfully slow.</p><p>Remember learning about dictionaries or hash tables in your data structures course? The lookup time for one of those structures is constant $O(1)$. Indices work like this - we create a specialized data structure that can provide the index we are looking for, i.e. an index built on the <code>Last</code> column would map <code>last => id</code>. Then we could retrieve all &ldquo;Smith&rdquo; last names from this structure in constant time $O(1)$. Since we know the primary key is unique and ordered, we can use some kind of divide-and-conquer search strategy to find all rows with a primary key in our set of matches, with a complexity of $O(log(n))$. Thus, the complete lookup would be $O(log(n)) + O(1)$, which we would simplify to $O(log(n))$, much faster for a large $n$ than $O(n)$.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>In truth, most SQL databases use <a href=https://en.wikipedia.org/wiki/B-tree rel=external target=_blank>Balanced Trees (B-Trees)</a> for their indices; but the exact data structure is unimportant to us as web developers, as long as retrieval is efficient.</p></div></div><p>We can create an index using SQL. For example, to create an index on the column <code>last</code> in our example, we would use:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>last_index</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>persons</span><span class=w> </span><span class=p>(</span><span class=k>last</span><span class=p>);</span></span></span></code></pre></div><p>An index can involve more than one row - for example, if we expected to search by both first and last name, we&rsquo;d probably create an index that used both as the key. The SQL to do so for both first and last names would be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>both_names</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>persons</span><span class=w> </span><span class=p>(</span><span class=k>last</span><span class=p>,</span><span class=w> </span><span class=k>first</span><span class=p>);</span></span></span></code></pre></div><p>Each index effectively creates a new data structure consuming additional memory, so you should consider which indices are really necessary. Any column or column you frequently look up values by (i.e. are part of the WHERE clause of a query) should be indexed. Columns that are only rarely or never used this way should not be included in indices.</p><h3 id=relationships>Relationships</h3><p>The second important idea behind a relational database is that we can define relationships <em>between</em> tables. Let&rsquo;s add a second table to our example, <em>addresses</em>:</p><table><thead><tr><th>id</th><th>person_id</th><th>street</th><th>city</th><th>state</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>Anderson Ave.</td><td>Manhattan</td><td>KS</td></tr><tr><td>1</td><td>1</td><td>Sesame St.</td><td>Baltimore</td><td>ML</td></tr><tr><td>2</td><td>1</td><td>Moholland Dr.</td><td>Hollywood</td><td>CA</td></tr><tr><td>3</td><td>3</td><td>Cooper Street</td><td>Silver City</td><td>NM</td></tr></tbody></table><p>Here <code>person_id</code> is a <em>foreign key</em>, and corresponds to the <code>id</code> in the <em>persons</em> table. Thus, we can look up the address of Lisa Merkowsky by her <code>id</code> of 0. The row in the <em>addresses</em> table with the value of 0 for <code>person_id</code> is &ldquo;Anderson Ave., Manhattan KS&rdquo;.</p><p>Note too that it is possible for one row in one table to correspond to more than one row in another - in this example Frank Styles has <em>two</em> addresses, one in Baltimore and one in Hollywood.</p><p>If one row in one table corresponds to a single row in another table, we often call this a <em>one-to-one</em> relationship. If one row corresponds to more than one row in another table, we call this a <em>one-to-many</em> relationship. We retrieve these values using a query with a JOIN clause, i.e. to get each person with their addresses, we might use:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=k>last</span><span class=p>,</span><span class=w> </span><span class=k>first</span><span class=p>,</span><span class=w> </span><span class=n>street</span><span class=p>,</span><span class=w> </span><span class=n>city</span><span class=p>,</span><span class=w> </span><span class=k>state</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>persons</span><span class=w> </span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>addresses</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>persons</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addresses</span><span class=p>.</span><span class=n>person_id</span><span class=p>;</span></span></span></code></pre></div><p>The result will also be structured as a table with columns <code>last</code>, <code>first</code>, <code>street</code>, <code>city</code>, and <code>state</code> containing a row for each person. Actually, there will be <em>two</em> rows for Frank, one containing each of his two addresses.</p><p>Finally, it is possible to have a <em>many-to-many</em> relationship, which requires a special table to sit in between the two called a <em>join</em> table. Consider if we had a <em>jobs</em> table:</p><table><thead><tr><th>id</th><th>name</th><th>description</th></tr></thead><tbody><tr><td>0</td><td>Doctor</td><td>A qualified practitioner of medicine; a physician.</td></tr><tr><td>1</td><td>Lawyer</td><td>A person who practices or studies law; an attorney or a counselor.</td></tr><tr><td>2</td><td>Producer</td><td>A person responsible for the financial and managerial aspects of making of a movie or broadcast or for staging a play, opera, etc.</td></tr><tr><td>3</td><td>Detective</td><td>A person, especially a police officer, whose occupation is to investigate and solve crimes.</td></tr></tbody></table>(definitions provided by Oxford Languages)<p>Because more than one person can have the same job, and we might want to look up people by their jobs, or a list of jobs that a specific person has, we would need a join table to connect the two. This could be named <em>persons_jobs</em> and would have a foreign key to both:</p><table><thead><tr><th>id</th><th>person_id</th><th>job_id</th></tr></thead><tbody><tr><td>0</td><td>1</td><td>1</td></tr><tr><td>1</td><td>2</td><td>2</td></tr><tr><td>2</td><td>3</td><td>1</td></tr><tr><td>3</td><td>3</td><td>3</td></tr></tbody></table><p>Thus Lisa is a doctor, Frank a producer, and Mary is both a doctor and detective! We could query for every doctor using a SQL statement with two joins, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=k>first</span><span class=p>,</span><span class=w> </span><span class=k>last</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>jobs</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>persons_jobs</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>jobs</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>persons_jobs</span><span class=p>.</span><span class=n>job_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>persons</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>jobs_persons</span><span class=p>.</span><span class=n>person_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>person</span><span class=p>.</span><span class=n>id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>jobs</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Doctor&#39;</span><span class=p>;</span></span></span></code></pre></div><p>As suggested before, this is just scraping the surface of relational databases. You&rsquo;ll definitely want to spend more time studying them, as they remain the most common form of persistent storage used on the web and in other industries as well.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=sql-injection>SQL Injection</h1><p>Along with the use of relational databases and SQL comes one very important attack to be aware of - SQL injection. This attack takes advantage of the way many developers write SQL queries within their programs. Consider the simple relational database we laid out earlier. Let&rsquo;s assume our web application lets us search for people by their last names. To find Mary Cotts, we would then need a SQL query like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>people</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=k>last</span><span class=o>=</span><span class=s1>&#39;Cotts&#39;</span><span class=p>;</span></span></span></code></pre></div><p>Since we want our <em>users</em> to be able to specify who to look for, we&rsquo;d probably give them a search form in our HTML, something like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>label</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;last&#34;</span><span class=p>&gt;</span>Last Name:<span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;last&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;Search&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span></span></span></code></pre></div><p>And in our code, extract the <code>name</code> value from the query string and use it to construct the SQL query using string concatenation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>querystring</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;querystring&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>url</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=s2>&#34;http://localhost&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>qs</span> <span class=o>=</span> <span class=nx>querystring</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>url</span><span class=p>.</span><span class=nx>search</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>qs</span><span class=p>.</span><span class=nx>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>query</span> <span class=o>=</span> <span class=sb>`SELECT * FROM people WHERE last=&#39;</span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb>&#39;;`</span><span class=p>;</span></span></span></code></pre></div><p>The problem with this approach is a savvy adversary could submit a &ldquo;name&rdquo; that completes the SQL command and begins a new one, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>bob&#39;; UPDATE users SET admin=true WHERE username=&#39;saavyhacker</span></span></code></pre></div><p>Our naive concatenation approach then creates <em>two</em> SQL commands:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>people</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=k>last</span><span class=o>=</span><span class=s1>&#39;bob&#39;</span><span class=p>;</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=k>admin</span><span class=o>=</span><span class=k>true</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>username</span><span class=o>=</span><span class=s1>&#39;saavyhacker&#39;</span><span class=p>;</span></span></span></code></pre></div><p>When we run this query, our savvy hacker just made themselves an admin on our site (assuming our database has a users table with an admin column we use to determine their role)!</p><p>This is just the tip of the iceberg for SQL injection attacks - there are many, many variations on the theme.</p><h2 id=preventing-sql-injection>Preventing SQL Injection</h2><p>Every database driver provides the ability to build parameterized queries, i.e. a preformatted query that has &ldquo;slots&rdquo; where you assign values to. The exact mechanism to use these depends on the driver you are using to connect to the database. For example, if we were using the <a href=/cis526/07-persistent-storage/05-sql-injection/>node-sqlite3</a> driver to connect our Node application to a SQLite database, we would use:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>querystring</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;querystring&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>url</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=s2>&#34;http://localhost&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>qs</span> <span class=o>=</span> <span class=nx>querystring</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>url</span><span class=p>.</span><span class=nx>search</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>qs</span><span class=p>.</span><span class=nx>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>query</span> <span class=o>=</span> <span class=sb>`SELECT * FROM people WHERE last=?;`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// assuming a variable db is declared 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=nx>query</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// do something with result...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span></span></span></code></pre></div><p>Because the slot corresponds to a specific column, the database engine converts the supplied argument to that type before applying it In this case, if our canny hacker uses his string, it would be interpreted as the literal last name &ldquo;bob&rsquo;; UPDATE users SET admin=true WHERE username=&lsquo;saavyhacker&rdquo;. Which probably wouldn&rsquo;t exist in our database, because what kind of parent would saddle a child with such a name?</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p><a href=#R-image-4145005ba66c78546a9702caeb46879e class=lightbox-link><img alt="XKCD&rsquo;s Exploits of a Mom" class="border lazy lightbox noshadow figure-image" loading=lazy src=https://imgs.xkcd.com/comics/exploits_of_a_mom.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4145005ba66c78546a9702caeb46879e><img alt="XKCD&rsquo;s Exploits of a Mom" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=https://imgs.xkcd.com/comics/exploits_of_a_mom.png></a>
<a href=https://xkcd.com/327/ rel=external target=_blank>XKCD&rsquo;s Exploits of a Mom</a></p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=object-relational-mapping>Object-Relational Mapping</h1><p>If you think learning and writing SQL looks challenging, you&rsquo;re not alone. Early full-stack developers did as well. In addition, there was the additional need to convert the responses from the relational database from text into objects the program could use. It shouldn&rsquo;t be surprising that libraries quickly were adopted to manage this process. The most basic of these are <em>drivers</em>, simple programs which manage the connection between the database and the program using it, sending SQL queries to the database and parsing the results into data types native to the language (usually an array of arrays or an array of dictionaries - the outer array for the rows, and the inner array or dictionary for the column values within the row).</p><p>However, the use of drivers was soon supplanted by <a href=https://en.wikipedia.org/wiki/Object-relational_mapping rel=external target=_blank>Object Relational Mapping (ORM)</a>, a software layer that sits between the database and the dynamic web server program. But unlike a driver, ORM libraries provide additional conversion logic. Most will convert function calls to SQL statements and execute them on the server, and all will convert the results of a query into an object in the language of the server.</p><p>Let&rsquo;s look at a few ORMs in practice.</p><h2 id=activerecord>ActiveRecord</h2><p>The <a href=https://guides.rubyonrails.org/active_record_basics.html rel=external target=_blank>ActiveRecord</a> ORM is part of the <a href=https://guides.rubyonrails.org/ rel=external target=_blank>Ruby on Rails</a> framework. It takes advantage of the Ruby programming language&rsquo;s dynamic nature to vastly simplify the code a developer must write to use a database. If we use our previous example of the database containing <em>persons</em>, <em>addresses</em>, and <em>jobs</em> tables, we would write classes to represent each table that inherit from the <code>ActiveRecord</code> base class:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># persons.rb</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Person</span> <span class=o>&lt;</span> <span class=no>ApplicationRecord</span> 
</span></span><span class=line><span class=cl>  <span class=n>has_many</span> <span class=ss>:addresses</span>
</span></span><span class=line><span class=cl>  <span class=n>has_and_belongs_to_many</span> <span class=ss>:jobs</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># addresses.rb </span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Address</span> <span class=o>&lt;</span> <span class=no>ApplicationRecord</span> 
</span></span><span class=line><span class=cl>  <span class=n>belongs_to</span> <span class=ss>:person</span> 
</span></span><span class=line><span class=cl><span class=k>end</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># jobs.rb </span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Job</span> <span class=o>&lt;</span> <span class=no>ApplicationRecord</span> 
</span></span><span class=line><span class=cl>    <span class=n>has_and_belongs_to</span> <span class=ss>:person</span>
</span></span><span class=line><span class=cl><span class=k>end</span></span></span></code></pre></div><p>Then, to retrieve all people we would use a query method of the <code>Job</code> class::</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>allPeople</span> <span class=o>=</span> <span class=no>Person</span><span class=o>.</span><span class=n>all</span><span class=p>()</span></span></span></code></pre></div><p>Or to retrieve all doctors, we would use a query method of the <code>Job</code> class:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>allDoctors</span> <span class=o>=</span> <span class=no>Person</span><span class=o>.</span><span class=n>includes</span><span class=p>(</span><span class=ss>:jobs</span><span class=p>)</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=ss>jobs</span><span class=p>:</span> <span class=p>{</span><span class=nb>name</span><span class=p>:</span> <span class=s2>&#34;Doctor&#34;</span><span class=p>})</span></span></span></code></pre></div><p>While we haven&rsquo;t been working in the Ruby language, I show this to help you understand just how far from SQL some ORMs go. For a Ruby programmer, this is far more comfortable syntax than SQL, much like LINQ&rsquo;s method syntax is often more comfortable to C# programmers.</p><p>That said, there are always some queries - especially when we&rsquo;re trying to squeeze out the most efficiency possible or working with a convoluted database - that are beyond the simple conversion abilities of an ORM to manage. So most ORMs offer a way to run a SQL query directly on the database as well.</p><p>Finally, you should understand that any ORM that provides a functional interface for constructing SQL queries is effectively a domain-specific language that duplicates the functionality of SQL. The SQL generated by these libraries can be far less efficient than a hand-written SQL query written by a knowledgeable programmer. While it can be more comfortable to program in, it may be more valuable to spend the effort developing a solid understanding of SQL and how relational databases work.</p><h2 id=entity-framework>Entity Framework</h2><p>The .NET platform has its own ORM similar to ActiveRecord, the <a href=https://docs.microsoft.com/en-us/ef/ rel=external target=_blank>Entity Framework</a>. Like ActiveRecord, you can create the entire database by defining model objects, and then generating migration scripts that will create the database to match (this is called <em>code first migrations</em> in entity framework lingo). As with ActiveRecord, you must define the relationships between tables. To set up the objects (and tables) we saw in the ActiveRecord example, we would write:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>Person</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=n>ID</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>LastName</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>FirstName</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Address</span> <span class=n>Address</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>ICollection</span><span class=p>&lt;</span><span class=n>Job</span><span class=p>&gt;</span> <span class=n>Jobs</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>Address</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=n>ID</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>Line1</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>Line2</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>City</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>State</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=n>Zip</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>ICollection</span><span class=p>&lt;</span><span class=n>People</span><span class=p>&gt;</span> <span class=n>People</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>Job</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=n>ID</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>Name</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>ICollection</span><span class=p>&lt;</span><span class=n>Person</span><span class=p>&gt;</span> <span class=n>People</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Note that this is a lot more verbose; the Entity Framework approach doesn&rsquo;t rely on the database telling it what the available, columns are, rather the model classes are used to determine what the database should be. We also have to set up the relationships, which are done using a class that extends <a href="https://docs.microsoft.com/en-us/dotnet/api/system.data.entity.dbcontext?view=entity-framework-6.2.0" rel=external target=_blank><code>DbContext</code></a>, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>ExampleContext</span> <span class=p>:</span> <span class=n>DbContext</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>DbSet</span><span class=p>&lt;</span><span class=n>Person</span><span class=p>&gt;</span> <span class=n>Persons</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>DbSet</span><span class=p>&lt;</span><span class=n>Address</span><span class=p>&gt;</span> <span class=n>Addresses</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>DbSet</span><span class=p>&lt;</span><span class=n>Job</span><span class=p>&gt;</span> <span class=n>Jobs</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kd>override</span> <span class=k>void</span> <span class=n>OnModelCreating</span><span class=p>(</span><span class=n>ModelBuilder</span> <span class=n>modelBuilder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>modelBuilder</span><span class=p>.</span><span class=n>Entity</span><span class=p>&lt;</span><span class=n>Person</span><span class=p>&gt;().</span><span class=n>ToTable</span><span class=p>(</span><span class=s>&#34;People&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>modelBuilder</span><span class=p>.</span><span class=n>Entity</span><span class=p>&lt;</span><span class=n>Address</span><span class=p>&gt;().</span><span class=n>ToTable</span><span class=p>(</span><span class=s>&#34;Addresses&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>modelBuilder</span><span class=p>.</span><span class=n>Entity</span><span class=p>&lt;</span><span class=n>Job</span><span class=p>&gt;().</span><span class=n>ToTable</span><span class=p>(</span><span class=s>&#34;Jobs&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>modelBuilder</span><span class=p>.</span><span class=n>Entity</span><span class=p>&lt;</span><span class=n>JobPerson</span><span class=p>&gt;().</span><span class=n>ToTable</span><span class=p>(</span><span class=s>&#34;JobsPersons&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>modelBuilder</span><span class=p>.</span><span class=n>Entity</span><span class=p>&lt;</span><span class=n>Person</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>HasOne</span><span class=p>(</span><span class=n>a</span> <span class=p>=&gt;</span> <span class=n>a</span><span class=p>.</span><span class=n>Address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>WithMany</span><span class=p>(</span><span class=n>b</span> <span class=p>=&gt;</span> <span class=n>b</span><span class=p>.</span><span class=n>Persons</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>modelBuilder</span><span class=p>.</span><span class=n>Entity</span><span class=p>&lt;</span><span class=n>Person</span><span class=p>&gt;().</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>HasMany</span><span class=p>(</span><span class=n>a</span> <span class=p>=&gt;</span> <span class=n>a</span><span class=p>.</span><span class=n>Jobs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>WithMany</span><span class=p>(</span><span class=n>b</span> <span class=p>=&gt;</span> <span class=n>b</span><span class=p>.</span><span class=n>Persons</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Note the use of the <code>.HasOne()</code> and <code>.HasMany()</code> methods to set up the relationships between the tables. With this established, we can run queries using an instance of the <code>ExampleContext</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kt>var</span> <span class=n>context</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ExampleContext</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get all people</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>allPeople</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>Person</span><span class=p>.</span><span class=n>All</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get all doctors</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>allDoctors</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>Person</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>Include</span><span class=p>(</span><span class=n>p</span> <span class=p>=&gt;</span> <span class=n>p</span><span class=p>.</span><span class=n>Jobs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>Where</span><span class=p>(</span><span class=n>p</span> <span class=p>=&gt;</span> <span class=n>p</span><span class=p>.</span><span class=n>Jobs</span><span class=p>.</span><span class=n>Includes</span><span class=p>(</span><span class=n>j</span> <span class=p>=&gt;</span> <span class=n>j</span><span class=p>.</span><span class=n>Name</span> <span class=p>==</span> <span class=s>&#34;Doctor&#34;</span><span class=p>));</span></span></span></code></pre></div><h2 id=massive>Massive</h2><p>For Node applications, I&rsquo;ve really come to prefer <a href=https://massivejs.org/ rel=external target=_blank>MassiveJS</a>, an ORM for the Postgres relational database. Like other ORMs, it converts query results into a JavaScript object or array of objects, with the column names as keys and values as values, converted to the appropriate type.</p><p>It does provide a slew of functions for generating queries programmatically, like other ORMs. But it also allows you to specify a folder in your project where you can place SQL files that are automatically converted to JavaScript functions that correspond to parameterized queries in the sql files. For example, to do our &ldquo;All doctors&rdquo; query, we would write a file <em>scripts/allDoctors.sql</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>persons</span><span class=w> </span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>jobs_persons</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>persons</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jobs_persons</span><span class=p>.</span><span class=n>person_id</span><span class=w> </span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>jobs</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>jobs</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jobs_persons</span><span class=p>.</span><span class=n>job</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>jobs</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;Doctor&#34;</span><span class=p>;</span></span></span></code></pre></div><p>While this may seem less convenient than the ActiveRecord or Entity Framework approaches, it is immediately clear to a seasoned SQL programmer what the tables involved are and how they are related. Moreover, a good SQL programmer can often write a more efficient query than an ORM library can generate.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 8</div><h1 id=routing>Routing</h1><p>Are we there yet?</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Routing</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>Once again, we&rsquo;ll return to the request-response pattern diagram.</p><p><a href=#R-image-23c2ac4b681ffd2d8efc6a268d797258 class=lightbox-link><img alt="The Request-Response Pattern" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/8.0.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-23c2ac4b681ffd2d8efc6a268d797258><img alt="The Request-Response Pattern" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/8.0.1.png></a></p><p>We revisit this diagram because it is so central to how HTTP servers work. At the heart, a server&rsquo;s primary responsibility is to respond to an incoming request. Thus, in <em>writing</em> a web server, our primary task is to determine what to respond with. With static web servers, the answer is pretty simple - we map the virtual path supplied by the URL to a file path on the file server. But the URL supplied in a request <em>doesn&rsquo;t</em> have to correspond to any real object on the server - we can create any object we want, and send it back.</p><p>In our examples, we&rsquo;ve built several functions that build specific kinds of responses. Our <code>serveFile()</code> function serves a response representing a static file. Our <code>listDirectory()</code> function generates an index for a directory, or if the directory contained a <code>index.html</code> file, served it instead. And our dynamic <code>servePost()</code> from our blog served a dynamically generated HTML page that drew data from a database.</p><p>Each of these functions created a <em>response</em>. But how do we know which of them to use? That is the question that we will be grappling with in this chapter - and the technical term for it is <em>routing</em>.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=request-routing>Request Routing</h1><p>In web development, routing refers to the process of matching an incoming request with generating the appropriate response. For most web servers (and definitely for Node-based ones), we abstract the process of generating the response into a function. We often call these functions <em>endpoints</em> as their purpose is to serve the response, effectively ending the processing of an incoming request with an appropriate response.</p><p>With a Node webserver, endpoint functions typically take in a <code>req</code> (an instance of http.IncomingMessage) and <code>res</code> (an instance of http.ServerResponse) objects. These objects form an abstraction around the HTTP request and response.</p><p>Routing in a Node webserver therefore consists of examining the properties of the <code>req</code> object and determining which endpoint function to invoke. Up to this point, we&rsquo;ve done this logic in a <code>handleRequest()</code> function, in a fairly ad-hoc way. Consider what we might need to do for a dynamically generated blog - we&rsquo;d need to serve static files (like CSS and JS files), as well as dynamically generated pages for blog posts and the home page. What might our <code>handleRequest()</code> look like in that case?</p><p>Let&rsquo;s assume we have a <code>serveHome()</code> function to serve the home page, a <code>serveFile()</code> function to serve static files, and a <code>servePost()</code> function to serve dynamically generated posts. Determining if the request is for the homepage is easy, as we know the path should just be a forward slash:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>    <span class=c1>// Determine if the request is for the index page
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span> <span class=o>===</span> <span class=s1>&#39;/&#39;</span><span class=p>)</span> <span class=k>return</span> <span class=nx>serveHome</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span></span></span></code></pre></div><p>But what about determining if a request is for a post or a static file? We could use <code>fs.stat</code> to determine if a file exists:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>    <span class=c1>// Determine if a corresponding file exists 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fs</span><span class=p>.</span><span class=nx>stat</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=s2>&#34;public&#34;</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>),</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>stat</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Error reading file, might be a post?
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>servePost</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// File exists, serve it 
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>serveFile</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span></span></span></code></pre></div><p>This would work, but it&rsquo;s a bit ugly. Also, using a filesystem method like <code>fs.stat</code> is potential bottleneck in our application; we&rsquo;d like to avoid it if at all possible.</p><p>If we make all our posts use the url <code>/posts</code>, we could use the query string to determine which post we want to display. This approach is a bit cleaner, though it does mean we need to separate the pathname from our URL:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>public</span> <span class=nx>handleRequest</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Separate the pathname from the url 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>pathname</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=s2>&#34;http://localhost&#34;</span><span class=p>).</span><span class=nx>pathname</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Determine if the request is for the index page
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=nx>pathname</span> <span class=o>===</span> <span class=s1>&#39;/&#39;</span><span class=p>)</span> <span class=k>return</span> <span class=nx>serveHome</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Determine if the request is for a post 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=nx>pathname</span> <span class=o>===</span> <span class=s1>&#39;/post&#39;</span><span class=p>)</span> <span class=k>return</span> <span class=nx>servePost</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Treat all other requests as a file 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>serveFile</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>This is a bit cleaner of an approach, but it still has a very ad-hoc feel and requires us to incorporate query strings into some of our URLs.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=resources>Resources</h1><p>As the web transitioned to dynamic pages, the concept of the URL path evolved. With a static server, the path indicates an actual file that exists on the fileserver. But with dynamic pages, the url doesn&rsquo;t have to correspond to anything real. Consider the case of <a href=https://placeholder.com/ rel=external target=_blank>Placeholder.com</a>, a service that offers image URLs you can use in a site layout to simulate images. For example, the image below is generated by the site by using the URL By using the URL <code>//via.placeholder.com/350x150</code>:</p><p><a href=#R-image-489a833907a03d68b8ea5599bed963d9 class=lightbox-link><img alt="350 x 150 pixel placeholder image" class="border lazy lightbox noshadow figure-image" loading=lazy src=https://via.placeholder.com/350x150 style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-489a833907a03d68b8ea5599bed963d9><img alt="350 x 150 pixel placeholder image" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=https://via.placeholder.com/350x150></a></p><p>Does Placeholder.com have thousands of images of varying sizes stored on a disk somewhere? No! It generates the image data <em>dynamically</em> based on the request - here it reads the <code>350x150</code> and uses it to determine the size of the image needed. It also reads other aspects of the URL and uses those to set other aspects, i.e. the url <code>//via.placeholder.com/350x150/C497FF/FFFFFF?text=Hello</code> generates the image:</p><p><a href=#R-image-66a14d0a4bf310dab8b8a8134a0d1eb1 class=lightbox-link><img alt="Another placeholder image with custom color and text" class="border lazy lightbox noshadow figure-image" loading=lazy src="https://via.placeholder.com/350x150/C497FF/FFFFFF?text=Hello" style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-66a14d0a4bf310dab8b8a8134a0d1eb1><img alt="Another placeholder image with custom color and text" class="border lazy lightbox noshadow lightbox-image" loading=lazy src="https://via.placeholder.com/350x150/C497FF/FFFFFF?text=Hello"></a></p><p>Clearly, we&rsquo;re conveying information to the Placeholder.com server <em>through the url</em>. This is much like passing parameters to a function - it is how we communicate what we want the server to do with our request!</p><p>Let&rsquo;s revisit our blog server. What if we adopted a similar approach there? Our URLs might then look like:</p><ul><li><a href=http://my-blog.com/posts/0-hello-web rel=external target=_blank>http://my-blog.com/posts/0-hello-web</a></li><li><a href=http://my-blog.com/posts/1-a-rose-by-any-other-name rel=external target=_blank>http://my-blog.com/posts/1-a-rose-by-any-other-name</a></li><li><a href=http://my-blog.com/posts/40-another-day rel=external target=_blank>http://my-blog.com/posts/40-another-day</a></li></ul><p>Where we use the <em>entire title</em> as part of the URL! This makes it more human-readable, especially helpful when searching your browser history or scanning bookmarks. But how would we handle this approach in our <code>handleRequest()</code>? You might recognize that we have a reoccurring <em>pattern</em>, which of course suggests we try a <code>RegExp</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>public</span> <span class=nx>handleRequest</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// Separate the pathname from the url 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>pathname</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=s2>&#34;http://localhost&#34;</span><span class=p>).</span><span class=nx>pathname</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Determine if the request is for the index page
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=nx>pathname</span> <span class=o>===</span> <span class=s1>&#39;/&#39;</span><span class=p>)</span> <span class=k>return</span> <span class=nx>serveHome</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Determine if the request is for a post 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=err>\</span><span class=nx>$</span><span class=o>/</span><span class=nx>post</span><span class=o>/</span><span class=err>\</span><span class=nx>w</span><span class=o>+^</span><span class=err>\</span><span class=nx>g</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>pathname</span><span class=p>))</span> <span class=k>return</span> <span class=nx>servePost</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Treat all other requests as a file 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>serveFile</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>With this regular expression, we&rsquo;ve effectively built a wildcard into our URL. Any URL with a pattern <code>/posts/[postname]</code> will be treated as a post!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=request-revisted>Request Revisted</h1><p>We&rsquo;ve seen then how the request conveys information useful to selecting the appropriate endpoint with the path, and also the query string. But there is more information available in our request than just those two tidbits. And we have <em>all</em> of that information available to us for determining the correct response to send. With that in mind, let&rsquo;s revisit the parts of the request in terms of what kinds of information they can convey.</p><h2 id=the-url-revisited>The URL, Revisited</h2><p>Now that we&rsquo;re thinking of the URL as a tool for passing information to the server, let&rsquo;s reexamine its parts:</p><p><a href=#R-image-d5a4c3d44dfeb852e2dec32e4adde6e1 class=lightbox-link><img alt="A diagram of a URL" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/6.3.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d5a4c3d44dfeb852e2dec32e4adde6e1><img alt="A diagram of a URL" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/6.3.1.png></a></p><p>The <strong>protocol</strong> is the protocol used for communication, and the <strong>host</strong> is the domain or IP address of the server. Note that these are <em>not</em> included in Node&rsquo;s <code>req.url</code> parameter, as these are used to find the right server and talk to it using the right protocol - by the time your Node server is generating the <code>req</code> object, the request has already found your server and is communicating with the protocol.</p><p>This is also why when we&rsquo;ve been parsing <code>req.url</code> with the <a href=https://nodejs.org/api/url.html rel=external target=_blank>URL</a> object, we&rsquo;ve supplied a host and protocol of <code>http://localhost</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>url</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=s2>&#34;http://localhost&#34;</span><span class=p>);</span></span></span></code></pre></div><p>This gives the URL object a placeholder for the missing protocol and host, so that it can parse the supplied URL without error. Just keep in mind that by doing so the <code>url.protocol</code> and <code>url.host</code> properties of <code>url</code> equal this &ldquo;fake&rdquo; host and protocol.</p><p>The <strong>path</strong> is the path to the virtual resource requested, accessible in our parsed URL as <code>url.pathname</code>. Traditionally, this corresponded to a file path, which is how we used it in our fileserver examples. But as we have seen with Placeholder.com, it can also be used to convey other information - in that case, the size of the image, its background color, and foreground color.</p><p>The <strong>query</strong> or <strong>querystring</strong> is a list of key-value pairs, preceded by the <code>?</code>. Traditionally this would be used to modify some aspect of the request, such as requesting a particular data format or portion of a dataset. It is also how forms are submitted with a GET request - the form data is encoded into the query string.</p><p>The <strong>hash</strong> or <strong>fragment</strong> is preceded by a <code>#</code>, and traditionally indicates an element on the page that the browser should auto-scroll to. This element should have an <code>id</code> attribute that matches the one supplied by the hash. For example, clicking this link: <a href=/cis526/08-routing/04-request-revisited/#the-url-revisited>#the-url-revisited</a> will scroll back to the header for this section (note we left the path blank, so the browser assumes we want to stay on this page).</p><p>Clearly our URL can clearly convey a lot of data to our server. But that&rsquo;s not the only information that we can use in deciding how to respond to a request.</p><h2 id=request-method-revisited>Request Method, Revisited</h2><p>In addition, we also receive the HTTP Method used for the request, i.e. GET, POST, PATCH, PUT, or DELETE. These again map back to the traditional role of a web server as a file server - GET retrieves a resource, POST uploads one, PATCH and PUT modify one, and DELETE removes it. But we can also create, read, update, and destroy <em>virtual</em> resources, i.e. resources generated and stored on the server that are <em>not</em> files. These play an especially important role in RESTful routes, which we&rsquo;ll discuss soon.</p><h2 id=headers-revisited>Headers, Revisited</h2><p>We can also convey additional information for the server to consider as part of the request headers. This is usually used to convey information tangential to the request, like authentication and cookies. We&rsquo;ll also discuss this a bit further on.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=rest>REST</h1><p>We&rsquo;ve already seen that with our blog, we could convey which post to display with different URL strategies, i.e.:</p><ul><li><a href="http://my-blog.com/posts?id=5" rel=external target=_blank>http://my-blog.com/posts?id=5</a></li><li><a href=http://my-blog.com/posts/5 rel=external target=_blank>http://my-blog.com/posts/5</a></li><li><a href=http://my-blog.com/posts/5-a-night-that-was-dark rel=external target=_blank>http://my-blog.com/posts/5-a-night-that-was-dark</a></li></ul><p>And that is just to <em>display</em> posts. What about when we want our blog software to allow the writer to <em>submit</em> new posts? Or <em>edit</em> existing ones? That&rsquo;s a lot of different URLS we&rsquo;ll need to keep track of.</p><h2 id=representational-state-transfer-rest>Representational State Transfer (REST)</h2><p>Roy Fielding tackled this issue in <a href=https://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm rel=external target=_blank>Chapter 5</a> of his Ph.D. dissertation &ldquo;Architectural Styles and the Design of Network-based Software Architectures.&rdquo; He recognized that increasingly dynamic web servers were dealing with <em>resources</em> that could be created, updated, read, and destroyed, much like the resources in database systems (not surprisingly, many of these resources were persistently stored in such a database system). These operations are so pervasive in database systems that we have an acronym for them: CRUD.</p><p>Roy mapped these CRUD methods to a HTTP URL + Method pattern he called <strong>Re</strong>presentational <strong>S</strong>tate <strong>T</strong>ransfer (or REST). This pattern provided a well-defined way to express CRUD operations as HTTP requests.</p><p>Take our blog posts example. The RESTful routes associated with posts would be:</p><table><tr><th>URL</th><th>HTTP Method</th><th>CRUD Operation</th></tr><tr><td>posts/</td><td>GET</td><td>Read (all)</td></tr><tr><td>posts/:id</td><td>GET</td><td>Read (one)</td></tr><tr><td>posts/</td><td>POST</td><td>Create</td></tr><tr><td>posts/:id</td><td>POST</td><td>Update</td></td><tr><td>posts/:id</td><td>DELETE</td><td>Delete</td></tr></table><p>The <code>:id</code> corresponds to an actual identifier of a specific resource - most often the <code>id</code> column in the database. REST also accounts for nesting relationships. Consider if we added <em>comments</em> to our <em>posts</em>. Comments would need to correspond to a specific post, so we&rsquo;d nest the routes:</p><table><tr><th>URL</th><th>HTTP Method</th><th>CRUD Operation</th></tr><tr><td>posts/:post_id/comments</td><td>GET</td><td>Read (all)</td></tr><tr><td>posts/:post_id/comments/:comment_id</td><td>GET</td><td>Read (one)</td></tr><tr><td>posts/:post_id/comments</td><td>POST</td><td>Create</td></tr><tr><td>posts/:post_id/comments/:comments_id</td><td>POST</td><td>Update</td></td><tr><td>posts/:post_id/comments/:comments_id</td><td>DELETE</td><td>Delete</td></tr></table><p>Notice that we now have <em>two</em> wildcards for most routes, one corresponding to the <code>post</code> and one to the <code>comment</code>.</p><p>If we didn&rsquo;t want to support an operation, for example, <em>updating</em> comments, we could just omit that route.</p><p>REST was so straightforward and corresponded so well to how many web servers were operating, that it quickly became a widely adopted technique in the web world. When you hear of a RESTful API or RESTful routes, we are referring to using this pattern in the URLs of a site.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=routers>Routers</h1><p>Many web development frameworks built upon this concept of routes by supplying a <em>router</em>, and object that would store route patterns and perform the routing operation. One popular Node library <a href=https://expressjs.com/ rel=external target=_blank>express</a>, is at its heart a router. If we were to write our Node blog using Express, the syntax to create our routes would be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>express</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;express&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Home page 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=nx>serveHome</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Posts 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;posts/&#39;</span><span class=p>,</span> <span class=nx>servePosts</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;posts/:id&#39;</span><span class=p>,</span> <span class=nx>servePost</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;posts/&#39;</span><span class=p>,</span> <span class=nx>createPost</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;posts/:id&#39;</span><span class=p>,</span> <span class=nx>updatePost</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=s1>&#39;posts/:id&#39;</span><span class=p>,</span> <span class=nx>deletePost</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Comments
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;posts/:post_id/comments&#39;</span><span class=p>,</span> <span class=nx>servePosts</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;posts/:post_id/comments/:id&#39;</span><span class=p>,</span> <span class=nx>servePost</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;posts/:post_id/comments&#39;</span><span class=p>,</span> <span class=nx>createPost</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;posts/:post_id/comments/:id&#39;</span><span class=p>,</span> <span class=nx>updatePost</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=s1>&#39;posts/:post_id/comments/:id&#39;</span><span class=p>,</span> <span class=nx>deletePost</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>app</span><span class=p>;</span></span></span></code></pre></div><p>The <code>app</code> variable is an instance of the express <a href=https://expressjs.com/en/4x/api.html#app rel=external target=_blank>Application</a> class, which itself is a wrapper around Node&rsquo;s <a href=https://nodejs.org/api/http.html#http_class_http_server rel=external target=_blank>http.Server</a> class. The Express <code>Application</code> adds (among other features), routing using the route methods <code>app.get()</code>, <code>app.post()</code>, <code>app.put()</code>, and <code>app.delete()</code>. These take routes either in string or regular expression form, and the wildcard values are assigned to an object in <code>req.params</code>. For example, we might write our <code>servePost()</code> method as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>servePost</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>id</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>post</span> <span class=o>=</span> <span class=nx>db</span><span class=p>.</span><span class=nx>prepare</span><span class=p>(</span><span class=s2>&#34;SELECT * FROM posts WHERE ID = ?&#34;</span><span class=p>,</span> <span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// TODO: Render the post HTML
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div><p>The parameter name in params is the same as the token after the <code>:</code> in the wildcard.</p><p>Routers can greatly simplify the creation of web applications, and provide a clear and concise way to specify routes. For this reason, they form the heart of most dynamic web development frameworks.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=apis>APIs</h1><p>Before we step away from routing, we should take the time to discuss a specific style of web application that goes hand-in-hand with routing - an Application Programming Interface (API). An API is simply a interface for two programs to communicate, to allow one to act as a service for the other. Web APIs are APIs that use hyper-text transfer protocol (http) as the mechanism for this communication. Thus, the client program makes HTTP requests against the API server and receives responses. The <a href=https://placeholder.com/ rel=external target=_blank>Placeholder.com</a> we discussed earlier in this chapter is an example of a web API - one that generates and serves placeholder images.</p><p>In fact, an API can serve <em>any</em> kind of resource - binary files, image files, text files, etc. But most serve data in one of a few forms:</p><ul><li><strong>HTML that is intended to be embedded in a web page</strong>, common to advertisement revenue services, embeddable social media feeds, YouTube and other video embedding sites.</li><li><strong>Data structured as JSON</strong>, a <em>very</em> common format for submitting or retrieving any kind of data across the web. For data that will be used by JavaScript running in the browser, it has the advantage of being the native format.</li><li><strong>Data structured as XML</strong>, another common format, XML tends to be slightly larger than the equivalent JSON, but it can have a published and enforced structure.</li></ul><h2 id=some-example-web-apis>Some Example Web APIs</h2><p>There are thousands of Web APIs available for you to work with. Some you might be interested in investigating include:</p><ul><li><a href=https://www.weather.gov/documentation/services-web-api rel=external target=_blank>The National Weather Service API</a> - we used this API early in the course to retrieve weather forecast data. As the NWS is supported by tax dollars, this resource is free to use.</li><li><a href=https://www.census.gov/data/developers/data-sets.html rel=external target=_blank>Census APIs</a> similarly, the U.S. Census Bureau makes much of their data sets available through APIs</li><li><a href=https://api.nasa.gov/ rel=external target=_blank>NASA APIs</a> as does NASA.</li><li><a href=https://developers.google.com/maps/documentation rel=external target=_blank>Google Maps</a> has extensive APIs for maps and geolocation, with a fee structure.</li><li><a href=https://wiki.openstreetmap.org/wiki/API rel=external target=_blank>Open Street Maps</a> offers an open-source alternative.</li><li><a href=https://developers.facebook.com/docs/apis-and-sdks/ rel=external target=_blank>Facebook</a> has a large collection of APIs for working with their data and navigating social network relationships.</li><li><a href=https://developer.github.com/v3/ rel=external target=_blank>GitHub</a> provides an API for developing tools to work with their site.</li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=web-hooks>Web Hooks</h1><p>A lighter-weight alternative to a full-fledged API is a <a href=https://en.wikipedia.org/wiki/Webhook rel=external target=_blank>webhook</a>. A webhook is simply an address a web application is instructed to make a HTTP request against when a specific event happens. For example, you can set your GitHub repository to trigger a webhook when a new commit is made to it. You simply provide the URL it should send a request to, and it will send a request with a payload (based on the event).</p><p>For example, the Discord chat platform allows users to create <a href=https://support.discord.com/hc/en-us/articles/228383668-Intro-to-Webhooks rel=external target=_blank>webhook endpoint</a> that will post messages into a channel. The webhook will be the in the form lf a URL that specifies the Discord server and channel that the message should be sent to, as well as some authentication parameters to identify the source of the webhook. You can then configure a webhook in GitHub which sends a message to the URL when a commit is made to GitHub. Now, each time a user pushes new data to GitHub, you&rsquo;ll be able to see a message in Discord.</p><p>A more advanced webhook endpoint can be used to trigger various actions, such as a continuous deployment routine. In that way, you can have a repository automatically deploy each time it is updated, simply through the use of webhooks!</p><p>In other words, a webhook is a technique for implementing event listeners using HTTP. One web service (GitHub in the example) provides a way for you to specify an event listener defined in another web application by the route used to communicate with it. This represents a looser coupling than a traditional API; if the request fails for any reason, it will not cause problems for the service that triggered it. It also has the benefit of being event-driven, whereas to check for new data with an API, you would need to <em>poll</em> (make a request to query) the API at regular intervals.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><p>In this chapter, we exported the idea of <em>routes</em>, a mechanism for mapping a request to the appropriate <em>endpoint</em> function to generate a response. Routes typically consist of both the request URL <em>and</em> the request method. RESTful routes provide a common strategy for implementing CRUD methods for a server-generated resource; any programmer familiar with REST will quickly be able to suss out the appropriate route.</p><p>We also explored <em>routers</em> are objects that make routing more manageable to implement. These allow you to define a route and tie it to an endpoint function used to generate the result. Most will also capture wildcards in the route, and supply those to the endpoint function in some form. We briefly looked at the <a href=http://expressjs.com/ rel=external target=_blank>Express</a> framework, a Node framework that adds a router to the vanilla Node <a href=https://nodejs.org/api/http.html#http_class_http_server rel=external target=_blank>http.Server</a> class.</p><p>Finally, we discussed using routes to serve other <em>programs</em> instead of users with APIs and WebHooks.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 9</div><h1 id=authentication>Authentication</h1><p>Who are you?</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Authentication</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>An important part of any dynamic web server is controlling how, and by whom, it is used. This is the domain of authentication and authorization. <em>Authentication</em> refers to mechanisms used to establish the <em>identity</em> of a user, and <em>authorization</em> refers to determining if an authenticated user has permission to do the requested action in the system. Collectively, these two concepts are often referred to by the abbreviation <em>auth</em>.</p><p>Consider a content management system (CMS) - a dynamic website for hosting content created by authorized users. The K-State website is an example of this kind of site - the events, articles, and pages are written by various contributors throughout the university. It is important that only authorized agents of the university (i.e. staff and faculty) are allowed to publish this content. Can you imagine what would happen if <em>anyone</em> could post <em>anything</em> on the K-State website?</p><p>In this chapter, we&rsquo;ll examine strategies for performing both authentication and authorization.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=http-authentication>HTTP Authentication</h1><p>The recognition of a need for authentication is not new to the web - it&rsquo;s been there since the earliest standards. In fact, the original URL specification included an optional username and password as part of its format (specified as <code>[username]:[password]@</code> between the protocol and host). I.e. to make a HTTP authenticated request against the CS departmental server you might use:</p><div class=highlight><pre tabindex=0><code>https://willie:purpleandwhite@cs.ksu.edu/</code></pre></div><p>However, the use of authentication URLS is now highly discouraged and has been stripped from most browsers, as it is considered a security risk. Instead, if you are using <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication rel=external target=_blank>HTTP-based authentication</a> the server needs to issue a challenge <strong>401 Unauthorized</strong> response, along with a <code>WWW-Authenticate</code> header specifying the challenge. This will prompt the browser to display a username/password form and will re-submit the request with the credentials using an <code>Authorization</code> header. The process looks something like this:</p><p><a href=#R-image-aa6021e375471f4ac9ec40cdea46a49c class=lightbox-link><img alt="The HTTP Authentication process" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/9.2.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-aa6021e375471f4ac9ec40cdea46a49c><img alt="The HTTP Authentication process" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/9.2.1.png></a></p><p>As you can see, when the client makes a request that requires authentication, the server issues a <strong>401 Unauthorized</strong> status code, along with an <code>WWW-Authenticate</code> header specifying the authentication scheme. This prompts the browser to request the user credentials via a dialog (much like the one created by the JavaScript functions <code>alert()</code>, <code>confirm()</code>, and <code>prompt()</code>). If the user supplies credentials, the request is re-sent, with those credentials included in an <code>Authentication</code> header. The server then decides, based on the credentials, if it will allow the request (typically a <strong>200</strong> response), or refuse (a <strong>403 Unauthorized</strong> response).</p><p>The <code>WWW-Authenticate</code> header looks like:</p><div class=highlight><pre tabindex=0><code>WWW-Authenticate: [type] realm=[realm]</code></pre></div><p>Where <code>[type]</code> is the authentication scheme (<code>Basic</code> being the most common), and <code>realm</code> describing the protected part of the server.</p><p>In the Basic authentication scheme, the content of the <code>Authorization</code> header is the string <code>[username]:[password]</code> encoded in <a href=https://en.wikipedia.org/wiki/Base64 rel=external target=_blank>base64</a>, where <code>[username]</code> is the users&rsquo; username, and <code>[password]</code> is their password.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>Base64 encoding is easy to undo, so you should only use HTTP Basic Authentication with the <code>https</code> protocol, which encrypts the request headers. Otherwise, anyone along the path the user&rsquo;s request travels can capture and decrypt the user&rsquo;s credentials.</p></div></div><p>The standard also defines other authorization schemes, but none are widely used today. Instead, most web developers have opted to build authentication directly into their web application. We&rsquo;ll discuss several of the most common approaches next.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=password-authentication>Password Authentication</h1><p>One of the more common approaches used in modern dynamic webservers - especially those that are already using a database - is to have each user create an account and log in with a username and password. The primary difference in this approach from the HTTP Basic one is that:</p><ol><li>The webserver provides a login page with a form for submitting the username/password (allowing it to be customized to match the site)</li><li>On an successful authentication, a cookie is used to persist the user&rsquo;s session, rather than re-submitting the <code>Authentication</code> header</li></ol><p>The actual difference in your server code between the two approaches is not that large.</p><h2 id=storing-user-credentials>Storing User Credentials</h2><p>In either case, it is necessary for the server to be able to verify that the user&rsquo;s supplied credentials are correct. For most database-backed dynamic webservers, this is accomplished by having a <em>users</em> table that stores the username, and an <strong>transformed</strong> version of the password. This transformation is usually accomplished through the use of a <a href=https://en.wikipedia.org/wiki/Cryptographic_hash_function rel=external target=_blank>cryptographic hash function</a>. This is a function that converts a string into a sequence of bytes that are very different from the source string. It is also a function that is <em>extremely difficult to reverse</em> i.e. it is difficult to figure out what the original string was from the hashed results.</p><p>When authenticating the user, the password supplied by the user is hashed using the same function, and the resulting hash is compared to the one stored in the database. If they match, the user is confirmed, and can be logged in.</p><p>The reason we store passwords only in this encrypted form is that if an adversary was able to compromise our database and obtain the <em>users</em> table, they still wouldn&rsquo;t know the users&rsquo; passwords. Even with the contents of the database, the adversary would not be able to log in to our server as the user. And, as most users use the same password and email for multiple sites, this gives them some additional protection.</p><p>In fact, current best practice is to do more than just encrypt the password - we also use salt and multiple hashing rounds.</p><h3 id=salting-a-password>Salting a Password</h3><p>Salting a password simply means to append a series of characters to the user&rsquo;s password before hashing it. This helps avoid <a href=https://en.wikipedia.org/wiki/Rainbow_table rel=external target=_blank>rainbow table</a> attacks, where an adversary uses a list of prehashed commonly-used passwords. Since many users adopt simple passwords like <strong>1234</strong>, <strong>secret</strong>, etc., it is a good bet that if you <em>do</em> obtain a list of usernames and their hashed passwords, you can find some matches. Appending the additional characters (usually in the form of random bytes) can prevent this. For an even stronger approach, <em>two</em> salts can be used - one stored as an server or environment variable, and one randomly generated per user and stored in the users table. Thus, the adversary would need to obtain access to both the database <em>and</em> the source code or server environment, making attacks more difficult.</p><h3 id=multiple-hashing-rounds>Multiple Hashing Rounds</h3><p>Unfortunately, computing hardware has advanced to the point that <a href=https://en.wikipedia.org/wiki/Brute-force_attack rel=external target=_blank>brute force attacks</a> have become more than plausible. In a brute-force approach, permutations of characters are hashed until a match is found. A cluster of off-the-shelf graphics cards can make as many as 350 billion guesses each second. The defense against this approach is to make it take longer. Cryptographic hash functions like <a href=https://en.wikipedia.org/wiki/Bcrypt rel=external target=_blank>Bcrypt</a> allow the hashing to be performed in multiple iterations. Adding more iterations makes the encryption process take longer - and therefore slows down any brute-force attack replicating the hashing function.</p><p>The downside is that it takes longer to log a user in using this strategy, but it provides about the best protection that we as web developers can offer. Incidentally, this is another reason to only authenticate the user once, rather than on every request (as is the case with HTTP authentication). To be able to store the user&rsquo;s authentication however, we must maintain some form of session.</p><h2 id=user-sessions>User Sessions</h2><p>This brings us to the second half of the username/password approach - we have to implement some form of user session. To do user sessions, we must also employ cookies. By their nature, cookies are not as secure as we might like, but there are some strategies we can use to make them more secure. First, we should specify the cookies using the <code>Secure</code> and <code>HttpOnly</code> attributes, and the <code>SameSite</code> attribute set to <code>Strict</code>. Moreover, the values set in the cookie should also be encrypted before being set (in this case, with a two-way encryption). Commonly, only the session id or user id will be included in the cookie, while the actual session data will be stored server-side in memory or in a sessions table.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>As with HTTP Authentication (and indeed, all authentication approaches) password-based authentication should only be used with HTTPS connections.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=stronger-passwords>Stronger Passwords</h1><p>Now that we&rsquo;ve discussed how to build a password-based authentication system as securely as possible, we should take a moment to understand what <em>makes a good password</em>. While we can&rsquo;t force users to use good passwords, we can encourage them to do so, and potentially build some requirements/guidance into our sign up forms.</p><p>You&rsquo;ve likely been told multiple times that a good password is a mix of numbers, upper- and lower-case letters, and special symbols. While this is indeed marginally better than a password of the same length that uses only letters, it isn&rsquo;t much. Remember that with some clever programming and a graphics card, passwords can be brute-forced. The amount of time this takes is more dependent on the <em>length</em> of the password than the combination of characters. This XKCD comic sums up the issue succinctly:</p><p><a href=#R-image-9e0cb68c022e42e1661ed2e5ed248b06 class=lightbox-link><img alt="XKCD: Password Strength" class="border lazy lightbox noshadow figure-image" loading=lazy src=https://imgs.xkcd.com/comics/password_strength.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9e0cb68c022e42e1661ed2e5ed248b06><img alt="XKCD: Password Strength" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=https://imgs.xkcd.com/comics/password_strength.png></a></p><p>In short, the best passwords are actually <em>pass phrases</em> - a combination of words that is easy to remember and of significant length. Given this is mathematically demonstrable, why do so many authentication services insist on a complex scheme for making short passwords? I suspect it is a legacy from when storage space was at a premium, as well as a nod to database performance.</p><p>Think back to our SQL discussions - we can declare text in two ways - a VARCHAR (which has a set maximum length), or TEXT (which can be any size). These roughly correspond to <em>value</em> and <em>reference</em> types in a programming language - VARCHARS are stored inline with table data, while TEXT entries are stored separately, and an address of their location is stored in the table. If we&rsquo;re retrieving thousands or millions of rows including TEXT values, we have to pull those values from their disparate locations - adding overhead to the query. VARCHARS we get with the row for no extra time cost. So storing passwords as a VARCHAR would give better performance, and limiting them to a small size (by imposing a character limit) would save on storage requirements.</p><p>In the modern web, with storage costs as low as they are, there is no excuse for clinging to short passwords with arcane requirements. If you are going to force your users to meet any rules for your password system, it should be a <em>minimum length</em>.</p><p>Or, we can side-step the issue entirely, by passing responsibility for authentication to a third party. We&rsquo;ll look at these strategies next.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=single-sign-on>Single Sign On</h1><p>It should be clear from our earlier discussion that there are some very real challenges to writing a good authentication approach. These challenges can be broken into two categories, those that face us as the programmer, and those that arise from our users:</p><h4 id=programmer-challenges>Programmer Challenges</h4><p>For us as the programmer, there are a lot of steps in creating an authentication strategy that we <em>must</em> get right. We also must be very careful about how we store the authentication data - i.e. passwords should <strong>always</strong> be stored encrypted, never as plain text. And having actual authentication data in our site makes us a juicer target for adversaries, and potentially ups the stakes if our site is compromised.</p><p>Finally, what constitutes best practice in authentication <em>is constantly changing</em>. And to make sure we are doing everything as securely as possible <em>we should be updating our apps to follow current best practices.</em> This is obviously a lot of work.</p><h4 id=user-challenges>User Challenges</h4><p>For the user, having <em>yet another login and password</em> contributes to a number of problems. Users struggle to remember multiple passwords, and often default to using the <em>same</em> login and password across multiple sites. This means their credentials are only as secure as the worst-implemented security of those sites. While your app might have stellar security, your user might be compromised by a completely different site you have no influence over. Also, users often resort to writing down credentials - leaving them open to being found and used by others.</p><h3 id=single-sign-on>Single Sign On</h3><p>Single-sign on is a solution to both sets of challenges. The basic idea is to have one authentication service that is used for multiple, often completely independent applications. A user only needs to remember one login and password for <em>all</em> the applications, and authentication is done on one special-built server that can be updated to the latest best practices with ease.</p><p>Of course, to implement single-sign on, we need a way to establish trust between the authenticating server and the other web apps that use it. Thus, we need a standardized process to draw upon. We&rsquo;ll discuss several in the next couple of sections.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cas>CAS</h1><p>Let&rsquo;s start our discussion of single-sign on strategies with Central Authentication Service (CAS). We&rsquo;ll do this because it is one of the more straightforward approaches to Single Sign On, and one you&rsquo;ve probably used every day as a K-State student, as it is the basis of Kansas State University&rsquo;s eid login system.</p><p>CAS is a standard protocol that involves two servers and the client computer. One server is the host of the app and the other is the authentication server. The flow is fairly straightforward:</p><ol><li><p>The user visits the app server, which determines the user is not logged in</p></li><li><p>The app server redirects the browser to the authentication server, providing in the url as a query parameter URL to return the authenticated user to</p></li><li><p>The authentication server sends the browser a login form</p></li><li><p>The user fills out and submits the form, which goes back to the authentication server</p></li><li><p>If the authentication is unsuccessful, the authentication server re-sends the form (returning to step 3). If it is successful, the authentication server redirects the user to the app server, using the URL it provided in the first redirect. It also sends a ticket (a string of cryptographic random bytes) that corresponds to the login attempt as a query parameter</p></li><li><p>The app server now has to verify that the ticket it received is valid (i.e. it is not counterfeit or an re-used one captured from an earlier login attempt). To do this, the app server sends a request to validate the ticket to the authentication server</p></li><li><p>If the authentication server sends an XML response indicating if the ticket was valid. If it is valid, this XML also includes information about the user (at a minimum the username, but it can contain additional information like email, first and last names, etc).</p></li><li><p>Once the app server is sure the ticket is valid, it finishes logging in the user (typically by saving their identity in a session) and sends a welcome page or the page they were attempting to access.</p></li></ol><p>The diagram below visually shows this process:</p><img src=https://miro.medium.com/max/1050/1*yCpUC4xPxtYV-LKbUv_TmQ.jpeg alt="The CAS login process"><p>You can learn more about the CAS approach at <a href=https://www.apereo.org/projects/cas rel=external target=_blank>https://www.apereo.org/projects/cas</a>.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=saml>SAML</h1><p>Security Assertion Markup Language (SAML) is a similar single-sign-on strategy to CAS, but one that has a wider adoption in the business world. The process is quite similar, with the addition that the user agent identifies the user before requesting access. How it does so is left to the implementer, but it can be an IP address, stored token, or other means.</p><p><img src=https://upload.wikimedia.org/wikipedia/commons/0/04/Saml2-browser-sso-redirect-post.png alt="SAML Web Browser Single-Sign On flow"><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>Much like CAS, SAML provides its response in the form of XML. And like CAS, the SAML standard primarily works with traditional, server-based web apps. We&rsquo;ll turn to some alternatives next.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>File:Saml2-browser-sso-redirect-post.png. (2021, October 17). Wikimedia Commons, the free media repository. Retrieved 15:33, June 2, 2022 from <a href="https://commons.wikimedia.org/w/index.php?title=File:Saml2-browser-sso-redirect-post.png&oldid=599388084" rel=external target=_blank>https://commons.wikimedia.org/w/index.php?title=File:Saml2-browser-sso-redirect-post.png&oldid=599388084</a>.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=json-web-tokens>JSON Web Tokens</h1><p>A common thread across single-sign-on approaches is the issuing of some kind of ticket or certificate to identify the signed-in user. This is often stored within a cookie (which means it can be used to persist a connection with a web app). However, as the web matured, a more robust identity token became a standard: the JSON Web Token (JWT).</p><p>A JSON Web Token (JWT) consists of three parts:</p><ul><li>A header with metadata</li><li>A payload consisting of the data needed to identify the user</li><li>A cryptographic signature verifying the payload and header</li></ul><p>The JWT puts the user information directly into a token that is served by the authentication server. So if we want to identify a user by email, their email is in the payload. The header provides information like when the JWT will expire, and what cryptographic algorithm was used to generate the signature. And the signature was created using the specified cryptographic algorithm on the header and payload. This signature is what gives a JWT its robustness; when used correctly makes it impossible to modify the payload without the tampering being evident.</p><p>How trust is established is based on the cryptographic function, which uses a public and private key pair (much like TLS). The hash is <em>created</em> with the private key on the authentication server on a successful login. It can be <em>decoded</em> by an application using the <em>public</em> key. The decoded data should match that of the header and payload <em>exactly</em>. If it does, this proves the JWT was created by the authentication server (as you can&rsquo;t create one without the private key) and hasn&rsquo;t been tampered with. If it <em>is</em> tampered with, i.e someone changes the payload, the signature will no longer match.</p><p>Because of this tamper-resistant nature, JWT has quickly become a standard form for authentication tokens.</p><p>You can learn more about the JWT approach at <a href=https://jwt.io/ rel=external target=_blank>https://jwt.io/</a>.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=oauth>OAuth</h1><p>OAuth 2.0 is perhaps the best-known single-sign-on solution. Many of the big internet players provide OAuth services: Google, Microsoft, Facebook, Twitter, etc. However, OAuth is significantly more complex than the other approaches we&rsquo;ve talked about, as it really a standard for <em>access delegation</em>, i.e. a way for users to authorize third-party apps to access their information stored with the identity provider.</p><p>I.e. if you write an app that works with the Facebook API and needs access to a users&rsquo; friends list, then OAuth allows you to authorize Facebook to share that info with your app. This authorization is done by the user through Facebook, and can be revoked at any time.</p><p>Despite being built to help with access delegation, OAuth 2.0 can (and often is) used soley for the purpose of single-sign-on.</p><p>The OAuth protocol flow</p><ol><li>The user requests a resource</li><li>The app server redirects the user&rsquo;s browser to the identity server, along with a a request for identity</li><li>The identity server prompts the user to log in (if they aren&rsquo;t already)</li><li>The identity server redirects the user back to the app server providing an encoded response and identity token (typically a JWT)</li><li>The app server <em>decodes</em> the response, and determines if the user has been authenticated</li><li>The identity token can now be used to access the approved services of the identity provider</li></ol><p>Notice the big difference here between CAS and SAML is that the app server doesn&rsquo;t need to contact the identity server directly to authenticate the user. This is because the app server is <em>registered</em> with the identity server, which provides it both an client id and secret. The client id is a public identifier used to uniquely identify the web app amongst all those that use the identity service, and the secret <em>should be</em> known only to the web app and the identity server. This client id, secret, and user&rsquo;s token are sent to the authenticating server when requests are made for its services.</p><p>OAuth is sometimes referred to as pseudo-identity, as its real purpose is to provide access to the services of the identity provider. OpenID is another standard built on top of OAuth that goes one step farther - issuing an authentication certificate certifying the identity of the user. A comparison of the two processes appears in the graphic below:</p><p><img src=https://upload.wikimedia.org/wikipedia/commons/3/32/OpenIDvs.Pseudo-AuthenticationusingOAuth.svg alt=Oauth> <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>File:OpenIDvs.Pseudo-AuthenticationusingOAuth.svg. (2020, October 22). Wikimedia Commons, the free media repository. Retrieved 15:38, June 2, 2022 from <a href="https://commons.wikimedia.org/w/index.php?title=File:OpenIDvs.Pseudo-AuthenticationusingOAuth.svg&oldid=496954680" rel=external target=_blank>https://commons.wikimedia.org/w/index.php?title=File:OpenIDvs.Pseudo-AuthenticationusingOAuth.svg&oldid=496954680</a>.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><p>In this chapter we discussed many of the possible authentication strategies for web applications, as well as the strengths and drawbacks. To reiterate the most salient points:</p><ul><li>Passwords should <strong>NEVER</strong> be stored as plain text!</li><li>Authentication processes should follow <em>current</em> industry best-practices. This is not the place to experiment!</li><li>Industry best practices are constantly changing, as ever-improving computer technology renders older techniques ineffective</li></ul><p>Following these guidelines can help keep your users safe and secure. Or you can use a singe-sign-on solution to allow another service to take on the responsibility for authentication. But if you do, you must follow the standard <em>exactly</em>, and protect any secrets or private keys involved. Failing to do so will expose your users&rsquo; data.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 10</div><h1 id=dynamic-web-frameworks>Dynamic Web Frameworks</h1><p>The Next Generation</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Dynamic Web Frameworks</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>You have now learned about and built examples of several early implementations for web applications - file servers and server pages. These kinds of web applications dominated the Internet in the 90&rsquo;s, and continue to play a major role today. However, the needs of web applications grew increasingly more dynamic as the web continued to evolve, leading to the development of truly dynamic web servers built around a stack of technologies. You&rsquo;ve also built several of these as well&mldr; and discovered just how long it can take to build one from scratch.</p><p>Consider the simple case of an online store - it must authenticate users, keep track of their shopping carts, and in processing orders, send emails to the user and instructions to inventory/warehouse systems. These are not trivial needs, nor are the programs built to meet them simple. These needs heralded the introduction of full-stack web development approaches; the stack being a combination of technologies that had to be used together effectively to host a web application.</p><p>In order to be a web developer, therefore, a programmer needed familiarity with a number of technologies, a basic grounding in IT, and proficiency with a programming languages. Of course, there were a limited number of professionals with these capacities available, and demand for them has never stopped growing.</p><p>Moreover, the applications themselves began to grow increasingly complex. It is very likely that you&rsquo;ve already found yourself struggling to understand the various parts of our examples in this class, and how they fit together. This was also true for the developers tackling these problems in the past, especially as many did not have deep enough training. This situation paralleled the <a href=https://en.wikipedia.org/wiki/Software_crisis rel=external target=_blank>software crisis</a> of the 70&rsquo;s, where increasingly sophisticated programs were being developed by undertrained programmers, and software development was plagued with cost overruns, missed deadlines, and failed projects.</p><p>One major outcome of the software crisis was the development of software engineering techniques, and changes to programming languages to help programmers make less errors in writing code, and find their errors more quickly. A similar process occurred with web development in the 2000&rsquo;s, leading to the development of &ldquo;web frameworks&rdquo;. These grew from the realization that most dynamic web servers need the same core features - the ability to interact with persistent data sources, to authenticate users and keep track of their actions on the site, and to interact with other servers. A web development framework seeks to provide those features, allowing the developer to quickly get started building the more unique features of the server.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=web-frameworks>Web Frameworks</h1><p>Web frameworks were designed meet these challenges, and to help programmers develop web applications more quickly and with less errors. They do so through providing a standardized approach to building a web application, including imposing a software architecture, providing commonly-needed functionality, libraries for database communication, and generators to create boilerplate code. These frameworks built upon existing Web Stacks, allowing the programmer to focus almost exclusively on the scripting aspect.</p><p>A slew of frameworks for various scripting languages emerged in 2005:</p><ul><li><a href=https://symfony.com/ rel=external target=_blank>Symfony</a> using <a href=https://php.net/ rel=external target=_blank>PHP</a></li><li><a href=https://www.djangoproject.com/ rel=external target=_blank>Django</a> using <a href=https://www.python.org/ rel=external target=_blank>Python</a></li><li><a href=https://rubyonrails.org/ rel=external target=_blank>Ruby on Rails</a> using <a href=https://www.ruby-lang.org/en/ rel=external target=_blank>Ruby</a></li><li><a href=https://grails.org/ rel=external target=_blank>Grails</a> using <a href=https://groovy-lang.org/ rel=external target=_blank>Groovy</a> (a Java Virtual Machine Language)</li></ul><p>And new ones continue to emerge relatively often:</p><ul><li><a href=https://expressjs.com/ rel=external target=_blank>Express</a> using [JavaScript (via Node)] in 2010</li><li><a href=https://laravel.com/ rel=external target=_blank>Laravel</a> using <a href=https://php.net/ rel=external target=_blank>PHP</a> in 2011</li><li><a href=https://phoenixframework.org/ rel=external target=_blank>Phoenix</a> using <a href=https://elixir-lang.org/ rel=external target=_blank>Elixir</a> in 2014</li><li><a href=https://dotnet.microsoft.com/apps/aspnet/mvc rel=external target=_blank>ASP.NET MVC</a> using .NET languages 2015</li></ul><p>These represent only some of the best known <em>server-side</em> frameworks. A newer trend are <em>client-side</em> frameworks, which are built on JavaScript (or one of its derivatives) and run in the browser communicating with a web API. Some of the best known of these include:</p><ul><li><a href=https://emberjs.com/ rel=external target=_blank>Ember</a> using JavaScript in 2011</li><li><a href=https://www.meteor.com/ rel=external target=_blank>Meteor</a> using JavaScript in 2012</li><li><a href=https://reactjs.org/ rel=external target=_blank>React</a> using JavaScript or JSX in 2013</li><li><a href=https://vuejs.org/ rel=external target=_blank>Vue.js</a> using JavaScript in 2014</li><li><a href=https://angular.io/ rel=external target=_blank>Angular</a> using TypeScript in 2016</li><li><a href=https://nextjs.org/ rel=external target=_blank>Next.JS</a> using JavaScript or JSX in 2016</li></ul><p>You can see there is a large variety represented and available to us - and these are only some of the best known!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=web-framework-characteristics>Web Framework Characteristics</h1><p>Web frameworks can be classified in a number of ways, but there are several that you will see pop up in discussions. For example, an <strong>opinionated</strong> web framework is one that was developed with a strict software architecture that developers are expected to follow. While it may be possible to deviate from this expected structure, to do so often causes significant headaches and coding challenges. Ruby on Rails is a good example of an opinionated framework - there is a <em>Rails Way</em> of writing a Ruby on Rails application, and deviating from that way will require a lot more work on your part.</p><p>Other frameworks do not try to impose a structure - merely offer a suite of tools to use as you see fit. While this comes with a great degree of freedom, it also means that you can find wildly divergent example code written using the framework. Express is a great example of this kind of framework - it is essentially a router that has the ability to add a template library (of your choice) and a database library (of your choice), and does not expect you to lay out your files in any specific way.</p><p>Another aspect to frameworks is what kinds of architectural patterns they adopt. Ruby on Rails, Django, and Microsoft&rsquo;s MVC, all use a <a href=https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller rel=external target=_blank>Model-View-Controller architecture</a>. Express and Phoenix adopt a <a href=https://en.wikipedia.org/wiki/Pipeline_(software) rel=external target=_blank>Pipeline architecture</a>. Microsoft&rsquo;s <a href="https://docs.microsoft.com/en-us/aspnet/core/razor-pages/?view=aspnetcore-3.1&tabs=visual-studio" rel=external target=_blank>Razor Pages</a>, while built on Microsoft MVC, have gone back to a page-based architecture similar to the server pages we spoke of previously, as does <a href=https://nextjs.org/ rel=external target=_blank>Next.JS</a>.</p><p>A third distinction is if the framework is <em>server-side</em> (meaning it runs on the server) or <em>client-side</em> (meaning it consists of a JavaScript program that runs in the browser), or a hybrid of the two. Ruby on Rails, Django, Microsoft&rsquo;s MVC, Express, and Phoenix are all server-side frameworks - they do the bulk of the work of creating the HTML being served on the server. React, Vue, and Angular are all client-side frameworks that create their HTML dynamically in the browser using JavaScript, typically through making requests against a web API. Meteor and NextJS are <em>hybrids</em> that provide both client-side and server-side libraries.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=single-page-apps>Single Page Apps</h1><p>Client-side frameworks often focus on creating <a href=https://en.wikipedia.org/wiki/Single-page_application rel=external target=_blank>single page apps</a>. In this pattern, the entire website consists of a single HTML page with very little content, mostly the <code>&lt;script></code> elements to download a large client-side JavaScript library. Once downloaded, this library populates the page with HTML content by directly manipulating the DOM.</p><p>Consider a drawing application for creating pixel art. It is entirely possible to write a single-page application that only needs a webserver to serve its static HTML and JavaScript files. Once downloaded into the browser, you could draw with it and download the resulting images directly out of the browser - no further server interaction is needed! Thus, you can host such an app on a simple static hosting service at very low cost.</p><p>On the other hand, if you <em>did</em> need server functionality (say you want to be able to save drawings to the server and re-open them on a different machine), you can combine your client-side app with a server-side API. It would provide authentication and persistent storage through a few endpoints, most likely communicating through sending JSON as requests and responses.</p><p>A good example of this kind of client-side application is MIT Media Labs&rsquo; <a href=https://scratch.mit.edu rel=external target=_blank>Scratch</a>, a block-based programming environment for teaching programming. The Scratch Development Environment is a client-side app that provides the programming environment, a vm for running the Scratch program, and the user interface code for displaying the result of running that program. All of the computation of running the Scratch program is therefore done in the browser&rsquo;s JavaScript environment, <em>not</em> on the server. The server provides a minimal API for saving Scratch projects and their resources, as well as publishing them - but the actual heavy computation is always done on the client.</p><p>This approach - offloading heavy computation to the browser instead of the server means servers don&rsquo;t need to work as hard. The benefit is they can be less powerful machines and serve <em>more</em> users while consuming <em>less</em> power, and generating less waste heat. This is why Google Docs, Microsoft 360, Facebook, and other big players have been pushing as much of their site&rsquo;s computational needs to the client for years.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=progressive-web-apps>Progressive Web Apps</h1><p>A next step in the evolution of single-page apps is the <a href=https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps rel=external target=_blank>progressive web application (PWA)</a>. While these are web applications, they also provide a native-like feel when running in a phone or tablet, and can usually have a shortcut saved to the desktop. It is built around several new web standards that provide specific functionality:</p><h2 id=secure-context>Secure Context</h2><p>A PWA is always served with https. Also, many features that a PWA might want to use (geolocation, the camera) are only available to a site served over http.</p><h2 id=service-worker>Service Worker</h2><p>A service worker is a JavaScript script (much like the web workers we learned about earlier) that manages communication between the app running in the browser and the network. Most specifically, it is used to cache information for when the network is unavailable, which can allow your app to run offline.</p><h2 id=manifest-file>Manifest File</h2><p>The manifest is a JSON file that describes the application (much like the Node package.json) that provides the details necessary to load the app and &ldquo;install&rdquo; it on mobile devices. Note that installing essentially means running a locally cached copy of the website.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter A</div><h1 id=hyper-text-markup-language>Hyper-Text Markup Language</h1><p>Providing structure and content to the world wide web since 1993.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Hyper-Text Markup Language</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>Hyper-Text Markup Language (HTML) alongside Hyper-Text Transfer Protocol (HTTP) formed the core of Sir Tim Berners-Lee&rsquo;s world-wide web. As the name implies, HTTP is a <em>markup language</em>, one that combines the text of what is being said with instructions on how to display it.</p><p>The other aspect of HTML is its <em>hyper-text</em> nature. Hyper-text refers to text that links to additional resources - primarily the links in the document, but also embedded multimedia.</p><p>This ability to author structured pages that linked to other structured pages with a single mouse click is at the heart of the World-Wide-Web.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>The HTML standard, along with many other web technologies, is maintained by the <a href=https://www.w3.org/ rel=external target=_blank>World-Wide-Web Consortium</a> (abbrivated W3C), stakeholders who create and maintain web standards. The full description of the Hyper-Text Markup Language can be found here <a href=https://www.w3.org/html/ rel=external target=_blank>w3c&rsquo;s HTML page</a>.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=html-element-structure>HTML Element Structure</h1><p>HTML was built from the SGML (Structured Generalized Markup Language) standard, which provides the concept of &ldquo;tags&rdquo; to provide markup and structure within a text document. Each element in HTML is defined by a unique opening and closing tag, which in turn are surrounded by angle brackets (&lt;>).</p><p>For example, a top-level heading in HTML would be written:</p><p><code>&lt;h1>Hello World&lt;/h1></code></p><p>And render:</p><h1>Hello World</h1><p>The <code>&lt;h1></code> is the <em>opening tag</em> and the <code>&lt;/h1></code> is the closing tag. The name of the tag appears immediately within the &lt;> of the opening tag, and within the closing tag proceeded by a forward slash (/). Between the opening tag and closing tag is the <em>content</em> of the element. This can be text (as in the case above) or it can be another HTML element.</p><p>For example:</p><p><code>&lt;h1>Hello &lt;i>World&lt;/i>!&lt;/h1></code></p><p>Renders:</p><h1>Hello <i>World</i></h1><h2 id=nesting-elements>Nesting Elements</h2><p>An element nested inside another element in this way is called a <em>child</em> of the element it is nested in. The containing element is a <em>parent</em>. If more than one tag is contained within the parent, the children are referred to as <em>siblings</em> of one another. Finally, a element nested several layers deep inside another element is called a <em>descendant</em> of that element, and that element is called an <em>ancestor</em>.</p><h2 id=matching-tags>Matching Tags</h2><p>Every opening tag <strong>must</strong> have a matching closing tag. Moreover, nested tags must be matched in order, much like when you use parenthesis and curly braces in programming. While whitespace is ignored by HTML interpreters, best developer practices use indentation to indicate nesting, i.e.:</p><div class=highlight><pre tabindex=0><code>&lt;div&gt;
  &lt;h1&gt;Hello World!&lt;/h1&gt;
  &lt;p&gt;
    This is a paragraph, followed by an unordered list...
  &lt;/p&gt;
  &lt;ul&gt;
    &lt;li&gt;List item #1&lt;/li&gt;
    &lt;li&gt;List item #2&lt;/li&gt;
    &lt;li&gt;List item #3&lt;/li&gt;
  &lt;/ul&gt;
&lt;/div&gt;</code></pre></div><p>Getting tags out of order results in invalid HTML, which may be rendered unpredictably in different browsers.</p><h2 id=void-elements>Void Elements</h2><p>Also, some elements are not allowed to contain content, and should not be written with an end tag, like the break character:</p><p><code>&lt;br></code></p><p>However, there is a more strict version of HTML called XHTML which is based on XML (another SGML extension). In XHTML void tags are self-closing, and must include a <code>/</code> before the last <code>></code>, i.e.:</p><p><code>&lt;br/></code></p><p>In practice, most browsers will interpret <code>&lt;br></code> and <code>&lt;br/></code> interchangeably, and you will see many websites and even textbooks use one or the other strategy (sometimes both on the same page). But as a computer scientist, you should strive to use the appropriate form based type of document you are creating.</p><h2 id=tag-name-case>Tag Name Case</h2><p>Similarly, by the standards, HTML is case-insensitive when evaluating tag names, but the W3C recommends using lowercase characters. In XHTML tag names <strong>must</strong> be in lowercase, and React&rsquo;s JSX format uses lowercase to distinguish between HTML elements and React components. Thus, it makes sense to always use lowercase tag names.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>XHTML is intended to allow HTML to be interpreted by XML parsers, hence the more strict formatting. While it is nearly identical to HTML, there are important structural differences that need to be followed for it to be valid. And since the point of XHTML is to make it more easily parsed by machines, these <strong>must</strong> be followed to meet that goal. Like HTML, the XHTML standard is maintained by W3C: <a href=https://www.w3.org/TR/xhtml11/ rel=external target=_blank>https://www.w3.org/TR/xhtml11/</a>.</p></div></div><h2 id=attributes>Attributes</h2><p>In addition to the tag name, tags can have <em>attributes</em> embedded within them. These are key-value pairs that can modify the corresponding HTML element in some way. For example, an image tag <em>must</em> have a <code>src</code> (source) attribute that provides a URL where the image data to display can be found:</p><p><code>&lt;img src="/images/Light_Bulb_or_Idea_Flat_Icon_Vector.svg" alt="Light Bulb"></code></p><p>This allows the image to be downloaded and displayed within the browser:</p><img src=/images/Light_Bulb_or_Idea_Flat_Icon_Vector.svg alt="Light Bulb"><p>Note that the <code>&lt;img></code> element is another void tag. Also, <code>&lt;img></code> elements should always have an <code>alt</code> attribute set - this is text that is displayed if the image cannot be downloaded, and is also read by a screen reader when viewed by the visually impaired.</p><p>Attributes come in the form of key-value pairs, with the key and value separated by an equal sign (<code>=</code>) and the individual attributes and the tag name separated by whitespace. Attributes can only appear in an opening or void tag. Some attributes (like <code>readonly</code>) do not need a value.</p><p>There should be no spaces between the attribute key, the equal sign (<code>=</code>), and the attribute value. Attribute values should be quoted using single or double quotes if they contain a space character, single quote, or double quote character.</p><p>Additionally, while there are specific attributes defined within the HTML standard that browsers know how to interpret, specific technologies like Angular and React add their own, custom attributes. Any attribute a browser does not know is simply ignored by the browser.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=html-document-structure>HTML Document Structure</h1><p>When authoring an HTML page, HTML elements should be organized into an <em>HTML Document</em>. This format is defined in the HTML standard. HTML that does not follow this format are technically invalid, and may not be interpreted and rendered correctly by all browsers. Accordingly, it is important to follow the standard.</p><p>The basic structure of a valid HTML5 document is:</p><div class=highlight><pre tabindex=0><code>&lt;!doctype HTML&gt;
&lt;html lang=&#34;en&#34;&gt;
  &lt;head&gt;
    &lt;title&gt;Page Title Goes Here&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;Page body and tags go here...&lt;/p&gt; 
  &lt;/body&gt;
&lt;/html&gt;</code></pre></div><p>We&rsquo;ll walk through each section of the page in detail.</p><h2 id=doctype>Doctype</h2><p>The SGML standard that HTML is based on requires a <code>!doctype</code> tag to appear as the first tag on the page. The doctype indicates what kind of document the file represents. For HTML5, the doctype is simply <em>HTML</em>. Note the doctype is not an element - it has no closing tag and is not self-closing.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>For SGML, the doctype normally includes a URL pointing at a definition for the specific type of document. For example, in HTML4, it would have been <code>&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"></code>. HTML5 broke with the standard by only requiring HTML be included, making the doctype much easier to remember and type.</p></div></div><h2 id=html-element>HTML Element</h2><p>The next element should be an <code>&lt;html></code> element. It should include all other elements in the document, and its closing tag should be the last tag on the page. It is best practice to include a <code>lang</code> attribute to indicate what language is used in the document - here we used <code>"en"</code> for English. The <code>&lt;html></code> element should only contain two children - a <code>&lt;head></code> and <code>&lt;body></code> tag in that order.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>The list of valid langauge subtags are maintained by the Internet Assigned Numbers Authority <a href=https://www.iana.org/ rel=external target=_blank>(IANA)</a>, which also oversees domains and IP addresses. The full list can be reached <a href=https://www.iana.org/assignments/language-subtag-registry/language-subtag-registry rel=external target=_blank>here</a>.</p></div></div><h2 id=the-head-element>The Head Element</h2><p>The next element is the <code>&lt;head></code> element. A valid HTML document will only have one head element, and it will always be the first child of the <code>&lt;html></code> element. The head section contains metadata about the document - information about the document that is not rendered in the document itself. This typically consists of <code>meta</code> and <code>link</code> elements, as well as a <code>&lt;title></code>. Traditionally, <code>&lt;script></code> elements would also appear here, though current best practice places them as the last children of the <code>&lt;body></code> tag.</p><h3 id=the-title-element>The Title Element</h3><p>The <code>&lt;head></code> element should always have exactly one child <code>&lt;title></code> element, which contains the title of the page (as text; the <code>&lt;title></code> element should <strong>never</strong> contain other HTML elements). This title is typically displayed in the browser tab.</p><h2 id=the-body-element>The Body Element</h2><p>The next element is the <code>&lt;body></code> element. A valid HTML document will only have one body element, and it will always be the second child of the <code>&lt;html></code> element. The <code>&lt;body></code> tag contains all the HTML elements that make up the page. It can be empty, though that makes for a very boring page.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=inline-vs-block-elements>Inline vs. Block Elements</h1><p>Given that the role of HTML is <em>markup</em>, i.e. providing structure and formatting to text, HTML elements can broadly be categorized into two categories depending on how they affect the flow of text - inline and block.</p><p>Inline elements referred to elements that maintained the flow of text, i.e. the <em>bring attention to</em> (<code>&lt;b></code>) element used in a paragraph of text, would bold the text without breaking the flow:</p><p><code>&lt;p>The quick brown &lt;b>fox&lt;/b> lept over the log&lt;/p></code></p><p>The quick brown <b>fox</b> lept over the log</p><p>In contrast, block elements break the flow of text. For example, the <code>&lt;blockquote></code> element used to inject a quote into the middle of the same paragraph:</p><p><code>&lt;p>The quick brown fox &lt;blockquote>What does the fox say? - YLVIS&lt;/blockquote> lept over the log&lt;/p></code></p><p>The quick brown fox<blockquote>What does the fox say? - YLVIS</blockquote>lept over the log</p><p>While HTML elements default to either block or inline behavior, this can be changed with the CSS <code>display</code> property.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=tables>Tables</h1><p>Tables were amongst the first addition to HTML (along with images), as they were necessary for the primary role of early HTML, disseminating research.</p><p>A table requires a <em>lot</em> of elements to be nested in a specific manner. It is best expressed through an example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>table</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>thead</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>th</span><span class=p>&gt;</span>Name<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>th</span><span class=p>&gt;</span>Role<span class=p>&lt;/</span><span class=nt>th</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>thead</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>tbody</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>Darth Vader<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>Antagonist<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>Luke Skywalker<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>Coming-of-age protagonist<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>Princess Lea<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>Heroic resistance fighter<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>       <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>Obi-Wan Kenobi<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>       <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>Wise old man<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>Han Solo<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>Likeable scoundrel<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>Chewbacca<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>The muscle<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>Threepio<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>Comedic foil<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>Artoo Deetoo<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>td</span><span class=p>&gt;</span>Plot driver<span class=p>&lt;/</span><span class=nt>td</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>tr</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>tbody</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>table</span><span class=p>&gt;</span></span></span></code></pre></div><p>It renders as:</p><table><thead><tr><th>Name</th><th>Role</th></tr></thead><tbody><tr><td>Darth Vader</td><td>Antagonist</td></tr><tr><td>Luke Skywalker</td><td>Coming-of-age protagonist</td></tr><tr><td>Princess Lea</td><td>Heroic resistance fighter</td></tr><tr><td>Obi-Wan Kenobi</td><td>Wise old man</td></tr><tr><td>Han Solo</td><td>Likeable scoundrel</td></tr><tr><td>Chewbacca</td><td>The muscle</td></tr><tr><td>3PO</td><td>Comedic foil</td></tr><tr><td>R2-D2</td><td>Plot driver</td></tr></tbody></table><p>Tables should <em>only</em> be used for displaying tabular data. There was a time, not long ago, when early web developers used them to create layouts by cutting images into segments and inserting them into table cells. <strong>This is very bad practice!</strong> It will not display as expected in all browsers, and wreaks havoc with screen readers for the visually impaired. Instead, pages should be laid out with CSS, as is discussed in the CSS layouts section.</p><p>A far more detailed discussion of tables can be found in <a href=https://developer.mozilla.org/en-US/docs/Learn/HTML/Tables/Basics rel=external target=_blank>MDN&rsquo;s guides</a>.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=forms>Forms</h1><p>Forms were also amongst the first additions to the HTML standard, and provide the ability to submit data to a web server. A web form is composed of <code>&lt;input></code>, <code>&lt;textarea></code>, <code>&lt;select></code> and similar elements nested within a <code>&lt;form></code> element.</p><h2 id=the-form-element>The Form Element</h2><p>The form element primarily is used to organize input elements and specify how they should be submitted. In its simplest form, it is simply a tag that other elements are nested within:</p><p><code>&lt;form>&lt;/form></code></p><p>However, it can be modified with a number of attributes:</p><ul><li><p><strong>action</strong> The <code>action</code> attribute specifies the url that this form data should be sent to. By default, it is the page the form exists on (i.e. if the form appears on <a href=http://foo.com/bar rel=external target=_blank>http://foo.com/bar</a>, then it will submit to <a href=http://foo.com/bar) rel=external target=_blank>http://foo.com/bar)</a>. The url can be relative to the current page, absolute, or even on a different webserver. See the discussion of URLs in the HTTP section.</p></li><li><p><strong>enctype</strong> The <code>enctype</code> attribute specifies the format that form data will be submitted in. The most common values are <code>application/x-www-form-urlencoded</code> (the default), which serializes the key/value pairs using the urlencoding strategy, and <code>multipart/form-data</code>, which uses the multipart encoding scheme, and can interweave binary (file) data into the submission. These encoding strategies are discussed more thoroughly in the chapter on submitting form data.</p></li><li><p><strong>method</strong> The <code>method</code> attribute specifies the HTTP method used to submit the form. The values are usually <code>GET</code> or <code>POST</code>. If the method is not specified, it will be a <code>GET</code> request.</p></li><li><p><strong>target</strong> The target attribute specifies how the server response to the form submission will be displayed. By default, it loads in the current frame (the <code>_self</code>) value. A value of <code>_blank</code> will load the response in a new tab. If <code>&lt;iframe></code> elements are being used, there are additional values that work within <code>&lt;iframe></code> sets.</p></li></ul><h2 id=the-input-element>The Input Element</h2><p>Most inputs in a form are variations of the <code>&lt;input></code> element, specified with the <code>type</code> attribute. Many additional specific types were introduced in the HTML5 specification, and may not be available in older browsers (in which case, they will be rendered as a <em>text</em> type input). Currently available types are (an asterisk indicate a HTML5-defined type):</p><ul><li><strong>button</strong>: A push button with no default behavior.</li><li><strong>checkbox</strong>: A check box allowing single values to be selected/deselected. It has an extra attributed <code>checked</code>, which is a boolean specifying if it is checked.</li><li><strong>color*</strong>: A control for specifying a color.</li><li><strong>date*:</strong> A control for entering a date (year, month, and day, with no time).</li><li><strong>datetime-local*</strong>: A control for entering a date and time, with no time zone.</li><li><strong>email:</strong> HTML5 A field for editing an e-mail address.</li><li><strong>file:</strong> A control that lets the user select a file. Use the accept attribute to define the types of files that the control can select.</li><li><strong>hidden:</strong> A control that is not displayed but whose value is submitted to the server.</li><li><strong>image:</strong> A graphical submit button. You must use the src attribute to define the source of the image and the alt attribute to define alternative text. You can use the height and width attributes to define the size of the image in pixels.</li><li><strong>month*:</strong> A control for entering a month and year, with no time zone.</li><li><strong>number*:</strong> A control for entering a number.</li><li><strong>password:</strong> A single-line text field whose value is obscured.</li><li><strong>radio:</strong> A radio button, allowing a single value to be selected out of multiple choices.</li><li><strong>range*:</strong> A control for entering a number whose exact value is not important.</li><li><strong>reset:</strong> A button that resets the contents of the form to default values.</li><li><strong>search*:</strong> A single-line text field for entering search strings. Line-breaks are automatically removed from the input value.</li><li><strong>submit:</strong> A button that submits the form.</li><li><strong>tel*:</strong> A control for entering a telephone number.</li><li><strong>text:</strong> A single-line text field. Line-breaks are automatically removed from the input value.</li><li><strong>time*:</strong> A control for entering a time value with no time zone.</li><li><strong>url*:</strong> A field for entering a URL.</li><li><strong>week*:</strong> A control for entering a date consisting of a week-year number and a week number with no time zone.</li></ul><p>In addition to the <em>type</em> attribute, some other commonly used input attributes are:</p><ul><li><strong>name</strong> The name of the attribute, which is used to identify the submitted value (the name and value attributes define a key/value pair)</li><li><strong>value</strong> The input&rsquo;s current value</li><li><strong>placeholder</strong> A string to display in the input until a value is entered (typically used as a prompt). The placeholder is never submitted as a value.</li><li><strong>readonly</strong> A boolean attribute that when true, indicates the input value cannot be changed</li><li><strong>required</strong> A boolean value indicating that the input is required to have a value before it can be submitted.</li><li><strong>tabindex</strong> Indicates the order in which inputs can be reached by hitting the tab key. For dense input forms, this can be important.</li><li><strong>disabled</strong> A boolean value that when true, means the input is disabled (does not submit a value, cannot be interacted with, and is grayed out)</li></ul><h2 id=other-input-elements>Other &ldquo;Input&rdquo; Elements</h2><p>In addition to the <code>&lt;input></code> element, some other elements exist that provide input-type functionality within a form, and implement the same attributes as an <code>&lt;input></code>. These are:</p><h3 id=textarea>Textarea</h3><p>The <code>&lt;textarea></code> element provides a method for entering larger chunks of text than a <code>&lt;input type="text"></code> does. Most importantly, it preserves line-breaks (the <code>&lt;input type="text"></code> removes them). Instead of using the <code>value</code> attribute, the current value appears inside the opening and closing tags, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>textarea</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;exampleText&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  This text is displayed within the textarea
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>textarea</span><span class=p>&gt;</span></span></span></code></pre></div><p>In addition, the <code>rows</code> and <code>cols</code> attribute can be used to specify the size of the textarea in characters.</p><h3 id=select>Select</h3><p>The <code>&lt;select></code> element allows you to define a drop-down list. It can contain as children, <code>&lt;option></code> and <code>&lt;optgroup></code> elements. The <code>&lt;select></code> element should have its <code>name</code> attribute specified, and each <code>&lt;option></code> element should have a unique <code>value</code> attribute. The selected <code>&lt;option></code>&rsquo;s value is then submitted with the <code>&lt;select></code>&rsquo;s name as a key/value pair.</p><p>Each <code>&lt;select></code> element should also have a closing tag, and its child text is what is displayed to the user.</p><p>The <code>&lt;optgroup></code> provides a way of nesting <code>&lt;option></code> elements under a category identifier (a <code>label</code> attribute specified on the <code>&lt;optgroup></code>).</p><p>An example <code>&lt;select></code> using these features is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>select</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;headgear&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>option</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;none&#34;</span><span class=p>&gt;</span>None<span class=p>&lt;/</span><span class=nt>option</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>optgroup</span> <span class=na>label</span><span class=o>=</span><span class=s>&#34;Hats&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>option</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;ball cap&#34;</span><span class=p>&gt;</span>Ball Cap<span class=p>&lt;/</span><span class=nt>option</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>option</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;derby&#34;</span><span class=p>&gt;</span>Derby<span class=p>&lt;/</span><span class=nt>option</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>option</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;fedora&#34;</span><span class=p>&gt;</span>Fedora<span class=p>&lt;/</span><span class=nt>option</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>optgroup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>optgroup</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;Ceremonial&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>option</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;crown&#34;</span><span class=p>&gt;</span>Crown<span class=p>&lt;/</span><span class=nt>option</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>option</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;mitre&#34;</span><span class=p>&gt;</span>Mitre<span class=p>&lt;/</span><span class=nt>option</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>option</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;war bonnet&#34;</span><span class=p>&gt;</span>War Bonnet<span class=p>&lt;/</span><span class=nt>option</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>optgroup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>select</span><span class=p>&gt;</span></span></span></code></pre></div><p>Finally, multiple selections can be allowed by specifying a <code>multiple</code> attribute as <code>true</code>.</p><h2 id=labels>Labels</h2><p>In addition to inputs, a <code>&lt;form></code> often uses <code>&lt;label></code> elements to help identify the inputs and their function. A label will typically have its <code>for</code> attribute set to match the <code>name</code> attribute of the <code>&lt;input></code> it corresponds to. When connected in this fashion, clicking the label will give focus to the input. Also, when the <code>&lt;input type="checkbox"></code>, clicking the label will also toggle the <code>checked</code> attribute of the checkbox.</p><h2 id=fieldsets>Fieldsets</h2><p>Finally, the <code>&lt;fieldset></code> element can be used to organize controls and labels into a single subcontainer within the form. Much like <code>&lt;div></code> elements, this can be used to apply specific styles to the contained elements.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=common-html-elements>Common HTML Elements</h1><p>This page details some of the most commonly used HTML elements. For a full reference, see MDN&rsquo;s <a href=https://developer.mozilla.org/en-US/docs/Web/HTML/Element rel=external target=_blank>HTML Element Reference</a>.</p><h2 id=document-level-elements>Document-Level Elements</h2><p>These elements describe the basic structure of the HTML document.</p><h3 id=lthtmlgt>&lt;html></h3><p>The <code>&lt;html></code> element contains the entire HTML document. It should have exactly two children, the <code>&lt;head></code> and the <code>&lt;body></code> elements, appearing in that order.</p><h3 id=ltheadgt>&lt;head></h3><p>The <code>&lt;head></code> element contains any metadata describing the document. The most common children elements are <code>&lt;title></code>, <code>&lt;meta></code>, and <code>&lt;link></code>.</p><h3 id=ltbodygt>&lt;body></h3><p>The <code>&lt;body></code> element should be the second child of the <code>&lt;html></code> element. It contains the actual rendered content of the page, typically as nested HTML elements and text. Elements that appear in the body can define structure, organize content, embed media, and play many other roles.</p><h2 id=metadata-elements>Metadata Elements</h2><p>These elements add properties to the document.</p><h3 id=ltlinkgt>&lt;link></h3><p>The <code>&lt;link></code> element links to an external resource using the <code>href</code> attribute and defines that resource&rsquo;s relationship with the document with the <code>rel</code> attibute.</p><p>This is most commonly used to link a stylesheet which will modify how the page is rendered by the browser (see the chapter on CSS). A stylesheet link takes the form:</p><p><code>&lt;link href="path-to-stylesheet.css" rel="stylesheet"/></code></p><p>It can also be used to link a favicon (the icon that appears on your browser tab):</p><p><code>&lt;link rel="icon" type="image/x-icon" href="http://example.com/favicon.ico" /></code></p><h3 id=ltmetagt>&lt;meta></h3><p>The <code>&lt;meta></code> elements is used to describe metadata not covered by other elements. In the early days, its most common use was to list keywords for the website for search engines to use:</p><p><code>&lt;meta keywords="html html5 web development webdev"/></code></p><p>However, this was greatly abused and search engines have stopped relying on them. One of the most common uses today is to set the viewport to the size of the rendering device for responsive design (see the chapter on responsive design):</p><p><code>&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"></code></p><p>Also, best practice is to author HTML documents in utf-8 character format and specify that encoding with a metadata tag with the <code>charset</code> attribute:</p><p><code>&lt;meta charset="utf-8"></code></p><h3 id=ltstylegt>&lt;style></h3><p>The <code>style</code> element allows for embedding CSS text directly into the head section of the HTML page. The Separation of Concerns discussion discusses the appropriateness of using this approach.</p><h3 id=lttitlegt>&lt;title></h3><p>The <code>&lt;title></code> element should only appear once in the <code>&lt;head></code> element, and its content should be text (no HTML elements). It specifies the title of the document. In modern browsers, the title is displayed on the browser tab displaying the document. In earlier browsers, it would appear in the window title bar.</p><h2 id=sectioning-elements>Sectioning Elements</h2><p>Many HTML Elements help define the structure of the document by breaking it into sections. These are intended to hold other elements and text. These elements are <em>block</em> type elements.</p><h3 id=headings>headings</h3><p>The <code>&lt;h1></code>, <code>&lt;h2></code>, <code>&lt;h3></code>, <code>&lt;h4></code>, <code>&lt;h5></code>, and <code>&lt;h6></code> elements are headings and subheadings with six possible levels of nesting. They are used to enclose the title of the section.</p><h3 id=ltmaingt>&lt;main></h3><p>A <code>&lt;main></code> element identifies the content most central in the page. There should be only one per page (or, if multiple main elements are used, the others should have their <code>visible</code> attribute set to false).</p><h3 id=ltaside-gt>&lt;aside ></h3><p>An <code>&lt;aside></code> element identifies content separate from the main focus of the page. It can be used for callouts, advertisements, and the like.</p><h3 id=ltarticlegt>&lt;article></h3><p>An <code>&lt;article></code> element identifies a stand-alone piece of content. Unlike an aside, it is intended for syndication (reprinting) in other forms.</p><h3 id=ltheadergt>&lt;header></h3><p>The <code>&lt;header></code> element identifies a header for the page, often containing the site banner, navigation, etc.</p><h3 id=ltfootergt>&lt;footer></h3><p>The <code>&lt;footer></code> element identifies a footer for the page, often containing copyright and contact information.</p><h3 id=ltnavgt>&lt;nav></h3><p>The <code>&lt;nav></code> element typically contains navigation links and/or menus.</p><h3 id=ltsectiongt>&lt;section></h3><p>A <code>&lt;section></code> element is a general-purpose container for sectioning a page where a more specific container does not make sense.</p><h2 id=text-content>Text Content</h2><p>These HTML elements are used to organize text content. Each of these is a <em>block element</em>, meaning it breaks up the flow of text on the page.</p><h3 id=ltblockquotegt>&lt;blockquote></h3><p>The <code>&lt;blockquote></code> is used to contain a long quotation.</p><h3 id=ltfiguregt>&lt;figure></h3><p>The <code>&lt;figure></code> is used to contain a figure (typically a <code>&lt;img></code> or other media element).</p><h3 id=ltfigcaptiongt>&lt;figcaption></h3><p>The <code>&lt;figcaption></code> provides a caption for a figure</p><h3 id=lthrgt>&lt;hr></h3><p>The <code>&lt;hr></code> provides a horizontal rule (line) to separate text.</p><h3 id=lists>lists</h3><p>There are three types of lists available in HTML, ordered, unordered, and definition. Ordered lists number their contents, and consist of list item elements (<code>&lt;li></code>) nested in an ordered list element (<code>&lt;ol></code>). Unordered lists are bulleted, and consist of list item elements (<code>&lt;li></code>) nested in an unordered list element (<code>&lt;ul></code>). List items can contain any kind of HTML elements, not just text.</p><p>Definition lists nest a definition term (<code>&lt;dt></code>) and its corresponding definition (<code>&lt;dd></code>) inside a definition list (<code>&lt;dl></code>) element. While rarely used, they can be handy when you want to provide lists of definitions (as in a glossary) in a way a search engine will recognize.</p><h3 id=ltdivgt>&lt;div></h3><p>The <code>&lt;div></code> element provides a wrapper around text content that is normally used to attach styles to.</p><h3 id=ltpregt>&lt;pre></h3><p>The <code>&lt;pre></code> tag informs the browser that its content has been preformatted, and its contents should be displayed exactly as written (i.e. whitespace is respected, and angle brackets (&lt;>) are rendered rather than interpreted as HTML. It is often used in conjunction with a <code>&lt;code></code> element to display source code within a webpage.</p><h2 id=inline-text-elements>Inline Text Elements</h2><p>The following elements modify nested text while maintaining the flow of the page. As the name suggests, these are <em>inline</em> type elements.</p><h3 id=ltagt>&lt;a></h3><p>The <code>&lt;a></code> anchor element is used to link to another document on the web (i.e. &lsquo;anchoring&rsquo; it). This element is what makes HTML hyper-text, so clearly it is important. It should always have a source (<code>src</code>) attribute defined (use <code>"#"</code> if you are overriding its behavior with JavaScript).</p><h3 id=text-callouts>text callouts</h3><p>A number of elements seek to draw specific attention to a snippet of text, including <code>&lt;strong></code>, <code>&lt;mark></code>, <code>&lt;em></code>, <code>&lt;b></code>, <code>&lt;i></code></p><h4 id=ltstronggt>&lt;strong></h4><p>The <code>&lt;strong></code> element indicates the text is <em>important</em> in some way. Typically browsers will render its contents in boldface.</p><h4 id=ltemgt>&lt;em></h4><p>The <code>&lt;em></code> element indicates <em>stress emphasis</em> on the text. Typically a browser will render it in italics.</p><h4 id=ltmarkgt>&lt;mark></h4><p>The <code>&lt;mark></code> element indicates text of specific <em>relevance</em>. Typically the text appears highlighted.</p><h4 id=ltbgt>&lt;b></h4><p>The <em>bring to attention</em> element (<code>&lt;b></code>) strives to bring attention to the text. It lacks the semantic meaning of the other callouts, and typically is rendered as boldface (in early versions of HTML, it referred to bold).</p><h4 id=ltigt>&lt;i></h4><p>The <code>&lt;i></code> element sets off the contained text for some reason other than emphasis. It typically renders as italic (in early versions of HTML, the i referred to italics).</p><h3 id=ltbrgt>&lt;br></h3><p>The break element (<code>&lt;br></code>) inserts a line break into the text. This is important as all whitespace in the text of an HTML document is collapsed into a single space when interpreted by a browser.</p><h3 id=ltcodegt>&lt;code></h3><p>The <code>&lt;code></code> element indicates the contained text is computer code.</p><h3 id=ltspangt>&lt;span></h3><p>The <code>&lt;span></code> element is the inline equivalent of the <code>&lt;div></code> element; it is used primarily to attach CSS rules to nested content.</p><h2 id=media-elements>Media Elements</h2><p>A number of elements bring media into the page.</p><h3 id=ltimggt>&lt;img></h3><p>The <code>&lt;img></code> element represents an image. It should have a source (<code>src</code>) attribute defined, consisting of a URL where the image data can be retrieved, and an alternative text (<code>alt</code>) attribute with text to be displayed when the image cannot be loaded or when the element is read by a screen reader.</p><h3 id=ltaudiogt>&lt;audio></h3><p>The <code>&lt;audio></code> element represents audio data. It should also have a source (<code>src</code>) attribute to provide the location of the video data. Alternatively, it can contain multiple <code>&lt;source></code> elements defining alternative forms of the video data.</p><h3 id=ltvideogt>&lt;video></h3><p>The <code>&lt;video></code> element represents a video. It should also have a source (<code>src</code>) attribute to provide the location of the video data. Alternatively, it can contain multiple <code>&lt;source></code> elements defining alternative forms of the audio data.</p><h3 id=ltsourcegt>&lt;source></h3><p>The <code>&lt;source></code> element specifies one form of multimedia data, and should be nested inside a <code>&lt;video></code> or <code>&lt;audio></code> element. Providing multiple sources in this way allows the browser to use the first one it understands (as most browsers do not support all possible media formats, this allows you to serve the broadest possible audience). Each <code>&lt;source></code> element should have a source attribute (<code>src</code>) defining where its multimedia data can be located, as well as a <code>type</code> attribute defining what format the data is in.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter B</div><h1 id=cascading-style-sheets>Cascading Style Sheets</h1><p>Making web pages pretty since 1994.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Cascading Style Sheets</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>Style sheets are collections of rules for modifying how a SGML document appears. Cascading Style Sheets (CSS) are the specific implementation adopted by the W3C for HTML.</p><p>The core concept of CSS is that defines rules altering the appearance of HTML elements that can be selectively applied. These rules are held in a document (the style sheet) and are applied in a well-defined priority order (the <em>cascading</em> part of CSS).</p><p>As of CSS Version 3, CSS technologies were split into separate <em>modules</em> allowing them to be revised and maintained separately. Each module adds or extends features to those defined in CSS Version 2, in order to maintain backwards compatibility.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>The CSS standards, along with many other web technologies, are maintained by the <a href=https://www.w3.org/ rel=external target=_blank>World-Wide-Web Consortium</a> (abbreviated W3C), stakeholders who create and maintain web standards. The full drafts of the Cascading Style Sheets standards can be found here <a href=https://www.w3.org/Style/CSS/ rel=external target=_blank>w3c&rsquo;s CSS page</a>.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=css-rules>CSS Rules</h1><p>CSS properties consist of key-value pairs separated by a colon (<code>:</code>). For example:</p><p><code>color: red</code></p><p>indicates that the styled HTML elements should be given a red color.</p><p>Multiple properties are separated by semicolons (<code>;</code>), i.e.:</p><div class=highlight><pre tabindex=0><code>color: red;
background-color: green;</code></pre></div><p>Rules are CSS properties grouped within curly braces (<code>{}</code>) and proceeded by a CSS selector to identify the HTML element(s) they should be applied to:</p><div class=highlight><pre tabindex=0><code>p {
  color: red;
  background-color: green;
}</code></pre></div><p>In this example, all paragraph elements (<code>&lt;p></code>) should have red text on a green background (how festive!).</p><p style=color:red;background-color:green>And difficult to read!</p><h2 id=short-forms>Short Forms</h2><p>Some properties have multiple forms allowing for some abbreviation. For example, the CSS property:</p><p><code>border: 1px solid black</code></p><p>is a short form for three separate border-related properties:</p><div class=highlight><pre tabindex=0><code>border-width: 1px;
border-style: solid;
border-color: black;</code></pre></div><h2 id=experimental-features-and-prefixes>Experimental Features and Prefixes</h2><p>As new features are considered for inclusion in CSS, browsers may adopt experimental implementations. To separate these from potentially differing future interpretations, these experimental properties are typically <em>prefixed</em> with a browser-specific code:</p><ul><li><strong>-webkit-</strong> Webkit Browsers (Chrome, Safari, newer Opera versions, and iOS)</li><li><strong>-moz-</strong> Mozilla</li><li><strong>-ms-</strong> Microsoft browsers (IE, Edge)</li><li><strong>-o-</strong> Older Opera versions</li></ul><p>For example, most browsers adopted the <code>box-shadow</code> property before it achieved candidate status, so to use it in the Mozilla browser at that point you would use:</p><p><code>-moz-box-shadow: black 2px 2px 2px</code></p><p>To make it work for multiple browsers, and future browsers when it was officially adopted, you might use:</p><div class=highlight><pre tabindex=0><code>-webkit-box-shadow: black 2px 2px 2px;
-moz-box-shadow: black 2px 2px 2px;
-ms-box-shadow: black 2px 2px 2px;
box-shadow: black 2px 2px 2px;</code></pre></div><p>The browser will ignore any properties it does not recognize, hence in Chrome 4, the <code>-webkit-box-shadow</code> will be used and the rest ignored, while in Chrome 10+ the <code>box-shadow</code> property will be used.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>You should always place the not-prefixed version last, to override the prefixed version if the browser supports the official property.</p></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p><a href=https://developer.mozilla.org rel=external target=_blank>The Mozilla Developer Network</a> maintains a wiki of comprehensive descriptions of CSS properties and at the bottom of each property&rsquo;s page is a table of detailed browser support. For example, the box-shadow property description can be found at: <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/box-shadow rel=external target=_blank>https://developer.mozilla.org/en-US/docs/Web/CSS/box-shadow</a>. By combining the css property name and the keyword <strong>mdn</strong> in a Google search, you can quickly reach the appropriate page.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=css-selectors>CSS Selectors</h1><p>In the example from the previous section, we saw:</p><div class=highlight><pre tabindex=0><code>p {
  color: red;
  background-color: green;
}</code></pre></div><p>Here the <code>p</code> is a <em>CSS Selector</em>, which tells us what elements on the page the CSS rules should be applied to.</p><h2 id=simple-selectors>Simple Selectors</h2><p>The most basic CSS selectors come in several flavors, which we&rsquo;ll take a look at next. Simple selectors are a string composed of alphanumeric characters, dashes (<code>-</code>), and underscores (<code>_</code>). Certain selectors also use additional special characters.</p><h3 id=type-selector>Type Selector</h3><p>Type selectors apply to a specific type of HTML element. The <code>p</code> in our example is a type selector matching the paragraph element.</p><p>A type selector is simply the name of the HTML element it applies to - the tag name from our discussion of HTML element structure.</p><h3 id=class-selector>Class Selector</h3><p>A class selector is a proceeded by a period (<code>.</code>), and applies to any HTML element that has a matching <code>class</code> attribute. For example, the CSS rule:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>.</span><span class=nc>danger</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>  <span class=k>color</span><span class=p>:</span> <span class=kc>red</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>would apply to both the paragraph and button elements:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>Hello<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>p</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;danger&#34;</span><span class=p>&gt;</span>You are in danger<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>button</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;danger&#34;</span><span class=p>&gt;</span>Don&#39;t click me!<span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span></span></span></code></pre></div><p>as both have the class <code>danger</code>. A HTML element can have multiple classes applied, just separate each class name with a space:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>p</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;danger big-text&#34;</span><span class=p>&gt;</span>I have two classes!<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span></span></span></code></pre></div><h3 id=id-selector>ID Selector</h3><p>An ID selector is proceeded by a hash (<code>#</code>) and applies to the HTML element that has a matching <code>id</code> attribute. Hence:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>p</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;lead&#34;</span><span class=p>&gt;</span>This paragraph has an id of &#34;lead&#34;<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span></span></span></code></pre></div><p>would be matched by:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>#</span><span class=nn>lead</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>font-size</span><span class=p>:</span> <span class=mi>16</span><span class=kt>pt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>It is important to note that the <code>id</code> attribute <em>should be unique within the page</em>. If you give the same id to multiple elements, the results will be unpredictable (and doing so is invalid HTML).</p><h3 id=universal-selector>Universal Selector</h3><p>The asterisk (<code>*</code>) is the universal selector, and applies to all elements. It is often used as part of a <em>reset</em> - CSS rules appearing at the beginning of a CSS document to remove browser-specific styles before applying a site&rsquo;s specific ones. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=o>*</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>margin</span><span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>padding</span><span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>sets all element margins and paddings to 0 instead of a browser default. Later rules can then apply specific margins and padding.</p><h3 id=attribute-selector>Attribute Selector</h3><p>The attribute selector is wrapped in square brackets (<code>[]</code>) and selects HTML elements with matching attribute values, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=o>[</span><span class=nt>readonly</span><span class=o>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>color</span><span class=p>:</span> <span class=kc>gray</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>will make any element with a <code>readonly</code> attribute have gray text. The value can also be specified exactly, i.e.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=o>[</span><span class=nt>href</span><span class=o>=</span><span class=s2>&#34;www.k-state.edu&#34;</span><span class=o>]</span></span></span></code></pre></div><p>or partially. See <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/Attribute_selectors#Syntax rel=external target=_blank>MDN&rsquo;s documentation</a> for details.</p><h2 id=compound-selectors>Compound Selectors</h2><p>Simple selectors can be used in conjunction for greater specificity. For example, <code>a.external-link</code> selects all <code>&lt;a></code> elements with a class of <code>external-link</code>, and <code>input[type=checkbox]</code> selects all <code>&lt;input></code> elements with an attribute <code>type</code> set to <code>checkbox</code>.</p><h2 id=pseudo-class>Pseudo-Class</h2><p>Pseudo-class selectors are proceeded with a single colon (<code>:</code>), and refer to the state of the element they modify. Pseudo-classes must therefore be appended to a selector.</p><p>The most commonly used pseudo-class is <code>:hover</code>, which is applied to an element that the mouse is currently over. Moving the mouse off the element will make this selector no longer apply. For example, <code>a:hover</code> applies only to <code>&lt;a></code> elements with the mouse directly over them.</p><p>Another extremely useful pseudo-class is <code>:nth-child()</code>, which applies to the nth child (specify as an argument), i.e. <code>ul:nth-child(2)</code> will apply to the second child of any unordered list. Additionally, <code>tr:nth-child(odd)</code> will apply to the odd-numbered rows of a table.</p><p>Additional pseudo-classes can be found in the <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/Pseudo-classes rel=external target=_blank>MDN documentation</a></p><h2 id=combinators>Combinators</h2><p>Combinators can be used to combine both simple and compound selectors using an operator.</p><h3 id=adjacent-sibling-combinator>Adjacent Sibling Combinator</h3><p>The plus symbol (<code>+</code>) can be used to select an adjacent sibling HTML element. To be siblings, the first element must be followed by the second, and both must be children of a shared parent. I.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>h1</span> <span class=o>+</span> <span class=nt>p</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>font-weight</span><span class=p>:</span> <span class=kc>bold</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>will bold all paragraphs that directly follow a first-level header.</p><h3 id=general-sibling-combinator>General Sibling Combinator</h3><p>The tilde symbol (<code>~</code>) also selects a sibling, but they do not need to be adjacent, just children of the same parent. The first element must still appear before the second (just not immediately after).</p><h3 id=child-combinator>Child Combinator</h3><p>The greater than symbol (<code>></code>) selects elements that are direct children of the first element. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>p</span> <span class=o>&gt;</span> <span class=nt>a</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>font-weight</span><span class=p>:</span> <span class=kc>bold</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Will bold all anchor elements that are direct children of a paragraph element.</p><h3 id=descendant-combinator>Descendant Combinator</h3><p>A space (<code> </code>) selects elements that are descendants of the first element.</p><h2 id=multiple-selectors>Multiple Selectors</h2><p>Finally, we can apply the same rules to a collection of selectors by separating the selectors with commas, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>a</span><span class=o>,</span> <span class=nt>p</span><span class=o>,</span> <span class=nt>span</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>font-family</span><span class=p>:</span> <span class=s2>&#34;Comic Sans&#34;</span><span class=p>,</span> <span class=kc>sans-serif</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Applies Comic Sans as the font for all <code>&lt;a></code>, <code>&lt;p></code>, and <code>&lt;span></code> elements.</p><h2 id=pseudo-elements>Pseudo-Elements</h2><p>An interesting newer development in CSS is the development of <em>psuedo-elements</em>, selectors that go beyond the elements included in the HTML of the page. They are proceeded by <em>two</em> colons (<code>::</code>). For example, the <code>::first-letter</code> selector allows you to change the first letter of a HTML element. Thus:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>p</span><span class=p>:</span><span class=nd>first-child</span><span class=p>::</span><span class=nd>first-letter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>font-size</span><span class=p>:</span> <span class=mi>20</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>font-weight</span><span class=p>:</span> <span class=kc>bold</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>float</span><span class=p>:</span> <span class=kc>left</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>creates drop caps for all initial paragraphs.</p><p>A second use of pseudo-elements is to create new elements around existing ones with <code>::before</code> or <code>::after</code>. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>a</span><span class=p>.</span><span class=nc>external-link</span><span class=p>::</span><span class=nd>after</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=k>content</span><span class=p>:</span> <span class=nb>url</span><span class=p>(</span><span class=sx>external-link-icon.png</span><span class=p>);</span> 
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Would add the <code>external-link-icon.png</code> image after any <code>&lt;a></code> elements with the <code>external-link</code> class.</p><p>More information can be found in the <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/Pseudo-elements rel=external target=_blank>MDN Documentation</a>.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=applying-css-rules>Applying CSS Rules</h1><p>There are multiple ways CSS rules can be applied to HTML elements. A document containing CSS rules can be attached to a HTML document with a <code>&lt;link></code> element, embedded directly into the html page with a <code>&lt;style></code> element, or applied directly to a HTML element with the <code>style</code> attribute. Let&rsquo;s look at each option.</p><h2 id=linked-css-documents>Linked CSS Documents</h2><p>The <code>&lt;link></code> HTML element can be used to link the HTML page it appears in to a text file of CSS rules. These rules will then be applied to the HTML elements in the HTML document.</p><p>The <code>&lt;link></code> element should provide a hypertext reference attribute (<code>href</code>) providing a location for the linked document, and a relationship attribute (<code>rel</code>) describing the relationship between the HTML document and the stylesheet (hint: for a stylesheet the relationship is <code>"stylesheet"</code>). If either of these attributes is missing or invalid, the stylesheet&rsquo;s rules will not be used.</p><p>For example, if the stylesheet is in the file styles.css, and our page is page.html, and both reside at the root of our website, the <code>&lt;link></code> element would be:</p><p><code>&lt;link href="/styles.css" rel="stylesheet" type="text/css"/></code></p><p>By placing our CSS rules in a separate file and linking them to where they are used, we can minimize code duplication. This approach also contributes to the <a href=https://en.wikipedia.org/wiki/Separation_of_concerns rel=external target=_blank>separation of concerns</a>. Thus, it is widely seen as a best practice for web development.</p><p>The <code>&lt;link></code> element should be declared within the <code>&lt;head></code> element.</p><h2 id=html-ltstylegt-element>HTML &lt;style> Element</h2><p>The <code>&lt;style></code> HTML element can be used to embed CSS rules directly in an HTML page. Its content is the CSS rules to be applied. The <code>&lt;style></code> element must be a child of a <code>&lt;head></code> or <code>&lt;body></code> element, though placing it into the <code>&lt;head></code> element is best practice.</p><p>To repeat our earlier efforts of making paragraphs have red text and green backgrounds with the <code>&lt;style></code> element:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Style Element Example<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>p</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>        <span class=k>color</span><span class=p>:</span> <span class=s1>&#39;red&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>background-color</span><span class=p>:</span> <span class=s1>&#39;green&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div><p>Unlike the <code>&lt;link></code> element approach, CSS rules defined with the <code>&lt;style></code> element can only be used with one file - the one in which they are embedded. Thus, it can lead to code duplication. And embedding CSS rules in an HTML document also breaks the <a href=https://en.wikipedia.org/wiki/Separation_of_concerns rel=external target=_blank>separation of concerns</a> design principle.</p><p>However, there are several use cases for which the <code>&lt;style></code> element is a good fit. Most obvious is a HTML page that is being distributed as a file, rather than hosted on a server. If the style information is embedded in that HTML file, the recipient only needs to receive the one file, rather than two. Similarly, emails with HTML bodies typically use a <code>&lt;style></code> element to add styling to the email body.</p><h2 id=the-html-element-style-attribute>The HTML Element Style Attribute</h2><p>The <code>style</code> attribute of any HTML element can be used to apply CSS rules to that specific element. These rules are provided a string consisting of key/value pairs separated by semicolons. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>This is a normal paragraph.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>p</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;color: orange; font-weight: bold&#34;</span><span class=p>&gt;</span>But this one has inline styles applied to it.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span></span></span></code></pre></div><p>Produces this:</p><p>This is a normal paragraph.</p><p style=color:orange;font-weight:700>But this one has inline styles applied to it.</p><p>It should be clear from a casual glance that inline styles will make your code more difficult to maintain, as your styling rules will be scattered throughout a HTML document, instead of collected into a <code>&lt;style></code> element or housed in a separate CSS file. And while inline styles can be used to selectively modify individual elements, CSS selectors (covered in the previous section) are typically a better approach.</p><p>Where inline styles make the most sense is when we manipulate the elements on the page directly using JavaScript. Also, the browser developer tools let us manipulate inline styles directly, which can be helpful when tweaking a design. Finally, some component-based design approaches (such as React) pivot the Separation of Concerns design principle to break a user interface into autonomous reusable components; in this approach content, style, and functionality are merged at the component level, making inline styles more appropriate.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=css-cascade>CSS Cascade</h1><p>Now that we know how to create an apply CSS rules to our HTML, let&rsquo;s explore how they actually are used. A core idea behind CSS is the <strong>cascade algorithm</strong>, the <em>cascading</em> in <em>cascading style sheets (CSS)</em>. The core idea behind the cascade algorithm is that as the browser encounters and parses CSS rules, they are collectively applied to the elements they match with. If the same rule is set multiple times, say <code>color</code>, the cascading algorithm decides which should be applied.</p><h2 id=css-sources>CSS Sources</h2><p>Before we look at how cascades work, we need to understand the sources of CSS rules. So far we&rsquo;ve focused on CSS rules created by the <em>author</em> - that is, the developer of the website. But there are two other sources of CSS rules, the <em>user-agent</em> and the <em>user</em>.</p><h3 id=user-agent>User-Agent</h3><p>The term <strong>user-agent</strong> is the technical way of describing the browser (or other software) that is accessing the webpage. Most browsers define default styles for their browser that help differentiate them from other browsers. These default values work well for less-styled websites, but for a carefully designed user experience, an unexpected rule can wreak havoc.</p><p>For this reason, many websites use a special CSS file that overrides user-agent sheets to allow the website to start from a well-known state. This is possible because rules appearing in sheets defined by the author override those defined in user-agent sheets.</p><h3 id=author>Author</h3><p>The <strong>author</strong> is simply the creator of the webpage. Thus, rules included with the <code>&lt;link></code> or <code>&lt;style></code> elements, as well as in-line styles defined on the elements themselves with the <code>style</code> attribute, fall into this category. Author styles always override user-agent styles, and are overridden in turn by user styles.</p><h3 id=user>User</h3><p>The <strong>user</strong> is the actual user of the browser, and they can add their own styles to an HTML document in a variety of ways. One that you may encounter the most is adding custom styles with the web developer tools. One that you may have not encountered, but is common in practice, are styles intended to make the website easier for the vision impaired to read and work with. Increasing or decreasing text size with <code>[CTRL] + [+]</code> or <code>[CTRL] + [-]</code> is a simple example of this kind of tool.</p><h2 id=cascading-order>Cascading Order</h2><p>Thus, the general order of rules applied by the cascading algorithm is user-agent, author, user. However, there is also the <code>!important</code> directive that can be added to CSS rules, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>p</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>color</span><span class=p>:</span> <span class=kc>red</span> <span class=cp>!important</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>which escalates them to a higher pass. Also, CSS animations and transitions are evaluated at their own priority level. Thus, we have a cascade order of:</p><table class=standard-table><thead><tr><th scope=col>&nbsp;</th><th scope=col>Origin</th><th scope=col>Importance</th></tr></thead><tbody><tr><td>1</td><td>user agent</td><td>normal</td></tr><tr><td>2</td><td>user</td><td>normal</td></tr><tr><td>3</td><td>author</td><td>normal</td></tr><tr><td>4</td><td>animations</td><td>&nbsp;</td></tr><tr><td>5</td><td>author</td><td><code>!important</code></td></tr><tr><td>6</td><td>user</td><td><code>!important</code></td></tr><tr><td>7</td><td>user agent</td><td><code>!important</code></td></tr><tr><td>8</td><td>transitions</td><td>&nbsp;</td></tr></tbody></table><p>A more thorough discussion of the Cascade Algorithm can be found in the <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/Cascade rel=external target=_blank>MDN Documentation</a>.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=css-specificity>CSS Specificity</h1><p>But what about two rules that conflict that appear in the same level of the cascade order? For example, given the CSS:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>p</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>color</span><span class=p>:</span> <span class=kc>black</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nc>warning</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>color</span><span class=p>:</span> <span class=kc>red</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>what would the color of <code>&lt;p class="warning"></code> be? You might say it would be <code>red</code> because the <code>.warning</code> CSS rules come <em>after</em> the <code>p</code> rules. And that would be true if the two rules had the same <em>specificity</em>. An example of that is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>p</span> <span class=p>{</span><span class=k>color</span><span class=p>:</span> <span class=kc>black</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nt>p</span> <span class=p>{</span><span class=k>color</span><span class=p>:</span> <span class=kc>red</span><span class=p>}</span></span></span></code></pre></div><p>Clearly the two selectors are equivalent, so the second <code>color</code> rule overrides the first. But what if we go back to our first example, but flip the rules?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>.</span><span class=nc>warning</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>color</span><span class=p>:</span> <span class=kc>red</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nt>p</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>color</span><span class=p>:</span> <span class=kc>black</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>In this case, the color is <em>still</em> <code>red</code>, because <code>.warning</code> is more <em>specific</em> than <code>p</code>. This is the concept of <em>specificity</em> in CSS, which has an actual, calculable value.</p><h2 id=specificity-calculations>Specificity Calculations</h2><p>The specificity of a selector increases by the type and number of selectors involved. In increasing value, these are:</p><ol><li>Type selectors and pseudo-elements</li><li>Class selectors, attribute selectors, and pseudo-classes</li><li>ID selectors</li></ol><p>Each of these is trumped by in-line CSS rules, which can be thought of as the highest specificity. Thus, we can think of specificity as a 4-element tuple (A, B, C, D):</p><p><a href=#R-image-8bed063a83b2f74a9cfee31d6dc64e91 class=lightbox-link><img alt="Specificity Tuple" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/B.6.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8bed063a83b2f74a9cfee31d6dc64e91><img alt="Specificity Tuple" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/B.6.1.png></a></p><p>We can then calculate the values of A,B,C,D:</p><ul><li>Count 1 if the declaration is from a ‚Äòstyle‚Äô attribute (inline style) rather than a rule with a selector, 0 otherwise (= A).</li><li>Count the number of IDs in the selector (= B).</li><li>Count the number of Classes, attributes and pseudo-classes in the selector (= C).</li><li>Count the number of Element names and pseudo-elements in the selector (= D).</li></ul><h2 id=the-important-loophole>The !important Loophole</h2><p>Finally, there is an extra trick that we can use when we are having trouble creating enough specificity for a CSS rule. We can add <code>!important</code> to the rule declaration. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>p</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>color</span><span class=p>:</span> <span class=kc>red</span> <span class=cp>!important</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>The <code>!important</code> rule overrides any other CSS declarations, effectively sidestepping specificity calculations. It should be avoided whenever possible (by making good use of specificity), but there are occasions it might be necessary.</p><p>If multiple rules use <code>!important</code>, then their priority is again determined by specificity amongst the group.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=css-units>CSS Units</h1><p>When specifying CSS rules, you often need to provide a unit of measurement. Any time you provide a measurement in a CSS rule, you must provide the units that measurement is being expressed in, following the value. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>#</span><span class=nn>banner</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>width</span><span class=p>:</span> <span class=mi>300</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>sets the width of the element with id <code>banner</code> to 300 pixels.</p><p>There are actually a lot of units available in CSS, and we&rsquo;ll summarize the most common in this section.</p><h2 id=units-of-absolute-size>Units of Absolute Size</h2><p>Absolute units don&rsquo;t change their size in relation to other settings, hence the name. The most common one encountered is pixels, which are expressed with the abbreviation <code>px</code>.</p><p>Other absolute measurements include:</p><ul><li><p><code>q</code>, <code>mm</code>, <code>cm</code>, <code>in</code> which are quarter-millimeters, millimeters, centimeters, and inches. These are rarely used outside of rules applied when printing websites.</p></li><li><p><code>pt</code>, <code>pc</code> which are <a href=https://en.wikipedia.org/wiki/Point_(typography) rel=external target=_blank>points</a> and <a href=https://en.wikipedia.org/wiki/Pica_(typography) rel=external target=_blank>picas</a>, common units of measurement within the publishing industry.</p></li></ul><h2 id=units-of-relative-size>Units of Relative Size</h2><p>Relative units are based on (relative to) the <code>font-size</code> property of the element, the viewport size, or grid container sizes. These are expressed as proportions of the units they are relative to, i.e.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>.</span><span class=nc>column</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>width</span><span class=p>:</span> <span class=mi>30</span><span class=kt>vw</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>sets columns to be 30% of the width of the viewport.</p><h3 id=units-relative-to-font-size>Units Relative to Font Size</h3><p>Setting dimensions of borders, padding, and margins using units relative to font sizes can help make these appear consistent at different resolutions. Consider a margin of <code>70px</code> - it might make sense on a screen 1024 pixels wide, but on a phone screen 300 pixels wide, nearly half the available space would be margins!</p><p>Units that are relative to the <code>font-size</code> include:</p><ul><li><code>em</code> one <a href=https://en.wikipedia.org/wiki/Em_(typography) rel=external target=_blank>em</a> is the font-size of the current element (which may be inherited from a parent).</li><li><code>rem</code> is same measurement as <code>em</code>, but disregards inherited font sizes. Thus, it is more consistent with intent than <code>em</code>, and is largely displacing its use (though it is not supported in older versions of Internet Explorer).</li></ul><h3 id=units-relative-to-viewport-size>Units Relative to Viewport Size</h3><p>The units <code>vh</code> and <code>vw</code> refer to 1/100th the height of the viewport (the size of the screen space the page can appear within).</p><p>It may be helpful to think of these as the percentage of the viewport width and viewport height, and they work much like percentages. However, in specifying heights, the <code>vh</code> will always set the height of an element, unlike <code>%</code>.</p><h3 id=fraction-units>Fraction Units</h3><p>The Grid model introduced the fraction (<code>fr</code>) unit, which is a fraction of the available space in a grid, after subtracting gutters and items sized in other units. See the discussion of the CSS Grid Model or CSS Tricks&rsquo; <a href=https://css-tricks.com/snippets/css/complete-guide-grid/ rel=external target=_blank>A Complete Guide to Grid</a> for more details.</p><h2 id=percentage-units>Percentage Units</h2><p>You can also specify percentages (<code>%</code>) for many properties, which are typically interpreted as a percentage of the parent element&rsquo;s width or height. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>.</span><span class=nc>column</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>width</span><span class=p>:</span> <span class=mi>33</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>sets elements with the class <code>column</code> to be 33% the width of their parent element. Similarly:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>.</span><span class=nc>row</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>height</span><span class=p>:</span> <span class=mi>20</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>sets elements with a class <code>row</code> to be 20% the height of their parent element.</p><p>If the parent does not have an explicit width, the width of the next ancestor with a supplied width is used instead, and if no ancestor has a set width, that of the viewport is used. The same is <em>almost</em> true of the height; however, if no elements have a specified height, then the percentage value is ignored - the element is sized according to its contents, as would be the case with <code>height: auto</code>.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p>One of the most frustrating lessons beginning HTML authors must learn is the difference in how width and height are handled when laying out a webpage. Using the percentage unit (<code>%</code>) to set the height almost never accomplishes the goal you have in mind - it only works if the containing element has a set height.</p><p>While there are hacky techniques that can help, they only offer partial solutions. It is usually best not to fight the design of HTML, and adopt layouts that can flow down the page rather than have a height determined at render time.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=css-functions>CSS Functions</h1><p>CSS provides a number of useful functions that calculate values. Functions are written in the form <code>name(arg1, arg2, ...)</code> and are provided as values to CSS properties. For example, this CSS code sets the height of the content area to the available space on screen for content after subtracting a header and footer:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>#</span><span class=nn>header</span> <span class=p>{</span><span class=k>height</span><span class=p>:</span> <span class=mi>150</span><span class=kt>px</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>#</span><span class=nn>footer</span> <span class=p>{</span><span class=k>height</span><span class=p>:</span> <span class=mi>100</span><span class=kt>px</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>#</span><span class=nn>content</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>height</span><span class=p>:</span> <span class=nb>calc</span><span class=p>(</span><span class=mi>100</span><span class=kt>vh</span> <span class=o>-</span> <span class=mi>150</span><span class=kt>px</span> <span class=o>-</span> <span class=mi>100</span><span class=kt>px</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Here <code>100vh</code> is the height of the viewport, and the header and footer are defined in terms of pixels.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>You might want to apply the <code>box-sizing: border-box</code> on these elements if they have padding and borders, or these additional dimensions will need to be included in the calculation. See the section on the <a href=https://textbooks.cs.ksu.edu/cis526/b-css/11-box-model/ rel=external target=_blank>CSS Box Model</a> for more details.</p></div></div><h2 id=math-functions>Math Functions</h2><p>CSS provides a number of useful math functions:</p><h3 id=the-calc-function>The Calc Function</h3><p>As you have seen above, the <code>calc()</code> function can be used to calculate values by performing arithmetic upon values. These values can be in different units (i.e. <code>calc(200px - 5mm)</code> or even determined as the webpage is being interpreted (i.e. <code>calc(80vw + 5rem)</code>). See the <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/calc rel=external target=_blank>MDN Documentation</a> for more details.</p><h3 id=the-min-and-max-functions>The Min and Max Functions</h3><p>CSS also provides <code>min()</code> and <code>max()</code> function, which provide the smallest or largest from the provided arguments (which can be arbitrary in number). As with <code>calc()</code>, it can do so with interpretation-time values.</p><h3 id=the-clamp-function>The Clamp Function</h3><p>The <code>clamp()</code> function clamps a value within a provided range. Its first argument is the minimum value, the second the preferred value, and the third the max. If the preferred value is between the min and max value, it is returned. If it is less than the minimum, the min is instead returned, or if it is greater than the maximum, the max value is returned.</p><h2 id=color-functions>Color Functions</h2><p>Several CSS functions are used to create an modify colors. These are described in the CSS Color section.</p><h2 id=transformation-functions>Transformation Functions</h2><p>Many CSS functions exist for specifying CSS transforms. See the <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/transform rel=external target=_blank>MDN documentation</a> for details.</p><h2 id=image-filter-functions>Image Filter Functions</h2><p>CSS allows for filters to be applied to images. More details can be found in the <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/filter rel=external target=_blank>Mozilla Documentation</a>.</p><h2 id=counter-functions>Counter Functions</h2><p>Finally CSS uses counters to determine row number and ordered list numbers. These can be manipulated and re-purposed in various ways. See the <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Lists_and_Counters/Using_CSS_counters rel=external target=_blank>MDN Documentation</a> for details.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=css-colors>CSS Colors</h1><p>CSS also has many properties that can be set to a color, i.e. <code>color</code>, <code>background-color</code>, <code>border-color</code>, <code>box-shadow</code>, etc. Colors consist of three or four values corresponding to the amount of red, green, and blue light blended to create the color. The optional fourth value is the alpha, and is typically used to specify transparency.</p><p>Colors are stored as 24-bit values, with 8 bits for each of the four channels (R,G,B,and A), representing 256 possible values (2^8) for each channel.</p><p>Colors can be specified in one of several ways:</p><ul><li><p><strong>Color Keywords</strong> like <code>red</code>, <code>dark-gray</code>, <code>chartreuse</code> correspond to well-defined values. You can find the full list <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/color_value#Color_keywords rel=external target=_blank>in the MDN Documentation</a>.</p></li><li><p><strong>Hexidecimal Values</strong> like <code>#6495ed</code>, which corresponds to cornflower blue. The first two places represent the red component, the second the green, and the third the blue. If an additional two places are provided the last pair represents the alpha component. Each pair of hex values can represent 256 possible values (16^2), and is converted directly to the binary color representation in memory.</p></li><li><p><strong>RGB Function</strong> a third option is to use the <code>RGB()</code> CSS function. This take decimal arguments for each channel which should be in the range 0-255</p></li><li><p><strong>HSL Function</strong> a fourth option is the <code>HSL()</code> function, which specifies colors in terms of an alternative scheme of <a href=https://en.wikipedia.org/wiki/HSL_and_HSV#Basic_principle rel=external target=_blank>hue, saturation, and lightness</a>.</p></li><li><p><strong>RGBA and HSLA Functions</strong> finally, the <code>RGBA()</code> and <code>HSLA()</code> functions take the same arguments as their siblings, plus a value for the alpha channel between 0 and 1.</p></li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=css-and-text>CSS and Text</h1><p>As the original purpose of the World-Wide-Web was to disseminate written information, it should be no surprise that CSS would provide many properties for working with text. Some of the most commonly employed properties are:</p><ul><li><code>font-family</code> defines the font to use for the text. Its value is one or more font family or generic font names, i.e. <code>font-family: Tahoma, serif</code>, <code>font-family: cursive</code> or <code>font-family: "Comic Sans"</code>. Font family names are typically capitalized and, if they contain spaces or special characters, double-quoted.</li><li><code>font-size</code> determines the size of the font. It can be a measurement or a defined value like <code>x-small</code>.</li><li><code>font-style</code> determines if the font should use its <code>normal</code> (default), <code>italic</code>, or <code>oblique</code> face.</li><li><code>font-weight</code> determines the weight (boldness) of the font. It can be <code>normal</code> or <code>bold</code> as well as <code>lighter</code> or <code>darker</code> than its parent, or specified as a numeric value between 1 and 1000. Be aware that many fonts have a limited number of weights.</li><li><code>line-height</code> sets the height of the line box (the distance between lines of text). It can be <code>normal</code>, or a numeric or percent value.</li><li><code>text-align</code> determines how text is aligned. Possible values are <code>left</code> (default), <code>center</code>, <code>right</code>, <code>justify</code>, along with some newer experimental values.</li><li><code>text-indent</code> indents the text by the specified value.</li><li><code>text-justify</code> is used in conjunction with <code>text-align: justify</code> and specifies how space should be distributed. A value of <code>inter-word</code> distributes space between words (appropriate for English, Spanish, Arabic, etc), and <code>inter-character</code> between characters (appropriate for Japanese, Chinese, etc).</li><li><code>text-transform</code> can be used to capitalize or lowercase text. Values include <code>capitalize</code>, <code>uppercase</code>, and <code>lowercase</code>.</li></ul><h2 id=choosing-fonts>Choosing Fonts</h2><p>An important consideration when working with HTML text is that not all users will have the same fonts you have - and if the font is not on their system, the browser will fall back to a different option. Specifying a generic font name after a Font Family can help steer that fallback choice; for example:</p><div class=highlight><pre tabindex=0><code>body {
  font-family: Lucinda, cursive
}</code></pre></div><p>will use Lucinda if available, or another cursive font if not. Some guidelines on font choice:</p><ul><li><code>cursive</code> fonts should typically only be used for headings, not body text.</li><li><code>serif</code> fonts (those with the additional feet at the base of letters) are easier to read printed on paper, but more difficult on-screen.</li><li><code>sans-serif</code> fonts are easier to read on-screen; your body text should most likely be a sans-serif.</li></ul><h3 id=web-safe-fonts>Web-Safe Fonts</h3><p>Fonts that commonly appear across computing platforms and have a strong possibility of being on a users&rsquo; machine have come to be known as <em>web-safe</em>. Some of these are:</p><ul><li><span style=font-family:Arial>Arial</span></li><li><span style=font-family:Helvetica>Helvetica</span></li><li><span style=font-family:Times>Times</span></li><li><span style='font-family:courier new'>Courier New</span></li><li><span style=font-family:Courier>Courier</span></li><li><span style=font-family:Georgia>Georgia</span></li><li><span style='font-family:lucidia console'>Lucidia Console</span></li><li><span style=font-family:Palatino>Palatino</span></li><li><span style=font-family:Verdana>Verdana</span></li></ul><h3 id=font-face-at-rule>Font-Face at Rule</h3><p>Alternatively, if you wish to use a less-common font, you can provide it to the browser using the <code>@font-face</code> rule. This defines a font and provides a source for the font file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>@</span><span class=k>font-face</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>font-family</span><span class=o>:</span> <span class=nt>examplefont</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=nt>src</span><span class=o>:</span> <span class=nt>url</span><span class=o>(</span><span class=s1>&#39;examplefont.ttf&#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>You can then serve the font file from your webserver.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>Be aware that <em>distributing</em> fonts carries different legal obligations than distributing something <em>printed in</em> the font. Depending on the font license, you may not be legally allowed to distribute it with the <code>@font-face</code> rule. Be sure to check.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=css-box-model>CSS Box Model</h1><p>As the browser lays out HTML elements in a page, it uses the <strong>CSS Box Model</strong> to determine the size and space between elements. The CSS box is composed of four nested areas (or outer edges): the content edge, padding edge, border edge, and margin edge.</p><h2 id=box-areas>Box Areas</h2><p><a href=#R-image-fd97320968d546851a3364b7d525300f class=lightbox-link><img alt="CSS Box Model" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/B.11.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fd97320968d546851a3364b7d525300f><img alt="CSS Box Model" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/B.11.1.png></a></p><p><strong>Content Area</strong> contains the actual content of the element (the text, image, etc). By default the CSS properties <code>width</code> and <code>height</code> set this size, and the <code>min-width</code>, <code>min-height</code>, <code>max-width</code>, <code>max-height</code> constrain it (but see the discussion of <code>box-sizing</code> below).</p><p><strong>Padding Area</strong> provides space between the content and the border of the HTML element. It is set by the <code>padding</code> properties (<code>padding-top</code>, <code>padding-right</code>, <code>padding-bottom</code>, and <code>padding-left</code>, as well as the shorthand versions).</p><p><strong>Border Area</strong> draws a border around the element. Its size is set with the <code>border-width</code> property. Borders can also be dashed, inset, and given rounded corners. See the <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/border rel=external target=_blank>MDN Border Documentation</a> for details.</p><p><strong>Margin Area</strong> provides the space between the border and neighboring elements. Its size is set with the <code>margin</code> properties (<code>margin-top</code>, <code>margin-right</code>, <code>margin-bottom</code>, and <code>margin-left</code>, as well as the shorthand versions).</p><h2 id=box-sizing>Box-Sizing</h2><p>By default, an element&rsquo;s <code>width</code> and <code>height</code> properties set the width and height of the <em>content area</em>, which means any padding, borders, and margins increase the size the element consumes on-screen. This can be altered with the <code>box-sizing</code> CSS rule, which has the following possible values:</p><p><code>content-box</code> (the default) the <code>width</code> and <code>height</code> properties set the content area&rsquo;s size.</p><p><code>border-box</code> includes the border area, padding area, and content area within the <code>width</code> and <code>height</code> of the HTML element. Using the CSS rule <code>box-sizing: border-box</code> therefore makes it easier to lay out elements on the page consistently, without having to do a lot of by-hand calculations.</p><h2 id=backgrounds>Backgrounds</h2><p>The <code>background</code> property allows you to set a color, pattern, or image as the background of an HTML element. By default the background extends to the border-area edge, but can be altered with the <code>border-clip</code> property to <code>border-box</code>, <code>padding-box</code>, or <code>content-box</code>. See the <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/background rel=external target=_blank>MDN Background Documentation</a> for more details on creating backgrounds.</p><h2 id=box-shadow>Box-Shadow</h2><p>The <code>box-shadow</code> property allows you to set a drop shadow beneath the HTML element. See the <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/box-shadow rel=external target=_blank>MDN Documentation</a> for more details on creating box shadows.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=css-positioning>CSS Positioning</h1><p>By default HTML elements are positioned in the page using the HTML flow algorithm. You can find a detailed discussion in the <a href=https://developer.mozilla.org/en-US/docs/Learn/CSS/CSS_layout/Normal_Flow rel=external target=_blank>MDN Documentation</a>. However, you may want to override this and manually position elements, which you can do with the CSS properties <code>position</code>, <code>left</code>, <code>top</code>, <code>right</code>, and <code>bottom</code>.</p><h2 id=the-positioning-context>The Positioning Context</h2><p>First, we need to understand the positioning context, this is basically the area an element is positioned within. The <code>left</code>, <code>top</code>, <code>right</code>, and <code>bottom</code> properties affect where an element appears within its context.</p><p><a href=#R-image-9e518c12a26bb63fb02d86a2350a5c01 class=lightbox-link><img alt="Positioning Context" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/B.12.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9e518c12a26bb63fb02d86a2350a5c01><img alt="Positioning Context" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/B.12.1.png></a></p><p>You can think of the context as a box. The <code>left</code> property determines how far the element is from the left side of this context, the <code>top</code> from the top, <code>right</code> from the right, and <code>bottom</code> from the bottom. These values can be numeric or percentage values, and can be negative.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p>If you define both a <code>left</code> and <code>right</code> value, only the <code>left</code> value will be used. Similarly, if both <code>top</code> and <code>bottom</code> are supplied, only <code>top</code> is used. Use the <code>width</code> and <code>height</code> properties in conjunction with the positioning rules if you want to control the element&rsquo;s dimensions.</p></div></div><p>What constitutes the positioning context depends on the elements <code>position</code> property, which we&rsquo;ll discuss next.</p><h2 id=the-position-property>The Position Property</h2><p>The <code>position</code> property can be one of several values:</p><h3 id=static-positioning>Static Positioning</h3><p>The default <code>position</code> value is <code>static</code>. It positions the element where it would normally be in the flow and ignores any <code>left</code>, <code>top</code>, <code>right</code>, and <code>bottom</code> properties.</p><h3 id=relative-positioning>Relative Positioning</h3><p>The <code>position</code> value of <code>relative</code> keeps the element where it would normally be in the flow, just like <code>static</code>. However, the <code>left</code>, <code>top</code>, <code>right</code>, and <code>bottom</code> properties move the element relative to this position - in effect, the positioning context is the hole the element would have filled with <code>static</code> positioning.</p><h3 id=absolute-positioning>Absolute Positioning</h3><p>Assigning the <code>position</code> property the value of <code>absolute</code> removes the element from the flow. Other statically positioned elements will be laid out as though the absolutely positioned element was never there. The positioning context for an absolutely positioned element is its first non-statically positioned ancestor, or (if there is none), the viewport.</p><p>A common CSS trick is to create a relatively-positioned element, and then absolutely position its children.</p><h3 id=fixed-positioning>Fixed Positioning</h3><p>Assigning the value of <code>fixed</code> to the <code>position</code> property also removes the element from the flow. However, its positioning context is <em>always</em> the viewport. Moreover, if the page is scrolled, a fixed-position element stays in the same spot (an absolutely-positioned element will scroll with the page). This makes fixed position elements useful for dialogs, pop-ups, and the like.</p><h2 id=z-order>Z-Order</h2><p>By default, elements are drawn in the browser in the order they appear in the HTML. Thus, if we position an element further down the page, it may be covered up by succeeding elements. The <code>z-index</code> property provides us with a fix. The default value for the <code>z-index</code> is 0. Items with a larger <code>z-index</code> are drawn later.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=css-layouts>CSS Layouts</h1><p>We often speak of the <a href=https://en.wikipedia.org/wiki/Separation_of_concerns rel=external target=_blank>separation of concerns</a> principle in the context of web development as setting up the roles of HTML, CSS, and JavaScript. In this understanding, HTML provides the organization of content, CSS provides for the presentation of the content, and JavaScript provides for user interaction.</p><p>In this understanding, CSS is often tasked with the role of laying out elements on the page. More specifically, it overrides the default flow of HTML elements (see our earlier discussion of <a href=https://textbooks.cs.ksu.edu/cis526/a-html/04-inline-vs-block/ rel=external target=_blank>block vs. inline elements</a> in the HTML chapter), altering how the browser arranges elements on the page.</p><p>The three most common layout approaches currently used in modern web development are <em>float</em>, <em>flexbox</em>, and <em>grid</em>, named for the CSS properties that make them possible. You may also encounter <em>absolutely positioned</em> layouts and <em>table layouts</em>, so we will briefly discuss those as well.</p><h2 id=float-layouts>Float Layouts</h2><p>By default a block-level element stretches the width of the parent element, and its siblings are pushed underneath. The CSS <code>float</code> property changes this behavior, allowing a block-level element to determine an appropriate width based on its content (or CSS rules), and allows sibling elements to &ldquo;float&rdquo; next to it. Thus, the <code>float</code> property has two primary values, <code>left</code> and <code>right</code> (as well as <code>none</code> and <code>inherit</code>). A <code>float: left</code> causes the element to float on the left side of its containing element, and a <code>float: right</code> floats it to the right.</p><p>A common use is to float figures and images within a page, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;images/Marc-Andreessen.jpg&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>People tend to think of the web as a way to get information or perhaps as a place  to carry out ecommerce. But really, the web is about accessing applications. Think of each website as an application, and every single click, every single interaction with that site, is an opportunity to be on the very latest version of that application.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>span</span><span class=p>&gt;</span>- Marc Andreessen<span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span></span></span></code></pre></div><img src=/images/Marc-Andreessen.jpg style=float:left;width:200px;margin:1rem><p>People tend to think of the web as a way to get information or perhaps as a place to carry out ecommerce. But really, the web is about accessing applications. Think of each website as an application, and every single click, every single interaction with that site, is an opportunity to be on the very latest version of that application.</p><span>- Marc Andreessen</span><div style=clear:both><p>But floats can also be used to create multi-column layouts, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>.</span><span class=nc>column</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>float</span><span class=p>:</span> <span class=kc>left</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>box-sizing</span><span class=p>:</span> <span class=kc>border-box</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>width</span><span class=p>:</span> <span class=mi>33</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>height</span><span class=p>:</span><span class=mi>60</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>color</span><span class=p>:</span> <span class=kc>white</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nc>one</span> <span class=p>{</span><span class=k>background-color</span><span class=p>:</span> <span class=kc>red</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nc>two</span> <span class=p>{</span><span class=k>background-color</span><span class=p>:</span> <span class=kc>blue</span><span class=p>;</span> <span class=k>margin-left</span><span class=p>:</span> <span class=mf>0.5</span><span class=kt>%</span><span class=p>;</span> <span class=k>margin-right</span><span class=p>:</span> <span class=mf>0.5</span><span class=kt>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nc>three</span> <span class=p>{</span><span class=k>background-color</span><span class=p>:</span> <span class=kc>green</span><span class=p>}</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;column one&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  One
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;column two&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  Two
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;column three&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  Three
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span></span></span></code></pre></div><div style=clear:both></div><div class="column one" style=float:left;box-sizing:border-box;width:33%;height:60px;color:#fff;background-color:red>One</div><div class="column two" style=float:left;box-sizing:border-box;width:33%;height:60px;color:#fff;margin-left:.5%;margin-right:.5%;background-color:blue>Two</div><div class="column three" style=float:left;box-sizing:border-box;width:33%;height:60px;color:#fff;background-color:green>Three</div><div style=clear:both></div><p>Finally, when discussing the <code>float</code> property, we need to discuss the <code>clear</code> property as well. The <code>clear</code> property is used to move an element below the margin area of any floating elements - basically resetting the flow of the page. It can selectively clear floating elements in the <code>left</code>, <code>right</code>, or <code>both</code> directions. In our column example, if we wanted to add a footer that stretched across all three columns, we&rsquo;d use something like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>footer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>clear</span><span class=p>:</span> <span class=kc>both</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>border</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=kc>solid</span> <span class=kc>black</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;column one&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  One
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;column two&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  Two
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;column three&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  Three
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>footer</span><span class=p>&gt;</span>Footer<span class=p>&lt;/</span><span class=nt>footer</span><span class=p>&gt;</span></span></span></code></pre></div><div style=clear:both></div><div class="column one" style=float:left;box-sizing:border-box;width:33%;height:60px;color:#fff;background-color:red>One</div><div class="column two" style=float:left;box-sizing:border-box;width:33%;height:60px;color:#fff;margin-left:.5%;margin-right:.5%;background-color:blue>Two</div><div class="column three" style=float:left;box-sizing:border-box;width:33%;height:60px;color:#fff;background-color:green>Three</div><footer style="clear:both;border:1px solid #000">Footer</footer><h2 id=flexbox-layouts>Flexbox Layouts</h2><p>The Flexible Box Layout (flexbox) is intended to offer a greater degree of control and <em>flexibility</em> (pun intended) to laying out web pages. Its purpose is to provide an efficient way of laying out, aligning, and distributing elements within a container. Moreover, it can carry out this goal even when the sizes of the child elements are unknown or dynamic.</p><p><a href=#R-image-a65b817f96ffe7e1fc67c149533fcff3 class=lightbox-link><img alt="flexbox diagram" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/B.13.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a65b817f96ffe7e1fc67c149533fcff3><img alt="flexbox diagram" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/B.13.1.png></a></p><p>The flexbox model therefore consists of two levels of nested elements - an outer <em>container</em> element and inner content <em>item</em> elements (the content item elements themselves can have many decendent elements). The flexbox properties help define how the content item elements are laid out within their parent container.</p><p>An HTML element is turned into a flexbox container by assigning it the <code>display</code> property of <code>flex</code>. Additional properties then control how the elements contained within our new flexbox container are laid out. These include:</p><p><code>flex-direction</code> determines how items are laid out, either <code>row</code>, <code>column</code>, <code>row-reverse</code>, or <code>column-reverse</code>.</p><p><code>wrap-items</code> determines if the row or column wraps into multiple rows or columns. Its values are <code>no-wrap</code> (default), <code>wrap</code>, and <code>wrap-reverse</code>.</p><p><code>justify-content</code> defines how content items will be aligned along the main axis of the container (horizontal for rows, and vertical for columns). Its possible values are: <code>flex-start</code>, <code>flex-end</code>, <code>center</code>, <code>space-between</code>, and <code>space-around</code>.</p><p><code>align-items</code> defines how content items are aligned along the secondary axis of the container (vertically for rows, and horizontally for columns). Its possible values are <code>flex-start</code> (the default), <code>flex-end</code>, <code>center</code>, <code>stretch</code>, and <code>baseline</code>.</p><p>Thus, to re-create our three-column layout with flexbox, we would:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>.</span><span class=nc>three-column</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>display</span><span class=p>:</span> <span class=kc>flex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>flex-direction</span><span class=p>:</span> <span class=kc>column</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>justify-content</span><span class=p>:</span> <span class=kc>space-between</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nc>three-column</span> <span class=o>&gt;</span> <span class=nt>div</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>color</span><span class=p>:</span> <span class=kc>white</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>width</span><span class=p>:</span> <span class=mi>33</span><span class=kt>%</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>height</span><span class=p>:</span> <span class=mi>60</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;three-column&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;one&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    one
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;two&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    two
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;three&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    three
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span></span></span></code></pre></div><div style=display:flex;flex-direction:row;color:#fff;justify-content:space-between><div class="column one" style=background-color:red;width:33%;height:60px>One</div><div class="column two" style=background-color:blue;width:33% height: 60px;>Two</div><div class="column three" style=background-color:green;width:33%;height:60px>Three</div></div><p>The items can also override these default behaviors with item specific CSS attributes, including allowing items to grow with <code>flex-grow</code> or shrink with <code>flex-shrink</code> to fit available space, override the default order of elements using the <code>order</code> attribute, or altering the alignment on a per-item basis with <code>align-self</code>.</p><p>You can also create very sophisticated layouts by nesting flex containers within flex containers. A superb reference for working with flexbox is CSS Tricks&rsquo; <a href=https://css-tricks.com/snippets/css/a-guide-to-flexbox/ rel=external target=_blank>Complete Guide to Flexbox</a>.</p><h2 id=grid-layouts>Grid Layouts</h2><p>While flexbox brought a lot of power to the web designer, the Grid model is an even more powerful way to lay out web elements. Unlike flex, which focuses on arranging elements along one dimension (provided you aren&rsquo;t wrapping), the Grid model lays elements out in a two-dimensional grid.</p><p>An HTML element is turned into a grid container by assigning it the <code>display</code> property of <code>grid</code> or <code>inline-grid</code>. Then you define the size of the grid elements with the properties <code>grid-template-rows</code> and <code>grid-template-columns</code>. These attributes take the measurements of the columns and rows. I.e. we could recreate our three-column layout with <code>grid-template-columns: 33% 33% 33%</code>. But the grid is far more powerful than that. Let&rsquo;s expand our three-column layout to have a separate header and footer:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>div</span><span class=p>#</span><span class=nn>page</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>display</span><span class=p>:</span> <span class=k>grid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>grid-template-columns</span><span class=p>:</span> <span class=mi>1</span><span class=n>fr</span> <span class=mi>1</span><span class=n>fr</span> <span class=mi>1</span><span class=n>fr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>grid-template-rows</span><span class=p>:</span>  <span class=mi>150</span><span class=kt>px</span> <span class=kc>auto</span> <span class=mi>100</span><span class=kt>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Here we use the unit <code>fr</code> for our column width, which proportions out the &ldquo;free space remaining&rdquo; after hard-coded measurements are accounted for. In our case, this translates into three equal-sized columns taking up all the available space.</p><p>For rows, our first row will be the header, and we&rsquo;ve sized it to 150 pixels. The next row is our content, we&rsquo;ve used the <code>auto</code> value to allow it to size appropriately to contain its content. The last row is the footer, and we&rsquo;ve sized it to 100 pixels.</p><p>Our HTML would look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;page&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>header</span><span class=p>&gt;&lt;/</span><span class=nt>header</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;one&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;two&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;three&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>footer</span><span class=p>&gt;&lt;/</span><span class=nt>footer</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span></span></span></code></pre></div><p>And finally, we can assign these HTML elements to part of the grid with the <code>grid-area</code> property, which takes the values for <em>row start</em>, <em>column start</em>, <em>row end</em>, <em>column end</em> separated by slashes (<code>/</code>) to define the area of the grid they span:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>header</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>grid-area</span><span class=p>:</span> <span class=mi>1</span><span class=o>/</span><span class=mi>1</span><span class=o>/</span><span class=mi>2</span><span class=o>/</span><span class=mi>4</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>  <span class=k>border</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=kc>solid</span> <span class=kc>black</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>#</span><span class=nn>one</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>grid-area</span><span class=p>:</span> <span class=mi>2</span><span class=o>/</span><span class=mi>1</span><span class=o>/</span><span class=mi>3</span><span class=o>/</span><span class=mi>2</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>  <span class=k>height</span><span class=p>:</span> <span class=mi>50</span><span class=kt>px</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>  <span class=k>background-color</span><span class=p>:</span> <span class=kc>red</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>#</span><span class=nn>two</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>grid-area</span><span class=p>:</span> <span class=mi>2</span><span class=o>/</span><span class=mi>2</span><span class=o>/</span><span class=mi>3</span><span class=o>/</span><span class=mi>3</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>  <span class=k>height</span><span class=p>:</span> <span class=mi>200</span><span class=kt>px</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>  <span class=k>background-color</span><span class=p>:</span> <span class=kc>blue</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>#</span><span class=nn>three</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>grid-area</span><span class=p>:</span> <span class=mi>2</span><span class=o>/</span><span class=mi>3</span><span class=o>/</span><span class=mi>3</span><span class=o>/</span><span class=mi>4</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>  <span class=k>height</span><span class=p>:</span> <span class=mi>300</span><span class=kt>px</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>  <span class=k>background-color</span><span class=p>:</span> <span class=kc>green</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nt>footer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>grid-area</span><span class=p>:</span> <span class=mi>3</span><span class=o>/</span><span class=mi>1</span><span class=o>/</span><span class=mi>4</span><span class=o>/</span><span class=mi>4</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>  <span class=k>border</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=kc>solid</span> <span class=kc>black</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div id=page style="display:grid;grid-template-columns:[col-one] 1fr [col-two] 1fr [col-three] 1fr;grid-template-rows:[header-row] 150px [content-row] auto [footer-row] 100px"><header style="grid-area:1/1/2/4;border:1px solid #000">Header</header><div id=one style=grid-area:2/1/3/2;height:50px;background-color:red>One</div><div id=two style=grid-area:2/2/3/3;height:200px;background-color:blue>Two</div><div id=three style=grid-area:2/3/3/4;height:300px;background-color:green>Three</div><footer style="grid-area:3/1/4/4;border:1px solid #000">Footer</footer></div><p>We&rsquo;ve really only scratch the surface of what is possible with the grid. Items can be aligned and justified, and tweaked in other ways, just as with flexbox. Names can be assigned to grid rows, grid columns, and grid areas, and used to make the resulting CSS more approachable and understandable.</p><p>A great resource for deeper exploration is CSS Trick&rsquo;s <a href=https://css-tricks.com/snippets/css/complete-guide-grid/ rel=external target=_blank>Complete Guide to Grid</a>.</p><h2 id=table-layouts>Table Layouts</h2><p>At one point in the 1990&rsquo;s, it was common practice for graphic designers to create a web page using graphic design software, export it as an image, and then slice up the image. These pieces were then used as the <code>background-image</code> property of a table cell, and text was overlaid on this graphics as the contents of the cell.</p><p>Thankfully, this practice has largely been abandoned, but you may still encounter it from time to time. There are some very real problems with the approach: if you increase the text size on the page, the cells may expand beyond the size of their background image, and the seams between the images will open up. Also, if a screen reader is used, it will often read content out-of-order and will describe the portions in terms of table rows and columns.</p><p>In web design best practices, tables should only be used for tabular data. If you desire to use this kind of slice-and-dice approach, use the Grid instead. It provides the same control over the placement of text, and can use a single <code>background-image</code> on the container element or multiple background images for the items.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=responsive-web-design>Responsive Web Design</h1><p>Modern websites are displayed on a wide variety of devices, with screen sizes from 640x480 pixels (VGA resolution) to 3840x2160 pixels (4K resolution). It should be obvious therefore that one-size-fits-all approach to laying out web applications does not work well. Instead, the current best practice is a technique known as <a href=https://en.wikipedia.org/wiki/Responsive_web_design rel=external target=_blank>Responsive Web Design</a>. When using this strategy your web app should automatically adjust the layout of the page based on how large the device screen it is rendered on.</p><h2 id=media-queries>Media Queries</h2><p>At the heart of the responsive CSS approach is a CSS technique called <em>media queries</em>. These are implemented with a CSS media at-rule (at-rules modify the behavior of CSS, and are preceded by an <em>at symbol</em> (<code>@</code>), hence the name). The original purpose of the media rule was to define different media types - i.e. <code>screen</code> and <code>print</code>, which would be selectively applied based on the media in play. For example, the rule:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>@</span><span class=k>media</span> <span class=nt>print</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>img</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>display</span><span class=p>:</span> <span class=kc>none</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nc>advertisement</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>display</span><span class=p>:</span> <span class=kc>none</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>would hide all images and elements with the <code>advertisement</code> class when printing a web page. You can also specify the media type with the <code>media</code> attribute in a <code>&lt;link></code> element, i.e. <code>&lt;link href="print.css" rel="stylesheet" media="print"></code> would apply the rules from <code>print.css</code> only when printing the website.</p><p>However, the real usefulness of the <code>@media</code> rule is when it is combined with a <em>media query</em>, which determines if its nested rules should be applied based on some aspect of the display.</p><p>The media query consists of:</p><ol><li>The <code>@media</code> keyword</li><li>An optional media type (typically <code>screen</code>, but could also be <code>all</code>, <code>print</code>, and <code>speech</code>)</li><li>The desired media features surrounded by parentheses. Multiple features can be joined by logical operators <code>and</code>, or logically or-ed using a <code>,</code>. More advanced queries can use <code>not</code> to invert an expression (if using <code>not</code> you <em>must</em> specify the media type).</li><li>A block of CSS surrounded by <code>{}</code></li></ol><p>An example media query that applies only when the screen is in portrait orientation (taller than it is wide) is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>@</span><span class=k>media</span> <span class=o>(</span><span class=nt>orientation</span><span class=o>:</span> <span class=nt>portrait</span><span class=o>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c>/* rules for a portrait orientation go here... */</span> 
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>The most commonly used media features are <code>max-width</code>, <code>min-width</code>, <code>max-height</code>, <code>min-height</code>, and <code>orientation</code>. The sizes can be specified in any CSS unit of measurement, but typically <code>px</code> is used. The <code>orientation</code> can either be <code>portrait</code> or <code>landscape</code>.</p><p>We can also combine multiple queries into a single <code>@media</code> rule:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>@</span><span class=k>media</span> <span class=o>(</span><span class=nt>orientation</span><span class=o>:</span> <span class=nt>landscape</span><span class=o>)</span> <span class=nt>and</span> <span class=o>(</span><span class=nt>max-width</span><span class=o>:</span> <span class=nt>700px</span><span class=o>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c>/* rules for a landscape-oriented screen 700 pixels or less wide */</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>The <code>and</code> in this case works like a logical <code>and</code>. You can also use the <code>not</code> keyword, which inverts the meaning of the query, or commas <code>,</code>, which operate like a logical <code>or</code>.</p><p>More details on the use of media queries can be found in the <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/Media_Queries/Using_media_queries rel=external target=_blank>MDN Documentation</a> on the subject.</p><p>By combining the use of media queries, and CSS layout techniques, you can drastically alter the presentation of a web application for different devices. Most browser development tools will also let you preview the effect of these rules by selecting a specific device size and orientation. See the <a href=https://developers.google.com/web/tools/chrome-devtools/device-mode/ rel=external target=_blank>Chrome Device Mode</a> documentation, Safari <a href=https://developer.apple.com/safari/tools/ rel=external target=_blank>Developer Documentation</a>, and Firefox <a href=https://developer.mozilla.org/en-US/docs/Tools/Responsive_Design_Mode rel=external target=_blank>Responsive Design Mode Documentation</a> for details.</p><h2 id=the-viewport-meta-tag>The Viewport Meta Tag</h2><p>The media query size features relate to the <em>viewport</em>, a rectangle representing the browser&rsquo;s visible area. For a desktop browser, this is usually equivalent to the <em>client area</em> of the browser window (the area of the window excluding the borders and menu bar). For mobile devices, however, the viewport is often much bigger than the actual screen size, and then scaled to fit on the screen:</p><p><a href=#R-image-79c18b5f8f8a608a52a02a216a2c9a4d class=lightbox-link><img alt="The mobile viewport scaling strategy" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/1.5.1.jpg style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-79c18b5f8f8a608a52a02a216a2c9a4d><img alt="The mobile viewport scaling strategy" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/1.5.1.jpg></a></p><p>This strategy helps legacy websites reasonably appear on mobile devices. However, with responsive designs, we want the viewport and the device size to match exactly. We can clue mobile browsers into this desire by adding a specific meta tag to the <code>&lt;head></code> of the HTML:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span></span></span></code></pre></div><p>For a responsive design to work, it is critical that this <code>&lt;meta></code> element be included, and use the exact syntax specified.</p><h2 id=advanced-css-layouts>Advanced CSS Layouts</h2><p>Finally, responsive designs tend to make heavy use of two new CSS layout strategies - <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Flexible_Box_Layout/Basic_Concepts_of_Flexbox rel=external target=_blank>The Flexible Box Module (flex)</a> and the <a href=https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Grid_Layout rel=external target=_blank>CSS Grid Layout</a>. These two layout tools allow for easily changing layouts within media queries - even allowing for the rearranging of elements!</p><p>Two great visual resources for learning the ins and outs of these layouts are CSS Trick&rsquo;s <a href=https://css-tricks.com/snippets/css/a-guide-to-flexbox/ rel=external target=_blank>A Complete Guide to Flexbox</a> and <a href=https://css-tricks.com/snippets/css/complete-guide-grid/ rel=external target=_blank>A Complete Guide to Grid</a>. In fact, you may want to bookmark these now.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter C</div><h1 id=javascript>JavaScript</h1><p>Bringing interaction to web pages since 1995.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of JavaScript</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>As the World Wide Web was gaining popularity in the mid-nineties, browser manufacturers started experimenting with interpreting program scripts embedded within webpages. By far the most successful of these was JavaScript, initally developed by Brandon Eich for Netscape.</p><p><a href=#R-image-1fce7ada63473377815d24b5f5a0709a class=lightbox-link><img alt="Brandon Eich" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/Brendan_Eich.jpg style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1fce7ada63473377815d24b5f5a0709a><img alt="Brandon Eich" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/Brendan_Eich.jpg></a></p><p>Brandon Eich was hired to integrate the <a href=https://en.wikipedia.org/wiki/Scheme_(programming_language) rel=external target=_blank>Scheme programming langauge</a> into the Netscape browser. But when Netscape cut a deal with Sun Microsystems to bring Java Applets to their browser, his mission was altered to create a more Java-like langauge. He developed a prototype in only ten days, that blended <a href=https://en.wikipedia.org/wiki/Java_(programming_language) rel=external target=_blank>Java</a> syntax, the <a href=https://en.wikipedia.org/wiki/Self_(programming_language) rel=external target=_blank>Self</a> object-orientation approach, and <a href=https://en.wikipedia.org/wiki/Scheme_(programming_language) rel=external target=_blank>Scheme</a> functionality.</p><p>Netscape eventually submitted JavaScript to <a href=https://en.wikipedia.org/wiki/Ecma_International rel=external target=_blank>ECMA International</a>, resulting in the ECMAScript standard, and opening the door for other browsers to adopt JavaScript. Currently all major browsers support the full ECMAScript 5 standard, and large chunks of ECMAScript 6 and some parts of later versions as well. Moreover, <em>transpilation</em> can be utilized to make newer ECMAScript-compliant code run on older browser versions.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>The ECMA standard is maintained by <a href=https://www.ecma-international.org/ rel=external target=_blank>ECMA International</a>, not the W3C. However, its development process is very similar, involving stakeholders developing proposals for new and improved features.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=basic-syntax>Basic Syntax</h1><style>.console{position:fixed;bottom:0;left:300px;box-sizing:border-box;z-index:1000;width:calc(100% - 300px);height:30vh;background-color:#8451a1;padding:1rem;transform:translateY(calc(30vh - 5px));transition:transform 1s}.console iframe{width:100%;height:100%;background-color:#fff}.console>.console-tab{position:absolute;top:-1.2rem;right:0;color:#fff;background-color:#8451a1;padding:0 2rem;border-radius:5px;cursor:pointer}.console.active{transform:none}</style><div class=console><div class=console-tab>CONSOLE</div><iframe src=https://jsconsole.com/></iframe></div><script>document.querySelector(".console-tab").addEventListener("click",e=>{console.log(e),e.target.parentElement.classList.toggle("active")})</script><p>Because Netscape was adopting Java at the same time they were developing what would become JavaScript, there was a push to make the syntax stay somewhat consistent between the two languages. As a result, JavaScript has much of the look and feel of an imperative language like C, C#, or Java.</p><p>However, this similarity can be deceptive, because how JavaScript operates can be quite different than those languages. This can lead to frustration for imperative programmers learning JavaScript. As we go over the basics of the language, I will strive to call out these tricky differences.</p><p>To assist you in learning JavaScript syntax, we&rsquo;ve added an interactive console to this textbook where you can type in arbitrary JavaScript code and see the result of its execution, much like the console that Developer Tools provide. You can click the word &ldquo;Console&rdquo; on the purple tab below to expand it, and click it again to minimize it.</p><h2 id=interpreted-language>Interpreted Language</h2><p>JavaScript is an interpreted language, which means instead of being compiled into machine code, it is interpreted by a special program - an interpreter. Each browser has its own interpreter implementation.</p><p>Let&rsquo;s start with a traditional example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;hello world&#34;</span><span class=p>);</span></span></span></code></pre></div><p>Copy/paste or type this code into the console provided at the bottom of the page. What is the output?</p><p>As you might expect, this prints the string &ldquo;hello world&rdquo; to standard output. Notice we didn&rsquo;t need to put this code into a <code>main</code> function - JavaScript code is executed as it is encountered by the interpreter.</p><h2 id=terminating-lines-of-code>Terminating Lines of Code</h2><p>Also, the semicolon is an optional way to end an expression. A new line is other way to do so, so these two programs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span></span></span></code></pre></div><p>and</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Hello&#34;</span><span class=p>);</span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>);</span></span></span></code></pre></div><p>are equivalent. We can also use both a semicolon and a new line (as in the first example). A common technique for making JavaScript files smaller, known as <em>minifying</em> takes advantage of this fact to write an entire program in a single line! We&rsquo;ll discuss how and when to do so later.</p><h2 id=data-types>Data Types</h2><p>Like any programming language, JavaScript has a number of predefined data types. We can also query the data type of a value at runtime, using the <code>typeof</code> keyword. Try typing some of these lines into the console:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>typeof</span> <span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>typeof</span> <span class=mf>1.3</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>typeof</span> <span class=s2>&#34;Hello&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>typeof</span> <span class=kc>true</span><span class=p>;</span></span></span></code></pre></div><h3 id=numbers>Numbers</h3><p>Numbers include integers and floats, though JavaScript mostly uses the distinction for how a value is stored in memory and presents the programmer with the <code>number</code> type. This category also includes some special values, like <code>NaN</code> (not a number) and <code>Infinity</code>. We can perform all the standard arithmetic operations on any number (<code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>).<br>These operations are also &ldquo;safe&rdquo; in the sense that they will not throw an error. For example, try typing <code>4/0</code> in the terminal below. The value you see as a result is still a number!</p><p>The JavaScript interpreter will switch between an integer and float representation internally as it makes sense to. For example, type <code>4.0</code> and you&rsquo;ll see the console echoes <code>4</code> to you, showing it is storing the number as an integer. Try typing <code>4.1</code>, and you&rsquo;ll see it stores it as a float.</p><h3 id=strings>Strings</h3><p>The <code>string</code> type in JavaScript can be declared literally using single (<code>'</code>) or double (<code>"</code>) quotes, and as of ES6, tick marks (<code>`</code>).</p><p>Double and single-quoted strings work exactly the same. They must be on the same line, though you can add newline characters to both using <code>\n</code>. The backslash is used as an escape character, so to include it in a string you must use a double-backslash instead <code>\\</code>. Finally, in a single-quoted string you can escape a single quote, i.e. <code>'Bob\'s Diner'</code>, and similarly for double-quotes: <code>"\"That's funny,\" she said."</code> Judicious choices of single-or double-quoted strings can avoid much of this complication.</p><p>You can also directly reference unicode characters with <code>\u[ref number]</code>. Try typing the sequence <code>"\u1F63C"</code>.</p><p>Finally, strings enclosed with tick marks (<code>`</code>) are <em>template literals</em> that have a few special properties. First, they can span multiple lines, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=sb>`This is a 
</span></span></span><span class=line><span class=cl><span class=sb>multiline string
</span></span></span><span class=line><span class=cl><span class=sb>example`</span></span></span></code></pre></div><p>The line breaks will be interpreted as new line characters. Secondly, you can embed arbitrary JavaScript inside of them using <code>${}</code>. Give it a try:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=sb>`The sum of 2 and 3 is </span><span class=si>${</span><span class=mi>2</span> <span class=o>+</span> <span class=mi>3</span><span class=si>}</span><span class=sb>`</span></span></span></code></pre></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>In JavaScript there is no character type. In practice, the role characters normally play in programs is filled by strings of length one.</p></div></div><h3 id=booleans>Booleans</h3><p>JavaScript also has the boolean literals <code>true</code> and <code>false</code>. It also implements the boolean logical operators <code>&&</code> (logical and) <code>||</code> (logical or), and <code>!</code> (logical not).</p><h3 id=undefined>Undefined</h3><p>JavaScript has a special value <code>undefined</code> that means a value hasn&rsquo;t been set. You probably saw it when you entered the <code>console.log("Hello World")</code> example above, which spit out:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tex data-lang=tex><span class=line><span class=cl>&gt; Hello World!
</span></span><span class=line><span class=cl>&gt; undefined</span></span></code></pre></div><p>As the console echoes the value of the prior line, it was printing the return value of <code>console.log()</code>. Since <code>console.log()</code> doesn&rsquo;t return a value, this results in <code>undefined</code>.</p><h3 id=null>Null</h3><p>JavaScript also defines a <code>null</code> type, even though <code>undefined</code> fills many of the roles <code>null</code> fills in other languages. However, the programmer must explicitly supply a <code>null</code> value. So if a variable is <code>null</code>, you know it was done <em>intentionally</em>, if it is <code>undefined</code>, it may be that it was accidentally not initialized.</p><h3 id=objects>Objects</h3><p>The <code>object</code> type is used to store more than one value, and functions much like a dictionary in other languages. Objects can be declared literally with curly braces, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>first</span><span class=o>:</span> <span class=s2>&#34;Jim&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>last</span><span class=o>:</span> <span class=s2>&#34;Hawkins&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>age</span><span class=o>:</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>An object is essentially a collection of key/value pairs, known as <strong>properties</strong>. We&rsquo;ll discuss objects in more depth in the <a href=https://textbooks.cs.ksu.edu/cis526/c-js/05-objects-and-classes/ rel=external target=_blank>Objects and Classes</a> section.</p><h3 id=symbols>Symbols</h3><p>Finally, the <code>symbol</code> type is a kind of identifier. We&rsquo;ll discuss it more later.</p><h2 id=variables>Variables</h2><p>JavaScript uses <em>dynamic typing</em>. This means the type of a variable is not declared in source code, rather it is determined at runtime. Thus, all variables in JavaScript are declared with the <code>var</code> keyword, regardless of type:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=s2>&#34;A string&#34;</span><span class=p>;</span>  <span class=c1>// A string
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>b</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>           <span class=c1>// A number
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>c</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>        <span class=c1>// A boolean
</span></span></span></code></pre></div><p>In addition, the type of a variable can be changed at any point in the code, i.e. the statements:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=s2>&#34;A string&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>a</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span> 
</span></span></code></pre></div><p>is perfectly legal and workable. The type of <code>a</code>, changes from a string to a float when its value is changed.</p><p>In addition to the <code>var</code> keyword, constants are declared with <code>const</code>. Constants must have a value assigned with their declaration and cannot be changed.</p><p>Finally, ECMA6 introduced the <code>let</code> keyword, which operates similar to <code>var</code> but is locally scoped (see the discussion of functional scope for details).</p><h2 id=type-conversions>Type Conversions</h2><p>JavaScript does its best to use the specified variable, which may result in a type conversion. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=s2>&#34;foo&#34;</span> <span class=o>+</span> <span class=mi>3</span></span></span></code></pre></div><p>Will result in the string <code>'foo3'</code>, as the <code>+</code> operator means concatenation for strings. However, <code>/</code> has no override for strings, so</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=s2>&#34;foo&#34;</span> <span class=o>/</span> <span class=mi>3</span></span></span></code></pre></div><p>Will result in <code>NaN</code> (not a number).</p><p>Additionally, when you attempt to use a different data type as a boolean, JavaScript will interpret its &rsquo;truthiness&rsquo;. The values <code>null</code>, <code>undefined</code>, and <code>0</code> are considered <code>false</code>. All other values will be interpreted as <code>true</code>.</p><h2 id=control-structures>Control Structures</h2><p>JavaScript implements many of the familiar control structures of conditionals and loops.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>Be aware that variables declared within a block of code using <code>var</code> are subject to function scope, and exist outside of the conditional branch/loop body. This can lead to unexpected behavior.</p></div></div><h3 id=if-else-statements>If Else Statements</h3><p>The JavaScript <code>if</code> and <code>if else</code> statements look just like their Java counterparts:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=o>&lt;</span><span class=nx>logical</span> <span class=nx>test</span><span class=o>&gt;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=kc>true</span> <span class=nx>branch</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=o>&lt;</span><span class=nx>logical</span> <span class=nx>test</span><span class=o>&gt;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=kc>true</span> <span class=nx>branch</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=kc>false</span> <span class=nx>branch</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h3 id=loops>Loops</h3><p>As do <code>while</code> and <code>do while</code> loops:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>while</span><span class=p>(</span><span class=o>&lt;</span><span class=nx>logical</span> <span class=nx>test</span><span class=o>&gt;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=nx>loop</span> <span class=nx>body</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=nx>loop</span> <span class=nx>body</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>}(</span><span class=o>&lt;</span><span class=nx>logical</span> <span class=nx>test</span><span class=o>&gt;</span><span class=p>);</span></span></span></code></pre></div><p>And <code>for</code> loops:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=kd>var</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=nx>loop</span> <span class=nx>body</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>JavaScript also introduces a <code>for ... in</code> loop, which loops over properties within an object. I.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>jim</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>first</span><span class=o>:</span> <span class=s2>&#34;Jim&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>last</span><span class=o>:</span> <span class=s2>&#34;Hawkins&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>age</span><span class=o>:</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=nx>key</span> <span class=k>in</span> <span class=nx>jim</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`The property </span><span class=si>${</span><span class=nx>key</span><span class=si>}</span><span class=sb> has value </span><span class=si>${</span><span class=nx>jim</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>and the <code>for ... of</code> which does the same for arrays and other iterables:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>fruits</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;apple&#34;</span><span class=p>,</span> <span class=s2>&#34;orange&#34;</span><span class=p>,</span> <span class=s2>&#34;pear&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=nx>value</span> <span class=k>of</span> <span class=nx>fruits</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`The fruit is a </span><span class=si>${</span><span class=nx>value</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Try writing some control structures.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=javascript-functions>JavaScript Functions</h1><style>.console{position:fixed;bottom:0;left:300px;box-sizing:border-box;z-index:1000;width:calc(100% - 300px);height:30vh;background-color:#8451a1;padding:1rem;transform:translateY(calc(30vh - 5px));transition:transform 1s}.console iframe{width:100%;height:100%;background-color:#fff}.console>.console-tab{position:absolute;top:-1.2rem;right:0;color:#fff;background-color:#8451a1;padding:0 2rem;border-radius:5px;cursor:pointer}.console.active{transform:none}</style><div class=console><div class=console-tab>CONSOLE</div><iframe src=https://jsconsole.com/></iframe></div><script>document.querySelector(".console-tab").addEventListener("click",e=>{console.log(e),e.target.parentElement.classList.toggle("active")})</script><p>While JavaScript may look like an imperative language on the surface, much of how it behaves is based on <em>functional</em> languages like Scheme. This leads to some of the common sources of confusion for programmers new to the language. Let&rsquo;s explore just what its functional roots mean.</p><p>JavaScript implements <a href=https://en.wikipedia.org/wiki/First-class_function rel=external target=_blank>first-class functions</a>, which means they can be assigned to a variable, passed as function arguments, returned from other functions, and even nested inside other functions. Most of these uses are not possible in a traditional imperative language, though C# and Java have been adding more functional-type behavior.</p><h2 id=defining-functions>Defining Functions</h2><p>Functions in JavaScript are traditionally declared using the <code>function</code> keyword, followed by an identifier, followed by parenthesized arguments, and a body enclosed in curly braces, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>doSomething</span><span class=p>(</span><span class=nx>arg1</span><span class=p>,</span> <span class=nx>arg2</span><span class=p>,</span> <span class=nx>arg3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Do something here...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div><p>Alternatively, the name can be omitted, resulting in an <em>anonymous</em> function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=p>(</span><span class=nx>arg1</span><span class=p>,</span> <span class=nx>arg2</span><span class=p>,</span> <span class=nx>arg3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Do something here...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div><p>Finally ES6 introduced the arrow function syntax, a more compact way of writing anonymous functions, similar to the lambda syntax of C#:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=p>(</span><span class=nx>arg1</span><span class=p>,</span> <span class=nx>arg2</span><span class=p>,</span> <span class=nx>arg3</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Do something here...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div><p>However, arrow function syntax also has special implications for scope, which we will discuss shortly.</p><h2 id=invoking-functions>Invoking Functions</h2><p>Functions are invoked with a parenthetical set of arguments, i.e.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>sayHello</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Hello, </span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Go ahead and define this function by typing the definition into your console.</p><p>Once you&rsquo;ve done so, it can be invoked with <code>sayHello("Bob")</code>, and would print <code>Hello, Bob</code> to the console. Give it a try:</p><iframe src=https://jsconsole.com/ style=width:100%></iframe><p>Functions can also be invoked using two methods defined for all functions, <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/call rel=external target=_blank>call()</a> and <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/apply rel=external target=_blank>apply()</a>.</p><h2 id=function-arguments>Function Arguments</h2><p>One of the bigger differences between JavaScript and imperative languages is in how JavaScript handles arguments. Consider the <code>hello()</code> function we defined above. What happens if we invoke it with no arguments? Or if we invoke it with two arguments?</p><p>Give it a try:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>sayHello</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>sayHello</span><span class=p>(</span><span class=s2>&#34;Mary&#34;</span><span class=p>,</span> <span class=s2>&#34;Bob&#34;</span><span class=p>);</span></span></span></code></pre></div><p>What are we seeing here? In JavaScript, the number of arguments supplied to a function when it is invoked is <em>irrelevant</em>. The same function will be invoked regardless of the <em>arity</em> (number) or <em>type</em> of arguments. The supplied arguments will be assigned to the defined argument names within the function&rsquo;s scope, according to the order. If there are less supplied arguments than defined ones, the missing ones are assigned the value <code>undefined</code>. And if there are extra arguments supplied, they are not assigned to a value.</p><p>Can we access those extra arguments? Yes, because JavaScript places them in a variable <code>arguments</code> accessible within the function body. Let&rsquo;s modify our <code>sayHello()</code> method to take advantage of this knowledge, using the <code>for .. of</code> loop we saw in the last section:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>sayHello</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span><span class=p>(</span><span class=nx>name</span> <span class=k>of</span> <span class=nx>arguments</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Hello, </span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>And try invoking it with an arbtrary number of names:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>sayHello</span><span class=p>(</span><span class=s2>&#34;Mike&#34;</span><span class=p>,</span> <span class=s2>&#34;Mary&#34;</span><span class=p>,</span> <span class=s2>&#34;Bob&#34;</span><span class=p>,</span> <span class=s2>&#34;Sue&#34;</span><span class=p>);</span></span></span></code></pre></div><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>JavaScript does not have a mechanism for <a href=https://en.wikipedia.org/wiki/Function_overloading rel=external target=_blank>function overloading</a> like C# and Java do. In JavaScript, if you declare a second &ldquo;version&rdquo; of a function that has different named arguments, you are not creating an overloaded version - you&rsquo;re replacing the original function!</p></div></div><p>Thus, when we entered our second <code>sayHello()</code> definition in the console, we overwrote the original one. Each function name will <em>only</em> reference a single definition at a time within a single scope, and just like with variables, we can change its value at any point.</p><p>Finally, because JavaScript has first-order functions, we can pass a function as an argument. For example, we could create a new function, <code>greet()</code> that takes the greeter&rsquo;s name, a function to use to greet others, and uses the arguments to greet an arbitrary number of people:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>greet</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>greetingFn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span><span class=p>(</span><span class=kd>var</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>arguments</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>greetingFn</span><span class=p>(</span><span class=nx>arguments</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`It&#39;s good to meet you.  I&#39;m </span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>We can then use it by passing our <code>sayHello()</code> function as the second argument:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>greet</span><span class=p>(</span><span class=s2>&#34;Mark&#34;</span><span class=p>,</span> <span class=nx>sayHello</span><span class=p>,</span> <span class=s2>&#34;Joe&#34;</span><span class=p>,</span> <span class=s2>&#34;Jill&#34;</span><span class=p>,</span> <span class=s2>&#34;Jack&#34;</span><span class=p>,</span> <span class=s2>&#34;John&#34;</span><span class=p>,</span> <span class=s2>&#34;Jenny&#34;</span><span class=p>);</span></span></span></code></pre></div><p>Note that we don&rsquo;t follow the function name with the parenthesis (<code>()</code>) when we pass it. If we did, we&rsquo;d inovke the function <em>at that point</em> and what we&rsquo;d pass was the return value of the function, not the function itself.</p><h2 id=return-values>Return Values</h2><p>Just like the functions you&rsquo;re used to, JavaScript functions can return a value with the <code>return</code> statement, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>foo</span><span class=p>()</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>We can also return nothing, which is <code>undefined</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>bar</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>This is useful when we want to stop execution immediately, but don&rsquo;t have a real return value. Also, if we don&rsquo;t specify a return value, we <em>implicity</em> return <code>undefined</code>.</p><p>And, because JavaScript has first-order functions, we can return a function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>giveMeAFunction</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Here I am!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h2 id=function-variables>Function Variables</h2><p>Because JavaScript has first-order functions, we can also assign a function to a variable, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>myFn</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>)</span> <span class=p>{</span><span class=k>return</span> <span class=nx>a</span> <span class=o>+</span> <span class=nx>b</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>greetFn</span> <span class=o>=</span> <span class=nx>greet</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>otherFn</span> <span class=o>=</span> <span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span><span class=k>return</span> <span class=nx>a</span> <span class=o>-</span> <span class=nx>b</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>oneMoreFn</span> <span class=o>=</span> <span class=nx>giveMeAFunction</span><span class=p>();</span></span></span></code></pre></div><h2 id=functional-scope>Functional Scope</h2><p>We&rsquo;ve mentioned scope several times now. Remember, <a href=https://en.wikipedia.org/wiki/Scope_(computer_science) rel=external target=_blank>scope</a> simply refers to where a binding between a symbol and a value is valid (here the symbol could be a <code>var</code> or <code>function</code> name). JavaScript uses <em>functional scope</em>, which means a new scope is created within the body of every function. Moreover, the parent scope of that function remains accessible as well.</p><p>Consider the JavaScript code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=s2>&#34;foo&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>b</span> <span class=o>=</span> <span class=s2>&#34;bar&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;before coolStuff&#34;</span><span class=p>,</span> <span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>coolStuff</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>b</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;in coolStuff&#34;</span><span class=p>,</span> <span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>,</span> <span class=nx>c</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>coolStuff</span><span class=p>(</span><span class=nx>b</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;after coolStuff&#34;</span><span class=p>,</span> <span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>);</span></span></span></code></pre></div><p>What gets printed before, in, and after <code>coolStuff()</code>?</p><ol><li>Before we invoke <code>coolStuff()</code> the values of <code>a</code> and <code>b</code> are <code>"foo"</code> and <code>"bar"</code> respectively.</li><li>Inside the body of <code>coolStuff()</code>:</li></ol><ul><li>The named argument <code>c</code> is assigned the value passed when <code>coolStuff()</code> is invoked - in this case, the value of <code>b</code> at the time, <code>"bar"</code>.</li><li>A new variable <code>a</code> is declared, and set to a value of <code>1</code>. This <code>a</code> only exists within <code>coolStuff()</code>, the old <code>a</code> remains unchanged outside of the function body.</li><li>The value of <code>4</code> is assigned to the variable <code>b</code>. Note that we did not declare a new <code>var</code>, so this is the same <code>b</code> as outside the body of the function.</li></ul><ol start=3><li>After the function is invoked, we go back to our original <code>a</code> which kept the value <code>"foo"</code> but our <code>b</code> was changed to <code>4</code>.</li></ol><p>That may not seem to bad. But let&rsquo;s try another example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>one</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>two</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nx>three</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>var</span> <span class=nx>a</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>three</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Here we have nested functions, each with its own scope, and its own variable <code>a</code> that exists for that scope.</p><h2 id=block-scope>Block Scope</h2><p>Most imperative programming langauges use <em>block scope</em>, which creates a new scope within any block of code. This includes function bodies, but also loop bodies and conditional blocks. Consider this snippet:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=kd>var</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>j</span> <span class=o>=</span> <span class=nx>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>j</span><span class=p>);</span></span></span></code></pre></div><p>What will be printed for the value of <code>j</code> after the loop runs?</p><p>You might think it should have been <code>undefined</code>, and it certainly would have been a null exception in an imperative language like Java, as the variable <code>j</code> was defined within the block of the <code>for</code> loop. Because those languages have <em>block scope</em>, anything declared within that scope only exists there.</p><p>However, with JavaScript&rsquo;s <em>functional</em> scope, a new scope is only created within the body of a function - not loop and conditional blocks! So anything created within a conditional block actually exists <em>in the scope of the function it appears in</em>. This can cause some headaches.</p><p>Try running this (admittedly contrived) example in the console:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=kd>var</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>setTimeout</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>The <a href=https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout rel=external target=_blank>setTimeout()</a> will trigger the supplied function body 10 ms in the future.</p><p>Notice how all the values are 10? That&rsquo;s because we were accessing the same variable <code>i</code>, because it was in the same scope each time!</p><p>The keyword <code>let</code> was introduced in ES6 to bring block scope to JavaScript. If we use it instead, we see the behavior we&rsquo;re more used to:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>setTimeout</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=arrays---lists-by-another-name>Arrays - Lists by Another Name</h1><style>.console{position:fixed;bottom:0;left:300px;box-sizing:border-box;z-index:1000;width:calc(100% - 300px);height:30vh;background-color:#8451a1;padding:1rem;transform:translateY(calc(30vh - 5px));transition:transform 1s}.console iframe{width:100%;height:100%;background-color:#fff}.console>.console-tab{position:absolute;top:-1.2rem;right:0;color:#fff;background-color:#8451a1;padding:0 2rem;border-radius:5px;cursor:pointer}.console.active{transform:none}</style><div class=console><div class=console-tab>CONSOLE</div><iframe src=https://jsconsole.com/></iframe></div><script>document.querySelector(".console-tab").addEventListener("click",e=>{console.log(e),e.target.parentElement.classList.toggle("active")})</script><p>You might have noticed we used an array in discussing the <code>for .. in</code> loop, but didn&rsquo;t talk about it in our data type discussion. This is because in JavaScript, an <code>array</code> is not a primitive data type. Rather, it&rsquo;s a special kind of <code>object</code>.</p><p>This is one of those aspects of JavaScript that breaks strongly with imperative languages. Brandon Eich drew heavily from Scheme, which is a functional language that focuses heavily on list processing&mldr; and the JavaScript array actually has more to do with lists than it does arrays.</p><h2 id=declaring-arrays>Declaring Arrays</h2><p>JavaScript arrays can be declared using literal syntax:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>arr</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;foo&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=mf>3.2</span><span class=p>,</span> <span class=kc>null</span><span class=p>];</span></span></span></code></pre></div><p>Notice how we can put any kind of data type into our array? We can also put an array in an array:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>arr2</span> <span class=o>=</span> <span class=p>[</span><span class=nx>arr</span><span class=p>,</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>],</span> <span class=p>[</span><span class=s2>&#34;foo&#34;</span><span class=p>,</span><span class=s2>&#34;bar&#34;</span><span class=p>]];</span></span></span></code></pre></div><p>We can create the effect of an n-dimensional array, though in practice we&rsquo;re creating what we call <a href=https://en.wikipedia.org/wiki/Jagged_array rel=external target=_blank>jagged arrays</a> in computer science.</p><p>Clearly if we can do this, the JavaScript array is a very different beast than a Java or C# one.</p><h2 id=accessing-array-values>Accessing Array Values</h2><p>We can access an element in an array with bracket notation, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>arr</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;foo&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=mf>3.2</span><span class=p>,</span> <span class=kc>null</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>arr</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span></span></span></code></pre></div><p>will print <code>true</code>. We index arrays starting at 0, just as we are used to .<br>But what if we try accessing an index that is &ldquo;out of bounds&rdquo;? Try it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>arr</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>arr</span><span class=p>[</span><span class=mi>80</span><span class=p>]);</span></span></span></code></pre></div><p>We don&rsquo;t get an exception, just an <code>undefined</code>, because that value doesn&rsquo;t exist yet. Let&rsquo;s take the same array and give it a value there:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>arr</span><span class=p>[</span><span class=mi>80</span><span class=p>]</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>arr</span><span class=p>[</span><span class=mi>80</span><span class=p>]);</span></span></span></code></pre></div><p>Now we see our value. But what about the values between <code>arr[3]</code> and <code>arr[80]</code>? If we try printing them, we&rsquo;ll see a value of <code>undefined</code>. But remember how we said an array is a special kind of object? Let&rsquo;s iterate over its keys and values with a <code>for .. in</code> loop:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=nx>key</span> <span class=k>in</span> <span class=nx>arr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`The index </span><span class=si>${</span><span class=nx>key</span><span class=si>}</span><span class=sb> has value </span><span class=si>${</span><span class=nx>arr</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Notice how we only print values for indices 0,1,2,3, and 80? The array is really just a special case of the <code>object</code>, using indices as property keys to store values. Everything in the array is effectively stored by reference&mldr; which means all the rules we learned about optimizing array algorithms won&rsquo;t apply here.</p><h2 id=arrays-as-special-purpose-data-structures>Arrays as Special-Purpose Data Structures</h2><p>You&rsquo;ve also learned about a lot of specialty data structures in prior courses - stacks, queues, etc. Before you write one in JavaScript though, you may be interested to know that JavaScript arrays can emulate these with their built-in methods.</p><p><strong>Stacks</strong> We push new elements to the top of the stack, and pop them off. The array methods <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/push rel=external target=_blank>push()</a> and <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/pop rel=external target=_blank>pop()</a> duplicate this behavior by pushing and popping items from the end of the array.</p><p><strong>FIFO queues</strong> A first-in-first-out queue can be mimicked with the array methods <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/push rel=external target=_blank>push()</a> and <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/shift rel=external target=_blank>shift()</a> which push new items to the end of the array and remove the first item, respectively.</p><p>Another useful method is <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/unshift rel=external target=_blank>unshift()</a>, which adds a new element to the front of the array.</p><p>Most data types you&rsquo;ve learned about in prior courses can be emulated with some combination of JavaScript arrays and objects, including various flavors of trees, priority queues, and tries. Granted, these will not be as performant as their equivalents written in C, but they will serve for most web app needs.</p><h2 id=map-reduce>Map Reduce</h2><p>One of the most powerful patterns JavaScript adopted from list-processing languages is the map and reduce patterns. You may have heard of <a href=https://en.wikipedia.org/wiki/MapReduce rel=external target=_blank>MapReduce</a> in terms of Big Data - that is exactly these two patterns used in combination. Let&rsquo;s examine how they are used in JavaScript.</p><h3 id=map>Map</h3><p>The basic idea of mapping is to process a list one element at a time, returning a new list containing the processed elements. In JavaScript, we implement it with the <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map rel=external target=_blank>map()</a> method of the array. It takes a function as an argument, which is invoked on each item in the array, and returns the newly processed array (the old array stays the same).</p><p>The function supplied to <em>map()</em> is supplied with three arguments - the item currently iterated, the index of the item in the array, and a reference to the original array. Of course, you don&rsquo;t have to define your function with the second or third arguments.</p><p>Let&rsquo;s try a simple example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>squares</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>].</span><span class=nx>map</span><span class=p>((</span><span class=nx>item</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span><span class=k>return</span> <span class=nx>item</span> <span class=o>*</span> <span class=nx>item</span><span class=p>})</span></span></span></code></pre></div><p>This code squares each of the numbers in the array, and sets <code>squares</code> to have as a value the array of newly-created squares.</p><p>Notice too how by passing a function into the map function, we create a new scope for each iteration? This is how JavaScript has long dealt with the challenge of functional scope - by using functions!</p><h3 id=reduce>Reduce</h3><p>The reduce pattern also operates on a list, but it <em>reduces</em> the list to a single result. In JavaScript, it is implemented with the array&rsquo;s <a href=/cis526/c-js/04-arrays-and-lists/>reduce()</a> method. The method takes two arguments - a reducer function and an initial accumulator value. Each time the reduce function iterates, it performs an operation on the currently iterated item and the accumulator. The accumulator is then passed forward to the next iteration, until it is returned at the end.</p><p>The function supplied to <em>reduce</em> has four arguments - the current accumulator value, the current iterated item, the item&rsquo;s index, and the original array. As with <code>map()</code>, we can leave out the last two arguments if we don&rsquo;t need to use them.</p><p>A common example of <code>reduce()</code> in action is to sum an array:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>sum</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>].</span><span class=nx>reduce</span><span class=p>((</span><span class=nx>acc</span><span class=p>,</span> <span class=nx>item</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span><span class=k>return</span> <span class=nx>acc</span> <span class=o>+</span> <span class=nx>item</span><span class=p>},</span> <span class=mi>0</span><span class=p>);</span></span></span></code></pre></div><p>We supply the initial value of the accumulator as identity for addition, <code>0</code>, and each iteration the current item in the array is added to it. At the end, the final value is returned.</p><h3 id=mapreduce>MapReduce</h3><p>And as we said before, MapReduce is a combination of the two, i.e. we can calculate the sum of squares by combining our two examples:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>sumOfSquares</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=p>,</span><span class=mi>5</span><span class=p>].</span><span class=nx>map</span><span class=p>((</span><span class=nx>item</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>item</span> <span class=o>*</span> <span class=nx>item</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nx>reduce</span><span class=p>((</span><span class=nx>acc</span><span class=p>,</span> <span class=nx>item</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>acc</span> <span class=o>+</span> <span class=nx>item</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Notice how we invoked the <code>map()</code> function on the original array, and then invoked <code>reduce()</code> on the returned array? This is a syntax known as <a href=https://en.wikipedia.org/wiki/Method_chaining rel=external target=_blank>method chaining</a>, which can make for concise code. We could also have assigned each result to a variable, and then invoked the next method on that variable.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=objects-and-classes>Objects and Classes</h1><style>.console{position:fixed;bottom:0;left:300px;box-sizing:border-box;z-index:1000;width:calc(100% - 300px);height:30vh;background-color:#8451a1;padding:1rem;transform:translateY(calc(30vh - 5px));transition:transform 1s}.console iframe{width:100%;height:100%;background-color:#fff}.console>.console-tab{position:absolute;top:-1.2rem;right:0;color:#fff;background-color:#8451a1;padding:0 2rem;border-radius:5px;cursor:pointer}.console.active{transform:none}</style><div class=console><div class=console-tab>CONSOLE</div><iframe src=https://jsconsole.com/></iframe></div><script>document.querySelector(".console-tab").addEventListener("click",e=>{console.log(e),e.target.parentElement.classList.toggle("active")})</script><p>JavaScript is also an object-oriented language, but the way it implements objects is derived from the ideas of the Self programming language, rather than the C++ origins of Java and C#&rsquo;s object-oriented approaches.</p><h2 id=object-properties>Object Properties</h2><p>Let&rsquo;s start with what an object <em>is</em> in JavaScript. It&rsquo;s basically a collection of properties - key/value pairs, similar to the concept of a Dictionary in other languages. The properties play both the role of fields and methods of the object, as a property can be assigned a primitive value or a function.</p><p>We&rsquo;ve already seen how to create an object with literal syntax, but let&rsquo;s see another example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>bob</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Bob&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>age</span><span class=o>:</span> <span class=mi>29</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>mother</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Mary&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>age</span><span class=o>:</span> <span class=mi>53</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Look at the property <code>mother</code> - it is its own object, nested within <code>bob</code>. Objects can nest as deep as we need them to (or at least, until we run out of memory).</p><p>We can then access properties with either dot notation or bracket notation, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// dot notation
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>bob</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>bob</span><span class=p>.</span><span class=nx>mother</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>bob</span><span class=p>.</span><span class=nx>father</span> <span class=o>=</span> <span class=p>{</span><span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Mark&#34;</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// bracket notation
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>bob</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>bob</span><span class=p>[</span><span class=s2>&#34;mother&#34;</span><span class=p>][</span><span class=s2>&#34;name&#34;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=nx>bob</span><span class=p>[</span><span class=s2>&#34;father&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Mark&#34;</span><span class=p>}</span></span></span></code></pre></div><p>Property names should conform to JavaScript variable naming rules (start with a letter, <code>$</code>, or <code>_</code>, be composed of letters, numbers, <code>$</code>, and <code>_</code>, and contain no spaces) though we can use bracket notation to sidestep this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>bob</span><span class=p>[</span><span class=s2>&#34;favorite thing&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;macaroni&#34;</span><span class=p>;</span></span></span></code></pre></div><p>However, if a property set with bracket notation does not conform to the naming rules, it cannot be accessed with dot notation. Other than that, you&rsquo;re free to mix and match.</p><p>You can also use the value of a variable as a property name:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>field</span> <span class=o>=</span> <span class=s2>&#34;key&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>tricky</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=nx>field</span><span class=p>]</span><span class=o>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>lo</span><span class=p>(</span><span class=nx>tricky</span><span class=p>.</span><span class=nx>key</span><span class=p>);</span></span></span></code></pre></div><p>This is a handy trick when you need to set property names at runtime.</p><h2 id=constructors>Constructors</h2><p>A constructor in JavaScript is simply a function that is invoked with the keyword <code>new</code>. Inside the body of the function, we have access to a variable named <code>this</code>, which can have values assigned to it. Here is an example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>Bear</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>this</span><span class=p>.</span><span class=nx>name</span> <span class=o>=</span> <span class=nx>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>pooh</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Bear</span><span class=p>(</span><span class=s2>&#34;pooh&#34;</span><span class=p>);</span></span></span></code></pre></div><p>There is nothing that inherently distinguishes a constructor from any other function; we can use the <code>new</code> keyword with any function. However, it only makes sense to do so with functions intended to be used as constructors, and therefore JavaScript programmers have adopted the convention of starting function names intended to be used as constructors with a capital letter, and other functions with a lowercase one.</p><h2 id=object-methods>Object Methods</h2><p>Methods are simply functions attached to the object as a property, which have access to the <code>this</code> (which refers back to the object) i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>pooh</span><span class=p>.</span><span class=nx>greet</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`My name is </span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>We can also attach a method to all objects created with a constructor by attaching them to its prototype, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>Bear</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>growl</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Grrr.  My name is </span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb> and I&#39;ll eat you up!`</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Now we can invoke <code>pooh.growl()</code> and see the same message. If we create a few new Bear instances:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>smokey</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Bear</span><span class=p>(</span><span class=s2>&#34;Smokey&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>shardik</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Bear</span><span class=p>(</span><span class=s2>&#34;Shardik&#34;</span><span class=p>);</span></span></span></code></pre></div><p>They also has access to the <code>growl()</code> method, but not <code>greet()</code>, because that was declared on the <code>pooh</code> instance, <em>not</em> the prototype.</p><p>Of course, it doesn&rsquo;t seem appropriate for Smokey the Bear to threaten to eat you. Let&rsquo;s tweak his behavior:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>smokey</span><span class=p>.</span><span class=nx>growl</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Only you can prevent forest fires!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Now try invoking:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>smokey</span><span class=p>.</span><span class=nx>growl</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>shardik</span><span class=p>.</span><span class=nx>growl</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>pooh</span><span class=p>.</span><span class=nx>growl</span><span class=p>();</span></span></span></code></pre></div><p>Pooh and Shardick continue to growl menacingly, but Smokey warns us about the dangers of forest fires. This leads us to the topic of prototypes.</p><h2 id=object-prototypes>Object Prototypes</h2><p>JavaScript adopts an approach to inheritance known as <a href=https://en.wikipedia.org/wiki/Prototype-based_programming rel=external target=_blank>prototype-based programming</a>, which works a bit differently than you&rsquo;re used to.</p><p>In JavaScript, each object keeps a reference to its constructor (in fact, you can see this for our bears with <code>pooh.constructor</code>, <code>smokey.constructor</code>, etc.). Each constructor in turn has a <code>prototype</code> property, which is an <code>object</code> with methods and properties attached to it.</p><p>When we invoke <code>pooh.growl()</code>, JavaScript first checks to see if the <code>growl</code> property is defined on the Bear instance we know as <code>pooh</code>. If not, then it checks the constructor&rsquo;s prototype for the same property. If it exists, then it invokes it.</p><p>Inheritance in JavaScript takes the form of a prototype chain - as each prototype is an <code>object</code>, each prototype can have its own prototype in turn. Thus, when we invoke a method, the interpreter walks down this chain and invokes the first matching property found.</p><h2 id=ecma-script-2015-class-syntax>ECMA Script 2015 Class Syntax</h2><p>If you find this all confusing, don&rsquo;t worry, you&rsquo;re not alone. ECMAScript decided to introduce a new class syntax in the 2015 version (ES6). It will look a lot more familiar:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Bear</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>name</span> <span class=o>=</span> <span class=nx>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>growl</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>growl</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nx>growl</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Grrr! My name is </span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb> and I&#39;ll eat you!`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Here we&rsquo;ve recreated our Bear class using the new syntax. We can construct a bear the same way, and invoke its <code>growl()</code> method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>yogi</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Bear</span><span class=p>(</span><span class=s2>&#34;Yogi&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>yogi</span><span class=p>.</span><span class=nx>growl</span><span class=p>();</span></span></span></code></pre></div><h3 id=method-binding>Method Binding</h3><p>Under the hood we&rsquo;re still using the same prototypical inheritance, which throws a slight wrench in the works. Notice the line:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>this</span><span class=p>.</span><span class=nx>growl</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>growl</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=k>this</span><span class=p>);</span></span></span></code></pre></div><p>in the constructor? This uses the <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_objects/Function/bind rel=external target=_blank>function.prototype.bind</a> method to bind the scope of the growl function to the <code>this</code> object of our class (remember, functions start a new scope, and a new scope means a new <code>this</code> object).</p><p>So remember when using ES6 class syntax, you need to bind your methods, or declare them in the constructor itself as arrow functions, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Bear</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>name</span> <span class=o>=</span> <span class=nx>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>growl</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Grrr! My name is </span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb> and I&#39;ll eat you!`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>As the arrow function declaration does not open a new scope, the this object doesn&rsquo;t change, and refers to the bear instance.</p><h3 id=inheritance>Inheritance</h3><p>Specifying inheritance is also simplified. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Mammal</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>hasFur</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>givesMilk</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>heartChambers</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>Bear</span> <span class=kr>extends</span> <span class=nx>Mammal</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>super</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Remember to always invoke the parent constructor with <code>super()</code> as the first thing in your child class constructor.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=attaching-scripts>Attaching Scripts</h1><p>Much like there are multiple ways to apply CSS to a web app, there are multiple ways to bring JavaScript into one. We can use a <code>&lt;script></code> tag with a specified <code>src</code> attribute to load a separate document, put our code into the <code>&lt;script></code> tag directly, or even add code to attributes of an HTML element. Let&rsquo;s look at each option.</p><h2 id=script-tag-with-source>Script Tag with Source</h2><p>We can add a <code>&lt;script></code> tag with a <code>src</code> attribute that gives a url pointing to a JavaScript file. This is similar to how we used the <code>&lt;link></code> element for CSS:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>JS Example<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;example.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div><p>A couple of important differences though. First, the <code>&lt;script></code> element is not a void tag, so we a closing <code>&lt;/script></code>. Also, while traditionally we would also place <code>&lt;script></code> elements in the <code>&lt;head></code>, current best practice is to place them as the last children of the <code>&lt;body></code> element.</p><h2 id=script-tag-with-content>Script Tag with Content</h2><p>The reason the <code>&lt;script></code> element isn&rsquo;t a void element is that you can place JavaScript code directly into it - similar to how we used the <code>&lt;style></code> element for CSS. Typically we would also place this tag at the end of the body:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>JS Example<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=mi>1</span> <span class=o>+</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div><h2 id=why-at-the-end-of-the-body>Why at the End of the Body?</h2><p>The reason for placing <code>&lt;script></code> tags at the end of the body is twofold. First, JavaScript files have grown increasingly large as web applications have become more sophisticated. And as they are parsed, there is no visible sign of this in the browser - so it can make your website appear to load more slowly when they are encountered in the <code>&lt;head></code> section. Second, JavaScript is interpreted as it is loaded - so if your code modifies part of the web page, and tries to do so before the webpage is fully loaded, it may fail.</p><p>A good trick is to place any code that should not be run until all the web pages&rsquo; assets have been downloaded within the body of an event handler tied to the <code>'load'</code> event, i.e.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nb>window</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;load&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// Put any JavaScript that should not be
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// run until the page has finished loading 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// here..
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><h2 id=as-an-attribute>As an Attribute</h2><p>A third alternative is to define our JavaScript as an <a href=https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Event_handlers rel=external target=_blank>on-event handler</a> directly on an element. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>button</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;console.log(1+3)&#34;</span><span class=p>&gt;</span>click me<span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span></span></span></code></pre></div><p>This once-common strategy has fallen out of favor as it does not provide for good separation of concerns, and can be difficult to maintain in large HTML files. Also, only one event handler can be set using this approach; we&rsquo;ll see an alternative method, <a href=https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener rel=external target=_blank>Element.addEventListener()</a> in the next section that is more powerful.</p><p>However, component-based development approaches like React&rsquo;s JSX make this approach more sensible, so it has seen some resurgence in interest.</p><h2 id=mix-and-match>Mix-and-Match</h2><p>It is important to understand that all JavaScript on a page is interpreted within the same scope, regardless of what file it was loaded from. Thus, you can invoke a function in one file that was defined in a separate file - this is commonly done when incorporating JavaScript libraries like JQuery.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>There is one aspect you need to be aware of though. Before you reference code artifacts like functions and variables, they must have been loaded in the interpreter. If you are using external files, these have to be retrieved by the browser as a separate request, and even though they may be declared in order in your HTML, they may be received out of order, and they will be interpreted <em>in the order they are received</em></p><p>There are a couple of strategies that can help here. First, you can use the window&rsquo;s <code>load</code> event as we discussed above to avoid triggering any JavaScript execution until all the script files have been loaded. And second, we can combine all of our script files into one single file (a process known as <em>concatenation</em>). This is often done with a build tool that also <em>minifies</em> the resulting code. We&rsquo;ll explore this strategy later in the course.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=the-document-object-model>The Document Object Model</h1><p>Now that we&rsquo;ve reviewed the basic syntax and structure of the JavaScript language, and how to load it into a page, we can turn our attention to what it was created for - to interact with web pages in the browser. This leads us to the <em>Document Object Model (DOM)</em>.</p><p>The DOM is a tree-like structure that is created by the browser when it parses the HTML page. Then, as CSS rules are interpreted and applied, they are attached to the individual nodes of the tree. Finally, as the page&rsquo;s JavaScript executes, it may modify the tree structure and node properties. The browser uses this structure and properties as part of its rendering process.</p><h2 id=the-document-instance>The Document Instance</h2><p>The DOM is exposed to JavaScript through an instance of the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Document rel=external target=_blank>Document</a> class, which is attached to the <code>document</code> property of the window (in the browser, the window is the top-level, a.k.a global scope. Its properties can be accessed with our without referencing the <code>window</code> object, i.e. <code>window.document</code> and <code>document</code> refer to the same object).</p><p>This document instance serves as the entry point for working with the DOM.</p><h2 id=the-dom-tree>The Dom Tree</h2><p>The DOM tree nodes are instances of the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Element rel=external target=_blank>Element</a> class, which extends from the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Node rel=external target=_blank>Node</a> class, which in turn extends the <a href=https://developer.mozilla.org/en-US/docs/Web/API/EventTarget rel=external target=_blank>EventTarget</a> class. This inheritance chain reflects the <a href=https://en.wikipedia.org/wiki/Separation_of_concerns rel=external target=_blank>Separation of Concerns</a> design principle: the EventTarget class provides the functionality for responding to events, the Node class provides for managing and traversing the tree structure, and the Element class maintains the element&rsquo;s appearance and properties.</p><div id=interfaceDiagram style=display:inline-block;position:relative;width:100%;padding-bottom:11.666666666666666%;vertical-align:middle;overflow:hidden><svg style="display:inline-block;position:absolute;top:0;left:0" viewBox="-50 0 600 70" preserveAspectRatio="xMinYMin meet"><a xlink:href="https://developer.mozilla.org/en-US/docs/Web/API/EventTarget" target="_top"><rect x="1" y="1" width="110" height="50" fill="#fff" stroke="#d4dde4" stroke-width="2"/><text x="56" y="30" font-size="12" font-family="Consolas,Monaco,Andale Mono,monospace" fill="#4d4e53" text-anchor="middle" alignment-baseline="middle">EventTarget</text></a><polyline points="111,25 121,20 121,30 111,25" stroke="#d4dde4" fill="none"/><line x1="121" y1="25" x2="151" y2="25" stroke="#d4dde4"/><a xlink:href="https://developer.mozilla.org/en-US/docs/Web/API/Node" target="_top"><rect x="151" y="1" width="75" height="50" fill="#fff" stroke="#d4dde4" stroke-width="2"/><text x="188.5" y="30" font-size="12" font-family="Consolas,Monaco,Andale Mono,monospace" fill="#4d4e53" text-anchor="middle" alignment-baseline="middle">Node</text></a><polyline points="226,25 236,20 236,30 226,25" stroke="#d4dde4" fill="none"/><line x1="236" y1="25" x2="266" y2="25" stroke="#d4dde4"/><a xlink:href="https://developer.mozilla.org/en-US/docs/Web/API/Element" target="_top"><rect x="266" y="1" width="75" height="50" fill="#f4f7f8" stroke="#d4dde4" stroke-width="2"/><text x="303.5" y="30" font-size="12" font-family="Consolas,Monaco,Andale Mono,monospace" fill="#4d4e53" text-anchor="middle" alignment-baseline="middle">Element</text></a></svg></div><h3 id=the-dom-playground>The DOM Playground</h3><p>The panels opposite show a simple web app where we can experiment with the DOM. Specifically, we&rsquo;re going to use JavaScript code we write in <em>playground.js</em> to interact with the page <em>index.html</em>. The page already has a couple of elements defined in it - a button with <code>id="some-button"</code>, and a text input with <code>id="some-input"</code>.</p><p>Additionally, the JavaScript code in <em>page-console.js</em> hijacks the <code>console.log()</code> method so that instead of printing to the regular console, it injects the output to a <code>div</code> element on the page. This will help make the console more accessible in Codio. Also, it demonstrates just how <em>dynamic</em> a language JavaScript is - we just altered the behavior of a core function!</p><h3 id=selecting-elements-on-the-page>Selecting Elements on the Page</h3><p>One of the most important skills in working with the DOM is understanding how to get a reference to an element on the page. There are many approaches, but some of the most common are:</p><h4 id=selecting-an-element-by-its-id>Selecting an Element by its ID</h4><p>If an element has an <code>id</code> attribute, we can select it with the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementById rel=external target=_blank>Document.getElementByID()</a> method. Let&rsquo;s select our button this way. Add this code to your <em>playground.js</em> file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>button</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;some-button&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>button</span><span class=p>);</span></span></span></code></pre></div><p>You should see the line <code>[object HTMLButtonElement]</code> - the actual instance of the DOM node representing our button (the class HTMLButtonElement is an extension of Element representing a button).</p><h4 id=selecting-a-single-element-by-css-selector>Selecting a Single Element by CSS Selector</h4><p>While there are additional selectors for selecting by tag name, class name(s), and other attributes, in practice these have largely been displaced by functions that select elements using a CSS selector.</p><p><a href=https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelector rel=external target=_blank>Document.querySelector()</a> will return the <em>first</em> element matching the CSS selector, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>button</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s1>&#39;#some-button&#39;</span><span class=p>);</span></span></span></code></pre></div><p>Works exactly like the <code>document.getElementById()</code> example. But we could also do:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>input</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s1>&#39;input[type=text]&#39;</span><span class=p>);</span></span></span></code></pre></div><p>Which would grab the first <code>&lt;input></code> with attribute <code>type=text</code>.</p><h4 id=selecting-multiple-elements-by-css-selector>Selecting Multiple Elements by CSS Selector</h4><p>But what if we wanted to select more than one element at a time? Enter <a href=https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelectorAll rel=external target=_blank>document.querySelectorAll()</a>. It returns a <a href=https://developer.mozilla.org/en-US/docs/Web/API/NodeList rel=external target=_blank>NodeList</a> containing all matching nodes. So the code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>paras</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>querySelectorAll</span><span class=p>(</span><span class=s1>&#39;p.highlight&#39;</span><span class=p>);</span></span></span></code></pre></div><p>Will populate the variable <code>paras</code> with a <code>NodeList</code> containing all <code>&lt;p></code> elements on the page with the highlight class.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>While a <code>NodeList</code> is an iterable object that behaves much like an array, it is not an array. Its items can also be directly accessed with bracket notation (<code>[]</code>) or <a href=https://developer.mozilla.org/en-US/docs/Web/API/NodeList/item rel=external target=_blank>NodeList.item()</a>. It can be iterated over with a <code>for .. of</code> loop, and in newer browsers, <a href=https://developer.mozilla.org/en-US/docs/Web/API/NodeList/forEach rel=external target=_blank>NodeList.forEach()</a>. Alternatively, it can be converted into an array with <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/from rel=external target=_blank>Array.from()</a>.</p></div></div><h4 id=elementqueryselector-and-elementqueryselectorall>Element.querySelector() and Element.querySelectorAll()</h4><p>The query selector methods are also implemented on the element class, with <a href=https://developer.mozilla.org/en-US/docs/Web/API/Element/querySelector rel=external target=_blank>Element.querySelector()</a> and <a href=https://developer.mozilla.org/en-US/docs/Web/API/Element/querySelectorAll rel=external target=_blank>Element.querySelectorAll()</a>. Instead of searching the entire document, these only search their descendants for matching elements.</p><h3 id=events>Events</h3><p>Once we have a reference to an element, we can add an event listener with <a href=https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener rel=external target=_blank>EventTarget.addEventListener()</a>. This takes as its first argument, the name of the event to listen for, and as the second, a method to invoke when the event occurs. There are additional optional arguments as well (such as limiting an event listener to firing only once), see the MDN documentation for more details.</p><p>For example, if we wanted to log when the user clicks our button, we could use the code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;some-button&#34;</span><span class=p>).</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;click&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>event</span><span class=p>.</span><span class=nx>preventDefault</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Button was clicked!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Notice we are once again using method chaining - we could also assign the element to a <code>var</code> and invoke <code>addEventListener()</code> on the variable. The event we want to listen for is identified by its name - the string <code>'click'</code>. Finally, our event handler function will be invoked with an event object as its first argument.</p><p>Also, note the use of <code>event.preventDefault()</code>. Invoking this method on the event tells it that we are taking care of its responsibilities, so no need to trigger the default action. If we don&rsquo;t do this, the event will continue to bubble up the DOM, triggering any additional event handlers. For example, if we added a <code>'click'</code> event to an <code>&lt;a></code> element and did not invoke <code>event.preventDefault()</code>, when we clicked the <code>&lt;a></code> tag we would run our custom event handler and then the browser would load the page that the <code>&lt;a></code> element&rsquo;s <code>href</code> attribute pointed to.</p><h4 id=common-event-names>Common Event Names</h4><p>The most common events you&rsquo;ll likely use are</p><ul><li><code>"click"</code> triggered when an item is clicked on</li><li><code>"input"</code> triggered when an input element receives input</li><li><code>"change"</code> triggered when an input&rsquo;s value changes</li><li><code>"load"</code> triggered when the source of a image or other media has finished loading</li><li><code>"mouseover"</code> and <code>"mouseout"</code> triggered when the mouse moves over an element or moves off an element</li><li><code>"mousedown"</code> and <code>"mouseup"</code> triggered when the mouse button is initially pressed and when it is released (primarily used for drawing and drag-and-drop)</li><li><code>"mousemove"</code> triggered when the mouse moves (used primarily for drawing and drag-and-drop)</li><li><code>"keydown"</code>, <code>"keyup"</code>, and <code>"keypressed"</code> triggered when a key is first pushed down, released, and held.</li></ul><p>Note that the mouse and key events are only passed to elements when they have <em>focus</em>. If you want to always catch these events, attach them to the <code>window</code> object.</p><p>There are many more events - refer to the MDN documentation of the specific element you are interested in to see the full list that applies to that element.</p><h4 id=event-objects>Event Objects</h4><p>The function used as the event handler is invoked with an object representing the event. In most cases, this is a descendant class of <a href=https://developer.mozilla.org/en-US/docs/Web/API/Event rel=external target=_blank>Event</a> that has additional properties specific to the event type. Let&rsquo;s explore this a bit with our text input. Add this code to your <em>playground.js</em>, reload the page, and type something into the text input:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;some-input&#34;</span><span class=p>).</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;input&#34;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Here we access the event&rsquo;s <code>target</code> property, which gives us the target element for the event, the original <code>&lt;input></code>. The input element has the <code>value</code> property, which corresponds to the <code>value</code> attribute of the HTML that was parsed to create it, and it changes as text is entered into the <code>&lt;input></code>.</p><h3 id=modifying-dom-element-properties>Modifying DOM Element Properties</h3><p>One of the primary uses of the DOM is to alter properties of <a href=https://developer.mozilla.org/en/docs/Web/API/Element rel=external target=_blank>element</a> objects in the page. Any changes to the DOM structure and properties are almost immediately applied to the appearance of the web page. Thus, we use this approach to alter the document in various ways.</p><h4 id=attributes>Attributes</h4><p>The attributes of an HTML element can be accessed and changed through the DOM, with the methods <a href=https://developer.mozilla.org/en/docs/Web/API/Element/getAttribute rel=external target=_blank>element.getAttribute()</a>, <a href=https://developer.mozilla.org/en-US/docs/Web/API/Element/hasAttribute rel=external target=_blank>element.hasAttribute()</a> and <a href=https://developer.mozilla.org/en/docs/Web/API/Element/setAttribute rel=external target=_blank>element.setAttribute()</a>.</p><p>Let&rsquo;s revisit the button in our playground, and add an event listener to change the input element&rsquo;s <code>value</code> attribute:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;some-button&#34;</span><span class=p>).</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;click&#34;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;some-input&#34;</span><span class=p>).</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>&#34;value&#34;</span><span class=p>,</span> <span class=s2>&#34;Hello World!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Notice too that <em>both</em> event handlers we have assigned to the button trigger when you click it. We can add as many event handlers as we like to a project.</p><h4 id=styles>Styles</h4><p>The <a href=https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/style rel=external target=_blank>style</a> property provides access to the element&rsquo;s inline styles. Thus, we can set style properties on the element:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;some-button&#34;</span><span class=p>).</span><span class=nx>style</span> <span class=o>=</span> <span class=s2>&#34;background-color: yellow&#34;</span><span class=p>;</span></span></span></code></pre></div><p>Remember from our discussion of the CSS cascade that inline styles have the highest priority.</p><h4 id=class-names>Class Names</h4><p>Alternatively, we can change the CSS classes applied to the element by changing its <a href=https://developer.mozilla.org/en-US/docs/Web/API/Element/classList rel=external target=_blank>element.classList</a> property, which is an instance of a DOMTokensList, which exposes the methods:</p><ul><li><code>add()</code> which takes one or more string arguments which are class names added to the class list</li><li><code>remove()</code> which takes one or more string arguments which are class names removed from the class list</li><li><code>toggle()</code> which takes one or more strings as arguments and toggles the class name in the list (i.e. if the class name is there, it is removed, and if not, it is added)</li></ul><p>By adding, removing, or toggling class names on an element, we can alter what CSS rules apply to it based on its CSS selector.</p><h3 id=altering-the-document-structure>Altering the Document Structure</h3><p>Another common use for the DOM is to add, remove, or relocate elements in the DOM tree. This in turn alters the page that is rendered. For example, let&rsquo;s add a paragraph element to the page just after the <code>&lt;h1></code> element:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>p</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>p</span><span class=p>.</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=s2>&#34;Now I see you&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>insertBefore</span><span class=p>(</span><span class=nx>p</span><span class=p>,</span> <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s1>&#39;h1&#39;</span><span class=p>).</span><span class=nx>nextSibling</span><span class=p>);</span></span></span></code></pre></div><p>Let&rsquo;s walk through this code line-by-line.</p><ol><li>Here we use <a href=https://developer.mozilla.org/en-US/docs/Web/API/Document/createElement rel=external target=_blank>Document.createElement()</a> to create a new element for the DOM. At this point, the element is <em>unattached</em> to the document, which means it will not be rendered.</li><li>Now we alter the new <code>&lt;p></code> tag, adding the words <code>"Now I see you"</code> with the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Element/innerHTML rel=external target=_blank>Element.innerHTML</a> property.</li><li>Then we attach the new <code>&lt;p></code> tag to the DOM tree, using <a href=https://developer.mozilla.org/en-US/docs/Web/API/Node/insertBefore rel=external target=_blank>Node.insertBefore()</a> method and <a href=https://developer.mozilla.org/en-US/docs/Web/API/Node/nextSibling rel=external target=_blank>Node.nextSibling</a> property.</li></ol><p>The <a href=https://developer.mozilla.org/en-US/docs/Web/API/Node rel=external target=_blank>Node</a> interface provides a host of properties and methods for traversing, adding to, and removing from, the DOM tree. Some of the most commonly used are:</p><ul><li><a href=https://developer.mozilla.org/en-US/docs/Web/API/Node/parentNode rel=external target=_blank>Node.parent</a> the parent of this Node</li><li><a href=https://developer.mozilla.org/en-US/docs/Web/API/Node/childNodes rel=external target=_blank>Node.childNodes</a> a <a href=https://developer.mozilla.org/en-US/docs/Web/API/NodeList rel=external target=_blank>NodeList</a> of this node&rsquo;s children</li><li><a href=https://developer.mozilla.org/en-US/docs/Web/API/Node/nextSibling rel=external target=_blank>Node.nextSibling</a> returns the node following this one at the same level in the DOM tree</li><li><a href=https://developer.mozilla.org/en-US/docs/Web/API/Node/previousSibling rel=external target=_blank>Node.previousSibling</a> returns the node proceeding this one in the DOM tree at the same level</li><li><a href=https://developer.mozilla.org/en-US/docs/Web/API/Node/appendChild rel=external target=_blank>Node.appendChild()</a> adds the an element as the last child of the node</li><li><a href=https://developer.mozilla.org/en-US/docs/Web/API/Node/removeChild rel=external target=_blank>Node.removeChild()</a> removes a child from the node and returns it (this means the element becomes <em>unattached</em>)</li><li><a href=https://developer.mozilla.org/en-US/docs/Web/API/Node/replaceChild rel=external target=_blank>Node.replaceChild()</a> replaces a child element with another</li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=strict-mode>Strict Mode</h1><p>JavaScript has been around a long time, and a lot of JavaScript code has been written by inexperienced programmers. Browser manufacturers compensated for this by allowing lenient interpretation of JavaScript programs, and by ignoring many errors as they occurred.</p><p>While this made poorly-written scripts run, arguably they didn&rsquo;t run well. In ECMA5, <em>strict mode</em> was introduced to solve the problems of lenient interpretation.</p><p>Strict mode <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode rel=external target=_blank>according to the Mozilla Developer Network</a>:</p><ol><li>Eliminates some JavaScript silent errors by changing them to throw errors.</li><li>Fixes mistakes that make it difficult for JavaScript engines to perform optimizations: strict mode code can sometimes be made to run faster than identical code that&rsquo;s not strict mode.</li><li>Prohibits some syntax likely to be defined in future versions of ECMAScript.</li></ol><p>You can place the interpreter in strict mode by including this line at the start of your JavaScript file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=s2>&#34;use strict&#34;</span><span class=p>;</span></span></span></code></pre></div><p>In interpreters that don&rsquo;t support strict mode, this expression will be interpreted as a string and do nothing.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=regular-expressions>Regular Expressions</h1><style>.console{position:fixed;bottom:0;left:300px;box-sizing:border-box;z-index:1000;width:calc(100% - 300px);height:30vh;background-color:#8451a1;padding:1rem;transform:translateY(calc(30vh - 5px));transition:transform 1s}.console iframe{width:100%;height:100%;background-color:#fff}.console>.console-tab{position:absolute;top:-1.2rem;right:0;color:#fff;background-color:#8451a1;padding:0 2rem;border-radius:5px;cursor:pointer}.console.active{transform:none}</style><div class=console><div class=console-tab>CONSOLE</div><iframe src=https://jsconsole.com/></iframe></div><script>document.querySelector(".console-tab").addEventListener("click",e=>{console.log(e),e.target.parentElement.classList.toggle("active")})</script><p>The JavaScript <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String rel=external target=_blank>String</a> prototype has some very powerful methods, such as <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/includes rel=external target=_blank>String.prototype.includes()</a> which recognizes when a string contains a substring - i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=s2>&#34;foobarwhen&#34;</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s2>&#34;bar&#34;</span><span class=p>)</span></span></span></code></pre></div><p>would evaluate to true. But what if you needed a more general solution? Say, to see if the text matched a phone number pattern like XXX-XXX-XXXX? That&rsquo;s where <a href=https://en.wikipedia.org/wiki/Regular_expression rel=external target=_blank>Regular Expressions</a> come in.</p><p>Regular Expressions are a sequence of characters that define a <em>pattern</em> that can be searched for within a string. Unlike substrings, these patterns can have a <em>lot</em> of flexibility. For example, the phone number pattern above can be expressed as a JavaScript <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp rel=external target=_blank>RegExp</a> like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=sr>/\d{3}-\d{3}-\d{4}/</span></span></span></code></pre></div><p>Let&rsquo;s break down what each part means. First, the enclosing forward slashes (<code>/</code>) indicate this is a RegExp literal, the same way single or double quotes indicate a string literal. The backslash d (<code>\d</code>) indicates a decimal character, and will match a 0,1,2,3,4,5,6,7,8, or 9. The three in brackets <code>{3}</code> is a quantifier, indicating there should be three of the proceeding character - so three decimal characters. And the dash (<code>-</code>) matches the actual dash character.</p><h2 id=writing-regular-expressions-and-scriptular>Writing Regular Expressions and Scriptular</h2><p>As you can see, regular expressions make use of a decent number of special characters, and can be tricky to write. One of the greatest tools in your arsenal when dealing with Regular Expressions are web apps such as <a href=https://scriptular.com/ target=_blank>Scriptular.com</a> or <a href=https://regex101.com/ target=_blank>Regex101</a>(click the link to open it in a new tab). It lists characters with special meanings for regular expressions on the right, and provides an interactive editor on the left, where you can try out regular expressions against target text.</p><p>You can, of course, do the same thing on the console, but I find that using Scriptular to prototype regular expressions is faster. You can also clone the <a href=https://github.com/jonmagic/scriptular rel=external target=_blank>Scriptular Github repo</a> and use it locally rather than on the internet. A word of warning, however, always test your regular expressions in the context you are going to use them - sometimes something that works in Scriptular doesn&rsquo;t quite in the field (especially with older browsers and Node versions).</p><h2 id=regular-expressions-and-input-validation>Regular Expressions and Input Validation</h2><p>So how are regular expressions used in Web Development? One common use is to <em>validate</em> user input - to make sure the user has entered values in the format we want. To see if a user entered string matches the phone format we declared above, for example, we can use the <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/test rel=external target=_blank>RegExp.prototype.test()</a> method. It returns the boolean <code>true</code> if a match is found, <code>false</code> otherwise:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=sr>/\d{3}-\d{3}-\d{4}/</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>userEnteredString</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;String was valid&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;String was Invalid&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>But what if we wanted to allow phone numbers in more than one format? Say X-XXX-XXX-XXXX, (XXX)XXX-XXXX, and X(XXX)XXX-XXXX)?</p><p>We can do this as well:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=sr>/\d?-?\d{3}-\d{3}-\d{4}|\d?\s?\(\d{3}\)\s?\d{3}-\d{4}/</span></span></span></code></pre></div><p>The pipe (<code>|</code>) in the middle of the RexExp acts like an OR; we can match against the pattern before OR the pattern after. The first pattern is almost the same as the one we started with, but with a new leading <code>\d</code> and <code>-</code>. These use the quantifier <code>?</code>, which indicates 0 or 1 instances of the character.</p><p>The second pattern is similar, except we use a backslash s (<code>/s</code>) to match whitespace characters (we could also use the literal space <code></code>, <code>\s</code> also matches tabs and newlines). And we look for parenthesis, but as parenthesis have special meaning for RegExp syntax, we must escape them with a backslash: (<code>\(</code> and <code>\)</code>).</p><h2 id=regular-expressions-and-form-validation>Regular Expressions and Form Validation</h2><p>In fact, the use of Regular Expressions to validate user input is such a common use-case that when HTML5 introduced <a href=https://developer.mozilla.org/en-US/docs/Learn/HTML/Forms/Form_validation rel=external target=_blank>form data validation</a> it included the <code>pattern</code> attribute for HTML5 forms. It instructs the browser to mark a form field as invalid unless input matching the pattern is entered. Thus, the HTML:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>label</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;phone&#34;</span><span class=p>&gt;</span>Please enter a phone number
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>input</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;phone&#34;</span> <span class=na>pattern</span><span class=o>=</span><span class=s>&#34;\d{3}-\d{3}-\d{4}&#34;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;xxx-xxx-xxxx&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;</span></span></span></code></pre></div><p>Will ensure that only validly formatted phone numbers can be submitted. Also, note that we omitted the leading and trailing forward slashes (<code>/</code>) with the <code>pattern</code> attribute.</p><p>However, be aware that older browsers may not have support for <a href=https://developer.mozilla.org/en-US/docs/Learn/HTML/Forms/Form_validation rel=external target=_blank>HTML5 form data validation</a> (though all modern ones do), and that a savvy user can easily disable HTML5 form validation with the Developer Tools. Thus, you should aways validate on both the client-side (for good user experience) <em>and</em> the server-side (to ensure clean data). We&rsquo;ll discuss data validation more in our chapter on persisting data on the server.</p><h2 id=constructing-regexp>Constructing RegExp</h2><p>Besides using literal notation, We can also <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp rel=external target=_blank>construct regular expressions</a> from a string of characters:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>regexp</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=s2>&#34;\d{3}-\d{3}-\d{4}&#34;</span><span class=p>)</span></span></span></code></pre></div><p>This is especially useful if we won&rsquo;t know the pattern until runtime, as we can create our regular expression &ldquo;on the fly.&rdquo;</p><h2 id=regexp-flags>RegExp flags</h2><p>You can also specify one or more flags when defining a JavaScript Regular Expression, by listing the flag after the literal, i.e. in the RegExp:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=sr>/\d{3}-\d{3}-\d{4}/g</span> 
</span></span></code></pre></div><p>The flag <code>g</code> means <em>global</em>, and will find <em>all</em> matches, not just the first. So if we wanted to find all phone numbers in a body of text, we could do:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=sr>/\d{3}-\d{3}-\d{4}/g</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=nx>bodyOfText</span><span class=p>);</span></span></span></code></pre></div><p>Here the <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/match rel=external target=_blank>RegExp.prototype.match()</a> function returns an array of phone numbers that matched the pattern and were found in <code>bodyOfText</code>.</p><p>The flags defined for JavaScript regular expressions are:</p><ul><li><code>g</code> global match - normally RegExp execution stops after the first match.</li><li><code>i</code> ignore case - upper and lowercase versions of a letter are treated equivalently</li><li><code>m</code> multiline - makes the beginning end operators (<code>^</code> and <code>$</code>) operate on lines rather than the whole string.</li><li><code>s</code> dotAll - allows <code>.</code> to match newlines (normally <code>.</code> is a wildcard matching everything <em>but</em> newline characters)</li><li><code>u</code> unicode - treat pattern as a sequence of unicode code points</li><li><code>y</code>sticky - matches only from the <code>lastIndex</code> property of the Regular Expression</li></ul><h2 id=capture-groups>Capture Groups</h2><p>We saw above how we can retrieve the strings that matched our regular expression patterns
Matching patterns represents only <em>part</em> of the power of regular expressions. One of the most useful features is the ability to <em>capture</em> pieces of the pattern, and expose them to the programmer.</p><p>Consider, for example, the common case where we have a comma delimited value (CSV) file where we need to tweak some values. Say perhaps we have one like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>Name,weight,height
</span></span><span class=line><span class=cl>John Doe,150,6&#39;2&#34;
</span></span><span class=line><span class=cl>Sara Smith,102,5&#39;8&#34;
</span></span><span class=line><span class=cl>&#34;Mark Zed, the Third&#34;,250,5&#39;11&#34;
</span></span><span class=line><span class=cl>... 100&#39;s more values....</span></span></code></pre></div><p>which is part of a scientific study where they need the weight in Kg and the height in meters. We could make the changes by hand - but who wants to do that? We could also do the changes by opening the file in Excel, but that would also involve a lot of copy/paste and deletion, opening the door to human error. Or we can tweak the values with JavaScript.</p><p>Notice how the Mark Zed entry, because it has a comma in the name, is wrapped in double quotes, while the other names aren&rsquo;t? This would make using something like <a href=/cis526/c-js/09-regexp/>String.prototype.split()</a> impossible to use without a ton of additional logic, because it splits on the supplied delimiter (in this case, a comma), and would catch these additional commas. However, because a RegExp matches a <em>pattern</em>, we can account for this issue.</p><p>But we want to go one step farther, and <em>capture</em> the weight and height values. We can create a <em>capture group</em> by surrounding part of our pattern with parenthesis, i.e. the RegExp:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=sr>/^([\d\s\w]+|&#34;[\d\s\w,]+&#34;),(\d+),(\d+&#39;\d+)&#34;$/gm</span></span></span></code></pre></div><p>Will match each line in the file. Let&rsquo;s take a look at each part:</p><p><code>/^ ... $/mg</code> the <code>m</code> flag indicates that <code>^</code> and <code>$</code> should mark the start and end of each line. This makes sure we only capture values from the same line as par to a match, and the <code>g</code> flag means we want to find all matching lines in the file.</p><p><code>([\d\s\w]+|"[\d\s\w,]+")</code> is our first capture group, and we see it has two options (separated by <code>|</code>). The square brackets (<code>[]</code>) represent a set of characters, and we&rsquo;ll match any character(s) listed inside. So <code>[\d\s\w]</code> means any decimal (<code>\d</code>), whitespace (<code>\s</code>), or word (<code>\w</code>) character, and the <code>+</code> means one or more of these. The second option is <em>almost</em> the same as the first, but surrounded by double quotes (<code>"</code>) and includes commas (<code>,</code>) in the set of matching characters. This means the first group will always match our name field, even if it has commas.</p><p><code>,(\d+),</code> is pretty simple - we match the comma between name and weight columns, capture the weight value, and then the comma between weight and height.</p><p><code>(\d+'\d+)"</code> is a bit more interesting. We capture the feet value (<code>\d+</code>), the apostrophe (<code>'</code>) indicating the unit of feet, and the inches value (<code>\d+</code>). While we match the units for inches (<code>"</code>), it is not part of the capture group.</p><p>So our line-by-line captures would be:</p><pre>
Line 0: No match
Line 1: John Doe, 150, 6'2
Line 2: Sara Smith, 102, 5'8
Line 3: "Mark Zed, the Third", 250, 5'11
</pre><p>We can use this knowledge with <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replace rel=external target=_blank>String.prototype.replace()</a> to reformat the values in our file. The <code>replace()</code> can work as you are probably used to - taking two strings - one to search for and one to use as a replacement. But it can also take a RegExp as a <em>pattern</em> to search for and replace. And the replacement value can also be a <em>function</em>, which receives as its parameters 1) the full match to the pattern, and 2) the capture group values, as subsequent parameters.</p><p>Thus, for the Line 1 match, it would be invoked with parameters: <code>("John Doe,150,6'2\"", "John Doe", "150", "6'2\"")</code>. We can use this understanding to write our conversion function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>convertRow</span><span class=p>(</span><span class=nx>match</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>weight</span><span class=p>,</span> <span class=nx>height</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=c1>// Convert weight from lbs to Kgs 
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=kd>var</span> <span class=nx>lbs</span> <span class=o>=</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nx>weight</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=kd>var</span> <span class=nx>kgs</span> <span class=o>=</span> <span class=nx>lbs</span> <span class=o>/</span> <span class=mf>2.205</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=c1>// Convert height from feet and inches to meters 
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=kd>var</span> <span class=nx>parts</span> <span class=o>=</span> <span class=nx>height</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s2>&#34;&#39;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=kd>var</span> <span class=nx>feet</span> <span class=o>=</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nx>parts</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=kd>var</span> <span class=nx>inches</span> <span class=o>=</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nx>parts</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=kd>var</span> <span class=nx>totalInches</span> <span class=o>=</span> <span class=nx>inches</span> <span class=o>+</span> <span class=mi>12</span> <span class=o>*</span> <span class=nx>feet</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kd>var</span> <span class=nx>meters</span> <span class=o>=</span> <span class=nx>totalInches</span> <span class=o>*</span> <span class=mf>1.094</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>   <span class=c1>// Return the new line values:
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>return</span> <span class=sb>`</span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb>,</span><span class=si>${</span><span class=nx>kgs</span><span class=si>}</span><span class=sb>,</span><span class=si>${</span><span class=nx>meters</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>And now we can invoke that function as part of <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replace rel=external target=_blank>String.prototype.replace()</a> on the body of the file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>newBody</span> <span class=o>=</span> <span class=nx>oldBody</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/^([\d\s\w]+|&#34;[\d\s\w,]+&#34;),(\d+),(\d+&#39;\d+)&#34;$/gm</span><span class=p>,</span> <span class=nx>convertRow</span><span class=p>);</span></span></span></code></pre></div><p>And our <code>newBody</code> variable contains the revised file body (we&rsquo;ll talk about how to <em>get</em> the file body in the first place, either in the browser or with Node, later on).</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=json>JSON</h1><p>JSON is an acronym for <em>JavaScript Object Notation</em>, a serialization format that was developed in conjunction with ECMAScript 3. It is a standard format, as set by <a href=http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf rel=external target=_blank>ECMA-404</a>.</p><h2 id=json-format>JSON Format</h2><p>Essentially, it is a format for transmitting JavaScript objects. Consider the JavaScript object literal notation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>wilma</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Wilma Flintstone&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>relationship</span><span class=o>:</span> <span class=s2>&#34;wife&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>pebbles</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Pebbles Flintstone&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>age</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>relationship</span><span class=o>:</span> <span class=s2>&#34;daughter&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>fred</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Fred Flintstone&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>job</span><span class=o>:</span> <span class=s2>&#34;Quarry Worker&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>payRate</span><span class=o>:</span> <span class=mi>8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>dependents</span><span class=o>:</span> <span class=p>[</span><span class=nx>wilma</span><span class=p>,</span> <span class=nx>pebbles</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>If we were to express the same object in JSON:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Fred Flintstone&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;job&#34;</span><span class=p>:</span> <span class=s2>&#34;Quarry Worker&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;payRate&#34;</span><span class=p>:</span> <span class=mi>8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependents&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Wilma Flintstone&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;relationship&#34;</span><span class=p>:</span> <span class=s2>&#34;wife&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Pebbles Flintstone&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;age&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;relationship&#34;</span><span class=p>:</span> <span class=s2>&#34;daughter&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>As you probably notice, the two are very similar. Two differences probably stand out: First, references (like wilma and pebbles) are replaced with a JSON representation of their values. And second, all property names (the keys) are expressed as strings, not JavaScript symbols.</p><p>A discussion of the full syntax can be found in the <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON rel=external target=_blank>MDN Documentation</a> and also at <a href=https://json.org/ rel=external target=_blank>json.org</a>.</p><h2 id=the-json-object>The JSON Object</h2><p>The JavaScript language provides a JSON object with two very useful functions: <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify rel=external target=_blank>JSON.stringify()</a> and <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse rel=external target=_blank>JSON.parse()</a>. The first converts any JavaScript variable into a JSON string. Similarly, the second method parses a JSON string and returns what it represents.</p><p>The <code>JSON</code> object is available in browsers and in Node. Open the console and try converting objects and primitives to JSON strings with <code>JSON.stringify()</code> and back with <code>JSON.parse()</code>.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>While JSON was developed in conjunction with JavaScript, it has become a popular exchange format for other languages as well. There are parsing libraries for most major programming languages that can convert JSON strings into native objects:</p><ul><li><a href=https://www.oracle.com/technetwork/articles/java/json-1973242.html rel=external target=_blank>Java</a></li><li><a href=https://docs.microsoft.com/en-us/dotnet/framework/wcf/feature-details/how-to-serialize-and-deserialize-json-data rel=external target=_blank>C#</a></li><li><a href=https://docs.python.org/3/library/json.html rel=external target=_blank>Python</a></li><li><a href=https://github.com/json-c/json-c rel=external target=_blank>C</a></li><li><a href=https://github.com/nlohmann/json rel=external target=_blank>C++</a></li></ul><p>Some (like the Python one) are core language features. Others are open-source projects. There are many more available, just search the web!</p></div></div><h2 id=json-nesting-and-circular-references>JSON Nesting and Circular References</h2><p>While <code>JSON.parse()</code> will handle almost anything you throw at it. Consider this object:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>guy</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Guy&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>age</span><span class=o>:</span> <span class=mi>25</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>hobbies</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;Reading&#34;</span><span class=p>,</span> <span class=s2>&#34;Dancing&#34;</span><span class=p>,</span> <span class=s2>&#34;Fly fishing&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div><p>It converts just fine - you can see for yourself by pasting this code into the console. But what if we add reference to another object?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>guyMom</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Guy&#39;s Mom&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>age</span><span class=o>:</span> <span class=mi>52</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>hobbies</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;Knitting&#34;</span><span class=p>,</span> <span class=s2>&#34;Needlework&#34;</span><span class=p>,</span> <span class=s2>&#34;International Espionage&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=nx>guy</span><span class=p>.</span><span class=nx>mother</span> <span class=o>=</span> <span class=nx>guyMom</span><span class=p>;</span></span></span></code></pre></div><p>Try running <code>JSON.stringify()</code> on <code>guy</code> now:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>guy</span><span class=p>);</span></span></span></code></pre></div><p>Notice it works just fine, with Guy&rsquo;s mother now serialized as a part of the <code>guy</code> object. But what if we add a reference from <code>guyMother</code> back to her son?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>guyMom</span><span class=p>.</span><span class=nx>son</span> <span class=o>=</span> <span class=nx>guy</span><span class=p>;</span></span></span></code></pre></div><p>And try <code>JSON.stringify()</code> on <code>guy</code> now&mldr;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>guy</span><span class=p>);</span></span></span></code></pre></div><p>We get a <code>TypeError: Converting circular structure to JSON</code>. The <code>JSON.stringify</code> algorithm cannot handle this sort of circular reference - it wants to serialize <code>guy</code>, and thus needs to serialize <code>guyMom</code> to represent <code>guy.mother</code>, but in doing so it needs to serialize <code>guy</code> <em>again</em> as <code>guyMother.son</code> references it. This is a potentially infinitely recursive process&mldr; so the algorithm stops and throws an exception as soon as it detects the existence of a circular reference.</p><p>Is there a way around this in practice? Yes - substitute direct references for keys, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>people</span> <span class=o>=</span> <span class=p>{</span><span class=nx>guy</span><span class=o>:</span> <span class=nx>guy</span><span class=p>,</span> <span class=nx>guyMom</span><span class=o>:</span> <span class=nx>guyMom</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>guy</span><span class=p>.</span><span class=nx>mother</span> <span class=o>=</span> <span class=s2>&#34;guyMom&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>guyMom</span><span class=p>.</span><span class=nx>son</span> <span class=o>=</span> <span class=s2>&#34;guy&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>peopleJSON</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>people</span><span class=p>);</span></span></span></code></pre></div><p>Now when you deserialize <code>people</code>, you can rebuild the references:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>newPeople</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>peopleJSON</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>newPeople</span><span class=p>[</span><span class=s2>&#34;guy&#34;</span><span class=p>].</span><span class=nx>mother</span> <span class=o>=</span> <span class=nx>newPeople</span><span class=p>[</span><span class=nx>newPeople</span><span class=p>[</span><span class=s2>&#34;guy&#34;</span><span class=p>].</span><span class=nx>mother</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nx>newPeople</span><span class=p>[</span><span class=s2>&#34;guyMom&#34;</span><span class=p>].</span><span class=nx>son</span> <span class=o>=</span> <span class=nx>newPeople</span><span class=p>[</span><span class=nx>newPeople</span><span class=p>[</span><span class=s2>&#34;guyMother&#34;</span><span class=p>].</span><span class=nx>son</span><span class=p>];</span></span></span></code></pre></div><p>Given a standardized format, you can write a helper method to automate this kind of approach.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>The fact that JSON serializes references into objects makes it possible to create deep clones (copies of an object where the references are also clones) using JSON, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>deepClone</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>obj</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>If we were to use this method on <code>guy</code> from the above example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>guyClone</span> <span class=o>=</span> <span class=nx>deepClone</span><span class=p>(</span><span class=nx>guy</span><span class=p>);</span></span></span></code></pre></div><p>And then alter some aspect of his mother:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>guyClone</span><span class=p>.</span><span class=nx>mother</span><span class=p>.</span><span class=nx>hobbies</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=s2>&#34;Skydiving&#34;</span><span class=p>);</span></span></span></code></pre></div><p>The original <code>guy</code>&rsquo;s mother will be unchanged, i.e. it will <em>not</em> include Skydiving in her hobbies.</p></div></div><style>.console{position:fixed;bottom:0;left:300px;box-sizing:border-box;z-index:1000;width:calc(100% - 300px);height:30vh;background-color:#8451a1;padding:1rem;transform:translateY(calc(30vh - 5px));transition:transform 1s}.console iframe{width:100%;height:100%;background-color:#fff}.console>.console-tab{position:absolute;top:-1.2rem;right:0;color:#fff;background-color:#8451a1;padding:0 2rem;border-radius:5px;cursor:pointer}.console.active{transform:none}</style><div class=console><div class=console-tab>CONSOLE</div><iframe src=https://jsconsole.com/></iframe></div><script>document.querySelector(".console-tab").addEventListener("click",e=>{console.log(e),e.target.parentElement.classList.toggle("active")})</script><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=ajax>AJAX</h1><p>Asynchronous JavaScript and XML (AJAX) is a term coined by Jesse James Garrett to describe a technique of using the <a href=https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest rel=external target=_blank>XMLHttpRequest</a> object to request resources directly from JavaScript. As the name implies, this was originally used to request XML content, but the technique can be used with any kind of data.</p><h3 id=the-xmlhttprequest>The XMLHttpRequest</h3><p>The <code>XMLHttpRequest</code> object is modeled after how the <code>window</code> object makes web requests. You can think of it as a state machine that can be in one of several possible states, defined by both a constant and an unsigned short value:</p><ul><li><strong>UNSENT</strong> or <strong>0</strong> The client has been created, but no request has been made. Analogous to a just-opened browser before you type an address in the address bar.</li><li><strong>OPENED</strong> or <strong>1</strong> The request has been made, but the response has not been received. The browser analogue would be you have just pressed enter after typing the address.</li><li><strong>HEADERS_RECEIVED</strong> or <strong>2</strong> The first part of the response has been processed. We&rsquo;ll talk about headers in the next chapter.</li><li><strong>LOADING</strong> or <strong>3</strong> The content of the response is being downloaded. In the browser, this would be the stage where the HTML is being received and parsed into the DOM.</li><li><strong>DONE</strong> or <strong>4</strong> The resource is fully loaded. In the DOM, this would be equivalent to the <code>'load'</code> event.</li></ul><p><a href=#R-image-1e0043d6f807287ab6334eacee97fc88 class=lightbox-link><img alt="The XMLHttpRequest ready states" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/3.8.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1e0043d6f807287ab6334eacee97fc88><img alt="The XMLHttpRequest ready states" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/3.8.1.png></a></p><h4 id=xmlhttprequest-properties>XMLHttpRequest Properties</h4><p>The XMLHttpRequest object also has a number of properties that are helpful:</p><ul><li><code>readyState</code> - the current state of the property</li><li><code>response</code> - the body of the response, an <code>ArrayBuffer</code>, <code>Blob</code>, <code>Document</code>, or <code>DOMString</code> based on the value of the <code>responseType</code></li><li><code>responseType</code> - the mime type of response</li><li><code>status</code> - returns an unsigned short with the HTTP response status (or 0 if the response has not been received)</li><li><code>statusText</code> - returns a string containing the response string fro the server, i.e. <code>"200 OK"</code></li><li><code>timeout</code> - the number of milliseconds the request can take before being terminated</li></ul><h4 id=xmlhttprequest-events>XMLHttpRequest Events</h4><p>The XMLHttpRequest object implements the <code>EventTarget</code> interface, just like the <code>Element</code> and <code>Node</code> of the DOM, so we can attach event listeners with <code>addEventListener()</code>. The specific events we can listen for are:</p><ul><li><code>abort</code> - fired when the request has been aborted (you can abort a request with the <a href=https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/abort rel=external target=_blank>XMLHttpRequest.abort()</a> method)</li><li><code>error</code> - fired when the request encountered an error</li><li><code>load</code> - fired when the request completes successfully</li><li><code>loadend</code> - fired when the request has completed, either because of success or after an abort or error.</li><li><code>loadstart</code> - fired when the request has started to load data</li><li><code>progress</code> - fired periodically as the request receives data</li><li><code>timeout</code> - fired when the progress is expired due to taking too long</li></ul><p>Several of these events have properties you can assign a function to directly to capture the event:</p><ul><li><code>onerror</code> - corresponds to the <code>error</code> event</li><li><code>onload</code> - corresponds to the <code>load</code> event</li><li><code>onloadend</code> - corresponds to the <code>loadend</code> event</li><li><code>onloadstart</code> - corresponds to the <code>loadstart</code> event</li><li><code>onprogress</code> - corresponds to the <code>progress</code> event</li><li><code>ontimeout</code> - corresponds to the <code>timeout</code> event</li></ul><p>In addition, there is an <code>onreadystatechange</code> property which acts like one of these properties and is fired every time the state of the request changes. In older code, you may see it used instead of the <code>load</code> event, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>xhr</span><span class=p>.</span><span class=nx>onreadystatechange</span><span class=p>(</span><span class=kd>function</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>xhr</span><span class=p>.</span><span class=nx>readyState</span> <span class=o>===</span> <span class=mi>4</span> <span class=o>&amp;&amp;</span> <span class=nx>xhr</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>200</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Request has finished successfully, do logic
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><h3 id=using-ajax>Using AJAX</h3><p>Of course the point of learning about the XMLHttpRequest object is to perform AJAX requests. So let&rsquo;s turn our attention to that task.</p><h4 id=creating-the-xmlhttprequest>Creating the XMLHttpRequest</h4><p>The first step in using AJAX is creating the XMLHttpRequest object. To do so, we simply call its constructor, and assign it to a variable:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>xhr</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>XMLHttpRequest</span><span class=p>();</span></span></span></code></pre></div><p>We can create as many of these requests as we want, so if we have multiple requests to make, we&rsquo;ll usually create a new XMLHttpRequest object for each.</p><h4 id=attaching-the-event-listeners>Attaching the Event Listeners</h4><p>Usually, we&rsquo;ll want to attach our event listener(s) before doing anything else with the <code>XMLHttpRequest</code> object. The reason is simple - because the request happens asynchronously, it is entirely possible the request will be finished <em>before</em> we add the event listener to listen for the <code>load</code> event. In that case, our listener will <em>never</em> trigger.</p><p>At a minimum, you probably want to listen to <code>load</code> events, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>xhr</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;load&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// do something with xhr object
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span></span></span></code></pre></div><p>But it is also a good idea to listen for the <code>error</code> event as well:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>xhr</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// report the error
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span></span></span></code></pre></div><h4 id=opening-the-xmlhttprequest>Opening the XMLHttpRequest</h4><p>Much like when we manually made requests, we first need to open the connection to the server. We do this with the <a href=https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/open rel=external target=_blank>XMLHttpRequest.open()</a> method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>xhr</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;https://imgs.xkcd.com/comics/blogofractal.png&#39;</span><span class=p>);</span></span></span></code></pre></div><p>The first argument is the <a href=https://textbooks.cs.ksu.edu/cis526/02-http/04-request-methods/ rel=external target=_blank>HTTP request method</a> to use, and the second is the <a href=https://textbooks.cs.ksu.edu/cis526/02-http/05-uris-and-urls/ rel=external target=_blank>URL</a> to open.</p><p>There are also three optional parameters that can be used to follow - a boolean determining if the request should be made asynchronously (default <code>true</code>) and a user and password for HTTP authentication. Since AJAX requests are normally made asynchronously, and HTTP authentication has largely been displaced by more secure authentication approaches, these are rarely used.</p><h4 id=setting-headers>Setting Headers</h4><p>After the <code>XMLHttpRequest</code> has been opened, but before it is sent, you can use <a href=https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/setRequestHeader rel=external target=_blank>XMLHttpRequest.setRequestHeader()</a> to set any <a href=https://textbooks.cs.ksu.edu/cis526/02-http/06-request-headers/ rel=external target=_blank>request headers</a> you need. For example, we might set an <code>Accept</code> header to <code>image/png</code> to indicate we would like image data as our response:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>xhr</span><span class=p>.</span><span class=nx>setRequestHeader</span><span class=p>(</span><span class=s1>&#39;Accept&#39;</span><span class=p>,</span> <span class=s1>&#39;image/png&#39;</span><span class=p>);</span></span></span></code></pre></div><h4 id=sending-the-xmlhttprequest>Sending the XMLHttpRequest</h4><p>Finally, the <a href=https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/send rel=external target=_blank>XMLHttpRequest.send()</a> method will send the request asynchronously (unless the <code>async</code> parameter in <code>XMLHttpRequest.open()</code> was set to <code>false</code>). As the response is received (or fails) the appropriate event handlers will be triggered. To finish our example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>xhr</span><span class=p>.</span><span class=nx>send</span><span class=p>();</span></span></span></code></pre></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>A second major benefit of the JQuery library (after simplifying DOM querying and manipulation) was its effort to simplify AJAX. It provides a robust wrapper around the <code>XMLHttpRequest</code> object with the <a href=https://api.jquery.com/jquery.ajax/ rel=external target=_blank>jQuery.ajax()</a> method. Consider the AJAX request we defined in this chapter:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>xhr</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>XMLHttpRequest</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>xhr</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;load&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// do something with xhr object
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>xhr</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// report the error
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>xhr</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=s1>&#39;GET&#39;</span><span class=p>,</span> <span class=s1>&#39;https://imgs.xkcd.com/comics/blogofractal.png&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>xhr</span><span class=p>.</span><span class=nx>setRequestHeader</span><span class=p>(</span><span class=s1>&#39;Accept&#39;</span><span class=p>,</span> <span class=s1>&#39;image/png&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>xhr</span><span class=p>.</span><span class=nx>send</span><span class=p>();</span></span></span></code></pre></div><p>The equivalent jQuery code would be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>jQuery</span><span class=p>.</span><span class=nx>ajax</span><span class=p>(</span><span class=s2>&#34;https://imgs.xkcd.com/comics/blogofractal.png&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>method</span><span class=o>:</span> <span class=s1>&#39;GET&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Accept</span><span class=o>:</span> <span class=s1>&#39;image/png&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>success</span><span class=o>:</span> <span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>status</span><span class=p>,</span> <span class=nx>xhr</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// do something with data
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>error</span><span class=o>:</span> <span class=p>(</span><span class=nx>xhr</span><span class=p>,</span> <span class=nx>status</span><span class=p>,</span> <span class=nx>error</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>        <span class=c1>// report the error 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Many developers found this all-in-one approach simpler than working directly with <code>XMLHttpRequest</code> objects. The W3C adopted some of these ideas into the Fetch API.</p></div></div><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter X</div><h1 id=example-projects>Example Projects</h1><p>Example projects you can follow along with!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Example Projects</h1><article class=default><header class=headline></header><h1 id=express-starter-project>Express Starter Project</h1><a href="https://www.youtube.com/watch?v=4NUyZMgtHEw">YouTube Video</a><p>This example project is the first in a series toward building a complete full-stack web application using <a href=https://nodejs.org/en rel=external target=_blank>Node.js</a> and <a href=https://expressjs.com/ rel=external target=_blank>Express</a> to create a RESTful API on the backend that connects to a database, and then a <a href=https://vuejs.org/ rel=external target=_blank>Vue</a> single page application on the frontend.</p><p>In doing so, we&rsquo;ll explore some of the standard ways web developers use existing tools, frameworks, and libraries to perform many of the operations we&rsquo;ve learned how to do manually throughout this course. In essence, you&rsquo;ve already learned how to build these things <em>from scratch</em>, but now we&rsquo;ll look at how professionals use <em>dependencies</em> to accomplish many of the same things.</p><p>We&rsquo;ll also explore techniques for writing good, clean JavaScript code that includes documentation and API information, unit testing, and more.</p><p>Finally, we&rsquo;ll learn how to do all of this using <a href=https://github.com/features/codespaces rel=external target=_blank>GitHub Codespaces</a>, so everything runs directly in the web browser with no additional software or hardware needed. Of course, you can also do everything locally using <a href=https://www.docker.com/products/docker-desktop/ rel=external target=_blank>Docker Desktop</a> and <a href=https://code.visualstudio.com/ rel=external target=_blank>Visual Studio Code</a> as well.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li>A working GitHub Codespace containing Node.js</li><li>A bare-bones Express application</li><li>Update Express application from CommonJS to ES Modules</li><li>Application logs with Winston and Morgan</li><li>Install other useful Express libraries</li><li>A better development server using Nodemon</li><li>A tool for managing environment variables</li><li>Code documentation with JSDoc and OpenAPI comments</li><li>Linting and Formatting with ESLint and Prettier</li></ol><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Express Starter Project</h1><article class=default><header class=headline></header><h1 id=github-codespace>GitHub Codespace</h1><a href="https://www.youtube.com/watch?v=nO3-TJlFW8U">YouTube Video</a><h2 id=creating-a-codespace>Creating a Codespace</h2><p>To begin, we will start with an empty GitHub repository. You can either create one yourself, or you may be working from a repository provided through GitHub Classroom.</p><p>At the top of the page, you may see either a <strong>Create a Codespace</strong> button in an empty repository, or a <strong>Code</strong> button that opens a panel with a <strong>Codespaces</strong> tab and a <strong>Create Codespace on main</strong> button in an initialized repository. Go ahead and click that button.</p><p><a href=#R-image-3d3972cda8ec744572c89409af267484 class=lightbox-link><img alt="Codespace in Empty Repository" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/codespace_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3d3972cda8ec744572c89409af267484><img alt="Codespace in Empty Repository" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/codespace_1.png></a></p><p><a href=#R-image-02406a13b1ddf1d73bdb12a451226bd4 class=lightbox-link><img alt="Codespace in Initialized Repository" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/codespace_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-02406a13b1ddf1d73bdb12a451226bd4><img alt="Codespace in Initialized Repository" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/codespace_2.png></a></p><p>Once you do, GitHub will start creating a new <a href=https://github.com/features/codespaces rel=external target=_blank>GitHub Codespace</a> for your project. This process may take a few moments.</p><p>Once it is done, you&rsquo;ll be presented with a window that looks very similar to Visual Studio Code&rsquo;s main interface. In fact - it is! It is just a version of Visual Studio Code running directly in a web browser. Pretty neat!</p><p>For the rest of this project, we&rsquo;ll do all of our work here in GitHub Codespaces directly in our web browser.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Working Locally?</div><div class=box-content><p>If you would rather do this work on your own computer, you&rsquo;ll need to install the following prerequisites:</p><ul><li><a href=https://code.visualstudio.com/ rel=external target=_blank>Visual Studio Code</a></li><li><a href=https://www.docker.com/products/docker-desktop/ rel=external target=_blank>Docker Desktop</a></li><li><a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers" rel=external target=_blank>Dev Containers Extension</a></li></ul><p>For now, you&rsquo;ll start by cloning your GitHub repository to your local computer, and opening it in Visual Studio Code. We&rsquo;ll create some configuration files, and then reopen the project using a Dev Container in Docker. When looking in the Command Palette, just swap the &ldquo;Codespaces&rdquo; prefix with the &ldquo;Dev Containers&rdquo; prefix in the command names.</p></div></div><p>Once you&rsquo;ve created your GitHub Codespace, you can always find it again by visiting the repository in your web browser, clicking the <strong>Code</strong> button and choosing the <strong>Codespaces</strong> tab.</p><p><a href=#R-image-2efb991809a76be54feee0879affbed7 class=lightbox-link><img alt="Existing Codespace" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/codespace_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2efb991809a76be54feee0879affbed7><img alt="Existing Codespace" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/codespace_3.png></a></p><h2 id=configuring-the-codespace>Configuring the Codespace</h2><p>When we first create a GitHub Codespace, GitHub will use a <a href=https://docs.github.com/en/codespaces/setting-up-your-project-for-codespaces/adding-a-dev-container-configuration/introduction-to-dev-containers#using-the-default-dev-container-configuration rel=external target=_blank>default dev container</a> configuration. It includes many tools that are preinstalled for working on a wide variety of projects. Inside of the Codespace, you can run the following command in the terminal to get a URL that contains a list of all tools installed and their versions:</p><div class=tab-panel data-tab-group=ad45a6aa8a9d683f86ac04e36d65ccc2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ad45a6aa8a9d683f86ac04e36d65ccc2","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ devcontainer-info content-url</span></span></code></pre></div></div></div></div></div><p>The current default configuration as of this writing can be found <a href=https://github.com/devcontainers/images/blob/main/src/universal/history/2.12.6.md rel=external target=_blank>here</a>.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Documenting Terminal Commands</div><div class=box-content><p>In these example projects, we&rsquo;ll prefix any terminal commands with a dollar sign <code>$</code> symbol, representing the standard Linux terminal command prompt. You <strong>should not</strong> enter this character into the terminal, just the content after it. This makes it easy to see individual commands in the documentation, and also makes it easy to tell the difference between commands to be executed and the output produced by that command.</p><p>You can learn more in the <a href=https://developers.google.com/style/code-syntax rel=external target=_blank>Google Developer Documentation Style Guide</a>.</p></div></div><p>For this project, we are going to configure our own <a href=https://containers.dev/ rel=external target=_blank>dev container</a> that just contains the tools we need for this project. This also allows us to use the same configuration both in GitHub Codespaces as well as locally on our own systems using Docker.</p><p>To configure our own dev container, we first must open the <a href=https://code.visualstudio.com/docs/getstarted/userinterface#_command-palette rel=external target=_blank>Visual Studio Code Command Palette</a>. We can do this by pressing <kbd>CTRL</kbd>+<kbd>SHIFT</kbd>+<kbd>P</kbd>, or by clicking the top search bar on the page and choosing <strong>Show and Run Commands ></strong>.</p><p>In the Command Palette, search for and choose the <strong>Codespaces: Add Dev Container Configuration Files&mldr;</strong> option, then choose <strong>Create a new configuration&mldr;</strong>. In the list that appears, search for &ldquo;node&rdquo; to find the container titled &ldquo;Node.js & TypeScript&rdquo; and choose that option.</p><p><a href=#R-image-e1589dfc04d536874e4c7ae850652d52 class=lightbox-link><img alt="Choosing a Dev Container Configuration" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/codespace_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e1589dfc04d536874e4c7ae850652d52><img alt="Choosing a Dev Container Configuration" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/codespace_4.png></a></p><p>You&rsquo;ll then be prompted to choose a version to use. We&rsquo;ll use <code>22-bookworm</code> for this project. That refers to <a href=https://nodejs.org/en/blog/release/v22.11.0 rel=external target=_blank>Node version 22 LTS</a> running on a <a href=https://www.debian.org/releases/bookworm/ rel=external target=_blank>Debian Bookworm LTS</a> Linux image. Both of these are current, long term supported (LTS) versions of the software, making them an excellent choice for a new project.</p><p>Finally, the last question will ask if we&rsquo;d like to add any additional features to our dev container configuration. We&rsquo;ll leave this blank for now, but in the future you may find some of these additional features useful and choose to add them here.</p><p>Once that is done, a <code>.devcontainer</code> folder will be created, with a <code>devcontainer.json</code> file inside of it. The content of that file should match what is shown below:</p><div class=tab-panel data-tab-group=1f965ebf752304870ea1a25a4f8e6fdd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=devcontainerdevcontainerjson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1f965ebf752304870ea1a25a4f8e6fdd","devcontainerdevcontainerjson")'>
<span class=tab-nav-text>.devcontainer/devcontainer.json</span></button></div><div class=tab-content-container><div data-tab-item=devcontainerdevcontainerjson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// For format details, see https://aka.ms/devcontainer.json. For config options, see the
</span></span></span><span class=line><span class=cl><span class=c1>// README at: https://github.com/devcontainers/templates/tree/main/src/typescript-node
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;name&#34;</span><span class=o>:</span> <span class=s2>&#34;Node.js &amp; TypeScript&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Or use a Dockerfile or Docker Compose file. More info: https://containers.dev/guide/dockerfile
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=s2>&#34;image&#34;</span><span class=o>:</span> <span class=s2>&#34;mcr.microsoft.com/devcontainers/typescript-node:1-22-bookworm&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Features to add to the dev container. More info: https://containers.dev/features.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// &#34;features&#34;: {},
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Use &#39;forwardPorts&#39; to make a list of ports inside the container available locally.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// &#34;forwardPorts&#34;: [],
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Use &#39;postCreateCommand&#39; to run commands after the container is created.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// &#34;postCreateCommand&#34;: &#34;yarn install&#34;,
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Configure tool-specific properties.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// &#34;customizations&#34;: {},
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Uncomment to connect as root instead. More info: https://aka.ms/dev-containers-non-root.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// &#34;remoteUser&#34;: &#34;root&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Over time, we&rsquo;ll come back to this file to add additional features to our dev container. For now, we&rsquo;ll just leave it as-is.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Dependabot</div><div class=box-content><p>You may also see a second file, <code>.github/dependabot.yml</code> that is also created. This file is used by the <a href=https://docs.github.com/en/code-security/getting-started/dependabot-quickstart-guide rel=external target=_blank>GitHub Dependabot</a> to keep your dev container configuration up to date. You may get occasional notices from GitHub in the future if there are any updates to software included in your dev container configuration.</p></div></div><p>At this point, we are ready to rebuilt our GitHub Codespace to use our new dev container configuration. To do this, open the Command Palette once again and look for the <strong>Codespaces: Rebuild Container</strong> option. Click that option, then select the <strong>Full Rebuild</strong> option in the popup window since we have completely changed our dev container configuration.</p><p>Now, we can sit back and be patient while GitHub Codespaces rebuilds our environment using the new configuration. This may take several minutes.</p><p>Once it is complete, we can confirm that Node.js is installed and running the correct version by running the following command and checking the output matches our expected version of Node.js:</p><div class=tab-panel data-tab-group=3b8b770f380c42db78b40009d5482a24><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3b8b770f380c42db78b40009d5482a24","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node --version
</span></span><span class=line><span class=cl>v22.12.0</span></span></code></pre></div></div></div></div></div><p>If that works, then our dev container environment in GitHub Codespaces should be set up and ready to go!</p><p>Now is a good time to commit our current work to git and push it to GitHub. Even though we are working in a GitHub Codespace, we still have to <strong>commit and push</strong> our work to get it saved. You can do this using the Source Control sidebar tab on the page, or using the classic terminal commands as shown below.</p><div class=tab-panel data-tab-group=545cda4c526526eff49ddec0e13b2c31><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("545cda4c526526eff49ddec0e13b2c31","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ git add .
</span></span><span class=line><span class=cl>$ git commit -m <span class=s2>&#34;Dev Container&#34;</span>
</span></span><span class=line><span class=cl>$ git push -u origin main</span></span></code></pre></div></div></div></div></div><p>For the rest of this exercise, we&rsquo;ll assume that you are comfortable with git and GitHub and can take care of committing and pushing your work yourself, but we&rsquo;ll give you several hints showing when we hit a good opportunity to save your work.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=express-starter>Express Starter</h1><a href="https://www.youtube.com/watch?v=Wh4jmh9A7V4">YouTube Video</a><h2 id=generating-an-express-application>Generating an Express Application</h2><p>Now that we have our dev container configured, we can start setting up an Express application. The recommended method in the documentation is to use the <a href=https://expressjs.com/en/starter/generator.html rel=external target=_blank>Express application generator</a>, so we&rsquo;ll use that method. You may want to refer to the documentation for this command to see what options are available.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Express Documentation</div><div class=box-content><p>You may also want to bookmark the <a href=https://expressjs.com/ rel=external target=_blank>Express Documentation</a> website as well, since it contains lots of helpful information about how Express works that may not be covered in this tutorial.</p></div></div><p>For this project, we&rsquo;ll use the following command to build our application:</p><div class=tab-panel data-tab-group=9c31a574a1c63ec8c689fb9c516a6eed><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9c31a574a1c63ec8c689fb9c516a6eed","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npx express-generator --no-view --git server</span></span></code></pre></div></div></div></div></div><p>Let&rsquo;s break down that command to see what it is doing:</p><ul><li><code>npx</code> - The <a href=https://docs.npmjs.com/cli/v7/commands/npx rel=external target=_blank>npx</a> command is included with Node.js and <code>npm</code> and allows us to run a command from an <code>npm</code> package, including packages that <em>aren&rsquo;t currently installed!</em>. This is the preferred way to run commands that are available in any <code>npm</code> packages.</li><li><code>express-generator</code> - This is the <a href=https://www.npmjs.com/package/express-generator rel=external target=_blank>express-generator</a> package in <code>npm</code> that contains the command we are using to build our Express application.</li><li><code>--no-view</code> - This option will generate a project without a built-in view engine.</li><li><code>--git</code> - This option will add a <code>.gitignore</code> file to our project</li><li><code>server</code> - This is the name of the directory where we would like to create our application.</li></ul><p>When we run that command, we may be prompted to install the <code>express-generator</code> package, so we can press <code>y</code> to install it.</p><p>That command will produce a large amount of output, similar to what is shown below:</p><div class=tab-panel data-tab-group=d15d339450997929a70dc901f39cb45d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d15d339450997929a70dc901f39cb45d","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>Need to install the following packages:
express-generator@4.16.1
Ok to proceed? (y) y

npm warn deprecated mkdirp@0.5.1: Legacy versions of mkdirp are no longer supported. Please update to mkdirp 1.x. (Note that the API surface has changed to use Promises in 1.x.)

   create : server/
   create : server/public/
   create : server/public/javascripts/
   create : server/public/images/
   create : server/public/stylesheets/
   create : server/public/stylesheets/style.css
   create : server/routes/
   create : server/routes/index.js
   create : server/routes/users.js
   create : server/public/index.html
   create : server/.gitignore
   create : server/app.js
   create : server/package.json
   create : server/bin/
   create : server/bin/www

   change directory:
     $ cd server

   install dependencies:
     $ npm install

   run the app:
     $ DEBUG=server:* npm start</code></pre></div></div></div></div></div><p>As we can see, it created quite a few files for us! Let&rsquo;s briefly review what each of these files and folders are for:</p><ul><li><code>public</code> - this folder contains the static HTML, CSS, and JavaScript files that will be served from our application. Much later down the road, we&rsquo;ll place the compiled version of our Vue frontend application in this folder. For now, it just serves as a placeholder for where those files will be placed.</li><li><code>routes</code> - this folder contains the Express application routers for our application. There are currently only two routers, the <code>index.js</code> router connected to the <code>/</code> path, and the <code>users.js</code> router connected to the <code>/users</code> path.</li><li><code>.gitignore</code> - this file tells git which files or folders can be ignored when committing to the repository. We&rsquo;ll discuss this file in detail below.</li><li><code>app.js</code> - this is the main file for our Express application. It loads all of the libraries, configurations, and routers and puts them all together into a single Express application.</li><li><code>package.json</code> - this file contains information about the project, including some metadata, scripts, and the list of external dependencies. More information on the structure and content of that file can be found in the <a href=https://docs.npmjs.com/cli/v11/configuring-npm/package-json rel=external target=_blank>documentation</a>.</li><li><code>bin/www</code> - this file is the actual entrypoint for our web application. It loads the Express application defined in <code>app.js</code>, and then creates an <code>http</code> server to listen for incoming connections and sends them to the Express application. It also handles figuring out which port the application should listen on, as well as some common errors.</li></ul><p>Since we are only building a RESTful API application, there are a few files that we can delete or quickly modify:</p><ul><li>Delete everything in the <code>public</code> folder <strong>except</strong> the file <code>index.html</code></li><li>Inside of the <code>public/index.html</code> file, remove the line referencing the stylesheet: <code>&lt;link rel="stylesheet" href="/stylesheets/style.css"></code> since it has been deleted.</li></ul><p>At this point, we should also update the contents of the <code>package.json</code> file to describe our project. It currently contains information similar to this:</p><div class=tab-panel data-tab-group=51db130900db14ec38cefb78d5cdefb2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("51db130900db14ec38cefb78d5cdefb2","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;node ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cookie-parser&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.4.4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;debug&#34;</span><span class=p>:</span> <span class=s2>&#34;~2.6.9&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;express&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.16.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;morgan&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.9.1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>For now, let&rsquo;s update the <code>name</code> and <code>version</code> entries to match our project:</p><div class=tab-panel data-tab-group=a5353dd59cb7aa501cc0a19eb98f441d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a5353dd59cb7aa501cc0a19eb98f441d","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;node ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cookie-parser&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.4.4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;debug&#34;</span><span class=p>:</span> <span class=s2>&#34;~2.6.9&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;express&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.16.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;morgan&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.9.1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>In a stand-alone application like ours, these values really don&rsquo;t matter, but if we do decide to publish this application as an <code>npm</code> module in the future, these values will be used to build the module itself.</p><h2 id=exploring-appjs>Exploring App.js</h2><p>Let&rsquo;s quickly take a look at the contents of the <code>app.js</code> file to get an idea of what this application does:</p><div class=tab-panel data-tab-group=e723780a5fb215856c3975ce17ed2c2e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e723780a5fb215856c3975ce17ed2c2e","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>express</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;express&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>path</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;path&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>cookieParser</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;cookie-parser&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>logger</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;morgan&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>indexRouter</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;./routes/index&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>usersRouter</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;./routes/users&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>logger</span><span class=p>(</span><span class=s1>&#39;dev&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=nx>__dirname</span><span class=p>,</span> <span class=s1>&#39;public&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/users&#39;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>app</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>At the top, the file loads several libraries, including <a href=https://www.npmjs.com/package/cookie-parser rel=external target=_blank>cookie-parser</a> for parsing cookies sent from the browser, and <a href=https://www.npmjs.com/package/morgan rel=external target=_blank>morgan</a> for logging requests. It then also loads the two routers, <code>index</code> and <code>users</code>.</p><p>Next, we see the line <code>var app = express()</code> - this line actually creates the Express application and stores a reference to it in the <code>app</code> variable.</p><p>The next few lines add various middlewares to the Express application using the <code>app.use()</code> function. Each of these is effectively a function that is called each time the application receives a request, one after the other, until a response is generated and sent. See <a href=https://expressjs.com/en/guide/using-middleware.html rel=external target=_blank>Using middleware</a> in the Express documentation for more details.</p><p>The last line of that group uses the <code>express.static</code> middleware to serve static files from the <code>public</code> directory (it uses the <code>path</code> library and the <code>__dirname</code> global variable to construct the correct absolute path to those files). So, if the user requests any path that matches a static file, that file will be sent to the user. This will happen even if a static file matches an existing route, since this middleware is added to the application before the routes. So, there are some instances where we may want to connect this middleware to the application <em>after</em> adding some important routes - we&rsquo;ll discuss that in the future as we continue to build this application.</p><p>After that, the two routers are added as well. Each router is given a base path - the <code>index</code> router is given the <code>/</code> path, then the <code>users</code> router is given the <code>/users</code> path. These are the URL paths that are used to determine where each incoming request should be sent in the application. See <a href=https://expressjs.com/en/guide/routing.html rel=external target=_blank>routing</a> in the Express documentation for more details.</p><p>Finally, the Express application referenced in <code>app</code> is exported from this file. It is used by the <code>bin/www</code> file and attached to an <code>http</code> server to listen for incoming requests.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Order Matters</div><div class=box-content><p>Because Express is a routing and middleware framework, the order in which you add middlewares and routers determines how the application functions. So, we must be very thoughtful about the order in which we add middlewares and routers to our application. In this example, notice, that we add the logger first, then parse any incoming JSON requests, then decode any URL encoded requests, then parse any cookies, before doing anything else.</p><p>This is a common error that trips up many first-time Express developers, so be mindful as you add and adjust content in this file!</p></div></div><h2 id=installing-dependencies>Installing Dependencies</h2><p>Now that we&rsquo;ve generated a basic Express web application, we need to install all of the dependencies. This is also the first step we&rsquo;ll need to do anytime we clone this project for the first time or if we rebuild our GitHub codespace or dev container.</p><p>To do this, we need to go to the terminal and change directory to the <code>server</code> folder:</p><div class=tab-panel data-tab-group=8cab020f72b66d512ded07cf9c000c08><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8cab020f72b66d512ded07cf9c000c08","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>cd</span> server</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Working Directory</div><div class=box-content><p>Remember that we can always see the current working directory by looking at the command prompt in the terminal, or by typing the <code>pwd</code> command:</p><p><a href=#R-image-8357daa906fd20d639d0c7a66e770097 class=lightbox-link><img alt="Working Directory in Terminal" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/express_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8357daa906fd20d639d0c7a66e770097><img alt="Working Directory in Terminal" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/express_1.png></a></p><p><a href=#R-image-f9231b791de4a32dddee73745a94c8b7 class=lightbox-link><img alt="Present Working Directory" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/express_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f9231b791de4a32dddee73745a94c8b7><img alt="Present Working Directory" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/express_2.png></a></p></div></div><p>Once inside of the <code>server</code> folder, we can install all our dependencies using the following command:</p><div class=tab-panel data-tab-group=b3e3cab8e42e3fefa181442e191914c4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b3e3cab8e42e3fefa181442e191914c4","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install</span></span></code></pre></div></div></div></div></div><p>When we run that command, we&rsquo;ll see output similar to the following:</p><div class=tab-panel data-tab-group=901557713c45e01b62353e3d6bdc5513><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("901557713c45e01b62353e3d6bdc5513","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>added 53 packages, and audited 54 packages in 4s

7 vulnerabilities (3 low, 4 high)

To address all issues, run:
  npm audit fix --force

Run `npm audit` for details.</code></pre></div></div></div></div></div><p>It looks like we have some out of date packages and vulnerabilities to fix!</p><h2 id=updating-dependencies>Updating Dependencies</h2><p>Thankfully, there is a very useful command called <a href=https://www.npmjs.com/package/npm-check-updates rel=external target=_blank>npm-check-updates</a> that we can use to update our dependencies anytime there is a problem. We can run that package&rsquo;s command using <code>npx</code> as we saw earlier:</p><div class=tab-panel data-tab-group=db59afeea3d967a06c9ffa9c79989a66><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("db59afeea3d967a06c9ffa9c79989a66","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npx npm-check-updates</span></span></code></pre></div></div></div></div></div><p>As before, we&rsquo;ll be prompted to install the package if it isn&rsquo;t installed already. Once it is done, we&rsquo;ll see output like this:</p><div class=tab-panel data-tab-group=2178538a8386130b7f1b591a3f9c83a6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2178538a8386130b7f1b591a3f9c83a6","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>Need to install the following packages:
npm-check-updates@17.1.14
Ok to proceed? (y) y

Checking /workspaces/example-project/server/package.json
[====================] 4/4 100%

 cookie-parser   ~1.4.4  ‚Üí   ~1.4.7
 debug           ~2.6.9  ‚Üí   ~4.4.0
 express        ~4.16.1  ‚Üí  ~4.21.2
 morgan          ~1.9.1  ‚Üí  ~1.10.0

Run npx npm-check-updates -u to upgrade package.json</code></pre></div></div></div></div></div><p>When we run the command, it tells us which packages are out of date and lists a newer version of the package we can install.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Tread Carefully!</div><div class=box-content><p>In an actual production application, it is important to make sure your dependencies are kept up to date. At the same time, you&rsquo;ll want to carefully read the documentation for these dependencies and test your project after any dependency updates, just to ensure that your application works correctly using the new versions.</p><p>For example, in the output above, we see this:</p><div class=highlight><pre tabindex=0><code> debug           ~2.6.9  ‚Üí   ~4.4.0</code></pre></div><p>This means that the <code>debug</code> library is <strong>two major versions</strong> out of date (see <a href=https://semver.org/ rel=external target=_blank>Semantic Versioning</a> for more information on how to interpret version numbers)! If we check the <a href="https://www.npmjs.com/package/debug?activeTab=versions" rel=external target=_blank><code>debug</code> versions list</a> on npm, we can see that version <code>2.6.9</code> was released in September 2017 - a very long time ago.</p><p>When a package undergoes a major version change, it often comes with incompatible API changes. So, we may want to consult the documentation for each major version or find release notes or upgrade guides to refer to. In this case, we can refer to the release notes for each version on GitHub:</p><ul><li>3.0.0: <a href=https://github.com/debug-js/debug/releases/tag/3.0.0 rel=external target=_blank>https://github.com/debug-js/debug/releases/tag/3.0.0</a></li><li>4.0.0: <a href=https://github.com/debug-js/debug/releases/tag/4.0.0 rel=external target=_blank>https://github.com/debug-js/debug/releases/tag/4.0.0</a></li></ul><p>We may even need to check some of the release notes for minor releases as well.</p><p>Thankfully, the latest version of the <code>debug</code> library is compatible with our existing code, and later in this project we&rsquo;ll replace it with a better logging infrastructure anyway.</p></div></div><p>Now that we know which dependencies can be updated, we can use the same command with the <code>-u</code> option to update our <code>package.json</code> file easily:</p><div class=tab-panel data-tab-group=c6701525be4c41f9ce9ed16c75a5f304><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c6701525be4c41f9ce9ed16c75a5f304","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npx npm-check-updates -u</span></span></code></pre></div></div></div></div></div><p>We should see output similar to this:</p><div class=tab-panel data-tab-group=3d7ada2fe740980214682ab091d7179c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3d7ada2fe740980214682ab091d7179c","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>Upgrading /workspaces/example-project/server/package.json
[====================] 4/4 100%

 cookie-parser   ~1.4.4  ‚Üí   ~1.4.7
 debug           ~2.6.9  ‚Üí   ~4.4.0
 express        ~4.16.1  ‚Üí  ~4.21.2
 morgan          ~1.9.1  ‚Üí  ~1.10.0

Run npm install to install new versions.</code></pre></div></div></div></div></div><p>We can also check our <code>package.json</code> file to see the changes:</p><div class=tab-panel data-tab-group=61df053c4ba86a028698d9d9607e13f8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("61df053c4ba86a028698d9d9607e13f8","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;node ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cookie-parser&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.4.7&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;debug&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.4.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;express&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.21.2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;morgan&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.10.0&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Finally, we can install those dependencies:</p><div class=tab-panel data-tab-group=3f51fb5b2ce2f463c068142031b3b615><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3f51fb5b2ce2f463c068142031b3b615","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install</span></span></code></pre></div></div></div></div></div><p>Now when we run that command, we should see that everything is up to date!</p><div class=tab-panel data-tab-group=7e7ac9b8b4a1df732a1f7a50e3a5e59d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7e7ac9b8b4a1df732a1f7a50e3a5e59d","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>added 36 packages, changed 24 packages, and audited 90 packages in 4s

14 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities</code></pre></div></div></div></div></div><p>There we go! We now have a sample Express application configured with updated dependencies.</p><h2 id=testing-the-application>Testing the Application</h2><p>At this point, we are ready to actually test our application. To do this, we can run the following command from within the <code>server</code> directory in our project:</p><div class=tab-panel data-tab-group=e2b21db57aaf3ecc6cbacd777d354fb7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e2b21db57aaf3ecc6cbacd777d354fb7","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm start</span></span></code></pre></div></div></div></div></div><p>When we do, we&rsquo;ll see a bit of information on the terminal:</p><div class=tab-panel data-tab-group=98941369a52787bfc4a1bcfa870a865f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("98941369a52787bfc4a1bcfa870a865f","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 start
&gt; node ./bin/www</code></pre></div></div></div></div></div><p>We&rsquo;ll also see a small popup in the bottom right corner of the screen, telling us that it has detected that our application is listening on port <code>3000</code>.</p><p><a href=#R-image-36e67864a8d6329de8f8f0bae51a5a2f class=lightbox-link><img alt="Listening Port Popup" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/express_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-36e67864a8d6329de8f8f0bae51a5a2f><img alt="Listening Port Popup" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/express_3.png></a></p><p>So, to access our application, we can click on the <strong>Open in Browser</strong> button on that popup. If everything works correctly, we should be able to see our application running in our web browser:</p><p><a href=#R-image-8992480b5f7a4a0df6b51ebd696d4033 class=lightbox-link><img alt="Running Example Application" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/express_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8992480b5f7a4a0df6b51ebd696d4033><img alt="Running Example Application" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/express_4.png></a></p><p>Take a look at the long URL in the browser - that URL includes the name of the GitHub Codespace (<code>laughing-computing-machine</code> in this example), followed by a random Codespace ID (<code>jj5j9p97vx435jqj</code>), followed by the port our application is listening on (<code>3000</code>). We&rsquo;ll look at ways we can build this URL inside of our application in the future, but for now it is just worth noting.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Finding Listening Ports</div><div class=box-content><p>If you didn&rsquo;t see the popup appear, or you cannot find where your application is running, check the <strong>PORTS</strong> tab above the console in GitHub Codespaces:</p><p><a href=#R-image-0ebc812081aa2992e4fd91b13a41a584 class=lightbox-link><img alt="Listening Port List" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/express_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0ebc812081aa2992e4fd91b13a41a584><img alt="Listening Port List" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/express_5.png></a></p><p>We can click on the URL under the <strong>Forwarded Addresses</strong> heading to access the port in our web browser. We can also use this interface to configure additional ports that we want to be able to access outside of the GitHub Codespace.</p></div></div><p>We can also access any routes that are configured in our application. For example, the default Express application includes a <code>/users</code> route, so we can just add <code>/users</code> to the end of the URL in our web browser to access it. We should see this page when we do:</p><p><a href=#R-image-932e79d1486774d6704c0b3c2b951e0b class=lightbox-link><img alt="Running Example Users Path" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/express_6.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-932e79d1486774d6704c0b3c2b951e0b><img alt="Running Example Users Path" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/express_6.png></a></p><p>Great! It looks like our example application in running correctly.</p><h2 id=committing-to-github>Committing to GitHub</h2><p>Now is a great time to commit and push our project to GitHub. Before we do, however, we should double-check that our project has a proper <code>server/.gitignore</code> file. It should have been created by the Express application generator if we used the <code>--git</code> option, but it is always important to double-check that it is there before trying to commit a new project.</p><p><a href=#R-image-6e958b09494d6c8532891c104a7a4851 class=lightbox-link><img alt="Gitignore File" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/express_7.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6e958b09494d6c8532891c104a7a4851><img alt="Gitignore File" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/express_7.png></a></p><p>A <a href=https://docs.github.com/en/get-started/getting-started-with-git/ignoring-files rel=external target=_blank>.gitignore</a> file is used to tell git which files should not be committed to a repository. For a project using Node.js, we especially don&rsquo;t want to commit our <code>node_modules</code> folder. This folder contains all of the dependencies for our project, and can often be very large.</p><p>Why don&rsquo;t we want to commit it? Because it contains lots of code that isn&rsquo;t ours, and it is much better to just install the dependencies locally whenever we develop or use our application. That is the whole function of the <code>package.json</code> file and the <code>npm</code> command - it lets us focus on only developing our own code, and it will find and manage all other external dependencies for us.</p><p>So, as a general rule of thumb, we should <strong>NEVER</strong> commit the <code>node_modules</code> folder to our repository.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Missing gitignore file?</div><div class=box-content><p>If your project does not have a <code>.gitignore</code> file, you can usually find one for the language or framework you are using in the excellent <a href=https://github.com/github/gitignore rel=external target=_blank>gitignore GitHub Repository</a>. Just look for the appropriate file and add the contents to a <code>.gitignore</code> file in your project. For example, you can find a <a href=https://github.com/github/gitignore/blob/main/Node.gitignore rel=external target=_blank>Node.gitignore</a> file to use in this project.</p></div></div><p>At long last, we are ready to <strong>commit and push</strong> all of our changes to this project. If it works correctly, it should only commit the code files we&rsquo;ve created, but none of the files that are ignored in the <code>.gitignore</code> file.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=convert-to-es-modules>Convert to ES Modules</h1><a href="https://www.youtube.com/watch?v=6dDn8qBPTgs">YouTube Video</a><h2 id=commonjs-vs-es-modules>CommonJS vs ES Modules</h2><p>By default, the Express application generator creates an application using the <a href=https://nodejs.org/api/modules.html#modules-commonjs-modules rel=external target=_blank>CommonJS module format</a>. This is the original way that JavaScript modules were packaged. However, many libraries and frameworks have been moving to the new <a href=https://nodejs.org/api/esm.html rel=external target=_blank>ECMAScript module format</a> (commonly referred to as ES modules), which is current official standard way of packaging JavaScript modules.</p><p>Since we want to build an industry-grade application, it would be best to update our application to use the new ES module format. This format will become more and more common over time, and many dependencies on npm have already started to shift to only supporting the ES module format. So, let&rsquo;s take the time now to update our application to use that new format before we go any further.</p><h2 id=enabling-es-module-support>Enabling ES Module Support</h2><p>To enable ES module support in our application, we must simply add <code>"type": "module",</code> to the <code>package.json</code> file:</p><div class=tab-panel data-tab-group=77333d17ab8f322924a2ba1034d48016><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("77333d17ab8f322924a2ba1034d48016","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;module&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;node ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cookie-parser&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.4.7&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;debug&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.4.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;express&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.21.2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;morgan&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.10.0&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Now, let&rsquo;s try to run our application:</p><div class=tab-panel data-tab-group=8e7cdf9257b6a5362f76d4a1a678ceae><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8e7cdf9257b6a5362f76d4a1a678ceae","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm start</span></span></code></pre></div></div></div></div></div><p>When we do, we&rsquo;ll get some errors:</p><div class=tab-panel data-tab-group=386e1bc5e05d1424924d0e883a48ebc5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("386e1bc5e05d1424924d0e883a48ebc5","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 start
&gt; node ./bin/www

file:///workspaces/example-project/server/bin/www:7
var app = require(&#39;../app&#39;);
          ^

ReferenceError: require is not defined in ES module scope, you can use import instead
    at file:///workspaces/example-project/server/bin/www:7:11
    at ModuleJob.run (node:internal/modules/esm/module_job:271:25)
    at async onImport.tracePromise.__proto__ (node:internal/modules/esm/loader:547:26)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:116:5)

Node.js v22.12.0</code></pre></div></div></div></div></div><p>By changing that one line in <code>package.json</code>, the Node.js runtime is trying to load our project using ES modules instead of CommonJS modules, and it causes all sorts of errors. Thankfully, most of them are easy to fix! In most cases, we are simply making two updates:</p><ol><li>Replacing <code>require</code> statements with <code>import</code> statements</li><li>Replacing <code>module.exports</code> statements with <code>export default</code> statements.</li></ol><p>Let&rsquo;s go file by file and make these updates. We&rsquo;ll only show the lines that are commented out and their replacements directly below - you&rsquo;ll need to look carefully at each file, find the commented line, and replace it with the new line.</p><ul><li><code>bin/www</code></li></ul><div class=tab-panel data-tab-group=4013c2a253db9c2584feff66451f0bf5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4013c2a253db9c2584feff66451f0bf5","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// var app = require(&#39;../app&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s1>&#39;../app.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var debug = require(&#39;debug&#39;)(&#39;server:server&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>debugLibrary</span> <span class=nx>from</span> <span class=s1>&#39;debug&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>debug</span> <span class=o>=</span> <span class=nx>debugLibrary</span><span class=p>(</span><span class=s1>&#39;server:server&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var http = require(&#39;http&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><ul><li><code>app.js</code></li></ul><div class=tab-panel data-tab-group=18796e0ace1d1c2c8d6ac2b5ed186116><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("18796e0ace1d1c2c8d6ac2b5ed186116","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// var express = require(&#39;express&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var path = require(&#39;path&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var cookieParser = require(&#39;cookie-parser&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var logger = require(&#39;morgan&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;morgan&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var indexRouter = require(&#39;./routes/index&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/index.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var usersRouter = require(&#39;./routes/users&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/users.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>//module.exports = app;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=k>default</span> <span class=nx>app</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><ul><li><code>routes/index.js</code> and <code>routes/users.js</code></li></ul><div class=tab-panel data-tab-group=425054d9863ff9f6ffdeba7c6f132bad><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesindexjs-amp-routesusersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("425054d9863ff9f6ffdeba7c6f132bad","routesindexjs-amp-routesusersjs")'>
<span class=tab-nav-text>routes/index.js & routes/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesindexjs-amp-routesusersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// var express = require(&#39;express&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var router = express.Router();
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// module.exports = router;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>At this point, let&rsquo;s test our application again to see if we&rsquo;ve updated everything correctly:</p><div class=tab-panel data-tab-group=7c2440b80866262a79c1919546b07c29><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7c2440b80866262a79c1919546b07c29","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm start</span></span></code></pre></div></div></div></div></div><p>Now, we should get an error message similar to this:</p><div class=tab-panel data-tab-group=b2ceb5b941370996d74fde4372f892cf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b2ceb5b941370996d74fde4372f892cf","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>file:///workspaces/example-project/server/app.js:25
app.use(express.static(path.join(__dirname, &#39;public&#39;)));
                                 ^

ReferenceError: __dirname is not defined in ES module scope
    at file:///workspaces/example-project/server/app.js:25:34
    at ModuleJob.run (node:internal/modules/esm/module_job:271:25)
    at async onImport.tracePromise.__proto__ (node:internal/modules/esm/loader:547:26)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:116:5)

Node.js v22.12.0</code></pre></div></div></div></div></div><p>This is a bit trickier to debug, but a quick Google search usually leads to the correct answer. In this case, the <code>__dirname</code> variable is a global variable that is defined when Node.js is running a CommonJS module, as discussed in the <a href=https://nodejs.org/docs/latest/api/modules.html#__dirname rel=external target=_blank>documentation</a>. However, when Node.js is running an ES module, many of these global variables have been relocated to the <code>import.meta</code> property, as shown in the <a href=https://nodejs.org/api/esm.html#importmetadirname rel=external target=_blank>documentation</a>. So, we can just replace <code>__dirname</code> with the <code>import.meta.dirname</code> variable in <code>app.js</code>:</p><div class=tab-panel data-tab-group=49cfc8874def8846bd8c1edfa7ca08c3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("49cfc8874def8846bd8c1edfa7ca08c3","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>//app.use(express.static(path.join(__dirname, &#39;public&#39;)));
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s1>&#39;public&#39;</span><span class=p>)));</span></span></span></code></pre></div></div></div></div></div><p>Let&rsquo;s try to run our application again - it should be able to start this time:</p><div class=tab-panel data-tab-group=877534fa1e99a6fabb604b684f14d806><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("877534fa1e99a6fabb604b684f14d806","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm start</span></span></code></pre></div></div></div></div></div><p>Updating a Node.js application to use ES modules is not terribly difficult, especially if it is done early in development. However, since we&rsquo;ve made this change, we&rsquo;ll have to be careful as we continue to develop our application. Many online tutorials, documentation, and references assume that any Node.js and Express application is still using CommonJS modules, so we may have to translate any code we find to match our new ES module setup.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><h2 id=references>References</h2><ul><li><a href=https://electerious.medium.com/from-commonjs-to-es-modules-how-to-modernize-your-node-js-app-ad8cdd4fb662 rel=external target=_blank>From CommonJS to ES Modules: How to modernize your Node.js app</a></li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=debugging--logging>Debugging & Logging</h1><a href="https://www.youtube.com/watch?v=iykPYL9FQMs">YouTube Video</a><h2 id=debugging-with-the-debug-utility>Debugging with the Debug Utility</h2><p>Now that we have a basic Express application, let&rsquo;s add some helpful tools for developers to make our application easier to work with and debug in the future. These are some great quality of life tweaks that many professional web applications include, but often new developers fail to add them early on in development and waste lots of time adding them later. So, let&rsquo;s take some time now to add these features before we start developing any actual RESTful endpoints.</p><p>First, you may have noticed that the <code>bin/www</code> file includes the <a href=https://www.npmjs.com/package/debug rel=external target=_blank>debug</a> utility. This is a very common debugging module that is included in many Node.sj applications, and is modeled after how Node.js itself handles debugging internally. It is a very powerful module, and one that you should make use of anytime you are creating a Node.js library to be published on npm and shared with others.</p><p>Let&rsquo;s quickly look at how we can use the <code>debug</code> utility in our application. Right now, when we start our application, we see very little output on the terminal:</p><div class=tab-panel data-tab-group=d1fc3b8d49c3d2a81751c10df82c09e3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d1fc3b8d49c3d2a81751c10df82c09e3","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm start</span></span></code></pre></div></div></div></div></div><p>That command produces this output:</p><div class=tab-panel data-tab-group=c58b439ca8ec6379d5f74761c4c0422b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c58b439ca8ec6379d5f74761c4c0422b","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 start
&gt; node ./bin/www</code></pre></div></div></div></div></div><p>As we access various pages and routes, we may see some additional lines of output appear, like this:</p><div class=tab-panel data-tab-group=63f54b0b3aa7a14996adc88dbc83674a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("63f54b0b3aa7a14996adc88dbc83674a","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>GET / 304 2.569 ms - -
GET /users 200 2.417 ms - 23
GET / 200 1.739 ms - 120</code></pre></div></div></div></div></div><p>These lines come from the <a href=https://www.npmjs.com/package/morgan rel=external target=_blank>morgan</a> request logging middleware, which we&rsquo;ll discuss on the next page of this example.</p><p>To enable the <code>debug</code> library, we simply must set an environment variable in the terminal when we run our application, as shown here:</p><div class=tab-panel data-tab-group=b75d638006ec183ae6c1e129c83ca80d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b75d638006ec183ae6c1e129c83ca80d","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nv>DEBUG</span><span class=o>=</span>* npm start</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Environment Variables</div><div class=box-content><p>An <a href=https://en.wikipedia.org/wiki/Environment_variable rel=external target=_blank><strong>environment variable</strong></a> is a value that is present in memory in a running instance of an operating system. These generally give running processes information about the system, but may also include data and information provided by the user or system administrator. Environment variables are very common ways to configure applications that run in containers, like our application will when it is finally deployed. We&rsquo;ll cover this in detail later in this course; for now, just understand that we are setting a variable in memory that can be accessed inside of our application.</p></div></div><p>Now, we&rsquo;ll be provided with a lot of debugging output from all throughout our application:</p><div class=tab-panel data-tab-group=e29f1d4549a4226034fadc81906f5934><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e29f1d4549a4226034fadc81906f5934","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 start
&gt; node ./bin/www

  express:router:route new &#39;/&#39; +0ms
  express:router:layer new &#39;/&#39; +1ms
  express:router:route get &#39;/&#39; +0ms
  express:router:layer new &#39;/&#39; +1ms
  express:router:route new &#39;/&#39; +0ms
  express:router:layer new &#39;/&#39; +0ms
  express:router:route get &#39;/&#39; +0ms
  express:router:layer new &#39;/&#39; +0ms
  express:application set &#34;x-powered-by&#34; to true +1ms
  express:application set &#34;etag&#34; to &#39;weak&#39; +0ms
  express:application set &#34;etag fn&#34; to [Function: generateETag] +0ms
  express:application set &#34;env&#34; to &#39;development&#39; +0ms
  express:application set &#34;query parser&#34; to &#39;extended&#39; +0ms
  express:application set &#34;query parser fn&#34; to [Function: parseExtendedQueryString] +0ms
  express:application set &#34;subdomain offset&#34; to 2 +0ms
  express:application set &#34;trust proxy&#34; to false +0ms
  express:application set &#34;trust proxy fn&#34; to [Function: trustNone] +1ms
  express:application booting in development mode +0ms
  express:application set &#34;view&#34; to [Function: View] +0ms
  express:application set &#34;views&#34; to &#39;/workspaces/example-project/server/views&#39; +0ms
  express:application set &#34;jsonp callback name&#34; to &#39;callback&#39; +0ms
  express:router use &#39;/&#39; query +1ms
  express:router:layer new &#39;/&#39; +0ms
  express:router use &#39;/&#39; expressInit +0ms
  express:router:layer new &#39;/&#39; +0ms
  express:router use &#39;/&#39; logger +0ms
  express:router:layer new &#39;/&#39; +0ms
  express:router use &#39;/&#39; jsonParser +0ms
  express:router:layer new &#39;/&#39; +0ms
  express:router use &#39;/&#39; urlencodedParser +1ms
  express:router:layer new &#39;/&#39; +0ms
  express:router use &#39;/&#39; cookieParser +0ms
  express:router:layer new &#39;/&#39; +0ms
  express:router use &#39;/&#39; serveStatic +0ms
  express:router:layer new &#39;/&#39; +0ms
  express:router use &#39;/&#39; router +0ms
  express:router:layer new &#39;/&#39; +1ms
  express:router use &#39;/users&#39; router +0ms
  express:router:layer new &#39;/users&#39; +0ms
  express:application set &#34;port&#34; to 3000 +2ms
  server:server Listening on port 3000 +0ms</code></pre></div></div></div></div></div><p>Each line of output starts with a package name, such as <code>express:application</code> showing the <em>namespace</em> where the logging message came from (which usually corresponds to the library or module it is contained in), followed by the message itself. The last part of the line looks like <code>+0ms</code>, and is simply a timestamp showing the time elapsed since the last debug message was printed.</p><p>At the very bottom we see the debug line <code>server:server Listening on port 3000 +0ms</code> - this line is what is actually printed in the <code>bin/www</code> file. Let&rsquo;s look at that file and see where that comes from:</p><div class=tab-panel data-tab-group=bd7c324ba99413ad9cdfe60466b75903><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bd7c324ba99413ad9cdfe60466b75903","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>debugLibrary</span> <span class=nx>from</span> <span class=s1>&#39;debug&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>debug</span> <span class=o>=</span> <span class=nx>debugLibrary</span><span class=p>(</span><span class=s1>&#39;server:server&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>onListening</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>addr</span> <span class=o>=</span> <span class=nx>server</span><span class=p>.</span><span class=nx>address</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>bind</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>addr</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=s1>&#39;pipe &#39;</span> <span class=o>+</span> <span class=nx>addr</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=s1>&#39;port &#39;</span> <span class=o>+</span> <span class=nx>addr</span><span class=p>.</span><span class=nx>port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>debug</span><span class=p>(</span><span class=s1>&#39;Listening on &#39;</span> <span class=o>+</span> <span class=nx>bind</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>At the top of that file, we import the <code>debug</code> library, and then instantiate it using the name <code>'server:server'</code>. This becomes the <em>namespace</em> for our debug messages printed using this instance of the <code>debug</code> library. Then, inside of the <code>onListening()</code> function, we call the <code>debug</code> function and provide a message to be printed.</p><p>When we run our application, we can change the value of the <code>DEBUG</code> environment variable to match a particular namespace to only see messages from that part of our application:</p><div class=tab-panel data-tab-group=4d2564c2b8e9991deff48356957daae4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4d2564c2b8e9991deff48356957daae4","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ $ <span class=nv>DEBUG</span><span class=o>=</span>server:* npm start</span></span></code></pre></div></div></div></div></div><p>This will only show output from our <code>server</code> namespace:</p><div class=tab-panel data-tab-group=4342afccd89b1e2f14832532d72f1233><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4342afccd89b1e2f14832532d72f1233","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; example-project@0.0.1 start
</span></span><span class=line><span class=cl>&gt; node ./bin/www
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  server:server Listening on port <span class=m>3000</span> +0ms</span></span></code></pre></div></div></div></div></div><p>The <code>debug</code> utility is a very powerful tool for diagnosing issues with a Node.js and Express application. You can learn more about how to use and configure the <code>debug</code> utility in the <a href=https://www.npmjs.com/package/debug rel=external target=_blank>documentation</a>.</p><h2 id=logging-with-winston>Logging with Winston</h2><p>However, since we are focused on creating a web application and not a library, let&rsquo;s replace <code>debug</code> with the more powerful <a href=https://www.npmjs.com/package/winston rel=external target=_blank>winston</a> logger. This allows us to create a robust logging system based on the traditional concept of <a href=https://en.wikipedia.org/wiki/Syslog#Severity_level rel=external target=_blank>severity levels</a> of the logs we want to see.</p><p>To start, let&rsquo;s install <code>winston</code> using the <code>npm</code> command (as always, we should make sure we are working in the <code>server</code> directory of our application):</p><div class=tab-panel data-tab-group=1d7eca370ba7e6e12365a0bea1491e2c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1d7eca370ba7e6e12365a0bea1491e2c","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install winston</span></span></code></pre></div></div></div></div></div><p>We should see output similar to the following:</p><div class=highlight><pre tabindex=0><code>added 28 packages, and audited 118 packages in 2s

15 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities</code></pre></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Multiple Dependencies</div><div class=box-content><p>Notice how installing a single dependency actually installed 28 individual packages? This is a very useful feature of how Node.js and npm packages are structured, since each package can focus on doing only one task really well while reusing common tools and utilities that other packages may also use (thereby reducing the number of duplicated packages that may need to be installed). Unfortunately, this can also lead to situations where an issue with a single package can cause cascading failures and incompatibilities across the board. So, while it is very helpful to install these dependencies in our application, we always want to do so with caution and make sure are always using dependencies that are well maintained and actually add value to our application.</p></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> The <code>left-pad</code> Incident</div><div class=box-content><p>For a vivid case study of the concerns around using unnecessary dependencies, look at the <a href=https://en.wikipedia.org/wiki/Npm_left-pad_incident rel=external target=_blank>npm left-pad incident</a>. The <code>left-pad</code> library was a simple utility that added padding to the left side of a string. The entire library itself was a single function that contained less than 10 lines of actual code. However, when the developer of that library removed access to it due to a dispute, it ended up nearly breaking the entire npm ecosystem. Core development tools such as Babel, Webpack and more all used that library as a dependency, and with the rise of automated build systems, each tool broke as soon as the next rebuild cycle was initiated. It also caused issues with major online platforms such as Facebook, PayPal, Netflix, and Spotify.</p><p>Even today, nearly 9 years after the incident, the <a href=https://www.npmjs.com/package/left-pad rel=external target=_blank>left-pad</a> library is still present on npm, even though it is listed as deprecated since JavaScript now includes a method <code>String.prototype.padStart()</code> that performs the same action. As of January 2025, there are still 540 libraries on npm that list <code>left-pad</code> as a dependency, and it is downloaded over 1 million times per week!</p></div></div><p>Now that we&rsquo;ve installed <code>winston</code>, we should configure it. We could place all of the code to configure it inside of each file where it is used, but let&rsquo;s instead create a standalone configuration file for <code>winston</code> that we can use throughout our application.</p><p>To do this, let&rsquo;s create a new folder named <code>configs</code> inside of our <code>server</code> folder to house configurations for various dependencies, and then inside of that folder create a new file named <code>logger.js</code> for this configuration. In that file, we can place the following content:</p><div class=tab-panel data-tab-group=d05851b765cc75da01b8443a6a704585><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsloggerjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d05851b765cc75da01b8443a6a704585","configsloggerjs")'>
<span class=tab-nav-text>configs/logger.js</span></button></div><div class=tab-content-container><div data-tab-item=configsloggerjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>winston</span> <span class=nx>from</span> <span class=s1>&#39;winston&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>combine</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=nx>printf</span><span class=p>,</span> <span class=nx>colorize</span><span class=p>,</span> <span class=nx>align</span><span class=p>,</span> <span class=nx>errors</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>format</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Log Levels
</span></span></span><span class=line><span class=cl><span class=c1>//   error: 0
</span></span></span><span class=line><span class=cl><span class=c1>//   warn: 1
</span></span></span><span class=line><span class=cl><span class=c1>//   info: 2
</span></span></span><span class=line><span class=cl><span class=c1>//   http: 3
</span></span></span><span class=line><span class=cl><span class=c1>//   verbose: 4
</span></span></span><span class=line><span class=cl><span class=c1>//   debug: 5
</span></span></span><span class=line><span class=cl><span class=c1>//   silly: 6
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>level</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;0&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;error&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;error&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;1&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;warn&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;warn&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;2&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;info&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;info&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;3&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;http&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;4&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;verbose&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;verbose&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;5&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;debug&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;debug&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;6&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;silly&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;silly&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>logger</span> <span class=o>=</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>createLogger</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=c1>// call `level` function to get default log level
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>level</span><span class=o>:</span> <span class=nx>level</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Format configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>format</span><span class=o>:</span> <span class=nx>combine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>colorize</span><span class=p>({</span> <span class=nx>all</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=nx>errors</span><span class=p>({</span> <span class=nx>stack</span><span class=o>:</span> <span class=kc>true</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=nx>timestamp</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=nx>format</span><span class=o>:</span> <span class=s1>&#39;YYYY-MM-DD hh:mm:ss.SSS A&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=nx>align</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>printf</span><span class=p>((</span><span class=nx>info</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=sb>`[</span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>timestamp</span><span class=si>}</span><span class=sb>] </span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>level</span><span class=si>}</span><span class=sb>: </span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>stack</span> <span class=o>?</span> <span class=nx>info</span><span class=p>.</span><span class=nx>message</span> <span class=o>+</span> <span class=s2>&#34;\n&#34;</span> <span class=o>+</span> <span class=nx>info</span><span class=p>.</span><span class=nx>stack</span> <span class=o>:</span> <span class=nx>info</span><span class=p>.</span><span class=nx>message</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Output configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>transports</span><span class=o>:</span> <span class=p>[</span><span class=k>new</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>transports</span><span class=p>.</span><span class=nx>Console</span><span class=p>()]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>logger</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>At the top, we see a helpful comment just reminding us which log levels are available by default in <code>winston</code>. Then, we have a <code>level</code> function that determines what our desired log level should be based on an environment variable named <code>LOG_LEVEL</code>. We&rsquo;ll set that variable a bit later in this tutorial. Based on that log level, our system will print any logs at that level or lower in severity level. Finally, we create an instance of the <code>winston</code> logger and provide lots of configuration information about our desired output format. All of this is highly configurable. To fully understand this configuration, take some time to review the <a href=https://www.npmjs.com/package/winston rel=external target=_blank>winston documentation</a>.</p><p>Now, let&rsquo;s update our <code>bin/www</code> file to use this logger instead of the <code>debug</code> utility. Lines that have been changed are highlighted:</p><div class=tab-panel data-tab-group=529e450eafa4286f7f731cdd601bef3b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("529e450eafa4286f7f731cdd601bef3b","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// var debug = require(&#39;debug&#39;)(&#39;server:server&#39;);
</span></span></span><span class="line hl"><span class=cl><span class=c1>// import debugLibrary from &#39;debug&#39;;
</span></span></span><span class="line hl"><span class=cl><span class=c1>// const debug = debugLibrary(&#39;server:server&#39;);
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;../configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>onError</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>syscall</span> <span class=o>!==</span> <span class=s1>&#39;listen&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=nx>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>bind</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>port</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=s1>&#39;Pipe &#39;</span> <span class=o>+</span> <span class=nx>port</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=s1>&#39;Port &#39;</span> <span class=o>+</span> <span class=nx>port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// handle specific listen errors with friendly messages
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>switch</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>code</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s1>&#39;EACCES&#39;</span><span class=o>:</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// console.error(bind + &#39; requires elevated privileges&#39;);
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=nx>bind</span> <span class=o>+</span> <span class=s1>&#39; requires elevated privileges&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s1>&#39;EADDRINUSE&#39;</span><span class=o>:</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// console.error(bind + &#39; is already in use&#39;);
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=nx>bind</span> <span class=o>+</span> <span class=s1>&#39; is already in use&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=nx>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Event listener for HTTP server &#34;listening&#34; event.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>onListening</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>addr</span> <span class=o>=</span> <span class=nx>server</span><span class=p>.</span><span class=nx>address</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>bind</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>addr</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=s1>&#39;pipe &#39;</span> <span class=o>+</span> <span class=nx>addr</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=s1>&#39;port &#39;</span> <span class=o>+</span> <span class=nx>addr</span><span class=p>.</span><span class=nx>port</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl>  <span class=c1>// debug(&#39;Listening on &#39; + bind);
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>  <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s1>&#39;Listening on &#39;</span> <span class=o>+</span> <span class=nx>bind</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Basically, we&rsquo;ve replaced all instances of the <code>debug</code> method with <code>logger.debug</code>. We&rsquo;ve also replaced a couple of uses of <code>console.error</code> to instead use <code>logger.error</code>. They will also create new <code>Error</code> object, which will cause <code>winston</code> to print a stack trace as well.</p><p>With that change in place, we can now remove the <code>debug</code> utility from our list of dependencies:</p><div class=tab-panel data-tab-group=7c22c67dcce96cc620ea1f51279b5bd1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7c22c67dcce96cc620ea1f51279b5bd1","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm uninstall debug</span></span></code></pre></div></div></div></div></div><p>Now, let&rsquo;s run our program to see <code>winston</code> in action:</p><div class=tab-panel data-tab-group=24d3d0662c0a770f8fcbbdeb4f7bebec><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("24d3d0662c0a770f8fcbbdeb4f7bebec","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm start</span></span></code></pre></div></div></div></div></div><p>When we run it, we should see this output:</p><div class=tab-panel data-tab-group=2c1b6156ff7b6e24ff4c40b1878b78cf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2c1b6156ff7b6e24ff4c40b1878b78cf","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 start
&gt; node ./bin/www</code></pre></div></div></div></div></div><p>Notice how <code>winston</code> didn&rsquo;t print any debug messages? That is because we haven&rsquo;t set our <code>LOG_LEVEL</code> environment variable. So, let&rsquo;s do that by creating two different scripts in our <code>package.json</code> file - one to run the application with a default log level, and another to run it with the <code>debug</code> log level:</p><div class=tab-panel data-tab-group=9d6eb8fb2b8afdaade6a38f7ea9e5756><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9d6eb8fb2b8afdaade6a38f7ea9e5756","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;module&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=debug node ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cookie-parser&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.4.7&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;express&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.21.2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;morgan&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.10.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;winston&#34;</span><span class=p>:</span> <span class=s2>&#34;^3.17.0&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>The <code>npm run</code> command can be used to run any of the scripts in the <code>scripts</code> section of our <code>package.json</code> file.
So, if we want to run our application so we can see the debug messages, we can use the following command:</p><div class=tab-panel data-tab-group=3f8ba3e19bd4d33565519ae12794edda><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3f8ba3e19bd4d33565519ae12794edda","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Now we should see some debug messages in the output:</p><div class=tab-panel data-tab-group=f5935262dc07fa4170476942661cdd87><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f5935262dc07fa4170476942661cdd87","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; LOG_LEVEL=debug node ./bin/www

[2025-01-17 06:23:03.622 PM] info:      Listening on port 3000</code></pre></div></div></div></div></div><p>Great! Notice how the logger outputs a timestamp, the log level, and the message, all on the same line? This matches the configuration we used in the <code>configs/logger.js</code> file. On most terminals, each log level will even be a different color!</p><p><a href=#R-image-1c9980a5d050e54b7c0cc3d973e8a114 class=lightbox-link><img alt="Debug Logging in Color" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/debug_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1c9980a5d050e54b7c0cc3d973e8a114><img alt="Debug Logging in Color" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/debug_1.png></a></p><p>Finally, since we really should make sure the message that the application is successfully listening on a port is printed by default, let&rsquo;s change it to the <code>info</code> log level in our <code>bin/www</code> file:</p><div class=tab-panel data-tab-group=b9a688a8b3bf64d69b67abbc15c4b2f4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b9a688a8b3bf64d69b67abbc15c4b2f4","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>onListening</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>addr</span> <span class=o>=</span> <span class=nx>server</span><span class=p>.</span><span class=nx>address</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>bind</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>addr</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=s1>&#39;pipe &#39;</span> <span class=o>+</span> <span class=nx>addr</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=s1>&#39;port &#39;</span> <span class=o>+</span> <span class=nx>addr</span><span class=p>.</span><span class=nx>port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// debug(&#39;Listening on &#39; + bind);
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>  <span class=nx>logger</span><span class=p>.</span><span class=nx>info</span><span class=p>(</span><span class=s1>&#39;Listening on &#39;</span> <span class=o>+</span> <span class=nx>bind</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Why Not Use NODE_ENV?</div><div class=box-content><p>In many web applications written using Node.js and Express, you may have come across the <code>NODE_ENV</code> environment variable, which is often set to either <code>development</code>, <code>production</code>, or sometimes <code>test</code> to configure the application. While this may have made sense in the past, it is now considered an <em>anti-pattern</em> in Node.js. This is because there no fundamental difference between development and production in Node.js, and it is often very confusing if an application runs differently in different environments. So, it is better to directly configure logging via its own environment variable instead of using an overall variable that configures multiple services. See the <a href=https://nodejs.org/en/learn/getting-started/nodejs-the-difference-between-development-and-production rel=external target=_blank>Node.js Documentation</a> for a deeper discussion of this topic.</p></div></div><p>This is a good point to <strong>commit and push</strong> our work!</p><h2 id=references>References</h2><ul><li><a href=https://betterstack.com/community/guides/logging/how-to-install-setup-and-use-winston-and-morgan-to-log-node-js-applications/ rel=external target=_blank>A Complete Guide to Winston Logging in Node.js</a></li><li><a href=https://levelup.gitconnected.com/better-logs-for-expressjs-using-winston-and-morgan-with-typescript-1c31c1ab9342 rel=external target=_blank>Better logs for ExpressJS using Winston and Morgan with Typescript</a></li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=request-logging>Request Logging</h1><a href="https://www.youtube.com/watch?v=0d9YbadZ3Mk">YouTube Video</a><h2 id=logging-requests-with-morgan>Logging Requests with Morgan</h2><p>Now that we have configured a logging utility, let&rsquo;s use it to also log all incoming requests sent to our web application. This will definitely make it much easier to keep track of what is going on in our application and make sure it is working correctly.</p><p>The Express application generator already installs a library for this, called <a href=https://www.npmjs.com/package/morgan rel=external target=_blank>morgan</a>. We have already seen output from <code>morgan</code> before:</p><div class=tab-panel data-tab-group=7b06458c17eaed9def94650aaf1b4d9b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7b06458c17eaed9def94650aaf1b4d9b","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>GET / 304 2.569 ms - -
GET /users 200 2.417 ms - 23
GET / 200 1.739 ms - 120</code></pre></div></div></div></div></div><p>While this is useful, let&rsquo;s reconfigure <code>morgan</code> to use our new <code>winston</code> logger and add some additional detail to the output.</p><p>Since <code>morgan</code> is technically a <a href=https://expressjs.com/en/guide/using-middleware.html rel=external target=_blank>middleware</a> in our application, let&rsquo;s create a new folder called <code>middlewares</code> to store configuration for our various middlewares, and then we can create a new middleware file named <code>request-logger.js</code> in that folder. Inside of that file, we can place the following configuration:</p><div class=tab-panel data-tab-group=1ac2793ebc6e2836dd8325aca3559c27><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=middlewaresrequest-loggerjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1ac2793ebc6e2836dd8325aca3559c27","middlewaresrequest-loggerjs")'>
<span class=tab-nav-text>middlewares/request-logger.js</span></button></div><div class=tab-content-container><div data-tab-item=middlewaresrequest-loggerjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>morgan</span> <span class=nx>from</span> <span class=s1>&#39;morgan&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;../configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Override morgan stream method to use our custom logger
</span></span></span><span class=line><span class=cl><span class=c1>// Log Format
</span></span></span><span class=line><span class=cl><span class=c1>// :method :url :status :response-time ms - :res[content-length]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>stream</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>write</span><span class=o>:</span> <span class=p>(</span><span class=nx>message</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// log using the &#39;http&#39; severity
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>logger</span><span class=p>.</span><span class=nx>http</span><span class=p>(</span><span class=nx>message</span><span class=p>.</span><span class=nx>trim</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// See https://github.com/expressjs/morgan?tab=readme-ov-file#api
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>requestLogger</span> <span class=o>=</span> <span class=nx>morgan</span><span class=p>(</span><span class=s1>&#39;dev&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>stream</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>requestLogger</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>In effect, this file basically tells <code>morgan</code> to write output through the <code>logger.http()</code> method instead of just directly to the console. We are importing our <code>winston</code> configuration from <code>configs/logger.js</code> to accomplish this. We are also configuring <code>morgan</code> to use the <code>dev</code> logging format; more information on log formats can be found in the <a href=https://www.npmjs.com/package/morgan rel=external target=_blank>documentation</a>.</p><p>Finally, let&rsquo;s update our <code>app.js</code> file to use this new request logger middleware instead of <code>morgan</code>:</p><div class=tab-panel data-tab-group=2b8a88b86de3a4730595efd1347dbf54><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2b8a88b86de3a4730595efd1347dbf54","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=c1>// import logger from &#39;morgan&#39;;
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>requestLogger</span> <span class=nx>from</span> <span class=s1>&#39;./middlewares/request-logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/index.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/users.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// app.use(logger(&#39;dev&#39;));
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s1>&#39;public&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, let&rsquo;s run our application and access a few of the routes via our web browser:</p><div class=tab-panel data-tab-group=2f3afffab1578ea74a92126683687cfe><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2f3afffab1578ea74a92126683687cfe","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>We should now see output from <code>morgan</code> included as <code>http</code> logs from <code>winston</code>:</p><div class=tab-panel data-tab-group=f0dca71d80808f6f38ca0bde5f9ade4b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f0dca71d80808f6f38ca0bde5f9ade4b","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; LOG_LEVEL=debug node ./bin/www

[2025-01-17 06:39:30.975 PM] info:      Listening on port 3000
[2025-01-17 06:39:37.430 PM] http:      GET / 200 3.851 ms - 120
[2025-01-17 06:39:40.665 PM] http:      GET /users 200 3.184 ms - 23
[2025-01-17 06:39:43.069 PM] http:      GET / 304 0.672 ms - -
[2025-01-17 06:39:45.424 PM] http:      GET /users 304 1.670 ms - -</code></pre></div></div></div></div></div><p>When viewed on a modern terminal, they should even be colorized!</p><p><a href=#R-image-e001584a120f67cb2f7b934649698d96 class=lightbox-link><img alt="Request Logging" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/request_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e001584a120f67cb2f7b934649698d96><img alt="Request Logging" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/request_1.png></a></p><p>Here, we can see each log level is colorized, and also the HTTP status codes in our <code>morgan</code> log output are also colorized. The first time each page is accessed, the browser receives a <code>200</code> status code in green with the content. The second time, our application correctly sends back a <code>304</code> status code in light blue, indicating that the content has not been modified and that the browser can use the cached version instead.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=other-libraries>Other Libraries</h1><a href="https://www.youtube.com/watch?v=ntg2fQQ1FQ8">YouTube Video</a><h2 id=other-useful-libraries>Other Useful Libraries</h2><p>Before we move on, let&rsquo;s install a few other useful libraries that perform various tasks in our Express application.</p><h3 id=compression>Compression</h3><p>The <a href=https://www.npmjs.com/package/compression rel=external target=_blank>compression</a> middleware library does exactly what it says it will - it compresses any responses generated by the server and sent through the network. This can be helpful in many situations, but not all. Recall that compression is really just trading more processing time in exchange for less network bandwidth, so we may need to consider which of those we are more concerned about. Thankfully, adding or removing the <code>compression</code> middleware library is simple.</p><p>First, let&rsquo;s install it using <code>npm</code>:</p><div class=tab-panel data-tab-group=248bda9d55d3f628093186ccf94aa280><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("248bda9d55d3f628093186ccf94aa280","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install compression</span></span></code></pre></div></div></div></div></div><p>Then, we can add it to our <code>app.js</code> file, generally early in the chain of middlewares since it will impact all responses after that point in the chain.</p><div class=tab-panel data-tab-group=1ab3d9dc88dadab87e275187c948ba2b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1ab3d9dc88dadab87e275187c948ba2b","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>compression</span> <span class=nx>from</span> <span class=s1>&#39;compression&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>requestLogger</span> <span class=nx>from</span> <span class=s1>&#39;./middlewares/request-logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/index.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/users.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>compression</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s1>&#39;public&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/users&#39;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>app</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>To test this library, we can run our application with all built-in debugging enabled through the <code>debug</code> library as documented in the <a href=https://expressjs.com/en/guide/debugging.html rel=external target=_blank>Express Documentation</a>:</p><div class=tab-panel data-tab-group=68ca8a46f6a070791845bd78e257ae16><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("68ca8a46f6a070791845bd78e257ae16","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nv>DEBUG</span><span class=o>=</span>* npm run dev</span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll see a bunch of output as our Express application is initialized. Once it is done, we can open the home page in our web browser to send an HTTP GET request to the server. This will produce the following log output:</p><div class=tab-panel data-tab-group=63276313565dc2c06459aaadfb856632><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("63276313565dc2c06459aaadfb856632","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  express:router dispatching GET / +1m
</span></span><span class=line><span class=cl>  express:router query  : / +0ms
</span></span><span class=line><span class=cl>  express:router expressInit  : / +1ms
</span></span><span class=line><span class=cl>  express:router compression  : / +0ms
</span></span><span class=line><span class=cl>  express:router logger  : / +0ms
</span></span><span class=line><span class=cl>  express:router urlencodedParser  : / +0ms
</span></span><span class=line><span class=cl>  body-parser:urlencoded skip empty body +1ms
</span></span><span class=line><span class=cl>  express:router cookieParser  : / +0ms
</span></span><span class=line><span class=cl>  express:router serveStatic  : / +0ms
</span></span><span class=line><span class=cl>  send stat <span class=s2>&#34;/workspaces/example-project/server/public/index.html&#34;</span> +0ms
</span></span><span class=line><span class=cl>  send pipe <span class=s2>&#34;/workspaces/example-project/server/public/index.html&#34;</span> +1ms
</span></span><span class=line><span class=cl>  send accept ranges +0ms
</span></span><span class=line><span class=cl>  send cache-control public, max-age<span class=o>=</span><span class=m>0</span> +0ms
</span></span><span class=line><span class=cl>  send modified Thu, <span class=m>16</span> Jan <span class=m>2025</span> 23:17:14 GMT +0ms
</span></span><span class=line><span class=cl>  send etag W/<span class=s2>&#34;78-1947168173e&#34;</span> +1ms
</span></span><span class=line><span class=cl>  send content-type text/html +0ms
</span></span><span class="line hl"><span class=cl>  compression no compression: size below threshold +1ms
</span></span><span class=line><span class=cl>  morgan log request +2ms
</span></span><span class=line><span class=cl><span class=o>[</span>2025-01-25 07:00:35.013 PM<span class=o>]</span> http:      GET / <span class=m>200</span> 3.166 ms - <span class=m>120</span></span></span></code></pre></div></div></div></div></div><p>We can see in the highlighted line that the <code>compression</code> library did not apply any compression to the response because it was below the minium size threshold. This is set to 1kb by default according to the <a href=https://www.npmjs.com/package/compression rel=external target=_blank>compression</a> documentation.</p><p>So, to really see what it does, let&rsquo;s generate a much larger response by adding some additional text to our <code>public/index.html</code> file (this text was generated using <a href=https://www.lipsum.com/ rel=external target=_blank>Lorem Ipsum</a>):</p><div class=tab-panel data-tab-group=c60b5bb671d866679231ce96116d67f7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=publicindexhtml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c60b5bb671d866679231ce96116d67f7","publicindexhtml")'>
<span class=tab-nav-text>public/index.html</span></button></div><div class=tab-content-container><div data-tab-item=publicindexhtml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Express<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>Express<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Welcome to Express<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam sed arcu tincidunt, porttitor diam a, porta nibh. Duis pretium tellus euismod, imperdiet elit id, gravida turpis. Fusce vitae pulvinar tellus. Donec cursus pretium justo, sed vehicula erat iaculis lobortis. Mauris dapibus scelerisque aliquet. Nullam posuere, magna vitae viverra lacinia, sapien magna imperdiet erat, ac sagittis ante ante tristique eros. Phasellus eget fermentum mauris. Integer justo lorem, finibus a ullamcorper in, feugiat in nunc. Etiam ut felis a magna aliquam consectetur. Duis eu mauris ut leo vehicula fringilla scelerisque vel mi. Donec placerat quam nulla, at commodo orci maximus sit amet. Curabitur tincidunt euismod enim, non feugiat nulla eleifend sed. Sed finibus metus sit amet metus congue commodo. Cras ullamcorper turpis sed mi scelerisque porta.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Sed maximus diam in blandit elementum. Integer diam ante, tincidunt in pulvinar at, luctus in dui. Fusce tincidunt hendrerit dolor in suscipit. Nullam vitae tellus at justo bibendum blandit a vel ligula. Nunc sed augue blandit, finibus nisi nec, posuere orci. Maecenas ut egestas diam. Donec non orci nec ex rhoncus malesuada at eget ante. Proin ultricies cursus nunc eu mollis. Donec vel ligula vel eros luctus pulvinar. Proin vitae dui imperdiet, rutrum risus non, maximus purus. Vivamus fringilla augue tincidunt, venenatis arcu eu, dictum nunc. Mauris eu ullamcorper orci. Cras efficitur egestas ligula. Maecenas a nisl bibendum turpis tristique lobortis.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Now, when we request that file, we should see this line in our debug output:</p><div class=tab-panel data-tab-group=74fd7c340047d328d148340c9ac33aba><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("74fd7c340047d328d148340c9ac33aba","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>express:router dispatching GET / +24s
</span></span><span class=line><span class=cl>  express:router query  : / +1ms
</span></span><span class=line><span class=cl>  express:router expressInit  : / +0ms
</span></span><span class=line><span class=cl>  express:router compression  : / +0ms
</span></span><span class=line><span class=cl>  express:router logger  : / +0ms
</span></span><span class=line><span class=cl>  express:router urlencodedParser  : / +0ms
</span></span><span class=line><span class=cl>  body-parser:urlencoded skip empty body +0ms
</span></span><span class=line><span class=cl>  express:router cookieParser  : / +1ms
</span></span><span class=line><span class=cl>  express:router serveStatic  : / +0ms
</span></span><span class=line><span class=cl>  send stat <span class=s2>&#34;/workspaces/example-project/server/public/index.html&#34;</span> +0ms
</span></span><span class=line><span class=cl>  send pipe <span class=s2>&#34;/workspaces/example-project/server/public/index.html&#34;</span> +0ms
</span></span><span class=line><span class=cl>  send accept ranges +0ms
</span></span><span class=line><span class=cl>  send cache-control public, max-age<span class=o>=</span><span class=m>0</span> +0ms
</span></span><span class=line><span class=cl>  send modified Sat, <span class=m>25</span> Jan <span class=m>2025</span> 19:05:18 GMT +0ms
</span></span><span class=line><span class=cl>  send etag W/<span class=s2>&#34;678-1949edaaa4c&#34;</span> +0ms
</span></span><span class=line><span class=cl>  send content-type text/html +0ms
</span></span><span class="line hl"><span class=cl>  compression gzip compression +1ms
</span></span><span class=line><span class=cl>  morgan log request +1ms
</span></span><span class=line><span class=cl><span class=o>[</span>2025-01-25 07:05:20.234 PM<span class=o>]</span> http:      GET / <span class=m>200</span> 1.232 ms - -</span></span></code></pre></div></div></div></div></div><p>As we can see, the <code>compression</code> middleware is now compressing the response before it is sent to the server using the <a href=https://en.wikipedia.org/wiki/Gzip rel=external target=_blank>gzip</a> compression algorithm. We can also see this in our web browser&rsquo;s debugging tools - in Google Chrome, we notice that the <code>Content-Encoding</code> header is set to <code>gzip</code> as shown below:</p><p><a href=#R-image-45b261e0b9f8e4acc173858464a8f019 class=lightbox-link><img alt="Compressed Server Response" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/other_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-45b261e0b9f8e4acc173858464a8f019><img alt="Compressed Server Response" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/other_1.png></a></p><p>We&rsquo;ll go ahead and integrate the <code>compression</code> middleware into our project for this course, but as discussed above, it is always worth considering whether the tradeoff of additional processing time to save network bandwidth is truly worth it.</p><h3 id=helmet>Helmet</h3><p>Another very useful Express library is <a href=https://www.npmjs.com/package/helmet rel=external target=_blank>helmet</a>. Helmet sets several headers in the HTTP response from an Express application to help improve security. This includes things such as setting an appropriate <a href=https://helmetjs.github.io/#content-security-policy rel=external target=_blank>Content-Security-Policy</a> and removing information about the web server that could be leaked in the <a href=https://helmetjs.github.io/#x-powered-by rel=external target=_blank>X-Powered-By</a> header.</p><p>To install <code>helmet</code> we can simply use <code>npm</code> as always:</p><div class=tab-panel data-tab-group=13c0a19113fd85964f3db3d61230f84f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("13c0a19113fd85964f3db3d61230f84f","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install helmet</span></span></code></pre></div></div></div></div></div><p>Similar to the <code>compression</code> library above, we can simply add <code>helmet</code> to our Express application&rsquo;s <code>app.js</code> file:</p><div class=tab-panel data-tab-group=3238a1fc04c5bac0640598889fb7e4a4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3238a1fc04c5bac0640598889fb7e4a4","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>compression</span> <span class=nx>from</span> <span class=s1>&#39;compression&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>helmet</span> <span class=nx>from</span> <span class=s1>&#39;helmet&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>requestLogger</span> <span class=nx>from</span> <span class=s1>&#39;./middlewares/request-logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/index.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/users.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>helmet</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>compression</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s1>&#39;public&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/users&#39;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>app</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>To really see what the <code>helmet</code> library does, we can examine the headers sent by the server with and without <code>helmet</code> enabled.</p><p>First, here are the headers sent by the server without <code>helmet</code> enabled:</p><p><a href=#R-image-1ca361ae163afa7954409e561428fe12 class=lightbox-link><img alt="Insecure Headers" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/other_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1ca361ae163afa7954409e561428fe12><img alt="Insecure Headers" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/other_2.png></a></p><p>When <code>helmet</code> is enabled, we see an entirely different set of headers:</p><p><a href=#R-image-ddc1c5fef6c832b2ba497ce47d2c262e class=lightbox-link><img alt="Secure Headers" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/other_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ddc1c5fef6c832b2ba497ce47d2c262e><img alt="Secure Headers" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/other_3.png></a></p><p>In the second screenshot, notice that the <code>Content-Security-Policy</code> header is now present, but the <code>X-Powered-By</code> header is not? Those changes, along with many others, are provided by the <code>helmet</code> library.</p><p>In general, it is always a good idea to review the security of the headers sent by our application. Installing <code>helmet</code> is a good start, but as we continue to develop applications we may learn additional ways we can configure <code>helmet</code> to provide even more security for our applications.</p><h3 id=nodemon>Nodemon</h3><p>Finally, let&rsquo;s also install the <a href=https://www.npmjs.com/package/nodemon rel=external target=_blank>nodemon</a> package to make developing our application a bit easier. At its core, <code>nodemon</code> is a simple tool that will auotmatically restart our application anytime it detects that a file has changed. In this way, we can just leave our application running in the background, and any changes we make to the code will immediately be availbale for us to test without having to manually restart the server.</p><p>To begin, let&rsquo;s install <code>nodemon</code> as a development dependency using <code>npm</code> with the <code>--save-dev</code> flag:</p><div class=tab-panel data-tab-group=14913c5ef974d1524e3530f5a0ffa902><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("14913c5ef974d1524e3530f5a0ffa902","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install nodemon --save-dev</span></span></code></pre></div></div></div></div></div><p>Notice that this will cause that library to be installed in a new section of our <code>package.json</code> file called <code>devDependencies</code>:</p><div class=tab-panel data-tab-group=7a43486366a252234d223ea8dcae548f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7a43486366a252234d223ea8dcae548f","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;compression&#34;</span><span class=p>:</span> <span class=s2>&#34;^1.7.5&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cookie-parser&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.4.7&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;express&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.21.2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;helmet&#34;</span><span class=p>:</span> <span class=s2>&#34;^8.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;morgan&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.10.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;winston&#34;</span><span class=p>:</span> <span class=s2>&#34;^3.17.0&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;devDependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;nodemon&#34;</span><span class=p>:</span> <span class=s2>&#34;^3.1.9&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>These dependencies are only installed by <code>npm</code> when we are developing our application. The default <code>npm install</code> command will install all dependencies, including development dependencies. However, we can instead either use <code>npm install --omit=dev</code> or set the <code>NODE_ENV</code> environment variable to <code>production</code> to avoid installing development dependencies.</p><p>Next, we can simply update our <code>package.json</code> file to use the <code>nodemon</code> command instead of <code>node</code> in the <code>dev</code> script:</p><div class=tab-panel data-tab-group=9329373c6b08842d92bec815763ffc70><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9329373c6b08842d92bec815763ffc70","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;module&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=debug nodemon ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Now, when we execute our application:</p><div class=tab-panel data-tab-group=19b1c5ffe02d8cb6070ddbfe6acdb657><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("19b1c5ffe02d8cb6070ddbfe6acdb657","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>We should see additional output from <code>nodemon</code> to see that it is working:</p><div class=tab-panel data-tab-group=362d8662fe02accb1df5098c6f4e986f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("362d8662fe02accb1df5098c6f4e986f","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; LOG_LEVEL=debug nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[2025-01-25 09:37:24.734 PM] info:      Listening on port 3000</code></pre></div></div></div></div></div><p>Now, with our application running, we can make any change to a file in our application, such as <code>app.js</code>, and it will automatically restart our application:</p><div class=tab-panel data-tab-group=8ea69aa83891b338e9e6044dc7a0eb4b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8ea69aa83891b338e9e6044dc7a0eb4b","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[nodemon] restarting due to changes...
[nodemon] starting `node ./bin/www`
[2025-01-25 09:39:02.858 PM] info:      Listening on port 3000</code></pre></div></div></div></div></div><p>We can also always manually type <code>rs</code> in the terminal to restart the application when it is running inside of <code>nodemon</code>.</p><p>In general, using <code>nodemon</code> to develop a Node.js application is recommended, but we don&rsquo;t want to use that in a production environment. So, we are careful to install <code>nodemon</code> as a development dependency only.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=environment>Environment</h1><a href="https://www.youtube.com/watch?v=RwurcrpXW7g">YouTube Video</a><h2 id=environment-variables>Environment Variables</h2><p>As discussed earlier, an <a href=https://en.wikipedia.org/wiki/Environment_variable rel=external target=_blank><strong>environment variable</strong></a> is a value present in memory in the operating system environment where a process is running. They contain important information about the system where the application is running, but they can also be configured by the user or system administrator to provide information and configuration to any processes running in that environment. This is especially used when working with <strong>containers</strong> like the dev container we built for this project.</p><p>To explore this, we can use the <code>printenv</code> command in any Linux terminal:</p><div class=tab-panel data-tab-group=e4220a7615e4b83f4269e25c776dee4b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e4220a7615e4b83f4269e25c776dee4b","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ printenv</span></span></code></pre></div></div></div></div></div><p>When we run that command in our GitHub codespace, we&rsquo;ll see output containing lines similar to this (many lines have been omitted as they contain secure information):</p><div class=tab-panel data-tab-group=406bf4c3d7e88d82196db74cf1759a1d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("406bf4c3d7e88d82196db74cf1759a1d","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>SHELL=/bin/bash
GITHUB_USER=russfeld
CODESPACE_NAME=laughing-computing-machine-jj5j9p97vx435jqj
HOSTNAME=codespaces-f1a983
RepositoryName=example-project
CODESPACES=true
YARN_VERSION=1.22.22
PWD=/workspaces/example-project/server
ContainerVersion=13
GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN=app.github.dev
USER=node
NODE_VERSION=22.12.0
OLDPWD=/workspaces/example-project
TERM_PROGRAM=vscode</code></pre></div></div></div></div></div><p>As we can see, the environment contains many useful variables, including a <code>CODESPACES</code> variable showing that the application is running in GitHub Codespaces. We can also find our <code>GITHUB_USER</code>, <code>CODESPACE_NAME</code> and even the <code>NODE_VERSION</code> all in the environment.</p><h2 id=configuring-the-environment>Configuring the Environment</h2><p>Because many web applications eventually run in a containerized environment anyway, it is very common practice to configure those applications through the use of environment variables. Thankfully, we can more easily control and configure our application through the use of a special library <a href=https://dotenvx.com/ rel=external target=_blank>dotenvx</a> that allows us to load a set of environment variables from a file named <code>.env</code>.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> dotenv</div><div class=box-content><p>The <code>dotenvx</code> library is a newer version of the <a href=https://www.npmjs.com/package/dotenv rel=external target=_blank>dotenv</a> library that has been used for this purpose for many years. <code>dotenvx</code> was developed by the same developer, and is often recommended as a new, modern replacement to <code>dotenv</code> for most users. It includes features that allow us to create multiple environments and even encrypt values. So, for this project we&rsquo;ll use the newer library to take advantage of some of those features.</p></div></div><p>To begin, let&rsquo;s install <code>dotenvx</code> using <code>npm</code>:</p><div class=tab-panel data-tab-group=e070ee8024e320b9c20a2c132d0dad1d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e070ee8024e320b9c20a2c132d0dad1d","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install @dotenvx/dotenvx</span></span></code></pre></div></div></div></div></div><p>Next, we&rsquo;ll need to import that library as early as possible in our application, since we want to make sure that the environment is properly loaded before any other configuration files are referenced, since they may require environment variables to work properly. In this case, we want to do that as the very first thing in <code>app.js</code>:</p><div class=tab-panel data-tab-group=8e998033ac6c5442d0514a0774eec425><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8e998033ac6c5442d0514a0774eec425","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class="line hl"><span class=cl><span class=kr>import</span> <span class=s1>&#39;@dotenvx/dotenvx/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>compression</span> <span class=nx>from</span> <span class=s1>&#39;compression&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>helmet</span> <span class=nx>from</span> <span class=s1>&#39;helmet&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>requestLogger</span> <span class=nx>from</span> <span class=s1>&#39;./middlewares/request-logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we run our application, we should get a helpful message letting us know that our environment file is missing:</p><div class=tab-panel data-tab-group=ecad2f696fdb7bb99f1ce62730be2776><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ecad2f696fdb7bb99f1ce62730be2776","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; LOG_LEVEL=debug nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[MISSING_ENV_FILE] missing .env file (/workspaces/example-project/server/.env)
[MISSING_ENV_FILE] https://github.com/dotenvx/dotenvx/issues/484
[dotenvx@1.34.0] injecting env (0)
[2025-01-25 08:15:56.135 PM] info:      Listening on port 3000</code></pre></div></div></div></div></div><p>This is one of the many benefits that comes from using the newer <code>dotenvx</code> library - it will helpfully remind us when we are running without an environment file, just in case we forgot to create one.</p><p>So, now let&rsquo;s create the <code>.env</code> file in the <code>server</code> folder of our application, and add an environment variable to that file:</p><div class=tab-panel data-tab-group=48ff18392ff7451c3b8bcf9dd96b5fe6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("48ff18392ff7451c3b8bcf9dd96b5fe6","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>error</span></span></code></pre></div></div></div></div></div><p>This should set the logging level of our application to <strong>error</strong>, meaning that only errors will be logged to the terminal. So, let&rsquo;s run our application and see what it does:</p><div class=tab-panel data-tab-group=07ffef3432e521b5af5886abf236e6b4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("07ffef3432e521b5af5886abf236e6b4","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>However, when we do, we notice that we are still getting <strong>http</strong> logging in the output:</p><div class=tab-panel data-tab-group=2a11c54b88c55a243134fc6f87a6dac1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2a11c54b88c55a243134fc6f87a6dac1","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; LOG_LEVEL=debug nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[dotenvx@1.34.0] injecting env (0) from .env
[2025-01-25 08:20:17.438 PM] info:      Listening on port 3000
[2025-01-25 08:23:56.896 PM] http:      GET / 304 3.405 ms -</code></pre></div></div></div></div></div><p>This is because we are already setting the <code>LOG_LEVEL</code> environment variable directly in our <code>package.json</code> file:</p><div class=tab-panel data-tab-group=019add2482955746cb078f59ea5fde70><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("019add2482955746cb078f59ea5fde70","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;module&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=debug nodemon ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>This is actually a great feature! The <code>dotenvx</code> library will not override any existing environment variables - so, if the environment is already configured, or we want to override anything that may be present in our <code>.env</code> file, we can just set it in the environment before running our application, and those values will take precedence!</p><p>For now, let&rsquo;s go ahead and remove that variable from the <code>dev</code> script in our <code>package.json</code> file:</p><div class=tab-panel data-tab-group=4703d298bb1c50963ae4a37cf763cc54><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4703d298bb1c50963ae4a37cf763cc54","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;module&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;nodemon ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Now, when we run our program, we should not see any logging output (unless we can somehow cause the server to raise an error, which is unlikely right now):</p><div class=tab-panel data-tab-group=1d0c2a365427b52bd99ae6673a8f3ea4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1d0c2a365427b52bd99ae6673a8f3ea4","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[dotenvx@1.34.0] injecting env (1) from .env</code></pre></div></div></div></div></div><p>Finally, let&rsquo;s go ahead and set the value in our <code>.env</code> file back to the <code>debug</code> setting:</p><div class=tab-panel data-tab-group=45b3622d87566cce16d824f4e89d8415><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("45b3622d87566cce16d824f4e89d8415","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug</span></span></code></pre></div></div></div></div></div><p>Now, when we run our application, we can see that it is following that configuration:</p><div class=tab-panel data-tab-group=470e40ff15f8ffc954f251adfd66c9fb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("470e40ff15f8ffc954f251adfd66c9fb","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[dotenvx@1.34.0] injecting env (1) from .env
[2025-01-25 08:28:54.587 PM] info:      Listening on port 3000
[2025-01-25 08:28:58.625 PM] http:      GET / 200 3.475 ms - -</code></pre></div></div></div></div></div><p>Great! We now have a powerful way to configure our application using a <code>.env</code> file.</p><h2 id=other-environment-variables>Other Environment Variables</h2><p>Right now, our program only uses one other environment variable, which can be found in the <code>bin/www</code> file:</p><div class=tab-panel data-tab-group=17d01f01839904953e3b712a84eb0aa6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("17d01f01839904953e3b712a84eb0aa6","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=ch>#!/usr/bin/env node
</span></span></span><span class=line><span class=cl><span class=ch></span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s1>&#39;../app.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;../configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get port from environment and store in Express.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kd>var</span> <span class=nx>port</span> <span class=o>=</span> <span class=nx>normalizePort</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>||</span> <span class=s1>&#39;3000&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;port&#39;</span><span class=p>,</span> <span class=nx>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>The code <code>process.env.PORT || '3000'</code> is a commonly used shorthand in JavaScript to check for the presence of a variable. Basically, if <code>process.env.PORT</code> is set, then that code will resolve to that value. If not, then the or operator <code>||</code> will use the second option, which is the value <code>'3000'</code> that is just hard-coded into our application.</p><p>So, we can set that value explicitly in our <code>.env</code> file:</p><div class=tab-panel data-tab-group=909b9afb158ed24a8d7cf382ac5263c7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("909b9afb158ed24a8d7cf382ac5263c7","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span></span></span></code></pre></div></div></div></div></div><p>In general, it is always good practice to explicitly list all configurable values in the <code>.env</code> file when developing an application, since it helps us keep track of them.</p><p>However, each value should also have a <strong>logical default value</strong> if no configuration is provided. Ideally, our application should be able to run correctly with minimal configuration, or it should at least provide clear errors to the user when a configuration value is not provided. For example, we can look back at the <code>level()</code> function in <code>configs/logger.js</code> to see that it will set the logging level to <code>http</code> if it cannot find an appropriate <code>LOG_LEVEL</code> environment variable.</p><h2 id=environment-variable-security>Environment Variable Security</h2><p>Storing the configuration for our application in a <code>.env</code> file is a great option, and it is even included as item 3 of the <a href=https://12factor.net/config rel=external target=_blank>twelve-factor methodology</a> for developing modern web applications.</p><p>Unfortunately, this can present one <strong>major security flaw</strong> - often, the information stored in the <code>.env</code> file is very sensitive, since it may include database passwords, encryption keys, and more. So, we want to make absolutely sure that our <code>.env</code> file is never committed to git or GitHub, and it should never be shared between developers.</p><p>We can enforce this by ensuring that our <code>.gitignore</code> file inside of our <code>server</code> folder includes a line that prevents us from accidentally committing the <code>.env</code> file. Thankfully, both the <code>.gitignore</code> produced by the Express application generator, as well as the one in the GitHub <a href=https://github.com/github/gitignore/blob/main/Node.gitignore rel=external target=_blank>gitignore</a> repository both already include that line.</p><p>Instead, it is common practice to create a second file called <code>.env.example</code> (or similar) that contains a list of all configurable environment variables, along with safe default values for each. So, for this application, we might create a <code>.env.example</code> file that looks like this:</p><div class=tab-panel data-tab-group=71d0aa038551d64e6e5b2e8c9184f52c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=envexample class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("71d0aa038551d64e6e5b2e8c9184f52c","envexample")'>
<span class=tab-nav-text>.env.example</span></button></div><div class=tab-content-container><div data-tab-item=envexample class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>http
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span></span></span></code></pre></div></div></div></div></div><p>This file can safely be committed to git and stored in GitHub. When a new developer or user clones our project, they can easily copy the <code>.env.example</code> file to <code>.env</code> and update it to match their desired configuration.</p><p>As we continue to add environment variables to our <code>.env</code> file, we should also make sure the <code>.env.example</code> file is kept up to date.</p><p>This is a good point to <strong>commit and push</strong> our work, but be extra sure that our <code>.env</code> file <strong>DOES NOT</strong> get committed to git!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=openapi-documentation>OpenAPI Documentation</h1><a href="https://www.youtube.com/watch?v=MW-NA86npRw">YouTube Video</a><h2 id=openapi-documentation>OpenAPI Documentation</h2><p>There are many different ways to document the features of a RESTful web application. One of the most commonly used methods is the <a href=https://www.openapis.org/ rel=external target=_blank>OpenAPI Specification (OAS)</a>. OpenAPI was originally based on the Swagger specification, so we&rsquo;ll sometimes still see references to the name Swagger in online resources.</p><p>At its core, the OpenAPI Specification defines a way to describe the functionality of a RESTful web application in a simple document format, typically structured as a JSON or YAML file. For example, we can find an example YAML file for a <a href=https://github.com/swagger-api/swagger-petstore/blob/master/src/main/resources/openapi.yaml rel=external target=_blank>Petstore API</a> that is commonly cited as an example project for understanding the OpenAPI Specification format.</p><p>That file can then be parsed and rendered as an interactive documentation website for developers and users of the API itself. So, we can find a current version of the <a href=https://petstore3.swagger.io/ rel=external target=_blank>Petstore API Documentation</a> online and compare it to the YAML document to see how it works.</p><p>For more information on the OpenAPI Specification, consult their <a href=https://learn.openapis.org/ rel=external target=_blank>Getting Started</a> page.</p><h2 id=configuration-openapi>Configuration OpenAPI</h2><p>For our project, we are going to take advantage of two helpful libraries to automatically generate and serve OpenAPI documentation for our code using documentation comments:</p><ul><li><a href=https://www.npmjs.com/package/swagger-jsdoc rel=external target=_blank>swagger-jsdoc</a> - generates OpenAPI Specification based on JSDoc comments.</li><li><a href=https://www.npmjs.com/package/swagger-ui-express rel=external target=_blank>swagger-ui-express</a> - serves an OpenAPI Documentation page based on the specification generated by other tools.</li></ul><p>First, let&rsquo;s install both of those libraries into our project:</p><div class=tab-panel data-tab-group=2a0ab20427e592e0aab43947e42980f1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2a0ab20427e592e0aab43947e42980f1","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install swagger-jsdoc swagger-ui-express</span></span></code></pre></div></div></div></div></div><p>Next, we should create a configuration file for the <code>swagger-jsdoc</code> library that contains some basic information about our API. We can store that in the <code>configs/openapi.js</code> file with the following content:</p><div class=tab-panel data-tab-group=cffc1987eed7b7ad815ae8987a073b1e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsopenapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cffc1987eed7b7ad815ae8987a073b1e","configsopenapijs")'>
<span class=tab-nav-text>configs/openapi.js</span></button></div><div class=tab-content-container><div data-tab-item=configsopenapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>swaggerJSDoc</span> <span class=nx>from</span> <span class=s1>&#39;swagger-jsdoc&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>url</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OPENAPI_HOST</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OPENAPI_HOST</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>port</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>||</span> <span class=s1>&#39;3000&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=sb>`http://localhost:</span><span class=si>${</span><span class=nx>port</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>definition</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>openapi</span><span class=o>:</span> <span class=s1>&#39;3.1.0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>info</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>title</span><span class=o>:</span> <span class=s1>&#39;Example Project&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s1>&#39;0.0.1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>description</span><span class=o>:</span> <span class=s1>&#39;Example Project&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>servers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>url</span><span class=o>:</span> <span class=nx>url</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>apis</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;./routes/*.js&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>swaggerJSDoc</span><span class=p>(</span><span class=nx>options</span><span class=p>)</span></span></span></code></pre></div></div></div></div></div><p>Let&rsquo;s look at a few items in this file to see what it does:</p><ul><li><code>url()</code> - this function checks for the <code>OPENAPI_HOST</code> environment variable. If that is set, then it will use that value. Otherwise, it uses a sensible default value of <code>http://localhost:3000</code> or whatever port is set in the environment.</li><li><code>options</code> - the <code>options</code> object is used to configure the <code>swagger-jsdoc</code> library. We can read more about how to configure that library in the <a href=https://www.npmjs.com/package/swagger-jsdoc rel=external target=_blank>documentation</a>. At a minimum, it provides some basic information about the API, as well as the URL where the API is located, and a list of source files to read information from. For now, we only want to read from the routes stored in the <code>routes</code> folder, so we include that path along with a wildcard filename.</li></ul><p>We should also take a minute to add the <code>OPENAPI_HOST</code> environment variable to our <code>.env</code> and <code>.env.example</code> files. If we are running our application locally, we can figure out what this value should be pretty easily (usually it will look similar to <code>http://localhost:3000</code> or similar). However, when we are running in GitHub Codespaces, our URL changes each time. Thankfully, we can find all the information we need in the environment variables provided by GitHub Codespaces (see the previous page for a full list).</p><p>So, the item we need to add to our <code>.env</code> file will look something like this:</p><div class=tab-panel data-tab-group=89c750fd37692af2c745528b9d5de5bc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("89c750fd37692af2c745528b9d5de5bc","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>https://<span class=nv>$CODESPACE_NAME</span>-<span class=nv>$PORT</span>.<span class=nv>$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span></span></span></code></pre></div></div></div></div></div><p>This is one of the key features of the <code>dotenvx</code> library we are using - it will <strong>expand</strong> environment variables based on the existing environment. So, we are using the values stored in the <code>CODESPACE_NAME</code>, <code>PORT</code>, and <code>GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</code> environment variables to construct the appropriate URL for our application.</p><p>In our <code>.env.example</code> file, we might want to make a note of this in a comment, just to be helpful for future developers. Comments in the <code>.env</code> file format are prefixed with hashes <code>#</code>.</p><div class=tab-panel data-tab-group=a3be9c4694967b62b0accbc55c48f21b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=envexample class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a3be9c4694967b62b0accbc55c48f21b","envexample")'>
<span class=tab-nav-text>.env.example</span></button></div><div class=tab-content-container><div data-tab-item=envexample class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>http://localhost:3000
</span></span><span class=line><span class=cl><span class=c1># For GitHub Codespaces</span>
</span></span><span class=line><span class=cl><span class=c1># OPENAPI_HOST=https://$CODESPACE_NAME-$PORT.$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span></span></span></code></pre></div></div></div></div></div><p>Once that configuration is created, we can add it to our <code>app.js</code> file, along with a few lines to actually make the documentation visible:</p><div class=tab-panel data-tab-group=e5ce303686f9da5fd3fc75dce8d2a7e2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e5ce303686f9da5fd3fc75dce8d2a7e2","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=s1>&#39;@dotenvx/dotenvx/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>compression</span> <span class=nx>from</span> <span class=s1>&#39;compression&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>helmet</span> <span class=nx>from</span> <span class=s1>&#39;helmet&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>requestLogger</span> <span class=nx>from</span> <span class=s1>&#39;./middlewares/request-logger.js&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;./configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>openapi</span> <span class=nx>from</span> <span class=s1>&#39;./configs/openapi.js&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>swaggerUi</span> <span class=nx>from</span> <span class=s1>&#39;swagger-ui-express&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/index.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/users.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>helmet</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>compression</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s1>&#39;public&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/users&#39;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OPENAPI_VISIBLE</span> <span class=o>===</span> <span class=s1>&#39;true&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;OpenAPI documentation visible!&#39;</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/docs&#39;</span><span class=p>,</span> <span class=nx>swaggerUi</span><span class=p>.</span><span class=nx>serve</span><span class=p>,</span> <span class=nx>swaggerUi</span><span class=p>.</span><span class=nx>setup</span><span class=p>(</span><span class=nx>openapi</span><span class=p>,</span> <span class=p>{</span><span class=nx>explorer</span><span class=o>:</span> <span class=kc>true</span><span class=p>}));</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>app</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Notice that we are using the <code>OPENAPI_VISIBLE</code> environment variable to control whether the documentation is visible or not, and we print a warning to the terminal if it is enabled. This is because it is often considered very insecure to make the details of our API visible to users unless that is the explicit intent, so it is better to be cautious.</p><p>Of course, to make the documentation appear, we&rsquo;ll have to set the <code>OPENAPI_VISIBLE</code> value to <code>true</code> in our <code>.env</code> file, and also add a default entry to the <code>.env.example</code> file as well:</p><div class=tab-panel data-tab-group=fdb7558767606aa2a9bb44f5539dcd82><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fdb7558767606aa2a9bb44f5539dcd82","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>https://<span class=nv>$CODESPACE_NAME</span>-<span class=nv>$PORT</span>.<span class=nv>$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span>true</span></span></code></pre></div></div></div></div></div><p>Now, let&rsquo;s run our application and see what happens:</p><div class=tab-panel data-tab-group=a7b9a86a8997d9b77eb1c235ae757231><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a7b9a86a8997d9b77eb1c235ae757231","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>We should see the following output when our application initializes:</p><div class=tab-panel data-tab-group=26c164c34775b1a28fe7685cb3fd7bb7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("26c164c34775b1a28fe7685cb3fd7bb7","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[dotenvx@1.34.0] injecting env (4) from .env
[2025-01-25 09:10:37.646 PM] warn:      OpenAPI documentation visible!
[2025-01-25 09:10:37.649 PM] info:      Listening on port 3000</code></pre></div></div></div></div></div><p>Now, let&rsquo;s load our application in a web browser, and go to the <code>/docs</code> path. We should see our OpenAPI Documentation website!</p><p><a href=#R-image-685b4bac475b88a67cef94475d91b516 class=lightbox-link><img alt="OpenAPI Documentation Example" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/openapi_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-685b4bac475b88a67cef94475d91b516><img alt="OpenAPI Documentation Example" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/openapi_1.png></a></p><p>Notice that the <strong>Servers</strong> URL matches the URL at the top of the page! That means our complex <code>OPENAPI_HOST</code> environment variable is working correctly.</p><p>However, we notice that our server does not have any operations defined yet, so we need to add those before we can really make use of this documentation website.</p><h2 id=documenting-routes>Documenting Routes</h2><p>To document our routes using the OpenAPI Specification, we can add a simple JSDoc comment above each route function with some basic information, prefixed by the <code>@swagger</code> tag.</p><div class=tab-panel data-tab-group=347f9d5d692f4e273f8c474397971a65><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesindexjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("347f9d5d692f4e273f8c474397971a65","routesindexjs")'>
<span class=tab-nav-text>routes/index.js</span></button></div><div class=tab-content-container><div data-tab-item=routesindexjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class="line hl"><span class=cl><span class=cm>/**
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @swagger
</span></span></span><span class="line hl"><span class=cl><span class=cm> * tags:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *   name: index
</span></span></span><span class="line hl"><span class=cl><span class=cm> *   description: Index Routes
</span></span></span><span class="line hl"><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=cm>/**
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @swagger
</span></span></span><span class="line hl"><span class=cl><span class=cm> * /:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *   get: 
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     summary: index page
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     description: Gets the index page for the application
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     tags: [index]
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     responses:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *       200: 
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         description: success
</span></span></span><span class="line hl"><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>render</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>title</span><span class=o>:</span> <span class=s1>&#39;Express&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=5f10a8d0debd7e487b2e44552f578b1d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesusersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5f10a8d0debd7e487b2e44552f578b1d","routesusersjs")'>
<span class=tab-nav-text>routes/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesusersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class="line hl"><span class=cl><span class=cm>/**
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @swagger
</span></span></span><span class="line hl"><span class=cl><span class=cm> * tags:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *   name: users
</span></span></span><span class="line hl"><span class=cl><span class=cm> *   description: Users Routes
</span></span></span><span class="line hl"><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=cm>/**
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @swagger
</span></span></span><span class="line hl"><span class=cl><span class=cm> * /users:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *   get: 
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     summary: users list page
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     description: Gets the list of all users in the application
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     responses:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *       200: 
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         description: a resource            
</span></span></span><span class="line hl"><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;respond with a resource&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Now, when we run our application and view the documentation, we see two operations:</p><p><a href=#R-image-739b767a0c33ff1dddeaccec880811b7 class=lightbox-link><img alt="OpenAPI Documentation With Operations" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/openapi_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-739b767a0c33ff1dddeaccec880811b7><img alt="OpenAPI Documentation With Operations" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/openapi_2.png></a></p><p>We can expand the operation to learn more about it, and even test it on a running server if our URL is set correctly:</p><p><a href=#R-image-2e852f18fe8fb4cc65029f04034df2db class=lightbox-link><img alt="OpenAPI Documentation Operation Example" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/openapi_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2e852f18fe8fb4cc65029f04034df2db><img alt="OpenAPI Documentation Operation Example" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/openapi_3.png></a></p><p>As we develop our RESTful API, this documentation tool will be a very powerful way for us to understand our own API&rsquo;s design, and it will help us communicate easily with other developers who wish to use our API as well.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><h2 id=references>References</h2><ul><li><a href=https://dev.to/qbentil/swagger-express-documenting-your-nodejs-rest-api-4lj7 rel=external target=_blank>Swagger & Express: Documenting Your Node.js REST API</a></li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=jsdoc-documentation>JSDoc Documentation</h1><a href="https://www.youtube.com/watch?v=CfiI16ysn-Q">YouTube Video</a><h2 id=jsdoc-documentation>JSDoc Documentation</h2><p>It is also considered good practice to add additional documentation to all of the source files we create for this application. One common standard is <a href=https://jsdoc.app/ rel=external target=_blank>JSDoc</a>, which is somewhat similar to the JavaDoc comments we may have seen in previous courses. JSDoc can be used to generate documentation, but we won&rsquo;t be using that directly in this project. However, we will be loosely following the JSDoc documentation standard to give our code comments some consistency. We can find a full list of the tags in the <a href=https://jsdoc.app/ rel=external target=_blank>JSDoc Documentation</a>.</p><p>For example, we can add a file header to the top of each source file with a few important tags. We may also want to organize our import statements and add notes for each group. We can also document individual functions, such as the <code>normalizePort</code> function in the <code>bin/www</code> file. Here&rsquo;s a fully documented and commented version of that file:</p><div class=tab-panel data-tab-group=badd6ae90e5afc6f9b5dc80a5a9836ca><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("badd6ae90e5afc6f9b5dc80a5a9836ca","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Executable entrypoint for the web application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s1>&#39;../app.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logging configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;../configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get port from environment and store in Express
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>port</span> <span class=o>=</span> <span class=nx>normalizePort</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>||</span> <span class=s1>&#39;3000&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;port&#39;</span><span class=p>,</span> <span class=nx>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create HTTP server
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Listen on provided port, on all network interfaces
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Attach event handlers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>server</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=nx>onError</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>server</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;listening&#39;</span><span class=p>,</span> <span class=nx>onListening</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Normalize a port into a number, string, or false.
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {(string|number)} val - a value representing a port to connect to
</span></span></span><span class=line><span class=cl><span class=cm> * @returns {(number|string|boolean)} the port or `false`
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>normalizePort</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>port</span> <span class=o>=</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nx>val</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>isNaN</span><span class=p>(</span><span class=nx>port</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// named pipe
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>port</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// port number
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Event listener for HTTP server &#34;error&#34; event.
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {error} error - the HTTP error event
</span></span></span><span class=line><span class=cl><span class=cm> * @throws error if the error cannot be determined
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>onError</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>syscall</span> <span class=o>!==</span> <span class=s1>&#39;listen&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=nx>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>bind</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>port</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=s1>&#39;Pipe &#39;</span> <span class=o>+</span> <span class=nx>port</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=s1>&#39;Port &#39;</span> <span class=o>+</span> <span class=nx>port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// handle specific listen errors with friendly messages
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>switch</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>code</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s1>&#39;EACCES&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=nx>bind</span> <span class=o>+</span> <span class=s1>&#39; requires elevated privileges&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s1>&#39;EADDRINUSE&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=nx>bind</span> <span class=o>+</span> <span class=s1>&#39; is already in use&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=nx>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Event listener for HTTP server &#34;listening&#34; event.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>onListening</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>addr</span> <span class=o>=</span> <span class=nx>server</span><span class=p>.</span><span class=nx>address</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>bind</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>addr</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=s1>&#39;pipe &#39;</span> <span class=o>+</span> <span class=nx>addr</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=s1>&#39;port &#39;</span> <span class=o>+</span> <span class=nx>addr</span><span class=p>.</span><span class=nx>port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>logger</span><span class=p>.</span><span class=nx>info</span><span class=p>(</span><span class=s1>&#39;Listening on &#39;</span> <span class=o>+</span> <span class=nx>bind</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Here is another example of a cleaned up, reorganized, and documented version of the <code>app.js</code> file. Notice that it also includes an <code>@export</code> tag at the top to denote the type of object that is exported from this file.</p><div class=tab-panel data-tab-group=071cac591242a36a4c015d6519e7541b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("071cac591242a36a4c015d6519e7541b","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Main Express application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports app Express application
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load environment (must be first)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s1>&#39;@dotenvx/dotenvx/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>compression</span> <span class=nx>from</span> <span class=s1>&#39;compression&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>helmet</span> <span class=nx>from</span> <span class=s1>&#39;helmet&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>swaggerUi</span> <span class=nx>from</span> <span class=s1>&#39;swagger-ui-express&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;./configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>openapi</span> <span class=nx>from</span> <span class=s1>&#39;./configs/openapi.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import middlewares
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>requestLogger</span> <span class=nx>from</span> <span class=s1>&#39;./middlewares/request-logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/index.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/users.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>helmet</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>compression</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span> 
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use middlewares
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use static files
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s1>&#39;public&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/users&#39;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use SwaggerJSDoc router if enabled
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OPENAPI_VISIBLE</span> <span class=o>===</span> <span class=s1>&#39;true&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;OpenAPI documentation visible!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/docs&#39;</span><span class=p>,</span> <span class=nx>swaggerUi</span><span class=p>.</span><span class=nx>serve</span><span class=p>,</span> <span class=nx>swaggerUi</span><span class=p>.</span><span class=nx>setup</span><span class=p>(</span><span class=nx>openapi</span><span class=p>,</span> <span class=p>{</span><span class=nx>explorer</span><span class=o>:</span> <span class=kc>true</span><span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>app</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Finally, here is a fully documented <code>routes/index.js</code> file, showing how routes can be documented both with JSDoc tags as well as OpenAPI Specification items:</p><div class=tab-panel data-tab-group=26735df7d26cda7a82ddc60eb9cecd97><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesindexjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("26735df7d26cda7a82ddc60eb9cecd97","routesindexjs")'>
<span class=tab-nav-text>routes/index.js</span></button></div><div class=tab-content-container><div data-tab-item=routesindexjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Index router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: index
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Index Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the index page for the application
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /:
</span></span></span><span class=line><span class=cl><span class=cm> *   get: 
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: index page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the index page for the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [index]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200: 
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>render</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>title</span><span class=o>:</span> <span class=s1>&#39;Express&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Now is a great time to document all of the JavaScript files in our application following the <a href=https://jsdoc.app/ rel=external target=_blank>JSDoc</a> standard.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=linting--formatting>Linting & Formatting</h1><a href="https://www.youtube.com/watch?v=1AIUiGW2FNs">YouTube Video</a><h2 id=linting>Linting</h2><p>Finally, let&rsquo;s look at two other tools that will help us write clean and maintainable JavaScript code. The first tool is <a href=https://www.npmjs.com/package/eslint rel=external target=_blank>eslint</a>, which is a <a href=https://en.wikipedia.org/wiki/Lint_(software) rel=external target=_blank>linting</a> tool to find bugs and issues in JavaScript code by performing some static analysis on it. This helps us avoid any major issues in our code that can be easily detected just by looking at the overall style and structure of our code.</p><p>To begin, we can install <code>eslint</code> following the recommended process in their documentation:</p><div class=tab-panel data-tab-group=7237ec2915dd8a25e5a1a921752c4c8e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7237ec2915dd8a25e5a1a921752c4c8e","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm init @eslint/config@latest</span></span></code></pre></div></div></div></div></div><p>It will install the package and ask several configuration questions along the way. We can follow along with the answers shown in the output below:</p><div class=tab-panel data-tab-group=47f09ee4bf9d24493167030adbdec112><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("47f09ee4bf9d24493167030adbdec112","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>Need to install the following packages:
@eslint/create-config@1.4.0
Ok to proceed? (y) y

@eslint/create-config: v1.4.0

‚úî How would you like to use ESLint? ¬∑ problems
‚úî What type of modules does your project use? ¬∑ esm
‚úî Which framework does your project use? ¬∑ none
‚úî Does your project use TypeScript? ¬∑ javascript
‚úî Where does your code run? ¬∑ node
The config that you&#39;ve selected requires the following dependencies:

eslint, globals, @eslint/js
‚úî Would you like to install them now? ¬∑ No / Yes
‚úî Which package manager do you want to use? ¬∑ npm
‚òïÔ∏èInstalling...

added 70 packages, and audited 273 packages in 5s

52 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities
Successfully created /workspaces/example-project/server/eslint.config.js file.</code></pre></div></div></div></div></div><p>Once it is installed, we can run <code>eslint</code> using the following command:</p><div class=tab-panel data-tab-group=cabf04e1ac042c0ed304a002fd69ce65><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cabf04e1ac042c0ed304a002fd69ce65","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npx eslint --fix .</span></span></code></pre></div></div></div></div></div><p>When we do, we&rsquo;ll probably get a couple of errors:</p><div class=tab-panel data-tab-group=15b7abe7bed6f00d651ef49e41aa860e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("15b7abe7bed6f00d651ef49e41aa860e","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>/workspaces/example-project/server/routes/index.js
  35:36  error  &#39;next&#39; is defined but never used  no-unused-vars

/workspaces/example-project/server/routes/users.js
  35:36  error  &#39;next&#39; is defined but never used  no-unused-vars

‚úñ 2 problems (2 errors, 0 warnings)</code></pre></div></div></div></div></div><p>In both of our routes files, we have included the <code>next</code> parameter, but it is unused. We could remove it, but it is often considered good practice to include that parameter in case we need to explicitly use it. So, in our <code>eslint.config.js</code> we can add an option to ignore that parameter (pay careful attention to the formatting; for some reason the file by default does not have much spacing between the curly braces):</p><div class=tab-panel data-tab-group=fbd4ad7404f2d3c1f37a33ea53ef8136><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=eslintconfigjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fbd4ad7404f2d3c1f37a33ea53ef8136","eslintconfigjs")'>
<span class=tab-nav-text>eslint.config.js</span></button></div><div class=tab-content-container><div data-tab-item=eslintconfigjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>globals</span> <span class=nx>from</span> <span class=s2>&#34;globals&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>pluginJs</span> <span class=nx>from</span> <span class=s2>&#34;@eslint/js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** @type {import(&#39;eslint&#39;).Linter.Config[]} */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>languageOptions</span><span class=o>:</span> <span class=p>{</span> <span class=nx>globals</span><span class=o>:</span> <span class=nx>globals</span><span class=p>.</span><span class=nx>node</span> <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>rules</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=s1>&#39;no-unused-vars&#39;</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class="line hl"><span class=cl>        <span class=s1>&#39;error&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>argsIgnorePattern</span><span class=o>:</span> <span class=s1>&#39;next&#39;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>]</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>pluginJs</span><span class=p>.</span><span class=nx>configs</span><span class=p>.</span><span class=nx>recommended</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>];</span></span></span></code></pre></div></div></div></div></div><p>Now, when we run that command, we should not get any output!</p><div class=tab-panel data-tab-group=26a434649b1006c09d0b6f69f0a97754><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("26a434649b1006c09d0b6f69f0a97754","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npx eslint --fix .</span></span></code></pre></div></div></div></div></div><p>To make this even easier, let&rsquo;s add a new script to the <code>scripts</code> section of our <code>package.json</code> file for this tool:</p><div class=tab-panel data-tab-group=c6d8bf5bce138b9d4e3a9e19992c94a2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c6d8bf5bce138b9d4e3a9e19992c94a2","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=debug nodemon ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;lint&#34;</span><span class=p>:</span> <span class=s2>&#34;npx eslint --fix .&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Now we can just run this command to check our project for errors:</p><div class=tab-panel data-tab-group=1ad8427f05f74ed065baf6a8c9337fbd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1ad8427f05f74ed065baf6a8c9337fbd","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run lint</span></span></code></pre></div></div></div></div></div><h2 id=formatting>Formatting</h2><p>Another commonly used tool for JavaScript developers is <a href=https://www.npmjs.com/package/prettier rel=external target=_blank>prettier</a>. Prettier will reformat our JavaScript code to match a defined coding style, making it much easier to read and maintain.</p><p>First, let&rsquo;s install <code>prettier</code> using <code>npm</code> as a development dependency:</p><div class=tab-panel data-tab-group=1f2956692cc71a7bacdd64cbbb7228b8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1f2956692cc71a7bacdd64cbbb7228b8","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install prettier --save-dev</span></span></code></pre></div></div></div></div></div><p>We also need to create a <code>.prettierrc</code> configuration file that just contains an empty JavaScript object for now:</p><div class=tab-panel data-tab-group=ab8147f4887412dd09ee5748b5235c02><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=prettierrc class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ab8147f4887412dd09ee5748b5235c02","prettierrc")'>
<span class=tab-nav-text>.prettierrc</span></button></div><div class=tab-content-container><div data-tab-item=prettierrc class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=p>{}</span></span></span></code></pre></div></div></div></div></div><p>There are many options that can be placed in that configuration file - see the <a href=https://prettier.io/docs/en/options rel=external target=_blank>Prettier Documentation</a> for details. For now, we&rsquo;ll just leave it blank.</p><p>We can now run the <code>prettier</code> command on our code:</p><div class=tab-panel data-tab-group=68047de036462876808c43f713ed8b0d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("68047de036462876808c43f713ed8b0d","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npx prettier . --write</span></span></code></pre></div></div></div></div></div><p>When we do, we&rsquo;ll see output listing all of the files that have been changed:</p><div class=tab-panel data-tab-group=a15f3c2405ec64f7d1b70144838e6756><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a15f3c2405ec64f7d1b70144838e6756","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>.prettierrc 34ms
app.js 34ms
configs/logger.js 19ms
configs/openapi.js 7ms
eslint.config.js 5ms
middlewares/request-logger.js 5ms
package-lock.json 111ms (unchanged)
package.json 2ms (unchanged)
public/index.html 29ms
routes/index.js 4ms
routes/users.js 3ms</code></pre></div></div></div></div></div><p>Notice that nearly all of the files have been updated in some way. Many times it simply aligns code and removes extra spaces, but other times it will rewrite long lines.</p><p>Just like with <code>eslint</code>, let&rsquo;s add a new script to <code>package.json</code> to make this process simpler as well:</p><div class=tab-panel data-tab-group=816043b9430c14d36de41b0149b33a69><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("816043b9430c14d36de41b0149b33a69","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=debug nodemon ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;lint&#34;</span><span class=p>:</span> <span class=s2>&#34;npx eslint --fix .&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;format&#34;</span><span class=p>:</span> <span class=s2>&#34;npx prettier . --write&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>With that script in place, we can clean up our code anytime using this command:</p><div class=tab-panel data-tab-group=c07ae665ac3b1dbb034d2104d77293bf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c07ae665ac3b1dbb034d2104d77293bf","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run format</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Best Practice</div><div class=box-content><p>Now that we have installed both <code>eslint</code> and <code>prettier</code>, it is always a good practice to run both tools before committing any code to git and pushing to GitHub. This ensures that your codebase is always clean, well formatted, and free of errors or bugs that could be easily spotted by these tools.</p></div></div><p>This is a good point to <strong>commit and push</strong> our work!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><a href="https://www.youtube.com/watch?v=1WhAMeX0Seo">YouTube Video</a><h2 id=summary>Summary</h2><p>In this example project, we created an Express application with the following features:</p><ol><li>GitHub Codespaces</li><li>A sample Express application</li><li>Updated to ES Modules</li><li>Application logs with Winston and Morgan</li><li>Other useful libraries such as Compression and Helmet</li><li>A better development server using Nodemon</li><li>Environment variables through Dotenvx</li><li>Code documentation with JSDoc and OpenAPI comments</li><li>Linting and Formatting with ESLint and Prettier</li></ol><p>This example project makes a great basis for building robust RESTful web APIs and other Express applications.</p><p>As you work on projects built from this framework, we welcome any feedback or additions to be made. Feel free to submit requests to the course instructor for updates to this project.</p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=adding-a-database>Adding a Database</h1><p>This example project builds on the previous Express Starter Project by adding a database. A database is a powerful way to store and retrieve the data used by our web application.</p><p>To accomplish this, we&rsquo;ll learn about different libraries that interface between our application and a database. Once we&rsquo;ve installed a library, we&rsquo;ll discover how to use that library to create database tables, add initial data to those tables, and then easily access them within our application.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li>An SQLite database</li><li>The Sequelize ORM tool</li><li>The Umzug migration tool</li><li>A simple migration to create tables for Users and Roles</li><li>Seed data for those tables</li><li>Automated processes to migrate and seed the data on application startup</li><li>A simple route to query user information</li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Adding a Database</h1><article class=default><header class=headline></header><h1 id=sequelize>Sequelize</h1><a href="https://www.youtube.com/watch?v=RN46EzaMHy0">YouTube Video</a><h2 id=database-libraries>Database Libraries</h2><p>To begin, we must first select a library to use when interfacing with our database. There are many different types of libraries, and many different options to choose from.</p><ol><li><p>First and foremost, we can always just write raw SQL queries directly in our code. This is often very straightforward, but also can lead to very complex code and security issues. It also doesn&rsquo;t offer many of the more advanced features such as mapping database results to object types and automatically managing database schemas.</p></li><li><p>Another option is an SQL query library, such as <a href=https://knexjs.org/ rel=external target=_blank>Knex.js</a> or <a href=https://kysely.dev/ rel=external target=_blank>Kysely</a>. These libraries provide a helpful abstraction on top of SQL, allowing developers to build queries using syntax that is more comfortable and familiar to them. These libraries also have additional features to manage database schemas and sample data</p></li><li><p>The final option is an <a href=https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping rel=external target=_blank>Object-Relational Mapping (ORM)</a> library such as <a href=https://vincit.github.io/objection.js/ rel=external target=_blank>Objection</a> or <a href=https://sequelize.org/ rel=external target=_blank>Sequelize</a>. These libraries provide the most abstraction away from raw SQL, often allowing developers to store and retrieve data in a database as if it were stored in a list or dictionary data structure.</p></li></ol><p>For this project, we&rsquo;re going to use the <a href=https://sequelize.org/ rel=external target=_blank>Sequelize</a> ORM, coupled with the <a href=https://github.com/sequelize/umzug rel=external target=_blank>Umzug</a> migration tool. Both of these libraries are very commonly used in Node.js projects, and are actively maintained.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Database Engines</div><div class=box-content><p>We also have many choices for the database engine we want to use for our web projects. Some common options include <a href=https://www.postgresql.org/ rel=external target=_blank>PostgreSQL</a>, <a href=https://www.mysql.com/ rel=external target=_blank>MySQL</a>, <a href=https://mariadb.org/ rel=external target=_blank>MariaDB</a>, <a href=https://www.mongodb.com/ rel=external target=_blank>MongoDB</a>, <a href=https://firebase.google.com/ rel=external target=_blank>Firebase</a>, and many more.</p><p>For this project, we&rsquo;re going to use <a href=https://www.sqlite.org/ rel=external target=_blank>SQLite</a>. SQLite is unique because it is a database engine that only requires a single file, so it is self-contained and easy to work with. It doesn&rsquo;t require any external database servers or software, making it perfect for a small development project. In fact, SQLite may be one of the most <a href=https://www.sqlite.org/mostdeployed.html rel=external target=_blank>widely deployed software modules</a> in the whole world!</p><p>Naturally, if wer plan on growing a web application beyond a simple hobby project with a few users, we should spend some time researching a reliable database solution. Thankfully, the Sequelize ORM supports <a href=https://sequelize.org/docs/v6/other-topics/dialect-specific-things/ rel=external target=_blank>many different database engines</a> so it is easy to switch.</p></div></div><h2 id=installing-sequelize>Installing Sequelize</h2><p>To begin, let&rsquo;s install both <code>sequelize</code> as well as the <code>sqlite3</code> library using <code>npm</code>:</p><div class=tab-panel data-tab-group=239e31f9913b9ae7da17669592069ae3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("239e31f9913b9ae7da17669592069ae3","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install sqlite3 sequelize</span></span></code></pre></div></div></div></div></div><p>Once those libraries are installed, we can now configure <code>sequelize</code> following the information in the <a href=https://sequelize.org/docs/v6/getting-started/ rel=external target=_blank>Sequelize Documentation</a>. Let&rsquo;s create a new file <code>configs/database.js</code> to store our database configuration:</p><div class=tab-panel data-tab-group=d4c9c44b097b742edf97b92c2b07a93d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsdatabasejs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d4c9c44b097b742edf97b92c2b07a93d","configsdatabasejs")'>
<span class=tab-nav-text>configs/database.js</span></button></div><div class=tab-content-container><div data-tab-item=configsdatabasejs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Sequelize database ORM
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports sequelize a Sequelize instance
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Sequelize</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Sequelize instance
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>sequelize</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Sequelize</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>dialect</span><span class=o>:</span> <span class=s1>&#39;sqlite&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>storage</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DATABASE_FILE</span> <span class=o>||</span> <span class=s2>&#34;:memory:&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>logging</span><span class=o>:</span> <span class=nx>logger</span><span class=p>.</span><span class=nx>sql</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=nx>logger</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>sequelize</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This file creates a very simple configuration for <code>sequelize</code> that uses the <code>sqlite</code> dialect. It uses the <code>DATABASE_FILE</code> environment variable to control the location of the database in the file system, and it also uses the <code>logger.sql</code> log level to log any data produced by the library. If a <code>DATABASE_FILE</code> environment variable is not provided, it will default to storing data in the SQLite <a href=https://www.sqlite.org/inmemorydb.html rel=external target=_blank>In-Memory Database</a>, which is great for testing and quick development.</p><p>Of course, a couple of those items don&rsquo;t actually exist yet, so let&rsquo;s add those in before we move on! First, we need to add a <code>DATABASE_FILE</code> environment variable to both our <code>.env</code> and <code>.env.example</code> files:</p><div class=tab-panel data-tab-group=f994eb0dbf9020d2efec5506f2ba42de><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f994eb0dbf9020d2efec5506f2ba42de","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>https://<span class=nv>$CODESPACE_NAME</span>-<span class=nv>$PORT</span>.<span class=nv>$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class="line hl"><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>database.sqlite</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=96440b844cd53acb4308aeff8c2836e2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=envexample class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("96440b844cd53acb4308aeff8c2836e2","envexample")'>
<span class=tab-nav-text>.env.example</span></button></div><div class=tab-content-container><div data-tab-item=envexample class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>http://localhost:3000
</span></span><span class=line><span class=cl><span class=c1># For GitHub Codespaces</span>
</span></span><span class=line><span class=cl><span class=c1># OPENAPI_HOST=https://$CODESPACE_NAME-$PORT.$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class="line hl"><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>database.sqlite</span></span></code></pre></div></div></div></div></div><p>We also need to add a new logging level called <code>sql</code> to our logger configuration in <code>configs/logger.js</code>. This is a bit more involved, because it means we have to now list all intended logging levels explicitly. See the highlighted lines below for what has been changed, but the entire file is included for convenience:</p><div class=tab-panel data-tab-group=1a05a63e0c95ee3e3ec8fb27694609d0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsloggerjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1a05a63e0c95ee3e3ec8fb27694609d0","configsloggerjs")'>
<span class=tab-nav-text>configs/logger.js</span></button></div><div class=tab-content-container><div data-tab-item=configsloggerjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Winston logger
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports logger a Winston logger object
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>winston</span> <span class=nx>from</span> <span class=s2>&#34;winston&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Extract format options
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=p>{</span> <span class=nx>combine</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=nx>printf</span><span class=p>,</span> <span class=nx>colorize</span><span class=p>,</span> <span class=nx>align</span><span class=p>,</span> <span class=nx>errors</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>format</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Determines the correct logging level based on the Node environment
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @returns {string} the desired log level
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>level</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;0&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;error&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;error&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;1&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;warn&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;warn&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;2&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;info&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;info&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;3&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;http&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;4&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;verbose&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;verbose&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;5&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;debug&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;debug&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;6&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;sql&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=k>return</span> <span class=s1>&#39;sql&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;7&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;silly&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=k>return</span> <span class=s1>&#39;silly&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Custom logging levels for the application
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>levels</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>error</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>warn</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>info</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>http</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>verbose</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>debug</span><span class=o>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>sql</span><span class=o>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>silly</span><span class=o>:</span> <span class=mi>7</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Custom colors
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>colors</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;red&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>warn</span><span class=o>:</span> <span class=s1>&#39;yellow&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>info</span><span class=o>:</span> <span class=s1>&#39;green&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>http</span><span class=o>:</span> <span class=s1>&#39;green&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>verbose</span><span class=o>:</span> <span class=s1>&#39;cyan&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>debug</span><span class=o>:</span> <span class=s1>&#39;blue&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>sql</span><span class=o>:</span> <span class=s1>&#39;gray&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>silly</span><span class=o>:</span> <span class=s1>&#39;magenta&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=nx>winston</span><span class=p>.</span><span class=nx>addColors</span><span class=p>(</span><span class=nx>colors</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Creates the Winston instance with the desired configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>logger</span> <span class=o>=</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>createLogger</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// call `level` function to get default log level
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>level</span><span class=o>:</span> <span class=nx>level</span><span class=p>(),</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>levels</span><span class=o>:</span> <span class=nx>levels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Format configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// See https://github.com/winstonjs/logform
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>format</span><span class=o>:</span> <span class=nx>combine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>colorize</span><span class=p>({</span> <span class=nx>all</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>errors</span><span class=p>({</span> <span class=nx>stack</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>timestamp</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;YYYY-MM-DD hh:mm:ss.SSS A&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>align</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>printf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nx>info</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>        <span class=sb>`[</span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>timestamp</span><span class=si>}</span><span class=sb>] </span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>level</span><span class=si>}</span><span class=sb>: </span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>stack</span> <span class=o>?</span> <span class=nx>info</span><span class=p>.</span><span class=nx>message</span> <span class=o>+</span> <span class=s2>&#34;\n&#34;</span> <span class=o>+</span> <span class=nx>info</span><span class=p>.</span><span class=nx>stack</span> <span class=o>:</span> <span class=nx>info</span><span class=p>.</span><span class=nx>message</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Output configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>transports</span><span class=o>:</span> <span class=p>[</span><span class=k>new</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>transports</span><span class=p>.</span><span class=nx>Console</span><span class=p>()],</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>logger</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>We have added a new <code>sql</code> logging level that is now part of our logging setup. One of the unique features of <code>sequelize</code> is that it will actually allow us to log all SQL queries run against our database, so we can enable and disable that level of logging by adjusting the <code>LOG_LEVEL</code> environment variable as desired.</p><p>There! We now have a working database configuration. Before we can make use of it, however, we need to add additional code to create and populate our database. So, we&rsquo;ll need to continue on in this tutorial before we can actually test our application.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=migrations>Migrations</h1><a href="https://www.youtube.com/watch?v=P-0Iuaj_BAE">YouTube Video</a><h2 id=umzug>Umzug</h2><p>Now that we have a database configured in our application, we need to create some way to actually populate that database with the tables and information our app requires. We could obviously do that manually, but that really makes it difficult (if not impossible) to automatically build, test, and deploy this application.</p><p>Thankfully, most database libraries also have a way to automate building the database structure. This is known as <a href=https://en.wikipedia.org/wiki/Schema_migration rel=external target=_blank>schema migration</a> or often just <strong>migration</strong>. We call it migration because it allows us to update the database schema along with new versions of the application, effectively <em>migrating</em> our data to new versions as we go.</p><p>The <code>sequelize</code> library recommends using another library, named <a href=https://github.com/sequelize/umzug rel=external target=_blank>Umzug</a>, as the preferred way to manage database migrations. It is actually completely framework agnostic, and would even work with ORMs other than Sequelize.</p><h2 id=setting-up-umzug>Setting up Umzug</h2><p>To begin, let&rsquo;s install <code>umzug</code> using <code>npm</code>:</p><div class=tab-panel data-tab-group=ef2d239e98fdf8a5f47b099b46fc93ec><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ef2d239e98fdf8a5f47b099b46fc93ec","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install umzug</span></span></code></pre></div></div></div></div></div><p>Next, we can create a configuration file to handle our migrations, named <code>configs/migrations.js</code>, with the following content as described in the <a href=https://github.com/sequelize/umzug rel=external target=_blank>Umzug Documentation</a>:</p><div class=tab-panel data-tab-group=85e4d9a17d1bff51e461814eb8a05c5f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsmigrationsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("85e4d9a17d1bff51e461814eb8a05c5f","configsmigrationsjs")'>
<span class=tab-nav-text>configs/migrations.js</span></button></div><div class=tab-content-container><div data-tab-item=configsmigrationsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Umzug migration engine
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports umzug an Umzug instance
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Umzug</span><span class=p>,</span> <span class=nx>SequelizeStorage</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;umzug&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import database configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;./database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Umzug instance
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>umzug</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Umzug</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>migrations</span><span class=o>:</span> <span class=p>{</span><span class=nx>glob</span><span class=o>:</span> <span class=s1>&#39;migrations/*.js&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span><span class=o>:</span> <span class=nx>database</span><span class=p>.</span><span class=nx>getQueryInterface</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>storage</span><span class=o>:</span> <span class=k>new</span> <span class=nx>SequelizeStorage</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>sequelize</span><span class=o>:</span> <span class=nx>database</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>modelName</span><span class=o>:</span> <span class=s1>&#39;migrations&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=o>:</span> <span class=nx>logger</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>umzug</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Notice that this configuration uses our existing <code>sequelize</code> database configuration, and also uses an instance of our <code>logger</code> as well. It is set to look for any migrations stored in the <code>migrations/</code> folder.</p><p>The <code>umzug</code> library also has a very handy way to run migrations directly from the terminal using a simple JavaScript file, so let&rsquo;s create a new file named <code>migrate.js</code> in the root of the <code>server</code> directory as well with this content:</p><div class=tab-panel data-tab-group=85d90e110c9008b54f771aded4284be8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=migratejs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("85d90e110c9008b54f771aded4284be8","migratejs")'>
<span class=tab-nav-text>migrate.js</span></button></div><div class=tab-content-container><div data-tab-item=migratejs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Load environment (must be first)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;@dotenvx/dotenvx/config&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>migrations</span> <span class=nx>from</span> <span class=s1>&#39;./configs/migrations.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Run Umzug as CLI application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>migrations</span><span class=p>.</span><span class=nx>runAsCLI</span><span class=p>();</span></span></span></code></pre></div></div></div></div></div><p>This file will simply load our environment configuration as well as the <code>umzug</code> instance for migrations, and then instruct it to run as a command-line interface (CLI) application. This is very handy, as we&rsquo;ll see shortly.</p><h2 id=creating-a-migration>Creating a Migration</h2><p>Now we can create a new migration to actually start building our database structure for our application. For this simple example, we&rsquo;ll build a <code>users</code> table with four fields:</p><p><a href=#R-image-9a8c5280326d4421c566d2e4b5066c90 class=lightbox-link><img alt="Users ERD" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/migration_users.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9a8c5280326d4421c566d2e4b5066c90><img alt="Users ERD" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/migration_users.png></a></p><p>We can refer to both the <a href=https://github.com/sequelize/umzug rel=external target=_blank>Umzug Documentation</a> and <a href=https://github.com/sequelize/umzug/tree/main/examples/1-sequelize-typescript rel=external target=_blank>Examples</a> as well as the <a href=https://sequelize.org/docs/v6/other-topics/migrations/ rel=external target=_blank>Sequelize Documentation</a>. So, let&rsquo;s create a new folder named <code>migrations</code> to match our configuration above, then a new file named <code>00_users.js</code> to hold the migration for our <code>users</code> table:</p><div class=tab-panel data-tab-group=9ed007549152a54fad91b565c87fb763><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=migrations00_usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9ed007549152a54fad91b565c87fb763","migrations00_usersjs")'>
<span class=tab-nav-text>migrations/00_users.js</span></button></div><div class=tab-content-container><div data-tab-item=migrations00_usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users table migration
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports up the Up migration
</span></span></span><span class=line><span class=cl><span class=cm> * @exports down the Down migration
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span><span class=nx>Sequelize</span><span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Apply the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>createTable</span><span class=p>(</span><span class=s1>&#39;users&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>autoIncrement</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>STRING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>unique</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Roll back the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>down</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>dropTable</span><span class=p>(</span><span class=s1>&#39;users&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>A migration consists of two functions. First, the <code>up</code> function is called when the migration is applied, and it should define or modify the database structure as desired. In this case, since this is the first migration, we can assume we are starting with a blank database and go from there. The other function, <code>down</code>, is called whenever we want to undo, or <em>rollback</em>, the migration. It should effectively undo any changes made by the <code>up</code> function, leaving the database in the state it was before the migration was applied.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Sequential File Names</div><div class=box-content><p>Most migration systems, including <code>umzug</code>, apply the migrations in order according to the filenames of the migrations. Some systems automatically append a timestamp to the name of the migration file when it is created, such as <code>20250203112345_users.js</code>. For our application, we will simply number them sequentially, starting with <code>00</code>.</p></div></div><p>Finally, we can use the <code>migrate.js</code> file we created to run <code>umzug</code> from the command line to apply the migration:</p><div class=tab-panel data-tab-group=151f35ee837442db1a094cd25df3eb7c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("151f35ee837442db1a094cd25df3eb7c","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node migrate up</span></span></code></pre></div></div></div></div></div><p>If everything works correctly, we should receive some output showing that our migration succeeded:</p><div class=tab-panel data-tab-group=05ce5a5c77db395cbf8b956fd9b0cd47><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("05ce5a5c77db395cbf8b956fd9b0cd47","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[dotenvx@1.34.0] injecting env (5) from .env
[2025-02-03 10:59:35.066 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }
[2025-02-03 10:59:35.080 PM] info:      { event: &#39;migrated&#39;, name: &#39;00_users.js&#39;, durationSeconds: 0.014 }
[2025-02-03 10:59:35.080 PM] info:      applied 1 migrations.</code></pre></div></div></div></div></div><p>We should also see a file named <code>database.sqlite</code> added to our file structure. If desired, we can install the <a href="https://marketplace.visualstudio.com/items?itemName=qwtel.sqlite-viewer" rel=external target=_blank>SQLite Viewer</a> extension in VS Code to explore the contents of that file to confirm it is working correctly.</p><p><a href=#R-image-7953800e4e0bf45fb3787bc22523ec98 class=lightbox-link><img alt="Users Table in SQLite" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/migrations_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7953800e4e0bf45fb3787bc22523ec98><img alt="Users Table in SQLite" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/migrations_3.png></a></p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Add Extension to Dev Container</div><div class=box-content><p>When installing a VS Code extension, we can also choose to have it added directly to our <code>devcontainer.json</code> file so it is available automatically whenever we close this repository into a new codespace or dev container. Just click the gear icon on the marketplace page and choose &ldquo;Add to devcontainer.json&rdquo; from the menu!</p><p><a href=#R-image-854a3ca0ba4aaed10a2548e168a62530 class=lightbox-link><img alt="Add to Dev Container" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/migrations_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-854a3ca0ba4aaed10a2548e168a62530><img alt="Add to Dev Container" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/migrations_2.png></a></p></div></div><p>If we need to roll back that migration, we can use a similar command:</p><div class=tab-panel data-tab-group=d6ba59dade59e7c66bfac1bd2853d624><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d6ba59dade59e7c66bfac1bd2853d624","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node migrate down</span></span></code></pre></div></div></div></div></div><p>There are many more commands available to apply migrations individually and more. Check the <a href="https://github.com/sequelize/umzug/?tab=readme-ov-file#cli" rel=external target=_blank>Umzug Documentation</a> for more details.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=seeds>Seeds</h1><a href="https://www.youtube.com/watch?v=UZTSyvzFjAw">YouTube Video</a><h2 id=database-seeding>Database Seeding</h2><p>Another useful task that <code>umzug</code> can handle is adding some initial data to a new database. This process is known as <em>seeding</em> the database. Thankfully, the process for seeding is nearly identical to the process for migrations - in fact, it uses the same operations in different ways! So, let&rsquo;s explore how to set that up.</p><p>First, we&rsquo;ll create a new configuration file at <code>configs/seeds.js</code> that contains nearly the same content as <code>configs/migrations.js</code> with a couple of important changes on the highlighted lines:</p><div class=tab-panel data-tab-group=578071cbbc1785b0b5fecd721f623886><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsseedsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("578071cbbc1785b0b5fecd721f623886","configsseedsjs")'>
<span class=tab-nav-text>configs/seeds.js</span></button></div><div class=tab-content-container><div data-tab-item=configsseedsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Umzug seed engine
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports umzug an Umzug instance
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Umzug</span><span class=p>,</span> <span class=nx>SequelizeStorage</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;umzug&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import database configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;./database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Umzug instance
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>umzug</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Umzug</span><span class=p>({</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>migrations</span><span class=o>:</span> <span class=p>{</span><span class=nx>glob</span><span class=o>:</span> <span class=s1>&#39;seeds/*.js&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span><span class=o>:</span> <span class=nx>database</span><span class=p>.</span><span class=nx>getQueryInterface</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>storage</span><span class=o>:</span> <span class=k>new</span> <span class=nx>SequelizeStorage</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>sequelize</span><span class=o>:</span> <span class=nx>database</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>modelName</span><span class=o>:</span> <span class=s1>&#39;seeds&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=o>:</span> <span class=nx>logger</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>umzug</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>All we really have to do is change the folder where the migrations (in this case, the seeds) are stored, and we also change the name of the model, or table, where that information will be kept in the database.</p><p>Next, we&rsquo;ll create a <code>seed.js</code> file that allows us to run the seeds from the command line. Again, this file is nearly identical to the <code>migrate.js</code> file from earlier, with a couple of simple changes:</p><div class=tab-panel data-tab-group=ae2bde9cab9b0d215b31416a149f400d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=seedjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ae2bde9cab9b0d215b31416a149f400d","seedjs")'>
<span class=tab-nav-text>seed.js</span></button></div><div class=tab-content-container><div data-tab-item=seedjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Load environment (must be first)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;@dotenvx/dotenvx/config&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>seeds</span> <span class=nx>from</span> <span class=s1>&#39;./configs/seeds.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Run Umzug as CLI application
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>seeds</span><span class=p>.</span><span class=nx>runAsCLI</span><span class=p>();</span></span></span></code></pre></div></div></div></div></div><p>Finally, we can create a new folder <code>seeds</code> to store our seeds, and then create the first seed also called <code>00_users.js</code> to add a few default users to our database:</p><div class=tab-panel data-tab-group=7f681e9346cfad9d7c4ad00b7072a84f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=seeds00_usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7f681e9346cfad9d7c4ad00b7072a84f","seeds00_usersjs")'>
<span class=tab-nav-text>seeds/00_users.js</span></button></div><div class=tab-content-container><div data-tab-item=seeds00_usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users seed
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports up the Up migration
</span></span></span><span class=line><span class=cl><span class=cm> * @exports down the Down migration
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Timestamp in the appropriate format for the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>now</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>().</span><span class=nx>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>23</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=s2>&#34;T&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34; +00:00&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Array of objects to add to the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=s1>&#39;admin&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=s1>&#39;contributor&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=s1>&#39;manager&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=s1>&#39;user&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Apply the seed
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=s1>&#39;users&#39;</span><span class=p>,</span> <span class=nx>users</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Roll back the seed
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>down</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkDelete</span><span class=p>(</span><span class=s2>&#34;users&#34;</span><span class=p>,</span> <span class=p>{},</span> <span class=p>{</span> <span class=nx>truncate</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>This seed will add 4 users to the database. Notice that we are setting both the <code>createdAt</code> and <code>updatedAt</code> fields manually - while the <code>sequelize</code> library will manage those for us in certain situations, we must handle them manually when doing a bulk insert directly to the database.</p><p>At this point we can insert our seeds into the database using the command line interface:</p><div class=tab-panel data-tab-group=c1d911576ec293cc9c93057ac5acab32><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c1d911576ec293cc9c93057ac5acab32","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node seed up</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=acf4c766e52b7d7cbd232ce47c79468a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("acf4c766e52b7d7cbd232ce47c79468a","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[dotenvx@1.34.0] injecting env (5) from .env
[2025-02-04 02:47:20.702 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }
[2025-02-04 02:47:20.716 PM] info:      { event: &#39;migrated&#39;, name: &#39;00_users.js&#39;, durationSeconds: 0.013 }
[2025-02-04 02:47:20.716 PM] info:      applied 1 migrations.</code></pre></div></div></div></div></div><p>Now, once we&rsquo;ve done that, we can go back to the <a href="https://marketplace.visualstudio.com/items?itemName=qwtel.sqlite-viewer" rel=external target=_blank>SQLite Viewer</a> extension in VS Code to confirm that our data was properly inserted into the database.</p><p><a href=#R-image-ad5c433bedf3119f1a9e63076130294b class=lightbox-link><img alt="Seeded Data" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/seed_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ad5c433bedf3119f1a9e63076130294b><img alt="Seeded Data" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/seed_1.png></a></p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Migrate Before Seeding</div><div class=box-content><p>One common mistake that is very easy to do is to try and seed the database without first migrating it.</p><div class=tab-panel data-tab-group=7079e485109617ae791cff47ee29d992><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7079e485109617ae791cff47ee29d992","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[2025-02-04 02:51:39.452 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }

Error: Migration 00_users.js (up) failed: Original error: SQLITE_ERROR: no such table: users</code></pre></div></div></div></div></div><p>Thankfully <code>umzug</code> gives a pretty helpful error in this case.</p><p>Another common error is to forget to roll back seeds before rolling back and resetting any migrations. In that case, when you try to apply your seeds again, they will not be applied since the database thinks the data is still present. So, remember to roll back your seeds <em>before</em> rolling back any migrations!</p></div></div><p>We&rsquo;re almost ready to test our app! The last step is to create a model for our data, which we&rsquo;ll cover on the next page.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=models>Models</h1><a href="https://www.youtube.com/watch?v=c4iNYRhqxTs">YouTube Video</a><h2 id=database-models>Database Models</h2><p>Now that we have our database table structure and sample data set up, we can finally configure <code>sequelize</code> to query our database by defining a <a href=https://sequelize.org/docs/v6/core-concepts/model-basics/ rel=external target=_blank>model</a> representing that data. At its core, a model is simply an abstraction that represents the structure of the data in a table of our database. We can equate this to a <code>class</code> in object-oriented programming - each row or <em>record</em> in our database can be thought of as an <em>instance</em> of our model class. You can learn more about models in the <a href=https://sequelize.org/docs/v6/core-concepts/model-basics/ rel=external target=_blank>Sequelize Documentation</a></p><p>To create a model, let&rsquo;s first create a <code>models</code> folder in our app, then we can create a file <code>user.js</code> that contains the schema for the <code>User</code> model, based on the <code>users</code> table.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Singular vs. Plural</div><div class=box-content><p>By convention, model names are usually singular like &ldquo;user&rdquo; while table names are typically pluralized like &ldquo;users.&rdquo; This is not a rule that must be followed, but many web frameworks use this convention so we&rsquo;ll also follow it.</p></div></div><p>The <code>User</code> model schema should look very similar to the table definition used in the migration created earlier in this example:</p><div class=tab-panel data-tab-group=c5eaff333adc1507cb4084328af878ab><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsuserjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c5eaff333adc1507cb4084328af878ab","modelsuserjs")'>
<span class=tab-nav-text>models/user.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsuserjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file User schema
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports UserSchema the schema for the User model
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Sequelize</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>UserSchema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>autoIncrement</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>STRING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>unique</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>UserSchema</span></span></span></code></pre></div></div></div></div></div><p>At a minimum, a model schema defines the attributes that are stored in the database, but there are many more features that can be added over time, such as additional computed fields (for example, a <code>fullName</code> field that concatenates the <code>giveName</code> and <code>familyName</code> fields stored in the database). We&rsquo;ll explore ways to improve our models in later examples.</p><p>Once we have the model schema created, we&rsquo;ll create a second file named <code>models.js</code> that will pull together all of our schemas and actually build the <code>sequelize</code> models that can be used throughout our application.</p><div class=tab-panel data-tab-group=86d5399128145d73322d0e9209883cff><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsmodelsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("86d5399128145d73322d0e9209883cff","modelsmodelsjs")'>
<span class=tab-nav-text>models/models.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsmodelsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Database models
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports User a Sequelize User model
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import database connection
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;../configs/database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Schemas
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>UserSchema</span> <span class=nx>from</span> <span class=s1>&#39;./user.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create User Model
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>User</span> <span class=o>=</span> <span class=nx>database</span><span class=p>.</span><span class=nx>define</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Model Name
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s1>&#39;User&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Schema
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>UserSchema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Other options
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>tableName</span><span class=o>:</span> <span class=s1>&#39;users&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>User</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>It is also important to note that we can define the name of the table that stores instances of the model in the <code>tableName</code> option.</p><p>We will see why it is important to use this <code>models.js</code> file (instead of just defining the model itself and not just the schema in the <code>users.js</code> file) once we start adding relations between the models. For now, we&rsquo;ll start with this simple scaffold that we can expand upon in the future.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Models vs. Migrations</div><div class=box-content><p>One of the more interesting features of <code>sequelize</code> is that it can use just the models themselves to define the structure of the tables in the database. It has features such as <a href=https://sequelize.org/docs/v6/core-concepts/model-basics/#model-synchronization rel=external target=_blank>Model Synchronization</a> to keep the database structure updated to match the given models.</p><p>However, even in the documentation, <code>sequelize</code> recommends using migrations for more complex database structures. So, in our application, the migrations will represent the incremental steps required over time to construct our application&rsquo;s database tables, whereas the models will represent the full structure of the database tables at this point in time. As we add new features to our application, this difference will become more apparent.</p></div></div><h2 id=model-querying>Model Querying</h2><p>Finally, we are at the point where we can actually use our database in our application! So, let&rsquo;s update the route for the <code>users</code> endpoint to actually return a list of the users of our application in a JSON format:</p><div class=tab-panel data-tab-group=784abb11b7263619a20c46c5eb355f3a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesusersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("784abb11b7263619a20c46c5eb355f3a","routesusersjs")'>
<span class=tab-nav-text>routes/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesusersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: users
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Users Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import models
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;../models/models.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of users
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /users:
</span></span></span><span class=line><span class=cl><span class=cm> *   get: 
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: users list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all users in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200: 
</span></span></span><span class=line><span class=cl><span class=cm> *         description: a resource         
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findAll</span><span class=p>();</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>The only change we need to make is to import our <code>User</code> model we just created in the <code>models/models.js</code> file, and then use the <code>User.findAll()</code> query method inside of our first route method. A full list of all the querying functions in <code>sequelize</code> can be found in the <a href=https://sequelize.org/docs/v6/core-concepts/model-querying-basics/ rel=external target=_blank>Sequelize Documentation</a></p><p>Now, let&rsquo;s start our application and see if it works! We should make sure we have migrated and seeded the database recently before starting. If everything works correctly, we should be able to navigate to the <code>/users</code> path and see the following JSON output on the page:</p><div class=tab-panel data-tab-group=7c8e1c5b1ae22f7afe71dd351c5f8f93><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=route-users class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7c8e1c5b1ae22f7afe71dd351c5f8f93","route-users")'>
<span class=tab-nav-text>route: /users</span></button></div><div class=tab-content-container><div data-tab-item=route-users class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;createdAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;updatedAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;contributor&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;createdAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;updatedAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;manager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;createdAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;updatedAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;createdAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;updatedAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div></div></div></div></div><p>Awesome! We have now developed a basic web application that is able to query a database and present data to the user in a JSON format. This is the first big step toward actually building a RESTful API application.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Committing Database Files</div><div class=box-content><p>One thing we might notice is that our <code>database.sqlite</code> file is in the list of files to be committed to our GitHub repository for this project. In many cases, you may or may not want to do this, depending on what type of data you are storing in the database and how you are using it.</p><p>For this application, and the projects in this course, we&rsquo;ll go ahead and commit our database to GitHub since that is the simplest way to share that information.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=documenting-models>Documenting Models</h1><a href="https://www.youtube.com/watch?v=ebVJ4R08ZZM">YouTube Video</a><h2 id=documenting-models-with-open-api>Documenting Models with Open API</h2><p>Before we move ahead, let&rsquo;s quickly take a minute to add some documentation to our models using the Open API specification. The details can be found in the <a href=https://swagger.io/specification/ rel=external target=_blank>Open API Specification Document</a></p><p>First, let&rsquo;s update our configuration in the <code>configs/openapi.js</code> file to include the <code>models</code> directory:</p><div class=tab-panel data-tab-group=c51d471684a3844bb9aea983568bfdcb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsopenapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c51d471684a3844bb9aea983568bfdcb","configsopenapijs")'>
<span class=tab-nav-text>configs/openapi.js</span></button></div><div class=tab-content-container><div data-tab-item=configsopenapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Configure SwaggerJSDoc options
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>definition</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>openapi</span><span class=o>:</span> <span class=s2>&#34;3.1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>info</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>title</span><span class=o>:</span> <span class=s2>&#34;Example Project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>description</span><span class=o>:</span> <span class=s2>&#34;Example Project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>servers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>url</span><span class=o>:</span> <span class=nx>url</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>apis</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;./routes/*.js&#34;</span><span class=p>,</span> <span class=s2>&#34;./models/*.js&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Next, at the top of our <code>models/user.js</code> file, we can add information in an <code>@swagger</code> tag about our newly created <code>User</code> model, usually placed right above the model definition itself:</p><div class=tab-panel data-tab-group=ed1c1f5b12ce2c06566548fb39f35d8a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsuserjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ed1c1f5b12ce2c06566548fb39f35d8a","modelsuserjs")'>
<span class=tab-nav-text>models/user.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsuserjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   schemas:
</span></span></span><span class=line><span class=cl><span class=cm> *     User:
</span></span></span><span class=line><span class=cl><span class=cm> *       type: object
</span></span></span><span class=line><span class=cl><span class=cm> *       required:
</span></span></span><span class=line><span class=cl><span class=cm> *         - username
</span></span></span><span class=line><span class=cl><span class=cm> *       properties:
</span></span></span><span class=line><span class=cl><span class=cm> *         id:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *           description: autogenerated id
</span></span></span><span class=line><span class=cl><span class=cm> *         username:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           description: username for the user
</span></span></span><span class=line><span class=cl><span class=cm> *         createdAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was created
</span></span></span><span class=line><span class=cl><span class=cm> *         updatedAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was last updated
</span></span></span><span class=line><span class=cl><span class=cm> *       example:
</span></span></span><span class=line><span class=cl><span class=cm> *           id: 1
</span></span></span><span class=line><span class=cl><span class=cm> *           username: admin
</span></span></span><span class=line><span class=cl><span class=cm> *           createdAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class=line><span class=cl><span class=cm> *           updatedAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>UserSchema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Finally, we can now update our route in the <code>routes/users.js</code> file to show that it is outputting an array of <code>User</code> objects:</p><div class=tab-panel data-tab-group=16ff22ccf6ff99e91ea956ede3c519d1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesusersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("16ff22ccf6ff99e91ea956ede3c519d1","routesusersjs")'>
<span class=tab-nav-text>routes/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesusersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of users
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /users:
</span></span></span><span class=line><span class=cl><span class=cm> *   get: 
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: users list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all users in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     responses:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *       200:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         description: the list of users
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         content:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *           application/json:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *             schema:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *               type: array
</span></span></span><span class="line hl"><span class=cl><span class=cm> *               items:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *                 $ref: &#39;#/components/schemas/User&#39;       
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findAll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>With all of that in place, we can start our application with the Open API documentation enabled, then navigate to the <code>/docs</code> route to see our updated documentation. We should now see our <code>User</code> model listed as a schema at the bottom of the page:</p><p><a href=#R-image-48810da93151a0a1f5e73d4f624077c1 class=lightbox-link><img alt="User Schema" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/documenting_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-48810da93151a0a1f5e73d4f624077c1><img alt="User Schema" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/documenting_1.png></a></p><p>In addition, we can see that the <code>/users</code> route has also been updated to show that it returns an array of <code>User</code> objects, along with the relevant data:</p><p><a href=#R-image-fb6ff8711de72f9edb837a43dc06bd9d class=lightbox-link><img alt="User Route Documentation" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/documenting_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fb6ff8711de72f9edb837a43dc06bd9d><img alt="User Route Documentation" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/documenting_2.png></a></p><p>As we continue to add models and routes to our application, we should also make sure our Open API documentation is kept up to date with the latest information.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=automation>Automation</h1><a href="https://www.youtube.com/watch?v=LMQZ6OXpzGU">YouTube Video</a><h2 id=automating-database-deployment>Automating Database Deployment</h2><p>One very helpful feature we can add to our application is the ability to automatically migrate and seed the database when the application first starts. This can be especially helpful when deploying this application in a container.</p><p>To do this, let&rsquo;s add some additional code to our <code>bin/www</code> file that is executed when our project starts:</p><div class=tab-panel data-tab-group=46f631a8c36233c18ebe3237a1378591><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("46f631a8c36233c18ebe3237a1378591","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Executable entrypoint for the web application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s1>&#39;../app.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s1>&#39;../configs/database.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;../configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>migrations</span> <span class=nx>from</span> <span class=s1>&#39;../configs/migrations.js&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>seeds</span> <span class=nx>from</span> <span class=s1>&#39;../configs/seeds.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get port from environment and store in Express.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>port</span> <span class=o>=</span> <span class=nx>normalizePort</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>||</span> <span class=s1>&#39;3000&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;port&#39;</span><span class=p>,</span> <span class=nx>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create HTTP server.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Attach event handlers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>server</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=nx>onError</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>server</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;listening&#39;</span><span class=p>,</span> <span class=nx>onListening</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Call startup function
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>startup</span><span class=p>();</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=cm>/**
</span></span></span><span class="line hl"><span class=cl><span class=cm> * Server startup function
</span></span></span><span class="line hl"><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kd>function</span> <span class=nx>startup</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Test database connection
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=nx>database</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Database connection successful&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Run migrations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>migrations</span><span class=p>.</span><span class=nx>up</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Database migrations complete&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SEED_DATA</span> <span class=o>===</span> <span class=s1>&#39;true&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=s2>&#34;Database data seeding is enabled!&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>seeds</span><span class=p>.</span><span class=nx>up</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>            <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Database seeding complete&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>            <span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>port</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>          <span class=c1>// Listen on provided port, on all network interfaces.
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>          <span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>port</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>){</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>We now have a new <code>startup</code> function that will first test the database connection, then run the migrations, and finally it will seed the database if the <code>SEED_DATA</code> environment variable is set to <code>true</code>. Once all that is done, it will start the application by calling <code>server.listen</code> using the port.</p><p>Notice that this code uses the <code>then()</code> function to resolve promises instead of the <code>async</code> and <code>await</code> keywords. This is because it is running at the top level, and cannot include any <code>await</code> keywords.</p><p>To enable this, let&rsquo;s add the <code>SEED_DATA</code> environment variable to both <code>.env</code> and <code>.env.example</code>:</p><div class=tab-panel data-tab-group=b02d79b52ec21d8a9c6bd62fd7e24ce3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b02d79b52ec21d8a9c6bd62fd7e24ce3","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>https://<span class=nv>$CODESPACE_NAME</span>-<span class=nv>$PORT</span>.<span class=nv>$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>database.sqlite
</span></span><span class="line hl"><span class=cl><span class=nv>SEED_DATA</span><span class=o>=</span>true</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=8b9059ab66403104c048ed2ab01fa3cd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=envexample class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8b9059ab66403104c048ed2ab01fa3cd","envexample")'>
<span class=tab-nav-text>.env.example</span></button></div><div class=tab-content-container><div data-tab-item=envexample class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>http://localhost:3000
</span></span><span class=line><span class=cl><span class=c1># For GitHub Codespaces</span>
</span></span><span class=line><span class=cl><span class=c1># OPENAPI_HOST=https://$CODESPACE_NAME-$PORT.$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>database.sqlite
</span></span><span class="line hl"><span class=cl><span class=nv>SEED_DATA</span><span class=o>=</span>false</span></span></code></pre></div></div></div></div></div><p>To test this, we can delete the <code>database.sqlite</code> file in our repository, then start our project:</p><div class=tab-panel data-tab-group=86aee873c198a093921f378ae8db29f0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("86aee873c198a093921f378ae8db29f0","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>If it works correctly, we should see that our application is able to connect to the database, migrate the schema, and add the seed data, before fully starting:</p><div class=tab-panel data-tab-group=70b0b9c4620acf87ec7a83992b6675ba><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("70b0b9c4620acf87ec7a83992b6675ba","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight hl_lines=11-23><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[dotenvx@1.34.0] injecting env (6) from .env
[2025-02-04 06:56:11.823 PM] warn:      OpenAPI documentation visible!
[2025-02-04 06:56:12.163 PM] debug:     Database connection successful
[2025-02-04 06:56:12.208 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }
[2025-02-04 06:56:12.265 PM] info:      { event: &#39;migrated&#39;, name: &#39;00_users.js&#39;, durationSeconds: 0.058 }
[2025-02-04 06:56:12.266 PM] debug:     Database migrations complete
[2025-02-04 06:56:12.266 PM] warn:      Database data seeding is enabled!
[2025-02-04 06:56:12.296 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }
[2025-02-04 06:56:12.321 PM] info:      { event: &#39;migrated&#39;, name: &#39;00_users.js&#39;, durationSeconds: 0.024 }
[2025-02-04 06:56:12.321 PM] debug:     Database seeding complete
[2025-02-04 06:56:12.323 PM] info:      Listening on port 3000</code></pre></div></div></div></div></div><p>There we go! Our application will now always make sure the database is properly migrated, and optionally seeded, before it starts. Now, when another developer or user starts our application, it will be sure to have a working database.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=another-table>Another Table</h1><a href="https://www.youtube.com/watch?v=MWRW1LgN7gI">YouTube Video</a><h2 id=adding-another-table>Adding Another Table</h2><p>Now that we have a working database, let&rsquo;s explore what it takes to add a new table to our application to represent additional models and data in our database.</p><p>We&rsquo;ve already created a <code>users</code> table, which contains information about the users of our application. Now we want to add a <code>roles</code> table to contain all of the possible roles that our users can hold. In addition, we need some way to associate a user with a number of roles. Each user can have multiple roles, and each role can be assigned to multiple users. This is known as a <strong>many to many</strong> database relation, and requires an additional <strong>junction table</strong> to implement it properly. The end goal is to create the database schema represented in this diagram:</p><p><a href=#R-image-a29be5cd4012e9ca8efb443e6273d62c class=lightbox-link><img alt="User Roles Database Diagram" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/user_roles.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a29be5cd4012e9ca8efb443e6273d62c><img alt="User Roles Database Diagram" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/user_roles.png></a></p><p>To do this, we&rsquo;ll go through three steps:</p><ol><li>Create a migration to modify the database schema</li><li>Create a model for each table</li><li>Add additional seed data for these tables</li></ol><h2 id=migration>Migration</h2><p>First, we need to create a new migration to modify the database schema to include the two new tables. So, we&rsquo;ll create a file named <code>01_roles.js</code> in the <code>migrations</code> folder and add content to it to represent the two new tables we need to create:</p><div class=tab-panel data-tab-group=71737c65171d452c49b93bec80923a65><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=migrations01_rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("71737c65171d452c49b93bec80923a65","migrations01_rolesjs")'>
<span class=tab-nav-text>migrations/01_roles.js</span></button></div><div class=tab-content-container><div data-tab-item=migrations01_rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Roles table migration
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports up the Up migration
</span></span></span><span class=line><span class=cl><span class=cm> * @exports down the Down migration
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span><span class=nx>Sequelize</span><span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Apply the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>createTable</span><span class=p>(</span><span class=s1>&#39;roles&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>autoIncrement</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>STRING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>createTable</span><span class=p>(</span><span class=s1>&#39;user_roles&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>references</span><span class=o>:</span> <span class=p>{</span> <span class=nx>model</span><span class=o>:</span> <span class=s1>&#39;users&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;id&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>onDelete</span><span class=o>:</span> <span class=s2>&#34;cascade&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>references</span><span class=o>:</span> <span class=p>{</span> <span class=nx>model</span><span class=o>:</span> <span class=s1>&#39;roles&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;id&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>onDelete</span><span class=o>:</span> <span class=s2>&#34;cascade&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Roll back the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>down</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>dropTable</span><span class=p>(</span><span class=s1>&#39;user_roles&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>dropTable</span><span class=p>(</span><span class=s1>&#39;roles&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>In this migration, we are creating two tables. The first, named <code>roles</code>, stores the list of roles in the application. The second, named <code>user_roles</code>, is the junction table used for the many-to-many relationship between the <code>users</code> and <code>roles</code> table. Notice that we have to add the tables in the correct order, and also in the <code>down</code> method we have to remove them in reverse order. Finally, it is important to include the <code>onDelete: "cascade"</code> option for each of our reference fields in the <code>user_roles</code> table, as that will handle deleting associated entries in the junction table when a user or role is deleted.</p><p>The <code>user_roles</code> table also includes a great example for adding a foreign key reference between two tables. More information can be found in the <a href=https://sequelize.org/docs/v6/core-concepts/assocs/ rel=external target=_blank>Sequelize Documentation</a>.</p><h2 id=models>Models</h2><p>Next, we need to create two models to represent these tables. The first is the <code>role</code> model schema, stored in <code>models/role.js</code> with the following content:</p><div class=tab-panel data-tab-group=8a6243f87f3eb72a0ca372782fa4d0b8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsrolejs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8a6243f87f3eb72a0ca372782fa4d0b8","modelsrolejs")'>
<span class=tab-nav-text>models/role.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsrolejs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Role model
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports RoleSchema the schema for the Role model
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Sequelize</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   schemas:
</span></span></span><span class=line><span class=cl><span class=cm> *     Role:
</span></span></span><span class=line><span class=cl><span class=cm> *       type: object
</span></span></span><span class=line><span class=cl><span class=cm> *       required:
</span></span></span><span class=line><span class=cl><span class=cm> *         - role
</span></span></span><span class=line><span class=cl><span class=cm> *       properties:
</span></span></span><span class=line><span class=cl><span class=cm> *         id:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *           description: autogenerated id
</span></span></span><span class=line><span class=cl><span class=cm> *         role:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           description: name of the role
</span></span></span><span class=line><span class=cl><span class=cm> *         createdAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was created
</span></span></span><span class=line><span class=cl><span class=cm> *         updatedAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was last updated
</span></span></span><span class=line><span class=cl><span class=cm> *       example:
</span></span></span><span class=line><span class=cl><span class=cm> *           id: 1
</span></span></span><span class=line><span class=cl><span class=cm> *           role: manage_users
</span></span></span><span class=line><span class=cl><span class=cm> *           createdAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class=line><span class=cl><span class=cm> *           updatedAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>RoleSchema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>autoIncrement</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>role</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>STRING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>RoleSchema</span></span></span></code></pre></div></div></div></div></div><p>Notice that this file is very similar to the <code>models/user.js</code> file created earlier, with a few careful changes made to match the table schema.</p><p>We also need to create a model schema for the <code>user_roles</code> table, which we will store in the <code>models/user_role.js</code> file with the following content:</p><div class=tab-panel data-tab-group=02cf9ddf939b671938efceec86d74b7e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsuser_rolejs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("02cf9ddf939b671938efceec86d74b7e","modelsuser_rolejs")'>
<span class=tab-nav-text>models/user_role.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsuser_rolejs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file User role junction model
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports RoleSchema the schema for the UserRole model
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Sequelize</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>UserRoleSchema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>userId</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>references</span><span class=o>:</span> <span class=p>{</span> <span class=nx>model</span><span class=o>:</span> <span class=s1>&#39;User&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;id&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>onDelete</span><span class=o>:</span> <span class=s2>&#34;cascade&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>roleId</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>references</span><span class=o>:</span> <span class=p>{</span> <span class=nx>model</span><span class=o>:</span> <span class=s1>&#39;Role&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;id&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>onDelete</span><span class=o>:</span> <span class=s2>&#34;cascade&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>UserRoleSchema</span></span></span></code></pre></div></div></div></div></div><p>Finally, we can now update our <code>models/models.js</code> file to create the <code>Role</code> and <code>UserRole</code> models, and also to define the associations between them and the <code>User</code> model.</p><div class=tab-panel data-tab-group=73928967938bb35e779e26a53c6f3163><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsmodelsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("73928967938bb35e779e26a53c6f3163","modelsmodelsjs")'>
<span class=tab-nav-text>models/models.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsmodelsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Database models
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports User a Sequelize User model
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @exports Role a Sequelize Role model
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @exports UserRole a Sequelize UserRole model
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import database connection
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;../configs/database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Schemas
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>UserSchema</span> <span class=nx>from</span> <span class=s1>&#39;./user.js&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>RoleSchema</span> <span class=nx>from</span> <span class=s2>&#34;./role.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>UserRoleSchema</span> <span class=nx>from</span> <span class=s2>&#34;./user_role.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create User Model
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>User</span> <span class=o>=</span> <span class=nx>database</span><span class=p>.</span><span class=nx>define</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Model Name
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s1>&#39;User&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Schema
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>UserSchema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Other options
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>tableName</span><span class=o>:</span> <span class=s1>&#39;users&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Create Role Model
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>Role</span> <span class=o>=</span> <span class=nx>database</span><span class=p>.</span><span class=nx>define</span><span class=p>(</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Model Name
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=s1>&#39;Role&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Schema
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=nx>RoleSchema</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Other options
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>tableName</span><span class=o>:</span> <span class=s1>&#39;roles&#39;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Create UserRole Model
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>UserRole</span> <span class=o>=</span> <span class=nx>database</span><span class=p>.</span><span class=nx>define</span><span class=p>(</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Model Name
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=s1>&#39;UserRole&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Schema
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=nx>UserRoleSchema</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Other options
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>tableName</span><span class=o>:</span> <span class=s1>&#39;user_roles&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>timestamps</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>underscored</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Define Associations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>Role</span><span class=p>.</span><span class=nx>belongsToMany</span><span class=p>(</span><span class=nx>User</span><span class=p>,</span> <span class=p>{</span> <span class=nx>through</span><span class=o>:</span> <span class=nx>UserRole</span><span class=p>,</span> <span class=nx>unique</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;users&#34;</span> <span class=p>})</span>
</span></span><span class="line hl"><span class=cl><span class=nx>User</span><span class=p>.</span><span class=nx>belongsToMany</span><span class=p>(</span><span class=nx>Role</span><span class=p>,</span> <span class=p>{</span> <span class=nx>through</span><span class=o>:</span> <span class=nx>UserRole</span><span class=p>,</span> <span class=nx>unique</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>User</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>Role</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>UserRole</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Notice that this file contains two lines at the bottom to define the associations included as part of this table, so that <code>sequelize</code> will know how to handle it. This will instruct <code>sequelize</code> to add additional attributes and features to the <code>User</code> and <code>Role</code> models for querying the related data, as we&rsquo;ll see shortly.</p><p>We also added the line <code>timestamps: false</code> to the other options for the <code>User_roles</code> table to disable the creation and management of timestamps (the <code>createdAt</code> and <code>updatedAt</code> attributes), since they may not be needed for this relation.</p><p>Finally, we added the <code>underscored: true</code> line to tell <code>sequelize</code> that it should interpret the <code>userId</code> and <code>roleId</code> attributes (written in camel case as preferred by Sequelize) as <code>user_id</code> and <code>role_id</code>, respectively (written in snake case as we did in the migration).</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Camel Case vs. Snake Case</div><div class=box-content><p>The choice of either CamelCase or snake_case naming for database attributes is a matter of preference. In this example, we show both methods, and it is up to each developer to select their own preferred style.</p></div></div><h2 id=seed>Seed</h2><p>Finally, let&rsquo;s create a new seed file in <code>seeds/01_roles.js</code> to add some default data to the <code>roles</code> and <code>user_roles</code> tables:</p><div class=tab-panel data-tab-group=c25ebb339a42b9a32e89c8b4bb0ce7a4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=seeds01_rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c25ebb339a42b9a32e89c8b4bb0ce7a4","seeds01_rolesjs")'>
<span class=tab-nav-text>seeds/01_roles.js</span></button></div><div class=tab-content-container><div data-tab-item=seeds01_rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Roles seed
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports up the Up migration
</span></span></span><span class=line><span class=cl><span class=cm> * @exports down the Down migration
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Timestamp in the appropriate format for the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>now</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>().</span><span class=nx>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>23</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=s2>&#34;T&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34; +00:00&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Array of objects to add to the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;manage_users&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;manage_documents&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;add_documents&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;manage_communities&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;add_communities&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;view_documents&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;view_communities&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>user_roles</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Apply the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=s1>&#39;roles&#39;</span><span class=p>,</span> <span class=nx>roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=s1>&#39;user_roles&#39;</span><span class=p>,</span> <span class=nx>user_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Roll back the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>down</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkDelete</span><span class=p>(</span><span class=s1>&#39;user_roles&#39;</span><span class=p>,</span> <span class=p>{}</span> <span class=p>,</span> <span class=p>{</span> <span class=nx>truncate</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkDelete</span><span class=p>(</span><span class=s2>&#34;roles&#34;</span><span class=p>,</span> <span class=p>{},</span> <span class=p>{</span> <span class=nx>truncate</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Once again, this seed is very similar to what we&rsquo;ve seen before. Notice that we use the <code>truncate</code> option to remove all entries in the <code>user_roles</code> table when we undo this seed as well as the <code>roles</code> table.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Seeding from a CSV File</div><div class=box-content><p>It is also possible to seed the database from a CSV or other data file using a bit of JavaScript code. Here&rsquo;s an example for seeding a table that contains all of the counties in Kansas using a CSV file with that data that is read with the <a href=https://www.npmjs.com/package/convert-csv-to-json rel=external target=_blank>convert-csv-to-json</a> library:</p><div class=tab-panel data-tab-group=e9aacccfa39c456f154fba94e123cff5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=seeds02_countiesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e9aacccfa39c456f154fba94e123cff5","seeds02_countiesjs")'>
<span class=tab-nav-text>seeds/02_counties.js</span></button></div><div class=tab-content-container><div data-tab-item=seeds02_countiesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>csvToJson</span> <span class=o>=</span> <span class=kr>import</span><span class=p>(</span><span class=s2>&#34;convert-csv-to-json&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Timestamp in the appropriate format for the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>now</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>().</span><span class=nx>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>23</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=s2>&#34;T&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34; +00:00&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span> <span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Read data from CSV file
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// id,name,code,seat,population,est_year
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 1,Allen,AL,Iola,&#34;12,464&#34;,1855
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>counties</span> <span class=o>=</span> <span class=p>(</span><span class=kr>await</span> <span class=nx>csvToJson</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>formatValueByType</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>supportQuotedField</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>fieldDelimiter</span><span class=p>(</span><span class=s2>&#34;,&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>getJsonFromCsv</span><span class=p>(</span><span class=s2>&#34;./seeds/counties.csv&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// append timestamps and parse fields
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>counties</span><span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>c</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// handle parsing numbers with comma separators
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>c</span><span class=p>.</span><span class=nx>population</span> <span class=o>=</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>population</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/,/g</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nx>createdAt</span> <span class=o>=</span> <span class=nx>now</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nx>updatedAt</span> <span class=o>=</span> <span class=nx>now</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// insert into database
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=s2>&#34;counties&#34;</span><span class=p>,</span> <span class=nx>counties</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>down</span><span class=p>({</span> <span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkDelete</span><span class=p>(</span><span class=s2>&#34;counties&#34;</span><span class=p>,</span> <span class=p>{},</span> <span class=p>{</span> <span class=nx>truncate</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div></div></div><h2 id=update-user-model>Update User Model</h2><p>Finally, let&rsquo;s update the <code>User</code> model schema to include related roles. At this point, we just have to update the Open API documentation to match:</p><div class=tab-panel data-tab-group=0ee84558b6b32c91aea51fc06b97678e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsuserjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0ee84558b6b32c91aea51fc06b97678e","modelsuserjs")'>
<span class=tab-nav-text>models/user.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsuserjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   schemas:
</span></span></span><span class=line><span class=cl><span class=cm> *     User:
</span></span></span><span class=line><span class=cl><span class=cm> *       type: object
</span></span></span><span class=line><span class=cl><span class=cm> *       required:
</span></span></span><span class=line><span class=cl><span class=cm> *         - username
</span></span></span><span class=line><span class=cl><span class=cm> *       properties:
</span></span></span><span class=line><span class=cl><span class=cm> *         id:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *           description: autogenerated id
</span></span></span><span class=line><span class=cl><span class=cm> *         username:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           description: username for the user
</span></span></span><span class=line><span class=cl><span class=cm> *         createdAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was created
</span></span></span><span class=line><span class=cl><span class=cm> *         updatedAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was last updated
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         roles:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *           type: array
</span></span></span><span class="line hl"><span class=cl><span class=cm> *           items:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *             $ref: &#39;#/components/schemas/Role&#39;
</span></span></span><span class=line><span class=cl><span class=cm> *       example:
</span></span></span><span class=line><span class=cl><span class=cm> *           id: 1
</span></span></span><span class=line><span class=cl><span class=cm> *           username: admin
</span></span></span><span class=line><span class=cl><span class=cm> *           createdAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class=line><span class=cl><span class=cm> *           updatedAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class="line hl"><span class=cl><span class=cm> *           roles:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *             - id: 1
</span></span></span><span class="line hl"><span class=cl><span class=cm> *               role: manage_users
</span></span></span><span class="line hl"><span class=cl><span class=cm> *             - id: 2
</span></span></span><span class="line hl"><span class=cl><span class=cm> *               role: manage_documents
</span></span></span><span class="line hl"><span class=cl><span class=cm> *             - id: 4
</span></span></span><span class="line hl"><span class=cl><span class=cm> *               role: manage_communities
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now we can modify our route in <code>routes/users.js</code> to include the data from the related <code>Role</code> model in our query:</p><div class=tab-panel data-tab-group=49ca734fbbdbb73d527103693f3ef7fa><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesusersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("49ca734fbbdbb73d527103693f3ef7fa","routesusersjs")'>
<span class=tab-nav-text>routes/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesusersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: users
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Users Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;../models/models.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of users
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /users:
</span></span></span><span class=line><span class=cl><span class=cm> *   get: 
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: users list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all users in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of users
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 $ref: &#39;#/components/schemas/User&#39;          
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findAll</span><span class=p>({</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=s1>&#39;role&#39;</span><span class=p>],</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>You can learn more about querying associations in the <a href=https://sequelize.org/docs/v6/core-concepts/assocs/#basics-of-queries-involving-associations rel=external target=_blank>Sequelize Documentation</a>.</p><p>If everything works, we should see our roles now included in our JSON output when we navigate to the <code>/users</code> route:</p><div class=tab-panel data-tab-group=9e4cc92ecdbe16a1495871bd282dea79><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=route-users class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9e4cc92ecdbe16a1495871bd282dea79","route-users")'>
<span class=tab-nav-text>route: /users</span></button></div><div class=tab-content-container><div data-tab-item=route-users class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[
  {
    &#34;id&#34;: 1,
    &#34;username&#34;: &#34;admin&#34;,
    &#34;createdAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;updatedAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;roles&#34;: [
      {
        &#34;id&#34;: 1,
        &#34;role&#34;: &#34;manage_users&#34;
      },
      {
        &#34;id&#34;: 2,
        &#34;role&#34;: &#34;manage_documents&#34;
      },
      {
        &#34;id&#34;: 4,
        &#34;role&#34;: &#34;manage_communities&#34;
      }
    ]
  },
  {
    &#34;id&#34;: 2,
    &#34;username&#34;: &#34;contributor&#34;,
    &#34;createdAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;updatedAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;roles&#34;: [
      {
        &#34;id&#34;: 3,
        &#34;role&#34;: &#34;add_documents&#34;
      },
      {
        &#34;id&#34;: 5,
        &#34;role&#34;: &#34;add_communities&#34;
      }
    ]
  },
  {
    &#34;id&#34;: 3,
    &#34;username&#34;: &#34;manager&#34;,
    &#34;createdAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;updatedAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;roles&#34;: [
      {
        &#34;id&#34;: 2,
        &#34;role&#34;: &#34;manage_documents&#34;
      },
      {
        &#34;id&#34;: 4,
        &#34;role&#34;: &#34;manage_communities&#34;
      }
    ]
  },
  {
    &#34;id&#34;: 4,
    &#34;username&#34;: &#34;user&#34;,
    &#34;createdAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;updatedAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;roles&#34;: [
      {
        &#34;id&#34;: 6,
        &#34;role&#34;: &#34;view_documents&#34;
      },
      {
        &#34;id&#34;: 7,
        &#34;role&#34;: &#34;view_communities&#34;
      }
    ]
  }
]</code></pre></div></div></div></div></div><p>That should also exactly match the schema and route information in our Open API documentation provided at the <code>/docs</code> route.</p><p>There we go! That&rsquo;s a quick example of adding an additional table to our application, including a relationship and more.</p><p>As a last step before finalizing our code, we should run the <code>lint</code> and <code>format</code> commands and deal with any errors they find. Finally, we can <strong>commit and push</strong> our work.</p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=restful-api>RESTful API</h1><p>This example project builds on the previous Adding a Database project by using that project to create a <a href=https://en.wikipedia.org/wiki/REST rel=external target=_blank>RESTful API</a>. That API can be used to access and modify the data in the database. We&rsquo;ll also add a suite of unit tests to explore our API and ensure that it is working correctly.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li>A RESTful API with several routes for creating, reading, updating, and deleting (CRUD) data in the database</li><li>Open API Documentation for API Routes</li><li>Full Unit Test Suite with Coverage Metrics</li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of RESTful API</h1><article class=default><header class=headline></header><h1 id=api-design>API Design</h1><a href="https://www.youtube.com/watch?v=FwJ139xkhTc">YouTube Video</a><h2 id=good-api-design>Good API Design</h2><p>There are many articles online that discuss best practices in API design. For this project, we&rsquo;re going to follow a few of the most common recommendations:</p><ul><li><a href=https://www.postman.com/api-platform/api-versioning/ rel=external target=_blank>API Versioning</a></li><li><a href=https://restfulapi.net/resource-naming/ rel=external target=_blank>Proper Naming Conventions</a></li><li><a href=https://restfulapi.net/http-methods/ rel=external target=_blank>Proper HTTP Methods</a></li><li><a href=https://restfulapi.net/http-status-codes/ rel=external target=_blank>Proper HTTP Status Code Responses</a></li></ul><p>Let&rsquo;s start with the first one - we can easily add a version number to our API&rsquo;s URL paths. This allows us to make breaking changes to the API in the future without breaking any of the current functionality.</p><h2 id=api-versioning>API Versioning</h2><p>Our current application contains data for both a <code>User</code> and a <code>Role</code> model. For this example, we&rsquo;ll begin by adding a set of RESTful API routes to work with the <code>Role</code> model. In order to add proper versioning to our API, we will want these routes visible at the <code>/api/v1/roles</code> path.</p><p>First, we should create the folder structure inside of our <code>routes</code> folder to match the routes used in our API. This means we&rsquo;ll create an <code>api</code> folder, then a <code>v1</code> folder, and finally a <code>roles.js</code> file inside of that folder:</p><p><a href=#R-image-ddccd1a0a0b348edae1b19ab5b7a79bd class=lightbox-link><img alt="API Folder Paths" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/api_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ddccd1a0a0b348edae1b19ab5b7a79bd><img alt="API Folder Paths" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/api_1.png></a></p><p>Before we create the content in that file, let&rsquo;s also create a new file in the base <code>routes</code> folder named <code>api.js</code> that will become the base file for all of our API routes:</p><div class=tab-panel data-tab-group=0fc2ce2a39e32c0b7e4e18867975469e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0fc2ce2a39e32c0b7e4e18867975469e","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file API main router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: api
</span></span></span><span class=line><span class=cl><span class=cm> *   description: API routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import v1 routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>rolesRouter</span> <span class=nx>from</span> <span class=s2>&#34;./api/v1/roles.js&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use v1 routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/v1/roles&#34;</span><span class=p>,</span> <span class=nx>rolesRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of API versions
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: list API versions
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [api]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of API versions
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: object
</span></span></span><span class=line><span class=cl><span class=cm> *                 properties:
</span></span></span><span class=line><span class=cl><span class=cm> *                   version:
</span></span></span><span class=line><span class=cl><span class=cm> *                     type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                   url: 
</span></span></span><span class=line><span class=cl><span class=cm> *                     type: string
</span></span></span><span class=line><span class=cl><span class=cm> *             example:
</span></span></span><span class=line><span class=cl><span class=cm> *               - version: &#34;1.0&#34;
</span></span></span><span class=line><span class=cl><span class=cm> *                 url: /api/v1/
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v1/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span></span></span></code></pre></div></div></div></div></div><p>This file is very simple - it just outputs all possible API versions (in this case, we just have a single API version). It also imports and uses our new <code>roles</code> router. Finally, it includes some basic Open API documentation for the route it contains. Let&rsquo;s quickly add some basic content to our <code>roles</code> router, based on the existing content in our <code>users</code> router from before:</p><div class=tab-panel data-tab-group=f07d2df9c37f424c561bf3318a824493><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f07d2df9c37f424c561bf3318a824493","routesapiv1rolesjs")'>
<span class=tab-nav-text>routes/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Roles router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: roles
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Roles Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/logger.js&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of roles
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/v1/roles:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: roles list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all roles in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [roles]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of roles
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 $ref: &#39;#/components/schemas/Role&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>Role</span><span class=p>.</span><span class=nx>findAll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Notice that we have added an additional <code>try</code> and <code>catch</code> block to the route function. This will ensure any errors that are thrown by the database get caught and logged without leaking any sensitive data from our API. It is always a good practice to wrap each API method in a <code>try</code> and <code>catch</code> block.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Get All Route Only</div><div class=box-content><p>For this particular application&rsquo;s API design, we will only be creating the <strong>get all</strong> RESTful method for the <code>Role</code> model. This is because we don&rsquo;t actually want any users of the application modifying the roles themselves, since those roles will eventually be used in the overall authorization structure of the application (to be added in a later example). However, when creating or updating users, we need to be able to access a full list of all available roles, which can be found using this particular API endpoint.</p><p>We&rsquo;ll explore the rest of the RESTful API methods in the <code>User</code> model later in this example.</p></div></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Controllers and Services</div><div class=box-content><p>More complex RESTful API designs may include additional files such as <strong>controllers</strong> and <strong>services</strong> to add additional structure to the application. For example, there might be multiple API routes that access the same method in a controller, which then uses a service to perform business logic on the data before storing it in the database.</p><p>For this example project, we will place most of the functionality directly in our routes to simplify our structure.</p><p>You can read more about how to use controllers and services in the <a href=https://developer.mozilla.org/en-US/docs/Learn_web_development/Extensions/Server-side/Express_Nodejs/routes rel=external target=_blank>MDN Express Tutorial</a>.</p></div></div><p>Since we are creating routes in a new subfolder, we also need to update our Open API configuration in <code>configs/openapi.js</code> so that we can see the documentation contained in those routes:</p><div class=tab-panel data-tab-group=cddd4435477a6555397edc0194bd6ced><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsopenapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cddd4435477a6555397edc0194bd6ced","configsopenapijs")'>
<span class=tab-nav-text>configs/openapi.js</span></button></div><div class=tab-content-container><div data-tab-item=configsopenapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Configure SwaggerJSDoc options
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>definition</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>openapi</span><span class=o>:</span> <span class=s2>&#34;3.1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>info</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>title</span><span class=o>:</span> <span class=s2>&#34;Lost Communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>description</span><span class=o>:</span> <span class=s2>&#34;Kansas Lost Communities Project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>servers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>url</span><span class=o>:</span> <span class=nx>url</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>apis</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;./routes/*.js&#34;</span><span class=p>,</span> <span class=s2>&#34;./models/*.js&#34;</span><span class=p>,</span> <span class=s2>&#34;./routes/api/v1/*.js&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>swaggerJSDoc</span><span class=p>(</span><span class=nx>options</span><span class=p>);</span></span></span></code></pre></div></div></div></div></div><p>Now that we&rsquo;ve created these two basic routers, let&rsquo;s get them added to our <code>app.js</code> file so they are accessible to the application:</p><div class=tab-panel data-tab-group=8f325d56b09dd5e76a392f1afa229436><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8f325d56b09dd5e76a392f1afa229436","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/index.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/users.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>apiRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/api.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>helmet</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>compression</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use middlewares
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use static files
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s2>&#34;public&#34;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/users&#34;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/api&#34;</span><span class=p>,</span> <span class=nx>apiRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, with everything in place, let&rsquo;s run our application and see if we can access that new route at <code>/api/v1/roles</code>:</p><div class=tab-panel data-tab-group=466f27099048116f94b0d41b5351d7a2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("466f27099048116f94b0d41b5351d7a2","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>If everything is working correctly, we should see our roles listed in the output on that page:</p><p><a href=#R-image-4ac69ca015a59dccb7ce284a7052f478 class=lightbox-link><img alt="List of Roles" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/api_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4ac69ca015a59dccb7ce284a7052f478><img alt="List of Roles" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/api_2.png></a></p><p>We should also be able to query the list of API versions at the path <code>/api</code>:</p><p><a href=#R-image-301e727a6cd9a8bb8d258906232741ec class=lightbox-link><img alt="List of API Versions" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/api_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-301e727a6cd9a8bb8d258906232741ec><img alt="List of API Versions" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/api_3.png></a></p><p>Finally, we should also check and make sure our Open API documentation at the <code>/docs</code> path is up to date and includes the new routes:</p><p><a href=#R-image-dea574a9cb1bcd02733d39cdac30fc29 class=lightbox-link><img alt="API Documentation" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/api_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-dea574a9cb1bcd02733d39cdac30fc29><img alt="API Documentation" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/api_4.png></a></p><p><a href=#R-image-fa1f7cd851ebe9eb4acedd93f2135f94 class=lightbox-link><img alt="Roles Documentation" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/api_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fa1f7cd851ebe9eb4acedd93f2135f94><img alt="Roles Documentation" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/api_5.png></a></p><p>There! This gives us a platform to build our new API upon. We&rsquo;ll continue throughout this example project to add additional routes to the API as well as related unit tests.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=unit-testing>Unit Testing</h1><a href="https://www.youtube.com/watch?v=0jqhrmsuny0">YouTube Video</a><h2 id=testing-web-apis>Testing Web APIs</h2><p>Now that we have created our first route in our RESTful API, we can start to write unit tests that will confirm our API works as intended. Adding unit testing early in the development process makes it much easier to keep up with unit tests as new features are added or even explore <a href=https://en.wikipedia.org/wiki/Test-driven_development rel=external target=_blank>test-driven development</a>!</p><p>There are many libraries that can be used to unit test a RESTful API using Node.js and Express. For this project, we&rsquo;re going to use a number of testing libraries:</p><ul><li><a href=https://www.npmjs.com/package/mocha rel=external target=_blank>mocha</a> - Node.js testing framework</li><li><a href=https://www.npmjs.com/package/chai rel=external target=_blank>chai</a> - assertion library</li><li><a href=https://www.npmjs.com/package/supertest rel=external target=_blank>supertest</a> - HTTP request testing framework</li><li><a href=https://www.npmjs.com/package/ajv rel=external target=_blank>ajv</a> - JSON schema validator</li><li><a href=https://www.npmjs.com/package/chai-json-schema-ajv rel=external target=_blank>chai-json-schema-ajv</a> - chai plugin for AJV</li><li><a href=https://www.npmjs.com/package/chai-shallow-deep-equal rel=external target=_blank>chai-shallow-deep-equal</a> - chai plugin for deep equal assertion</li></ul><p>To begin, let&rsquo;s install these libraries as development dependencies in our project using <code>npm</code>:</p><div class=tab-panel data-tab-group=bec031e184eaba0d595a6100825101d5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bec031e184eaba0d595a6100825101d5","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install --save-dev mocha chai supertest ajv chai-json-schema-ajv chai-shallow-deep-equal</span></span></code></pre></div></div></div></div></div><p>Now that we have those libraries in place, let&rsquo;s make a few modifications to our project configuration to make testing more convenient.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> ESLint Plugin</div><div class=box-content><p>To help with formatting and highlighting of our unit tests, we should update the content of our <code>eslint.config.js</code> to recognize items from <code>mocha</code> as follows:</p><div class=tab-panel data-tab-group=3a251bf2e201b6fcc08cbd681cf3a86f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=eslintconfigjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3a251bf2e201b6fcc08cbd681cf3a86f","eslintconfigjs")'>
<span class=tab-nav-text>eslint.config.js</span></button></div><div class=tab-content-container><div data-tab-item=eslintconfigjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>globals</span> <span class=nx>from</span> <span class=s2>&#34;globals&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>pluginJs</span> <span class=nx>from</span> <span class=s2>&#34;@eslint/js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** @type {import(&#39;eslint&#39;).Linter.Config[]} */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>languageOptions</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>globals</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>...</span><span class=nx>globals</span><span class=p>.</span><span class=nx>node</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>...</span><span class=nx>globals</span><span class=p>.</span><span class=nx>mocha</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>rules</span><span class=o>:</span> <span class=p>{</span> <span class=s2>&#34;no-unused-vars&#34;</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;error&#34;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>argsIgnorePattern</span><span class=o>:</span> <span class=s2>&#34;next&#34;</span> <span class=p>}]</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>pluginJs</span><span class=p>.</span><span class=nx>configs</span><span class=p>.</span><span class=nx>recommended</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>];</span></span></span></code></pre></div></div></div></div></div><p>If working properly, this should also fix any errors visible in VS Code using the ESLint plugin!</p></div></div><h2 id=mocha-root-hooks>Mocha Root Hooks</h2><p>In testing frameworks such as <code>mocha</code>, we can create <code>hooks</code> that contain actions that should be taken before each test is executed in a file. The <code>mocha</code> framework also has <a href=https://mochajs.org/#root-hook-plugins rel=external target=_blank>root-level hooks</a> that are actions to be taken before each and every test in every file. We can use a root-level hook to manage setting up a simple database for unit testing, as well as configuring other aspects of our application for testing.</p><p>First, let&rsquo;s create a new <code>test</code> directory in our <code>server</code> folder, and inside of that we&rsquo;ll create a file <code>hooks.js</code> to contain the testing hooks for our application.</p><div class=tab-panel data-tab-group=bc3dd5541f7ea0de9df525c3fadf9c39><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhooksjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bc3dd5541f7ea0de9df525c3fadf9c39","testhooksjs")'>
<span class=tab-nav-text>test/hooks.js</span></button></div><div class=tab-content-container><div data-tab-item=testhooksjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Root Mocha Hooks
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports mochaHooks A Mocha Root Hooks Object
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load environment (must be first)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>dotenvx</span> <span class=nx>from</span> <span class=s2>&#34;@dotenvx/dotenvx&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>dotenvx</span><span class=p>.</span><span class=nx>config</span><span class=p>({</span><span class=nx>path</span><span class=o>:</span> <span class=s2>&#34;.env.test&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;../configs/database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>migrations</span> <span class=nx>from</span> <span class=s1>&#39;../configs/migrations.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>seeds</span> <span class=nx>from</span> <span class=s1>&#39;../configs/seeds.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Root Hook Runs Before Each Test
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>mochaHooks</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Hook runs once before any tests are executed
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>beforeAll</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Test database connection
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>database</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Run migrations
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>migrations</span><span class=p>.</span><span class=nx>up</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span> 
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// Hook runs before each individual test
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>beforeEach</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Seed the database
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>seeds</span><span class=p>.</span><span class=nx>up</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Hook runs after each individual test
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>afterEach</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Remove all data from the database
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>seeds</span><span class=p>.</span><span class=nx>down</span><span class=p>({</span><span class=nx>to</span><span class=o>:</span> <span class=mi>0</span><span class=p>}).</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>This file contains three hooks. First, the <code>beforeAll</code> hook, which is executed once before any tests are executed, is used to migrate the database. Then, we have the <code>beforeEach()</code> hook, which is executed before each individual test, which will seed the database with some sample data for us to use in our unit tests. Finally, we have an <code>afterEach()</code> hook that will remove any data from the database by undoing all of the seeds, which will truncate each table in the database.</p><p>Notice at the top that we are also loading our environment from a new environment file, <code>.env.test</code>. This allows us to use a different environment configuration when we perform testing. So, let&rsquo;s create that file and populate it with the following content:</p><div class=tab-panel data-tab-group=c3d7f1c09c2232f600ae1b7ce10b320d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=envtest class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c3d7f1c09c2232f600ae1b7ce10b320d","envtest")'>
<span class=tab-nav-text>.env.test</span></button></div><div class=tab-content-container><div data-tab-item=envtest class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>error
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>http://localhost:3000
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>:memory:
</span></span><span class=line><span class=cl><span class=nv>SEED_DATA</span><span class=o>=</span>false</span></span></code></pre></div></div></div></div></div><p>Here, the two major changes are to switch the log level to <code>error</code> so that we only see errors in the log output, and also to switch the database file to <code>:memory:</code> - a special filename that tells SQLite to create an in-memory database that is excellent for testing.</p><p>At this point, we can start writing our unit tests.</p><h2 id=writing-basic-unit-tests>Writing Basic Unit Tests</h2><p>Let&rsquo;s start with a very simple case - the <code>/api</code> route we created earlier. This is a simple route that only has a single method and outputs a single item, but it already clearly demonstrates how complex unit testing can become.</p><p>For these unit tests, we can create a file <code>api.js</code> in the <code>test</code> folder with the following content:</p><div class=tab-panel data-tab-group=db08d4b7c08b19cf7f68cacafe0f3d07><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("db08d4b7c08b19cf7f68cacafe0f3d07","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s1>&#39;supertest&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;chai&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s1>&#39;chai-json-schema-ajv&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s1>&#39;chai-shallow-deep-equal&#39;</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiJsonSchemaAjv</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>verbose</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}))</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiShallowDeepEqual</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s1>&#39;../app.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Modify Object.prototype for BDD style assertions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>should</span><span class=p>()</span></span></span></code></pre></div></div></div></div></div><p>These lines will import the various libraries required for these unit tests. We&rsquo;ll explore how they work as we build the unit tests, but it is also recommended to read the documentation for each library (linked above) to better understand how each one works together in the various unit tests.</p><p>Now, let&rsquo;s write our first unit test, which can be placed right below those lines in the same file:</p><div class=tab-panel data-tab-group=2eb26ce88455f19830096587e05502e3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2eb26ce88455f19830096587e05502e3","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all API versions
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllVersions</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should list all API versions&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s1>&#39;array&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;/api&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>This code looks quite a bit different than the code we&rsquo;ve been writing so far. This is because the <code>mocha</code> and <code>chai</code> libraries use the <a href=https://en.wikipedia.org/wiki/Behavior-driven_development rel=external target=_blank>Behavior-Driven Development</a>, or BDD, style for writing unit tests. The core idea is that the unit tests should be somewhat &ldquo;readable&rdquo; by anyone looking at the code. So, it defines functions such as <code>it</code> and <code>describe</code> that are used to structure the unit tests.</p><p>In this example, the <code>getAllVersions</code> function is a unit test function that uses the <code>request</code> library to send a request to our Express <code>app</code> at the <code>/api/</code> path. When the response is received from that request, we expect the HTTP status code to be 200, and the body of that request should be an array with a length of 1. Hopefully it is clear to see all of that just by reading the code in that function.</p><p>The other important concept is the special <code>done</code> function, which is provided as an argument to any unit test function that is testing <a href=https://mochajs.org/#asynchronous-code rel=external target=_blank>asynchronous code</a>. Because of the way asynchronous code is handled, the system cannot automatically determine when all promises have been returned. So, once we are done with the unit test and are not waiting for any further async responses, we need to call the <code>done()</code> method. Notice that we call that both at the end of the function, but also in the <code>if</code> statement that checks for any errors returned from the HTTP request.</p><p>Finally, at the bottom of the file, we have a few <code>describe</code> statements that actually build the structure that runs each unit test. When the tests are executed, only functions called inside of the <code>describe</code> statements will be executed.</p><h2 id=running-unit-tests>Running Unit Tests</h2><p>Now that we have created a simple unit test, let&rsquo;s run it using the <code>mocha</code> test framework. To do this, we&rsquo;ll add a new script to the <code>package.json</code> file with all of the appropriate options:</p><div class=tab-panel data-tab-group=4a3a8c3aa2c3a73e48c3961b72af5f37><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4a3a8c3aa2c3a73e48c3961b72af5f37","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;nodemon ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;lint&#34;</span><span class=p>:</span> <span class=s2>&#34;npx eslint --fix .&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;format&#34;</span><span class=p>:</span> <span class=s2>&#34;npx prettier . --write&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;test&#34;</span><span class=p>:</span> <span class=s2>&#34;mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Here, we are using the <code>mocha</code> command with many options:</p><ul><li><code>--require test/hooks.js</code> - this requires the global hooks file to be used before each test</li><li><code>--recursive</code> - this will recursively look for any tests in subdirectories</li><li><code>--parallel</code> - this allows tests to run in parallel (this requires the SQLite in-memory database)</li><li><code>--timeout 2000</code> - this will stop any test if it runs for more than 2 seconds</li><li><code>--exit</code> - this forces Mocha to stop after all tests have finished</li></ul><p>So, now let&rsquo;s run our tests using that script:</p><div class=tab-panel data-tab-group=375868d1e8218df824d64db48c631674><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("375868d1e8218df824d64db48c631674","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run test</span></span></code></pre></div></div></div></div></div><p>If everything is working correctly, we should get the following output:</p><div class=tab-panel data-tab-group=e4881efe58369f01aa42d0887bb7f13a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e4881efe58369f01aa42d0887bb7f13a","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; lost-communities-solution@0.0.1 test
&gt; mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit

[dotenvx@1.34.0] injecting env (6) from .env.test

[dotenvx@1.34.0] injecting env (0) from .env.test
[dotenvx@1.34.0] injecting env (0) from .env

  /api
    GET /
      ‚úî should list all API versions


  1 passing (880ms)</code></pre></div></div></div></div></div><p>Great! It looks like our test already passed!</p><p>Just to be sure, let&rsquo;s quickly modify our test to look for an array of size <code>2</code> so that it should fail:</p><div class=tab-panel data-tab-group=31bdc0f594e54add174ddcd4851f2d9a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("31bdc0f594e54add174ddcd4851f2d9a","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all API versions
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllVersions</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should list all API versions&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s1>&#39;array&#39;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we run the tests, we should clearly see a failure report instead:</p><div class=tab-panel data-tab-group=bcc8b6e32637af1e555ed8fab559fcb9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bcc8b6e32637af1e555ed8fab559fcb9","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; lost-communities-solution@0.0.1 test
&gt; mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit

[dotenvx@1.34.0] injecting env (6) from .env.test

[dotenvx@1.34.0] injecting env (0) from .env.test
[dotenvx@1.34.0] injecting env (0) from .env

  /api
    GET /
      1) should list all API versions


  0 passing (910ms)
  1 failing

  1) /api
       GET /
         should list all API versions:

      Uncaught AssertionError: expected [ { version: &#39;1.0&#39;, url: &#39;/api/v1/&#39; } ] to have a length of 2 but got 1
      + expected - actual

      -1
      +2
      
      at Test.&lt;anonymous&gt; (file:///workspaces/lost-communities-solution/server/test/api.js:31:30)
      at Test.assert (node_modules/supertest/lib/test.js:172:8)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)
      at Object.onceWrapper (node:events:638:28)
      at Server.emit (node:events:524:28)
      at emitCloseNT (node:net:2383:8)
      at process.processTicksAndRejections (node:internal/process/task_queues:89:21)</code></pre></div></div></div></div></div><p>Thankfully, anytime a test fails, we get a very clear and easy to follow error report that pinpoints exactly which line in the test failed, and how the assertion was not met.</p><p>Before moving on, let&rsquo;s update our test so that it should pass again.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=code-coverage>Code Coverage</h1><a href="https://www.youtube.com/watch?v=2Yl9zF6iz-U">YouTube Video</a><h2 id=code-coverage>Code Coverage</h2><p>It is often helpful to examine the <a href=https://en.wikipedia.org/wiki/Code_coverage rel=external target=_blank>code coverage</a> of our unit tests. Thankfully, there is an easy way to enable that in our project using the <a href=https://www.npmjs.com/package/c8 rel=external target=_blank>c8</a> library. So, we can start by installing it:</p><div class=tab-panel data-tab-group=63316ad50c25f99924742a3da68bc256><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("63316ad50c25f99924742a3da68bc256","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install --save-dev c8</span></span></code></pre></div></div></div></div></div><p>Once it is installed, we can simply add it to a new script in the <code>package.json</code> file that will run our tests with code coverage:</p><div class=tab-panel data-tab-group=ca152ce52c11a3441bdca6cd56f75852><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ca152ce52c11a3441bdca6cd56f75852","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;nodemon ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;lint&#34;</span><span class=p>:</span> <span class=s2>&#34;npx eslint --fix .&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;format&#34;</span><span class=p>:</span> <span class=s2>&#34;npx prettier . --write&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;test&#34;</span><span class=p>:</span> <span class=s2>&#34;mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;cov&#34;</span><span class=p>:</span> <span class=s2>&#34;c8 --reporter=html --reporter=text mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>All we have to do is add the <code>c8</code> command with a few options in front of our existing <code>mocha</code> command.</p><p>Now, we can run our tests with code coverage using this script:</p><div class=tab-panel data-tab-group=532e3a62d6c6bcd6707d1c82363c3221><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("532e3a62d6c6bcd6707d1c82363c3221","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run cov</span></span></code></pre></div></div></div></div></div><p>This time, we&rsquo;ll see a bunch of additional output on the terminal</p><div class=tab-panel data-tab-group=fbe4cf54d2f235ba71b460c7ef671e55><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fbe4cf54d2f235ba71b460c7ef671e55","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; lost-communities-solution@0.0.1 cov
&gt; c8 --reporter=html --reporter=text mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit

[dotenvx@1.34.0] injecting env (6) from .env.test

[dotenvx@1.34.0] injecting env (0) from .env.test
[dotenvx@1.34.0] injecting env (0) from .env

  /api
    GET /
      ‚úî should list all API versions


  1 passing (1s)

------------------------|---------|----------|---------|---------|-------------------------------------------
File                    | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                         
------------------------|---------|----------|---------|---------|-------------------------------------------
All files               |   93.53 |    83.33 |   55.55 |   93.53 |                                           
 server                 |   88.52 |       50 |     100 |   88.52 |                                           
  app.js                |   88.52 |       50 |     100 |   88.52 | 53-59                                     
 server/configs         |   91.86 |    47.36 |     100 |   91.86 |                                           
  database.js           |     100 |      100 |     100 |     100 |                                           
  logger.js             |   85.56 |    30.76 |     100 |   85.56 | 24-25,27-28,30-31,33-34,36-37,39-40,42-43 
  migrations.js         |     100 |      100 |     100 |     100 |                                           
  openapi.js            |   92.85 |    66.66 |     100 |   92.85 | 19-21                                     
  seeds.js              |     100 |      100 |     100 |     100 |                                           
 server/middlewares     |     100 |      100 |     100 |     100 |                                           
  request-logger.js     |     100 |      100 |     100 |     100 |                                           
 server/migrations      |   96.07 |      100 |      50 |   96.07 |                                           
  00_users.js           |   95.55 |      100 |      50 |   95.55 | 44-45                                     
  01_roles.js           |   94.91 |      100 |      50 |   94.91 | 57-59                                     
  02_counties.js        |   96.61 |      100 |      50 |   96.61 | 58-59                                     
  03_communities.js     |   96.61 |      100 |      50 |   96.61 | 58-59                                     
  04_metadata.js        |   96.66 |      100 |      50 |   96.66 | 88-90                                     
  05_documents.js       |   95.71 |      100 |      50 |   95.71 | 68-70                                     
 server/models          |     100 |      100 |     100 |     100 |                                           
  community.js          |     100 |      100 |     100 |     100 |                                           
  county.js             |     100 |      100 |     100 |     100 |                                           
  document.js           |     100 |      100 |     100 |     100 |                                           
  metadata.js           |     100 |      100 |     100 |     100 |                                           
  metadata_community.js |     100 |      100 |     100 |     100 |                                           
  metadata_document.js  |     100 |      100 |     100 |     100 |                                           
  models.js             |     100 |      100 |     100 |     100 |                                           
  role.js               |     100 |      100 |     100 |     100 |                                           
  user.js               |     100 |      100 |     100 |     100 |                                           
  user_role.js          |     100 |      100 |     100 |     100 |                                           
 server/routes          |   68.72 |      100 |     100 |   68.72 |                                           
  api.js                |     100 |      100 |     100 |     100 |                                           
  index.js              |   97.43 |      100 |     100 |   97.43 | 36                                        
  users.js              |    46.8 |      100 |     100 |    46.8 | 52-62,66-73,77-91,95-105,109-138          
 server/routes/api/v1   |   87.71 |      100 |     100 |   87.71 |                                           
  roles.js              |   87.71 |      100 |     100 |   87.71 | 48-54                                     
 server/seeds           |   95.09 |      100 |      50 |   95.09 |                                           
  00_users.js           |   96.36 |      100 |      50 |   96.36 | 54-55                                     
  01_roles.js           |   97.36 |      100 |      50 |   97.36 | 112-114                                   
  02_counties.js        |   95.83 |      100 |      50 |   95.83 | 47-48                                     
  03_communities.js     |   95.65 |      100 |      50 |   95.65 | 45-46                                     
  04_metadata.js        |   89.39 |      100 |      50 |   89.39 | 60-66                                     
  05_documents.js       |   94.82 |      100 |      50 |   94.82 | 56-58</code></pre></div></div></div></div></div><p>Right away we see that a large part of our application achieves 100% code coverage with a single unit test! This highlights both how tightly interconnected all parts of our application are (such that a single unit test exercises much of the code) but also that code coverage can be a very poor metric for unit test quality (seeing this result we might suspect our application is already well tested with just a single unit test).</p><p>We have also enabled the <code>html</code> reporter, so we can see similar results in a <code>coverage</code> folder that appears inside of our <code>server</code> folder. We can use various VS Code Extensions such as <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.live-server" rel=external target=_blank>Live Preview</a> to view that file in our web browser.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Port Conflict</div><div class=box-content><p>The Live Preview extension defaults to port 3000, so we recommend digging into the settings and changing the default port to something else before using it.</p></div></div><p><a href=#R-image-8b34069a64e9026542014c3b82766fd2 class=lightbox-link><img alt="Coverage Example" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/coverage_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8b34069a64e9026542014c3b82766fd2><img alt="Coverage Example" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/coverage_1.png></a></p><p>In either case, we can see that we&rsquo;ve already reached 100% coverage on our <code>routes/api.js</code> file. However, as we&rsquo;ll see in the next section, that doesn&rsquo;t always mean that we are done writing our unit tests.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=other-tests>Other Tests</h1><a href="https://www.youtube.com/watch?v=ENWHzaMXMMk">YouTube Video</a><h2 id=testing-for-other-issues>Testing for Other Issues</h2><p>Let&rsquo;s consider the scenario where our <code>routes/api.js</code> file was modified slightly to have some incorrect code in it:</p><div class=tab-panel data-tab-group=610c062fb21bc58caac8b4c0114dc5af><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("610c062fb21bc58caac8b4c0114dc5af","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>versoin</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/ver1/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>In this example, we have misspelled the <code>version</code> attribute, and also used an incorrect URL for that version of the API. Unfortunately, if we actually make that change to our code, our existing unit test will not catch either error!</p><p>So, let&rsquo;s look at how we can go about catching these errors and ensuring our unit tests are actually valuable.</p><h2 id=json-schemas>JSON Schemas</h2><p>First, it is often helpful to validate the schema of the JSON output by our API. To do that, we&rsquo;ve installed the <code>ajv</code> JSON schema validator and a <code>chai</code> plugin for using it in a unit test. So, in our <code>test/api.js</code> file, we can add a new test:</p><div class=tab-panel data-tab-group=14b00e5e3062f956b981699d1485a80e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("14b00e5e3062f956b981699d1485a80e","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check JSON Schema of API Versions
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllVersionsSchemaMatch</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;all API versions should match schema&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>schema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;array&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>items</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;object&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>required</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;version&#39;</span><span class=p>,</span> <span class=s1>&#39;url&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>properties</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>version</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;string&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>url</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;string&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>additionalProperties</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>jsonSchema</span><span class=p>(</span><span class=nx>schema</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;/api&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersionsSchemaMatch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>In this test, we create a JSON schema following the <a href=https://ajv.js.org/json-schema.html rel=external target=_blank>AJV Instructions</a> that defines the various attributes that should be present in the output. It is especially important to include the <code>additionalProperties: false</code> line, which helps prevent leaking any unintended attributes.</p><p>Now, when we run our tests, we should see that this test fails:</p><div class=tab-panel data-tab-group=1710aa35514a67688a28a0f42b7312b5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1710aa35514a67688a28a0f42b7312b5","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api
    GET /
      ‚úî should list all API versions
      1) all API versions should match schema


  1 passing (1s)
  1 failing

  1) /api
       GET /
         all API versions should match schema:
     Uncaught AssertionError: expected [ { versoin: &#39;1.0&#39;, ‚Ä¶(1) } ] to match json-schema
[ { instancePath: &#39;/0&#39;, ‚Ä¶(7) } ]
      at Test.&lt;anonymous&gt; (file:///workspaces/lost-communities-solution/server/test/api.js:59:28)
...</code></pre></div></div></div></div></div><p>As we can see, the misspelled <code>version</code> attribute will not match the given schema, causing the test to fail! That shows the value of such a unit test in our code.</p><h2 id=protecting-attributes>Protecting Attributes</h2><p>Let&rsquo;s update our route to include the correct attributes, but also add an additional item that shouldn&rsquo;t be present in the output:</p><div class=tab-panel data-tab-group=d8ca7064dfbdc83071c3ece57f16bae9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d8ca7064dfbdc83071c3ece57f16bae9","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/ver1/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>secure_data</span><span class=o>:</span> <span class=s2>&#34;This should not be shared!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>This is an example of <a href=https://owasp.org/API-Security/editions/2023/en/0xa3-broken-object-property-level-authorization/ rel=external target=_blank>Broken Object Property Level Authorization</a>, one of the top 10 most common API security risks according to OWASP. Often our database models will include attributes that we don&rsquo;t want to expose to our users, so we want to make sure they aren&rsquo;t included in the output by accident.</p><p>If we run our test again, it should also fail:</p><div class=tab-panel data-tab-group=d491551fbc8447c72f296fc9aadc1d66><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d491551fbc8447c72f296fc9aadc1d66","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api
    GET /
      ‚úî should list all API versions
      1) all API versions should match schema


  1 passing (1s)
  1 failing

  1) /api
       GET /
         all API versions should match schema:
     Uncaught AssertionError: expected [ { version: &#39;1.0&#39;, ‚Ä¶(2) } ] to match json-schema
[ { instancePath: &#39;/0&#39;, ‚Ä¶(7) } ]
      at Test.&lt;anonymous&gt; (file:///workspaces/lost-communities-solution/server/test/api.js:59:28)
...</code></pre></div></div></div></div></div><p>However, if we remove the line <code>additionalProperties: false</code> from our JSON schema unit test, it will now succeed. So, it is always important for us to remember to include that line in all of our JSON schemas if we want to avoid this particular security flaw.</p><h2 id=checking-values>Checking Values</h2><p>However, we still have not caught our incorrect value in our API output:</p><div class=tab-panel data-tab-group=b0c3901116c20ca8c76d3d3dc6bab0a0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b0c3901116c20ca8c76d3d3dc6bab0a0","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/ver1/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>secure_data</span><span class=o>:</span> <span class=s2>&#34;This should not be shared!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>For this, we need to write one additional unit test to check the actual content of the output. For this, we&rsquo;ll use a deep equality plugin for <code>chai</code>:</p><div class=tab-panel data-tab-group=bd88e0fc885b0bed0403181e1128e930><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bd88e0fc885b0bed0403181e1128e930","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check API version exists in list
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>findVersion</span> <span class=o>=</span> <span class=p>(</span><span class=nx>version</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should contain specific version&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>foundVersion</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>v</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>v</span><span class=p>.</span><span class=nx>version</span> <span class=o>===</span> <span class=nx>version</span><span class=p>.</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>foundVersion</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;/api&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersionsSchemaMatch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;version: 1.0&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>version</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v1/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>findVersion</span><span class=p>(</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>The <code>findVersion</code> unit test will check the actual contents of the output received from the API and compare it to the <code>version</code> object that is provided as input. In our <code>describe</code> statements below, we can see how easy it is to define a simple version object that we can use to compare to the output.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Use the Source!</div><div class=box-content><p>One common mistake when writing these unit tests is to simply copy the object structure from the code that is being tested. This is considered <strong>bad practice</strong> since it virtually guarantee that any typos or mistakes are not caught. Instead, when constructing these unit tests, we should always go back to the original source document, typically a design document or API specification, and build our unit tests using that as a guide. This will ensure that our tests will actually catch things such as typos or missing data.</p></div></div><p>With that test in place, we should once again have a unit test that fails:</p><div class=tab-panel data-tab-group=74452688dc434c4acaf14816499dce01><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("74452688dc434c4acaf14816499dce01","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api
    GET /
      ‚úî should list all API versions
      ‚úî all API versions should match schema
    version: 1.0
      GET /
        1) should contain specific version


  2 passing (987ms)
  1 failing

  1) /api
       version: 1.0
         GET /
           should contain specific version:

      Uncaught AssertionError: Expected to have &#34;/api/v1/&#34; but got &#34;/api/ver1/&#34; at path &#34;/url&#34;.
      + expected - actual

       {
      -  &#34;url&#34;: &#34;/api/ver1/&#34;
      +  &#34;url&#34;: &#34;/api/v1/&#34;
         &#34;version&#34;: &#34;1.0&#34;
       }
      
      at Test.&lt;anonymous&gt; (file:///workspaces/lost-communities-solution/server/test/api.js:76:29)</code></pre></div></div></div></div></div><p>Thankfully, in the output we clearly see the error, and it is easy to go back to our original design document to correct the error in our code.</p><h2 id=reusing-tests>Reusing Tests</h2><p>While it may seem like we are using a very complex structure for these tests, there is actually a very important reason behind it. If done correctly, we can easily reuse most of our tests as we add additional data to the application.</p><p>Let&rsquo;s consider the scenario where we add a second API version to our output:</p><div class=tab-panel data-tab-group=437e0856f1a54dc74d7a77d7a09af9ad><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("437e0856f1a54dc74d7a77d7a09af9ad","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v1/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v2/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>To fully test this, all we need to do is update the array size in the <code>getAllVersions</code> and add an additional <code>describe</code> statement for the new version:</p><div class=tab-panel data-tab-group=61ef6e58c4bc9b86726de1a21574ac93><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("61ef6e58c4bc9b86726de1a21574ac93","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all API versions
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllVersions</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should list all API versions&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s1>&#39;array&#39;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;/api&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersionsSchemaMatch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;version: 1.0&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>version</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v1/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>findVersion</span><span class=p>(</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;version: 2.0&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>version</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v2/&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl>    <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>findVersion</span><span class=p>(</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>With those minor changes, we see that our code now passes all unit tests:</p><div class=tab-panel data-tab-group=b9455a54ab386c11b2702cc5ecc968d9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b9455a54ab386c11b2702cc5ecc968d9","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api
    GET /
      ‚úî should list all API versions
      ‚úî all API versions should match schema
    version: 1.0
      GET /
        ‚úî should contain specific version
    version: 2.0
      GET /
        ‚úî should contain specific version</code></pre></div></div></div></div></div><p>By writing reusable functions for our unit tests, we can often deduplicate and simplify our code.</p><p>Before moving on, let&rsquo;s roll back our unit tests and the API to just have a single version. We should make sure all tests are passing before we move ahead!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=testing-roles>Testing Roles</h1><a href="https://www.youtube.com/watch?v=ClN_Vp3s5eA">YouTube Video</a><h2 id=unit-testing-roles-routes>Unit Testing Roles Routes</h2><p>Now that we&rsquo;ve created a basic unit test for the <code>/api</code> route, we can now expand on that to test our other existing route, the <code>/api/v1/roles</code> route. Once again, there is only one method inside of this route, the <strong>GET ALL</strong> method, so the unit tests should be similar between these two routes. The only difference here is this route is now reading from the database instead of just returning a static JSON array.</p><p>We can begin by creating a new <code>api</code> folder inside of the <code>test</code> folder, and then a <code>v1</code> folder inside of that, and finally a new <code>roles.js</code> file to contain our tests. By doing this, the path to our tests match the path to the routes themselves, making it easy to match up the tests with the associated routers.</p><p>Inside of that file, we can place the first unit test for the <code>roles</code> routes:</p><div class=tab-panel data-tab-group=7ba7351eb500166774f4b5cb9b423a38><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7ba7351eb500166774f4b5cb9b423a38","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api/v1/roles Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiJsonSchemaAjv</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>verbose</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiShallowDeepEqual</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../../../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Modify Object.prototype for BDD style assertions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>should</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all Roles
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllRoles</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should list all roles&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/roles route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllRoles</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Just like before, this unit test will simply send an HTTP GET request to the <code>/api/v1/roles</code> and expect to receive a response that contains an array of 7 elements, which matches the 7 roles defined in the <code>seeds/01_roles.js</code> file.</p><h2 id=adding-additional-formats-to-ajv>Adding Additional Formats to AJV</h2><p>Next, we can create a test to confirm that the structure of that response matches our expectation:</p><div class=tab-panel data-tab-group=5546b0419f9fb08916431aab3bf04c21><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5546b0419f9fb08916431aab3bf04c21","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check JSON Schema of Roles
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getRolesSchemaMatch</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;all roles should match schema&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>schema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;array&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>items</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>required</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>properties</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>id</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;number&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>role</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>additionalProperties</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>jsonSchema</span><span class=p>(</span><span class=nx>schema</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/roles route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllRoles</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>getRolesSchemaMatch</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>However, as we write that test, we might notice that the <code>createdAt</code> and <code>updatedAt</code> fields are just defined as strings, when really they should be storing a timestamp. Thankfully, the AJV Schema Validator has an extension called <a href=https://ajv.js.org/packages/ajv-formats.html rel=external target=_blank>AJV Formats</a> that adds many new formats we can use. So, let&rsquo;s install it as a development dependency using <code>npm</code>:</p><div class=tab-panel data-tab-group=61633337fbafa3087d29442058032bf6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("61633337fbafa3087d29442058032bf6","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install --save-dev ajv-formats</span></span></code></pre></div></div></div></div></div><p>Then, we can add it to AJV at the top of our unit tests and use all of the additional types in the <a href=https://ajv.js.org/packages/ajv-formats.html rel=external target=_blank>AJV Formats</a> documentation in our tests:</p><div class=tab-panel data-tab-group=370dd8c1e90048d6037a0330b16a0c56><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("370dd8c1e90048d6037a0330b16a0c56","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api/v1/roles Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>Ajv</span> <span class=nx>from</span> <span class=s1>&#39;ajv&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>addFormats</span> <span class=nx>from</span> <span class=s1>&#39;ajv-formats&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../../../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Configure Chai and AJV
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>ajv</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Ajv</span><span class=p>()</span>
</span></span><span class="line hl"><span class=cl><span class=nx>addFormats</span><span class=p>(</span><span class=nx>ajv</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiJsonSchemaAjv</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>ajv</span><span class=p>,</span> <span class=nx>verbose</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}));</span>
</span></span><span class="line hl"><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiShallowDeepEqual</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Modify Object.prototype for BDD style assertions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>should</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check JSON Schema of Roles
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getRolesSchemaMatch</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;all roles should match schema&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>schema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;array&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>items</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>required</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>properties</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>id</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;number&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>role</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span> <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;iso-date-time&#34;</span> <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;iso-date-time&#34;</span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>additionalProperties</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>jsonSchema</span><span class=p>(</span><span class=nx>schema</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now we can use the <code>iso-date-time</code> string format to confirm that the <code>createdAt</code> and <code>updatedAt</code> fields match the expected format. The <a href=https://ajv.js.org/packages/ajv-formats.html rel=external target=_blank>AJV Formats</a> package supports a number of helpful formats, such as <code>email</code>, <code>uri</code>, <code>uuid</code>, and more.</p><h2 id=testing-each-role>Testing Each Role</h2><p>Finally, we should also check that each role we expect to be included in the database is present and accounted for. We can write a single unit test function for this, but we&rsquo;ll end up calling it several times with different roles:</p><div class=tab-panel data-tab-group=e55dc5c7c4dd5ca01c2bdcc9d9c417c7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e55dc5c7c4dd5ca01c2bdcc9d9c417c7","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check Role exists in list
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>findRole</span> <span class=o>=</span> <span class=p>(</span><span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should contain &#39;&#34;</span> <span class=o>+</span> <span class=nx>role</span><span class=p>.</span><span class=nx>role</span> <span class=o>+</span> <span class=s2>&#34;&#39; role&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>foundRole</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>role</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>foundRole</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>role</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// List of all expected roles in the application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;manage_users&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;manage_documents&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;add_documents&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;manage_communities&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;add_communities&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;view_documents&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=mi>7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;view_communities&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/roles route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllRoles</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>getRolesSchemaMatch</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span> <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>findRole</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Here we are creating a simple array of roles, which looks similar to the one that is already present in our <code>seeds/01_roles.js</code> seed file, but importantly it is <strong>not copied from that file</strong>! Instead, we should go back to the original design documentation for this application, if any, and read the roles from there to make sure they are all correctly added to the database. In this case we don&rsquo;t have an original design document so we won&rsquo;t worry about that here.</p><p>With all of that in place, let&rsquo;s run our unit tests and confirm they are working:</p><div class=tab-panel data-tab-group=c6a9695be60645a6001abb0afacd9b8a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c6a9695be60645a6001abb0afacd9b8a","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run test</span></span></code></pre></div></div></div></div></div><p>If everything is correct, we should find the following in our output showing all tests are successful:</p><div class=tab-panel data-tab-group=9356f075320c45340e0a906f9c348602><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9356f075320c45340e0a906f9c348602","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api/v1/roles
    GET /
      ‚úî should list all roles
      ‚úî all roles should match schema
      ‚úî should contain &#39;manage_users&#39; role
      ‚úî should contain &#39;manage_documents&#39; role
      ‚úî should contain &#39;add_documents&#39; role
      ‚úî should contain &#39;manage_communities&#39; role
      ‚úî should contain &#39;add_communities&#39; role
      ‚úî should contain &#39;view_documents&#39; role
      ‚úî should contain &#39;view_communities&#39; role</code></pre></div></div></div></div></div><p>There we go! We now have working unit tests for our roles. Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub before continuing. Below are a couple of important discussions on unit test structure and design that are highly recommended before continuing.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Unit Tests Based on Seed Data</div><div class=box-content><p>In this application, we are heavily basing our unit tests on the seed data we created in the <code>seeds</code> directory. This is a <strong>design choice</strong>, and there are many different ways to approach this in practice:</p><ul><li>Seed data for unit tests could be included as a hook that runs before each unit test</li><li>Unit tests could assume the database is completely blank and manually insert data as needed as part of the test</li><li>Different seed data files could be used for testing and production</li><li>A sample database file or connection could be used for testing instead of seed data</li></ul><p>In this case, we believe it makes sense for the application we are testing to have a number of pre-defined roles and users that are populated via seed data when the application is tested and when it is deployed, so we chose to build our unit tests based on the assumption that the existing seed data will be used. However, other application designs may require different testing strategies, so it is always important to consider which method will work best for a given application!</p></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Duplicated Unit Test Code</div><div class=box-content><p>A keen-eyed observer may notice that the three unit test functions in the <code>test/api.js</code> file are nearly identical to the functions included in the <code>test/api/v1/roles.js</code> file. This is usually the case in unit testing - there is often a large amount of repeated code used to test different parts of an application, especially a RESTful API like this one.</p><p>This leads to two different design options:</p><ul><li>Refactor the code to reduce duplication across unit tests, adding some complexity and interdependence between tests</li><li>Keep duplicated code to make unit tests more readable and independent of each other</li></ul><p>For this application, we will follow the second approach. We feel that unit tests are much more useful if the large majority of the test can be easily seen and understood in a single file. This also means that a change in one test method will not impact other tests, both for good and for bad. So, it may mean modifying and updating the entire test suite is a bit more difficult, but updating individual tests should be much simpler.</p><p>Again, this is a <strong>design choice</strong> that we feel is best for this application, and other applications may be better off with other structures. It is always important to consider these implications when writing unit tests for an application!</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=retrieve-all>Retrieve All</h1><a href="https://www.youtube.com/watch?v=DkYVNrXEgn8">YouTube Video</a><h2 id=users-routes>Users Routes</h2><p>Now that we have written and tested the routes for the <code>Role</code> model, let&rsquo;s start working on the routes for the <code>User</code> model. These routes will be much more complex, because we want the ability to add, update, and delete users in our database.</p><p>To do this, we&rsquo;ll create several RESTful routes, which pair HTTP verbs and paths to the various CRUD operations that can be performed on the database. Here is a general list of the actions we want to perform on most models in a RESTful API, based on their associated CRUD operation:</p><ul><li>Create New (HTTP POST)</li><li>Retrieve All / Retrieve One (HTTP GET)</li><li>Update One (HTTP PUT)</li><li>Delete One (HTTP DELETE)</li></ul><p>As we build this new API router, we&rsquo;ll see each one of these in action.</p><h2 id=retrieve-all-route>Retrieve All Route</h2><p>The first operation we&rsquo;ll look at is the <strong>retrieve all</strong> operation, which is one we&rsquo;re already very familiar with. To begin, we should start by copying the existing file at <code>routes/users.js</code> to <code>routes/api/v1/users.js</code> and modifying it a bit to contain this content:</p><div class=tab-panel data-tab-group=bc7ef52ccf9361fd49b9e814dc1b793d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bc7ef52ccf9361fd49b9e814dc1b793d","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: users
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Users Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>User</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import logger
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of users
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class="line hl"><span class=cl><span class=cm> * /api/v1/users:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: users list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all users in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of users
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 $ref: &#39;#/components/schemas/User&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findAll</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>users</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This is very similar to the code we included in our <code>roles</code> route. The major difference is that the <code>users</code> route will also output the list of roles assigned to the user. There is a lot of great information in the <a href=https://sequelize.org/docs/v6/core-concepts/assocs/#basics-of-queries-involving-associations rel=external target=_blank>Sequelize Documentation</a> for how to properly query associated records.</p><p>We&rsquo;ll also need to remove the line from our <code>app.js</code> file that directly imports and uses that router:</p><div class=tab-panel data-tab-group=8e6c9b350df69a250ed86037f5fa327b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8e6c9b350df69a250ed86037f5fa327b","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/index.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/users.js&#34;</span><span class=p>;</span> <span class=c1>// delete this line
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>apiRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/api.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Use routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/users&#34;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span> <span class=c1>// delete this line
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/api&#34;</span><span class=p>,</span> <span class=nx>apiRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Instead, we can now import and link the new router in our <code>routes/api.js</code> file:</p><div class=tab-panel data-tab-group=d6733def3a8b5a1d84a4260068527435><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d6733def3a8b5a1d84a4260068527435","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import v1 routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>rolesRouter</span> <span class=nx>from</span> <span class=s2>&#34;./api/v1/roles.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s2>&#34;./api/v1/users.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use v1 routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/v1/roles&#34;</span><span class=p>,</span> <span class=nx>rolesRouter</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/v1/users&#34;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Before moving on, let&rsquo;s run our application and make sure that the <code>users</code> route is working correctly:</p><div class=tab-panel data-tab-group=d88ce1c553c39302764c97448b75dfcc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d88ce1c553c39302764c97448b75dfcc","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once it loads, we can navigate to the <code>/api/v1/users</code> URL to see the output:</p><p><a href=#R-image-214d69bf171d08a61592678c2ed14d4c class=lightbox-link><img alt="Retrieve All Ouptut" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/retrieveall_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-214d69bf171d08a61592678c2ed14d4c><img alt="Retrieve All Ouptut" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/retrieveall_1.png></a></p><h2 id=retrieve-all-unit-tests>Retrieve All Unit Tests</h2><p>As we write each of these routes, we&rsquo;ll also explore the related unit tests. The first three unit tests for this route are very similar to the ones we wrote for the <code>roles</code> routes earlier, so we won&rsquo;t go into too much detail on these. As expected, we&rsquo;ll place all of the unit tests for the <code>users</code> routes in the <code>test/api/v1/users.js</code> file:</p><div class=tab-panel data-tab-group=873a54607d95aa8f08cb65d3fbcf6c46><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("873a54607d95aa8f08cb65d3fbcf6c46","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api/v1/users Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Ajv</span> <span class=nx>from</span> <span class=s2>&#34;ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>addFormats</span> <span class=nx>from</span> <span class=s2>&#34;ajv-formats&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../../../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Configure Chai and AJV
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>ajv</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Ajv</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>addFormats</span><span class=p>(</span><span class=nx>ajv</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiJsonSchemaAjv</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>ajv</span><span class=p>,</span> <span class=nx>verbose</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiShallowDeepEqual</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Modify Object.prototype for BDD style assertions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>should</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// User Schema
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>userSchema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>required</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>properties</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;number&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;iso-date-time&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;iso-date-time&#34;</span> <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>roles</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;array&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>items</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;object&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>required</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=s1>&#39;role&#39;</span><span class=p>],</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>properties</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>              <span class=nx>id</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;number&#39;</span> <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>              <span class=nx>role</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;string&#39;</span> <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>additionalProperties</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all Users
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllUsers</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should list all users&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check JSON Schema of Users
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getUsersSchemaMatch</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;all users should match schema&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>schema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;array&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>items</span><span class=o>:</span> <span class=nx>userSchema</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>jsonSchema</span><span class=p>(</span><span class=nx>schema</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check User exists in list
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>findUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should contain &#39;&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39; user&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>foundUser</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>foundUser</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// List of all expected users in the application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;contributor&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;manager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllUsers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>getUsersSchemaMatch</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>findUser</span><span class=p>(</span><span class=nx>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>The major difference to note is in the highlighted section, where we have to add some additional schema information to account for the <code>roles</code> associated attribute that is part of the <code>users</code> object. It is pretty self-explanatory; each object in the array has a set of attributes that match what we used in the unit test for the <code>roles</code> routes.</p><p>We also moved the schema for the <code>User</code> response object out of that unit test so we can reuse it in other unit tests, as we&rsquo;ll see later in this example.</p><p>However, we also should add a couple of additional unit tests to confirm that each user has the correct roles assigned, since that is a major part of the security and authorization mechanism we&rsquo;ll be building for this application. While we could do that as part of the <code>findUser</code> test, let&rsquo;s go ahead and add separate tests for each of these, which is helpful in debugging anything that is broken or misconfigured.</p><div class=tab-panel data-tab-group=59abf156569600e596811b6e4fd29567><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("59abf156569600e596811b6e4fd29567","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api/v1/users Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span><span class=p>,</span> <span class=nx>expect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Ajv</span> <span class=nx>from</span> <span class=s2>&#34;ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>addFormats</span> <span class=nx>from</span> <span class=s2>&#34;ajv-formats&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check that User has correct number of roles
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>findUserCountRoles</span> <span class=o>=</span> <span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>count</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;user &#39;&#34;</span> <span class=o>+</span> <span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39; should have &#34;</span> <span class=o>+</span> <span class=nx>count</span> <span class=o>+</span> <span class=s2>&#34; roles&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>foundUser</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>username</span> <span class=o>===</span> <span class=nx>username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>foundUser</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>foundUser</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=nx>count</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check that User has specific role
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>findUserConfirmRole</span> <span class=o>=</span> <span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;user &#39;&#34;</span> <span class=o>+</span> <span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39; should have &#39;&#34;</span> <span class=o>+</span> <span class=nx>role</span> <span class=o>+</span> <span class=s2>&#34;&#39; role&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>foundUser</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>username</span> <span class=o>===</span> <span class=nx>username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>foundUser</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>role</span> <span class=o>===</span> <span class=nx>role</span><span class=p>)).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// List of all users and expected roles
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>user_roles</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>,</span> <span class=s2>&#34;manage_documents&#34;</span><span class=p>,</span> <span class=s2>&#34;manage_communities&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;contributor&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;add_documents&#34;</span><span class=p>,</span> <span class=s2>&#34;add_communities&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;manager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;manage_documents&#34;</span><span class=p>,</span> <span class=s2>&#34;manage_communities&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;view_documents&#34;</span><span class=p>,</span> <span class=s2>&#34;view_communities&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=nx>user_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Check that user has correct number of roles
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>findUserCountRoles</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nx>username</span><span class=p>,</span> <span class=nx>u</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>u</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Check that user has each expected role
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>findUserConfirmRole</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nx>username</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This code uses an additional assertion, <code>expect</code>, from the <code>chai</code> library, so we have to import it at the top on the highlighted line. These two tests will confirm that the user has the expected number of roles, and also explicitly confirm that each user has each of the expected roles.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Testing Arrays for Containment</div><div class=box-content><p>When writing unit tests that deal with arrays, it is always important to not only check that the array contains the correct elements, but also that it <strong>ONLY</strong> contains those elements and no additional elements. A great way to do this is to explicitly check each element the array should contain is present, and then <strong>also</strong> check the size of the array so that it can only contain those listed elements. Of course, this assumes that each element is only present once in the array!</p><p>If we aren&rsquo;t careful about how these unit tests are constructed, it is possible for arrays to contain additional items. In this case, it might mean that a user is assigned to more roles than they should be, which would be very bad for our application&rsquo;s security!</p></div></div><p>With all of these tests in place, let&rsquo;s go ahead and run them to confirm everything is working properly. Thankfully, with the <code>mocha</code> test runner, we can even specify a single file to run, as shown below:</p><div class=tab-panel data-tab-group=b8e74952d9d916d8527bd08f6a6a0b9a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b8e74952d9d916d8527bd08f6a6a0b9a","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run <span class=nb>test</span> test/api/v1/users.js</span></span></code></pre></div></div></div></div></div><p>If everything is correct, we should see that this file has 19 tests that pass:</p><div class=tab-panel data-tab-group=7330db8bfef6e714956323bdad3f99e3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7330db8bfef6e714956323bdad3f99e3","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api/v1/users
    GET /
      ‚úî should list all users
      ‚úî all users should match schema
      ‚úî should contain &#39;admin&#39; user
      ‚úî should contain &#39;contributor&#39; user
      ‚úî should contain &#39;manager&#39; user
      ‚úî should contain &#39;user&#39; user
      ‚úî user &#39;admin&#39; should have 3 roles
      ‚úî user &#39;admin&#39; should have &#39;manage_users&#39; role
      ‚úî user &#39;admin&#39; should have &#39;manage_documents&#39; role
      ‚úî user &#39;admin&#39; should have &#39;manage_communities&#39; role
      ‚úî user &#39;contributor&#39; should have 2 roles
      ‚úî user &#39;contributor&#39; should have &#39;add_documents&#39; role
      ‚úî user &#39;contributor&#39; should have &#39;add_communities&#39; role
      ‚úî user &#39;manager&#39; should have 2 roles
      ‚úî user &#39;manager&#39; should have &#39;manage_documents&#39; role
      ‚úî user &#39;manager&#39; should have &#39;manage_communities&#39; role
      ‚úî user &#39;user&#39; should have 2 roles
      ‚úî user &#39;user&#39; should have &#39;view_documents&#39; role
      ‚úî user &#39;user&#39; should have &#39;view_communities&#39; role


  19 passing (1s)</code></pre></div></div></div></div></div><p>Great! Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub before continuing.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=retrieve-one>Retrieve One</h1><a href="https://www.youtube.com/watch?v=VihnaPGzBz8">YouTube Video</a><h2 id=retrieve-one-route>Retrieve One Route</h2><p>Many RESTful web APIs also include the ability to retrieve a single object from a collection by providing the ID as a parameter to the route. So, let&rsquo;s go ahead and build that route in our application as well.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Unused in Practice</div><div class=box-content><p>While this route is an important part of many RESTful web APIs, it can often go unused since most frontend web applications will simply use the <strong>retrieve all</strong> endpoint to get a list of items, and then it will just cache that result and filter the list to show a user a single entry. However, there are some use cases where this route is extremely useful, so we&rsquo;ll go ahead and include it in our backend code anyway.</p></div></div><p>In our <code>routes/api/v1/users.js</code> file, we can add a new route to retrieve a single user based on the user&rsquo;s ID number:</p><div class=tab-panel data-tab-group=cddc941d51ea272779581963e491ad02><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cddc941d51ea272779581963e491ad02","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets a single user by ID
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/v1/users/{id}:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: get single user
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets a single user from the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     parameters:
</span></span></span><span class=line><span class=cl><span class=cm> *       - in: path
</span></span></span><span class=line><span class=cl><span class=cm> *         name: id
</span></span></span><span class=line><span class=cl><span class=cm> *         required: true
</span></span></span><span class=line><span class=cl><span class=cm> *         schema:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *         description: user ID
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: a user
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               $ref: &#39;#/components/schemas/User&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/:id&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findByPk</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=c1>// if the user is not found, return an HTTP 404 not found status code
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span> <span class=o>===</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>404</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this route, we have included a new route parameter <code>id</code> in the path for the route, and we also documented that route parameter in the Open API documentation comment. We then use that <code>id</code> parameter, which will be stored as <code>req.params.id</code> by Express, in the <code>findByPk</code> method available in <a href=https://sequelize.org/docs/v6/core-concepts/model-querying-finders/ rel=external target=_blank>Sequelize</a>. We can even confirm that our new method appears correctly in our documentation by visiting the <code>/docs</code> route in our application:</p><p><a href=#R-image-04d919b3df54ffc78147ce46aa604869 class=lightbox-link><img alt="Retrieve One Route" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/retrieve_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-04d919b3df54ffc78147ce46aa604869><img alt="Retrieve One Route" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/retrieve_1.png></a></p><p>When we visit that route, we&rsquo;ll need to include the ID of the user to request in the path, as in <code>/api/v1/users/1</code>. If it is working correctly, we should see data for a single user returned in the browser:</p><p><a href=#R-image-adca4ff2350a3a8277dc6ca4e14d4be5 class=lightbox-link><img alt="Retrieve One Route" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/retrieve_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-adca4ff2350a3a8277dc6ca4e14d4be5><img alt="Retrieve One Route" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/retrieve_2.png></a></p><h2 id=retrieve-one-unit-tests>Retrieve One Unit Tests</h2><p>The unit tests for the route to retrieve a single object are nearly identical to the ones use for the retrieve all route. Since we have already verified that each user exists and has the correct roles, we may not need to be as particular when developing these tests.</p><div class=tab-panel data-tab-group=c6564091f194c6e7cbd70db09b1b9237><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c6564091f194c6e7cbd70db09b1b9237","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get single user
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getSingleUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should get user &#39;&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get single user check schema
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getSingleUserSchemaMatch</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;user &#39;&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39; should match schema&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>jsonSchema</span><span class=p>(</span><span class=nx>userSchema</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>getSingleUser</span><span class=p>(</span><span class=nx>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>getSingleUserSchemaMatch</span><span class=p>(</span><span class=nx>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>For these unit tests, we are once again simply checking that we can retrieve each individual user by ID, and also that the response matches the expected <code>userSchema</code> object we used in earlier tests.</p><p>However, these unit tests are only checking for the users that we expect the database to contain. What if we receive an ID parameter for a user that does not exist? We should also test that particular situation as well.</p><div class=tab-panel data-tab-group=1e1f18729121770bf5e272b7ec56e9ae><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1e1f18729121770bf5e272b7ec56e9ae","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Tries to get a user using an invalid id
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getSingleUserBadId</span> <span class=o>=</span> <span class=p>(</span><span class=nx>invalidId</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should return 404 when requesting user with id &#39;&#34;</span> <span class=o>+</span> <span class=nx>invalidId</span> <span class=o>+</span> <span class=s2>&#34;&#39;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>invalidId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>404</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>getSingleUser</span><span class=p>(</span><span class=nx>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>getSingleUserSchemaMatch</span><span class=p>(</span><span class=nx>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>getSingleUserBadId</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>getSingleUserBadId</span><span class=p>(</span><span class=s2>&#34;test&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>getSingleUserBadId</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>getSingleUserBadId</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>With this unit test, we can easily check that our API properly returns HTTP status code 404 for a number of invalid ID values, including <code>0</code>, <code>-1</code>, <code>"test"</code>, <code>5</code>, and any others we can think of to try.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=create>Create</h1><a href="https://www.youtube.com/watch?v=QWP3aGro9_M">YouTube Video</a><h2 id=create-route>Create Route</h2><p>Now that we&rsquo;ve explored the routes we can use to read data from our RESTful API, let&rsquo;s look at the routes we can use to modify that data. The first one we&rsquo;ll cover is the <strong>create</strong> route, which allows us to add a new entry to the database. However, before we do that, let&rsquo;s create some helpful utility functions that we can reuse throughout our application as we develop more advanced routes.</p><h3 id=success-messages>Success Messages</h3><p>One thing we&rsquo;ll want to be able to do is send some well-formatted success messages to the user. While we could include this in each route, it is a good idea to abstract this into a utility function that we can write once and use throughout our application. By doing so, it makes it easier to restructure these messages as needed in the future.</p><p>So, let&rsquo;s create a new <code>utilities</code> folder inside of our <code>server</code> folder, and then a new <code>send-success.js</code> file with the following content:</p><div class=tab-panel data-tab-group=3a5a478d8623a9517f2cb0a6cddd14dc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=utilitiessend-successjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3a5a478d8623a9517f2cb0a6cddd14dc","utilitiessend-successjs")'>
<span class=tab-nav-text>utilities/send-success.js</span></button></div><div class=tab-content-container><div data-tab-item=utilitiessend-successjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Sends JSON Success Messages
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports sendSuccess a function to send JSON Success Messages
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Send JSON Success Messages
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} message - the message to send
</span></span></span><span class=line><span class=cl><span class=cm> * @param {integer} status - the HTTP status to use
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   responses:
</span></span></span><span class=line><span class=cl><span class=cm> *     Success:
</span></span></span><span class=line><span class=cl><span class=cm> *       description: success
</span></span></span><span class=line><span class=cl><span class=cm> *       content:
</span></span></span><span class=line><span class=cl><span class=cm> *         application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *           schema:
</span></span></span><span class=line><span class=cl><span class=cm> *             type: object
</span></span></span><span class=line><span class=cl><span class=cm> *             required:
</span></span></span><span class=line><span class=cl><span class=cm> *               - message
</span></span></span><span class=line><span class=cl><span class=cm> *               - id
</span></span></span><span class=line><span class=cl><span class=cm> *             properties:
</span></span></span><span class=line><span class=cl><span class=cm> *               message:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                 description: the description of the successful operation
</span></span></span><span class=line><span class=cl><span class=cm> *               id:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *                 description: the id of the saved or created item
</span></span></span><span class=line><span class=cl><span class=cm> *             example:
</span></span></span><span class=line><span class=cl><span class=cm> *               message: User successfully saved!
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>sendSuccess</span><span class=p>(</span><span class=nx>message</span><span class=p>,</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>status</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=nx>status</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>message</span><span class=o>:</span> <span class=nx>message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>sendSuccess</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>In this file, we are defining a <strong>success</strong> message from our application as a JSON object with a <code>message</code> attribute, as well as the <code>id</code> of the object that was acted upon. The code itself is very straightforward, but we are including the appropriate Open API documentation as well, which we can reuse in our routes elsewhere.</p><p>To make the Open API library aware of these new files, we need to add it to our <code>configs/openapi.js</code> file:</p><div class=tab-panel data-tab-group=69bffe745d9a20dd6108edebcc8a4e15><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsopenapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("69bffe745d9a20dd6108edebcc8a4e15","configsopenapijs")'>
<span class=tab-nav-text>configs/openapi.js</span></button></div><div class=tab-content-container><div data-tab-item=configsopenapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>definition</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>openapi</span><span class=o>:</span> <span class=s2>&#34;3.1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>info</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>title</span><span class=o>:</span> <span class=s2>&#34;Lost Communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>description</span><span class=o>:</span> <span class=s2>&#34;Kansas Lost Communities Project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>servers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>url</span><span class=o>:</span> <span class=nx>url</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>apis</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;./routes/*.js&#34;</span><span class=p>,</span> <span class=s2>&#34;./models/*.js&#34;</span><span class=p>,</span> <span class=s2>&#34;./routes/api/v1/*.js&#34;</span><span class=p>,</span> <span class=s2>&#34;./utilities/*.js&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div></div></div></div><h3 id=validation-error-messages>Validation Error Messages</h3><p>Likewise, we may also want to send a well-structured message anytime our database throws an error, or if any of our model validation steps fails. So, we can create another file <code>handle-validation-error.js</code> with the following content:</p><div class=tab-panel data-tab-group=7b30084ff7848929df79a8e9b711d1a5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=utilitieshandle-validation-errorjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7b30084ff7848929df79a8e9b711d1a5","utilitieshandle-validation-errorjs")'>
<span class=tab-nav-text>utilities/handle-validation-error.js</span></button></div><div class=tab-content-container><div data-tab-item=utilitieshandle-validation-errorjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Error handler for Sequelize Validation Errors
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports handleValidationError a handler for Sequelize validation errors
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gracefully handle Sequelize Validation Errors
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {SequelizeValidationError} error - Sequelize Validation Error
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   responses:
</span></span></span><span class=line><span class=cl><span class=cm> *     Success:
</span></span></span><span class=line><span class=cl><span class=cm> *     ValidationError: 
</span></span></span><span class=line><span class=cl><span class=cm> *       description: model validation error
</span></span></span><span class=line><span class=cl><span class=cm> *       content:
</span></span></span><span class=line><span class=cl><span class=cm> *         application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *           schema:
</span></span></span><span class=line><span class=cl><span class=cm> *             type: object
</span></span></span><span class=line><span class=cl><span class=cm> *             required:
</span></span></span><span class=line><span class=cl><span class=cm> *               - error
</span></span></span><span class=line><span class=cl><span class=cm> *             properties:
</span></span></span><span class=line><span class=cl><span class=cm> *               error: 
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                 description: the description of the error
</span></span></span><span class=line><span class=cl><span class=cm> *               errors:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: array
</span></span></span><span class=line><span class=cl><span class=cm> *                 items:
</span></span></span><span class=line><span class=cl><span class=cm> *                    type: object
</span></span></span><span class=line><span class=cl><span class=cm> *                    required: 
</span></span></span><span class=line><span class=cl><span class=cm> *                      - attribute
</span></span></span><span class=line><span class=cl><span class=cm> *                      - message
</span></span></span><span class=line><span class=cl><span class=cm> *                    properties:
</span></span></span><span class=line><span class=cl><span class=cm> *                      attribute:
</span></span></span><span class=line><span class=cl><span class=cm> *                        type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                        description: the attribute that caused the error
</span></span></span><span class=line><span class=cl><span class=cm> *                      message:
</span></span></span><span class=line><span class=cl><span class=cm> *                        type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                        description: the error associated with that attribute
</span></span></span><span class=line><span class=cl><span class=cm> *             example:
</span></span></span><span class=line><span class=cl><span class=cm> *               error: Validation Error
</span></span></span><span class=line><span class=cl><span class=cm> *               errors:
</span></span></span><span class=line><span class=cl><span class=cm> *                 - attribute: username
</span></span></span><span class=line><span class=cl><span class=cm> *                   message: username must be unique
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>handleValidationError</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>errors</span><span class=o>?</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>errors</span> <span class=o>=</span> <span class=nx>error</span><span class=p>.</span><span class=nx>errors</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{</span><span class=nx>attribute</span><span class=o>:</span> <span class=nx>e</span><span class=p>.</span><span class=nx>path</span><span class=p>,</span> <span class=nx>message</span><span class=o>:</span> <span class=nx>e</span><span class=p>.</span><span class=nx>message</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>422</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> 
</span></span><span class=line><span class=cl>      <span class=nx>error</span><span class=o>:</span> <span class=s2>&#34;Validation Error&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>errors</span><span class=o>:</span> <span class=nx>errors</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>422</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>error</span><span class=o>:</span> <span class=nx>error</span><span class=p>.</span><span class=nx>parent</span><span class=p>.</span><span class=nx>message</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>handleValidationError</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Again, the code for this is not too complex. It builds upon the structure in the <a href=https://sequelize.org/api/v7/classes/_sequelize_core.index.validationerror rel=external target=_blank>Sequelize ValidationError</a> class to create a helpful JSON object that includes both an <code>error</code> attribute as well as an optional <code>errors</code> array that lists each attribute with a validation error, if possible. We also include the appropriate Open API documentation for this response type.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Trial & Error</div><div class=box-content><p>If we look at the code in the <code>handle-validation-error.js</code> file, it may seem like it came from nowhere, or it may be difficult to see how this was constructed based on what little is given in the Sequelize documentation.</p><p>In fact, this code was actually constructed using a trial and error process by iteratively submitting broken models and looking at the raw errors that were produced by Sequelize until a common structure was found. For the purposes of this example, we&rsquo;re leaving out some of these steps, but we encourage exploring the output to determine the best method for any given application.</p></div></div><h2 id=creating-a-new-user>Creating a New User</h2><p>Now that we have created helpers for our route, we can add the code to actually create that new user when an HTTP POST request is received.</p><p>In our <code>routes/api/v1/users.js</code> file, let&rsquo;s add a new route we can use to create a new entry in the <code>users</code> table:</p><div class=tab-panel data-tab-group=2589ecb2427476657970da377b5e5054><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2589ecb2427476657970da377b5e5054","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ValidationError</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;sequelize&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import database
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/database.js&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import utilities
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>handleValidationError</span> <span class=nx>from</span> <span class=s2>&#34;../../../utilities/handle-validation-error.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>sendSuccess</span> <span class=nx>from</span> <span class=s2>&#34;../../../utilities/send-success.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Create a new user
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/v1/users:
</span></span></span><span class=line><span class=cl><span class=cm> *   post:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: create user
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     requestBody:
</span></span></span><span class=line><span class=cl><span class=cm> *       description: user
</span></span></span><span class=line><span class=cl><span class=cm> *       required: true
</span></span></span><span class=line><span class=cl><span class=cm> *       content:
</span></span></span><span class=line><span class=cl><span class=cm> *         application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *           schema:
</span></span></span><span class=line><span class=cl><span class=cm> *             $ref: &#39;#/components/schemas/User&#39;
</span></span></span><span class=line><span class=cl><span class=cm> *           example:
</span></span></span><span class=line><span class=cl><span class=cm> *             username: newuser
</span></span></span><span class=line><span class=cl><span class=cm> *             roles:
</span></span></span><span class=line><span class=cl><span class=cm> *               - id: 6
</span></span></span><span class=line><span class=cl><span class=cm> *               - id: 7
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       201:
</span></span></span><span class=line><span class=cl><span class=cm> *         $ref: &#39;#/components/responses/Success&#39;
</span></span></span><span class=line><span class=cl><span class=cm> *       422:
</span></span></span><span class=line><span class=cl><span class=cm> *         $ref: &#39;#/components/responses/ValidationError&#39;         
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Use a database transaction to roll back if any errors are thrown
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>await</span> <span class=nx>database</span><span class=p>.</span><span class=nx>transaction</span><span class=p>(</span><span class=kr>async</span> <span class=nx>t</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Build the user object using body attributes
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>username</span><span class=o>:</span> <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Assign to a database transaction
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>transaction</span><span class=o>:</span> <span class=nx>t</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=c1>// If roles are included in the body
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>roles</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find all roles listed
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=kr>await</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>map</span><span class=p>(({</span> <span class=nx>id</span><span class=p>,</span> <span class=p>...</span><span class=nx>next</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>Role</span><span class=p>.</span><span class=nx>findByPk</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// Attach roles to user
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>await</span> <span class=nx>user</span><span class=p>.</span><span class=nx>setRoles</span><span class=p>(</span><span class=nx>roles</span><span class=p>,</span> <span class=p>{</span> <span class=nx>transaction</span><span class=o>:</span> <span class=nx>t</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=c1>// Send the success message
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>sendSuccess</span><span class=p>(</span><span class=s2>&#34;User saved!&#34;</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=mi>201</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>error</span> <span class=k>instanceof</span> <span class=nx>ValidationError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>handleValidationError</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>At the top of the file, we have added several additional import statements:</p><ul><li><code>ValidationError</code> - we import the <code>ValidationError</code> type from the Sequelize library</li><li><code>database</code> - we import our Sequelize instance from <code>configs/database.js</code> so we can create a transaction</li><li><code>handleValidationError</code> and <code>sendSuccess</code> - we import our two new utilities from the <code>utilities</code> folder</li></ul><p>This route itself is quite a bit more complex that our previous routes, so let&rsquo;s break down what it does piece by piece to see how it all works together.</p><ol><li>Start a database transaction</li></ol><div class=tab-panel data-tab-group=ef5ba86be9128091e801947a3a08866d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ef5ba86be9128091e801947a3a08866d","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>await</span> <span class=nx>database</span><span class=p>.</span><span class=nx>transaction</span><span class=p>(</span><span class=kr>async</span> <span class=nx>t</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// perform database operations here
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>First, since we will be updating the database using multiple steps, we should use a <a href=https://en.wikipedia.org/wiki/Database_transaction rel=external target=_blank>database transaction</a> to ensure that we only update the database if all operations will succeed. So, we use the <a href=https://sequelize.org/docs/v6/other-topics/transactions/ rel=external target=_blank>Sequelize Transactions</a> feature to create a new managed database transaction. If we successfully reach the end of the block of code contained in this statement, the database transaction will be <em>committed</em> to the database and the changes will be stored.</p><ol start=2><li>Create the <code>User</code> itself</li></ol><div class=tab-panel data-tab-group=f75716d89b6c14f3b1d49c215f9d7091><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f75716d89b6c14f3b1d49c215f9d7091","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Build the user object using body attributes
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>username</span><span class=o>:</span> <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Assign to a database transaction
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>transaction</span><span class=o>:</span> <span class=nx>t</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Next, we use the <code>User</code> model to create a new instance of the user and store it in the database. The <a href=https://sequelize.org/docs/v6/core-concepts/model-instances/#a-very-useful-shortcut-the-create-method rel=external target=_blank>Sequelize Create</a> method will both build the new object in memory as well as save it to the database. This is an asynchronous process, so we must <code>await</code> the result before moving on. We also must give this method a reference to the current database transaction <code>t</code> in the second parameter.</p><ol start=3><li>Associate Roles</li></ol><div class=tab-panel data-tab-group=cdbce1d86be1ad6ad65a5cea43d3adc8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cdbce1d86be1ad6ad65a5cea43d3adc8","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// If roles are included in the body
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>roles</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find all roles listed
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=kr>await</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>map</span><span class=p>(({</span> <span class=nx>id</span><span class=p>,</span> <span class=p>...</span><span class=nx>next</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>Role</span><span class=p>.</span><span class=nx>findByPk</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// Attach roles to user
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>await</span> <span class=nx>user</span><span class=p>.</span><span class=nx>setRoles</span><span class=p>(</span><span class=nx>roles</span><span class=p>,</span> <span class=p>{</span> <span class=nx>transaction</span><span class=o>:</span> <span class=nx>t</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>After that, we check to see if the <code>roles</code> attribute was provided as part of the body of the HTTP POST method. If it was, we need to associate those roles with the new user. Here, we are assuming that the submission includes the ID for each role at a minimum, but it may also include other data such as the name of the role. So, before doing anything else, we must first find each <code>Role</code> model in the database by ID using the <code>findByPk</code> method. Once we have a list of roles, then we can add those roles to the <code>User</code> object using the special <code>setRoles</code> method that is created as part of the <code>Roles</code> association on that model. If any roles are null and can&rsquo;t be found, this will throw an error that we can catch later.</p><ol start=4><li>Send Success Messages</li></ol><div class=tab-panel data-tab-group=911382d0e943fb5976d08f27a7bd8df2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("911382d0e943fb5976d08f27a7bd8df2","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>      <span class=c1>// Send the success message
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>sendSuccess</span><span class=p>(</span><span class=s2>&#34;User saved!&#34;</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=mi>201</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span></span></span></code></pre></div></div></div></div></div><p>Finally, if everything is correct, we can send the success message back to the user using the <code>sendSuccess</code> utility method that we created earlier.</p><ol start=5><li>Handle Exceptions</li></ol><div class=tab-panel data-tab-group=12452031b869bd3b500c0181c59a02db><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("12452031b869bd3b500c0181c59a02db","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>error</span> <span class=k>instanceof</span> <span class=nx>ValidationError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>handleValidationError</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Finally, at the bottom of the file we have a <code>catch</code> block that will catch any exceptions thrown while trying to create our <code>User</code> and associate the correct <code>Role</code> objects. Notice that this <code>catch</code> block is <strong>outside</strong> the database transaction, so any database changes will not be saved if we reach this block of code.</p><p>Inside, we check to see if the error is an instance of the <code>ValidationError</code> class from Sequelize. If so, we can use our new <code>handleValidationError</code> method to process that error and send a well-structured JSON response back to the user about the error. If not, we&rsquo;ll simply log the error and send back a generic HTTP 500 response code.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=testing-create>Testing Create</h1><a href="https://www.youtube.com/watch?v=37eMKTRxQi4">YouTube Video</a><h2 id=manual-testing-with-open-api>Manual Testing with Open API</h2><p>Before we start unit testing this route, let&rsquo;s quickly do some manual testing using the Open API documentation site. It is truly a very handy way to work with our RESTful APIs as we are developing them, allowing us to test them quickly in isolation to make sure everything is working properly.</p><p>So, let&rsquo;s start our server:</p><div class=tab-panel data-tab-group=085a3916b637c59453ce63da86b5f07b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("085a3916b637c59453ce63da86b5f07b","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once it starts, we can navigate to the <code>/docs</code> URL, and we should see the Open API documentation for our site, including a new <code>POST</code> route for the <code>users</code> section:</p><p><a href=#R-image-706c0dfe0ec11d27050719baf2af4cd2 class=lightbox-link><img alt="Create API Documentation" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/create_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-706c0dfe0ec11d27050719baf2af4cd2><img alt="Create API Documentation" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/create_1.png></a></p><p>If we documented our route correctly, we can see that this documentation includes not only an example for what a new submission should look like, but also examples of the <strong>success</strong> and <strong>model validation error</strong> outputs should be. To test it, we can use the <strong>Try it out</strong> button on the page to try to create a new user.</p><p><a href=#R-image-1b540ac1ba261924cb9de348c12e202e class=lightbox-link><img alt="Create Example" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/create_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1b540ac1ba261924cb9de348c12e202e><img alt="Create Example" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/create_2.png></a></p><p>Let&rsquo;s go ahead and try to create the user that is suggested by our example input, which should look like this:</p><div class=tab-panel data-tab-group=d2e23a0c6c5a6863854b5f1045b275f7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=input class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d2e23a0c6c5a6863854b5f1045b275f7","input")'>
<span class=tab-nav-text>input</span></button></div><div class=tab-content-container><div data-tab-item=input class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;newuser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;roles&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>This would create a user with the username <code>newuser</code> and assign them to the roles with IDs 6 (<code>view_documents</code>) and 7 (<code>view_communities</code>). So, we can click the <strong>Execute</strong> button to send that request to the server and see if it works.</p><p><a href=#R-image-6b606b30d7aa2e96e9c21e5383792636 class=lightbox-link><img alt="Create Success" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/create_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6b606b30d7aa2e96e9c21e5383792636><img alt="Create Success" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/create_3.png></a></p><p>Excellent! We can see that it worked correctly, and we received our expected success message as part of the response. We can also scroll up and try the <code>GET /api/v1/users</code> API endpoint to see if that user appears in our list of all users in the system with the correct roles assigned. If we do, we should see this in the output:</p><div class=tab-panel data-tab-group=07dcc9978e16e5ca6b209ebda7d41dcf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("07dcc9978e16e5ca6b209ebda7d41dcf","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;newuser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;createdAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-21T18:34:54.725Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;updatedAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-21T18:34:54.725Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;roles&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;view_documents&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;view_communities&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>From here, we can try a couple of different scenarios to see if our server is working properly.</p><h3 id=duplicate-username>Duplicate Username</h3><p>First, what if we try and create a user with a duplicate username? To test this, we can simply resubmit the default example again and see what happens. This time, we get an HTTP 422 response code with a very detailed error message:</p><p><a href=#R-image-12ebf2f999d377ca44fb66b4c025e220 class=lightbox-link><img alt="Create Failure - Duplicate Username" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/create_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-12ebf2f999d377ca44fb66b4c025e220><img alt="Create Failure - Duplicate Username" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/create_4.png></a></p><p>This is great! It tells us exactly what the error is. This is the output created by our <code>handleValidationError</code> utility function from the previous page.</p><h3 id=missing-attributes>Missing Attributes</h3><p>We can also try to submit a new user, but this time we can accidentally leave out some of the attributes, as in this example:</p><div class=tab-panel data-tab-group=104058a36b30f55580135912913a77ca><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=input class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("104058a36b30f55580135912913a77ca","input")'>
<span class=tab-nav-text>input</span></button></div><div class=tab-content-container><div data-tab-item=input class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;user&#34;</span><span class=p>:</span> <span class=s2>&#34;testuser&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Here, we have mistakenly renamed the <code>username</code> attribute to just <code>user</code>, and we&rsquo;ve left off the <code>roles</code> list entirely. When we submit this, we also get a helpful error message:</p><p><a href=#R-image-0b341ffd85028de18fb09659e73e7880 class=lightbox-link><img alt="Create Failure - Username Null" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/create_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0b341ffd85028de18fb09659e73e7880><img alt="Create Failure - Username Null" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/create_5.png></a></p><p>Since the <code>username</code> attribute was not provided, it will be set to <code>null</code> and the database will not allow a <code>null</code> value for that attribute.</p><p>However, if we correct that, we do see that it will accept a new user without any listed roles! This is by design, since we may need to create users that don&rsquo;t have any roles assigned.</p><h3 id=invalid-roles>Invalid Roles</h3><p>Finally, what if we try to create a user with an invalid list of roles:</p><div class=tab-panel data-tab-group=df363ea86728a3d9130293f1919d2d92><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=input class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("df363ea86728a3d9130293f1919d2d92","input")'>
<span class=tab-nav-text>input</span></button></div><div class=tab-content-container><div data-tab-item=input class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;baduser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;roles&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>In this instance, we&rsquo;ll get another helpful error message:</p><p><a href=#R-image-6b56563ec7dac53f15b6c59c2843efd8 class=lightbox-link><img alt="Create Failure - Role Null" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/create_6.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6b56563ec7dac53f15b6c59c2843efd8><img alt="Create Failure - Role Null" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/create_6.png></a></p><p>Since there is no role with ID 8 in the database, it finds a <code>null</code> value instead and tries to associate that with our user. This causes an SQL constraint error, which we can send back to our user.</p><p>Finally, we should also double-check that our user <code>baduser</code> was not created using <code>GET /api/v1/users</code> API endpoint above. This is because we don&rsquo;t want to create that user unless a list of valid roles are also provided.</p><h2 id=unit-testing>Unit Testing</h2><p>Now that we have a good handle on how this endpoint works in practice, let&rsquo;s write some unit tests to confirm that it works as expected in each of these cases. First, we should have a simple unit test that successfully creates a new user:</p><div class=tab-panel data-tab-group=80e4a195805624e374d6c20a6d95c4ec><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("80e4a195805624e374d6c20a6d95c4ec","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Creates a user successfully
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>createUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should successfully create a user &#39;&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>201</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>created_id</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find user in list of all users
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>foundUser</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>created_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>foundUser</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// New user structure for creating users
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>new_user</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;test_user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span><span class=o>:</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span><span class=o>:</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;POST /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This first test is very straightforward since it just confirms that we can successfully create a new user in the system. It also confirms that the user now appears in the output from the <strong>get all</strong> route, which is helpful.</p><p>While this at least confirms that the route works as expected, we should write several more unit tests to confirm that the route works correctly even if the user provides invalid input.</p><h3 id=missing-attributes-1>Missing Attributes</h3><p>First, we should confirm that the user will be created even with the list of roles missing. We can do this just by creating a second <code>new_user</code> object that is missing the list of roles.</p><div class=tab-panel data-tab-group=af464eb2ea51bf76c27fda0001a83836><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("af464eb2ea51bf76c27fda0001a83836","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// New user structure for creating users without roles
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>new_user_no_roles</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;test_user_no_roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;POST /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user_no_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>We should also write a test to make sure the process will fail if any required attributes (in this case, just <code>username</code>) are missing. We can even check the output to make sure the missing attribute is listed:</p><div class=tab-panel data-tab-group=fa0b9f86424362ce471c20b2d3b3515d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fa0b9f86424362ce471c20b2d3b3515d","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Fails to create user with missing required attribute
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>createUserFailsOnMissingRequiredAttribute</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>attr</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should fail when required attribute &#39;&#34;</span> <span class=o>+</span> <span class=nx>attr</span> <span class=o>+</span> <span class=s2>&#34;&#39; is missing&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Create a copy of the user object and delete the given attribute
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>updated_user</span> <span class=o>=</span> <span class=p>{...</span> <span class=nx>user</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>delete</span> <span class=nx>updated_user</span><span class=p>[</span><span class=nx>attr</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>updated_user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>422</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;errors&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// the error should be related to the deleted attribute
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>e</span><span class=p>.</span><span class=nx>attribute</span> <span class=o>===</span> <span class=nx>attr</span><span class=p>)).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;POST /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user_no_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnMissingRequiredAttribute</span><span class=p>(</span><span class=nx>new_user</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><h3 id=duplicate-username-1>Duplicate Username</h3><p>We also should write a unit test that will make sure we cannot create a user with a duplicate username.</p><div class=tab-panel data-tab-group=2d72b45632781a53853231f6774addc6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2d72b45632781a53853231f6774addc6","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Fails to create user with a duplicate username
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>createUserFailsOnDuplicateUsername</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should fail on duplicate username &#39;&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>201</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>created_id</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find user in list of all users
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>foundUser</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>created_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>foundUser</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Try to create same user again
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>422</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;errors&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>// the error should be related to the username attribute
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>expect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                  <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>e</span><span class=p>.</span><span class=nx>attribute</span> <span class=o>===</span> <span class=s2>&#34;username&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>              <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;POST /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user_no_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnMissingRequiredAttribute</span><span class=p>(</span><span class=nx>new_user</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnDuplicateUsername</span><span class=p>(</span><span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This test builds upon the previous <code>createUser</code> test by first creating the user, and then confirming that it appears in the output, before trying to create it again. This time, it should fail, so we can borrow some of the code from the <code>createUserFailsOnMissingRequiredAttribute</code> to confirm that it is failing because of a duplicate username.</p><h3 id=invalid-roles-1>Invalid Roles</h3><p>Finally, we should write a unit test that makes sure a user won&rsquo;t be created if any invalid role IDs are used, and also that the database transaction is properly rolled back so that the user itself isn&rsquo;t created.</p><div class=tab-panel data-tab-group=0e6a2b8bce53e27f5a5f85174e3bacee><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0e6a2b8bce53e27f5a5f85174e3bacee","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Fails to create user with bad role ID
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>createUserFailsOnInvalidRole</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>role_id</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should fail when invalid role id &#39;&#34;</span> <span class=o>+</span> <span class=nx>role_id</span> <span class=o>+</span> <span class=s2>&#34;&#39; is used&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Create a copy of the user object
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>updated_user</span> <span class=o>=</span> <span class=p>{</span> <span class=p>...</span><span class=nx>user</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Make a shallow copy of the roles array
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>updated_user</span><span class=p>.</span><span class=nx>roles</span> <span class=o>=</span> <span class=p>[...</span> <span class=nx>user</span><span class=p>.</span><span class=nx>roles</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Add invalid role ID to user object
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>updated_user</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span><span class=o>:</span> <span class=nx>role_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>updated_user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>422</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// User with invalid roles should not be created
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>username</span> <span class=o>===</span> <span class=nx>updated_user</span><span class=p>.</span><span class=nx>username</span><span class=p>)).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;POST /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user_no_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnMissingRequiredAttribute</span><span class=p>(</span><span class=nx>new_user</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnDuplicateUsername</span><span class=p>(</span><span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnInvalidRole</span><span class=p>(</span><span class=nx>new_user</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnInvalidRole</span><span class=p>(</span><span class=nx>new_user</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnInvalidRole</span><span class=p>(</span><span class=nx>new_user</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnInvalidRole</span><span class=p>(</span><span class=nx>new_user</span><span class=p>,</span> <span class=s2>&#34;test&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This test will try to create a valid user, but it appends an invalid role ID to the list of roles to assign to the user. It also confirms that the user itself is not created by querying the get all endpoint and checking for a matching username.</p><p>There we go! We have a set of unit tests that cover most of the situations we can anticipate seeing with our route to create new users. If we run all of these tests at this point, they should all pass:</p><div class=tab-panel data-tab-group=20dea6649a7d793a0b236dca8d6e8284><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("20dea6649a7d793a0b236dca8d6e8284","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>    POST /
      ‚úî should successfully create a user &#39;test_user&#39;
      ‚úî should successfully create a user &#39;test_user_no_roles&#39;
      ‚úî should fail when required attribute &#39;username&#39; is missing
      ‚úî should fail on duplicate username &#39;test_user&#39;
      ‚úî should fail when invalid role id &#39;0&#39; is used
      ‚úî should fail when invalid role id &#39;-1&#39; is used
      ‚úî should fail when invalid role id &#39;8&#39; is used
      ‚úî should fail when invalid role id &#39;test&#39; is used</code></pre></div></div></div></div></div><p>Great! Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub before continuing.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=update>Update</h1><a href="https://www.youtube.com/watch?v=wH6SmYAGRLs">YouTube Video</a><h2 id=update-route>Update Route</h2><p>Next, let&rsquo;s look at adding an additional route in our application that allows us to update a <code>User</code> model. This route is very similar to the route used to create a user, but there are a few key differences as well.</p><div class=tab-panel data-tab-group=9743442ea3fef4d6c185b8700c1d92a1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9743442ea3fef4d6c185b8700c1d92a1","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Update a user
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/v1/users/{id}:
</span></span></span><span class=line><span class=cl><span class=cm> *   put:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: update user
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     parameters:
</span></span></span><span class=line><span class=cl><span class=cm> *       - in: path
</span></span></span><span class=line><span class=cl><span class=cm> *         name: id
</span></span></span><span class=line><span class=cl><span class=cm> *         required: true
</span></span></span><span class=line><span class=cl><span class=cm> *         schema:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *         description: user ID
</span></span></span><span class=line><span class=cl><span class=cm> *     requestBody:
</span></span></span><span class=line><span class=cl><span class=cm> *       description: user
</span></span></span><span class=line><span class=cl><span class=cm> *       required: true
</span></span></span><span class=line><span class=cl><span class=cm> *       content:
</span></span></span><span class=line><span class=cl><span class=cm> *         application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *           schema:
</span></span></span><span class=line><span class=cl><span class=cm> *             $ref: &#39;#/components/schemas/User&#39;
</span></span></span><span class=line><span class=cl><span class=cm> *           example:
</span></span></span><span class=line><span class=cl><span class=cm> *             username: updateduser
</span></span></span><span class=line><span class=cl><span class=cm> *             roles:
</span></span></span><span class=line><span class=cl><span class=cm> *               - id: 6
</span></span></span><span class=line><span class=cl><span class=cm> *               - id: 7
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       201:
</span></span></span><span class=line><span class=cl><span class=cm> *         $ref: &#39;#/components/responses/Success&#39;
</span></span></span><span class=line><span class=cl><span class=cm> *       422:
</span></span></span><span class=line><span class=cl><span class=cm> *         $ref: &#39;#/components/responses/ValidationError&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=s2>&#34;/:id&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findByPk</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// if the user is not found, return an HTTP 404 not found status code
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span> <span class=o>===</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>404</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>database</span><span class=p>.</span><span class=nx>transaction</span><span class=p>(</span><span class=kr>async</span> <span class=p>(</span><span class=nx>t</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>user</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Update the user object using body attributes
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>username</span><span class=o>:</span> <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Assign to a database transaction
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>transaction</span><span class=o>:</span> <span class=nx>t</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// If roles are included in the body
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>roles</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Find all roles listed
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=kr>await</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>map</span><span class=p>(({</span> <span class=nx>id</span><span class=p>,</span> <span class=p>...</span><span class=nx>next</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>return</span> <span class=nx>Role</span><span class=p>.</span><span class=nx>findByPk</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}),</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>          <span class=c1>// Attach roles to user
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=kr>await</span> <span class=nx>user</span><span class=p>.</span><span class=nx>setRoles</span><span class=p>(</span><span class=nx>roles</span><span class=p>,</span> <span class=p>{</span> <span class=nx>transaction</span><span class=o>:</span> <span class=nx>t</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Remove all roles
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=kr>await</span> <span class=nx>user</span><span class=p>.</span><span class=nx>setRoles</span><span class=p>([],</span> <span class=p>{</span> <span class=nx>transaction</span><span class=o>:</span> <span class=nx>t</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// Send the success message
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>sendSuccess</span><span class=p>(</span><span class=s2>&#34;User saved!&#34;</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=mi>201</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>error</span> <span class=k>instanceof</span> <span class=nx>ValidationError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>handleValidationError</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>As we can see, overall this route is very similar to the create route. The only major difference is that we must first find the user we want to update based on the query parameter, and then we use the <code>update</code> database method to update the existing values in the database. The rest of the work updating the related <code>Roles</code> models is exactly the same. We can also reuse the utility functions we created for the previous route.</p><p>Just like we did earlier, we can test this route using the Open API documentation website to confirm that it is working correctly before we even move on to testing it.</p><h2 id=unit-testing-update-route>Unit Testing Update Route</h2><p>The unit tests for the route to update a user are very similar to the ones used for creating a user. First, we need a test that will confirm we can successfully update a user entry:</p><div class=tab-panel data-tab-group=9e9b051e4984fab149335646fc9cd2da><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9e9b051e4984fab149335646fc9cd2da","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Update a user successfully
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>updateUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should successfully update user ID &#39;&#34;</span> <span class=o>+</span> <span class=nx>id</span> <span class=o>+</span> <span class=s2>&#34;&#39; to &#39;&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>201</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>id</span><span class=p>).</span><span class=nx>equal</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find user in list of all users
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>foundUser</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>foundUser</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;PUT /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUser</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Next, we also want to check that any updated users have the correct roles attached, including instances where the roles were completely removed:</p><div class=tab-panel data-tab-group=7c6dbd2b99cd2ee455687e4e46c05e1e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7c6dbd2b99cd2ee455687e4e46c05e1e","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Update a user and roles successfully
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>updateUserAndRoles</span> <span class=o>=</span> <span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should successfully update user ID &#39;&#34;</span> <span class=o>+</span> <span class=nx>id</span> <span class=o>+</span> <span class=s2>&#34;&#39; roles&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>201</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>id</span><span class=p>).</span><span class=nx>equal</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find user in list of all users
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>foundUser</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Handle case where user has no roles assigned
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=nx>user</span><span class=p>.</span><span class=nx>roles</span> <span class=o>||</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=nx>foundUser</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>foundUser</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=nx>roles</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>expect</span><span class=p>(</span><span class=nx>foundUser</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>role</span><span class=p>.</span><span class=nx>id</span><span class=p>)).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;PUT /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUser</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=nx>new_user_no_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>We also should check that the username is unchanged if an update is sent with no username attribute, but the rest of the update will succeed. For this test, we can just create a new mock object with just roles and no username included.</p><div class=tab-panel data-tab-group=3a959eca64bc14786d6d0bfd9d4c3602><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3a959eca64bc14786d6d0bfd9d4c3602","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Update user structure with only roles
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>update_user_only_roles</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span><span class=o>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span><span class=o>:</span> <span class=mi>7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;PUT /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUser</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=nx>new_user_no_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nx>update_user_only_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Finally, we should include a couple of tests to handle the situation where a duplicate username is provided, or where an invalid role is provided. These are nearly identical to the tests used in the create route earlier in this example:</p><div class=tab-panel data-tab-group=7338dd8879a180042c8ba51aae04465c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7338dd8879a180042c8ba51aae04465c","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Fails to update user with a duplicate username
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>updateUserFailsOnDuplicateUsername</span> <span class=o>=</span> <span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should fail on duplicate username &#39;&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>422</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;errors&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// the error should be related to the username attribute
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>expect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>e</span><span class=p>.</span><span class=nx>attribute</span> <span class=o>===</span> <span class=s2>&#34;username&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Fails to update user with bad role ID
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>updateUserFailsOnInvalidRole</span> <span class=o>=</span> <span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=nx>user</span><span class=p>,</span> <span class=nx>role_id</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should fail when invalid role id &#39;&#34;</span> <span class=o>+</span> <span class=nx>role_id</span> <span class=o>+</span> <span class=s2>&#34;&#39; is used&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Create a copy of the user object
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>updated_user</span> <span class=o>=</span> <span class=p>{</span> <span class=p>...</span><span class=nx>user</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Make a shallow copy of the roles array
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>updated_user</span><span class=p>.</span><span class=nx>roles</span> <span class=o>=</span> <span class=p>[...</span> <span class=nx>user</span><span class=p>.</span><span class=nx>roles</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Add invalid role ID to user object
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>updated_user</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span><span class=o>:</span> <span class=nx>role_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>updated_user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>422</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// User with invalid roles should not be updated
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>username</span> <span class=o>===</span> <span class=nx>updated_user</span><span class=p>.</span><span class=nx>username</span><span class=p>)).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Update user structure with duplicate username
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>update_user_duplicate_username</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;PUT /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUser</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=nx>new_user_no_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nx>update_user_only_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserFailsOnDuplicateUsername</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=nx>update_user_duplicate_username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserFailsOnInvalidRole</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserFailsOnInvalidRole</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserFailsOnInvalidRole</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>,</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserFailsOnInvalidRole</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>,</span> <span class=s2>&#34;test&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>There we go! We have a set of unit tests that cover most of the situations we can anticipate seeing with our route to update users. If we run all of these tests at this point, they should all pass:</p><div class=tab-panel data-tab-group=6f0ec7ac82ee32bba8d8f59a9ff761e3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6f0ec7ac82ee32bba8d8f59a9ff761e3","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>    PUT /{id}
      ‚úî should successfully update user ID &#39;3&#39; to &#39;test_user&#39;
      ‚úî should successfully update user ID &#39;3&#39; roles
      ‚úî should successfully update user ID &#39;2&#39; roles
      ‚úî should successfully update user ID &#39;1&#39; roles
      ‚úî should fail on duplicate username &#39;admin&#39;
      ‚úî should fail when invalid role id &#39;0&#39; is used
      ‚úî should fail when invalid role id &#39;-1&#39; is used
      ‚úî should fail when invalid role id &#39;8&#39; is used
      ‚úî should fail when invalid role id &#39;test&#39; is used</code></pre></div></div></div></div></div><p>Great! Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub before continuing.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=delete>Delete</h1><a href="https://www.youtube.com/watch?v=ujGaXQjq_z4">YouTube Video</a><h2 id=delete-route>Delete Route</h2><p>Finally, the last route we need to add to our <code>users</code> routes is the delete route. This route is very simple - it will remove a user based on the given user ID if it exists in the database:</p><div class=tab-panel data-tab-group=f8089ca399f96174230734cba153d743><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f8089ca399f96174230734cba153d743","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Delete a user
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/v1/users/{id}:
</span></span></span><span class=line><span class=cl><span class=cm> *   delete:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: delete user
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     parameters:
</span></span></span><span class=line><span class=cl><span class=cm> *       - in: path
</span></span></span><span class=line><span class=cl><span class=cm> *         name: id
</span></span></span><span class=line><span class=cl><span class=cm> *         required: true
</span></span></span><span class=line><span class=cl><span class=cm> *         schema:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *         description: user ID
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         $ref: &#39;#/components/responses/Success&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=s2>&#34;/:id&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findByPk</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// if the user is not found, return an HTTP 404 not found status code
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span> <span class=o>===</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>404</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>user</span><span class=p>.</span><span class=nx>destroy</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Send the success message
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>sendSuccess</span><span class=p>(</span><span class=s2>&#34;User deleted!&#34;</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=mi>200</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Once again, we can test this route using the Open API documentation website. Let&rsquo;s look at how we can quickly unit test it as well.</p><h2 id=unit-testing-delete-route>Unit Testing Delete Route</h2><p>The unit tests for this route are similarly very simple. We really only have two cases - the user is found and successfully deleted, or the user cannot be found and an HTTP 404 response is returned.</p><div class=tab-panel data-tab-group=c01ec3176140cb1106a44258df40fcb4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c01ec3176140cb1106a44258df40fcb4","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Delete a user successfully
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>deleteUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>id</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should successfully delete user ID &#39;&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>id</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nb>String</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Ensure user is not found in list of users
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>id</span><span class=p>)).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Fail to delete a missing user
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>deleteUserFailsInvalidId</span><span class=o>=</span> <span class=p>(</span><span class=nx>id</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should fail to delete invalid user ID &#39;&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>404</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;DELETE /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>deleteUser</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>deleteUserFailsInvalidId</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>deleteUserFailsInvalidId</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>deleteUserFailsInvalidId</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>deleteUserFailsInvalidId</span><span class=p>(</span><span class=s2>&#34;test&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>There we go! That will cover all of the unit tests for the <code>users</code> route. If we try to run all of our tests, we should see that they succeed!</p><div class=tab-panel data-tab-group=373cd0ab6b87488a05b83a261dc4e801><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("373cd0ab6b87488a05b83a261dc4e801","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>DELETE /{id}
      ‚úî should successfully delete user ID &#39;4
      ‚úî should fail to delete invalid user ID &#39;0
      ‚úî should fail to delete invalid user ID &#39;-1
      ‚úî should fail to delete invalid user ID &#39;5
      ‚úî should fail to delete invalid user ID &#39;test</code></pre></div></div></div></div></div><p>All told, we write just 5 API routes (retrieve all, retrieve one, create, update, and delete) but wrote 53 different unit tests to fully test those routes.</p><p>Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub.</p><p>In the next example, we&rsquo;ll explore how to add authentication to our RESTful API.</p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=authentication>Authentication</h1><p>This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li>An authentication system using <a href=https://www.passportjs.org/ rel=external target=_blank>Passport.js</a> and <a href=https://apereo.github.io/cas/7.1.x/index.html rel=external target=_blank>CAS</a></li><li>Valid JSON Web Tokens (JWTs) for authentication within the RESTful API</li><li>Proper middleware to verify users have the correct role for each operation in the API</li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Authentication</h1><article class=default><header class=headline></header><h1 id=bypass-auth>Bypass Auth</h1><a href="https://www.youtube.com/watch?v=NjrWPg41_B4">YouTube Video</a><h2 id=authentication-libraries>Authentication Libraries</h2><p>There are many different authentication libraries and methods available for Node.js and Express. For this project, we will use the <a href=https://www.passportjs.org/ rel=external target=_blank>Passport.js</a> library. It supports many different authentication strategy, and is a very common way that authentication is handled within JavaScript applications.</p><p>For our application, we&rsquo;ll end up using several strategies to authenticate our users:</p><ul><li><a href=https://www.passportjs.org/packages/passport-unique-token/ rel=external target=_blank>Unique Token</a> - used to bypass authentication for testing</li><li><a href=https://github.com/appdevdesigns/passport-cas rel=external target=_blank>CAS</a> - used to authenticate with <a href=https://apereo.github.io/cas/7.1.x/index.html rel=external target=_blank>Central Authentication Service (CAS)</a> servers such as those used at K-State</li><li><a href=https://www.passportjs.org/packages/passport-jwt-cookiecombo/ rel=external target=_blank>JSON Web Tokens (JWT)</a> - used to identify user requests to the API itself</li></ul><p>Let&rsquo;s first set up our unique token strategy, which allows us to test our authentication routes before setting up anything else.</p><h2 id=authentication-router>Authentication Router</h2><p>First, we&rsquo;ll need to create a new route file at <code>routes/auth.js</code> to contain our authentication routes. We&rsquo;ll start with this basic structure and work on filling in each method as we go.</p><div class=tab-panel data-tab-group=d06eb601aed658180f0c97e5884d3bec><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d06eb601aed658180f0c97e5884d3bec","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Auth router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: auth
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Authentication Routes
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   securitySchemes:
</span></span></span><span class=line><span class=cl><span class=cm> *     bearerAuth:
</span></span></span><span class=line><span class=cl><span class=cm> *       type: http
</span></span></span><span class=line><span class=cl><span class=cm> *       scheme: bearer
</span></span></span><span class=line><span class=cl><span class=cm> *       bearerFormat: JWT
</span></span></span><span class=line><span class=cl><span class=cm> *   responses:
</span></span></span><span class=line><span class=cl><span class=cm> *     AuthToken:
</span></span></span><span class=line><span class=cl><span class=cm> *       description: authentication success
</span></span></span><span class=line><span class=cl><span class=cm> *       content:
</span></span></span><span class=line><span class=cl><span class=cm> *         application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *           schema:
</span></span></span><span class=line><span class=cl><span class=cm> *             type: object
</span></span></span><span class=line><span class=cl><span class=cm> *             required:
</span></span></span><span class=line><span class=cl><span class=cm> *               - token
</span></span></span><span class=line><span class=cl><span class=cm> *             properties:
</span></span></span><span class=line><span class=cl><span class=cm> *               token:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                 description: a JWT for the user
</span></span></span><span class=line><span class=cl><span class=cm> *             example:
</span></span></span><span class=line><span class=cl><span class=cm> *               token: abcdefg12345
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;../configs/auth.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Authentication Response Handler
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>authSuccess</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Bypass authentication for testing
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/bypass:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: bypass authentication for testing
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Bypasses CAS authentication for testing purposes
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     parameters:
</span></span></span><span class=line><span class=cl><span class=cm> *       - in: query
</span></span></span><span class=line><span class=cl><span class=cm> *         name: token
</span></span></span><span class=line><span class=cl><span class=cm> *         required: true
</span></span></span><span class=line><span class=cl><span class=cm> *         schema:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *         description: username
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/bypass&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * CAS Authentication
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/cas:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: CAS authentication
</span></span></span><span class=line><span class=cl><span class=cm> *     description:  CAS authentication for deployment
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/cas&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Request JWT based on previous authentication
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/token:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: request JWT 
</span></span></span><span class=line><span class=cl><span class=cm> *     description: request JWT based on previous authentication
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         $ref: &#39;#/components/responses/AuthToken&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/token&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This file includes a few items to take note of:</p><ul><li>In the top-level Open API comment, we define a new <code>AuthToken</code> response that we&rsquo;ll send to the user when they request a token.</li><li>We create three routes. The first two, <code>/auth/bypass</code> and <code>/auth/cas</code>, for each of our authentication strategies. The last one, <code>/auth/token</code> will be used by our frontend to request a token to access the API.</li><li>Finally, we&rsquo;ll build a <code>authSuccess</code> function to handle actually sending the response to the user</li></ul><p>Before moving on, let&rsquo;s go ahead and add this router to our <code>app.js</code> file along with the other routers:</p><div class=tab-panel data-tab-group=0b8b3ea848b70c18e97e51e8c5d6d780><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0b8b3ea848b70c18e97e51e8c5d6d780","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/index.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>apiRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/api.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>authRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/auth.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Use routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/api&#34;</span><span class=p>,</span> <span class=nx>apiRouter</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=nx>authRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll come back to this file once we are ready to link up our authentication strategies.</p><h2 id=unique-token-authentication>Unique Token Authentication</h2><p>Next, let&rsquo;s install both <code>passport</code> and the <code>passport-unique-token</code> authentication strategy:</p><div class=tab-panel data-tab-group=3f4e66483a856458d0bad9c8444f8a35><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3f4e66483a856458d0bad9c8444f8a35","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install passport passport-unique-token</span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll configure that strategy in a new <code>configs/auth.js</code> file with the following content:</p><div class=tab-panel data-tab-group=3c0c9c23a04131a94631ce8f8ff987c7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3c0c9c23a04131a94631ce8f8ff987c7","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Passport.js Authentication
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UniqueTokenStrategy</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;passport-unique-token&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Authenticate a user
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} username the username to authenticate
</span></span></span><span class=line><span class=cl><span class=cm> * @param {function} next the next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>authenticateUser</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Find user with the username
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span> 
</span></span><span class=line><span class=cl>    <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>username</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// User not found
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span> <span class=o>===</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Login failed for user: &#34;</span> <span class=o>+</span> <span class=nx>username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// User authenticated
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Login succeeded for user: &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Convert Sequelize object to plain JavaScript object
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>user</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>user</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Bypass Authentication via Token
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=k>new</span> <span class=nx>UniqueTokenStrategy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=c1>// verify callback function
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>authenticateUser</span><span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Default functions to serialize and deserialize a session
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>serializeUser</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>done</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>passport</span><span class=p>.</span><span class=nx>deserializeUser</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>done</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this file, we created an <code>authenticateUser</code> function that will look for a user based on a given username. If found, it will return that user by calling the <code>next</code> middleware function. Otherwise, it will call that function and provide <code>false</code>.</p><p>Below, we configure Passport.js using the <code>passport.use</code> function to define the various authentication strategies we want to use. In this case, we&rsquo;ll start with the <a href=https://www.passportjs.org/packages/passport-unique-token/ rel=external target=_blank>Unique Token Strategy</a>, which uses a token provided as part of a query to the web server.</p><p>In addition, we need to implement some default functions to handle serializing and deserializing a user from a session. These functions don&rsquo;t really have any content in our implementation; we just need to include the default code.</p><p>Finally, since Passport.js acts as a global object, we don&rsquo;t even have to export anything from this file!</p><h2 id=testing-authentication>Testing Authentication</h2><p>To test this authentication strategy, let&rsquo;s modify <code>routes/auth.js</code> to use this strategy. We&rsquo;ll update the <code>/auth/bypass</code> route and also add some temporary code to the <code>authSuccess</code> function:</p><div class=tab-panel data-tab-group=812d3ac2a81480e4b75f46b4a709cacd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("812d3ac2a81480e4b75f46b4a709cacd","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import configurations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;../configs/auth.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>authSuccess</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/bypass&#34;</span><span class=p>,</span> <span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>,</span> <span class=p>{</span><span class=nx>session</span><span class=o>:</span> <span class=kc>false</span><span class=p>}),</span> <span class=nx>authSuccess</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>In the <code>authSuccess</code> function, right now we are just sending the content of <code>req.user</code>, which is set by Passport.js on a successful authentication (it is the value we returned when calling the <code>next</code> function in our authentication strategy earlier). We&rsquo;ll come back to this later when we implement JSON Web Tokens (JWT) later in this tutorial.</p><p>The other major change is that now the <code>/auth/bypass</code> route calls the <code>passport.authenticate</code> method with the <code>'token'</code> strategy specified. It also uses <code>{session: false}</code> as one of the options provided to Passport.js since we aren&rsquo;t actually going to be using sessions. Finally, if that middleware is satisfied, it will call the <code>authSuccess</code> function to handle sending the response to the user. This takes advantage of the chaining that we can do in Express!</p><p>With all of that in place, we can test our server and see if it works:</p><div class=tab-panel data-tab-group=7f924c38434e98f45f4d342990799ec8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7f924c38434e98f45f4d342990799ec8","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once the page loads, we want to navigate to the <code>/auth/bypass?token=admin</code> path to see if we can log in as the <code>admin</code> user. Notice that we are including a query parameter named <code>token</code> to include the username in the URL.</p><p><a href=#R-image-e00bb1795b40bb43e9887cff3039fb2b class=lightbox-link><img alt="Successful Authentication" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e00bb1795b40bb43e9887cff3039fb2b><img alt="Successful Authentication" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_1.png></a></p><p>There we go! We see that it successfully finds our <code>admin</code> user and returns data about that user, including the roles assigned. This is what we want to see. We can also test this by providing other usernames to make sure it is working.</p><h2 id=securing-authentication>Securing Authentication</h2><p>Of course, we don&rsquo;t want to have this bypass authentication system available all the time in our application. In fact, we really only want to use it for testing and debugging; otherwise, our application will have a major security flaw! So, let&rsquo;s add a new environment variable <code>BYPASS_AUTH</code> to our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. We should set it to <code>TRUE</code> in the <code>.env.test</code> file, and for now we&rsquo;ll have it enabled in our <code>.env</code> file as well, but this option should <strong>NEVER</strong> be enabled in a production setting.</p><div class=tab-panel data-tab-group=cf0865eeec0d97b920d098725bb0b47d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cf0865eeec0d97b920d098725bb0b47d","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=nv>BYPASS_AUTH</span><span class=o>=</span>true</span></span></code></pre></div></div></div></div></div><p>With that setting in place, we can add it to our <code>configs/auth.js</code> file to only allow bypass authentication if that setting is enabled:</p><div class=tab-panel data-tab-group=8034ba7442a5850d6ce4e4b78e9d00c1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8034ba7442a5850d6ce4e4b78e9d00c1","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Bypass Authentication via Token
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=k>new</span> <span class=nx>UniqueTokenStrategy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=c1>// verify callback function
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Only allow token authentication when enabled
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>BYPASS_AUTH</span> <span class=o>===</span> <span class=s2>&#34;true&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>authenticateUser</span><span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>))</span></span></span></code></pre></div></div></div></div></div><p>Before moving on, we should make sure we test both enabling and disabling this setting <em>actually</em> disables bypass authentication. We want to be absolutely sure it works as intended!</p><p><a href=#R-image-8f5c41467908f23139c9d5544294496b class=lightbox-link><img alt="Disabled Authentication" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8f5c41467908f23139c9d5544294496b><img alt="Disabled Authentication" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_2.png></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cookie-sessions>Cookie Sessions</h1><a href="https://www.youtube.com/watch?v=HR3gG-9bwts">YouTube Video</a><h2 id=cookie-sessions>Cookie Sessions</h2><p>One of the most common methods for keeping track of users after they are authenticated is by setting a cookie on their browser that is sent with each request. We&rsquo;ve already explored this method earlier in this course, so let&rsquo;s go ahead and configure cookie sessions for our application, storing them in our existing database.</p><p>We&rsquo;ll start by installing both the <a href=https://www.npmjs.com/package/express-session rel=external target=_blank>express-session</a> middleware and the <a href=https://www.npmjs.com/package/connect-session-sequelize rel=external target=_blank>connect-session-sequelize</a> library that we can use to store our sessions in a Sequelize database:</p><div class=tab-panel data-tab-group=ea8593252b88b408c1d6f0b0c222a57e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ea8593252b88b408c1d6f0b0c222a57e","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install express-session connect-session-sequelize</span></span></code></pre></div></div></div></div></div><p>Once those libraries are installed, we can create a configuration for sessions in a new <code>configs/sessions.js</code> file:</p><div class=tab-panel data-tab-group=210072a29308b405b9aca8adb054597f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configssessionsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("210072a29308b405b9aca8adb054597f","configssessionsjs")'>
<span class=tab-nav-text>configs/sessions.js</span></button></div><div class=tab-content-container><div data-tab-item=configssessionsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration for cookie sessions stored in Sequelize
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports sequelizeSession a Session instance configured for Sequelize
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>session</span> <span class=nx>from</span> <span class=s1>&#39;express-session&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>connectSession</span> <span class=nx>from</span> <span class=s1>&#39;connect-session-sequelize&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s1>&#39;./database.js&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;./logger.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Initialize Store
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>sequelizeStore</span> <span class=o>=</span> <span class=nx>connectSession</span><span class=p>(</span><span class=nx>session</span><span class=p>.</span><span class=nx>Store</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>store</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>sequelizeStore</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=o>:</span> <span class=nx>database</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create tables in Sequelize
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>store</span><span class=p>.</span><span class=nx>sync</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_SECRET</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&#34;Cookie session secret not set! Set a SESSION_SECRET environment variable.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Session configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>sequelizeSession</span> <span class=o>=</span> <span class=nx>session</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_NAME</span> <span class=o>||</span> <span class=s1>&#39;connect.sid&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>secret</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_SECRET</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>store</span><span class=o>:</span> <span class=nx>store</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=nx>resave</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>proxy</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>saveUninitialized</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>sequelizeSession</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This file loads our Sequelize database connection and initializes the Express session middleware and the Sequelize session store. We also have a quick sanity check that will ensure there is a <code>SESSION_SECRET</code> environment variable set, otherwise an error will be printed. Finally, we export that session configuration to our application.</p><p>So, we&rsquo;ll need to add a <code>SESSION_NAME</code> and <code>SESSION_SECRET</code> environment variable to our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. The <code>SESSION_NAME</code> is a unique name for our cookie, and the <code>SESSION_SECRET</code> is a secret key used to secure our cookies and prevent them from being modified.</p><p>There are many ways to generate a secret key, but one of the simplest is to just use the built in functions in Node.js itself. We can launch the Node.js <a href=https://nodejs.org/en/learn/command-line/how-to-use-the-nodejs-repl rel=external target=_blank>REPL</a> environment by just running the <code>node</code> command in the terminal:</p><div class=tab-panel data-tab-group=05f78b93875f0bd015e70af65f84b2ac><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("05f78b93875f0bd015e70af65f84b2ac","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node</span></span></code></pre></div></div></div></div></div><p>From there, we can use this line to get a random secret key:</p><div class=tab-panel data-tab-group=6fcb7c16bf9f8885e9a9431ae7476a85><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=node class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6fcb7c16bf9f8885e9a9431ae7476a85","node")'>
<span class=tab-nav-text>node</span></button></div><div class=tab-content-container><div data-tab-item=node class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;crypto&#39;</span><span class=p>).</span><span class=nx>randomBytes</span><span class=p>(</span><span class=mi>64</span><span class=p>).</span><span class=nx>toString</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>)</span></span></span></code></pre></div></div></div></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Documenting Terminal Commands</div><div class=box-content><p>Just like we use <code>$</code> as the prompt for Linux terminal commands, the Node.js REPL environment uses <code>></code> so we will include that in our documentation. You should not include that character in your command.</p></div></div><p>If done correctly, we&rsquo;ll get a random string that you can use as your secret key!</p><p><a href=#R-image-b833575f0e3eea74e781be3e584fb6f5 class=lightbox-link><img alt="Secret Key" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b833575f0e3eea74e781be3e584fb6f5><img alt="Secret Key" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_3.png></a></p><p>We can include that key in our <code>.env</code> file. To help remember how to do this in the future, we can even include the Node.js command as a comment above that line:</p><div class=tab-panel data-tab-group=dc75b582d7d89ad9c8ec403c52594401><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("dc75b582d7d89ad9c8ec403c52594401","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=nv>SESSION_NAME</span><span class=o>=</span>lostcommunities
</span></span><span class=line><span class=cl><span class=c1># require(&#39;crypto&#39;).randomBytes(64).toString(&#39;hex&#39;)</span>
</span></span><span class=line><span class=cl><span class=nv>SESSION_SECRET</span><span class=o>=</span>46a5fdfe16fa710867102d1f0dbd2329f2eae69be3ed56ca084d9e0ad....</span></span></code></pre></div></div></div></div></div><p>Finally, we can update our <code>app.js</code> file to use this session configuration. We&rsquo;ll place this between the <code>/api</code> and <code>/auth</code> routes, since we only want to load cookie sessions if the user is accessing the authentication routes, to minimize the number of database requests:</p><div class=tab-panel data-tab-group=022944e2bd71f8d0124371ebede3c4b3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("022944e2bd71f8d0124371ebede3c4b3","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>compression</span> <span class=nx>from</span> <span class=s2>&#34;compression&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s2>&#34;cookie-parser&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>helmet</span> <span class=nx>from</span> <span class=s2>&#34;helmet&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s2>&#34;path&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>swaggerUi</span> <span class=nx>from</span> <span class=s2>&#34;swagger-ui-express&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>openapi</span> <span class=nx>from</span> <span class=s2>&#34;./configs/openapi.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>sessions</span> <span class=nx>from</span> <span class=s2>&#34;./configs/sessions.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Use routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/api&#34;</span><span class=p>,</span> <span class=nx>apiRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Use sessions
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>sessions</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s2>&#34;session&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use auth routes
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=nx>authRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>There we go! Now we can enable cookie sessions in Passport.js by removing the <code>{session: false}</code> setting in our <code>/auth/bypass</code> route in the <code>routes/auth.js</code> file:</p><div class=tab-panel data-tab-group=6b4caab527847807f997cf5bbc0f236b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6b4caab527847807f997cf5bbc0f236b","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/bypass&#34;</span><span class=p>,</span> <span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>),</span> <span class=nx>authSuccess</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we navigate to that route and authenticate, we should see our application set a session cookie as part of the response.</p><p><a href=#R-image-b7b4884c4e7fa9c83a0aa419eb3dee6f class=lightbox-link><img alt="Cookie Session" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_7.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b7b4884c4e7fa9c83a0aa419eb3dee6f><img alt="Cookie Session" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_7.png></a></p><p>We can match the SID in the session cookie with the SID in the <code>Sessions</code> table in our database to confirm that it is working:</p><p><a href=#R-image-8394615f830be458b8f722b1f047efae class=lightbox-link><img alt="Cookie Session in Database" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_8.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8394615f830be458b8f722b1f047efae><img alt="Cookie Session in Database" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_8.png></a></p><p>From here, we can use these sessions throughout our application to track users as they make additional requests.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=json-web-token>JSON Web Token</h1><a href="https://www.youtube.com/watch?v=j9tzO3bQxxs">YouTube Video</a><h2 id=json-web-tokens-jwt>JSON Web Tokens (JWT)</h2><p>Now that we have a working authentication system, the next step is to configure a method to request a valid JSON Web Token, or JWT, that contains information about the authenticated user. We&rsquo;ve already learned a bit about JWTs in this course, so we won&rsquo;t cover too many of the details here.</p><p>To work with JWTs, we&rsquo;ll need to install the <a href=https://www.npmjs.com/package/jsonwebtoken rel=external target=_blank>jsonwebtoken</a> package from NPM:</p><div class=tab-panel data-tab-group=9ec28899e60d183d3cf5af3feeb9786c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9ec28899e60d183d3cf5af3feeb9786c","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install jsonwebtoken</span></span></code></pre></div></div></div></div></div><p>Next, we&rsquo;ll need to create a secret key that we can use to sign our tokens. We&rsquo;ll add this as the <code>JWT_SECRET_KEY</code> setting in our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. We can use the same method discussed on the previous page to generate a new random key:</p><div class=tab-panel data-tab-group=349724cb3935934a8719501405d9ef61><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("349724cb3935934a8719501405d9ef61","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=c1># require(&#39;crypto&#39;).randomBytes(64).toString(&#39;hex&#39;)</span>
</span></span><span class=line><span class=cl><span class=nv>JWT_SECRET_KEY</span><span class=o>=</span><span class=s1>&#39;46a5fdfe16fa710867102d1f0dbd2329f2eae69be3ed56ca084d9e0ad....&#39;</span></span></span></code></pre></div></div></div></div></div><p>Once we have the library and a key, we can easily create and sign a JWT in the <code>/auth/token</code> route in the <code>routes/auth.js</code> file:</p><div class=tab-panel data-tab-group=33c8d0f52b804c0d834bcb5f2143c038><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("33c8d0f52b804c0d834bcb5f2143c038","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>jsonwebtoken</span> <span class=nx>from</span> <span class=s2>&#34;jsonwebtoken&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/token&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// If user is logged in
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>JWT_SECRET_KEY</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>expiresIn</span><span class=o>:</span> <span class=s1>&#39;6h&#39;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>token</span><span class=o>:</span> <span class=nx>token</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Send unauthorized response
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Now, when we visit the <code>/auth/token</code> URL on our working website (after logging in through the <code>/auth/bypass</code> route), we should receive a JWT as a response:</p><p><a href=#R-image-3ce21a60c54ea2c452242407aebb6411 class=lightbox-link><img alt="JWT Response" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3ce21a60c54ea2c452242407aebb6411><img alt="JWT Response" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_4.png></a></p><p>Of course, while that data may seem unreadable, we already know that JWTs are Base64 encoded, so we can easily view the content of the token. Thankfully, there are many great tools we can use to debug our tokens, such as <a href=https://token.dev/ rel=external target=_blank>Token.dev</a>, to confirm that they are working correctly.</p><p><a href=#R-image-14ec5925f7743c0b006cc0430ee6df14 class=lightbox-link><img alt="JWT Debugger" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-14ec5925f7743c0b006cc0430ee6df14><img alt="JWT Debugger" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_5.png></a></p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Do Not Share Live Keys!</div><div class=box-content><p>While sites like this will also help you confirm that your JWTs are properly signed by asking for your secret key, you <strong>SHOULD NOT</strong> share a secret key for a live production application with these sites. There is always a chance it has been compromised!</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=auth-routing>Auth Routing</h1><a href="https://www.youtube.com/watch?v=8hOtlMwkSow">YouTube Video</a><h2 id=routing-after-authentication>Routing after Authentication</h2><p>The last step we should take in our authentication system is to properly route users back to the index page after a successful login attempt. Since we will eventually be building a single-page application in Vue.js as our frontend for this application, we only need to worry about directing users back to the index page, which will load our frontend.</p><p>So, in our <code>authSuccess</code> method in <code>routes/auth.js</code>, we can update the response to redirect our users back to the index page:</p><div class=tab-panel data-tab-group=16de0a1a6749baab4a012574758698bc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=authroutesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("16de0a1a6749baab4a012574758698bc","authroutesjs")'>
<span class=tab-nav-text>auth/routes.js</span></button></div><div class=tab-content-container><div data-tab-item=authroutesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>authSuccess</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>The <code>res.redirect</code> method will sent an HTTP 302 <code>Found</code> response back to the browser with a new location to navigate to. However, by that point, the authentication process will also send a cookie to the browser with the session ID, so the user will be logged in correctly:</p><p><a href=#R-image-9bea8c0527fe743f11fda824ce973c62 class=lightbox-link><img alt="Session Login with Cookie Set" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_9.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9bea8c0527fe743f11fda824ce973c62><img alt="Session Login with Cookie Set" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_9.png></a></p><h2 id=logout-route>Logout Route</h2><p>Finally, we should also add a logout route. This route will end any sessions created through Passport.js by removing the session from the database and also telling the browser to delete the session cookie. It uses the special <code>req.logout()</code> method that is added to each request by Passport.js. We&rsquo;ll add our logout route to the bottom of the <code>routes/auth.js</code> file:</p><div class=tab-panel data-tab-group=1a49679f60142f50946da7f8da8d0e77><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1a49679f60142f50946da7f8da8d0e77","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;../configs/auth.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Logout of a Passport.js session
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * See https://www.initialapps.com/properly-logout-passportjs-express-session-for-single-page-app/
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/logout:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: logout current user
</span></span></span><span class=line><span class=cl><span class=cm> *     description:  logout current user and end session
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/logout&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>clearCookie</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_NAME</span> <span class=o>||</span> <span class=s1>&#39;connect.sid&#39;</span><span class=p>);</span>  <span class=c1>// clear the session cookie
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>req</span><span class=p>.</span><span class=nx>logout</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>       <span class=c1>// logout of passport
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>destroy</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// destroy the session
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we access this route with a valid session, we&rsquo;ll see that the user is properly logged out.</p><p>We&rsquo;ll also no longer be able to access the <code>/auth/token</code> route without logging in again.</p><p>However, this route <strong>WILL NOT</strong> invalidate any existing JWTs already issued to that user - they will still be valid until they expire. In our earlier example, we set the JWTs to have a 6 hour lifetime, so in theory a user could still access the application using a valid JWT up to 6 hours after logging out!</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Invalidating JWTs</div><div class=box-content><p>JSON Web Tokens (JWTs) are a very powerful authentication method for web APIs because they allow users to send requests without worrying about the need for a cookie session. In theory, a JWT issued by any instance of our API can be validated anywhere, making it much easier to horizontally scale this application in the future.</p><p>In addition, requests with a JWT generally don&rsquo;t require a database access with each request to validate the session. Our current cookie sessions store the session data in the database, so now each incoming request containing a session cookie requires a database lookup to get information about the user before any work can be done.</p><p>However, this means that any user with a valid JWT will be able to access our application even if they have logged out. This may present a security issue for some applications.</p><p>There are some strategies to mitigate this risk:</p><ol><li>Use JWTs with a short expiration - this means users may have to log in again and/or request new tokens more often, which could be frustrating.</li><li>Add a database session to each JWT - this would mean that each incoming request with a JWT would now result in a database lookup, which could slow things down. Alternatively, sessions could be stored in a faster cache mechanism such as <a href=https://redis.io/ rel=external target=_blank>Redis</a> or <a href=https://valkey.io/ rel=external target=_blank>Valkey</a>.</li><li>To permanently invalidate all existing JWT sessions (in case of a security compromise or other concern), simply change the key used to sign the JWTs to a new secure key. This is a method of last resort, but it is always important to know that it is available if needed.</li></ol></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cas-authentication>CAS Authentication</h1><a href="https://www.youtube.com/watch?v=fnsW2-iKliE">YouTube Video</a><h2 id=cas-authentication>CAS Authentication</h2><p>We&rsquo;ve already studied <a href=https://apereo.github.io/cas/7.1.x/index.html rel=external target=_blank>Central Authentication Service (CAS)</a> as one method for authenticating users through a third party service. In this case, CAS is the service commonly used at K-State for authentication, which is why we like to cover it in our examples. So, let&rsquo;s look at how to add CAS authentication to our application through Passport.</p><h2 id=installing-a-passport-strategy>Installing a Passport Strategy</h2><p>First, we&rsquo;ll need to install a new Passport.js strategy for dealing with CAS authentication. Thankfully, the ALT+CS lab at K-State maintains an updated library for this, which can be installed as shown below:</p><div class=tab-panel data-tab-group=f30117f3ae09b31e70997f65f66fad2f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f30117f3ae09b31e70997f65f66fad2f","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install https://github.com/alt-cs-lab/passport-cas</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Finding a Good Strategy</div><div class=box-content><p>Unfortunately, it is very difficult to find an updated Passport.js strategy for CAS authentication. This is partially due to the fact the CAS is not commonly used, and partially because many existing strategies have been written once and then abandoned by the developers. For this class, we sought out the most updated strategy available, then did our best to fix any known/existing bugs.</p></div></div><h2 id=configuring-cas-strategy>Configuring CAS Strategy</h2><p>Next, we can configure our authentication strategy by adding a few items to the <code>configs/auth.js</code> file for our new CAS strategy:</p><div class=tab-panel data-tab-group=785be09a3e46d2b349ff8e8f5fb36301><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("785be09a3e46d2b349ff8e8f5fb36301","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UniqueTokenStrategy</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;passport-unique-token&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Strategy</span> <span class=nx>as</span> <span class=nx>CasStrategy</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@alt-cs-lab/passport-cas&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// CAS authentication
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=k>new</span> <span class=nx>CasStrategy</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>version</span><span class=o>:</span> <span class=s1>&#39;CAS2.0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>ssoBaseURL</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_URL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>serverBaseURL</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_SERVICE_URL</span> <span class=o>+</span> <span class=s1>&#39;/auth/cas&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nx>profile</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>profile</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>authenticateUser</span><span class=p>(</span><span class=nx>profile</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=s2>&#34;CAS authentication succeeded but no user returned: &#34;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>profile</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>In this file, we are importing our new CAS authentication strategy, then using <code>passport.use</code> to tell Passport.js to use this authentication strategy when requested. Inside, we set up the various settings for our strategy, as well as the callback function when a user successfully authenticates. In this case, the CAS server will give us a <code>profile</code> object that should contain the <code>user</code> attribute with the user&rsquo;s username, which we can send to our <code>authenticateUser</code> method we&rsquo;ve already created. Finally, we also include a short catch to log any errors where the user is able to log in but a username is not provided.</p><p>In our <code>.env</code> file, we&rsquo;ll need to add two more settings. The <code>CAS_URL</code> is the base URL for the CAS server itself, and the <code>CAS_SERVICE_URL</code> is the URL that users should be sent back to, along with a ticket, to complete the log in process. Since we are working in GitHub Codespaces, our <code>CAS_SERVICE_URL</code> will be the same as our <code>OPENAPI_HOST</code>.</p><div class=tab-panel data-tab-group=dfa20e2f0adf22b75ee578e0ce4f692a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("dfa20e2f0adf22b75ee578e0ce4f692a","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=nv>CAS_URL</span><span class=o>=</span>https://testcas.cs.ksu.edu
</span></span><span class=line><span class=cl><span class=nv>CAS_SERVICE_URL</span><span class=o>=</span>https://<span class=nv>$CODESPACE_NAME</span>-<span class=nv>$PORT</span>.<span class=nv>$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span></span></span></code></pre></div></div></div></div></div><p>Notice that we already add the <code>/auth/cas</code> route to the end of the <code>CAS_SERVICE_URL</code> in the configuration above - since that path won&rsquo;t change, it makes sense to just include it there instead of having to remember to add it to the path in the <code>.env</code> file. We should also put sensible defaults in our <code>.env.example</code> and <code>.env.test</code> files as well.</p><p>Now, to use this authentication method, all we have to do is update our <code>/auth/cas</code> route in <code>routes/auth.js</code> to use this strategy:</p><div class=tab-panel data-tab-group=f55e7b069404f59b898501f750948c3f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f55e7b069404f59b898501f750948c3f","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * CAS Authentication
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/cas:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: CAS authentication
</span></span></span><span class=line><span class=cl><span class=cm> *     description:  CAS authentication for deployment
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/cas&#34;</span><span class=p>,</span> <span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s1>&#39;cas&#39;</span><span class=p>),</span> <span class=nx>authSuccess</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>With that in place, we can start our application and test it by navigating to the <code>/auth/cas</code> route to see if our login attempt works:</p><div class=tab-panel data-tab-group=83c4e7f7774d47035abfa636215b434c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("83c4e7f7774d47035abfa636215b434c","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>If everything works correctly, we should be directed to our CAS server to authenticate, then we&rsquo;ll be sent back to our own server with a ticket to validate our authentication. Finally, once the ticket is validated, we&rsquo;ll be redirected back to our home page with a session cookie set:</p><p><a href=#R-image-a26580cc6c66a73079b14395a33343d4 class=lightbox-link><img alt="CAS Login with Cookie Set" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_9.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a26580cc6c66a73079b14395a33343d4><img alt="CAS Login with Cookie Set" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_9.png></a></p><h2 id=cas-logout>CAS Logout</h2><p>Finally, we&rsquo;ll need to add a bit more logic to our logout process to properly log users out of both our application and the CAS server they originally logged in through. So, let&rsquo;s update our <code>/auth/logout</code> route to include that:</p><div class=tab-panel data-tab-group=355a3da82f9c618a746c50698fd63457><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("355a3da82f9c618a746c50698fd63457","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/logout&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>clearCookie</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_NAME</span> <span class=o>||</span> <span class=s1>&#39;connect.sid&#39;</span><span class=p>);</span>  <span class=c1>// clear the session cookie
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>req</span><span class=p>.</span><span class=nx>logout</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>       <span class=c1>// logout of passport
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>destroy</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// destroy the session
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>      <span class=kr>const</span> <span class=nx>redirectURL</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_URL</span> <span class=o>+</span> <span class=s2>&#34;/logout?service=&#34;</span> <span class=o>+</span> <span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_SERVICE_URL</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=nx>redirectURL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Most CAS servers will automatically redirect the user back to the <code>service</code> request parameter, but not all of them. However, this will ensure that the CAS server knows the user has logged out and will invalidate any tickets for that user.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Test CAS Server Updated</div><div class=box-content><p>The test CAS server was updated recently to properly redirect users back to the <code>service</code> request parameter, so you will probably no longer see the Logout page from that server in your testing. This should make developing and testing with that server a bit more straightforward</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=new-users>New Users</h1><a href="https://www.youtube.com/watch?v=53odl8cktpI">YouTube Video</a><h2 id=handling-new-users>Handling New Users</h2><p>What if a user logs in to our application through CAS, but we don&rsquo;t have them in our database of users? Do we want to deny them access to the application? Or should we somehow gracefully add them to the list of users and give them some basic access to our application?</p><p>Since we are building a website meant to be open to a number of users, let&rsquo;s go ahead and implement a strategy where a new user can be created in the event that a user logs on through one of our authentication strategies but isn&rsquo;t found in the database.</p><p>Thankfully, to do this is really simple - all we must do is add a few additional lines to our <code>authenticateUser</code> function in the <code>configs/auth.js</code> file:</p><div class=tab-panel data-tab-group=eff3698be8b18b1e28a054c6349dbe06><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("eff3698be8b18b1e28a054c6349dbe06","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>authenticateUser</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Find user with the username
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span> 
</span></span><span class=line><span class=cl>    <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>username</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// User not found
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span> <span class=o>===</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Create new user
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>User</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>username</span><span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;New user created via login: &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>        
</span></span><span class="line hl"><span class=cl>        <span class=c1>// Convert Sequelize object to plain JavaScript object
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>        <span class=nx>user</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>user</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>        <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// User authenticated
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Login succeeded for user: &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>      
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Convert Sequelize object to plain JavaScript object
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>user</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>user</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>      <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we try to log in using any username, we&rsquo;ll either be logged in as an existing user, or a new user will be created. We can see this in our log output:</p><div class=tab-panel data-tab-group=0ea21cf3eda75d16df87c7d72e8f0486><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0ea21cf3eda75d16df87c7d72e8f0486","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[2025-03-20 07:15:17.256 PM] http:      GET /auth/cas 302 0.697 ms - 0
[2025-03-20 07:15:23.525 PM] debug:     New user created via login: russfeld
[2025-03-20 07:15:23.564 PM] http:      GET /auth/cas?ticket=aac12881-9bea-449c-bf13-b981525cc8db 302 218.923 ms - 30
[2025-03-20 07:15:23.721 PM] http:      GET / 200 1.299 ms - -</code></pre></div></div></div></div></div><p>That&rsquo;s all there is to it! Of course, we can also configure this process to automatically assign roles to our newly created user, but for right now we won&rsquo;t worry about that.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=testing-authentication>Testing Authentication</h1><a href="https://www.youtube.com/watch?v=W4jM6hkYuks">YouTube Video</a><h2 id=testing-authentication-routes>Testing Authentication Routes</h2><p>Now that we have our authentication system working for our application, let&rsquo;s write some unit tests to confirm that it works as expected in a variety of situations.</p><p>As part of these tests, we&rsquo;ll end up creating a <a href=https://en.wikipedia.org/wiki/Test_double rel=external target=_blank>test double</a> of one part of our authentication system to make it easier to test. To do this, we&rsquo;ll use the <a href=https://sinonjs.org/ rel=external target=_blank>Sinon</a> library, so let&rsquo;s start by installing it as a development dependency:</p><div class=tab-panel data-tab-group=5c3ea749ce02be7bd379a66aa332b21d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5c3ea749ce02be7bd379a66aa332b21d","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install --save-dev sinon</span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll store these tests in the <code>test/auth.js</code> file, starting with this content including the libraries we&rsquo;ll need to use:</p><div class=tab-panel data-tab-group=2e80a5ab67583dad0cba4795186fda1c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2e80a5ab67583dad0cba4795186fda1c","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /auth Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span><span class=p>,</span> <span class=nx>expect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>sinon</span> <span class=nx>from</span> <span class=s2>&#34;sinon&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>jsonwebtoken</span> <span class=nx>from</span> <span class=s2>&#34;jsonwebtoken&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiJsonSchemaAjv</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>verbose</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiShallowDeepEqual</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Modify Object.prototype for BDD style assertions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>should</span><span class=p>();</span></span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll continue to build out tests below that content in the same file.</p><h3 id=testing-bypass-authentication>Testing Bypass Authentication</h3><p>First, let&rsquo;s look at some tests for the <code>/auth/bypass</code> route, since that is the simplest. The first test is a very simple one to confirm that bypass authentication works, and also that it sets the expected cookie in the browser when it redirects the user back to the home page:</p><div class=tab-panel data-tab-group=88f40d44597462835f156127fbf25f61><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("88f40d44597462835f156127fbf25f61","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Regular expression to match the expected cookie
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>regex_valid</span> <span class=o>=</span> <span class=s2>&#34;^&#34;</span> <span class=o>+</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_NAME</span> <span class=o>+</span> <span class=s2>&#34;=\\S*; Path=/; HttpOnly$&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test Bypass authentication
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>bypassAuth</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should allow bypass login with user &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// List of existing users to be tested
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;admin&#34;</span><span class=p>,</span> <span class=s2>&#34;contributor&#34;</span><span class=p>,</span> <span class=s2>&#34;manager&#34;</span><span class=p>,</span> <span class=s2>&#34;user&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /bypass&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>bypassAuth</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Notice that we are using a <a href=https://en.wikipedia.org/wiki/Regular_expression rel=external target=_blank>regular expression</a> to help us verify that the cookie being sent to the user is using the correct name and has the expected content.</p><p>Next, we also should test to make sure that using bypass authentication with any unknown username will create that user:</p><div class=tab-panel data-tab-group=28abf5e3e9d2e73c1ea7f9456b709d98><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("28abf5e3e9d2e73c1ea7f9456b709d98","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test Bypass authentication creates user
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>bypassAuthCreatesUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should allow bypass login with new user &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>          <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>user</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>found_user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>expect</span><span class=p>(</span><span class=nx>found_user</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>not</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>found_user</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;username&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>expect</span><span class=p>(</span><span class=nx>found_user</span><span class=p>.</span><span class=nx>username</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /bypass&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>bypassAuth</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>bypassAuthCreatesUser</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This test will first log the user in, then it will directly check the database to ensure that the user has been created successfully. Alternatively, we could also use the API, but we&rsquo;re trying to keep our tests independent, so in this case it makes the most sense to query the database directly in our test instead of any other method.</p><h3 id=testing-cas-authentication>Testing CAS Authentication</h3><p>Next, let&rsquo;s write the tests for our CAS authentication strategy. These are similar to the ones we&rsquo;ve already written, but they have some key differences as well.</p><p>First, we can write a simple test just to show that any user who visits the <code>/auth/cas</code> route will be properly redirected to the correct CAS server:</p><div class=tab-panel data-tab-group=3697e7c678d810dfc0e69f52850f3045><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3697e7c678d810dfc0e69f52850f3045","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test CAS authentication redirect
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>casAuthRedirect</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should redirect users to CAS server&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>expectedURL</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_URL</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;/login?service=&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>      <span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_SERVICE_URL</span> <span class=o>+</span> <span class=s2>&#34;/auth/cas&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/cas&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=nx>expectedURL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /cas&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>casAuthRedirect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this test, we are building the URL that the user should be redirected to, based on the settings we have already set in our environment file. Then, we simply check that the returned response is an HTTP 302 Found response with the correct location indicated.</p><p>The next two tests are much more complex, because they require us to mock the step where our server confirms that the user is authenticated with the CAS server by sending a request with a ticket attached, and then getting a response for that ticket. We can do this using a bit of clever coding and the [Sinon] library.</p><p>First, we need to mock up a response object that mimics what the server would respond with. This is mocked just so it will be understood by our CAS authentication library and may not work in all cases:</p><div class=tab-panel data-tab-group=f0275956cd3fc73a7b443423b7f0fd09><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f0275956cd3fc73a7b443423b7f0fd09","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Helper function to generate a valid mock CAS 2.0 Ticket
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>validTicket</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>ticket</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=sb>`&lt;cas:serviceResponse xmlns:cas=&#39;http://www.yale.edu/tp/cas&#39;&gt;
</span></span></span><span class=line><span class=cl><span class=sb>          &lt;cas:authenticationSuccess&gt;
</span></span></span><span class=line><span class=cl><span class=sb>              &lt;cas:user&gt;</span><span class=si>${</span><span class=nx>user</span><span class=si>}</span><span class=sb>&lt;/cas:user&gt;
</span></span></span><span class=line><span class=cl><span class=sb>              &lt;cas:ksuPersonWildcatID&gt;</span><span class=si>${</span><span class=mi>123456789</span><span class=si>}</span><span class=sb>&lt;/cas:ksuPersonWildcatID&gt;
</span></span></span><span class=line><span class=cl><span class=sb>              &lt;cas:proxyGrantingTicket&gt;</span><span class=si>${</span><span class=nx>ticket</span><span class=si>}</span><span class=sb>&lt;/cas:proxyGrantingTicket&gt;
</span></span></span><span class=line><span class=cl><span class=sb>          &lt;/cas:authenticationSuccess&gt;
</span></span></span><span class=line><span class=cl><span class=sb>        &lt;/cas:serviceResponse&gt;`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>This function creates an object with a single method <code>text()</code> that will return a valid XML ticket for the given user and random ticket ID.</p><p>Right below that, we can create a unit test that will mock the global <code>fetch</code> function used by our CAS authentication strategy to contact the CAS server to validate the ticket, and instead it will respond with our mock response object created above:</p><div class=tab-panel data-tab-group=82e1cae95121d45372b02d6d631c8c22><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("82e1cae95121d45372b02d6d631c8c22","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test CAS with valid ticket
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>casAuthValidTicket</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should log in user &#34;</span> <span class=o>+</span> <span class=nx>user</span> <span class=o>+</span> <span class=s2>&#34; via CAS&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ticket</span> <span class=o>=</span> <span class=s2>&#34;abc123&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>fetchStub</span> <span class=o>=</span> <span class=nx>sinon</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>stub</span><span class=p>(</span><span class=nx>global</span><span class=p>,</span> <span class=s2>&#34;fetch&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>resolves</span><span class=p>(</span><span class=nx>validTicket</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>ticket</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/cas?ticket=&#34;</span> <span class=o>+</span> <span class=nx>ticket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>sinon</span><span class=p>.</span><span class=nx>assert</span><span class=p>.</span><span class=nx>calledOnce</span><span class=p>(</span><span class=nx>fetchStub</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>fetchStub</span><span class=p>.</span><span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]).</span><span class=nx>to</span><span class=p>.</span><span class=nx>contain</span><span class=p>(</span><span class=s2>&#34;?ticket=&#34;</span> <span class=o>+</span> <span class=nx>ticket</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /cas&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>casAuthRedirect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>casAuthValidTicket</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this test, we create a <code>fetchStub</code> object that is used by our CAS authentication strategy in place of <code>fetch</code>. It will confirm that the user has a valid ticket and can be authenticated, so we can perform the same steps as before and ensure that the cookie is properly set when the user is authenticated.</p><p>We also are checking that the <code>fetch</code> method we mocked was actually called once, and that it contained the ticket we provided as part of the URL. This is just a sanity check to make sure that we mocked up the correct part of our application!</p><p>We must also add a new item in the <code>afterEach()</code> hook for Mocha, which will reset all functions and objects that are mocked by Sinon after each test. This ensures we are always working with a clean slate. We&rsquo;ll update the function in <code>test/hooks.js</code> with this new content:</p><div class=tab-panel data-tab-group=f158fd72efd90145c0e4bdca11fe0f14><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhooksjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f158fd72efd90145c0e4bdca11fe0f14","testhooksjs")'>
<span class=tab-nav-text>test/hooks.js</span></button></div><div class=tab-content-container><div data-tab-item=testhooksjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import libraries
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>sinon</span> <span class=nx>from</span> <span class=s2>&#34;sinon&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Root Hook Runs Before Each Test
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>mochaHooks</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// Hook runs after each individual test
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>afterEach</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Restore Sinon mocks
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=nx>sinon</span><span class=p>.</span><span class=nx>restore</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Remove all data from the database
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>seeds</span><span class=p>.</span><span class=nx>down</span><span class=p>({</span> <span class=nx>to</span><span class=o>:</span> <span class=mi>0</span> <span class=p>}).</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div></div></div></div><p>Finally, we also should confirm that logging in via CAS will create a new user if the username is not recognized. This test builds upon the previous CAS test in a way similar to the one used for bypass authentication above:</p><div class=tab-panel data-tab-group=0b2b5aa3627614439ce3affe070aa39b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0b2b5aa3627614439ce3affe070aa39b","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test CAS creates user
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>casAuthValidTicketCreatesUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should create new user &#34;</span> <span class=o>+</span> <span class=nx>user</span> <span class=o>+</span> <span class=s2>&#34; via CAS&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ticket</span> <span class=o>=</span> <span class=s2>&#34;abc123&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>fetchStub</span> <span class=o>=</span> <span class=nx>sinon</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>stub</span><span class=p>(</span><span class=nx>global</span><span class=p>,</span> <span class=s2>&#34;fetch&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>resolves</span><span class=p>(</span><span class=nx>validTicket</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>ticket</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/cas?ticket=&#34;</span> <span class=o>+</span> <span class=nx>ticket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>sinon</span><span class=p>.</span><span class=nx>assert</span><span class=p>.</span><span class=nx>calledOnce</span><span class=p>(</span><span class=nx>fetchStub</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>fetchStub</span><span class=p>.</span><span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]).</span><span class=nx>to</span><span class=p>.</span><span class=nx>contain</span><span class=p>(</span><span class=s2>&#34;?ticket=&#34;</span> <span class=o>+</span> <span class=nx>ticket</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>          <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>user</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>found_user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>expect</span><span class=p>(</span><span class=nx>found_user</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>not</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>found_user</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;username&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>expect</span><span class=p>(</span><span class=nx>found_user</span><span class=p>.</span><span class=nx>username</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /cas&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>casAuthRedirect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>casAuthValidTicket</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>casAuthValidTicketCreatesUser</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>As before, this will log a user in via CAS, confirm that it works, and then check in the database to make sure that the new user is properly created.</p><h3 id=testing-jwt>Testing JWT</h3><p>Now that we&rsquo;ve tested both ways to log into our application, we can write some tests to confirm that users can properly request a JWT to be used in our frontend later on. So, our first test simply checks to make sure a user with a valid session can request a token:</p><div class=tab-panel data-tab-group=a8cbdd9162ff9e0bc077b23c7c94b515><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a8cbdd9162ff9e0bc077b23c7c94b515","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test user can request a valid token
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>userCanRequestToken</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should allow user &#34;</span> <span class=o>+</span> <span class=nx>user</span> <span class=o>+</span> <span class=s2>&#34; to request valid JWT&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>agent</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;token&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>decode</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>token</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>token</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;username&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>token</span><span class=p>.</span><span class=nx>username</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /token&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this test, we must use a persistent browser agent to make our requests. This will ensure that any cookies or other settings are saved between requests. Thankfully, the <a href=https://www.npmjs.com/package/supertest rel=external target=_blank>Supertest</a> library we are using already has that functionality, so all we have to do is create an <code>agent</code> for our testing as shown in the test above. Once we have successfully logged in, we can confirm that the <code>/auth/token</code> endpoint sends a valid JWT that contains information about the current user. For these tests, we are using bypass authentication for simplicity, but any authentication method could be used.</p><p>When we run the tests at the bottom of the file, notice that we are running this for all existing users, as well as a newly created user. Both types of users should be able to request a token for our application.</p><p>Next, let&rsquo;s confirm that all of a user&rsquo;s roles are listed in the JWT issued for that user. This is important because, later on in this example, we&rsquo;ll be using those roles to implement role-based authorization in our application, so it is vital to make sure our JWTs include the correct roles:</p><div class=tab-panel data-tab-group=ea4c543bc2198fe006dbb381271ed621><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ea4c543bc2198fe006dbb381271ed621","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test user roles are correctly listed in token
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>userRolesAreCorrectInToken</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should contain correct roles for user &#34;</span> <span class=o>+</span> <span class=nx>user</span> <span class=o>+</span> <span class=s2>&#34; in JWT&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>agent</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;token&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>decode</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>token</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span>
</span></span><span class=line><span class=cl>              <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>              <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>              <span class=p>},</span>
</span></span><span class=line><span class=cl>              <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>user</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>if</span> <span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>length</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>token</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;roles&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>expect</span><span class=p>(</span><span class=nx>token</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>length</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>user</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>expected_role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nx>expect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=nx>token</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>role</span><span class=p>.</span><span class=nx>id</span> <span class=o>==</span> <span class=nx>expected_role</span><span class=p>.</span><span class=nx>id</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                  <span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>});</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>token</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>not</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;roles&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /token&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>userRolesAreCorrectInToken</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>userRolesAreCorrectInToken</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This test may seem very long and verbose, but it is very straightforward. We first login and request a token for a user, and then we also look up that user in the database including all associated roles. Then, we simply assert that the number of roles in the token is the same as the number of them in the database, and if there are any roles that each role is found as expected.</p><p>Finally, we should write one additional test, that simply confirms that the application will not allow anyone to request a token if they are not currently logged in:</p><div class=tab-panel data-tab-group=e3ec55c0b7e927f4ee5da579bcc8b897><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e3ec55c0b7e927f4ee5da579bcc8b897","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * User must have a valid session to request a token
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>mustBeLoggedInToRequestToken</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should not allow a user to request a token without logging in&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>401</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /token&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>userRolesAreCorrectInToken</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>userRolesAreCorrectInToken</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>mustBeLoggedInToRequestToken</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>For this test, we simply check that the application returns an HTTP 401 response if the user tries to request a token without first being logged in.</p><h3 id=testing-logout>Testing Logout</h3><p>Finally, we can write a few tests to make sure our logout process is also working as expected. The first test will confirm that the session cookie we are using is properly removed from the user&rsquo;s browser when they log out:</p><div class=tab-panel data-tab-group=2cb4f006651b9ff0675b60d6142c3b8c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2cb4f006651b9ff0675b60d6142c3b8c","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Regular expression to match deleting the cookie
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>regex_destroy</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;^&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>  <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_NAME</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT$&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Logout will remove the cookie
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>logoutDestroysCookie</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should remove the cookie on logout&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re_destroy</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_destroy</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>agent</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/logout&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re_destroy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /logout&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutDestroysCookie</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this test, we are looking for a second <code>set-cookie</code> header to be sent when the user logs out. This header will both contain an empty cookie, but also will set the cookie&rsquo;s expiration date to the earliest date possible. So, we can simply look for that header to confirm our cookie is being properly removed and expired from the user&rsquo;s browser when they log out. We only really have to test this for a single username, since the process is identical for all of them.</p><p>Next, we should also confirm that the logout process will redirect users to the CAS server as well and log them out of any existing CAS sessions.</p><div class=tab-panel data-tab-group=698eddf119ac1727d638abf3fc33ab44><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("698eddf119ac1727d638abf3fc33ab44","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Regular expression for redirecting to CAS
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>regex_redirect</span> <span class=o>=</span> <span class=s2>&#34;^&#34;</span> <span class=o>+</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_URL</span> <span class=o>+</span> <span class=s2>&#34;/logout\\?service=\\S*$&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Logout redirects to CAS
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>logoutRedirectsToCas</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should redirect to CAS on logout&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re_redirect</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_redirect</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>agent</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/logout&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=nx>re_redirect</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /logout&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutDestroysCookie</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutRedirectsToCas</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Once again, we are simply checking the <code>Location</code> header of the HTTP 302 Found response received from our application. We are making use of regular expressions to ensure we are being properly redirected to the correct CAS server and the <code>logout</code> route on that server.</p><p>Finally, we should confirm that once a user has logged out, they are no longer able to request a new token from the application:</p><div class=tab-panel data-tab-group=a5030d91a76329a336ada1b4d483ad73><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a5030d91a76329a336ada1b4d483ad73","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Logout prevents requesting a token
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>logoutPreventsToken</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should prevent access to token after logging out&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>agent</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>agent</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/logout&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>agent</span>
</span></span><span class=line><span class=cl>                  <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                  <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>401</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                  <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                  <span class=p>});</span>
</span></span><span class=line><span class=cl>              <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /logout&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutDestroysCookie</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutRedirectsToCas</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutPreventsToken</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this test, we simply log in, request a token, then log out, and show that the application will no longer allow us to request a token, even though we are using the same user agent as before. This is a great way to confirm that our entire process is working!</p><p>Now is a great time to lint, format, and commit our code to GitHub before continuing!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=role-based-authorization>Role-Based Authorization</h1><a href="https://www.youtube.com/watch?v=KMiBMPzHRp8">YouTube Video</a><h2 id=token-middlewares>Token Middlewares</h2><p>Now that we finally have a working authentication system, we can start to add role-based authorization to our application. This will ensure that only users with specific roles can perform certain actions within our RESTful API. To do this, we&rsquo;ll need to create a couple of new Express middlewares to help load the contents of our JWT into the request, and also to verify that the authenticated user has the appropriate roles to perform an action.</p><p>First, let&rsquo;s create a middleware to handle loading our JWT from an authorization header into the Express request object:</p><div class=tab-panel data-tab-group=44f398b9a25ae44d9c2f2a1e7b25d664><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=middlewarestokenjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("44f398b9a25ae44d9c2f2a1e7b25d664","middlewarestokenjs")'>
<span class=tab-nav-text>middlewares/token.js</span></button></div><div class=tab-content-container><div data-tab-item=middlewarestokenjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Middleware for reading JWTs from the Bearer header and storing them in the request
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports tokenMiddleware the token middleware
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>jsonwebtoken</span> <span class=nx>from</span> <span class=s1>&#39;jsonwebtoken&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;../configs/logger.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>tokenMiddleware</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Retrieve the token from the headers
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>authHeader</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s1>&#39;authorization&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>authHeader</span> <span class=o>&amp;&amp;</span> <span class=nx>authHeader</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// If the token is null in the header, send 401 unauthorized
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>token</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s1>&#39;JWT in header is null&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Verify the token
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>JWT_SECRET_KEY</span><span class=p>,</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>token</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Handle common errors
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=s1>&#39;TokenExpiredError&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If the token is expired, send 401 unauthorized 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If the token won&#39;t parse, send 403 forbidden
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&#34;JWT Parsing Error!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>sendStatus</span><span class=p>(</span><span class=mi>403</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Attach token to request
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>req</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=nx>token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Call next middleware
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>tokenMiddleware</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This middleware will extract our JWT from the <code>authorization: Bearer</code> header that should be present in any request from our frontend single-page web application to our API. It then checks that the signature matches the expected signature and that the payload of the JWT has not been tampered with. It also makes sure the JWT has not expired. If all of those checks pass, then it simply attaches the contents of the JWT to the Express request object as <code>req.token</code>, so we can use it later in our application.</p><p>To use this middleware, we need to make a small change to the structure of our <code>routes/api.js</code> file to allow users to access the base API route without needing the token, but all other routes will require a valid token for access:</p><div class=tab-panel data-tab-group=397cfcdabf6ff320826cca08b40fde18><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("397cfcdabf6ff320826cca08b40fde18","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file API main router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: api
</span></span></span><span class=line><span class=cl><span class=cm> *   description: API routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import middleware
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>tokenMiddleware</span> <span class=nx>from</span> <span class=s2>&#34;../middlewares/token.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import v1 routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>rolesRouter</span> <span class=nx>from</span> <span class=s2>&#34;./api/v1/roles.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s2>&#34;./api/v1/users.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of API versions
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: list API versions
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [api]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of users
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: object
</span></span></span><span class=line><span class=cl><span class=cm> *                 properties:
</span></span></span><span class=line><span class=cl><span class=cm> *                   version:
</span></span></span><span class=line><span class=cl><span class=cm> *                     type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                   url:
</span></span></span><span class=line><span class=cl><span class=cm> *                     type: string
</span></span></span><span class=line><span class=cl><span class=cm> *             example:
</span></span></span><span class=line><span class=cl><span class=cm> *               - version: &#34;1.0&#34;
</span></span></span><span class=line><span class=cl><span class=cm> *                 url: /api/v1/
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v1/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Use Token Middleware
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>tokenMiddleware</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use v1 routers after API route
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/v1/roles&#34;</span><span class=p>,</span> <span class=nx>rolesRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/v1/users&#34;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Here, we import our new middleware, and then we rearrange the contents of the file so that the single <code>/api</code> route comes first, then we add our middleware and the rest of the API routes at the end of the file. Remember that everything in Express is executed in the order it is attached to the application, so in this way any routes that occur before our middleware is attached can be accessed without a valid JWT, but any routes or routers added afterward will require a valid JWT for access.</p><h2 id=role-middleware>Role Middleware</h2><p>Next, we can create another middleware function that will check if a user has the appropriate roles to perform an operation via our API. However, instead of writing a simple function as our middleware, or even writing a number of different functions for each possible role, we can take advantage of one of the most powerful features of JavaScript - we can create a function that <em>returns</em> another function! Let&rsquo;s take a look and see how it works:</p><div class=tab-panel data-tab-group=52c257b2f194f44cff0f3950cae45bc6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=middlewaresauthorized-rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("52c257b2f194f44cff0f3950cae45bc6","middlewaresauthorized-rolesjs")'>
<span class=tab-nav-text>middlewares/authorized-roles.js</span></button></div><div class=tab-content-container><div data-tab-item=middlewaresauthorized-rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Middleware for role-based authorization
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports roleBasedAuth middleware
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Build a middleware function to validate a user has one of a list of roles
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param  {...any} roles a list of roles that are valid for this operation
</span></span></span><span class=line><span class=cl><span class=cm> * @returns a middleware function for those roles.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>roleBasedAuth</span> <span class=o>=</span> <span class=p>(...</span><span class=nx>roles</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kd>function</span> <span class=nx>roleAuthMiddleware</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Route requires roles: &#34;</span> <span class=o>+</span> <span class=nx>roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;User &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=nx>req</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34; has roles: &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=nx>req</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>role</span><span class=p>).</span><span class=nx>join</span><span class=p>(</span><span class=s2>&#34;,&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>match</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// loop through each role given
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// if the user has that role, then they can proceed
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>role</span> <span class=o>===</span> <span class=nx>role</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Role match!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>match</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>match</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// if no roles match, send an unauthenticated response
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;No role match!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>send</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>roleBasedAuth</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This file contains a function named <code>roleBasedAuth</code> that accepts a list of roles as parameters (they can be provided directly or as an array, but either way we can treat them like an array in our code). Then, we will <em>return</em> a new middleware function named <code>roleAuthMiddleware</code> that will check to see if the currently authenticated user (indicated by <code>req.token</code>) has at least one of the named roles. If so, then there is a match and the user should be able to perform the operation. If the user does not have any of the roles listed, then the user should not be able to perform the operation and a 401 Unauthorized response should be sent. This file also includes some helpful logging information to help ensure things are working properly.</p><h2 id=implementing-role-based-authorization>Implementing Role-Based Authorization</h2><p>Finally, let&rsquo;s look at how we can use that middleware function to implement role-based authorization in our application. Let&rsquo;s start simple - in this instance, we can update our <code>GET /api/v1/roles/</code> operation to require the user to have the <code>manage_users</code> role in order to list all possible roles in the application. To do this, we can import our new middleware function in the <code>routes/api/v1/roles.js</code> file, and then call that function to create a new middleware function to use in that file:</p><div class=tab-panel data-tab-group=e689b0fc05ee5f7ec13a8ef3c512f75f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e689b0fc05ee5f7ec13a8ef3c512f75f","routesapiv1rolesjs")'>
<span class=tab-nav-text>routes/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Roles router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: roles
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Roles Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import middlewares
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>roleBasedAuth</span> <span class=nx>from</span> <span class=s2>&#34;../../../middlewares/authorized-roles.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of roles
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/v1/roles:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: roles list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all roles in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [roles]
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     security:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *       - bearerAuth:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         - &#39;manage_users&#39;
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of roles
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 $ref: &#39;#/components/schemas/Role&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nx>roleBasedAuth</span><span class=p>(</span><span class=s2>&#34;manage_users&#34;</span><span class=p>),</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>Role</span><span class=p>.</span><span class=nx>findAll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Notice here that we are calling the <code>roleBasedAuth</code> function when we add it to our endpoint, which in turn will return a new middleware function that will be called anytime this endpoint is accessed. It is a bit complicated and confusing at first, but hopefully it makes sense.</p><p>We also have added a new <code>security</code> item to our Open API documentation, which allows us to test this route by providing a JWT through the Open API documentation website. We can even include the specific roles that are able to access this endpoint, but as of this writing it is only part of the Open API 3.1 spec but is not supported by the <code>swagger-ui</code> library so it won&rsquo;t appear on our documentation page.</p><p>Let&rsquo;s test it now by starting our server in development mode:</p><div class=tab-panel data-tab-group=175beaf2ab52c110fe546de8f2d9dc40><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("175beaf2ab52c110fe546de8f2d9dc40","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once we have loaded our page, let&rsquo;s go ahead and log in as the <code>admin</code> user by navigating to <code>/auth/bypass?token=admin</code> - this will return us to our home page, but now we have an active session we can use.</p><p>Once we have done that, we can now go to the <code>/docs</code> route to view our documentation. We should now notice that there is a new <code>Authorize</code> button at the top of the page:</p><p><a href=#R-image-1cf64e7b76e08b0c9ea9bd9961a4920b class=lightbox-link><img alt="OpenAPI Authorize" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_11.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1cf64e7b76e08b0c9ea9bd9961a4920b><img alt="OpenAPI Authorize" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_11.png></a></p><p>In addition, if we scroll down to find our <code>/api/v1/roles</code> route, we should also see that it now has a lock icon next to it, showing that it requires authentication before we can access it:</p><p><a href=#R-image-470b1f43948745322fa90cff0d81dde6 class=lightbox-link><img alt="OpenAPI Protected Route" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_12.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-470b1f43948745322fa90cff0d81dde6><img alt="OpenAPI Protected Route" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_12.png></a></p><p>If we try to test that route now, even though we have a valid session cookie session, it should give us a 401 Unauthorized response because we aren&rsquo;t providing a valid JWT as part of our request:</p><p><a href=#R-image-a0b8afcb01516c19febefe0212ddfc0e class=lightbox-link><img alt="Unauthorized Response" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_13.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a0b8afcb01516c19febefe0212ddfc0e><img alt="Unauthorized Response" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_13.png></a></p><p>To fix this, we need to authorize our application using a valid JWT. Thankfully, we can request one by finding the <code>/auth/token</code> route in our documentation and executing that route:</p><p><a href=#R-image-2fd13583dd5eab4d94d173d82848d24f class=lightbox-link><img alt="Requesting JWT" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_14.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2fd13583dd5eab4d94d173d82848d24f><img alt="Requesting JWT" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_14.png></a></p><p>Once we have that, we can click the new Authorize button at the top, and paste the text of that token in the window that pops up. We just need the raw part of the JWT in quotes that is the value of the <code>token</code> property, without the quotes themselves included:</p><p><a href=#R-image-83caf9ee744e1335ac63ed7b29ce57cc class=lightbox-link><img alt="Authorizing with JWT" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_15.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-83caf9ee744e1335ac63ed7b29ce57cc><img alt="Authorizing with JWT" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_15.png></a></p><p>Finally, once that has been done, we can try the <code>/api/v1/roles</code> route again, and it should now let us access that route:</p><p><a href=#R-image-53cf32caf348cd9cb1a1a87844d36bff class=lightbox-link><img alt="Working Request" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_16.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-53cf32caf348cd9cb1a1a87844d36bff><img alt="Working Request" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_16.png></a></p><p>We can also see that it is properly using our role-based authorization by checking the debug output of our application:</p><div class=tab-panel data-tab-group=586489765c110415c26ddde7234d751e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("586489765c110415c26ddde7234d751e","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[2025-03-21 12:54:14.085 AM] debug:     Route requires roles: manage_users
[2025-03-21 12:54:14.085 AM] debug:     User admin has roles: manage_users,manage_documents,manage_communities
[2025-03-21 12:54:14.086 AM] debug:     Role match!
[2025-03-21 12:54:14.087 AM] sql:       Executing (default): SELECT `id`, `role`, `createdAt`, `updatedAt` FROM `roles` AS `Role`;
[2025-03-21 12:54:14.090 AM] http:      GET /api/v1/roles 200 9.553 ms - 784</code></pre></div></div></div></div></div><p>There we go! That is all it takes to add role-based authorization to our application. Next, we&rsquo;ll look at how to update our unit tests to use our new authentication system and roles.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=updating-tests>Updating Tests</h1><a href="https://www.youtube.com/watch?v=k43QEMKxO9Y">YouTube Video</a><h2 id=updating-unit-tests>Updating Unit Tests</h2><p>Of course, now that we&rsquo;re requiring a valid JWT for all API routes, and adding role-based authorization for most routes, all of our existing API unit tests now longer work. So, let&rsquo;s work on updating those tests to use our new authentication system.</p><p>First, let&rsquo;s build a simple helper function we can use to easily log in as a user and request a token to use in our application. We&rsquo;ll place this in a new file named <code>test/helpers.js</code>:</p><div class=tab-panel data-tab-group=ecf03b6d886cfcf540cfce6210e7e87d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ecf03b6d886cfcf540cfce6210e7e87d","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Unit Test Helpers
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>login</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>agent</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>).</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div></div></div></div><p>This file is pretty straightforward - it simply uses the bypass login system to authenticate as a user, then it requests a token and returns it. It assumes that all other parts of the authentication process work properly - we can do this because we already have unit tests to check that functionality.</p><p>Now, let&rsquo;s use this in our <code>test/api/v1/roles.js</code> file by adding a few new lines to each test. We&rsquo;ll start with the simple <code>getAllRoles</code> test:</p><div class=tab-panel data-tab-group=1b676ce7b8984dbcff9832fac33399e2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1b676ce7b8984dbcff9832fac33399e2","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api/v1/roles Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Ajv</span> <span class=nx>from</span> <span class=s2>&#34;ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>addFormats</span> <span class=nx>from</span> <span class=s2>&#34;ajv-formats&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../../../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import Helpers
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>login</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../helpers.js&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Configure Chai and AJV
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>ajv</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Ajv</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>addFormats</span><span class=p>(</span><span class=nx>ajv</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiJsonSchemaAjv</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>ajv</span><span class=p>,</span> <span class=nx>verbose</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiShallowDeepEqual</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Modify Object.prototype for BDD style assertions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>should</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all Roles
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>getAllRoles</span> <span class=o>=</span> <span class=p>(</span><span class=nx>state</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should list all roles&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;Authorization&#39;</span><span class=p>,</span> <span class=sb>`Bearer </span><span class=si>${</span><span class=nx>state</span><span class=p>.</span><span class=nx>token</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/roles route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=kd>let</span> <span class=nx>state</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>    <span class=nx>beforeEach</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>state</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>login</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>    <span class=nx>getAllRoles</span><span class=p>(</span><span class=nx>state</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>To update this test, we have created a new <code>state</code> object that is present in our <code>describe</code> block at the bottom of the test. That <code>state</code> object can store various things we&rsquo;ll use in our tests, but for now we&rsquo;ll just use it to store a valid JWT for our application. Then, in a <code>beforeEach</code> <a href=https://mochajs.org/#hooks rel=external target=_blank>Mocha hook</a>, we use the <code>login</code> helper we created earlier to log in as the &ldquo;admin&rdquo; user and store a valid JWT for that user in the <code>state.token</code> property.</p><p>Then, we pass that <code>state</code> object to the <code>getAllRoles</code> test. Inside of that test, we use the <code>state.token</code> property to set an <code>Authorization: Bearer</code> header for our request to the API. If everything works correctly, this test should now pass.</p><p>We can make similar updates to the other tests in this file:</p><div class=tab-panel data-tab-group=1b3bfac6c1138d6e200a8f2e3b4137be><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1b3bfac6c1138d6e200a8f2e3b4137be","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check JSON Schema of Roles
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>getRolesSchemaMatch</span> <span class=o>=</span> <span class=p>(</span><span class=nx>state</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;all roles should match schema&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>schema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;array&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>items</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>required</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>properties</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>id</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;number&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>role</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;iso-date-time&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;iso-date-time&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>additionalProperties</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;Authorization&#39;</span><span class=p>,</span> <span class=sb>`Bearer </span><span class=si>${</span><span class=nx>state</span><span class=p>.</span><span class=nx>token</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>jsonSchema</span><span class=p>(</span><span class=nx>schema</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check Role exists in list
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>findRole</span> <span class=o>=</span> <span class=p>(</span><span class=nx>state</span><span class=p>,</span> <span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should contain &#39;&#34;</span> <span class=o>+</span> <span class=nx>role</span><span class=p>.</span><span class=nx>role</span> <span class=o>+</span> <span class=s2>&#34;&#39; role&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;Authorization&#39;</span><span class=p>,</span> <span class=sb>`Bearer </span><span class=si>${</span><span class=nx>state</span><span class=p>.</span><span class=nx>token</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>foundRole</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>role</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>foundRole</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>role</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/roles route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>state</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>beforeEach</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>state</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>login</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>getAllRoles</span><span class=p>(</span><span class=nx>state</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>getRolesSchemaMatch</span><span class=p>(</span><span class=nx>state</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>findRole</span><span class=p>(</span><span class=nx>state</span><span class=p>,</span> <span class=nx>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This will ensure that each RESTful API action will work properly with an authenticated user, but it doesn&rsquo;t test whether the user has the proper role to perform the action (in this instance, we are using the <code>admin</code> user which has the appropriate role already). On the next page, we&rsquo;ll build a very flexible system to perform unit testing on our role-based authorization middleware.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=testing-roles>Testing Roles</h1><a href="https://www.youtube.com/watch?v=lolT-mwmFvc">YouTube Video</a><h2 id=testing-role-based-authorization-middleware>Testing Role-Based Authorization Middleware</h2><p>Earlier in this example we created a generator function named <code>roleBasedAuth</code> (stored in <code>middlewares/authorized-roles.js</code>) that returns a middleware function named <code>roleAuthMiddleware</code> that we can use as a middleware in any of our RESTful API endpoints to ensure that only users with specific roles are able to perform each and every action in our API.</p><p>When it comes to testing, however, this can quickly become really complex. For example, if we have 15 routes and 6 user roles, we must write 120 tests just to test each combination of route and role in order to truly test this setup.</p><p>In addition, if we continue to use our current strategy of integration testing (where each test performs a full action on the API), the tests we write will need to be unique for each endpoint, so even if we simplify things, we&rsquo;ll still need at least 2 tests per endpoint (one for roles that should have access, and another for roles that should not).</p><p>Instead, let&rsquo;s look at a way we can deconstruct our Express application a bit to test two things directly:</p><ol><li>Is the <code>roleAuthMiddleware</code> present on each route?</li><li>Does the <code>roleAuthMiddleware</code> function allow the correct roles for each route?</li></ol><p>If we can confirm both of these for each route, we can assume that our role-based authorization is implemented correctly.</p><h2 id=express-route-stack>Express Route Stack</h2><p>As you may recall, applications written in Express consist of an application that has middlewares and handlers attached in a specific order. In addition, we can create smaller components called routers that each have their own middlewares and handlers attached. Overall, we may end up with a structure similar to this one:</p><p><a href=#R-image-6c2d10b1abe6d7dc7f769e4833d9b9bd class=lightbox-link><img alt="Express Architecture" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/express-routing-http.svg style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6c2d10b1abe6d7dc7f769e4833d9b9bd><img alt="Express Architecture" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/express-routing-http.svg></a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>A more detailed explanation of the structure of Express applications can be found here: <a href=https://www.sohamkamani.com/nodejs/expressjs-architecture/ rel=external target=_blank>https://www.sohamkamani.com/nodejs/expressjs-architecture/</a></p><p>In code, each Express router has a <code>stack</code> variable that contains a list of layers, which can either be middleware functions or actual route handlers. Middleware layers will contain the <code>name</code> of the middleware function, whereas route handlers can be checked using a <code>match</code> function to determine if the handler matches a given path.</p><p>So, in our <code>test/helpers.js</code> file, we can write a new helper function to this for our tests:</p><div class=tab-panel data-tab-group=d5a142b6375391a4f1151cc57e6753cb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d5a142b6375391a4f1151cc57e6753cb","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Iterate through the router stack of an Express app to find a matching middleware function
</span></span></span><span class=line><span class=cl><span class=cm> * attached to a particular path and/or method
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} name the name of the function to find
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} path the path of the endpoint
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} method the HTTP method of the endpoint
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Router} router The Express router to search
</span></span></span><span class=line><span class=cl><span class=cm> * @returns
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>findMiddlewareFunction</span> <span class=o>=</span> <span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>app</span><span class=p>.</span><span class=nx>_router</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>layer</span> <span class=k>of</span> <span class=nx>router</span><span class=p>.</span><span class=nx>stack</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Return if the middleware function is found
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>layer</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>layer</span><span class=p>.</span><span class=nx>handle</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>layer</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=nx>path</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Recurse into a router
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>layer</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=s2>&#34;router&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>layer</span><span class=p>.</span><span class=nx>path</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Remove matching portion of path
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>path</span> <span class=o>=</span> <span class=nx>path</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=nx>layer</span><span class=p>.</span><span class=nx>path</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>findMiddlewareFunction</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>layer</span><span class=p>.</span><span class=nx>handle</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find matching handler
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>layer</span><span class=p>.</span><span class=nx>route</span> <span class=o>&amp;&amp;</span> <span class=nx>layer</span><span class=p>.</span><span class=nx>route</span><span class=p>.</span><span class=nx>methods</span><span class=p>[</span><span class=nx>method</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>findMiddlewareFunction</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>layer</span><span class=p>.</span><span class=nx>route</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Using that function, we can now write another function to actually test our middleware using some mock objects:</p><div class=tab-panel data-tab-group=fb5319f30d684aa93f57276e39b11d36><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fb5319f30d684aa93f57276e39b11d36","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>expect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>sinon</span> <span class=nx>from</span> <span class=s2>&#34;sinon&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test if a role is able to access the route via the roleAuthMiddleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} path the path of the endpoint
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} method the HTTP method of the endpoint
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} role the role to search for
</span></span></span><span class=line><span class=cl><span class=cm> * @param {boolean} allowed whether the role should be allowed to access the route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>testRoleBasedAuth</span> <span class=o>=</span> <span class=p>(</span><span class=nx>path</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>role</span><span class=p>,</span> <span class=nx>allowed</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;should role &#39;&#34;</span> <span class=o>+</span> <span class=nx>role</span> <span class=o>+</span> <span class=s2>&#34;&#39; access &#39;&#34;</span> <span class=o>+</span> <span class=nx>method</span> <span class=o>+</span> <span class=s2>&#34; &#34;</span> <span class=o>+</span> <span class=nx>path</span> <span class=o>+</span> <span class=s2>&#34;&#39;: &#34;</span> <span class=o>+</span> <span class=nx>allowed</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Mock Express Request object with token attached
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>req</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>token</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;test&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>role</span><span class=o>:</span> <span class=nx>role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Mock Express Response object
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>status</span><span class=o>:</span> <span class=nx>sinon</span><span class=p>.</span><span class=nx>stub</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>send</span><span class=o>:</span> <span class=nx>sinon</span><span class=p>.</span><span class=nx>stub</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>.</span><span class=nx>returns</span><span class=p>(</span><span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Mock Express Next Middleware function
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>next</span> <span class=o>=</span> <span class=nx>sinon</span><span class=p>.</span><span class=nx>stub</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Find the middleware function in the router stack for the given path and method
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>middleware</span> <span class=o>=</span> <span class=nx>findMiddlewareFunction</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;roleAuthMiddleware&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>expect</span><span class=p>(</span><span class=nx>middleware</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>not</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Call the middleware function
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>middleware</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>allowed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If allowed, expect the `next` function to be called
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>expect</span><span class=p>(</span><span class=nx>next</span><span class=p>.</span><span class=nx>calledOnce</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Otherwise, it should send a 401 response
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>.</span><span class=nx>calledWith</span><span class=p>(</span><span class=mi>401</span><span class=p>)).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div></div></div></div><p>The comments in the function describe how it works pretty clearly. Most of the code is just setting up barebones mock objects using <a href=https://sinonjs.org/ rel=external target=_blank>Sinon</a> for the Express request <code>req</code>, response <code>res</code>, and <code>next</code> middleware function. Once it finds our <code>roleAuthMiddleware</code> function in the router stack using the helper function above, it will call it and observe the response to determine if the user was allowed to access the desired endpoint or not.</p><p>The last thing we&rsquo;ll add to our <code>test/helpers.js</code> file is a helpful list of all of the roles available in the application, which we can use for our testing:</p><div class=tab-panel data-tab-group=44e4bf81ae8df36e01571d39bdcbfda4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("44e4bf81ae8df36e01571d39bdcbfda4","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// List of global roles
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>all_roles</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;manage_users&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;manage_documents&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;add_documents&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;manage_communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;add_communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;view_documents&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;view_communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>];</span></span></span></code></pre></div></div></div></div></div><p>With those helpers in place, we can now add a few lines to our <code>test/api/v1/roles.js</code> test file to check whether each and every role can access the endpoint in that router.</p><div class=tab-panel data-tab-group=1e689c763bbdbfdeeba822604997d930><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1e689c763bbdbfdeeba822604997d930","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import Helpers
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>login</span><span class=p>,</span> <span class=nx>testRoleBasedAuth</span><span class=p>,</span> <span class=nx>all_roles</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../helpers.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/roles route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=s2>&#34;get&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This code does a couple of very nifty things. First, we clearly define which roles should be allowed to access the endpoint. This can be done as part of the unit testing file here, or we may have some global file in our test suite that documents each role and route that we can read from.</p><p>Below that, we iterate through the list of all roles exported from the <code>test/helpers.js</code> file, and call our <code>testRoleBasedAuth</code> method for each one of those roles. The last argument to that function is a boolean that determines whether the role should be able to access this route. To determine that, we simply see if the role from the list of global roles can also be found in the list of allowed roles. If so, that will be <code>true</code> and the function will check that the role can access the route. If not, it will be <code>false</code> and the function will confirm that the user is unable to access the route.</p><p>Now, when we run these tests, we&rsquo;ll see that each role is explicitly checked:</p><div class=tab-panel data-tab-group=98d39b67542bda567a8db9be19e6221b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("98d39b67542bda567a8db9be19e6221b","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api/v1/roles
    GET /
      ‚úî should list all roles
      ‚úî all roles should match schema
      ‚úî should contain &#39;manage_users&#39; role
      ‚úî should contain &#39;manage_documents&#39; role
      ‚úî should contain &#39;add_documents&#39; role
      ‚úî should contain &#39;manage_communities&#39; role
      ‚úî should contain &#39;add_communities&#39; role
      ‚úî should contain &#39;view_documents&#39; role
      ‚úî should contain &#39;view_communities&#39; role
      ‚úî should role &#39;manage_users&#39; access &#39;get /api/v1/roles&#39;: true
      ‚úî should role &#39;manage_documents&#39; access &#39;get /api/v1/roles&#39;: false
      ‚úî should role &#39;add_documents&#39; access &#39;get /api/v1/roles&#39;: false
      ‚úî should role &#39;manage_communities&#39; access &#39;get /api/v1/roles&#39;: false
      ‚úî should role &#39;add_communities&#39; access &#39;get /api/v1/roles&#39;: false
      ‚úî should role &#39;view_documents&#39; access &#39;get /api/v1/roles&#39;: false
      ‚úî should role &#39;view_communities&#39; access &#39;get /api/v1/roles&#39;: false</code></pre></div></div></div></div></div><p>There we go! We now have a very flexible way to test our role-based authorization.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Image Source: <a href=https://www.sohamkamani.com/nodejs/expressjs-architecture/ rel=external target=_blank>https://www.sohamkamani.com/nodejs/expressjs-architecture/</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=users-api-updates>Users API Updates</h1><a href="https://www.youtube.com/watch?v=9aIS1mF5J-Y">YouTube Video</a><h2 id=users-api-roles>Users API Roles</h2><p>We should also add our role-based authorization middleware to our <code>/api/v1/users</code> routes. This can actually be done really simply, because we only want users with the <code>manage_users</code> role to be able to access any of these routes.</p><p>So, instead of attaching the middleware to each handler individually, we can attach it directly to the router before any handlers:</p><div class=tab-panel data-tab-group=eff351b413c6b7fdc663153bb46c757b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("eff351b413c6b7fdc663153bb46c757b","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: users
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Users Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ValidationError</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;sequelize&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import middlewares
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>roleBasedAuth</span> <span class=nx>from</span> <span class=s2>&#34;../../../middlewares/authorized-roles.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import utilities
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>handleValidationError</span> <span class=nx>from</span> <span class=s2>&#34;../../../utilities/handle-validation-error.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>sendSuccess</span> <span class=nx>from</span> <span class=s2>&#34;../../../utilities/send-success.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Add Role Authorization to all routes
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>roleBasedAuth</span><span class=p>(</span><span class=s2>&#34;manage_users&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>That&rsquo;s all it takes to add role-based authorization to an entire router! It is really simple.</p><p>We also should remember to add the new <code>security</code> section to our Open API documentation comments for each route to ensure that our documentation properly displays that each route requires authentication.</p><h2 id=users-api-unit-tests---authentication>Users API Unit Tests - Authentication</h2><p>As part of our updates, we need to add authentication to each of our unit tests for the <code>/api/v1/users</code> routes. This is relatively straightforward based on what we did in the previous page - it just requires a few tweaks per test.</p><p>In short, we need to add a <code>state</code> variable that we can use that contains a token for a user, and then pass that along to each test. We can do this in the global <code>describe</code> section at the bottom:</p><div class=tab-panel data-tab-group=40a2d238b1da18ddd58e0f8245e7b3af><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("40a2d238b1da18ddd58e0f8245e7b3af","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api/v1/users Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span><span class=p>,</span> <span class=nx>expect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Ajv</span> <span class=nx>from</span> <span class=s2>&#34;ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>addFormats</span> <span class=nx>from</span> <span class=s2>&#34;ajv-formats&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../../../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import Helpers
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>login</span><span class=p>,</span> <span class=nx>testRoleBasedAuth</span><span class=p>,</span> <span class=nx>all_roles</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../helpers.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=kd>let</span> <span class=nx>state</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>  <span class=nx>beforeEach</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>state</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>login</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Notice that we are able to add that code outside of the <code>describe</code> sections for each API endpoint, greatly simplifying things. Of course, if we need to log in as multiple users, we can either add additional tokens to the <code>state</code> or move the <code>state</code> and <code>beforeEach</code> methods to other locations in the code.</p><p>Once we have our state, we can simply pass it on to the tests and update each test to use it correctly by setting an <code>Authorization: Bearer</code> header on each request:</p><div class=tab-panel data-tab-group=6f5fb520a68d908376c5f925e6cf8d6f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6f5fb520a68d908376c5f925e6cf8d6f","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all Users
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>getAllUsers</span> <span class=o>=</span> <span class=p>(</span><span class=nx>state</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should list all users&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s2>&#34;Authorization&#34;</span><span class=p>,</span> <span class=sb>`Bearer </span><span class=si>${</span><span class=nx>state</span><span class=p>.</span><span class=nx>token</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>state</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>beforeEach</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>state</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>login</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>getAllUsers</span><span class=p>(</span><span class=nx>state</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>We won&rsquo;t exhaustively show each update to these tests here since there are so many. Take the time now to update all of the <code>/api/v1/users</code> unit tests to include authentication before continuing. They should all pass once authentication is enabled.</p><h2 id=users-api-unit-tests---role-based-authorization>Users API Unit Tests - Role-Based Authorization</h2><p>Finally, we should add additional unit tests to ensure that each endpoint in the <code>/api/v1/users</code> router is accessible only by users with the correct role. For that, we can simply add a block of code similar to what we did in the <code>roles</code> routes for each endpoint:</p><div class=tab-panel data-tab-group=6186b66ae609e12ddfebbcc74ff93bcc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6186b66ae609e12ddfebbcc74ff93bcc","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>state</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>beforeEach</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>state</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>login</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=s2>&#34;get&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/1&#34;</span><span class=p>,</span> <span class=s2>&#34;get&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;POST /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=s2>&#34;post&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;PUT /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/1&#34;</span><span class=p>,</span> <span class=s2>&#34;put&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;DELETE /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/1&#34;</span><span class=p>,</span> <span class=s2>&#34;delete&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>All told, there should now be 88 total unit test in that file alone - that is a lot of tests for just 5 API endpoints!</p><p>Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub.</p><p>That concludes the first set of tutorials for building a RESTful API. In the next set of tutorials, we&rsquo;ll focus on building a Vue.js frontend for our application.</p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=vuejs-starter-project>Vue.js Starter Project</h1><p>This example project builds on the previous RESTful API project by scaffolding a frontend application using Vue.js. This will become the basis for a full frontend for the application over the next few projects.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li>A single page frontend application running in <a href=https://vuejs.org/ rel=external target=_blank>Vue 3</a>.</li><li>Built-in Vue features such as <a href=https://router.vuejs.org/ rel=external target=_blank>Vue Router</a> and <a href=https://pinia.vuejs.org/ rel=external target=_blank>Pinia</a>.</li><li>Access to components and icons from <a href=https://primevue.org/ rel=external target=_blank>PrimeVue</a>.</li><li>Access to <a href=https://tailwindcss.com/ rel=external target=_blank>Tailwind CSS</a> for additional CSS styling and features.</li><li>A working <a href=https://primevue.org/theming/styled/#darkmode rel=external target=_blank>Dark Mode Theme</a> completed with a selector that remembers our preference.</li><li>A working <a href=https://vite.dev/ rel=external target=_blank>Vite</a> server that will proxy requests to our backend RESTful API seamlessly.</li><li>An <a href=https://axios-http.com/ rel=external target=_blank>Axios</a> client that can access our RESTful API routes.</li><li>A seamless system for authentication and requesting a JWT to access protected API routes.</li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Vue.js Starter Project</h1><article class=default><header class=headline></header><h1 id=vue-starter>Vue Starter</h1><a href="https://www.youtube.com/watch?v=p7gHGdYVdfA">YouTube Video</a><h2 id=vue-starter>Vue Starter</h2><p>Now that we&rsquo;ve built a solid backend for our application through our RESTful API, we can now start on building the frontend application that our users will actually interface with. There are many techniques and tools for writing frontend applications that we&rsquo;ve covered in this course, but for this project we&rsquo;re going to introduce once more, called <a href=https://vuejs.org/ rel=external target=_blank>Vue</a>. Vue is very similar to React, but uses a more streamlined syntax and structure. It also includes a lot of built-in features that make writing an interactive web application a very seamless experience. As with any tool we&rsquo;ve introduced in this set of tutorials, it is always a good idea to review the <a href=https://vuejs.org/guide/introduction.html rel=external target=_blank>Vue Documentation</a> as we add features to our application.</p><p>To get started, we&rsquo;ll use the <a href=https://github.com/vuejs/create-vue rel=external target=_blank>create-vue</a> application to help scaffold our project. This is very similar to the <code>express-generator</code> tool we used to create the initial version of our backend application.</p><p>So, in the base of our project directory (not in the <code>server</code> folder, but in the folder that contains the <code>server</code> folder), we&rsquo;ll run the following command:</p><div class=tab-panel data-tab-group=ffc928768e8d8573da301419e16a743c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ffc928768e8d8573da301419e16a743c","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm create vue@latest</span></span></code></pre></div></div></div></div></div><p>When we run this command, it will first install the package if it isn&rsquo;t already installed, and then we&rsquo;ll be asked a series of questions about what type of project we want to create. As of the writing of this tutorial, here are the current questions and the answers we&rsquo;ll give:</p><ul><li>Project name: <code>client</code> (this will place our code in the <code>client</code> directory; we&rsquo;ll update our project name later)</li><li>Features to include: Router, Pinia, Vitest, ESLint, Prettier (use arrow keys to navigate and spacebar to select each item, then press enter to confirm the selections)</li><li>Install Oxlint for faster linting: No</li></ul><p>All told, we should end up with output that looks like this:</p><div class=tab-panel data-tab-group=eb7a307cf5f0b39eed7b8a828fb68cd4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("eb7a307cf5f0b39eed7b8a828fb68cd4","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>‚îå  Vue.js - The Progressive JavaScript Framework
‚îÇ
‚óá  Project name (target directory):
‚îÇ  client
‚îÇ
‚óá  Select features to include in your project: (‚Üë/‚Üì to navigate, space to select, a to toggle all, enter to confirm)
‚îÇ  Router (SPA development), Pinia (state management), Vitest (unit testing), ESLint (error prevention), Prettier (code formatting)
‚îÇ
‚óá  Install Oxlint for faster linting? (experimental)
‚îÇ  No

Scaffolding project in /workspaces/lost-communities-solution/client...
‚îÇ
‚îî  Done. Now run:

   cd client
   npm install
   npm run format
   npm run dev

| Optional: Initialize Git in your project directory with:
   
   git init &amp;&amp; git add -A &amp;&amp; git commit -m &#34;initial commit&#34;</code></pre></div></div></div></div></div><p>So, once we&rsquo;ve created our project, we can follow the last few steps to install the libraries needed for our project and then run it. First, we&rsquo;ll navigate to the <code>client</code> directory:</p><div class=tab-panel data-tab-group=cedbae935c61b5627d7db85bc8164dd6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cedbae935c61b5627d7db85bc8164dd6","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>cd</span> client</span></span></code></pre></div></div></div></div></div><p>Then, we&rsquo;ll install our libraries, run the code formatter, and then start our application in development mode:</p><div class=tab-panel data-tab-group=63a081f7faf4d326736f0567a2e5bc74><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("63a081f7faf4d326736f0567a2e5bc74","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install
</span></span><span class=line><span class=cl>$ npm run format
</span></span><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>If everything works correctly, we should see our application start on port <code>5173</code> (the default port used by <a href=https://vite.dev/ rel=external target=_blank>Vite</a>, which is the tool used to run our Vue application in development mode). We can click the &ldquo;Open in Browser&rdquo; button that appears at the bottom of the page to load our application:</p><p><a href=#R-image-6c3e2fe4c42579ac5ae34b73b790b831 class=lightbox-link><img alt="Vue Development Mode" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6c3e2fe4c42579ac5ae34b73b790b831><img alt="Vue Development Mode" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_1.png></a></p><p>When we click that button to load our sample application, we should see the default Vue starter page appear in our browser:</p><p><a href=#R-image-20cb7d440e7ef407ff9ba093cc0312f5 class=lightbox-link><img alt="Vue Starter Page" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-20cb7d440e7ef407ff9ba093cc0312f5><img alt="Vue Starter Page" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_2.png></a></p><p>There we go! That&rsquo;s the basic steps to install Vue and create a scaffolded application. Let&rsquo;s take a look at some of the files it created and what they do.</p><p>As always, we can stop our running application using <kbd>CTRL</kbd> + <kbd>C</kbd>.</p><h2 id=exploring-the-vue-application>Exploring the Vue Application</h2><p>Our Vue application includes a lot of files and folders by default. Here&rsquo;s a brief list of what we find:</p><ul><li><code>.vscode</code> - this folder contains settings specific to the VS Code IDE. However, since they are in a subfolder of our project, they aren&rsquo;t actively being used. If we want to make use of these settings, we can move the folder up to the top level. We won&rsquo;t do that for this project, but it is an option worth exploring to see what settings are recommended by the developers behind the Vue project.</li><li><code>public</code> - this folder contains all public resources for our application, such as images. Right now it just contains a default <code>favicon.ico</code> file.</li><li><code>src</code> - all of the code for our application is contained in this folder. We&rsquo;ll explore this folder in depth throughout this tutorial.</li><li><code>.editorconfig</code> - this contains some editor settings that can be recognized by various text editors and IDEs. To use this in VS Code, we can install the <a href="https://marketplace.visualstudio.com/items?itemName=EditorConfig.EditorConfig" rel=external target=_blank>EditorConfig for VS Code</a> extension. Again, we won&rsquo;t do that for this project, but it is an option to explore.</li><li><code>.gitattributes</code> and <code>gitignore</code> - these are settings files used by Git. We should already be familiar with the functionality provided by a <code>.gitignore</code> file!</li><li><code>.prettierrc.json</code> - this is the settings file for the Prettier code formatter. It includes some useful default settings for that tool.</li><li><code>eslint.config.js</code> - this is the settings file for the ESLint tool. Similar to Prettier, it includes some default settings.</li><li><code>index.html</code> - this is the actual index page for our final application. In general, we won&rsquo;t need to make many changes to it unless we need to change some of the headers on that page.</li><li><code>jsconfig.json</code> - this file contains the settings used by the JavaScript language service used to build the project through Vite (we&rsquo;ll look at this a bit later)</li><li><code>package.json</code> and <code>package-lock.json</code> - these are the familiar Node package files we&rsquo;ve already seen in our backend application.</li><li><code>vite.config.js</code> - this is the configuration file for the <a href=https://vite.dev/ rel=external target=_blank>Vite</a> tool, which we use to run our application in development mode, and also the tool we&rsquo;ll use to build the deployable version of our application.</li><li><code>vitest.config.js</code> - this is the configuration file for the <a href=https://vitest.dev/ rel=external target=_blank>Vitest</a> testing framework, which we&rsquo;ll cover a bit later as we develop our application.</li></ul><h2 id=customizing-the-project>Customizing the Project</h2><p>Before we move ahead, let&rsquo;s update the contents of our <code>package.json</code> file to match the project we&rsquo;re working on. We should at least set the <code>name</code> and <code>version</code> entries to the correct values, and also take a look at the various scripts available in our application:</p><div class=tab-panel data-tab-group=4f53fd11c99bf6ce57d7d380ecd2d7b1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4f53fd11c99bf6ce57d7d380ecd2d7b1","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-project-frontend&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;module&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;vite&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;build&#34;</span><span class=p>:</span> <span class=s2>&#34;vite build&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;preview&#34;</span><span class=p>:</span> <span class=s2>&#34;vite preview&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;test:unit&#34;</span><span class=p>:</span> <span class=s2>&#34;vitest&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;lint&#34;</span><span class=p>:</span> <span class=s2>&#34;eslint . --fix&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;format&#34;</span><span class=p>:</span> <span class=s2>&#34;prettier --write src/&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=- 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>On the next page, we&rsquo;ll start building our frontend application! As we add features, we&rsquo;ll slowly modify some of these configuration files to make our application easier to develop and work with.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=exploring-vue>Exploring Vue</h1><a href="https://www.youtube.com/watch?v=bMU-fIjCV2s">YouTube Video</a><h2 id=install-the-vue-extension>Install the Vue Extension</h2><p>First, in our Visual Studio Code instance, we will want to install the <a href="https://marketplace.visualstudio.com/items?itemName=Vue.volar" rel=external target=_blank>Vue - Official</a> extension. Make sure it is the correct, official plugin, since there are many that share a similar name in the VS Code extension marketplace:</p><p><a href=#R-image-fdc9bbebb55c7b211087ea650ab11843 class=lightbox-link><img alt="Vue Extension" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_6.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fdc9bbebb55c7b211087ea650ab11843><img alt="Vue Extension" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_6.png></a></p><p>As always, you can click the gear next to the install button to add it to the <code>devcontainer.json</code> file, so it will be installed in future devcontainers built using this repository. Once it is installed, you may have to restart VS Code or refresh the page in GitHub Codespaces to get it activated. Once it is, you should see syntax highlighting enabled in any files with the <code>vue</code> file extension.</p><h2 id=exploring-the-source-code>Exploring the Source Code</h2><p>Let&rsquo;s take a quick look inside of the <code>src</code> folder to explore the structure of our application a bit more in detail.</p><ul><li><code>assets</code> - this folder contains the static assets used throughout our application, such as CSS files, SVG images, and other items that we want to include in the build pipeline of our application.</li><li><code>components</code> - this folder contains the individual components used to make up our application, as well as any associated tests. We can see that there are a few components already created in our application, including <code>HelloWorld.vue</code>, <code>TheWelcome.vue</code>, and <code>WelcomeItem.vue</code>.</li><li><code>router</code> - this folder contains the <a href=https://router.vuejs.org/ rel=external target=_blank>Vue Router</a> for our application. This is similar to the routers we&rsquo;ve already used in our Express application, but instead of matching URLs to endpoints, this tool is used to match URLs to different views, or pages, within our application.</li><li><code>stores</code> - this folder contains the <a href=https://pinia.vuejs.org/ rel=external target=_blank>Pinia</a> stores for our application. These stores are used to share data between components in our application, and also to connect back to our backend application through our RESTful API.</li><li><code>views</code> - this folder contains the overall views of our application, sometimes referred to as pages. As we can see, right now there is a <code>HomeView.vue</code> and an <code>AboutView.vue</code>, which correspond to the Home and About pages of our existing application.</li><li><code>App.vue</code> - this file contains the top-level Vue component of our entire web application. It contains items that are globally included on every page.</li><li><code>main.js</code> - this file is the &ldquo;setup&rdquo; file for the Vue application, very similar to the <code>app.js</code> file in our Express backend application. This is where a variety of application settings and plugins can be installed and configured.</li></ul><p>So, let&rsquo;s look at our existing page in development mode. It includes a feature called <a href=https://devtools.vuejs.org/ rel=external target=_blank>Vue DevTools</a> which is a great way to explore our application. That feature can be found by clicking the small floating button at the bottom of the page:</p><p><a href=#R-image-8f360d0a6590e2c376fd43f791bbc57d class=lightbox-link><img alt="Vue Starter Page" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8f360d0a6590e2c376fd43f791bbc57d><img alt="Vue Starter Page" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_3.png></a></p><p>It will open a tool that allows us to explore the components loaded into our page, the various views available, router settings, Pinia stores, and so much more:</p><p><a href=#R-image-ef7936ea376ab1e77f618386fe3d4d28 class=lightbox-link><img alt="Vue DevTools" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ef7936ea376ab1e77f618386fe3d4d28><img alt="Vue DevTools" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_4.png></a></p><p>We can also use the component inspector (the button with the target icon that appears when we hover over the Vue DevTools button) to see how the individual components are laid out on our page, just by hovering over them:</p><p><a href=#R-image-7bdb5765e4f4f4b7e61739706bd846c5 class=lightbox-link><img alt="Vue Component Inspector" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7bdb5765e4f4f4b7e61739706bd846c5><img alt="Vue Component Inspector" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_5.png></a></p><p>As we work on this project, this tool will be a very helpful asset for debugging our application, or simply understanding how it works. Now is a great time to play around with this tool on our scaffolded starter page before we start building our own.</p><h2 id=cleaning-out-the-starter-project>Cleaning Out the Starter Project</h2><p>To start building our own application, let&rsquo;s first start by clearing out the default content included in our scaffolded application. So, we can delete the following files:</p><ul><li><code>assets\*</code> - everything in the <code>assets</code> folder</li><li><code>components\*</code> - everything in the <code>components</code> folder</li><li><code>stores\*</code> - everything in the <code>stores</code> folder</li></ul><p>Now, let&rsquo;s customize a few files. First, we&rsquo;ll update the <code>index.html</code> file to include our project&rsquo;s title as the header:</p><div class=tab-panel data-tab-group=90b1d853633d7cc0084c761466906ddf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=indexhtml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("90b1d853633d7cc0084c761466906ddf","indexhtml")'>
<span class=tab-nav-text>index.html</span></button></div><div class=tab-content-container><div data-tab-item=indexhtml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>link</span> <span class=na>rel</span><span class=o>=</span><span class=s>&#34;icon&#34;</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;/favicon.ico&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Example Project<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;app&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;module&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;/src/main.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Next, we&rsquo;ll update the two default views in our application to be simple components. First, let&rsquo;s update the <code>HomeView.vue</code>:</p><div class=tab-panel data-tab-group=ed3771cf7714eb31d258a586c138b646><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcviewshomeviewvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ed3771cf7714eb31d258a586c138b646","srcviewshomeviewvue")'>
<span class=tab-nav-text>src/views/HomeView.vue</span></button></div><div class=tab-content-container><div data-tab-item=srcviewshomeviewvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nx>This</span> <span class=nx>is</span> <span class=nx>a</span> <span class=nx>home</span> <span class=nx>page</span><span class=p>.</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>And also the <code>AboutView.vue</code>:</p><div class=tab-panel data-tab-group=304695b1ebe627181dfb5cb120b1dca4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcviewshomeviewvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("304695b1ebe627181dfb5cb120b1dca4","srcviewshomeviewvue")'>
<span class=tab-nav-text>src/views/HomeView.vue</span></button></div><div class=tab-content-container><div data-tab-item=srcviewshomeviewvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nx>This</span> <span class=nx>is</span> <span class=nx>an</span> <span class=nx>about</span> <span class=nx>page</span><span class=p>.</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Finally, we can update our base <code>App.vue</code> file to include a very simple format:</p><div class=tab-panel data-tab-group=1cfbd0d3203aaf1d02509fa48b7322e5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcappvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1cfbd0d3203aaf1d02509fa48b7322e5","srcappvue")'>
<span class=tab-nav-text>src/App.vue</span></button></div><div class=tab-content-container><div data-tab-item=srcappvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>RouterLink</span><span class=p>,</span> <span class=nx>RouterView</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue-router&#39;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>header</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nx>This</span> <span class=nx>is</span> <span class=nx>a</span> <span class=nx>header</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>nav</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>RouterLink</span> <span class=na>to</span><span class=o>=</span><span class=s>&#34;/&#34;</span><span class=p>&gt;</span><span class=nx>Home</span><span class=p>&lt;/</span><span class=nt>RouterLink</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>RouterLink</span> <span class=na>to</span><span class=o>=</span><span class=s>&#34;/about&#34;</span><span class=p>&gt;</span><span class=nx>About</span><span class=p>&lt;/</span><span class=nt>RouterLink</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>nav</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>header</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>RouterView</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll also need to update our <code>main.js</code> to remove the import for the base CSS file:</p><div class=tab-panel data-tab-group=bc7458c75ac685a07beecd247b8c522a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcmainjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bc7458c75ac685a07beecd247b8c522a","srcmainjs")'>
<span class=tab-nav-text>src/main.js</span></button></div><div class=tab-content-container><div data-tab-item=srcmainjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>createApp</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>createPinia</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;pinia&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>App</span> <span class=nx>from</span> <span class=s1>&#39;./App.vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>router</span> <span class=nx>from</span> <span class=s1>&#39;./router&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>createApp</span><span class=p>(</span><span class=nx>App</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>createPinia</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>router</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>mount</span><span class=p>(</span><span class=s1>&#39;#app&#39;</span><span class=p>)</span></span></span></code></pre></div></div></div></div></div><p>Now, let&rsquo;s take a look at our application in development mode to see what it looks like without all of the extra structure and style applied by the scaffolding:</p><div class=tab-panel data-tab-group=a82cd6e95d9efe677f05889d0f702256><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a82cd6e95d9efe677f05889d0f702256","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p><a href=#R-image-500e3d10812d63402cdeedd8d7b0ca18 class=lightbox-link><img alt="Vue Simple Page" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_7.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-500e3d10812d63402cdeedd8d7b0ca18><img alt="Vue Simple Page" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_7.png></a></p><p>As we can see, our application is now much simpler - almost too simple! However, we can still click the links to move between the Home and About pages, and see our URL update accordingly:</p><p><a href=#R-image-067a15ecdc36812ce9e83d35c3bfb007 class=lightbox-link><img alt="Vue About Page" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_8.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-067a15ecdc36812ce9e83d35c3bfb007><img alt="Vue About Page" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_8.png></a></p><p>This is a great baseline for our application. Now we can start building up a structure for an application that has the features we&rsquo;d like to see.</p><h2 id=architecture-of-a-vue-page>Architecture of a Vue Page</h2><p>The vast majority of the work we&rsquo;ll be doing in Vue is creating <a href=https://vuejs.org/guide/introduction.html#single-file-components rel=external target=_blank>Single File Components</a>, which are the building blocks for larger views and pages within our application. We&rsquo;ll be using the <a href=https://vuejs.org/guide/introduction.html#api-styles rel=external target=_blank>Composition API Style</a>, which is a newer and more powerful API. It can be a bit daunting for new developers, but it provides a flexible way to define our components. It also differs from the API style used by React, making it a bit of a learning curve for experienced React developers. We can see more discussion in the <a href=https://vuejs.org/guide/extras/composition-api-faq.html rel=external target=_blank>Composition API FAQ</a> document.</p><p>A Vue single file component using the Composition API style looks like this (taken from the <a href=https://vuejs.org/guide/introduction.html#single-file-components rel=external target=_blank>Vue Documentation</a>):</p><div class=tab-panel data-tab-group=eab60e9fd2bf9d7ced58efc081967803><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=vue-sfc-example class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("eab60e9fd2bf9d7ced58efc081967803","vue-sfc-example")'>
<span class=tab-nav-text>Vue SFC Example</span></button></div><div class=tab-content-container><div data-tab-item=vue-sfc-example class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>count</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>button</span> <span class=nt>@click</span><span class=s>=&#34;count++&#34;</span><span class=p>&gt;</span><span class=na>Count</span> <span class=na>is</span><span class=o>:</span> <span class=p>{{</span> <span class=na>count</span> <span class=p>}}&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span> <span class=na>scoped</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=nx>button</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>font</span><span class=o>-</span><span class=nx>weight</span><span class=o>:</span> <span class=nx>bold</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>This file is divided into three important sections:</p><ul><li><code>&lt;script setup></code> - this section defines the functionality of the component, and is written using JavaScript syntax. It is the rough equivalent of the code you might put in a function called as the page begins to load in a traditional website. This code is used to configure all of the <em>reactive</em> elements of the user interface, as we&rsquo;ll see later.</li><li><code>&lt;template></code> - this section defines the structure of the component, and uses a syntax similar to HTML. It gives the overall layout of the component and includes all sub-components and other HTML elements. It also shows where the reactive elements defined earlier appear on the page itself.</li><li><code>&lt;style></code> - this section defines the style of the component, and it is written using CSS. These style elements can be applied throughout the application, or we can use a <code>&lt;style scoped></code> section to ensure these styles are only applied within this component.</li></ul><p>As we can see, Vue follows the concept of <a href=https://en.wikipedia.org/wiki/Separation_of_concerns rel=external target=_blank>Separation of Concerns</a> just like we&rsquo;ve seen in our earlier projects. However, instead of having a global HTML template, a site-wide CSS file, and a single JavaScript file for an entire page, each component itself contains just the HTML, CSS, and JavaScript needed for that single component to function. In this way, we can treat each component as a stand-alone part of our application, and as we learn more about how to build useful and flexible components, we&rsquo;ll see just how powerful this structure can be.</p><p>On the next page, we&rsquo;ll start building our simple web application by using a few pre-built components from a Vue component library.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=primevue>PrimeVue</h1><a href="https://www.youtube.com/watch?v=SXfu755SIcM">YouTube Video</a><h2 id=install-primevue>Install PrimeVue</h2><p>One of the first things we may want to install in our application is a library of ready-to-use components that we can use to build our application with. This can drastically cut down on the time it takes to build an application, and these libraries often come with a range of features that make our applications both user-friendly and very accessible.</p><p>While there are many different libraries to choose from, we&rsquo;ll use the <a href=https://primevue.org/ rel=external target=_blank>PrimeVue</a> library. PrimeVue has a very large set of components to choose from, and it is very easy to install and configure. So, let&rsquo;s follow the <a href=https://primevue.org/vite rel=external target=_blank>installation guide</a> to install PrimeVue in a project that uses Vite as it&rsquo;s build tool.</p><p>First, we&rsquo;ll need to install the library through <code>npm</code>:</p><div class=tab-panel data-tab-group=f289be74afd1c38f5b1951376a7ddee0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f289be74afd1c38f5b1951376a7ddee0","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install primevue @primeuix/themes</span></span></code></pre></div></div></div></div></div><p>Once that is installed, we need to configure the plugin by adding it to our <code>main.js</code> file. We&rsquo;ve added some documentation comments to this file to make it easily readable, but the new lines added for PrimeVue are highlighted below:</p><div class=tab-panel data-tab-group=95033b9be04a513874dc91580a4e4a8b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcmainjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("95033b9be04a513874dc91580a4e4a8b","srcmainjs")'>
<span class=tab-nav-text>src/main.js</span></button></div><div class=tab-content-container><div data-tab-item=srcmainjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Main Vue application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>createApp</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>createPinia</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;pinia&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>PrimeVue</span> <span class=nx>from</span> <span class=s1>&#39;primevue/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Vue App
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>App</span> <span class=nx>from</span> <span class=s1>&#39;./App.vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>router</span> <span class=nx>from</span> <span class=s1>&#39;./router&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Vue App
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>createApp</span><span class=p>(</span><span class=nx>App</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Install Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>createPinia</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>router</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>PrimeVue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Mount Vue App on page
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>mount</span><span class=p>(</span><span class=s1>&#39;#app&#39;</span><span class=p>)</span></span></span></code></pre></div></div></div></div></div><p>There we go! Now we can use PrimeVue components anywhere in our application. So, let&rsquo;s start building a basic framework for our application&rsquo;s overall look and feel.</p><h2 id=primevue-menubar-layout>PrimeVue Menubar Layout</h2><p>A good first step is to build the overall layout that all of our views, or pages, within our application will use. This is similar to the concept of template inheritance that we&rsquo;ve explored already in this class. For this application, let&rsquo;s assume we want to have a static menu bar at the top of the page that has links to other pages or views in our application across the top. On the left of that bar, we should have some settings buttons that allow the user to switch between light or dark mode, as well as a button to access their user profile and either login or logout of the system. A quick wireframe sketch of this site might look something like this:</p><p><a href=#R-image-354ceb688afd0293e82d111d62172756 class=lightbox-link><img alt="Vue Mockup" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_mockup.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-354ceb688afd0293e82d111d62172756><img alt="Vue Mockup" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_mockup.png></a></p><p>As it just so happens, as we look through the PrimeVue list of components, we see a component named <a href=https://primevue.org/menubar/ rel=external target=_blank>Menubar</a> that has an example template that looks very similar to our existing wireframe:</p><p><a href=#R-image-fbf383f045c76b6b197589915572efac class=lightbox-link><img alt="PrimeVue Menubar" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_mockup2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fbf383f045c76b6b197589915572efac><img alt="PrimeVue Menubar" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_mockup2.png></a></p><p>So, let&rsquo;s see if we can explore how to use this PrimeVue component and make it fit our desired website structure. Of course, there is always a little give and take to using these libraries; while we may have a very specific view or layout in mind, often it is best to let the component library guide us a bit by seeing that it already does well, and then adapting it for our needs.</p><h2 id=using-a-primevue-component>Using a PrimeVue Component</h2><p>In the PrimeVue documentation, each component comes with several example templates we can use. However, by default, the template code that is visible on the website is only a small part of the whole component that is actually displayed on the screen. So, we may first want to click the &ldquo;Toggle Full Code&rdquo; button that appears in the upper right corner of the code panel when we hover over it - that will show us the full example component:</p><p><a href=#R-image-69d5f259ec431858d08121edb8b8e5e0 class=lightbox-link><img alt="PrimeVue Show Full Code" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/primevue_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-69d5f259ec431858d08121edb8b8e5e0><img alt="PrimeVue Show Full Code" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/primevue_1.png></a></p><p>Once we have that full code, we can explore how it works in greater detail, comparing the code shown in each example to the component we see placed above it.</p><p>For this component, we&rsquo;ll build it up from scratch just to see how each part works. Once we are more familiar with PrimeVue components and how they are structured, we can copy these code examples easily into our own components and tweak them to fit our needs.</p><p>First, let&rsquo;s create a new folder named <code>layout</code> in our <code>src/components</code> folder, and then inside of that we can create a new Vue component named <code>TopMenu.vue</code>. Let&rsquo;s start by adding the two basic sections of any Vue component, the <code>&lt;script setup></code> and <code>&lt;template></code> sections:</p><div class=tab-panel data-tab-group=851fe937bd2cbac8340612da50b7567b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayouttopmenuvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("851fe937bd2cbac8340612da50b7567b","srccomponentslayouttopmenuvue")'>
<span class=tab-nav-text>src/components/layout/TopMenu.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayouttopmenuvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Top menu bar of the entire application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nx>Content</span> <span class=nx>Here</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Next, we can import the <a href=https://primevue.org/menubar/ rel=external target=_blank>PrimeVue Menubar</a> component in the <code>&lt;script setup></code> section of our component, and place it in the <code>&lt;template></code> section:</p><div class=tab-panel data-tab-group=24606003fa6db4e4848ab681bc383b8d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayouttopmenuvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("24606003fa6db4e4848ab681bc383b8d","srccomponentslayouttopmenuvue")'>
<span class=tab-nav-text>src/components/layout/TopMenu.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayouttopmenuvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Top menu bar of the entire application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import Components
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Menubar</span> <span class=nx>from</span> <span class=s1>&#39;primevue/menubar&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>Menubar</span> <span class=nt>:model</span><span class=o>=</span><span class=s>&#34;items&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>In the documentation, it says that we need to include a collection of menu items as the <code>model</code> of the component. A component&rsquo;s <code>model</code> can be thought of as the <strong>viewmodel</strong> part of the <a href=https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93viewmodel rel=external target=_blank>Model View ViewModel</a> architecture pattern we may already be familiar with. In effect, PrimeVue components take care of the <strong>view</strong> part of this pattern, and we must adapt our existing data <strong>model</strong> by providing a <strong>viewmodel</strong> reference that fits the structure expected by the component.</p><p>In this instance, we want our menubar to include links to the <code>home</code> and <code>about</code> pages, or views, of our application, so those will be the items we&rsquo;ll include. To do this, we need to create a reactive state element in Vue using the <code>ref()</code> function. For more about how reactivity works in Vue, consult the <a href=https://vuejs.org/guide/essentials/reactivity-fundamentals.html rel=external target=_blank>Vue Documentation</a>.</p><div class=tab-panel data-tab-group=169b2433168db2a6a6c082e56713d253><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayouttopmenuvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("169b2433168db2a6a6c082e56713d253","srccomponentslayouttopmenuvue")'>
<span class=tab-nav-text>src/components/layout/TopMenu.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayouttopmenuvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Top menu bar of the entire application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;vue&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Components
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Menubar</span> <span class=nx>from</span> <span class=s1>&#39;primevue/menubar&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Declare State
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>items</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;Home&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;About&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span>
</span></span><span class="line hl"><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>At this point we&rsquo;ve created a basic structure for our <code>TopMenu</code> component, so let&rsquo;s add it to our site and see what it looks like. To do this, we&rsquo;ll import it into our <code>App.vue</code> file and add it to the template there (we&rsquo;ll end up removing some content and libraries that were already included in that file, which is fine):</p><div class=tab-panel data-tab-group=e94f94324386e8f6936c61141a18a601><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcappvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e94f94324386e8f6936c61141a18a601","srcappvue")'>
<span class=tab-nav-text>src/App.vue</span></button></div><div class=tab-content-container><div data-tab-item=srcappvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Main Vue Application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import Components
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>TopMenu</span> <span class=nx>from</span> <span class=s1>&#39;./components/layout/TopMenu.vue&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>header</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>TopMenu</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>header</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>RouterView</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Now, let&rsquo;s run our application in development mode and see what it looks like:</p><div class=tab-panel data-tab-group=801758bf2419484eb77289104d08122b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("801758bf2419484eb77289104d08122b","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>When we navigate to our page in the browser, we should see this layout:</p><p><a href=#R-image-0a8f124b06bcc9f64c9ad9c24e879526 class=lightbox-link><img alt="PrimeVue Basic Layout" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/primevue_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0a8f124b06bcc9f64c9ad9c24e879526><img alt="PrimeVue Basic Layout" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/primevue_2.png></a></p><p>While this page still seems very simple, we can use the Vue DevTools to explore the page and see that our components are present. However, they aren&rsquo;t really styled the way we see in the PrimeVue examples. This is because we need to install a <a href=https://primevue.org/theming/styled/ rel=external target=_blank>PrimeVue Theme</a> that provides the overall look and feel of our application.</p><h2 id=primevue-themes>PrimeVue Themes</h2><p>PrimeVue includes several built-in themes that we can choose from:</p><ul><li>Aura - this theme is the one developed exclusively for PrimeVue</li><li>Material - this theme mimics <a href=https://m2.material.io/ rel=external target=_blank>Google&rsquo;s Material Design v2</a></li><li>Lara - this theme is based on the styling found in <a href=https://getbootstrap.com/ rel=external target=_blank>Bootstrap</a></li><li>Nora - this theme is inspired by several enterprise applications that use a simple style</li></ul><p>We can explore what each of these themes look like by selecting them on the PrimeVue documentation website - the whole website can be themed and styled based on any of the built-in options available in PrimeVue, which is a great way for us to see what is available and how it might look on our page.</p><p>For this application, we&rsquo;ll use the Aura theme, so let&rsquo;s install it in our <code>main.js</code> file:</p><div class=tab-panel data-tab-group=861e2afa3b45309851865d7fc7b570a4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcmainjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("861e2afa3b45309851865d7fc7b570a4","srcmainjs")'>
<span class=tab-nav-text>src/main.js</span></button></div><div class=tab-content-container><div data-tab-item=srcmainjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Main Vue application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>createApp</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>createPinia</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;pinia&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>PrimeVue</span> <span class=nx>from</span> <span class=s1>&#39;primevue/config&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>Aura</span> <span class=nx>from</span> <span class=s1>&#39;@primeuix/themes/aura&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Vue App
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>App</span> <span class=nx>from</span> <span class=s1>&#39;./App.vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>router</span> <span class=nx>from</span> <span class=s1>&#39;./router&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Vue App
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>createApp</span><span class=p>(</span><span class=nx>App</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Install Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>createPinia</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>router</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>PrimeVue</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Theme Configuration
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=nx>theme</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>preset</span><span class=o>:</span> <span class=nx>Aura</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Mount Vue App on page
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>mount</span><span class=p>(</span><span class=s1>&#39;#app&#39;</span><span class=p>)</span></span></span></code></pre></div></div></div></div></div><p>Now, when we restart our application and refresh the page, we should see a bit of a different look and feel on the page:</p><p><a href=#R-image-abcd8501440ea0570c90bcb703f77094 class=lightbox-link><img alt="PrimeVue Aura Theme" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/primevue_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-abcd8501440ea0570c90bcb703f77094><img alt="PrimeVue Aura Theme" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/primevue_3.png></a></p><p>Now we see that our PrimeVue Menubar component is beginning to look like what we expect. We also notice that it is now using a dark theme, which is the default for the web browser this screenshot was taken from - we&rsquo;ll explore how to add a toggle for light and dark themes later in this tutorial.</p><h2 id=primevue-component-slots>PrimeVue Component Slots</h2><p>Many PrimeVue components include <strong>slots</strong>, which are specific locations within the template where additional components or HTML code can be added. For example, the Menubar component include two slots, <code>#start</code> and <code>#end</code>, which allow us to add content at the beginning and end of the Menubar, respectively. We can use these by simply adding a <code>&lt;template></code> inside of our <code>Menubar</code> component with the appropriate label. So, let&rsquo;s do that now!</p><p>We know we want to add a logo to the beginning of the Menubar, so let&rsquo;s start there. We don&rsquo;t currently have a logo graphic for our application, but we can include a placeholder image for now.</p><div class=tab-panel data-tab-group=96e66b4e8554b5c0e7bd370d9b9c31e2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayouttopmenuvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("96e66b4e8554b5c0e7bd370d9b9c31e2","srccomponentslayouttopmenuvue")'>
<span class=tab-nav-text>src/components/layout/TopMenu.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayouttopmenuvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>Menubar</span> <span class=nt>:model</span><span class=o>=</span><span class=s>&#34;items&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>start</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://placehold.co/40x40&#34;</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#34;Placeholder Logo&#34;</span> <span class=p>/&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;/</span><span class=nt>Menubar</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>With that in place, we should now see an image included in our Menubar:</p><p><a href=#R-image-c979f219510ecf549240efd3a716ffed class=lightbox-link><img alt="PrimeVue Menubar Logo" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/primevue_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c979f219510ecf549240efd3a716ffed><img alt="PrimeVue Menubar Logo" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/primevue_4.png></a></p><p>On the next page, we&rsquo;ll continue to refine our Menubar by adding routing.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=routing>Routing</h1><a href="https://www.youtube.com/watch?v=lz0AiqcQAV4">YouTube Video</a><h2 id=vue-router>Vue Router</h2><p>Our Vue project already includes an instance of the <a href=https://router.vuejs.org/ rel=external target=_blank>Vue Router</a>, which is used to handle routing between the various views, or pages, within our application. So, let&rsquo;s take a minute to explore how the Vue Router works and how we can integrate it into our Menubar so we can move between the various views in our application.</p><p>First, let&rsquo;s take a look at the existing <code>src/router/index.js</code> file that is generated for our application. We&rsquo;ve added some comments to the file to make it easier to follow:</p><div class=tab-panel data-tab-group=2255a89ba9ff48fefdab0aa23b199668><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcrouterindexjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2255a89ba9ff48fefdab0aa23b199668","srcrouterindexjs")'>
<span class=tab-nav-text>src/router/index.js</span></button></div><div class=tab-content-container><div data-tab-item=srcrouterindexjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Vue Router for the application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router a Vue Router
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>createRouter</span><span class=p>,</span> <span class=nx>createWebHistory</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue-router&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Views
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>HomeView</span> <span class=nx>from</span> <span class=s1>&#39;../views/HomeView.vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>createRouter</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure History Mode
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>history</span><span class=o>:</span> <span class=nx>createWebHistory</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>BASE_URL</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure routes
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>routes</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;home&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>component</span><span class=o>:</span> <span class=nx>HomeView</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/about&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;about&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// route level code-splitting
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// this generates a separate chunk (About.[hash].js) for this route
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// which is lazy-loaded when the route is visited.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>component</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;../views/AboutView.vue&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span></span></span></code></pre></div></div></div></div></div><p>The major portion of this file we should look at is the <code>routes</code> array that is present inside of the <code>createRouter</code> function. Each object in the <code>routes</code> array matches a URL path with a Vue component, typically a view or page, that should be displayed at that route. We can also give each route a helpful name to make things simple.</p><p>At the bottom, we see an example of splitting the routes up into chunks, which allows parts of our application to be lazy-loaded as the user accesses them. This can make our application initially load faster, since the default chunk is smaller, but when the user accesses a part of the application that is lazy-loaded, it may pause briefly while it loads that chunk. We&rsquo;ll go ahead and leave it as-is for this example, just to see what it looks like. We&rsquo;ll revisit this when we build our application for production.</p><p>Finally, we also see that this file configures a <a href=https://router.vuejs.org/guide/essentials/history-mode.html rel=external target=_blank>History Mode</a> for our application. This describes how the URL may change as users move through our application. We&rsquo;ll leave this setting alone for now, but as we integrate this application into our backend, we may revisit this setting. The Vue Router documentation describes the different history modes and where they are most useful.</p><p>This file is imported in our <code>main.js</code> file and added to the Vue application so we can reference it throughout our application.</p><h2 id=using-the-router>Using the Router</h2><p>Now, let&rsquo;s go back to our <code>App.vue</code> file, and see where it uses the Vue Router:</p><div class=tab-panel data-tab-group=ec56fa5b4a1265cfa5489016d6b44dc5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcappvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ec56fa5b4a1265cfa5489016d6b44dc5","srcappvue")'>
<span class=tab-nav-text>src/App.vue</span></button></div><div class=tab-content-container><div data-tab-item=srcappvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Main Vue Application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Components
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>TopMenu</span> <span class=nx>from</span> <span class=s1>&#39;./components/layout/TopMenu.vue&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>header</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>TopMenu</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>header</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>  <span class=p>&lt;</span><span class=nt>RouterView</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>In the template, we see a <code>RouterView</code> element - this is where the different views are placed in our overall application. For example, when the user wants to navigate to the <code>/about</code> URL, the <code>RouterView</code> component here will contain the <code>AboutView</code> component that is referenced in the router&rsquo;s <code>routes</code> array for that URL path. It is very straightforward!</p><p>While we&rsquo;re here, let&rsquo;s briefly update the structure of this page to match a proper HTML file:</p><div class=tab-panel data-tab-group=1ca5c8212c60f80a4dbc0108bb90d1b7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcappvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1ca5c8212c60f80a4dbc0108bb90d1b7","srcappvue")'>
<span class=tab-nav-text>src/App.vue</span></button></div><div class=tab-content-container><div data-tab-item=srcappvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>header</span><span class=p>&gt;&lt;/</span><span class=nt>header</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>nav</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>Navigation</span> <span class=nx>Menu</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>TopMenu</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>nav</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=c>&lt;!--</span> <span class=nx>Main</span> <span class=nx>Application</span> <span class=nx>View</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>RouterView</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>  <span class=p>&lt;</span><span class=nt>footer</span><span class=p>&gt;&lt;/</span><span class=nt>footer</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>This template structure properly includes a <code>&lt;header></code>, <code>&lt;nav></code>, <code>&lt;main></code>, and <code>&lt;footer></code> elements that make up the overall structure of the page. For right now, we are only using the <code>&lt;nav></code> and <code>&lt;main></code> elements, but we can always add additional content to this overall page layout over time.</p><h2 id=navigating-to-a-view>Navigating to a View</h2><p>Finally, let&rsquo;s go back to our <code>TopMenu</code> component and add routing to each link. There are many ways to do this, but one simple way is to add a <code>command</code> property to each menu item, which is a callback function that is executed when the button on the menu is activated. This function can simply use the Vue router to navigate to the correct view:</p><div class=tab-panel data-tab-group=8fcc8ff3a016b70b4aac6a489246426e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayouttopmenuvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8fcc8ff3a016b70b4aac6a489246426e","srccomponentslayouttopmenuvue")'>
<span class=tab-nav-text>src/components/layout/TopMenu.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayouttopmenuvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Top menu bar of the entire application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;vue&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useRouter</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;vue-router&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>useRouter</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Components
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Menubar</span> <span class=nx>from</span> <span class=s1>&#39;primevue/menubar&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Declare State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>items</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;Home&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;home&#39;</span> <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;About&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;about&#39;</span> <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Now, when we run our application, we should be able to click the buttons in our menu and navigate between the two views, or pages, of our application!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=tailwind>Tailwind</h1><a href="https://www.youtube.com/watch?v=o9zBv3BDb8U">YouTube Video</a><h2 id=integrating-tailwind>Integrating Tailwind</h2><p>While PrimeVue includes many helpful components we can use in our application, we may still need to adjust the layout a bit to match our expected style. For example, right now the content of each of our views has no margins or padding around it:</p><p><a href=#R-image-799b6a6a6adac9a1ec1c5fd007777ad3 class=lightbox-link><img alt="PrimeVue Menubar Logo" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/primevue_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-799b6a6a6adac9a1ec1c5fd007777ad3><img alt="PrimeVue Menubar Logo" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/primevue_4.png></a></p><p>While we can easily write our own CSS directives to handle this, now is a good time to look at one of the more modern CSS libraries to see how to make this process much easier. <a href=https://tailwindcss.com/ rel=external target=_blank>Tailwind CSS</a> is a utility-based CSS framework that works really well with component libraries such as PrimeVue. So, let&rsquo;s integrate it into our application and use it to help provide some additional style and structure to our application.</p><p>First, we&rsquo;ll follow the installation guide to install <a href=https://tailwindcss.com/docs/installation/using-vite rel=external target=_blank>Tailwind CSS with Vite</a> by installing the library and the Vite plugin for Tailwind using <code>npm</code>:</p><div class=tab-panel data-tab-group=422c4d4613e8260a0047c71ebabc32d3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("422c4d4613e8260a0047c71ebabc32d3","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install tailwindcss @tailwindcss/vite</span></span></code></pre></div></div></div></div></div><p>Next, we&rsquo;ll need to add the Tailwind CSS plugin to our Vite configuration file <code>vite.config.js</code>:</p><div class=tab-panel data-tab-group=97eabd0e4270d801bd5311208cfbff9b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=viteconfigjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("97eabd0e4270d801bd5311208cfbff9b","viteconfigjs")'>
<span class=tab-nav-text>vite.config.js</span></button></div><div class=tab-content-container><div data-tab-item=viteconfigjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>fileURLToPath</span><span class=p>,</span> <span class=nx>URL</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;node:url&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>defineConfig</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vite&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>vue</span> <span class=nx>from</span> <span class=s1>&#39;@vitejs/plugin-vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>vueDevTools</span> <span class=nx>from</span> <span class=s1>&#39;vite-plugin-vue-devtools&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>tailwindcss</span> <span class=nx>from</span> <span class=s1>&#39;@tailwindcss/vite&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// https://vite.dev/config/
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=k>default</span> <span class=nx>defineConfig</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>plugins</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>vue</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>vueDevTools</span><span class=p>(),</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>tailwindcss</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>resolve</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>alias</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;@&#39;</span><span class=o>:</span> <span class=nx>fileURLToPath</span><span class=p>(</span><span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=s1>&#39;./src&#39;</span><span class=p>,</span> <span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>url</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>Since we are using PrimeVue, we should also install the <a href=https://primevue.org/tailwind/ rel=external target=_blank>PrimeVue Tailwind Plugin</a> as well:</p><div class=tab-panel data-tab-group=473e5821107de79abf30d6d9c3fb9848><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("473e5821107de79abf30d6d9c3fb9848","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install tailwindcss-primeui</span></span></code></pre></div></div></div></div></div><p>Now that Tailwind is installed, we need to reference it in a global CSS file that is part of our application. So, let&rsquo;s create a file <code>main.css</code> in our <code>src/assets</code> folder with the following content:</p><div class=tab-panel data-tab-group=e4df3f2f4088b4db1491f939796e2ec6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcassetsmaincss class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e4df3f2f4088b4db1491f939796e2ec6","srcassetsmaincss")'>
<span class=tab-nav-text>src/assets/main.css</span></button></div><div class=tab-content-container><div data-tab-item=srcassetsmaincss class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>@</span><span class=k>import</span> <span class=s2>&#34;tailwindcss&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>@</span><span class=k>import</span> <span class=s2>&#34;tailwindcss-primeui&#34;</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll also need to reference that file in our <code>main.js</code> file:</p><div class=tab-panel data-tab-group=e24328024da46fa50f521f7cba5aac20><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcmainjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e24328024da46fa50f521f7cba5aac20","srcmainjs")'>
<span class=tab-nav-text>src/main.js</span></button></div><div class=tab-content-container><div data-tab-item=srcmainjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Main Vue application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>createApp</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>createPinia</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;pinia&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>PrimeVue</span> <span class=nx>from</span> <span class=s1>&#39;primevue/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Aura</span> <span class=nx>from</span> <span class=s1>&#39;@primeuix/themes/aura&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import CSS
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s1>&#39;./assets/main.css&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Vue App
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>App</span> <span class=nx>from</span> <span class=s1>&#39;./App.vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Finally, with all of that in place, we can restart our application in development mode and begin using Tailwind CSS to style our application:</p><div class=tab-panel data-tab-group=b3efbf8d4be4a2095e7f3ff20753e752><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b3efbf8d4be4a2095e7f3ff20753e752","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Let&rsquo;s look back at our <code>App.vue</code> file and add a simple margin to the <code>&lt;div></code> containing our application using the <a href=https://tailwindcss.com/docs/margin rel=external target=_blank>Tailwind CSS Margin</a> utility. To do this, we simply add a <code>class="m-2"</code> attribute to that <code>&lt;div></code> element:</p><div class=tab-panel data-tab-group=da424cb475fe8894e81f4e5f881fd3ac><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcappvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("da424cb475fe8894e81f4e5f881fd3ac","srcappvue")'>
<span class=tab-nav-text>src/App.vue</span></button></div><div class=tab-content-container><div data-tab-item=srcappvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>header</span><span class=p>&gt;&lt;/</span><span class=nt>header</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>nav</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>Navigation</span> <span class=nx>Menu</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>TopMenu</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>nav</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;m-2&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=c>&lt;!--</span> <span class=nx>Main</span> <span class=nx>Application</span> <span class=nx>View</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>RouterView</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>footer</span><span class=p>&gt;&lt;/</span><span class=nt>footer</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Now, when we reload that page, we should see that the <code>&lt;div></code> inside of the <code>&lt;main></code> element of our page has a small margin around it. We can confirm this using the inspector tool in our browser:</p><p><a href=#R-image-8789d5733138379cff265c70b1445e5e class=lightbox-link><img alt="PrimeVue Tailwind" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/primevue_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8789d5733138379cff265c70b1445e5e><img alt="PrimeVue Tailwind" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/primevue_5.png></a></p><p>There we go! Now we have full access to Tailwind CSS in our application, which will allow us to easily control the layout and spacing of the various components in our application.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=dark-mode>Dark Mode</h1><a href="https://www.youtube.com/watch?v=6NaPnajdLyo">YouTube Video</a><h2 id=configuring-dark-mode>Configuring Dark Mode</h2><p>Many applications today include two default themes, a &ldquo;light-mode&rdquo; and a &ldquo;dark-mode,&rdquo; and users can choose which theme they receive by default through settings made either in their browser or their operating system. However, we can easily provide functionality in our application for users to override that setting if desired. The instructions for configuring a proper dark mode setup can be found in the <a href=https://tailwindcss.com/docs/dark-mode rel=external target=_blank>Tailwind CSS Documentation</a>, the <a href=https://primevue.org/theming/styled/#darkmode rel=external target=_blank>PrimeVue Documentation</a>, and a <a href=https://dev.to/abbeyperini/dark-mode-toggle-and-prefers-color-scheme-4f3m rel=external target=_blank>helpful article</a> describing how to detect the user&rsquo;s preference and store it in the browser&rsquo;s local storage. We&rsquo;ll integrate all three of these together into our component.</p><p>To begin, we need to configure both PrimeVue and Tailwind to look for a specific CSS class applied to the base <code>&lt;html></code> element to control whether the page is viewed in dark mode or light mode. For this application, we&rsquo;ll use the class <code>app-dark-mode</code>. So, let&rsquo;s start by adding it to the PrimeVue configuration in <code>main.js</code>:</p><div class=tab-panel data-tab-group=a20b69658e85331897b24cac2cc4be9c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcmainjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a20b69658e85331897b24cac2cc4be9c","srcmainjs")'>
<span class=tab-nav-text>src/main.js</span></button></div><div class=tab-content-container><div data-tab-item=srcmainjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Install Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>createPinia</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>router</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>PrimeVue</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Theme Configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>theme</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>preset</span><span class=o>:</span> <span class=nx>Aura</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>options</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>            <span class=nx>darkModeSelector</span><span class=o>:</span> <span class=s1>&#39;.app-dark-mode&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Next, we&rsquo;ll use the same class in a setting for Tailwind in the base <code>main.css</code> file:</p><div class=tab-panel data-tab-group=08851fa6aeb210fa76d5d7ec458dd0e5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcassetsmaincss class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("08851fa6aeb210fa76d5d7ec458dd0e5","srcassetsmaincss")'>
<span class=tab-nav-text>src/assets/main.css</span></button></div><div class=tab-content-container><div data-tab-item=srcassetsmaincss class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>@</span><span class=k>import</span> <span class=s1>&#39;tailwindcss&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>@</span><span class=k>import</span> <span class=s1>&#39;tailwindcss-primeui&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=p>@</span><span class=k>custom-variant</span> <span class=nt>dark</span> <span class=o>(&amp;</span><span class=p>:</span><span class=nd>where</span><span class=o>(</span><span class=p>.</span><span class=nc>app-dark-mode</span><span class=o>,</span> <span class=p>.</span><span class=nc>app-dark-mode</span> <span class=o>*))</span><span class=p>;</span>     <span class=o>//</span><span class=nt>dark</span> <span class=nt>mode</span> <span class=nt>configuration</span></span></span></code></pre></div></div></div></div></div><p>At this point, when we refresh our page in development mode, it should switch back to the light mode view.</p><p><a href=#R-image-3767f37c05273ab31e5f413941f2456f class=lightbox-link><img alt="PrimeVue Light Mode" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/primevue_light.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3767f37c05273ab31e5f413941f2456f><img alt="PrimeVue Light Mode" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/primevue_light.png></a></p><p>However, if we manually add the <code>app-dark-mode</code> class to the <code>&lt;html></code> element in our <code>index.html</code> file, it will switch to dark mode. Let&rsquo;s give it a try:</p><div class=tab-panel data-tab-group=6c0343f758f88fc8c37a3fb3150f20b3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=indexhtml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6c0343f758f88fc8c37a3fb3150f20b3","indexhtml")'>
<span class=tab-nav-text>index.html</span></button></div><div class=tab-content-container><div data-tab-item=indexhtml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class="line hl"><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;&#34;</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;app-dark-mode&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>link</span> <span class=na>rel</span><span class=o>=</span><span class=s>&#34;icon&#34;</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;/favicon.ico&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Lost Communities Solution<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;app&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;module&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;/src/main.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>After we add that class to our <code>&lt;html></code> element, the page should immediately refresh if we are running in development mode, and now it should be using dark mode:</p><p><a href=#R-image-fb633c94e202c2b88ad89b561c16c649 class=lightbox-link><img alt="PrimeVue Dark Mode" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/primevue_dark.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fb633c94e202c2b88ad89b561c16c649><img alt="PrimeVue Dark Mode" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/primevue_dark.png></a></p><p>Let&rsquo;s go ahead and remove that class from the <code>index.html</code> file so that our default is still light mode. Instead, we&rsquo;ll learn how to control it programmatically!</p><div class=tab-panel data-tab-group=00a817757a4561cc1defb3cde0bd0913><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=indexhtml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("00a817757a4561cc1defb3cde0bd0913","indexhtml")'>
<span class=tab-nav-text>index.html</span></button></div><div class=tab-content-container><div data-tab-item=indexhtml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class="line hl"><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>link</span> <span class=na>rel</span><span class=o>=</span><span class=s>&#34;icon&#34;</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;/favicon.ico&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1.0&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Lost Communities Solution<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;app&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;module&#34;</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;/src/main.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><h2 id=controlling-dark-mode>Controlling Dark Mode</h2><p>Let&rsquo;s create a component we can use in our website to control dark mode. That allows the user to easily switch between light and dark modes, and we can even save their preference for later. So, let&rsquo;s start by creating a component in the file <code>src/components/layout/ThemeToggle.vue</code> with the following content:</p><div class=tab-panel data-tab-group=bb26a0697683402aa470576c186ea2b0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayoutthemetogglevue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bb26a0697683402aa470576c186ea2b0","srccomponentslayoutthemetogglevue")'>
<span class=tab-nav-text>src/components/layout/ThemeToggle.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayoutthemetogglevue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Button to toggle light/dark theme
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Declare State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>theme</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>(</span><span class=s1>&#39;light-theme&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>toggleDarkMode</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>theme</span><span class=p>.</span><span class=nx>value</span> <span class=o>==</span> <span class=s1>&#39;light-theme&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>theme</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=s1>&#39;dark-theme&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>document</span><span class=p>.</span><span class=nx>documentElement</span><span class=p>.</span><span class=nx>classList</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=s1>&#39;app-dark-mode&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>theme</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=s1>&#39;light-theme&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>document</span><span class=p>.</span><span class=nx>documentElement</span><span class=p>.</span><span class=nx>classList</span><span class=p>.</span><span class=nx>remove</span><span class=p>(</span><span class=s1>&#39;app-dark-mode&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>a</span> <span class=nt>@click</span><span class=s>=&#34;toggleDarkMode&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>span</span> <span class=nt>v-if</span><span class=o>=</span><span class=s>&#34;theme == &#39;light-theme&#39;&#34; v-tooltip.bottom=&#34;&#39;Toggle Dark Mode&#39;&#34;</span><span class=p>&gt;</span><span class=na>Dark</span><span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>span</span> <span class=na>v</span><span class=nt>-else</span> <span class=na>v</span><span class=nt>-tooltip</span><span class=na>.bottom</span><span class=err>=&#34;&#39;</span><span class=na>Toggle</span> <span class=na>Light</span> <span class=na>Mode</span><span class=err>&#39;&#34;</span><span class=p>&gt;</span><span class=nx>Light</span><span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>There is a lot going on in this component, so let&rsquo;s break it down piece by piece to see how it works. First, here are the three major components of the <code>&lt;script setup></code> section.</p><ol><li>We start by importing the <code>ref</code> function from Vue. This is the function that allows us to create reactive state variables in our application. A reactive state variable stores data that will be updated as our application runs, and each update will cause the user interface to be updated and redrawn for the user. Therefore, by storing our data in these reactive state variables, it allows our web application to <em>react</em> to changes in state. We can learn more about this in the <a href=https://vuejs.org/guide/essentials/reactivity-fundamentals.html rel=external target=_blank>Reactivity Fundamentals</a> page of the Vue Documentation</li><li>Next, we create a reactive variable named <code>theme</code> that initially stores the string <code>'light-theme'</code>. We&rsquo;ll use this variable to keep track of the current theme being used by our site.</li><li>After that, we create a function called <code>toggleDarkMode</code> that does exactly what the name implies. First, it looks at the value of the <code>theme</code> reactive state variable. Notice that we must call the <code>value</code> property to access or update the value stored in the reactive state variable in our <code>&lt;script setup></code> section. Then, based on the value it finds, it will swap the theme by updating the value of the <code>theme</code> variable itself, and also either adding or removing the <code>app-dark-mode</code> class to the <code>document.documentElement</code> part of our page. According to the <a href=https://developer.mozilla.org/en-US/docs/Web/API/Document/documentElement rel=external target=_blank>MDN Web Docs</a>, that is typically the root element of the document, so in our case, it is the <code>&lt;html></code> element at the top level of our application.</li></ol><p>Next, here is how the template is structured:</p><ol><li>Inside of the template, we wrap everything in a <code>&lt;div></code>. While this is not strictly necessary, it helps to ensure everything inside of the component is properly isolated. We can also apply Tailwind CSS classes to this outermost <code>&lt;div></code> in order to adjust the size, layout, or spacing of our component.</li><li>Next, we include an <code>&lt;a></code> element, which we should remember represents a clickable link. However, instead of including an <code>href</code> attribute, we instead use the Vue <code>@click</code> attribute to attach a click handler to the element. This is covered in the <a href=https://vuejs.org/guide/essentials/event-handling rel=external target=_blank>Event Handling</a> section of the Vue documentation. So, when this link is clicked, it will call the <code>toggleDarkMode</code> function to switch between light and dark mode.</li><li>Inside of the <code>&lt;a></code> element, we have two <code>&lt;span></code> elements. The first one uses a <code>v-if</code> directive to check and see if the theme is currently set to the <code>'light-theme'</code> value. This is an example of <a href=https://vuejs.org/guide/essentials/conditional.html rel=external target=_blank>Conditional Rendering</a>, one of the most powerful features of a web framework such as Vue. Effectively, if that statement resolves to <code>true</code>, this element will be rendered on the page. If it is <code>false</code>, the element will not be rendered at all. Likewise, the following span containing a <code>v-else</code> directive will be rendered if the first one is not, and vice-versa. Effectively, only one of these two <code>&lt;span></code> elements will be visible, based on whether the theme is currently set to <code>'light-theme'</code> or <code>'dark-theme'</code>.</li></ol><p>As we can see, there is a lot going on even in this very simple component!</p><h2 id=adding-components-to-our-menu-bar>Adding Components to our Menu Bar</h2><p>Now that we&rsquo;ve created our <code>ThemeToggle</code> component, let&rsquo;s add it to our existing menu bar by updating the code in our <code>TopMenu.vue</code> component:</p><div class=tab-panel data-tab-group=6d095c67913351ce5ff969f5fe994a4c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayouttopmenuvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6d095c67913351ce5ff969f5fe994a4c","srccomponentslayouttopmenuvue")'>
<span class=tab-nav-text>src/components/layout/TopMenu.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayouttopmenuvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import Components
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Menubar</span> <span class=nx>from</span> <span class=s1>&#39;primevue/menubar&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>ThemeToggle</span> <span class=nx>from</span> <span class=s1>&#39;./ThemeToggle.vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Menubar</span> <span class=nt>:model</span><span class=o>=</span><span class=s>&#34;items&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>start</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://placehold.co/40x40&#34;</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#34;Placeholder Logo&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>end</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;</span><span class=nt>ThemeToggle</span> <span class=p>/&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Menubar</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>To add a component, we first must import it in our <code>&lt;script setup></code> section. Then, we can add it to our template just like any other HTML element. In this case, we want it at the end of our menu bar, so we are adding it to the <code>#end</code> slot of that PrimeVue component.</p><p>Now, if we load our page, we should see a button in the upper right that allows us to switch between light and dark theme!</p><p><a href=#R-image-3409076bbf7b532b00e0973d382c634f class=lightbox-link><img alt="PrimeVue Dark Mode" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/primevue_toggle.gif style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3409076bbf7b532b00e0973d382c634f><img alt="PrimeVue Dark Mode" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/primevue_toggle.gif></a></p><h2 id=user-preference--storage>User Preference & Storage</h2><p>Let&rsquo;s quickly improve our dark theme toggle by adding two additional features:</p><ol><li>Right now, the website defaults to the light theme. However, if the user has already set a system preference for dark theme, we should respect that if no other setting has been made.</li><li>Once the user changes the theme, we should remember that setting so the next time they reload the page, it will use their previous setting if one is found.</li></ol><p>So, let&rsquo;s update the code in our <code>ThemeToggle.vue</code> component to handle these cases by adding a few more functions:</p><div class=tab-panel data-tab-group=98d79f3fc6ac2866f488b24ed70f9ade><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayoutthemetogglevue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("98d79f3fc6ac2866f488b24ed70f9ade","srccomponentslayoutthemetogglevue")'>
<span class=tab-nav-text>src/components/layout/ThemeToggle.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayoutthemetogglevue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Button to toggle light/dark theme
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Declare State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>theme</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>(</span><span class=s1>&#39;light-theme&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get Theme from Local Storage
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>getTheme</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>localStorage</span><span class=p>.</span><span class=nx>getItem</span><span class=p>(</span><span class=s1>&#39;user-theme&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get Theme from User Preference
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>getMediaPreference</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>hasDarkPreference</span> <span class=o>=</span> <span class=nb>window</span><span class=p>.</span><span class=nx>matchMedia</span><span class=p>(</span><span class=s1>&#39;(prefers-color-scheme: dark)&#39;</span><span class=p>).</span><span class=nx>matches</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>hasDarkPreference</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;dark-theme&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;light-theme&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Set theme and store
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>setTheme</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Setting theme to &#34;</span> <span class=o>+</span> <span class=nx>theme</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>theme</span><span class=p>.</span><span class=nx>value</span> <span class=o>==</span> <span class=s1>&#39;light-theme&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>document</span><span class=p>.</span><span class=nx>documentElement</span><span class=p>.</span><span class=nx>classList</span><span class=p>.</span><span class=nx>remove</span><span class=p>(</span><span class=s1>&#39;app-dark-mode&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>document</span><span class=p>.</span><span class=nx>documentElement</span><span class=p>.</span><span class=nx>classList</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=s1>&#39;app-dark-mode&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>localStorage</span><span class=p>.</span><span class=nx>setItem</span><span class=p>(</span><span class=s1>&#39;user-theme&#39;</span><span class=p>,</span> <span class=nx>theme</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Toggle theme value
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>toggleDarkMode</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>theme</span><span class=p>.</span><span class=nx>value</span> <span class=o>==</span> <span class=s1>&#39;light-theme&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>theme</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=s1>&#39;dark-theme&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>theme</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=s1>&#39;light-theme&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>setTheme</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>theme</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>getTheme</span><span class=p>()</span> <span class=o>||</span> <span class=nx>getMediaPreference</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>setTheme</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Let&rsquo;s go through the updates to this code and explore how it works:</p><ol><li>First, we have a new function <code>getTheme</code> that will read a value from our browser&rsquo;s <a href=https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage rel=external target=_blank>Local Storage</a>. This allows our application to save some settings that will be stored across browser sessions, as long as the user does not clear their browser&rsquo;s cache. For this application, we will store the user&rsquo;s chosen theme using the <code>'user-theme'</code> key in local storage.</li><li>Next, we have another function to get the user&rsquo;s preferred theme by checking for a <code>prefers-color-scheme</code> entry in the browser&rsquo;s settings. If it finds that the setting is set to <code>dark</code> it will return our <code>dark-theme</code> option; otherwise it will default to the <code>light-theme</code>.</li><li>After that, we created a new <code>setTheme</code> function that will set the theme to whatever value is stored currently in the <code>theme</code> reactive state variable. It does so by adding or removing the class from the <code>&lt;html></code> element, and then it stores the current theme in the users&rsquo;s local storage. We added a <code>console.log</code> statement so we can debug this setup using our browser&rsquo;s console.</li><li>We also updated our <code>toggleDarkMode</code> function to just change the value stored in the <code>theme</code> reactive state variable, and then it calls the new <code>setTheme()</code> function to actually update the theme.</li><li>Finally, at the bottom of the <code>&lt;script setup></code> section are two lines of code that actually call these functions to determine the correct theme and set it. First, we call <code>getTheme()</code> to see if the user has a theme preference stored in local storage. If so, that value is returned and stored in the <code>theme</code> reactive state. However, if there is no entry in the browser&rsquo;s local storage, that function will return a <code>null</code> value, and the or <code>||</code> operator will move on to the second function, <code>getMediaPreference()</code> which will try to determine if the user has system preference set. That function will always return a value. Finally, once we&rsquo;ve determined the correct theme to use, the <code>setTheme</code> function is called to update the browser. It will also store the theme in the browser&rsquo;s local storage, so the user&rsquo;s setting will be remembered going forward.</li></ol><p>With all of that put together, our application should now seamlessly switch between light and dark themes, and remember the user&rsquo;s preference in local storage so that, even if they refresh the page, their theme preference will be remembered. We can see this setup in action below, showing both the page and the browser&rsquo;s local storage. Notice that the browser prefers a dark theme, so the first time the page is refreshed, it will automatically switch to dark mode. From there, the user can change the theme and refresh the page, and it will remember the previous setting.</p><p><a href=#R-image-f1f6a20e3213633afb44b28370c39c11 class=lightbox-link><img alt="PrimeVue Dark Mode" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/primevue_toggle2.gif style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f1f6a20e3213633afb44b28370c39c11><img alt="PrimeVue Dark Mode" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/primevue_toggle2.gif></a></p><p>Finally, if we want our dark mode selector button to look like it belongs on our menubar, we can add a few PrimeVue CSS classes so that it matches the existing buttons. These are all explained on the <a href=https://primevue.org/menubar/ rel=external target=_blank>Menubar Theming</a> tab of the PrimeVue documentation.</p><div class=tab-panel data-tab-group=cfb5733f0ca4a65e9cde00b2fba2d800><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayoutthemetogglevue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cfb5733f0ca4a65e9cde00b2fba2d800","srccomponentslayoutthemetogglevue")'>
<span class=tab-nav-text>src/components/layout/ThemeToggle.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayoutthemetogglevue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item-content&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>a</span> <span class=nt>@click</span><span class=s>=&#34;toggleDarkMode&#34;</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item-link&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>span</span> <span class=nt>v-if</span><span class=o>=</span><span class=s>&#34;theme == &#39;light-theme&#39;&#34; v-tooltip.bottom=&#34;&#39;Toggle Dark Mode&#39;&#34; class=&#34;p-menubar-item-label&#34;</span><span class=p>&gt;</span><span class=na>Dark</span><span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>span</span> <span class=na>v</span><span class=nt>-else</span> <span class=na>v</span><span class=nt>-tooltip</span><span class=na>.bottom</span><span class=err>=&#34;&#39;</span><span class=na>Toggle</span> <span class=na>Light</span> <span class=na>Mode</span><span class=err>&#39;&#34;</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item-label&#34;</span><span class=p>&gt;</span><span class=nx>Light</span><span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>All of the PrimeVue CSS classes are prefixed with a <code>p-</code>, so they are easy to find and remember. So, even if we create our own components, we can still easily style them to match the other PrimeVue components by paying close attention to the CSS classes used.</p><h2 id=enabling-tooltips>Enabling Tooltips</h2><p>One thing we included in the template above is the <code>v-tooltip.bottom</code> directive, which will give a small popup for the user letting them know a bit more information about what that button does. To enable it, we need to import that PrimeVue feature into our <code>main.js</code> file:</p><div class=tab-panel data-tab-group=96ab7fa6d593e7282e4a53b4dea2ebb4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcmainjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("96ab7fa6d593e7282e4a53b4dea2ebb4","srcmainjs")'>
<span class=tab-nav-text>src/main.js</span></button></div><div class=tab-content-container><div data-tab-item=srcmainjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Main Vue application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>createApp</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>createPinia</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;pinia&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>PrimeVue</span> <span class=nx>from</span> <span class=s1>&#39;primevue/config&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Aura</span> <span class=nx>from</span> <span class=s1>&#39;@primeuix/themes/aura&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>Tooltip</span> <span class=nx>from</span> <span class=s1>&#39;primevue/tooltip&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import CSS
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s1>&#39;./assets/main.css&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Vue App
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>App</span> <span class=nx>from</span> <span class=s1>&#39;./App.vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>router</span> <span class=nx>from</span> <span class=s1>&#39;./router&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Vue App
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>createApp</span><span class=p>(</span><span class=nx>App</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Install Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>createPinia</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>router</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>PrimeVue</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Theme Configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>theme</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>preset</span><span class=o>:</span> <span class=nx>Aura</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>darkModeSelector</span><span class=o>:</span> <span class=s1>&#39;.app-dark-mode&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Install Directives
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>directive</span><span class=p>(</span><span class=s1>&#39;tooltip&#39;</span><span class=p>,</span> <span class=nx>Tooltip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Mount Vue App on page
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>mount</span><span class=p>(</span><span class=s1>&#39;#app&#39;</span><span class=p>)</span></span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll see this in action as we hover over the button to toggle between dark and light mode.</p><p><a href=#R-image-61e21ab5bdc2ab6b74b155f481876f1d class=lightbox-link><img alt="PrimeVue Tooltips" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/primevue_tooltip.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-61e21ab5bdc2ab6b74b155f481876f1d><img alt="PrimeVue Tooltips" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/primevue_tooltip.png></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=icons>Icons</h1><a href="https://www.youtube.com/watch?v=KpEp43qcQNo">YouTube Video</a><h2 id=adding-icons>Adding Icons</h2><p>One of the best ways to make a web user interface very accessible and easy to use is by using globally recognized icons to represent certain actions, such as logging in, returning to the homepage, and editing items. Thankfully, there is an easy to use icon package that works directly with PrimeVue called <a href=https://primevue.org/icons/ rel=external target=_blank>PrimeIcons</a> that we can use in our project. So, let&rsquo;s quickly install that icon pack and see how we can use it in our application.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Other Icon Packs</div><div class=box-content><p>PrimeVue also supports using other icon packs, such as <a href=https://fontawesome.com/ rel=external target=_blank>FontAwesome</a> as described in the <a href=https://primevue.org/customicons/ rel=external target=_blank>PrimeVue Custom Icons</a> documentation. For this project, we&rsquo;ll keep things simple by only using PrimeIcons, but it is relatively easy to add additional icons from other sources as needed.</p></div></div><p>First, let&rsquo;s install the PrimeIcons package using <code>npm</code>:</p><div class=tab-panel data-tab-group=645f7a8b53191a43b4d91ea06f2230fe><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("645f7a8b53191a43b4d91ea06f2230fe","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install primeicons</span></span></code></pre></div></div></div></div></div><p>Next, we can simply import the required CSS file in our <code>src/assets/main.css</code> file:</p><div class=tab-panel data-tab-group=396c8f48015130cef80f752e1ee98638><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcassetsmaincss class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("396c8f48015130cef80f752e1ee98638","srcassetsmaincss")'>
<span class=tab-nav-text>src/assets/main.css</span></button></div><div class=tab-content-container><div data-tab-item=srcassetsmaincss class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=p>@</span><span class=k>import</span> <span class=s1>&#39;tailwindcss&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>@</span><span class=k>import</span> <span class=s1>&#39;tailwindcss-primeui&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>@</span><span class=k>custom-variant</span> <span class=nt>dark</span> <span class=o>(&amp;</span><span class=p>:</span><span class=nd>where</span><span class=o>(</span><span class=p>.</span><span class=nc>my-app-dark</span><span class=o>,</span> <span class=p>.</span><span class=nc>my-app-dark</span> <span class=o>*))</span><span class=p>;</span> 
</span></span><span class="line hl"><span class=cl><span class=p>@</span><span class=k>import</span> <span class=s1>&#39;primeicons/primeicons.css&#39;</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>With those two changes in place, we can start to use icons throughout our application! We can find a full list of icons available in the <a href=https://primevue.org/icons/ rel=external target=_blank>PrimeIcons Documentation</a>.</p><h2 id=menubar-icons>Menubar Icons</h2><p>Let&rsquo;s start by adding a couple of icons to our menu bar links. Thankfully, the <a href=https://primevue.org/menubar/ rel=external target=_blank>PrimeVue Menubar Component</a> recognizes an <code>icon</code> attribute that we can add to each of the menu items, so this is an easy update to make:</p><div class=tab-panel data-tab-group=29ffae22d9231c645e3c852993b99f5c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayouttopmenuvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("29ffae22d9231c645e3c852993b99f5c","srccomponentslayouttopmenuvue")'>
<span class=tab-nav-text>src/components/layout/TopMenu.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayouttopmenuvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>script</span> <span class=nx>setup</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Declare State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>items</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;Home&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s1>&#39;pi pi-home&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;home&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;About&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s1>&#39;pi pi-info-circle&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;about&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=err>/script&gt;</span></span></span></code></pre></div></div></div></div></div><p>With that change, we now see those icons appear next to our buttons on the menu bar:</p><p><a href=#R-image-a19c8fe4d218d1f56d73d938b049f097 class=lightbox-link><img alt="PrimeVue Icons" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/primevue_icons1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a19c8fe4d218d1f56d73d938b049f097><img alt="PrimeVue Icons" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/primevue_icons1.png></a></p><h2 id=theme-toggle-icons>Theme Toggle Icons</h2><p>We can also update our button to toggle the theme to just use icons! All we have to do is update the template to use icons instead of text:</p><div class=tab-panel data-tab-group=c0daa238e5f484090d40d712776f50db><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayoutthemetogglevue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c0daa238e5f484090d40d712776f50db","srccomponentslayoutthemetogglevue")'>
<span class=tab-nav-text>src/components/layout/ThemeToggle.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayoutthemetogglevue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item-content&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>a</span> <span class=nt>@click</span><span class=s>=&#34;toggleDarkMode&#34;</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item-link&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>span</span>
</span></span><span class=line><span class=cl>          <span class=nt>v-if</span><span class=o>=</span><span class=s>&#34;theme == &#39;light-theme&#39;&#34;</span><span class=p>
</span></span></span><span class=line><span class=cl><span class=p></span>          <span class=na>v</span><span class=nt>-tooltip</span><span class=na>.bottom</span><span class=err>=&#34;&#39;</span><span class=na>Toggle</span> <span class=na>Dark</span> <span class=na>Mode</span><span class=err>&#39;&#34;</span>
</span></span><span class="line hl"><span class=cl>          <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item-label pi pi-moon&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>&gt;&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>span</span>
</span></span><span class=line><span class=cl>          <span class=na>v</span><span class=nt>-else</span>
</span></span><span class=line><span class=cl>          <span class=na>v</span><span class=nt>-tooltip</span><span class=na>.bottom</span><span class=err>=&#34;&#39;</span><span class=na>Toggle</span> <span class=na>Light</span> <span class=na>Mode</span><span class=err>&#39;&#34;</span>
</span></span><span class="line hl"><span class=cl>          <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item-label pi pi-sun&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>&gt;&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Here, we remove the text from within the <code>&lt;span></code> elements, and instead add the classes <code>pi pi-moon</code> for the button to switch to dark mode, and <code>pi pi-sun</code> to switch to light mode, respectively. Since we have enabled tooltips, it is still pretty easy for our users to figure out what these buttons do and how they work!</p><p><a href=#R-image-cfeb27a2a54c2e285b3808ec65be93c3 class=lightbox-link><img alt="PrimeVue Icons Toggle" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/primevue_icon.gif style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-cfeb27a2a54c2e285b3808ec65be93c3><img alt="PrimeVue Icons Toggle" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/primevue_icon.gif></a></p><p>As we can see, adding some icons to our website makes it feel much simpler and easier to use, without a bunch of text cluttering up the interface!</p><p>Now is a great time to lint, format, and then commit and push our work!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=api-proxy>API Proxy</h1><a href="https://www.youtube.com/watch?v=SVQJatrP_98">YouTube Video</a><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>The video adds an extra slash to the <code>/auth</code> route in the <code>vite.config.js</code> file when setting up a proxy. That slash should be removed.</p></div></div><h2 id=connecting-to-our-restful-api>Connecting to our RESTful API</h2><p>Now that we have the basic structure of our application built and are becoming more familiar with both Vue and PrimeVue, let&rsquo;s work on connecting to our backend RESTful API application and see if we can retrieve some data from our database. This is really the key feature that we want ensure works in our frontend application!</p><p>First, we need a way to run our backend application at the same time, and also we want to be able to connect to it directly through our frontend. So, let&rsquo;s add a few features to our overall project to enable that connection.</p><h2 id=vs-code-tasks>VS Code Tasks</h2><p>There are many ways that we can run both our frontend and backend applications simultaneously. One of the simplest is to open a second terminal in VS Code simply by clicking the &ldquo;Split Terminal&rdquo; button at the top right of the terminal, or by pressing <kbd>CTRL</kbd>+<kbd>SHIFT</kbd>+<kbd>S</kbd> to split our existing terminal.</p><p><a href=#R-image-47ad9cb32710fbb8b4546bd1f07027fe class=lightbox-link><img alt="Split VS Code Terminal" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_terminal.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-47ad9cb32710fbb8b4546bd1f07027fe><img alt="Split VS Code Terminal" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_terminal.png></a></p><p>Once we have split the terminal window, we can run both parts of our application side-by-side by navigating to the correct directory and running the <code>npm run dev</code> command in each window:</p><p><a href=#R-image-03e116559c2540d9b9f5adc936941959 class=lightbox-link><img alt="Split VS Code Terminal" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_terminal2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-03e116559c2540d9b9f5adc936941959><img alt="Split VS Code Terminal" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_terminal2.png></a></p><p>However, that can get somewhat tedious to do all the time. Instead, we can just configure a <a href=https://code.visualstudio.com/docs/debugtest/tasks rel=external target=_blank>VS Code Task</a> that will handle this for us.</p><p>To do this, we should create a <code>.vscode</code> folder at the top level of our project (outside of the <code>client</code> and <code>server</code> folders we&rsquo;ve been working on) if one doesn&rsquo;t already exist. Inside of that folder, we&rsquo;ll create a file called <code>tasks.json</code> with the following content:</p><div class=tab-panel data-tab-group=66596299b70cf77a7c78ff1681452873><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=vscodetasksjson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("66596299b70cf77a7c78ff1681452873","vscodetasksjson")'>
<span class=tab-nav-text>.vscode/tasks.json</span></button></div><div class=tab-content-container><div data-tab-item=vscodetasksjson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=c1>// .vscode/tasks.json
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// See https://go.microsoft.com/fwlink/?LinkId=733558
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// for the documentation about the tasks.json format
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;tasks&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Watch Server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;shell&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;command&#34;</span><span class=p>:</span> <span class=s2>&#34;cd server &amp;&amp; npm run dev&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;group&#34;</span><span class=p>:</span> <span class=s2>&#34;build&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;presentation&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;group&#34;</span><span class=p>:</span> <span class=s2>&#34;buildGroup&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;reveal&#34;</span><span class=p>:</span> <span class=s2>&#34;always&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;panel&#34;</span><span class=p>:</span> <span class=s2>&#34;new&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;echo&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Watch Client&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;shell&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;command&#34;</span><span class=p>:</span> <span class=s2>&#34;cd client &amp;&amp; npm run dev&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;group&#34;</span><span class=p>:</span> <span class=s2>&#34;build&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;presentation&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;group&#34;</span><span class=p>:</span> <span class=s2>&#34;buildGroup&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;reveal&#34;</span><span class=p>:</span> <span class=s2>&#34;always&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;panel&#34;</span><span class=p>:</span> <span class=s2>&#34;new&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;echo&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Watch All&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;dependsOn&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Watch Server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Watch Client&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;group&#34;</span><span class=p>:</span> <span class=s2>&#34;build&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;runOptions&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;runOn&#34;</span><span class=p>:</span> <span class=s2>&#34;folderOpen&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Lint and Format&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;shell&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;command&#34;</span><span class=p>:</span> <span class=s2>&#34;cd server &amp;&amp; npm run lint &amp;&amp; npm run format &amp;&amp; cd ../client &amp;&amp; npm run lint &amp;&amp; npm run format&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;group&#34;</span><span class=p>:</span> <span class=s2>&#34;lint&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;presentation&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;group&#34;</span><span class=p>:</span> <span class=s2>&#34;lintGroup&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;reveal&#34;</span><span class=p>:</span> <span class=s2>&#34;always&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;panel&#34;</span><span class=p>:</span> <span class=s2>&#34;new&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;echo&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;problemMatcher&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;$eslint-compact&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;$prettier&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>This file creates several tasks that we can use in our VS Code IDE:</p><ul><li><code>Watch Server</code> - this will run the backend Express server application.</li><li><code>Watch Client</code> - this will run the frontend Vue client application.</li><li><code>Watch All</code> - this will watch both the server and client in two new terminal windows.</li><li><code>Lint and Format</code> - this will run linting and formatting for both the server and client. This is a helpful command to run before committing any code to GitHub.</li></ul><p>Once that file is created and saved, we may need to refresh our GitHub Codespace window or restart VS Code for the changes to take effect. When we do, we should see our new <code>Watch All</code> task run automatically, since it was given the <code>"runOn": "folderOpen"</code> option. In most cases, this is the most effective option - our server and client will always be running, and we can easily restart each of them by typing either <code>rs</code> for the server (running in Nodemon) or just <code>r</code> for the client (running in Vite) without closing those terminals.</p><p>We can also access these tasks anytime from the VS Code Command Palette by pressing <kbd>CTRL</kbd>+<kbd>SHIFT</kbd>+<kbd>P</kbd> and searching for the &ldquo;Tasks: Run Task&rdquo; menu option, then selecting whichever task we want to run.</p><p><a href=#R-image-7b2ebd7e39769951a21aeefc509bc3a6 class=lightbox-link><img alt="VS Code Tasks" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_tasks.gif style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7b2ebd7e39769951a21aeefc509bc3a6><img alt="VS Code Tasks" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_tasks.gif></a></p><h2 id=vite-proxy>Vite Proxy</h2><p>The second major feature we need to configure for our application is a proxy that allows our frontend application to access our backend RESTful API directly. In many typical development scenarios, we typically run our backend application on one port (such as port <code>3000</code>, which if how our app is currently configured), and then we run our frontend application in a development server on a different port (such as <code>5173</code>, the default port used by Vite). However, in this scenario, our frontend must include a hard-coded IP address and port to access our backend server in development mode.</p><p>In production, our frontend application and backend RESTful API server are generally running on the same system, so they will use the same IP address and port. So, to simplify things now, we can simulate that setup by adding a <a href=https://vite.dev/config/server-options#server-proxy rel=external target=_blank>Proxy</a> configuration to our frontend application&rsquo;s development server running in Vite. In this way, our frontend application can connect directly back to the port it is running on (port <code>5173</code> in this example), and if the connection matches one that should be sent to the backend API server instead, it will be proxied to that application (running on port <code>3000</code>). This greatly simplifies developing our application, since we don&rsquo;t have to worry about the configuration changing between development mode and production.</p><p>So, to configure a proxy for Vite, we must modify our <code>vite.config.js</code> file in our <code>client</code> folder by adding a few additional settings:</p><div class=tab-panel data-tab-group=6f7278d75709eb26b94b0d57d1b4ec35><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=viteconfigjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6f7278d75709eb26b94b0d57d1b4ec35","viteconfigjs")'>
<span class=tab-nav-text>vite.config.js</span></button></div><div class=tab-content-container><div data-tab-item=viteconfigjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>fileURLToPath</span><span class=p>,</span> <span class=nx>URL</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;node:url&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>defineConfig</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vite&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>vue</span> <span class=nx>from</span> <span class=s1>&#39;@vitejs/plugin-vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>vueDevTools</span> <span class=nx>from</span> <span class=s1>&#39;vite-plugin-vue-devtools&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>tailwindcss</span> <span class=nx>from</span> <span class=s1>&#39;@tailwindcss/vite&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// https://vite.dev/config/
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=k>default</span> <span class=nx>defineConfig</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>plugins</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>vue</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>vueDevTools</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>tailwindcss</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>resolve</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>alias</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;@&#39;</span><span class=o>:</span> <span class=nx>fileURLToPath</span><span class=p>(</span><span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=s1>&#39;./src&#39;</span><span class=p>,</span> <span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>url</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>server</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>proxy</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Proxy all API requests
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=s1>&#39;/api&#39;</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>target</span><span class=o>:</span> <span class=s1>&#39;http://localhost:3000&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>changeOrigin</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>secure</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Proxy Open API Docs
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=s1>&#39;/docs&#39;</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>target</span><span class=o>:</span> <span class=s1>&#39;http://localhost:3000&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>changeOrigin</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>secure</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Proxy Authentication Requests
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=s1>&#39;/auth&#39;</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>target</span><span class=o>:</span> <span class=s1>&#39;http://localhost:3000&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>changeOrigin</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>secure</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>In the new <code>server</code> section, we are including settings to proxy three different URL paths from our frontend to our backend:</p><ul><li><code>/api</code> - this will proxy all API requests</li><li><code>/docs</code> - this allows us to easily access the OpenAPI docs on our frontend in development mode</li><li><code>/auth</code> - this allows us to access the routes needed for authentication</li></ul><p>As we can see, this covers pretty much all routes available on our backend RESTful API server. Also, we need to remember that these routes are unique to our backend server, so we cannot use these same URLs as virtual routes in our Vue router on the frontend; otherwise, we&rsquo;ll have a conflict and our application may not work correctly.</p><p>So, let&rsquo;s test this by running both our client and server applications simultaneously, and then access the frontend application using port <code>5173</code> (or whatever port Vite is currently running our frontend application on). Once there, we should try to access the <code>/docs</code> URL. If it works, we know that our proxy is working correctly!</p><p><a href=#R-image-f4d82bb4169559beee04dbd819af4928 class=lightbox-link><img alt="Vue Proxy" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_proxy.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f4d82bb4169559beee04dbd819af4928><img alt="Vue Proxy" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_proxy.png></a></p><p>Notice in the screenshot above that the URL is running on port <code>5173</code> but it is able to access content that is running on port <code>3000</code> from our backend server. We can also see that it appears in the access logs on the backend server&rsquo;s terminal, so we know it is working properly.</p><h2 id=making-api-requests>Making API Requests</h2><p>Finally, let&rsquo;s see how we can make an API request to our backend RESTful API server from our frontend application. First, we&rsquo;ll need to install the <a href=https://axios-http.com/ rel=external target=_blank>Axios</a> HTTP client library in our frontend application. While we can use the basic <code>fetch</code> commands that are available by default, we&rsquo;ll quickly find that the extra features provided by Axios are worth adding an extra dependency to our application. So, let&rsquo;s install it using <code>npm</code> in our <code>client</code> folder:</p><div class=tab-panel data-tab-group=d85bb7225cac5888b940a97f53a44da3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d85bb7225cac5888b940a97f53a44da3","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install axios</span></span></code></pre></div></div></div></div></div><p>Next, let&rsquo;s create a new Vue component we can use for simple testing. We&rsquo;ll place this component in a file named <code>TestApi.vue</code> in the <code>src/components/test</code> folder:</p><div class=tab-panel data-tab-group=fb5d32d7b00d6d3cdf10ab3a8b8cd0c6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentstesttestapivue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fb5d32d7b00d6d3cdf10ab3a8b8cd0c6","srccomponentstesttestapivue")'>
<span class=tab-nav-text>src/components/test/TestApi.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentstesttestapivue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Test API Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>axios</span> <span class=nx>from</span> <span class=s1>&#39;axios&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Card</span> <span class=nx>from</span> <span class=s1>&#39;primevue/card&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Reactive State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>api_versions</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load API versions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>axios</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>api_versions</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Card</span> <span class=nt>v-for</span><span class=o>=</span><span class=s>&#34;api_version in api_versions&#34; :key=&#34;api_version.version&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>title</span><span class=p>&gt;</span><span class=nx>Version</span> <span class=p>{{</span> <span class=nx>api_version</span><span class=p>.</span><span class=nx>version</span> <span class=p>}}&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>content</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span><span class=nx>URL</span><span class=o>:</span> <span class=p>{{</span> <span class=nx>api_version</span><span class=p>.</span><span class=nx>url</span> <span class=p>}}&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Card</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>In this component, we start by creating a reactive state variable called <code>api_versions</code> that is initially set to an empty array. Then, we use the Axios library to send a request to the <code>/api</code> URL on our server, which is being proxied to the backend RESTful API. If we receive a response back, we&rsquo;ll go to the <code>then</code> function, which simply stores the data attached to the response in the <code>api_versions</code> reactive state variable, which should update our application as soon as it receives data. If there are any errors, we&rsquo;ll enter the <code>catch</code> function and log those errors to the browser&rsquo;s console.</p><p>In our template, we chose to use a <a href=https://primevue.org/card/ rel=external target=_blank>PrimeVue Card</a>, which is a very simple building block for our website to use. Since we want to include one card per API version, we are using a <code>v-for</code> Vue directive to allow us to iterate through a list of objects. This is discussed in detail in the <a href=https://vuejs.org/guide/essentials/list rel=external target=_blank>List Rendering</a> section of the Vue documentation. We are also binding a unique key to each element, which in this case is the <code>version</code> attribute for each <code>api_version</code> element.</p><p>To use this component, let&rsquo;s just add it to our <code>AboutView.vue</code> page for testing:</p><div class=tab-panel data-tab-group=763a32c96e5a3fbe5443339da299cb10><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcviewsaboutviewvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("763a32c96e5a3fbe5443339da299cb10","srcviewsaboutviewvue")'>
<span class=tab-nav-text>src/views/AboutView.vue</span></button></div><div class=tab-content-container><div data-tab-item=srcviewsaboutviewvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>TestApi</span> <span class=nx>from</span> <span class=s1>&#39;../components/test/TestApi.vue&#39;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>main</span><span class=p>&gt;</span><span class=nx>This</span> <span class=nx>is</span> <span class=nx>an</span> <span class=nx>about</span> <span class=nx>page</span><span class=p>.&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>TestApi</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Now, when we visit our application and click on the link for the About page, we should see a list of API versions appear:</p><p><a href=#R-image-094000f18665b60949a1d86c5839e408 class=lightbox-link><img alt="Vue Proxy Working" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/primevue_api1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-094000f18665b60949a1d86c5839e408><img alt="Vue Proxy Working" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/primevue_api1.png></a></p><p>We can even test this by changing the API versions that are returned by our backend server and see the changes directly on our frontend application!</p><p><a href=#R-image-e9369d37cdaf88770a645ca62f436367 class=lightbox-link><img alt="Vue Proxy Test" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/primevue_api2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e9369d37cdaf88770a645ca62f436367><img alt="Vue Proxy Test" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/primevue_api2.png></a></p><p>There we go! We can now request data from our backend RESTful API server, and it will provide a valid response. However, right now the only URL path that does not require authentication is the <code>/api</code> path, so we still need to add a way for users to authenticate themselves and get a valid JWT to access the rest of the API. We&rsquo;ll cover that on the next part of this tutorial.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=authentication>Authentication</h1><a href="https://www.youtube.com/watch?v=TyXq29cEFGQ">YouTube Video</a><h2 id=handling-user-authentication>Handling User Authentication</h2><p>The time has come for us to finally handle user authentication on our frontend application. There are several different pieces that need to work together seamlessly for this to work properly, so let&rsquo;s explore what that looks like and see what it takes to get our users properly authenticated so they can access secure data in our application.</p><h2 id=pinia-store>Pinia Store</h2><p>First, since we want the user to be able to request a JWT that can be used throughout our application, it would make the most sense to store that token in a <a href=https://pinia.vuejs.org/ rel=external target=_blank>Pinia</a> store, instead of storing it directly in any individual component. This way we can easily access the token anywhere we need it in our application, and Pinia will handle making sure it is accessible and updated as needed.</p><p>First, we&rsquo;ll need to install a library that we can use to decode a JWT and read the contents. Thankfully, we can easily use the <a href=https://www.npmjs.com/package/jwt-decode rel=external target=_blank>jwt-decode</a> library available on <code>npm</code> for this task:</p><div class=tab-panel data-tab-group=986172af7d08d68fb786604e4d55c893><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("986172af7d08d68fb786604e4d55c893","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install jwt-decode</span></span></code></pre></div></div></div></div></div><p>So, let&rsquo;s create a new store called <code>Token.js</code> in the <code>src/stores</code> folder with the following code:</p><div class=tab-panel data-tab-group=39d9e35d3241262460de9248fed66e80><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcstorestokenjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("39d9e35d3241262460de9248fed66e80","srcstorestokenjs")'>
<span class=tab-nav-text>src/stores/Token.js</span></button></div><div class=tab-content-container><div data-tab-item=srcstorestokenjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file JWT Token Store
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span><span class=p>,</span> <span class=nx>computed</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;vue&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>defineStore</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;pinia&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>jwtDecode</span> <span class=p>}</span>  <span class=nx>from</span> <span class=s2>&#34;jwt-decode&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>axios</span> <span class=nx>from</span> <span class=s2>&#34;axios&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Define Store
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>useTokenStore</span> <span class=o>=</span> <span class=nx>defineStore</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// State properties
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Getters
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>username</span> <span class=o>=</span> <span class=nx>computed</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=nx>token</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>?</span> <span class=nx>jwtDecode</span><span class=p>(</span><span class=nx>token</span><span class=p>.</span><span class=nx>value</span><span class=p>)[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>has_role</span> <span class=o>=</span> <span class=nx>computed</span><span class=p>(()</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>token</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>?</span> <span class=nx>jwtDecode</span><span class=p>(</span><span class=nx>token</span><span class=p>.</span><span class=nx>value</span><span class=p>)[</span><span class=s1>&#39;roles&#39;</span><span class=p>].</span><span class=nx>some</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>role</span> <span class=o>==</span> <span class=nx>role</span><span class=p>)</span> <span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Actions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Get a token for the user. 
</span></span></span><span class=line><span class=cl><span class=cm>   * 
</span></span></span><span class=line><span class=cl><span class=cm>   * If this fails, redirect to authentication page if parameter is true
</span></span></span><span class=line><span class=cl><span class=cm>   * 
</span></span></span><span class=line><span class=cl><span class=cm>   * @param redirect if true, redirect user to login page on failure
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=kd>function</span> <span class=nx>getToken</span><span class=p>(</span><span class=nx>redirect</span> <span class=o>=</span> <span class=kc>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;token:get&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>axios</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/auth/token&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>withCredentials</span><span class=o>:</span> <span class=kc>true</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=nx>token</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>token</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>token</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// If the response is a 401, the user is not logged in
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>response</span> <span class=o>&amp;&amp;</span> <span class=nx>error</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>401</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;token:get user not logged in&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>redirect</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;token:get redirecting to login page&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=nb>window</span><span class=p>.</span><span class=nx>location</span><span class=p>.</span><span class=nx>href</span> <span class=o>=</span> <span class=s1>&#39;/auth/cas&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;token:get error&#39;</span> <span class=o>+</span> <span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Log the user out and clear the token
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>logout</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>token</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>window</span><span class=p>.</span><span class=nx>location</span><span class=p>.</span><span class=nx>href</span> <span class=o>=</span> <span class=s1>&#39;/auth/logout&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Return all state, getters, and actions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=p>{</span><span class=nx>token</span><span class=p>,</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>has_role</span><span class=p>,</span> <span class=nx>getToken</span><span class=p>,</span> <span class=nx>logout</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>Let&rsquo;s take a look at each part of this Pinia store to understand how it works.</p><ul><li><code>export const useTokenStore = defineStore('token', () => {</code> - this first line creates a store with the unique name of <code>token</code> and exports a function that is used to make the store available in any component. We&rsquo;ll use this function later on this page to access the token in the store.</li><li><code>const token = ref('')</code> - next, we have a section that defines the state variables we actually want to keep in this Pinia store. Each of these are reactive state variables, just like we&rsquo;ve worked with before. In this store, we&rsquo;re just going to store the JWT we receive from our RESTful API backend server in the <code>token</code> variable here.</li><li><code>const username = computed(() =>...</code> - following the state, we have a couple of <a href=https://vuejs.org/guide/essentials/computed.html rel=external target=_blank>Computed Properties</a> that act as getters for our store. The first one will decode the JWT and extra the user&rsquo;s username for us to use in our application.</li><li><code>const has_role = computed(() =>...</code> - this getter will allow us to check if the user&rsquo;s token has a given role listed. This will help us make various parts of the application visible to the user, depending on which roles they have. This getter is unique in that it is an anonymous function that <em>returns</em> an anonymous function!</li><li><code>async function getToken(redirect = false)</code> - finally, we have a couple of actions, which are functions that can be called as part of the store, typically to retrieve the state from the server or perform some other operation on the state. The <code>getToken</code> function will use the Axios library to try and retrieve a token from the server. We have to include the <code>{withCredentials: true}</code> to direct Axios to also send along any cookies available in the browser for this request. If we receive a response, we store it in the <code>token</code> state for this store, showing that the user is correctly logged in. If not, we check and see if the response is an HTTP 401 response, letting us know that the user is not correctly logged in. If not, we can optionally redirect the user to the login page, or we can just silently fail. We&rsquo;ll see how both options are useful a bit later on this page. This function is written using <code>async/await</code> so we can optionally choose to <code>await</code> this function if we want to make sure a user is logged in before doing any other actions.</li><li><code>function logout()</code> - of course, the <code>logout</code> function does exactly what it says - it simply removes the token and then redirects the user to the logout route on the backend server. This is important to do, because it will tell the backend server to clear the cookie and also redirect us to the CAS server to make sure all of our sessions are closed.</li></ul><p>Finally, at the bottom, we have to remember to return every single state, getter, or action that is part of this Pinia store.</p><h2 id=user-profile-component>User Profile Component</h2><p>Now that we&rsquo;ve created a Pinia store to handle our JWT for our user, we can create a Vue component to work with the store to make it easy for the user to log in, log out, and see their information.</p><p>For this, we&rsquo;re going to create a new Vue component called <code>UserProfile.vue</code> and store it in the <code>src/components/layout</code> folder. It will contain the following content:</p><div class=tab-panel data-tab-group=3829203cc5ab9bf22052fa862bc18ead><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayoutuserprofilevue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3829203cc5ab9bf22052fa862bc18ead","srccomponentslayoutuserprofilevue")'>
<span class=tab-nav-text>src/components/layout/UserProfile.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayoutuserprofilevue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file User Profile menu option
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>storeToRefs</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;pinia&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Avatar</span><span class=p>,</span> <span class=nx>Menu</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useRouter</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue-router&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>useRouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Stores
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>useTokenStore</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/stores/Token&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>tokenStore</span> <span class=o>=</span> <span class=nx>useTokenStore</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>token</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>storeToRefs</span><span class=p>(</span><span class=nx>tokenStore</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Declare State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>items</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=nx>tokenStore</span><span class=p>.</span><span class=nx>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s1>&#39;pi pi-cog&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;profile&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;Logout&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s1>&#39;pi pi-sign-out&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=nx>tokenStore</span><span class=p>.</span><span class=nx>logout</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Menu Popup State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>menu</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Menu Toggle Button Handler
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>toggle</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>menu</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>toggle</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>If</span> <span class=nx>the</span> <span class=nx>token</span> <span class=nx>is</span> <span class=nx>empty</span><span class=p>,</span> <span class=nx>show</span> <span class=nx>the</span> <span class=nx>login</span> <span class=nx>button</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=nt>v-if</span><span class=o>=</span><span class=s>&#34;token.length == 0&#34; class=&#34;p-menubar-item-content&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>a</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item-link&#34;</span> <span class=nt>@click</span><span class=s>=&#34;tokenStore.getToken(true)&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item-icon pi pi-sign-in&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menu-item-label&#34;</span><span class=p>&gt;</span><span class=nx>Login</span><span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>Otherwise</span><span class=p>,</span> <span class=nx>assume</span> <span class=nx>the</span> <span class=nx>user</span> <span class=nx>is</span> <span class=nx>logged</span> <span class=k>in</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>v</span><span class=nt>-else</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item-content&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>a</span>
</span></span><span class=line><span class=cl>        <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item-link&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>id</span><span class=o>=</span><span class=s>&#34;user-icon&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nt>@click</span><span class=s>=&#34;toggle&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>aria</span><span class=nt>-haspopup</span><span class=err>=&#34;</span><span class=na>true</span><span class=err>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>aria</span><span class=nt>-controls</span><span class=err>=&#34;</span><span class=na>profile_menu</span><span class=err>&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>Avatar</span> <span class=na>icon</span><span class=o>=</span><span class=s>&#34;pi pi-user&#34;</span> <span class=na>shape</span><span class=o>=</span><span class=s>&#34;circle&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>Menu</span> <span class=na>ref</span><span class=o>=</span><span class=s>&#34;menu&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;profile_menu&#34;</span> <span class=nt>:model</span><span class=o>=</span><span class=s>&#34;items&#34;</span> <span class=nt>:popup</span><span class=o>=</span><span class=s>&#34;true&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span> <span class=na>scoped</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>user</span><span class=o>-</span><span class=nx>icon</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>padding</span><span class=o>:</span> <span class=mi>0</span><span class=nx>px</span> <span class=mi>12</span><span class=nx>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>As we can see, our components are slowly becoming more and more complex, but we can easily break down this component into several parts to see how it works.</p><div class=tab-panel data-tab-group=0e7f5f8e8755cac1d81bd8943e188a55><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayoutuserprofilevue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0e7f5f8e8755cac1d81bd8943e188a55","srccomponentslayoutuserprofilevue")'>
<span class=tab-nav-text>src/components/layout/UserProfile.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayoutuserprofilevue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=c1>// Stores
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>useTokenStore</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/stores/Token&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>tokenStore</span> <span class=o>=</span> <span class=nx>useTokenStore</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>token</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>storeToRefs</span><span class=p>(</span><span class=nx>tokenStore</span><span class=p>)</span></span></span></code></pre></div></div></div></div></div><p>First, these three lines in the <code>&lt;script setup></code> portion will load our <code>token</code> store we created earlier. We first import it, then we call the <code>useTokenStore</code> function to make it accessible. Finally, we are using the <code>storeToRefs</code> function to extract any state and getters from the store and make them direct reactive state variables we can use in our component.</p><div class=tab-panel data-tab-group=e2e188510fab971d6c1775868a3c94e1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayoutuserprofilevue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e2e188510fab971d6c1775868a3c94e1","srccomponentslayoutuserprofilevue")'>
<span class=tab-nav-text>src/components/layout/UserProfile.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayoutuserprofilevue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=c1>// Declare State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>items</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;Profile&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s1>&#39;pi pi-cog&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;profile&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;Logout&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s1>&#39;pi pi-sign-out&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=nx>tokenStore</span><span class=p>.</span><span class=nx>logout</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>])</span></span></span></code></pre></div></div></div></div></div><p>Next, we are setting up the menu items that will live in the submenu that is available when a user is logged on. These use the same menu item format that we used previously in our top-level menu bar.</p><div class=tab-panel data-tab-group=847f07c4bc3dc37b894f505509a8e991><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayoutuserprofilevue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("847f07c4bc3dc37b894f505509a8e991","srccomponentslayoutuserprofilevue")'>
<span class=tab-nav-text>src/components/layout/UserProfile.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayoutuserprofilevue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=c1>// Menu Popup State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>menu</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Menu Toggle Button Handler
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>toggle</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>menu</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>toggle</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Finally, we have a reactive state variable and a click handler function to enable our popup menu to appear and hide as users click on the profile button.</p><p>Now, let&rsquo;s break down the content in the <code>&lt;template></code> section as well.</p><div class=tab-panel data-tab-group=0aef2a6f18c77c671e0d9a3eb256587e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayoutuserprofilevue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0aef2a6f18c77c671e0d9a3eb256587e","srccomponentslayoutuserprofilevue")'>
<span class=tab-nav-text>src/components/layout/UserProfile.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayoutuserprofilevue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>If</span> <span class=nx>the</span> <span class=nx>token</span> <span class=nx>is</span> <span class=nx>empty</span><span class=p>,</span> <span class=nx>show</span> <span class=nx>the</span> <span class=nx>login</span> <span class=nx>button</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=nt>v-if</span><span class=o>=</span><span class=s>&#34;token.length == 0&#34; class=&#34;p-menubar-item-content&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>a</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item-link&#34;</span> <span class=nt>@click</span><span class=s>=&#34;tokenStore.getToken(true)&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item-icon pi pi-sign-in&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>span</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menu-item-label&#34;</span><span class=p>&gt;</span><span class=nx>Login</span><span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Our template consists of two different parts. First, if the <code>token</code> store has an empty token, we can assume that the user is not logged in. In that case, instead of showing any user profile information, we should just show a login button for the user to click. This button is styled using some PrimeVue CSS classes to match other buttons available in the top-level menu bar.</p><div class=tab-panel data-tab-group=0469a221738d7ec01af6afe0e490e355><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayoutuserprofilevue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0469a221738d7ec01af6afe0e490e355","srccomponentslayoutuserprofilevue")'>
<span class=tab-nav-text>src/components/layout/UserProfile.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayoutuserprofilevue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>Otherwise</span><span class=p>,</span> <span class=nx>assume</span> <span class=nx>the</span> <span class=nx>user</span> <span class=nx>is</span> <span class=nx>logged</span> <span class=k>in</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>v</span><span class=nt>-else</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item-content&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>a</span>
</span></span><span class=line><span class=cl>        <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-menubar-item-link&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>id</span><span class=o>=</span><span class=s>&#34;user-icon&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nt>@click</span><span class=s>=&#34;toggle&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>aria</span><span class=nt>-haspopup</span><span class=err>=&#34;</span><span class=na>true</span><span class=err>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>aria</span><span class=nt>-controls</span><span class=err>=&#34;</span><span class=na>profile_menu</span><span class=err>&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>Avatar</span> <span class=na>icon</span><span class=o>=</span><span class=s>&#34;pi pi-user&#34;</span> <span class=na>shape</span><span class=o>=</span><span class=s>&#34;circle&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>Menu</span> <span class=na>ref</span><span class=o>=</span><span class=s>&#34;menu&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;profile_menu&#34;</span> <span class=nt>:model</span><span class=o>=</span><span class=s>&#34;items&#34;</span> <span class=nt>:popup</span><span class=o>=</span><span class=s>&#34;true&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>However, if the user is logged in, we instead can show a clickable link that will open a submenu with a couple of options. To display the user&rsquo;s profile information, we are using a <a href=https://primevue.org/avatar/ rel=external target=_blank>PrimeVue Avatar</a> component with a default user icon, but we can easily replace that with a user&rsquo;s profile image if one exists in our application. We are also using a <a href=https://primevue.org/menu/ rel=external target=_blank>PrimeVue Menu</a> component to create a small popup menu if the user clicks on their profile icon. That menu includes options to view the user&rsquo;s profile,and also to log out of the application by calling the <code>logout</code> method in the <code>token</code> store.</p><p>We also see our first instance of a scoped CSS directive in this component:</p><div class=tab-panel data-tab-group=05f0082e845ad7154ca96cb0682aa7ea><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayoutuserprofilevue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("05f0082e845ad7154ca96cb0682aa7ea","srccomponentslayoutuserprofilevue")'>
<span class=tab-nav-text>src/components/layout/UserProfile.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayoutuserprofilevue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span> <span class=na>scoped</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>user</span><span class=o>-</span><span class=nx>icon</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>padding</span><span class=o>:</span> <span class=mi>0</span><span class=nx>px</span> <span class=mi>12</span><span class=nx>px</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>In effect, the Avatar component from PrimeVue is a bit taller than the rest of the items in the top-level menu bar. By default, the <code>p-menuvar-item-content</code> class has a lot of padding above and below the element, but we&rsquo;ve chosen to remove that padding by overriding the <code>padding</code> CSS directive on the <code>&lt;a></code> element with the ID <code>#user-icon</code>. This is a very powerful way to make little tweaks to the overall look and feel of our application to keep it consistent.</p><h2 id=integrating-the-user-profile-component>Integrating the User Profile Component</h2><p>Now we can add our new <code>UserProfile</code> component to our <code>TopMenu</code> component to make it visible in our application:</p><div class=tab-panel data-tab-group=6c8967dcbb6fa4d678919ad509365728><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayouttopmenuvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6c8967dcbb6fa4d678919ad509365728","srccomponentslayouttopmenuvue")'>
<span class=tab-nav-text>src/components/layout/TopMenu.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayouttopmenuvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import Components
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Menubar</span> <span class=nx>from</span> <span class=s1>&#39;primevue/menubar&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>ThemeToggle</span> <span class=nx>from</span> <span class=s1>&#39;./ThemeToggle.vue&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>UserProfile</span> <span class=nx>from</span> <span class=s1>&#39;./UserProfile.vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Menubar</span> <span class=nt>:model</span><span class=o>=</span><span class=s>&#34;items&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>start</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://placehold.co/40x40&#34;</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#34;Placeholder Logo&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>end</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;flex items-center gap-1&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>&lt;</span><span class=nt>ThemeToggle</span> <span class=p>/&gt;</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>&lt;</span><span class=nt>UserProfile</span> <span class=p>/&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Menubar</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>As we&rsquo;ve already seen before, we are simply importing the component into our file in the <code>&lt;script setup></code> section, and then adding it like any other HTML element in the <code>&lt;template></code> section. To help with layout, we&rsquo;ve wrapped the items in the <code>&lt;template #end></code> slot in a <code>&lt;div></code> of their own, and applied a few CSS classes from Tailwind to handle <a href=https://tailwindcss.com/docs/flex rel=external target=_blank>Flex Layout</a>, <a href=https://tailwindcss.com/docs/align-items rel=external target=_blank>Item Alignment</a>, and <a href=https://tailwindcss.com/docs/gap rel=external target=_blank>Gap Spacing</a>.</p><h2 id=fixing-the-cas-redirect>Fixing the CAS Redirect</h2><p>Finally, before we can test our authentication system, we must make one change to our website&rsquo;s configuration. Right now, our CAS authentication system is set to redirect users back to port <code>3000</code>, which is where our backend server is running. However, we now want users to be sent back to our frontend, which is running on port <code>5173</code>. So, in our <code>server</code> folder, we need to update one entry in our <code>.env</code> file:</p><div class=tab-panel data-tab-group=2bc051742af68493862fd81cfedb39af><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2bc051742af68493862fd81cfedb39af","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=nv>CAS_SERVICE_URL</span><span class=o>=</span>https://<span class=nv>$CODESPACE_NAME</span>-5173.<span class=nv>$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span></span></span></code></pre></div></div></div></div></div><p>Now, instead of referencing the <code>$PORT</code> setting, we have simply hard-coded the port <code>5173</code> used by Vite for now. Once we&rsquo;ve changed this setting, we must remember to manually restart our backend server by either stopping and restarting it in the terminal, or by typing <code>rs</code> in the running terminal window so Nodemon will restart it.</p><h2 id=testing-authentication>Testing Authentication</h2><p>At this point, we are finally ready to test our authentication setup. So, we&rsquo;ll need to make sure both our frontend and backend applications are running. Then, we can load our frontend application and try to click on the login button. If it works correctly, it should redirect us to the CAS server to log in. Once we have logged in, we&rsquo;ll be sent back to our frontend application, but the login button will still be visible. This time, however, if we click it, our frontend will be able to successfully get a token from the backend (since we are already logged in and have a valid cookie), and our frontend application will switch to show the user&rsquo;s profile option in the menu.</p><p><a href=#R-image-caee9cb24094694b68fb279ec3cc227c class=lightbox-link><img alt="Vue Authentication" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_auth.gif style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-caee9cb24094694b68fb279ec3cc227c><img alt="Vue Authentication" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_auth.gif></a></p><p>If everything is working correctly, our website should act like the example animation above! Now we just have to add a few more features to streamline this process a bit and actually request data from the server.</p><h2 id=authentication-process>Authentication Process</h2><p>Let&rsquo;s take a step back to examine the complexity of the authentication process for our application as it stands currently:</p><p><a href=#R-image-b0945f4aa0d3846348e19eea8f3c7c72 class=lightbox-link><img alt="Vue Auth Process" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_cas_auth.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b0945f4aa0d3846348e19eea8f3c7c72><img alt="Vue Auth Process" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_cas_auth.png></a></p><p>As we can see, there are lots of steps involved! It is always good to create diagrams like this in mind when developing an application - they can often be very helpful when we have to debug a complicated process like authentication.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=route-guards>Route Guards</h1><a href="https://www.youtube.com/watch?v=sK_-Cyn89T4">YouTube Video</a><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>In this video, the new <code>api.js</code> file was accidentally created in the <code>router</code> folder. It should be moved to the <code>configs</code> folder, which is shown in the next video.</p></div></div><h2 id=automatically-logging-in>Automatically Logging In</h2><p>One thing we may quickly realize as we use our application as it currently stands is that the user has to click the &ldquo;Login&rdquo; button twice to actually get logged into the system. That seems a bit counterintuitive, so we should take a minute to try and fix that.</p><p>Effectively, we want our application to try and request a token on behalf of the user behind the scenes as soon as the page is loaded. If a token can be received, we know the user is actually logged in and we can update the user interface accordingly. There are several approaches to do this:</p><ul><li>We can place this code in our top-level <code>App.vue</code> file - this will ensure it runs when any part of the web application is loaded</li><li>We can place it in a <a href=https://router.vuejs.org/guide/advanced/navigation-guards.html rel=external target=_blank>Navigation Guard</a> inside of our Vue Router. This will allow us to make sure the user is logged in, and we can even automatically redirect the user if they try to access something that requires them to log in first</li></ul><p>So, let&rsquo;s add a global navigation guard to our router, ensuring that we only have a single place that requests a token when the user first lands on the page.</p><h2 id=router-navigation-guards>Router Navigation Guards</h2><p>To do this, we need to edit the <code>src/router/index.js</code> to add a special <code>beforeEach</code> function to the router:</p><div class=tab-panel data-tab-group=3013a1189c5e3bc02a4b6ff62411c206><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcrouterindexjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3013a1189c5e3bc02a4b6ff62411c206","srcrouterindexjs")'>
<span class=tab-nav-text>src/router/index.js</span></button></div><div class=tab-content-container><div data-tab-item=srcrouterindexjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Vue Router for the application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router a Vue Router
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>createRouter</span><span class=p>,</span> <span class=nx>createWebHistory</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue-router&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import Stores
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>useTokenStore</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/stores/Token&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Views
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>HomeView</span> <span class=nx>from</span> <span class=s1>&#39;../views/HomeView.vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>createRouter</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure History Mode
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>history</span><span class=o>:</span> <span class=nx>createWebHistory</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>BASE_URL</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure routes
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>routes</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;home&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>component</span><span class=o>:</span> <span class=nx>HomeView</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/about&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;about&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// route level code-splitting
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// this generates a separate chunk (About.[hash].js) for this route
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// which is lazy-loaded when the route is visited.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>component</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;../views/AboutView.vue&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>//Global Route Guard
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>beforeEach</span><span class=p>(</span><span class=kr>async</span> <span class=p>(</span><span class=nx>to</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=c1>// Load Token Store
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>tokenStore</span> <span class=o>=</span> <span class=nx>useTokenStore</span><span class=p>();</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl>  <span class=c1>// Allow access to &#39;home&#39; and &#39;about&#39; routes automatically
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>noLoginRequired</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;home&#39;</span><span class=p>,</span> <span class=s1>&#39;about&#39;</span><span class=p>]</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>noLoginRequired</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>to</span><span class=p>.</span><span class=nx>name</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// If there is no token already
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>tokenStore</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Request a token in the background 
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>tokenStore</span><span class=p>.</span><span class=nx>getToken</span><span class=p>()</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl>  <span class=c1>// For all other routes
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// If there is no token already
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>tokenStore</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Request a token and redirect if not logged in 
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=kr>await</span> <span class=nx>tokenStore</span><span class=p>.</span><span class=nx>getToken</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span>
</span></span><span class="line hl"><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span></span></span></code></pre></div></div></div></div></div><p>In this navigation guard, we have identified two routes, <code>'home'</code> and <code>'about'</code> that don&rsquo;t require the user to log in first. So, if the route matches either of those, we request a token in the background if we don&rsquo;t already have one, but we don&rsquo;t <code>await</code> that function since we don&rsquo;t need it in order to complete the process. However, for all other routes that we&rsquo;ll create later in this project, we will <code>await</code> on the <code>tokenStore.getToken()</code> function to ensure that the user has a valid token available before allowing the application to load the next page. As we continue to add features to our application, we&rsquo;ll see that this is a very powerful way to keep track of our user and ensure they are always properly authenticated.</p><h2 id=axios-interceptors>Axios Interceptors</h2><p>We can also simplify one other part of our application by automatically configuring Axios with a few additional settings that will automatically inject the <code>Authorization: Bearer</code> header into each request, as well as silently requesting a new JWT token if ours appears to have expired.</p><p>For this, we&rsquo;ll create a new folder called <code>src/configs</code> and place a new file <code>api.js</code> inside of that folder with the following content:</p><div class=tab-panel data-tab-group=45b758969ae9ecbf49d03545e2e14d09><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcconfigsapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("45b758969ae9ecbf49d03545e2e14d09","srcconfigsapijs")'>
<span class=tab-nav-text>src/configs/api.js</span></button></div><div class=tab-content-container><div data-tab-item=srcconfigsapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Axios Configuration and Interceptors
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>axios</span> <span class=nx>from</span> <span class=s1>&#39;axios&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Stores
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>useTokenStore</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/stores/Token&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Axios Instance Setup
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>api</span> <span class=o>=</span> <span class=nx>axios</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Accept</span><span class=o>:</span> <span class=s1>&#39;application/json&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;application/json&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Add Interceptors
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>setupAxios</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure Requests
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>api</span><span class=p>.</span><span class=nx>interceptors</span><span class=p>.</span><span class=nx>request</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>config</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// If we are not trying to get a token or API versions, send the token
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>url</span> <span class=o>!==</span> <span class=s1>&#39;/auth/token&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>config</span><span class=p>.</span><span class=nx>url</span> <span class=o>!==</span> <span class=s1>&#39;/api&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>tokenStore</span> <span class=o>=</span> <span class=nx>useTokenStore</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>tokenStore</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>config</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s1>&#39;Authorization&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;Bearer &#39;</span> <span class=o>+</span> <span class=nx>tokenStore</span><span class=p>.</span><span class=nx>token</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>config</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// If we receive any errors, reject with the error
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>reject</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure Response
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>api</span><span class=p>.</span><span class=nx>interceptors</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Do not modify the response
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>(</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>res</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Gracefully handle errors
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>async</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Store original request config
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>config</span> <span class=o>=</span> <span class=nx>err</span><span class=p>.</span><span class=nx>config</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// If we are not trying to request a token but we get an error message
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>url</span> <span class=o>!==</span> <span class=s1>&#39;/auth/token&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>err</span><span class=p>.</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If the error is a 401 unauthorized, we might have a bad token
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>401</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Prevent infinite loops by tracking retries
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>config</span><span class=p>.</span><span class=nx>_retry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>config</span><span class=p>.</span><span class=nx>_retry</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Try to request a new token
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=kr>const</span> <span class=nx>tokenStore</span> <span class=o>=</span> <span class=nx>useTokenStore</span><span class=p>();</span>
</span></span><span class=line><span class=cl>              <span class=kr>await</span> <span class=nx>tokenStore</span><span class=p>.</span><span class=nx>getToken</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>              <span class=c1>// Retry the original request
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=k>return</span> <span class=nx>api</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>return</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>reject</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// This is a retry, so force an authentication
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kr>const</span> <span class=nx>tokenStore</span> <span class=o>=</span> <span class=nx>useTokenStore</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=kr>await</span> <span class=nx>tokenStore</span><span class=p>.</span><span class=nx>getToken</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// If we can&#39;t handle it, return the error
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=p>{</span> <span class=nx>api</span><span class=p>,</span> <span class=nx>setupAxios</span> <span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>This file configures an Axios instance to only accept <code>application/json</code> requests, which makes sense for our application. Then, in the <code>setupAxios</code> function, it will add some basic interceptors to modify any requests sent from this instance as well as responses received:</p><ul><li>If we try to request any URL other than <code>/auth/token</code> and <code>/api</code>, we&rsquo;ll assume that the user is accessing a route that requires a valid bearer token. So, we can automatically inject that into our request.</li><li>When we receive an error as a response, we&rsquo;ll check to see if it is an HTTP 401 Unauthorized error. If it comes from any URL except the <code>/auth/token</code> URL, we can assume that we might have an invalid token. So, we&rsquo;ll quickly try to request one in the background, and then retry the original request once. If it fails a second time, we&rsquo;ll redirect the user back to the login page so they can re-authenticate with the system.</li></ul><p>To use these interceptors, we must first enable them in the <code>src/main.js</code> file:</p><div class=tab-panel data-tab-group=b22ff483543d4baf0c20b8a207bcc7a4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcmainjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b22ff483543d4baf0c20b8a207bcc7a4","srcmainjs")'>
<span class=tab-nav-text>src/main.js</span></button></div><div class=tab-content-container><div data-tab-item=srcmainjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Main Vue application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>createApp</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>createPinia</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;pinia&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>PrimeVue</span> <span class=nx>from</span> <span class=s1>&#39;primevue/config&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Aura</span> <span class=nx>from</span> <span class=s1>&#39;@primeuix/themes/aura&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Tooltip</span> <span class=nx>from</span> <span class=s1>&#39;primevue/tooltip&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import CSS
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s1>&#39;./assets/main.css&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Vue App
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>App</span> <span class=nx>from</span> <span class=s1>&#39;./App.vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>router</span> <span class=nx>from</span> <span class=s1>&#39;./router&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>setupAxios</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;./configs/api&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Vue App
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>createApp</span><span class=p>(</span><span class=nx>App</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Install Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>createPinia</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>router</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>PrimeVue</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Theme Configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>theme</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>preset</span><span class=o>:</span> <span class=nx>Aura</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>darkModeSelector</span><span class=o>:</span> <span class=s1>&#39;.app-dark-mode&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Install Directives
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>directive</span><span class=p>(</span><span class=s1>&#39;tooltip&#39;</span><span class=p>,</span> <span class=nx>Tooltip</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Setup Interceptors
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>setupAxios</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Mount Vue App on page
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>mount</span><span class=p>(</span><span class=s1>&#39;#app&#39;</span><span class=p>)</span></span></span></code></pre></div></div></div></div></div><p>Now, anytime we want to request data from a protected route, we can use the <code>api</code> instance of Axios that we configured!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=accessing-api>Accessing API</h1><a href="https://www.youtube.com/watch?v=0ql16YXzXCM">YouTube Video</a><h2 id=accessing-the-api>Accessing the API</h2><p>Finally, let&rsquo;s see what it takes to actually access data that is available in our RESTful API using a properly authenticated request. For this example, we&rsquo;re going to create a simple <code>ProfileView</code> page that the user can access by clicking the <strong>Profile</strong> button available after they&rsquo;ve logged in. This page is just a test, but it will quickly demonstrate what we can do with our existing setup.</p><p>So, let&rsquo;s start by creating the <code>TestUser</code> component we plan on using on that page. We&rsquo;ll place it in our <code>src/components/test</code> folder.</p><div class=tab-panel data-tab-group=c160067791eb25571c7b2b5f92c60dae><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentstesttestuservue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c160067791eb25571c7b2b5f92c60dae","srccomponentstesttestuservue")'>
<span class=tab-nav-text>src/components/test/TestUser.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentstesttestuservue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Test User Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Card</span><span class=p>,</span> <span class=nx>Chip</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Reactive State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Users
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>api</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/v1/users&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Card</span> <span class=nt>v-for</span><span class=o>=</span><span class=s>&#34;user in users&#34; :key=&#34;user.id&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>title</span><span class=p>&gt;</span><span class=nx>Username</span><span class=o>:</span> <span class=p>{{</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=p>}}&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>content</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>Chip</span> <span class=nt>v-for</span><span class=o>=</span><span class=s>&#34;role in user.roles&#34; :label=&#34;role.role&#34; :key=&#34;role.id&#34;</span><span class=p> /&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Card</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>We should be easily able to compare the contents of this file to the <code>TestApi</code> component we developed earlier. In this case, however, we are using the <code>api</code> instance of Axios we created earlier to load our users. That instance will automatically send along the user&rsquo;s JWT to authenticate the request. We&rsquo;re also using the <a href=https://primevue.org/chip/ rel=external target=_blank>PrimeVue Chip</a> component to list the roles assigned to each user.</p><p>Next, we can create our new <code>ProfileView.vue</code> page in our <code>src/views</code> folder with the following content:</p><div class=tab-panel data-tab-group=9c28ee90c5410f82e99bb49c5159cc9b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcviewsprofileviewvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9c28ee90c5410f82e99bb49c5159cc9b","srcviewsprofileviewvue")'>
<span class=tab-nav-text>src/views/ProfileView.vue</span></button></div><div class=tab-content-container><div data-tab-item=srcviewsprofileviewvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>TestUser</span> <span class=nx>from</span> <span class=s1>&#39;../components/test/TestUser.vue&#39;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>TestUser</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>This is nearly identical to our other views, so nothing is really new here.</p><p>Finally, we need to add this page to our Vue Router in <code>src/router/index.js</code>:</p><div class=tab-panel data-tab-group=2c55e7230ffb7ad2d6baa4c05cd30370><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcrouterindexjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2c55e7230ffb7ad2d6baa4c05cd30370","srcrouterindexjs")'>
<span class=tab-nav-text>src/router/index.js</span></button></div><div class=tab-content-container><div data-tab-item=srcrouterindexjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Vue Router for the application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router a Vue Router
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>createRouter</span><span class=p>,</span> <span class=nx>createWebHistory</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue-router&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Stores
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>useTokenStore</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/stores/Token&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Views
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>HomeView</span> <span class=nx>from</span> <span class=s1>&#39;../views/HomeView.vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>createRouter</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure History Mode
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>history</span><span class=o>:</span> <span class=nx>createWebHistory</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>BASE_URL</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure routes
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>routes</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;home&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>component</span><span class=o>:</span> <span class=nx>HomeView</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/about&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;about&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// route level code-splitting
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// this generates a separate chunk (About.[hash].js) for this route
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// which is lazy-loaded when the route is visited.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>component</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;../views/AboutView.vue&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/profile&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;profile&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>component</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;../views/ProfileView.vue&#39;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Again, adding a route is as simple as giving it a name, a path, and listing the component that should be loaded.</p><p>Now, with all of that in place, we should be able to click on the <strong>Profile</strong> link on the menu under the user&rsquo;s profile image to access this page:</p><p><a href=#R-image-9ea317177b3926862a2b6f12adcab77d class=lightbox-link><img alt="Vue Auth Process" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/05/vue_api.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9ea317177b3926862a2b6f12adcab77d><img alt="Vue Auth Process" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/05/vue_api.png></a></p><p>This is the power of having a really well structured frontend application framework to build upon. Now that we&rsquo;ve spent all of this time configuring routing, authentication, components, and more, it becomes very straightforward to add new features to our application.</p><p>We can even refresh this page and it should reload properly without losing access! As long as we still have a valid cookie from our backend RESTful API server, our application will load, request a token, and then request the data, all seamlessly without any interruptions.</p><p>At this point, all that is left is to lint and format our code, then commit and push to GitHub!</p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=vuejs-crud-app>Vue.js CRUD App</h1><p>This example project builds on the previous Vue.js starter project by scaffolding a CRUD frontend for the basic users and roles tables.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li></li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Vue.js CRUD App</h1><article class=default><header class=headline></header><h1 id=roles-view>Roles View</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=roles-view>Roles View</h2><p>To start this project, let&rsquo;s add a new view and a new component to explore the roles available in our application.</p><p>First, let&rsquo;s create a simple component skeleton in a new <code>src/components/roles/</code> folder. We&rsquo;ll name it the <code>RolesList</code> component:</p><div class=tab-panel data-tab-group=4b998a7eb80b2dd670b48d05cce2ee62><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsrolesroleslist class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4b998a7eb80b2dd670b48d05cce2ee62","srccomponentsrolesroleslist")'>
<span class=tab-nav-text>src/components/roles/RolesList</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsrolesroleslist class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Roles List Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Card</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Reactive State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Roles
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>api</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/v1/roles&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>roles</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Card</span> <span class=nt>v-for</span><span class=o>=</span><span class=s>&#34;role in roles&#34; :key=&#34;role.id&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>title</span><span class=p>&gt;</span><span class=nx>Role</span><span class=o>:</span> <span class=p>{{</span> <span class=nx>role</span><span class=p>.</span><span class=nx>role</span> <span class=p>}}&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Card</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>This component should look very familiar - it is based on the <code>TestUser</code> component we developed in the previous tutorial.</p><p>Next, we should create a <code>RolesView.vue</code> component in the <code>src/views</code> folder to load that component on a page:</p><div class=tab-panel data-tab-group=d7c7d93fa62b56a8b0aaf2368d6fecd7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcviewsrolesviewvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d7c7d93fa62b56a8b0aaf2368d6fecd7","srcviewsrolesviewvue")'>
<span class=tab-nav-text>src/views/RolesView.vue</span></button></div><div class=tab-content-container><div data-tab-item=srcviewsrolesviewvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>RolesList</span> <span class=nx>from</span> <span class=s1>&#39;../components/roles/RolesList.vue&#39;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>RolesList</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>After that, we should add this page to our router:</p><div class=tab-panel data-tab-group=d43431acf667ed9eaee53d8375df1a85><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcrouterindexjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d43431acf667ed9eaee53d8375df1a85","srcrouterindexjs")'>
<span class=tab-nav-text>src/router/index.js</span></button></div><div class=tab-content-container><div data-tab-item=srcrouterindexjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>createRouter</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure History Mode
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>history</span><span class=o>:</span> <span class=nx>createWebHistory</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>BASE_URL</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure routes
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>routes</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;home&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>component</span><span class=o>:</span> <span class=nx>HomeView</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/about&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;about&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// route level code-splitting
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// this generates a separate chunk (About.[hash].js) for this route
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// which is lazy-loaded when the route is visited.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>component</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;../views/AboutView.vue&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/profile&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;profile&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>component</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;../views/ProfileView.vue&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/roles&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;roles&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>component</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;../views/RolesView.vue&#39;</span><span class=p>),</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Finally, let&rsquo;s also add it to our list of menu options in the <code>TopMenu</code> component:</p><div class=tab-panel data-tab-group=6703b35195d5be5d1009fdf8ef68a6ac><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayouttopmenuvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6703b35195d5be5d1009fdf8ef68a6ac","srccomponentslayouttopmenuvue")'>
<span class=tab-nav-text>src/components/layout/TopMenu.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayouttopmenuvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Declare State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>items</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;Home&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s1>&#39;pi pi-home&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;home&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;About&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s1>&#39;pi pi-info-circle&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;about&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;Roles&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s1>&#39;pi pi-id-card&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;roles&#39;</span> <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>With those changes in place, we should be able to view the list of available roles in our application by clicking the new Roles link in the top menu bar:</p><p><a href=#R-image-4f8bd5532893a6114ae1604c0c19cc0f class=lightbox-link><img alt="Roles View" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/crud_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4f8bd5532893a6114ae1604c0c19cc0f><img alt="Roles View" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/crud_1.png></a></p><p>Our application will even redirect users to the CAS server to authenticate if they aren&rsquo;t already logged in!</p><p>However, what if we log in using the <code>user</code> username instead of <code>admin</code>? Will this page still work? Unfortunately, because the <code>/api/v1/roles</code> API route requires a user to have the <code>manage_users</code> role, it will respond with an HTTP 401 error. We can see these errors in the console of our web browser:</p><p><a href=#R-image-2c8f9bbd4f50f82e2720079ff292153c class=lightbox-link><img alt="Bad Connection" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/crud_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2c8f9bbd4f50f82e2720079ff292153c><img alt="Bad Connection" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/crud_2.png></a></p><p>So, we need to add some additional code to our application to make sure that users only see the pages and links the are actually able to access.</p><h2 id=hiding-menu-items>Hiding Menu Items</h2><p>First, let&rsquo;s explore how we can hide various menu items from our top menu bar based on the roles assigned to our users. To enable this, we can tag each item in the menu that has restricted access with a list of roles that are able to access that page:</p><div class=tab-panel data-tab-group=7fa0efd3d70156e6dba8733fa1d73ce3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayouttopmenuvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7fa0efd3d70156e6dba8733fa1d73ce3","srccomponentslayouttopmenuvue")'>
<span class=tab-nav-text>src/components/layout/TopMenu.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayouttopmenuvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Declare State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>items</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;Home&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s1>&#39;pi pi-home&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;home&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;About&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s1>&#39;pi pi-info-circle&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;about&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;Roles&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s1>&#39;pi pi-id-card&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;roles&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;manage_users&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Then, we can create a <a href=https://vuejs.org/guide/essentials/computed.html rel=external target=_blank>Vue Computed Property</a> to filter the list of items used in the template:</p><div class=tab-panel data-tab-group=e97b6bf4e13c9e69a40005d844f61731><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayouttopmenuvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e97b6bf4e13c9e69a40005d844f61731","srccomponentslayouttopmenuvue")'>
<span class=tab-nav-text>src/components/layout/TopMenu.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayouttopmenuvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Top menu bar of the entire application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span><span class=p>,</span> <span class=nx>computed</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useRouter</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue-router&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>useRouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Components
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Menubar</span> <span class=nx>from</span> <span class=s1>&#39;primevue/menubar&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>ThemeToggle</span> <span class=nx>from</span> <span class=s1>&#39;./ThemeToggle.vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>UserProfile</span> <span class=nx>from</span> <span class=s1>&#39;./UserProfile.vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Stores
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>useTokenStore</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/stores/Token&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>tokenStore</span> <span class=o>=</span> <span class=nx>useTokenStore</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>visible_items</span> <span class=o>=</span> <span class=nx>computed</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>return</span> <span class=nx>items</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>filter</span><span class=p>((</span><span class=nx>item</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// If the item lists any roles
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>roles</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Assume the user must be logged in to view it
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>tokenStore</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=c1>// If the roles is a string containing an asterisk
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>roles</span> <span class=o>==</span> <span class=s2>&#34;*&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>          <span class=c1>// Allow all roles to view
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>          <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>          <span class=c1>// Otherwise, check if any role matches a role the user has
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>          <span class=k>return</span> <span class=nx>item</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>tokenStore</span><span class=p>.</span><span class=nx>has_role</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=c1>// If not logged in, hide item
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// If no roles listed, show item even if not logged in
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>})</span>
</span></span><span class="line hl"><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>In this function, we are filtering the the menu items based on the roles. If they have a set of roles listed, we check to see if it is an asterisk - if so, all roles are allowed. Otherwise, we assume that it is a list of roles, and check to see if at least one role matches a role that the user has by checking the <code>token</code> store&rsquo;s <code>has_role</code> getter method. Finally, if no roles are listed, we assume that the item should be visible to users even without logging in.</p><p>To use this new computed property, we just replace the <code>items</code> entry in the template with the new <code>computed_items</code> property:</p><div class=tab-panel data-tab-group=adee6de54bcc3ccbf59e0c3c28148f88><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayouttopmenuvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("adee6de54bcc3ccbf59e0c3c28148f88","srccomponentslayouttopmenuvue")'>
<span class=tab-nav-text>src/components/layout/TopMenu.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayouttopmenuvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>Menubar</span> <span class=nt>:model</span><span class=o>=</span><span class=s>&#34;visible_items&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>start</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://placehold.co/40x40&#34;</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#34;Placeholder Logo&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>end</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;flex items-center gap-1&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>ThemeToggle</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>UserProfile</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Menubar</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>That should properly hide menu items from the user based on their roles. Feel free to try it out!</p><h2 id=protecting-routes>Protecting Routes</h2><p>Of course, hiding the item from the menu does not prevent the user from manually typing in the route path in the URL and trying to access the page that way. So, we must also add some additional logic to our router to ensure that user&rsquo;s can&rsquo;t access. For that, we can add a <a href=https://router.vuejs.org/guide/advanced/navigation-guards.html#Per-Route-Guard rel=external target=_blank>Per-Route Guard</a> following a very similar approach. In our <code>src/router/index.js</code> file, we can add a new generator function to create a route guard based on roles, and then apply that guard as the <code>beforeEnter</code> property for a route:</p><div class=tab-panel data-tab-group=0aec2e5f26b5a402ba7cad45003b8526><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcrouterindexjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0aec2e5f26b5a402ba7cad45003b8526","srcrouterindexjs")'>
<span class=tab-nav-text>src/router/index.js</span></button></div><div class=tab-content-container><div data-tab-item=srcrouterindexjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=cm>/**
</span></span></span><span class="line hl"><span class=cl><span class=cm> * Router Guard Function to check for role before entering route
</span></span></span><span class="line hl"><span class=cl><span class=cm> * 
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @param roles a list of roles permitted to enter the route
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @return boolean true if the navigation is permitted, else returns to the home page
</span></span></span><span class="line hl"><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>requireRoles</span> <span class=o>=</span> <span class=p>(...</span><span class=nx>roles</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>return</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>tokenStore</span> <span class=o>=</span> <span class=nx>useTokenStore</span><span class=p>()</span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allow</span> <span class=o>=</span> <span class=nx>roles</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>tokenStore</span><span class=p>.</span><span class=nx>has_role</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>allow</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// allow navigation
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// redirect to home
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=p>{</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;home&#39;</span><span class=p>}</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>createRouter</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure History Mode
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>history</span><span class=o>:</span> <span class=nx>createWebHistory</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>BASE_URL</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure routes
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>routes</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;home&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>component</span><span class=o>:</span> <span class=nx>HomeView</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/about&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;about&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// route level code-splitting
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// this generates a separate chunk (About.[hash].js) for this route
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// which is lazy-loaded when the route is visited.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>component</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;../views/AboutView.vue&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/profile&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;profile&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>component</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;../views/ProfileView.vue&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/roles&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;roles&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>component</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;../views/RolesView.vue&#39;</span><span class=p>),</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>beforeEnter</span><span class=o>:</span> <span class=nx>requireRoles</span><span class=p>(</span><span class=s2>&#34;manage_users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, even if we try to type the <code>/roles</code> path into the address bar in our web browser, it won&rsquo;t allow us to reach that page unless we are logged in to a user account that has the correct role.</p><h2 id=reactive-style>Reactive Style</h2><p>We can also use Tailwind to add some reactive style to our components. For example, we can use the <a href=https://tailwindcss.com/docs/grid-template-columns rel=external target=_blank>Grid</a> layout options to place the components in a grid view:</p><div class=tab-panel data-tab-group=8bb1ca1d3816db82e62b23def296e7da><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsrolesroleslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8bb1ca1d3816db82e62b23def296e7da","srccomponentsrolesroleslistvue")'>
<span class=tab-nav-text>src/components/roles/RolesList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsrolesroleslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;grid grid-cols-1 xl:grid-cols-4 lg:grid-cols-3 sm:grid-cols-2 gap-2&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Card</span> <span class=nt>v-for</span><span class=o>=</span><span class=s>&#34;role in roles&#34; :key=&#34;role.id&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>title</span><span class=p>&gt;</span><span class=nx>Role</span><span class=o>:</span> <span class=p>{{</span> <span class=nx>role</span><span class=p>.</span><span class=nx>role</span> <span class=p>}}&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Card</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>This will give us a responsive layout that adjusts the number of columns based on the width of the screen:</p><p><a href=#R-image-d35bb4aa4733ff4b299fcb8683dd1199 class=lightbox-link><img alt="Responsive Layout" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_crud_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d35bb4aa4733ff4b299fcb8683dd1199><img alt="Responsive Layout" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_crud_1.png></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=users-table>Users Table</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=users-table>Users Table</h2><p>Now that we have explored the basics of adding new menu items and routes to our application, let&rsquo;s start working on the components to view and edit the users available in our application. To begin, we&rsquo;ll work on the *<em>GET ALL</em> route, which will allow us to view all of the users on our system. For this, we&rsquo;ll use the <a href=https://primevue.org/datatable/ rel=external target=_blank>PrimeVue DataTable</a> component, which is one of the most powerful components available in the PrimeVue library.</p><p>First, before we can do that, we must set up our new view and a route to get there, as well as a menu option. So, let&rsquo;s go through that really quickly.</p><p>First, we&rsquo;ll add a new route to the Vue router:</p><div class=tab-panel data-tab-group=690c4dae7f75ee39fef144766ebe35a7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcrouterindexjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("690c4dae7f75ee39fef144766ebe35a7","srcrouterindexjs")'>
<span class=tab-nav-text>src/router/index.js</span></button></div><div class=tab-content-container><div data-tab-item=srcrouterindexjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>createRouter</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure History Mode
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>history</span><span class=o>:</span> <span class=nx>createWebHistory</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>BASE_URL</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure routes
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>routes</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/users&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;users&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>component</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;../views/UsersListView.vue&#39;</span><span class=p>),</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>beforeEnter</span><span class=o>:</span> <span class=nx>requireRoles</span><span class=p>(</span><span class=s2>&#34;manage_users&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll also add that route as a menu item in our <code>TopMenu.vue</code> component:</p><div class=tab-panel data-tab-group=2100f7bbaa1c7a9960b6c2beba2e3963><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentslayouttopmenuvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2100f7bbaa1c7a9960b6c2beba2e3963","srccomponentslayouttopmenuvue")'>
<span class=tab-nav-text>src/components/layout/TopMenu.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentslayouttopmenuvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Declare State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>items</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>label</span><span class=o>:</span> <span class=s1>&#39;Users&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s1>&#39;pi pi-users&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>command</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;users&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;manage_users&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Then, we&rsquo;ll create a new view named <code>UsersListView.vue</code> that will contain our table component:</p><div class=tab-panel data-tab-group=085df7c1d3e52470f4257e91a4fb1553><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcviewsuserslistviewvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("085df7c1d3e52470f4257e91a4fb1553","srcviewsuserslistviewvue")'>
<span class=tab-nav-text>src/views/UsersListView.vue</span></button></div><div class=tab-content-container><div data-tab-item=srcviewsuserslistviewvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>UsersList</span> <span class=nx>from</span> <span class=s1>&#39;../components/users/UsersList.vue&#39;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>UsersList</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Finally, we&rsquo;ll create a new <code>UsersList</code> component to store our code:</p><div class=tab-panel data-tab-group=2a4dbeedcc57f76e808718a2c0a5b324><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2a4dbeedcc57f76e808718a2c0a5b324","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users List Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>Users</span> <span class=nx>List</span> <span class=nx>Here</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>With all of that in place, we should now be able to click on the <strong>Users</strong> button at the top of our page and get to the <code>UsersList</code> component on the appropriate view:</p><p><a href=#R-image-903881040906b59c5fca482b94d4667d class=lightbox-link><img alt="Users Table" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_crud_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-903881040906b59c5fca482b94d4667d><img alt="Users Table" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_crud_2.png></a></p><p>From here, we can start to build our table view.</p><h2 id=primevue-datatable>PrimeVue DataTable</h2><p>To use the <a href=https://primevue.org/datatable/ rel=external target=_blank>PrimeVue DataTable</a> component, we first need to get our data from the API so we can easily display it in our component. So, let&rsquo;s use the Axios api instance to query the API and get our list of users. This is nearly the exact same code we used previously to get the list of users:</p><div class=tab-panel data-tab-group=b13c45ea88dc65b46297235ae0bf34c2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b13c45ea88dc65b46297235ae0bf34c2","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users List Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Create Reactive State
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([])</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Load Users
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>api</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/v1/users&#39;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Now that we have that list, we can start to construct our DataTable. First, we&rsquo;ll need to import the required components in our <code>&lt;script setup></code> section:</p><div class=tab-panel data-tab-group=1b79893368c96fe999d3aa4c31efc0da><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1b79893368c96fe999d3aa4c31efc0da","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users List Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>DataTable</span> <span class=nx>from</span> <span class=s1>&#39;primevue/datatable&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>Column</span> <span class=nx>from</span> <span class=s1>&#39;primevue/column&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Now, in the <code>&lt;template></code> section, we can build a basic DataTable by including the data we want to view and the columns that should be included:</p><div class=tab-panel data-tab-group=cd58de4db9e8dc0a7db69ecfec512b32><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cd58de4db9e8dc0a7db69ecfec512b32","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>DataTable</span> <span class=nt>:value</span><span class=o>=</span><span class=s>&#34;users&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;username&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Username&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;roles&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Roles&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;createdAt&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Created&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;updatedAt&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Updated&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>DataTable</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Each <code>&lt;Column></code> component includes a field name for that column, as well as a header value. With that in place, we should see a simple page with lots of helpful information about our users:</p><p><a href=#R-image-2694d747148c893e723b77a73e655e34 class=lightbox-link><img alt="Users Table with Columns" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_crud_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2694d747148c893e723b77a73e655e34><img alt="Users Table with Columns" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_crud_3.png></a></p><p>This is a great start, but we can clean this up to make it much easier for our users to read and digest the information.</p><h2 id=custom-column-templates>Custom Column Templates</h2><p>First, let&rsquo;s create a couple of custom templates for columns. First, we notice that the <strong>Roles</strong> column is just outputting the entire JSON list of roles, but this is not very helpful. So, let&rsquo;s modify that column to present a list of <a href=https://primevue.org/chip/ rel=external target=_blank>Chips</a> representing the roles:</p><div class=tab-panel data-tab-group=60ceb2fd6fd29ba9b7fbd04294ebd26b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("60ceb2fd6fd29ba9b7fbd04294ebd26b","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users List Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>DataTable</span> <span class=nx>from</span> <span class=s1>&#39;primevue/datatable&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Column</span> <span class=nx>from</span> <span class=s1>&#39;primevue/column&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>Chip</span> <span class=nx>from</span> <span class=s1>&#39;primevue/chip&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>DataTable</span> <span class=nt>:value</span><span class=o>=</span><span class=s>&#34;users&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;username&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Username&#34;</span> <span class=p>/&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;roles&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Roles&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>body</span><span class=o>=</span><span class=s>&#34;{ data }&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;flex gap-2&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>&lt;</span><span class=nt>Chip</span> <span class=nt>v-for</span><span class=o>=</span><span class=s>&#34;role in data.roles&#34; :key=&#34;role.id&#34; :label=&#34;role.role&#34;</span><span class=p> </span> <span class=p>/&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;/</span><span class=nt>Column</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;createdAt&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Created&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;updatedAt&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Updated&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>DataTable</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Inside of the <code>&lt;Column></code> component, we place a <code>&lt;template></code> for the <code>#body</code> slot, and we also provide a link to the <code>data</code> of the <code>&lt;Column></code> component so we can access that data.</p><p>With this change, our table now looks like this:</p><p><a href=#R-image-8b4f29b81842418752e51d0c87aae939 class=lightbox-link><img alt="Users Table with Chips for Roles" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_crud_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8b4f29b81842418752e51d0c87aae939><img alt="Users Table with Chips for Roles" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_crud_4.png></a></p><p>However, we can improve on that a bit by adding some additional information to our application that helps us display these roles in a bit cleaner format. Let&rsquo;s create a new custom <code>RoleChip</code> component that will display the roles properly, along with some additional information.</p><div class=tab-panel data-tab-group=b851cf14a8eff55fba7bf1dfeb2666ea><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsrolesrolechipvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b851cf14a8eff55fba7bf1dfeb2666ea","srccomponentsrolesrolechipvue")'>
<span class=tab-nav-text>src/components/roles/RoleChip.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsrolesrolechipvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Roles Chip
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Chip</span> <span class=nx>from</span> <span class=s1>&#39;primevue/chip&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Incoming Props
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>props</span> <span class=o>=</span> <span class=nx>defineProps</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Role Object
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>role</span><span class=o>:</span> <span class=nb>Object</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Lookup Table
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Manage Users&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s2>&#34;pi pi-user-edit&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=mi>2</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Manage Documents&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s2>&#34;pi pi-pen-to-square&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=mi>3</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Add Documents&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s2>&#34;pi pi-file-plus&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=mi>4</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Manage Communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s2>&#34;pi pi-pencil&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=mi>5</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;Add Communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s2>&#34;pi pi-plus-circle&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=mi>6</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;View Documents&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s2>&#34;pi pi-file&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=mi>7</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;View Communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>icon</span><span class=o>:</span> <span class=s2>&#34;pi pi-building-columns&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>Chip</span> <span class=nt>:label</span><span class=o>=</span><span class=s>&#34;roles[props.role.id].name&#34;</span> <span class=nt>:icon</span><span class=o>=</span><span class=s>&#34;roles[props.role.id].icon&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>This component includes a constant lookup table that provides some additional information about each role, based on the role&rsquo;s ID. This allows us to assign a user-friendly name and icon to each role in our frontend application. In fact, if we are internationalizing this application, we could also use this component to translate the role names into localized forms here.</p><p>We are also seeing a great example of <a href=https://vuejs.org/guide/components/props.html rel=external target=_blank>Vue Props</a> in this component. Props allow us to pass data from one component down into another sub-component. It is a one-way data connection, which is very important to remember.</p><p>We can update our <code>UsersList.vue</code> component to use this new <code>RoleChip</code> component very easily:</p><div class=tab-panel data-tab-group=0a25b40695cb50c4d8d5fdd0816e77c5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0a25b40695cb50c4d8d5fdd0816e77c5","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users List Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>DataTable</span> <span class=nx>from</span> <span class=s1>&#39;primevue/datatable&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Column</span> <span class=nx>from</span> <span class=s1>&#39;primevue/column&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>RoleChip</span> <span class=nx>from</span> <span class=s1>&#39;../roles/RoleChip.vue&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>DataTable</span> <span class=nt>:value</span><span class=o>=</span><span class=s>&#34;users&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;username&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Username&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;roles&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Roles&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>body</span><span class=o>=</span><span class=s>&#34;{ data }&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;flex gap-2&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>&lt;</span><span class=nt>RoleChip</span> <span class=nt>v-for</span><span class=o>=</span><span class=s>&#34;role in data.roles&#34; :key=&#34;role.id&#34; :role=&#34;role&#34;</span><span class=p> </span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Column</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;createdAt&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Created&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;updatedAt&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Updated&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>DataTable</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Now we have a much cleaner view of the roles each user is assigned, with helpful icons to help us remember what each one does.</p><p><a href=#R-image-64f57de067759956848ca91a3ccddfad class=lightbox-link><img alt="Users Table with RoleChips" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_crud_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-64f57de067759956848ca91a3ccddfad><img alt="Users Table with RoleChips" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_crud_5.png></a></p><h2 id=handling-dates>Handling Dates</h2><p>Let&rsquo;s also clean up the <strong>Created</strong> and <strong>Updated</strong> columns by rendering the dates into a more useful format. For this, we can use the <a href=https://date-fns.org/ rel=external target=_blank>date-fns</a> library to help us format and display times easily in our project. First, we&rsquo;ll need to install it:</p><div class=tab-panel data-tab-group=41df4e6b99792af668e76813c169e319><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("41df4e6b99792af668e76813c169e319","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install date-fns</span></span></code></pre></div></div></div></div></div><p>Then, in our component, we can use it to format our dates by computing the distance in the past that the event occurred:</p><div class=tab-panel data-tab-group=fcaa46c1fb4c8e59e2be8e407d446661><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fcaa46c1fb4c8e59e2be8e407d446661","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users List Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>formatDistance</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;date-fns&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>DataTable</span> <span class=nx>from</span> <span class=s1>&#39;primevue/datatable&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Column</span> <span class=nx>from</span> <span class=s1>&#39;primevue/column&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>RoleChip</span> <span class=nx>from</span> <span class=s1>&#39;../roles/RoleChip.vue&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>DataTable</span> <span class=nt>:value</span><span class=o>=</span><span class=s>&#34;users&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;username&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Username&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;roles&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Roles&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>body</span><span class=o>=</span><span class=s>&#34;{ data }&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;flex gap-2&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>RoleChip</span> <span class=nt>v-for</span><span class=o>=</span><span class=s>&#34;role in data.roles&#34; :key=&#34;role.id&#34; :role=&#34;role&#34;</span><span class=p> </span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Column</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;createdAt&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Created&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>body</span><span class=o>=</span><span class=s>&#34;{ data }&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;</span><span class=nt>span</span> <span class=na>v</span><span class=nt>-tooltip</span><span class=na>.bottom</span><span class=err>=&#34;</span><span class=na>new</span> <span class=na>Date</span><span class=err>(</span><span class=na>data.createdAt</span><span class=err>)</span><span class=na>.toLocaleString</span><span class=err>()&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>{{</span> <span class=nx>formatDistance</span><span class=p>(</span><span class=k>new</span> <span class=nb>Date</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>createdAt</span><span class=p>),</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>(),</span> <span class=p>{</span> <span class=nx>addSuffix</span><span class=o>:</span> <span class=kc>true</span> <span class=p>})</span> <span class=p>}}</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;/</span><span class=nt>Column</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;updatedAt&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Created&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>body</span><span class=o>=</span><span class=s>&#34;{ data }&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;</span><span class=nt>span</span> <span class=na>v</span><span class=nt>-tooltip</span><span class=na>.bottom</span><span class=err>=&#34;</span><span class=na>new</span> <span class=na>Date</span><span class=err>(</span><span class=na>data.updatedAt</span><span class=err>)</span><span class=na>.toLocaleString</span><span class=err>()&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>{{</span> <span class=nx>formatDistance</span><span class=p>(</span><span class=k>new</span> <span class=nb>Date</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>updatedAt</span><span class=p>),</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>(),</span> <span class=p>{</span> <span class=nx>addSuffix</span><span class=o>:</span> <span class=kc>true</span> <span class=p>})</span> <span class=p>}}</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;/</span><span class=nt>Column</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>DataTable</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>With that in place, we can more easily see how long ago each user&rsquo;s account was created or updated:</p><p><a href=#R-image-62072091a86901997e8bbebfdd215268 class=lightbox-link><img alt="Users Table with Times" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_crud_6.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-62072091a86901997e8bbebfdd215268><img alt="Users Table with Times" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_crud_6.png></a></p><p>We can even hover over one of the formatted dates to see the actual date in a tooltip.</p><h2 id=sorting>Sorting</h2><p>We can also enable <a href=https://primevue.org/datatable/#sort rel=external target=_blank>Sorting</a> in our PrimeVue DataTable by simply adding the <code>sortable</code> property to any columns we&rsquo;d like to sort. For this example, let&rsquo;s add that to the <code>username</code>, <code>createdAt</code> and <code>updatedAt</code> fields:</p><div class=tab-panel data-tab-group=19cb49b6d9c02e6d8fe6430b2070d1ba><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("19cb49b6d9c02e6d8fe6430b2070d1ba","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>DataTable</span> <span class=nt>:value</span><span class=o>=</span><span class=s>&#34;users&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;username&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Username&#34;</span> <span class=na>sortable</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;roles&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Roles&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>body</span><span class=o>=</span><span class=s>&#34;{ data }&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;flex gap-2&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>RoleChip</span> <span class=nt>v-for</span><span class=o>=</span><span class=s>&#34;role in data.roles&#34; :key=&#34;role.id&#34; :role=&#34;role&#34;</span><span class=p> </span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Column</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;createdAt&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Created&#34;</span> <span class=na>sortable</span> <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>body</span><span class=o>=</span><span class=s>&#34;{ data }&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>span</span> <span class=na>v</span><span class=nt>-tooltip</span><span class=na>.bottom</span><span class=err>=&#34;</span><span class=na>new</span> <span class=na>Date</span><span class=err>(</span><span class=na>data.createdAt</span><span class=err>)</span><span class=na>.toLocaleString</span><span class=err>()&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>{{</span> <span class=nx>formatDistance</span><span class=p>(</span><span class=k>new</span> <span class=nb>Date</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>createdAt</span><span class=p>),</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>(),</span> <span class=p>{</span> <span class=nx>addSuffix</span><span class=o>:</span> <span class=kc>true</span> <span class=p>})</span> <span class=p>}}</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Column</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;updatedAt&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Updated&#34;</span> <span class=na>sortable</span> <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>body</span><span class=o>=</span><span class=s>&#34;{ data }&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>span</span> <span class=na>v</span><span class=nt>-tooltip</span><span class=na>.bottom</span><span class=err>=&#34;</span><span class=na>new</span> <span class=na>Date</span><span class=err>(</span><span class=na>data.updatedAt</span><span class=err>)</span><span class=na>.toLocaleString</span><span class=err>()&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>{{</span> <span class=nx>formatDistance</span><span class=p>(</span><span class=k>new</span> <span class=nb>Date</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>updatedAt</span><span class=p>),</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>(),</span> <span class=p>{</span> <span class=nx>addSuffix</span><span class=o>:</span> <span class=kc>true</span> <span class=p>})</span> <span class=p>}}</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Column</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>DataTable</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p><a href=#R-image-6fb545fcf5ed028a764e2def3fdce5ad class=lightbox-link><img alt="Users Table Sorting" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_crud_sort.gif style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6fb545fcf5ed028a764e2def3fdce5ad><img alt="Users Table Sorting" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_crud_sort.gif></a></p><p>We can even define a default column and sort order for our table:</p><div class=tab-panel data-tab-group=72812943f6b6fd4b652162e2ec94e977><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("72812943f6b6fd4b652162e2ec94e977","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>&lt;</span><span class=nt>DataTable</span> <span class=nt>:value</span><span class=o>=</span><span class=s>&#34;users&#34;</span> <span class=na>sortField</span><span class=o>=</span><span class=s>&#34;username&#34;</span> <span class=nt>:sortOrder</span><span class=o>=</span><span class=s>&#34;1&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>other</span> <span class=nx>code</span> <span class=nx>omitted</span> <span class=nx>here</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>DataTable</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><h2 id=global-filtering>Global Filtering</h2><p>Another great feature of PrimeVue&rsquo;s DataTable is the ability to quickly add <a href=https://primevue.org/datatable/#filter rel=external target=_blank>Filtering</a> features. We can define a global filter to allow us to search for a user by the username by simply defining a <code>global</code> filter set and a list of fields to search. We should also add a quick search box to the top of our DataTable template to accept this input.</p><div class=tab-panel data-tab-group=9eb268fbf601d65e9d575363a7542801><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9eb268fbf601d65e9d575363a7542801","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users List Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>formatDistance</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;date-fns&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>DataTable</span> <span class=nx>from</span> <span class=s1>&#39;primevue/datatable&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Column</span> <span class=nx>from</span> <span class=s1>&#39;primevue/column&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>IconField</span><span class=p>,</span> <span class=nx>InputIcon</span><span class=p>,</span> <span class=nx>InputText</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>FilterMatchMode</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@primevue/core/api&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>RoleChip</span> <span class=nx>from</span> <span class=s1>&#39;../roles/RoleChip.vue&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=c1>// Setup Filters
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>filters</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>({</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>global</span><span class=o>:</span> <span class=p>{</span> <span class=nx>value</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>matchMode</span><span class=o>:</span> <span class=nx>FilterMatchMode</span><span class=p>.</span><span class=nx>CONTAINS</span> <span class=p>},</span>
</span></span><span class="line hl"><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>&lt;</span><span class=nt>DataTable</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>:value</span><span class=o>=</span><span class=s>&#34;users&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=na>v</span><span class=nt>-model:filters</span><span class=o>=</span><span class=s>&#34;filters&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>:globalFilterFields</span><span class=o>=</span><span class=s>&#34;[&#39;username&#39;]&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=na>filterDisplay</span><span class=o>=</span><span class=s>&#34;menu&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=na>sortField</span><span class=o>=</span><span class=s>&#34;username&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>:sortOrder</span><span class=o>=</span><span class=s>&#34;1&#34;</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>header</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;flex justify-end&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;</span><span class=nt>IconField</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>&lt;</span><span class=nt>InputIcon</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>              <span class=p>&lt;</span><span class=nt>i</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;pi pi-search&#34;</span> <span class=p>/&gt;</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>&lt;/</span><span class=nt>InputIcon</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>&lt;</span><span class=nt>InputText</span> <span class=nt>v-model</span><span class=o>=</span><span class=s>&#34;filters[&#39;global&#39;].value&#34; placeholder=&#34;Keyword Search&#34;</span><span class=p> /&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;/</span><span class=nt>IconField</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>other</span> <span class=nx>code</span> <span class=nx>omitted</span> <span class=nx>here</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>DataTable</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>With this in place, we can now type in any username and filter the table for that username:</p><p><a href=#R-image-d26275c6c533b227fb9121b5dfb8fcee class=lightbox-link><img alt="Users Table Filtering Usernames" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_crud_filter1.gif style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d26275c6c533b227fb9121b5dfb8fcee><img alt="Users Table Filtering Usernames" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_crud_filter1.gif></a></p><h2 id=column-filtering>Column Filtering</h2><p>We can also do more advanced filtering, such as allowing users to select roles that they&rsquo;d like to search for. This is a bit more complex, as it requires us to first write our own custom filter function, and then we also have to add a small template for setting the filter options.</p><p>First, let&rsquo;s create a new custom filter function in our <code>&lt;script setup></code> section. We&rsquo;ll also need to get a list of the available roles in our system, so we can add that to this section as well.:</p><div class=tab-panel data-tab-group=ca820d96379c8c838b7613682ff70766><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ca820d96379c8c838b7613682ff70766","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users List Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>formatDistance</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;date-fns&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>DataTable</span> <span class=nx>from</span> <span class=s1>&#39;primevue/datatable&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Column</span> <span class=nx>from</span> <span class=s1>&#39;primevue/column&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>IconField</span><span class=p>,</span> <span class=nx>InputIcon</span><span class=p>,</span> <span class=nx>InputText</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>FilterMatchMode</span><span class=p>,</span> <span class=nx>FilterService</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@primevue/core/api&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>RoleChip</span> <span class=nx>from</span> <span class=s1>&#39;../roles/RoleChip.vue&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Reactive State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([])</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Users
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>api</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/v1/users&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Load Roles
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>api</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/v1/roles&#39;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>roles</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Custom Filter
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>FilterService</span><span class=p>.</span><span class=nx>register</span><span class=p>(</span><span class=s2>&#34;filterArrayOfObjectsById&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>targetArray</span><span class=p>,</span> <span class=nx>sourceArray</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>sourceArray</span> <span class=o>||</span> <span class=nx>sourceArray</span><span class=p>.</span><span class=nx>length</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=k>return</span> <span class=kc>true</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>  <span class=kd>let</span> <span class=nx>found</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>sourceArray</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>s</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>found</span> <span class=o>=</span> <span class=nx>found</span> <span class=o>&amp;&amp;</span> <span class=nx>targetArray</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>o</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>o</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>s</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>return</span> <span class=nx>found</span>
</span></span><span class="line hl"><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Setup Filters
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>filters</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>global</span><span class=o>:</span> <span class=p>{</span> <span class=nx>value</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>matchMode</span><span class=o>:</span> <span class=nx>FilterMatchMode</span><span class=p>.</span><span class=nx>CONTAINS</span> <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>roles</span><span class=o>:</span> <span class=p>{</span> <span class=nx>value</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>matchMode</span><span class=o>:</span> <span class=s2>&#34;filterArrayOfObjectsById&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>The <code>filterArrayOfObjectsById</code> function should look somewhat familiar - we have an array of roles we want to search for, and we want to ensure that the user has all of these roles (this is different than some of our other functions that look like this, where we want the user to have at least one of the roles).</p><p>Now, to make this visible in our template, we add a special <code>&lt;template #filter></code> slot to the <code>Column</code> that is displaying the roles. We also set the <code>filterDisplay</code> option on the top-level <code>DataTable</code> component to <code>"menu"</code> to allow us to have pop-up menus for filtering. For this menu, we&rsquo;re going to use the <a href=https://primevue.org/multiselect/ rel=external target=_blank>PrimeVue Multiselect</a> component, so we&rsquo;ll need to import it:</p><div class=tab-panel data-tab-group=73151ce6858eb92e0622097594d06ba0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("73151ce6858eb92e0622097594d06ba0","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users List Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>formatDistance</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;date-fns&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>DataTable</span> <span class=nx>from</span> <span class=s1>&#39;primevue/datatable&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Column</span> <span class=nx>from</span> <span class=s1>&#39;primevue/column&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>IconField</span><span class=p>,</span> <span class=nx>InputIcon</span><span class=p>,</span> <span class=nx>InputText</span><span class=p>,</span> <span class=nx>MultiSelect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>FilterMatchMode</span><span class=p>,</span> <span class=nx>FilterService</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@primevue/core/api&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>RoleChip</span> <span class=nx>from</span> <span class=s1>&#39;../roles/RoleChip.vue&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>DataTable</span>
</span></span><span class=line><span class=cl>    <span class=nt>:value</span><span class=o>=</span><span class=s>&#34;users&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>v</span><span class=nt>-model:filters</span><span class=o>=</span><span class=s>&#34;filters&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nt>:globalFilterFields</span><span class=o>=</span><span class=s>&#34;[&#39;username&#39;]&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=na>filterDisplay</span><span class=o>=</span><span class=s>&#34;menu&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>sortField</span><span class=o>=</span><span class=s>&#34;username&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nt>:sortOrder</span><span class=o>=</span><span class=s>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>other</span> <span class=nx>code</span> <span class=nx>omitted</span> <span class=nx>here</span> <span class=o>--&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>filterField</span><span class=o>=</span><span class=s>&#34;roles&#34;</span> <span class=nt>:showFilterMatchModes</span><span class=o>=</span><span class=s>&#34;false&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Roles&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>body</span><span class=o>=</span><span class=s>&#34;{ data }&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;flex gap-2&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>RoleChip</span> <span class=nt>v-for</span><span class=o>=</span><span class=s>&#34;role in data.roles&#34; :key=&#34;role.id&#34; :role=&#34;role&#34;</span><span class=p> /&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>filter</span><span class=o>=</span><span class=s>&#34;{ filterModel }&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;</span><span class=nt>MultiSelect</span>
</span></span><span class="line hl"><span class=cl>          <span class=nt>v-model</span><span class=o>=</span><span class=s>&#34;filterModel.value&#34;</span><span class=p>
</span></span></span><span class="line hl"><span class=cl><span class=p></span>          <span class=nt>:options</span><span class=o>=</span><span class=s>&#34;roles&#34;</span>
</span></span><span class="line hl"><span class=cl>          <span class=na>optionLabel</span><span class=o>=</span><span class=s>&#34;role&#34;</span>
</span></span><span class="line hl"><span class=cl>          <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;Any&#34;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>option</span><span class=o>=</span><span class=s>&#34;slotProps&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>            <span class=p>&lt;</span><span class=nt>RoleChip</span> <span class=nt>:role</span><span class=o>=</span><span class=s>&#34;slotProps.option&#34;</span> <span class=p>/&gt;</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;/</span><span class=nt>MultiSelect</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Column</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>other</span> <span class=nx>code</span> <span class=nx>omitted</span> <span class=nx>here</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>DataTable</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>With all of this in place, we can now filter based on roles as well:</p><p><a href=#R-image-95d50a96b97c7cd9e9ef15e80f7efc32 class=lightbox-link><img alt="Users Table Filtering Roles" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_crud_filter2.gif style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-95d50a96b97c7cd9e9ef15e80f7efc32><img alt="Users Table Filtering Roles" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_crud_filter2.gif></a></p><h2 id=buttons>Buttons</h2><p>Finally, let&rsquo;s work on adding some buttons to our table that will allow us to create new users, edit existing users, and delete users.</p><p>First, let&rsquo;s add a simple button to create a new user at the top of our DataTable component. We&rsquo;ll use a <a href=https://primevue.org/button/ rel=external target=_blank>PrimeVue Button</a> component for this, and we&rsquo;ll also need to import the Vue Router so we can route to a different view when this is clicked.</p><div class=tab-panel data-tab-group=1f0a2e76d7fed681148f27a3900d936c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1f0a2e76d7fed681148f27a3900d936c","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users List Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>formatDistance</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;date-fns&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>DataTable</span> <span class=nx>from</span> <span class=s1>&#39;primevue/datatable&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Column</span> <span class=nx>from</span> <span class=s1>&#39;primevue/column&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>IconField</span><span class=p>,</span> <span class=nx>InputIcon</span><span class=p>,</span> <span class=nx>InputText</span><span class=p>,</span> <span class=nx>MultiSelect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>FilterMatchMode</span><span class=p>,</span> <span class=nx>FilterService</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@primevue/core/api&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>RoleChip</span> <span class=nx>from</span> <span class=s1>&#39;../roles/RoleChip.vue&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>Button</span> <span class=nx>from</span> <span class=s1>&#39;primevue/button&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useRouter</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue-router&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>useRouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>DataTable</span>
</span></span><span class=line><span class=cl>    <span class=nt>:value</span><span class=o>=</span><span class=s>&#34;users&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>v</span><span class=nt>-model:filters</span><span class=o>=</span><span class=s>&#34;filters&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nt>:globalFilterFields</span><span class=o>=</span><span class=s>&#34;[&#39;username&#39;]&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>filterDisplay</span><span class=o>=</span><span class=s>&#34;menu&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>sortField</span><span class=o>=</span><span class=s>&#34;username&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nt>:sortOrder</span><span class=o>=</span><span class=s>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>header</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;flex justify-between&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;</span><span class=nt>Button</span>
</span></span><span class="line hl"><span class=cl>          <span class=na>label</span><span class=o>=</span><span class=s>&#34;New User&#34;</span>
</span></span><span class="line hl"><span class=cl>          <span class=na>icon</span><span class=o>=</span><span class=s>&#34;pi pi-user-plus&#34;</span>
</span></span><span class="line hl"><span class=cl>          <span class=na>severity</span><span class=o>=</span><span class=s>&#34;success&#34;</span>
</span></span><span class="line hl"><span class=cl>          <span class=err>@</span><span class=na>click</span><span class=o>=</span><span class=s>&#34;router.push({ name: &#39;newuser&#39; })&#34;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>IconField</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>InputIcon</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>i</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;pi pi-search&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;/</span><span class=nt>InputIcon</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>InputText</span> <span class=nt>v-model</span><span class=o>=</span><span class=s>&#34;filters[&#39;global&#39;].value&#34; placeholder=&#34;Keyword Search&#34;</span><span class=p> /&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>IconField</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>other</span> <span class=nx>code</span> <span class=nx>omitted</span> <span class=nx>here</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>DataTable</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>When we click on this button, we&rsquo;ll be sent to the <code>newuser</code> route in our application. This route doesn&rsquo;t currently exist, but we&rsquo;ll add it later in this tutorial.</p><p>Likewise, we want to add buttons to allow us to edit and delete each user&rsquo;s account, so let&rsquo;s add a new column to our DataTable with those buttons as well.</p><div class=tab-panel data-tab-group=d0d3c1b9380ddfde8db9861fadca08c9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d0d3c1b9380ddfde8db9861fadca08c9","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>DataTable</span>
</span></span><span class=line><span class=cl>    <span class=nt>:value</span><span class=o>=</span><span class=s>&#34;users&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>v</span><span class=nt>-model:filters</span><span class=o>=</span><span class=s>&#34;filters&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nt>:globalFilterFields</span><span class=o>=</span><span class=s>&#34;[&#39;username&#39;]&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>filterDisplay</span><span class=o>=</span><span class=s>&#34;menu&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>sortField</span><span class=o>=</span><span class=s>&#34;username&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nt>:sortOrder</span><span class=o>=</span><span class=s>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>other</span> <span class=nx>code</span> <span class=nx>omitted</span> <span class=nx>here</span> <span class=o>--&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Actions&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;min-width: 8rem&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>body</span><span class=o>=</span><span class=s>&#34;slotProps&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;flex gap-2&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>&lt;</span><span class=nt>Button</span>
</span></span><span class="line hl"><span class=cl>            <span class=na>icon</span><span class=o>=</span><span class=s>&#34;pi pi-pencil&#34;</span>
</span></span><span class="line hl"><span class=cl>            <span class=na>outlined</span>
</span></span><span class="line hl"><span class=cl>            <span class=na>rounded</span>
</span></span><span class="line hl"><span class=cl>            <span class=err>@</span><span class=na>click</span><span class=o>=</span><span class=s>&#34;router.push({ name: &#39;edituser&#39;, params: { id: slotProps.data.id } })&#34;</span>
</span></span><span class="line hl"><span class=cl>            <span class=na>v</span><span class=nt>-tooltip</span><span class=na>.bottom</span><span class=err>=&#34;&#39;</span><span class=na>Edit</span><span class=err>&#39;&#34;</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>/&gt;</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>&lt;</span><span class=nt>Button</span>
</span></span><span class="line hl"><span class=cl>            <span class=na>icon</span><span class=o>=</span><span class=s>&#34;pi pi-trash&#34;</span>
</span></span><span class="line hl"><span class=cl>            <span class=na>outlined</span>
</span></span><span class="line hl"><span class=cl>            <span class=na>rounded</span>
</span></span><span class="line hl"><span class=cl>            <span class=na>severity</span><span class=o>=</span><span class=s>&#34;danger&#34;</span>
</span></span><span class="line hl"><span class=cl>            <span class=err>@</span><span class=na>click</span><span class=o>=</span><span class=s>&#34;router.push({ name: &#39;deleteuser&#39;, params: { id: slotProps.data.id } })&#34;</span>
</span></span><span class="line hl"><span class=cl>            <span class=na>v</span><span class=nt>-tooltip</span><span class=na>.bottom</span><span class=err>=&#34;&#39;</span><span class=na>Delete</span><span class=err>&#39;&#34;</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>/&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;/</span><span class=nt>Column</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>DataTable</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>These buttons will direct us to the <code>edituser</code> and <code>deleteuser</code> routes, and they even include the ID of the user to be edited or deleted in the route parameters. We&rsquo;ll work on adding these features as well later in this tutorial. With these changes in place, our final DataTable for our users should look something like this:</p><p><a href=#R-image-79808769b57f6e67c2e00bca8de813b2 class=lightbox-link><img alt="Final Users Data Table" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_crud_7.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-79808769b57f6e67c2e00bca8de813b2><img alt="Final Users Data Table" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_crud_7.png></a></p><p>For the rest of this tutorial, we&rsquo;ll work on adding additional functionality to handle creating, editing, and deleting user accounts.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=edit-user>Edit User</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=editing-a-user>Editing a User</h2><p>The next major feature we can add to our frontend application is the ability to edit a user. To do this, we&rsquo;ll need to create a view and a component that contains the form fields for editing a user, as well as the logic to communicate any changes back to the API.</p><p>As always, we&rsquo;ll start by adding a route to our <code>src/router/index.js</code> file for this route:</p><div class=tab-panel data-tab-group=e24a1384486246a85d5099358889c48f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcrouterindexjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e24a1384486246a85d5099358889c48f","srcrouterindexjs")'>
<span class=tab-nav-text>src/router/index.js</span></button></div><div class=tab-content-container><div data-tab-item=srcrouterindexjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>createRouter</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure History Mode
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>history</span><span class=o>:</span> <span class=nx>createWebHistory</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>BASE_URL</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Configure routes
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>routes</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/users/:id/edit&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;edituser&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>component</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;../views/UsersEditView.vue&#39;</span><span class=p>),</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>beforeEnter</span><span class=o>:</span> <span class=nx>requireRoles</span><span class=p>(</span><span class=s1>&#39;manage_users&#39;</span><span class=p>),</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>props</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>In this route, we are using <code>:id</code> to represent a <a href=https://router.vuejs.org/guide/essentials/dynamic-matching.html rel=external target=_blank>Route Parameter</a>, which is the same syntax we saw earlier in our Express backend. Since we want that route parameter to be passed as a Vue prop to our view component, we also add the <code>props: true</code> entry to this route definition.</p><p>Next, we&rsquo;ll create a simple <code>UsersEditView.vue</code> component in our <code>src/views</code> folder to contain the new view:</p><div class=tab-panel data-tab-group=387140ddb7853d5acad7d1134a7fec97><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcviewsuserseditviewvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("387140ddb7853d5acad7d1134a7fec97","srcviewsuserseditviewvue")'>
<span class=tab-nav-text>src/views/UsersEditView.vue</span></button></div><div class=tab-content-container><div data-tab-item=srcviewsuserseditviewvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>UserEdit</span> <span class=nx>from</span> <span class=s1>&#39;../components/users/UserEdit.vue&#39;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>UserEdit</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Finally, we&rsquo;ll create our new component in the <code>src/components/users/UserEdit.vue</code> file with the following default content:</p><div class=tab-panel data-tab-group=a6c54609fa2bcb616a0d0881145b80ce><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a6c54609fa2bcb616a0d0881145b80ce","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file User Edit Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>Edit</span> <span class=nx>User</span> <span class=nx>Here</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><h2 id=getting-user-data>Getting User Data</h2><p>To begin, let&rsquo;s get the user&rsquo;s data from our API. We know that this component will have a Vue prop for the user&rsquo;s <code>id</code> available, because it is the only element on the <code>UsersEditView</code> page, so the property will <a href=https://vuejs.org/guide/components/attrs.html rel=external target=_blank>Fallthrough</a> to this element. So, we can declare it at the top of our component, and use it to request data about a single user in our component as a reactive state variable.</p><div class=tab-panel data-tab-group=901db7836726a6ae5595e2bca7e823b5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("901db7836726a6ae5595e2bca7e823b5","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file User Edit Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Incoming Props
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>props</span> <span class=o>=</span> <span class=nx>defineProps</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// User ID
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>id</span><span class=o>:</span> <span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Declare State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>({})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Users
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>api</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/v1/users/&#39;</span> <span class=o>+</span> <span class=nx>props</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>user</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>With this data in hand, we can start building a form to allow us to edit our user.</p><h2 id=creating-a-text-field-component>Creating a Text Field Component</h2><p>Our User account has two fields that we want to be able to edit: the <code>username</code> field and the list of <code>roles</code> assigned to the user. Let&rsquo;s tackle the <code>username</code> field first. PrimeVue includes many different components that can be used in a form. One of the simplest is their <a href=https://primevue.org/inputtext/ rel=external target=_blank>InputText</a> field that accepts textual input from the user. However, we can also add things like an <a href=https://primevue.org/iconfield/ rel=external target=_blank>IconField</a> to show an icon inside of the field, and a <a href=https://primevue.org/floatlabel/ rel=external target=_blank>FloatLabel</a> to easily include a descriptive label that floats over our field. One really cool feature is the ability to combine several of these into an <a href=https://primevue.org/iconfield/#floatlabel rel=external target=_blank>Icon Field with a Floating Label</a> as shown in the PrimeVue examples. However, because we know we plan on creating multiple forms with text input fields, let&rsquo;s create our own custom component that combines all of these items together.</p><p>We&rsquo;ll create a new component in the <code>src/components/forms/TextField.vue</code> with the following content:</p><div class=tab-panel data-tab-group=82c02971fb6a15be415a07edd11dcd52><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsformstextfieldvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("82c02971fb6a15be415a07edd11dcd52","srccomponentsformstextfieldvue")'>
<span class=tab-nav-text>src/components/forms/TextField.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsformstextfieldvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Custom Text Form Field Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>InputIcon</span><span class=p>,</span> <span class=nx>IconField</span><span class=p>,</span> <span class=nx>FloatLabel</span><span class=p>,</span> <span class=nx>InputText</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Incoming Props
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>props</span> <span class=o>=</span> <span class=nx>defineProps</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Field Name
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>field</span><span class=o>:</span> <span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Field Label
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>label</span><span class=o>:</span> <span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Field Icon
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>icon</span><span class=o>:</span> <span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Disable Editing
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>disabled</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>type</span><span class=o>:</span> <span class=nb>Boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// V-model of the field to be edited
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>model</span> <span class=o>=</span> <span class=nx>defineModel</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>FloatLabel</span> <span class=na>variant</span><span class=o>=</span><span class=s>&#34;on&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>IconField</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>InputIcon</span> <span class=nt>:class</span><span class=o>=</span><span class=s>&#34;props.icon&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>InputText</span> <span class=nt>:id</span><span class=o>=</span><span class=s>&#34;props.field&#34;</span> <span class=nt>:disabled</span><span class=o>=</span><span class=s>&#34;props.disabled&#34;</span> <span class=nt>v-model</span><span class=o>=</span><span class=s>&#34;model&#34;</span><span class=p> /&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>IconField</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>label</span> <span class=nt>:for</span><span class=o>=</span><span class=s>&#34;props.field&#34;</span><span class=p>&gt;{{</span> <span class=nx>props</span><span class=p>.</span><span class=nx>label</span> <span class=p>}}&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>FloatLabel</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>This component includes a number of props that define the form field we want to create, and then puts them all together following the model provided in the PrimeVue documentation.</p><p>With that component in place, we can use it our <code>UserEdit</code> component to edit the user&rsquo;s username:</p><div class=tab-panel data-tab-group=a68326cdea1b2b4d549c84f07221d8f5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a68326cdea1b2b4d549c84f07221d8f5","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file User Edit Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>TextField</span> <span class=nx>from</span> <span class=s1>&#39;../forms/TextField.vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>span</span><span class=p>&gt;{{</span> <span class=nx>user</span> <span class=p>}}&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>&lt;</span><span class=nt>TextField</span> <span class=nt>v-model</span><span class=o>=</span><span class=s>&#34;user.username&#34; field=&#34;username&#34; label=&#34;Username&#34; icon=&#34;pi pi-user&#34;</span><span class=p> /&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>For this example, we&rsquo;ve also added a <code>&lt;span></code> element showing the current contents of the <code>user</code> reactive state variable, just so we can see our form field in action. As we edit the data in the field, we can also see our <code>user</code> state variable update!</p><p><a href=#R-image-8328948516ab220c01ba460fd986b748 class=lightbox-link><img alt="Editing Username" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_edit1.gif style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8328948516ab220c01ba460fd986b748><img alt="Editing Username" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_edit1.gif></a></p><p>Since we can easily just edit the user&rsquo;s username without changing any other fields, we can test this by adding a <strong>Save</strong> and <strong>Cancel</strong> button to our page:</p><div class=tab-panel data-tab-group=e4f0ad90571a2a0492f0e1777cd1ce5a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e4f0ad90571a2a0492f0e1777cd1ce5a","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file User Edit Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Button</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>TextField</span> <span class=nx>from</span> <span class=s1>&#39;../forms/TextField.vue&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useRouter</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue-router&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>useRouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>span</span><span class=p>&gt;{{</span> <span class=nx>user</span> <span class=p>}}&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>TextField</span> <span class=nt>v-model</span><span class=o>=</span><span class=s>&#34;user.username&#34; field=&#34;username&#34; label=&#34;Username&#34; icon=&#34;pi pi-user&#34;</span><span class=p> /&gt;</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>&lt;</span><span class=nt>Button</span> <span class=na>severity</span><span class=o>=</span><span class=s>&#34;success&#34;</span> <span class=nt>@click</span><span class=s>=&#34;save&#34;</span> <span class=na>label</span><span class=o>=</span><span class=s>&#34;Save&#34;</span> <span class=p>/&gt;</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>&lt;</span><span class=nt>Button</span> <span class=na>severity</span><span class=o>=</span><span class=s>&#34;secondary&#34;</span> <span class=err>@</span><span class=na>click</span><span class=o>=</span><span class=s>&#34;router.push({ name: &#39;user&#39; })&#34;</span> <span class=na>label</span><span class=o>=</span><span class=s>&#34;Cancel&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>The functionality of the <strong>Cancel</strong> button is pretty straightforward; it just uses the Vue Router to send the user back to the <code>/users</code> route. For the <strong>Save</strong> button, however, we need to implement a custom <code>save</code> function in our component to save the updated user:</p><div class=tab-panel data-tab-group=6f56e523918b9fa69188c4c4c298e24b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6f56e523918b9fa69188c4c4c298e24b","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Save User
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>save</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>api</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=s1>&#39;/api/v1/users/&#39;</span> <span class=o>+</span> <span class=nx>props</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>201</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;users&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>With that code in place, we can click the <strong>Save</strong> button, and it should save our edit to the user&rsquo;s username and redirect us back to the <code>/users</code> route.</p><h2 id=toast-messages>Toast Messages</h2><p>However, there is no obvious visual cue that shows us the user was successfully saved, so our users may not really know if it worked or not. For that, we can use the <a href=https://primevue.org/toast/#position rel=external target=_blank>PrimeVue Toast</a> component to display messages to our users. To install it, we have to add a few lines to our <code>src/main.js</code> file:</p><div class=tab-panel data-tab-group=2a0322418ca319f276b66b12ba57442c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcmainjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2a0322418ca319f276b66b12ba57442c","srcmainjs")'>
<span class=tab-nav-text>src/main.js</span></button></div><div class=tab-content-container><div data-tab-item=srcmainjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Main Vue application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>createApp</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>createPinia</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;pinia&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>PrimeVue</span> <span class=nx>from</span> <span class=s1>&#39;primevue/config&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Aura</span> <span class=nx>from</span> <span class=s1>&#39;@primeuix/themes/aura&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Tooltip</span> <span class=nx>from</span> <span class=s1>&#39;primevue/tooltip&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>ToastService</span> <span class=nx>from</span> <span class=s1>&#39;primevue/toastservice&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import CSS
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s1>&#39;./assets/main.css&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Vue App
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>App</span> <span class=nx>from</span> <span class=s1>&#39;./App.vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>router</span> <span class=nx>from</span> <span class=s1>&#39;./router&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>setupAxios</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;./configs/api&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Vue App
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>createApp</span><span class=p>(</span><span class=nx>App</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Install Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>createPinia</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>router</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>PrimeVue</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Theme Configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>theme</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>preset</span><span class=o>:</span> <span class=nx>Aura</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>darkModeSelector</span><span class=o>:</span> <span class=s1>&#39;.app-dark-mode&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>ToastService</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Install Directives
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>directive</span><span class=p>(</span><span class=s1>&#39;tooltip&#39;</span><span class=p>,</span> <span class=nx>Tooltip</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Setup Interceptors
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>setupAxios</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Mount Vue App on page
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>mount</span><span class=p>(</span><span class=s1>&#39;#app&#39;</span><span class=p>)</span></span></span></code></pre></div></div></div></div></div><p>Then, we can add our <code>&lt;Toast></code> element to the top-level <code>App.vue</code> page so it is available throughout our application:</p><div class=tab-panel data-tab-group=f8652aa960cd56021d8f164dc1a2df6a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f8652aa960cd56021d8f164dc1a2df6a","appvue")'>
<span class=tab-nav-text>App.vue</span></button></div><div class=tab-content-container><div data-tab-item=appvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Main Vue Application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Components
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Toast</span> <span class=nx>from</span> <span class=s1>&#39;primevue/toast&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>TopMenu</span> <span class=nx>from</span> <span class=s1>&#39;./components/layout/TopMenu.vue&#39;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>header</span><span class=p>&gt;&lt;/</span><span class=nt>header</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>nav</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>Navigation</span> <span class=nx>Menu</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>TopMenu</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>nav</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;m-2&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=c>&lt;!--</span> <span class=nx>Main</span> <span class=nx>Application</span> <span class=nx>View</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>RouterView</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>footer</span><span class=p>&gt;&lt;/</span><span class=nt>footer</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>  <span class=p>&lt;</span><span class=nt>Toast</span> <span class=na>position</span><span class=o>=</span><span class=s>&#34;bottom-right&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>With that in place, we can use the <a href=https://primevue.org/toast/#toast-service rel=external target=_blank>ToastService</a> to display messages to our user from our <code>UserEdit</code> component:</p><div class=tab-panel data-tab-group=a1dccff25715144bffa69420574aa975><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a1dccff25715144bffa69420574aa975","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file User Edit Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Button</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>TextField</span> <span class=nx>from</span> <span class=s1>&#39;../forms/TextField.vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useRouter</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue-router&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>useRouter</span><span class=p>()</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useToast</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue/usetoast&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>toast</span> <span class=o>=</span> <span class=nx>useToast</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Save User
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>save</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>api</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=s1>&#39;/api/v1/users/&#39;</span> <span class=o>+</span> <span class=nx>props</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>201</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>toast</span><span class=p>.</span><span class=nx>add</span><span class=p>({</span> <span class=nx>severity</span><span class=o>:</span> <span class=s1>&#39;success&#39;</span><span class=p>,</span> <span class=nx>summary</span><span class=o>:</span> <span class=s2>&#34;Success&#34;</span><span class=p>,</span> <span class=nx>detail</span><span class=o>:</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>message</span><span class=p>,</span> <span class=nx>life</span><span class=o>:</span> <span class=mi>5000</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;users&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Now, when we successfully edit a user, we&rsquo;ll see a pop-up message on the lower right of our screen showing that the user was successfully saved!</p><p><a href=#R-image-29fc12c37c5463a581051a86f4608324 class=lightbox-link><img alt="Saving User shows Toast Message" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_edit2.gif style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-29fc12c37c5463a581051a86f4608324><img alt="Saving User shows Toast Message" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_edit2.gif></a></p><h2 id=handling-errors>Handling Errors</h2><p>What if we try to edit our user and end up receiving an error from the server? What should we do in that instance?</p><p>Thankfully, our backend RESTful API is already configured to send helpful, well-structured error messages when things go wrong. So, we can take advantage of that in our frontend application to display errors for the user.</p><p>To use these error messages, in our <code>UserEdit</code> component, we just need to grab them and store them in a new reactive state variable that we share with all of our form components:</p><div class=tab-panel data-tab-group=74497ccfa29236f48f51d33f97ff57e9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("74497ccfa29236f48f51d33f97ff57e9","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Declare State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>({})</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>errors</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Save User
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>save</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>errors</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=nx>api</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=s1>&#39;/api/v1/users/&#39;</span> <span class=o>+</span> <span class=nx>props</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>201</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>toast</span><span class=p>.</span><span class=nx>add</span><span class=p>({</span> <span class=nx>severity</span><span class=o>:</span> <span class=s1>&#39;success&#39;</span><span class=p>,</span> <span class=nx>summary</span><span class=o>:</span> <span class=s2>&#34;Success&#34;</span><span class=p>,</span> <span class=nx>detail</span><span class=o>:</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>message</span><span class=p>,</span> <span class=nx>life</span><span class=o>:</span> <span class=mi>5000</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;users&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>422</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>toast</span><span class=p>.</span><span class=nx>add</span><span class=p>({</span> <span class=nx>severity</span><span class=o>:</span> <span class=s1>&#39;warn&#39;</span><span class=p>,</span> <span class=nx>summary</span><span class=o>:</span> <span class=s2>&#34;Warning&#34;</span><span class=p>,</span> <span class=nx>detail</span><span class=o>:</span> <span class=nx>error</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>error</span><span class=p>,</span> <span class=nx>life</span><span class=o>:</span> <span class=mi>5000</span> <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>errors</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>error</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>errors</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>toast</span><span class=p>.</span><span class=nx>add</span><span class=p>({</span> <span class=nx>severity</span><span class=o>:</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=nx>summary</span><span class=o>:</span> <span class=s2>&#34;Error&#34;</span><span class=p>,</span> <span class=nx>detail</span><span class=o>:</span> <span class=nx>error</span><span class=p>,</span> <span class=nx>life</span><span class=o>:</span> <span class=mi>5000</span> <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>span</span><span class=p>&gt;{{</span> <span class=nx>user</span> <span class=p>}}&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>&lt;</span><span class=nt>TextField</span> <span class=nt>v-model</span><span class=o>=</span><span class=s>&#34;user.username&#34; field=&#34;username&#34; label=&#34;Username&#34; icon=&#34;pi pi-user&#34; :errors=&#34;errors&#34;</span><span class=p> /&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>Button</span> <span class=na>severity</span><span class=o>=</span><span class=s>&#34;success&#34;</span> <span class=nt>@click</span><span class=s>=&#34;save&#34;</span> <span class=na>label</span><span class=o>=</span><span class=s>&#34;Save&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>Button</span> <span class=na>severity</span><span class=o>=</span><span class=s>&#34;secondary&#34;</span> <span class=err>@</span><span class=na>click</span><span class=o>=</span><span class=s>&#34;router.push({ name: &#39;users&#39; })&#34;</span> <span class=na>label</span><span class=o>=</span><span class=s>&#34;Cancel&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Recall that these errors will have a standard structure, such as this:</p><div class=tab-panel data-tab-group=8c16e6fbcbf1deff049473abff409be2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=validation-error-structure class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8c16e6fbcbf1deff049473abff409be2","validation-error-structure")'>
<span class=tab-nav-text>Validation Error Structure</span></button></div><div class=tab-content-container><div data-tab-item=validation-error-structure class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;Validation Error&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;errors&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;attribute&#34;</span><span class=p>:</span> <span class=s2>&#34;username&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;username must be unique&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>So, in our <code>TextField.vue</code> component, we can look for any errors that match the <code>field</code> that the component is responsible for, and we can present those to the user.</p><div class=tab-panel data-tab-group=90d102237d83911f344696b34d80fcad><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsformtextfieldvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("90d102237d83911f344696b34d80fcad","srccomponentsformtextfieldvue")'>
<span class=tab-nav-text>src/components/form/TextField.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsformtextfieldvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Custom Text Form Field Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>computed</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>InputIcon</span><span class=p>,</span> <span class=nx>IconField</span><span class=p>,</span> <span class=nx>FloatLabel</span><span class=p>,</span> <span class=nx>InputText</span><span class=p>,</span> <span class=nx>Message</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Incoming Props
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>props</span> <span class=o>=</span> <span class=nx>defineProps</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Field Name
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>field</span><span class=o>:</span> <span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Field Label
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>label</span><span class=o>:</span> <span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Field Icon
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>icon</span><span class=o>:</span> <span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Disable Editing
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>disabled</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>type</span><span class=o>:</span> <span class=nb>Boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>errors</span><span class=o>:</span> <span class=nb>Array</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Find Error for Field
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>error</span> <span class=o>=</span> <span class=nx>computed</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>return</span> <span class=nx>props</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>e</span><span class=p>.</span><span class=nx>attribute</span> <span class=o>===</span> <span class=nx>props</span><span class=p>.</span><span class=nx>field</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// V-model of the field to be edited
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>model</span> <span class=o>=</span> <span class=nx>defineModel</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>FloatLabel</span> <span class=na>variant</span><span class=o>=</span><span class=s>&#34;on&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>IconField</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>InputIcon</span> <span class=nt>:class</span><span class=o>=</span><span class=s>&#34;props.icon&#34;</span> <span class=p>/&gt;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>&lt;</span><span class=nt>InputText</span> <span class=nt>:id</span><span class=o>=</span><span class=s>&#34;props.field&#34;</span> <span class=nt>:disabled</span><span class=o>=</span><span class=s>&#34;props.disabled&#34;</span> <span class=nt>:invalid</span><span class=o>=</span><span class=s>&#34;error&#34;</span> <span class=nt>v-model</span><span class=o>=</span><span class=s>&#34;model&#34;</span><span class=p> /&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>IconField</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>label</span> <span class=nt>:for</span><span class=o>=</span><span class=s>&#34;props.field&#34;</span><span class=p>&gt;{{</span> <span class=nx>props</span><span class=p>.</span><span class=nx>label</span> <span class=p>}}&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>FloatLabel</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=c>&lt;!--</span> <span class=nb>Error</span> <span class=nx>Text</span> <span class=o>--&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>Message</span> <span class=nt>v-if</span><span class=o>=</span><span class=s>&#34;error&#34; severity=&#34;error&#34; variant=&#34;simple&#34; size=&#34;small&#34;</span><span class=p>&gt;{{</span> <span class=na>error.message</span> <span class=p>}}&lt;/</span><span class=nt>Message</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Now, when we enter an invalid username, we&rsquo;ll clearly see the error on our form:</p><p><a href=#R-image-f3388d4550832704cb088fd0789f27bb class=lightbox-link><img alt="Error Field" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_crud_8.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f3388d4550832704cb088fd0789f27bb><img alt="Error Field" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_crud_8.png></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=edit-roles>Edit Roles</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=editing-roles>Editing Roles</h2><p>There are many different ways to edit the list of roles assigned to each user as well. One of the smoothest ways to select from a list of options is the <a href=https://primevue.org/autocomplete/ rel=external target=_blank>PrimeVue AutoComplete</a> component. Just like before, we can build our own version of this component that includes everything we included previously:</p><div class=tab-panel data-tab-group=cb3461b9eb86d870b7fe847418d53b1c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsformsautocompletemultiplefieldvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cb3461b9eb86d870b7fe847418d53b1c","srccomponentsformsautocompletemultiplefieldvue")'>
<span class=tab-nav-text>src/components/forms/AutoCompleteMultipleField.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsformsautocompletemultiplefieldvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Custom Autocomplete Multiple Field Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>computed</span><span class=p>,</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>InputIcon</span><span class=p>,</span> <span class=nx>IconField</span><span class=p>,</span> <span class=nx>FloatLabel</span><span class=p>,</span> <span class=nx>AutoComplete</span><span class=p>,</span> <span class=nx>Message</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Incoming Props
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>props</span> <span class=o>=</span> <span class=nx>defineProps</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Field Name
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>field</span><span class=o>:</span> <span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Field Label
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>label</span><span class=o>:</span> <span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Field Icon
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>icon</span><span class=o>:</span> <span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Disable Editing
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>disabled</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>type</span><span class=o>:</span> <span class=nb>Boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=c1>//Values to choose from
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>values</span><span class=o>:</span> <span class=nb>Array</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Value Label
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>valueLabel</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>type</span><span class=o>:</span> <span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span> <span class=s1>&#39;name&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>errors</span><span class=o>:</span> <span class=nb>Array</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Find Error for Field
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>error</span> <span class=o>=</span> <span class=nx>computed</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>props</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>e</span><span class=p>.</span><span class=nx>attribute</span> <span class=o>===</span> <span class=nx>props</span><span class=p>.</span><span class=nx>field</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// V-model of the field to be edited
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>model</span> <span class=o>=</span> <span class=nx>defineModel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// State variable for search results
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>items</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Search method
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>search</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>items</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>props</span><span class=p>.</span><span class=nx>values</span><span class=p>.</span><span class=nx>filter</span><span class=p>((</span><span class=nx>v</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>v</span><span class=p>[</span><span class=nx>props</span><span class=p>.</span><span class=nx>valueLabel</span><span class=p>].</span><span class=nx>includes</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>query</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>items</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>FloatLabel</span> <span class=na>variant</span><span class=o>=</span><span class=s>&#34;on&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>IconField</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>InputIcon</span> <span class=nt>:class</span><span class=o>=</span><span class=s>&#34;props.icon&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>AutoComplete</span>
</span></span><span class=line><span class=cl>          <span class=nt>:optionLabel</span><span class=o>=</span><span class=s>&#34;props.valueLabel&#34;</span>
</span></span><span class=line><span class=cl>          <span class=nt>:id</span><span class=o>=</span><span class=s>&#34;props.field&#34;</span>
</span></span><span class=line><span class=cl>          <span class=nt>:disabled</span><span class=o>=</span><span class=s>&#34;props.disabled&#34;</span>
</span></span><span class=line><span class=cl>          <span class=nt>:invalid</span><span class=o>=</span><span class=s>&#34;error&#34;</span>
</span></span><span class=line><span class=cl>          <span class=nt>v-model</span><span class=o>=</span><span class=s>&#34;model&#34;</span><span class=p>
</span></span></span><span class=line><span class=cl><span class=p></span>          <span class=na>forceSelection</span>
</span></span><span class=line><span class=cl>          <span class=na>multiple</span>
</span></span><span class=line><span class=cl>          <span class=na>fluid</span>
</span></span><span class=line><span class=cl>          <span class=nt>:suggestions</span><span class=o>=</span><span class=s>&#34;items&#34;</span>
</span></span><span class=line><span class=cl>          <span class=nt>@complete</span><span class=s>=&#34;search&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>IconField</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>label</span> <span class=nt>:for</span><span class=o>=</span><span class=s>&#34;props.field&#34;</span><span class=p>&gt;{{</span> <span class=nx>props</span><span class=p>.</span><span class=nx>label</span> <span class=p>}}&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>FloatLabel</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nb>Error</span> <span class=nx>Text</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Message</span> <span class=nt>v-if</span><span class=o>=</span><span class=s>&#34;error&#34; severity=&#34;error&#34; variant=&#34;simple&#34; size=&#34;small&#34;</span><span class=p>&gt;{{</span>
</span></span><span class=line><span class=cl>      <span class=na>error.message</span>
</span></span><span class=line><span class=cl>    <span class=p>}}&lt;/</span><span class=nt>Message</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>This component is very similar to the previous one, but it includes a couple of extra props to control the value that is displayed to the user as well as a function to help search through the list of values.</p><p>To use it, we&rsquo;ll need to load all of the available roles in our <code>UserEdit.vue</code> component so we can pass that along to the new <code>AutoCompleteMultipleField</code> component:</p><div class=tab-panel data-tab-group=bf966fc190902cf2ae77a8548f73c2e3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bf966fc190902cf2ae77a8548f73c2e3","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file User Edit Component
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Button</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>TextField</span> <span class=nx>from</span> <span class=s1>&#39;../forms/TextField.vue&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>AutoCompleteMultipleField</span> <span class=nx>from</span> <span class=s1>&#39;../forms/AutoCompleteMultipleField.vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useRouter</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue-router&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>useRouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useToast</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue/usetoast&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>toast</span> <span class=o>=</span> <span class=nx>useToast</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Incoming Props
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>props</span> <span class=o>=</span> <span class=nx>defineProps</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// User ID
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>id</span><span class=o>:</span> <span class=nb>String</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Declare State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>({})</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([])</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>errors</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=c1>// Load Roles
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>api</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/v1/roles&#39;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>roles</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>{{</span> <span class=nx>user</span> <span class=p>}}</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>TextField</span>
</span></span><span class=line><span class=cl>    <span class=nt>v-model</span><span class=o>=</span><span class=s>&#34;user.username&#34;</span><span class=p>
</span></span></span><span class=line><span class=cl><span class=p></span>    <span class=na>field</span><span class=o>=</span><span class=s>&#34;username&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>label</span><span class=o>=</span><span class=s>&#34;Username&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>icon</span><span class=o>=</span><span class=s>&#34;pi pi-user&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nt>:errors</span><span class=o>=</span><span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>/&gt;</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>&lt;</span><span class=nt>AutoCompleteMultipleField</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>v-model</span><span class=o>=</span><span class=s>&#34;user.roles&#34;</span><span class=p>
</span></span></span><span class="line hl"><span class=cl><span class=p></span>    <span class=na>field</span><span class=o>=</span><span class=s>&#34;roles&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=na>label</span><span class=o>=</span><span class=s>&#34;Roles&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=na>icon</span><span class=o>=</span><span class=s>&#34;pi pi-id-card&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>:errors</span><span class=o>=</span><span class=s>&#34;errors&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>:values</span><span class=o>=</span><span class=s>&#34;roles&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=na>valueLabel</span><span class=o>=</span><span class=s>&#34;role&#34;</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>Button</span> <span class=na>severity</span><span class=o>=</span><span class=s>&#34;success&#34;</span> <span class=nt>@click</span><span class=s>=&#34;save&#34;</span> <span class=na>label</span><span class=o>=</span><span class=s>&#34;Save&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>Button</span> <span class=na>severity</span><span class=o>=</span><span class=s>&#34;secondary&#34;</span> <span class=err>@</span><span class=na>click</span><span class=o>=</span><span class=s>&#34;router.push({ name: &#39;users&#39; })&#34;</span> <span class=na>label</span><span class=o>=</span><span class=s>&#34;Cancel&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>With that in place, we can now see a new field to edit a user&rsquo;s roles:</p><p><a href=#R-image-d3497d47a5412297791ef79b00dada27 class=lightbox-link><img alt=Roles class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_crud_9.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d3497d47a5412297791ef79b00dada27><img alt=Roles class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_crud_9.png></a></p><p>As we can see, however, the AutoComplete field for PrimeVue doesn&rsquo;t quite support having an icon in front of it. Thankfully, we can easily fix that in our CSS by just finding the offset used in the other fields:</p><p><a href=#R-image-0917adf9701280521883f20add207406 class=lightbox-link><img alt="CSS Offset" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_crud_10.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0917adf9701280521883f20add207406><img alt="CSS Offset" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_crud_10.png></a></p><p>Once we have that, we can add it to our new AutoComplete component in a <code>&lt;style scoped></code> section that references the correct class:</p><div class=tab-panel data-tab-group=5e87bb5bcf785f464765f13552a4bbfb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsformsautocompletemultiplefieldvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5e87bb5bcf785f464765f13552a4bbfb","srccomponentsformsautocompletemultiplefieldvue")'>
<span class=tab-nav-text>src/components/forms/AutoCompleteMultipleField.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsformsautocompletemultiplefieldvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>style</span> <span class=na>scoped</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>:</span><span class=nx>deep</span><span class=p>(.</span><span class=nx>p</span><span class=o>-</span><span class=nx>autocomplete</span> <span class=o>&gt;</span> <span class=nx>ul</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>padding</span><span class=o>-</span><span class=nx>inline</span><span class=o>-</span><span class=nx>start</span><span class=o>:</span> <span class=nx>calc</span><span class=p>((</span><span class=kd>var</span><span class=p>(</span><span class=o>--</span><span class=nx>p</span><span class=o>-</span><span class=nx>form</span><span class=o>-</span><span class=nx>field</span><span class=o>-</span><span class=nx>padding</span><span class=o>-</span><span class=nx>x</span><span class=p>)</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=kd>var</span><span class=p>(</span><span class=o>--</span><span class=nx>p</span><span class=o>-</span><span class=nx>icon</span><span class=o>-</span><span class=nx>size</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>style</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>That will fix the padding for our icon to show up properly!</p><p><a href=#R-image-394cabfb0a74eaeb623aa2d72f212852 class=lightbox-link><img alt="CSS Offset" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_crud_11.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-394cabfb0a74eaeb623aa2d72f212852><img alt="CSS Offset" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_crud_11.png></a></p><p>At this point, we can easily add and remove roles for this user. We can even click the save button and it should work as intended! No extra code is needed. So, we can remove the extra line in the <code>&lt;template></code> of our <code>UserEdit.vue</code> component to remove the debugging information.</p><h2 id=styling>Styling</h2><p>Finally, we can use some quick CSS styling to update the content of our <code>UserEdit.vue</code> page to be a bit easier to follow.</p><div class=tab-panel data-tab-group=099b7a3579e1c3471ffda4b6db651dca><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("099b7a3579e1c3471ffda4b6db651dca","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;flex flex-col gap-3 max-w-xl justify-items-center&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>h1</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;text-xl text-center m-1&#34;</span><span class=p>&gt;</span><span class=nx>Edit</span> <span class=nx>User</span><span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>TextField</span>
</span></span><span class=line><span class=cl>      <span class=nt>v-model</span><span class=o>=</span><span class=s>&#34;user.username&#34;</span><span class=p>
</span></span></span><span class=line><span class=cl><span class=p></span>      <span class=na>field</span><span class=o>=</span><span class=s>&#34;username&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>label</span><span class=o>=</span><span class=s>&#34;Username&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>icon</span><span class=o>=</span><span class=s>&#34;pi pi-user&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nt>:errors</span><span class=o>=</span><span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>AutoCompleteMultipleField</span>
</span></span><span class=line><span class=cl>      <span class=nt>v-model</span><span class=o>=</span><span class=s>&#34;user.roles&#34;</span><span class=p>
</span></span></span><span class=line><span class=cl><span class=p></span>      <span class=na>field</span><span class=o>=</span><span class=s>&#34;roles&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>label</span><span class=o>=</span><span class=s>&#34;Roles&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>icon</span><span class=o>=</span><span class=s>&#34;pi pi-id-card&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nt>:errors</span><span class=o>=</span><span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nt>:values</span><span class=o>=</span><span class=s>&#34;roles&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>valueLabel</span><span class=o>=</span><span class=s>&#34;role&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Button</span> <span class=na>severity</span><span class=o>=</span><span class=s>&#34;success&#34;</span> <span class=nt>@click</span><span class=s>=&#34;save&#34;</span> <span class=na>label</span><span class=o>=</span><span class=s>&#34;Save&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Button</span> <span class=na>severity</span><span class=o>=</span><span class=s>&#34;secondary&#34;</span> <span class=err>@</span><span class=na>click</span><span class=o>=</span><span class=s>&#34;router.push({ name: &#39;users&#39; })&#34;</span> <span class=na>label</span><span class=o>=</span><span class=s>&#34;Cancel&#34;</span> <span class=p>/&gt;</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>We can also add a <code>w-full</code> class to our <code>TextField</code> component to expand that field to fit the surrounding components:</p><div class=tab-panel data-tab-group=9fa07341061793c66d90a817ff8551fe><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsformstextfieldvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9fa07341061793c66d90a817ff8551fe","srccomponentsformstextfieldvue")'>
<span class=tab-nav-text>src/components/forms/TextField.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsformstextfieldvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>FloatLabel</span> <span class=na>variant</span><span class=o>=</span><span class=s>&#34;on&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>IconField</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>InputIcon</span> <span class=nt>:class</span><span class=o>=</span><span class=s>&#34;props.icon&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>InputText</span>
</span></span><span class=line><span class=cl>          <span class=nt>:id</span><span class=o>=</span><span class=s>&#34;props.field&#34;</span>
</span></span><span class=line><span class=cl>          <span class=nt>:disabled</span><span class=o>=</span><span class=s>&#34;props.disabled&#34;</span>
</span></span><span class=line><span class=cl>          <span class=nt>:invalid</span><span class=o>=</span><span class=s>&#34;error&#34;</span>
</span></span><span class=line><span class=cl>          <span class=nt>v-model</span><span class=o>=</span><span class=s>&#34;model&#34;</span><span class=p>
</span></span></span><span class="line hl"><span class=cl><span class=p></span>          <span class=na>class</span><span class=o>=</span><span class=s>&#34;w-full&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>IconField</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>label</span> <span class=nt>:for</span><span class=o>=</span><span class=s>&#34;props.field&#34;</span><span class=p>&gt;{{</span> <span class=nx>props</span><span class=p>.</span><span class=nx>label</span> <span class=p>}}&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>FloatLabel</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nb>Error</span> <span class=nx>Text</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Message</span> <span class=nt>v-if</span><span class=o>=</span><span class=s>&#34;error&#34; severity=&#34;error&#34; variant=&#34;simple&#34; size=&#34;small&#34;</span><span class=p>&gt;{{</span>
</span></span><span class=line><span class=cl>      <span class=na>error.message</span>
</span></span><span class=line><span class=cl>    <span class=p>}}&lt;/</span><span class=nt>Message</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>With all of that in place, we have a nice looking form to edit our users!</p><p><a href=#R-image-b029c4bc99ae4864686984595e739e8f class=lightbox-link><img alt="CSS Offset" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/06/vue_crud_12.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b029c4bc99ae4864686984595e739e8f><img alt="CSS Offset" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/06/vue_crud_12.png></a></p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=vuejs-components>Vue.js Components</h1><p>This example project builds on the previous Vue.js CRUD app by building a few custom components to view and update data in the application.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li></li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=deployment>Deployment</h1><p>This example project builds on the previous tutorials by finally showing how to build and deploy this application using Docker.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li></li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter X</div><h1 id=milestones>Milestones</h1><p>Class Project Milestones!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Milestones</h1><article class=default><header class=headline></header><h1 id=express-starter-project>Express Starter Project</h1><p>This set of milestones is all about building a RESTful API and interface for the <a href=https://lostkansas.ccrsdigitalprojects.com/ rel=external target=_blank>Lost Kansas Communities</a> project.</p><h2 id=milestone-1---express-starter-project>Milestone 1 - Express Starter Project</h2><p>Follow the instructions in the <a href=/cis526/x-examples/01-express-starter/>Example Project</a> to build a project using Node.js and Express that includes the following features:</p><ol><li>A working GitHub Codespace containing Node.js</li><li>A bare-bones Express application</li><li>Update the Express application from CommonJS to ES Modules</li><li>Application logs with Winston and Morgan</li><li>Install other useful Express libraries like <code>compression</code> and <code>helmet</code></li><li>Install and configure Nodemon</li><li>Install and configure dotenvx</li><li>Create code documentation with JSDoc and OpenAPI comments</li><li>Enable linting and formatting with ESLint and Prettier</li></ol><p>Effectively, just follow along with the example project and submit the resulting repository. This will be the starting point for the rest of the milestones!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=add-a-database>Add a Database</h1><p>This set of milestones is all about building a RESTful API and interface for the <a href=https://lostkansas.ccrsdigitalprojects.com/ rel=external target=_blank>Lost Kansas Communities</a> project.</p><h2 id=milestone-2---add-a-database>Milestone 2 - Add a Database</h2><p>Building from the <a href=/cis526/x-milestones/01-starter/>previous milestone</a>, expand upon the starter project by adding the following features:</p><ol><li>Create an SQLite database</li><li>Install and configure the Sequelize ORM and the Umzug migration tool</li><li>Configure an automated process to migrate and seed the data on application startup</li><li>Create database migrations, seeds, and models matching the database diagram given below</li></ol><h3 id=database-diagram>Database Diagram</h3><p><a href=#R-image-56c76bafc200ad53145e39365f132b42 class=lightbox-link><img alt="Database Diagram" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/milestones/02/lost_communities.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-56c76bafc200ad53145e39365f132b42><img alt="Database Diagram" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/milestones/02/lost_communities.png></a></p><h3 id=seed-data>Seed Data</h3><p>Seed data is stored in CSV files that can be downloaded from Canvas. See <a href=/cis526/x-examples/02-database/07-another-table/#seed>Seeding from a CSV File</a> for an example of how to read data from a CSV file when seeding the database.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=restful-api>RESTful API</h1><p>This set of milestones is all about building a RESTful API and interface for the <a href=https://lostkansas.ccrsdigitalprojects.com/ rel=external target=_blank>Lost Kansas Communities</a> project.</p><h2 id=milestone-3---restful-api>Milestone 3 - RESTful API</h2><p>Building from the <a href=/cis526/x-milestones/02-database/>previous milestone</a>, expand upon the starter project by adding the following features:</p><ol><li>Build a full RESTful API to manage the communities, counties, metadata, and documents. The RESTful API should faithfully implement the Open API specification given below.<ol><li>Notice that the <code>/api/v1/documents/{id}/upload</code> API path handles file uploads! We haven&rsquo;t covered that in these examples, but there are some prior examples in this class to build upon.</li><li>Pay special attention to the example inputs and outputs for each route. Your JSON should <strong>exactly</strong> match the structure of those examples. Note that some fields may be hidden in associated objects that are included.</li></ol></li><li>Each API endpoint should include full unit tests, with an explicit goal to test both successful and unsuccessful operations performed by that endpoint.</li><li>All functions, files, and exported objects should be documented using JSDoc and Open API following the examples given.</li></ol><h3 id=database-diagram>Database Diagram</h3><p><a href=#R-image-c2661402124c7f6f4e005d6325207581 class=lightbox-link><img alt="Database Diagram" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/milestones/02/lost_communities.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c2661402124c7f6f4e005d6325207581><img alt="Database Diagram" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/milestones/02/lost_communities.png></a></p><h3 id=open-api-specification>Open API Specification</h3><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p>You can download this specification file by clicking the link below, and then edit the <code>servers</code> section to test it using your server. You can use the <a href=https://editor.swagger.io/ rel=external target=_blank>Open API Editor</a> to see a cleaner view of this JSON file.</p><p>The OpenAPI specification looks best using the light theme. You can adjust the textbook theme in the left sidebar at the bottom of the textbook page.</p></div></div><div class="sc-openapi-wrapper is-loading helper-loading-container"><div class=sc-openapi-container id=R-openapi-45543e1e1adaf602113cf08625ef1f50 data-openapi-url=/cis526/milestones/03/openapi.json data-openapi-spec></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=authentication>Authentication</h1><p>This set of milestones is all about building a RESTful API and interface for the <a href=https://lostkansas.ccrsdigitalprojects.com/ rel=external target=_blank>Lost Kansas Communities</a> project.</p><h2 id=milestone-4---authentication>Milestone 4 - Authentication</h2><p>Building from the <a href=/cis526/x-milestones/03-rest-api/>previous milestone</a>, expand upon the starter project by adding the following features:</p><ol><li>Implement Bypass authentication using the <a href=https://www.passportjs.org/packages/passport-unique-token/ rel=external target=_blank>Unique Token Strategy</a> in Passport.js as shown in the tutorial. When enabled via the <code>.env</code> file, it should allow authentication via the <code>/auth/bypass?token=&lt;username></code> route.</li><li>Allow the system to create new users if a user tries to authenticate with a username not currently in the database. That user should not be assigned any roles by default.</li><li>Implement <a href=https://github.com/alt-cs-lab/passport-cas rel=external target=_blank>CAS</a> authentication strategy in Passport.js as shown in the tutorial. Users should be able to authenticate via the <code>https://testcas.cs.ksu.edu</code> server. CAS settings should be controlled via the <code>.env</code> file.</li><li>Implement <a href=https://www.npmjs.com/package/jsonwebtoken rel=external target=_blank>JSON Web Tokens</a> via the <code>/auth/token</code> route as shown in the tutorial. The token should include the user&rsquo;s ID and a list of roles assigned to the user.</li><li>Require a valid JWT to access ALL routes under the <code>/api/v1</code> path.</li><li>Implement role-based authorization for ALL routes under the <code>/api/v1</code> path. See below for a matrix of roles and allowed actions.</li><li>Update unit tests for each route to use authentication and also to test role-based authorization as shown in the tutorial.</li></ol><h3 id=authorization-matrix>Authorization Matrix</h3><ul><li>Path: <code>/api/v1/users</code><ul><li>ALL ACTIONS: <code>manage_users</code></li></ul></li><li>Path: <code>/api/v1/roles</code><ul><li>GET: <code>manage_users</code></li></ul></li><li>Path: <code>/api/v1/communities</code><ul><li>GET: [<code>view_communities</code>, <code>manage_communities</code>, <code>add_communities</code>]</li><li>POST: [<code>manage_communities</code>, <code>add_communities</code>]</li><li>PUT: [<code>manage_communities</code>]</li><li>DELETE: [<code>manage_communities</code>]</li></ul></li><li>Path: <code>/api/v1/counties</code><ul><li>GET: [<code>view_communities</code>, <code>manage_communities</code>, <code>add_communities</code>]</li></ul></li><li>Path: <code>/api/v1/documents</code><ul><li>GET: [<code>view_documents</code>, <code>manage_documents</code>, <code>add_documents</code>]</li><li>POST: [<code>manage_documents</code>, <code>add_documents</code>] (including file uploads)</li><li>PUT: [<code>manage_documents</code>]</li><li>DELETE: [<code>manage_documents</code>]</li></ul></li><li>Path: <code>/api/v1/metadata</code><ul><li>GET: [<code>view_documents</code>, <code>manage_documents</code>, <code>add_documents</code>]</li><li>POST: [<code>manage_documents</code>, <code>add_documents</code>] (including adding and removing communities and documents to metadata)</li><li>PUT: [<code>manage_documents</code>]</li><li>DELETE: [<code>manage_documents</code>]</li></ul></li></ul><h3 id=database-diagram>Database Diagram</h3><p><a href=#R-image-ed562e98e3ad45af4cc5439563b09e1e class=lightbox-link><img alt="Database Diagram" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/milestones/02/lost_communities.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ed562e98e3ad45af4cc5439563b09e1e><img alt="Database Diagram" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/milestones/02/lost_communities.png></a></p><h3 id=open-api-specification>Open API Specification</h3><p><strong>UPDATED FOR MILESTONE 4</strong></p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p>You can download this specification file by clicking the link below, and then edit the <code>servers</code> section to test it using your server. You can use the <a href=https://editor.swagger.io/ rel=external target=_blank>Open API Editor</a> to see a cleaner view of this JSON file.</p><p>The OpenAPI specification looks best using the light theme. You can adjust the textbook theme in the left sidebar at the bottom of the textbook page.</p></div></div><div class="sc-openapi-wrapper is-loading helper-loading-container"><div class=sc-openapi-container id=R-openapi-7ce158b7a1caeea2bc71ab6c12859b0c data-openapi-url=/cis526/milestones/04/openapi.json data-openapi-spec></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=vuejs-starter-project>Vue.js Starter Project</h1><p>This set of milestones is all about building a RESTful API and interface for the <a href=https://lostkansas.ccrsdigitalprojects.com/ rel=external target=_blank>Lost Kansas Communities</a> project.</p><h2 id=milestone-5---vue-starter-project>Milestone 5 - Vue Starter Project</h2><p>Follow the instructions in the <a href=/cis526/x-examples/05-vue-starter/>Example Project</a> to build a project using Vue.js that includes the following features:</p><ol><li>A single page frontend application running in <a href=https://vuejs.org/ rel=external target=_blank>Vue 3</a>.</li><li>Built-in Vue features such as <a href=https://router.vuejs.org/ rel=external target=_blank>Vue Router</a> and <a href=https://pinia.vuejs.org/ rel=external target=_blank>Pinia</a>.</li><li>Access to components and icons from <a href=https://primevue.org/ rel=external target=_blank>PrimeVue</a>.</li><li>Access to <a href=https://tailwindcss.com/ rel=external target=_blank>Tailwind CSS</a> for additional CSS styling and features.</li><li>A working <a href=https://primevue.org/theming/styled/#darkmode rel=external target=_blank>Dark Mode Theme</a> completed with a selector that remembers our preference.</li><li>A working <a href=https://vite.dev/ rel=external target=_blank>Vite</a> server that will proxy requests to our backend RESTful API seamlessly.</li><li>An <a href=https://axios-http.com/ rel=external target=_blank>Axios</a> client that can access our RESTful API routes.</li><li>A seamless system for authentication and requesting a JWT to access protected API routes.</li><li>A demo of accessing the API on the <code>/profile</code> page listing all users and roles assigned to those users (this page should load correctly for the <code>admin</code> user)</li></ol><p>Effectively, just follow along with the example project and submit the resulting repository. This will be the starting point for the rest of the milestones!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=vuejs-crud-app>Vue.js CRUD App</h1><p>This set of milestones is all about building a RESTful API and interface for the <a href=https://lostkansas.ccrsdigitalprojects.com/ rel=external target=_blank>Lost Kansas Communities</a> project.</p><h2 id=milestone-6---vuejs-crud-app>Milestone 6 - Vue.js CRUD App</h2><p>Building from the <a href=/cis526/x-milestones/05-vue-starter/>previous milestone</a>, expand upon the starter project by adding the following features:</p><ol><li></li></ol><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=vuejs-components>Vue.js Components</h1><p>This set of milestones is all about building a RESTful API and interface for the <a href=https://lostkansas.ccrsdigitalprojects.com/ rel=external target=_blank>Lost Kansas Communities</a> project.</p><h2 id=milestone-6---vuejs-crud-app>Milestone 6 - Vue.js CRUD App</h2><p>Building from the <a href=/cis526/x-milestones/06-vue-crud-app/>previous milestone</a>, expand upon the starter project by adding the following features:</p><ol><li></li></ol><footer class=footline></footer></article></section></section></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/41163dc548a00400a9f1d4962b4227b9a8ee4d20>Aug 10, 2023</a></p></div></div><script src=/cis526/js/clipboard.min.js?1744419070 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1744419070 defer></script><script src=/cis526/js/js-yaml.min.js?1744419070 defer></script><script>window.noZensmooth=!0</script><script src=/cis526/js/swagger-ui/swagger-ui-bundle.js?1744419070 defer></script><script src=/cis526/js/swagger-ui/swagger-ui-standalone-preset.js?1744419070 defer></script><script>window.themeUseOpenapi={css:"/js/swagger-ui/swagger-ui.css?1744419070",cssInProject:!0,assetsBuster:1744419070}</script><script src=/cis526/js/theme.js?1744419070 defer></script></body></html>
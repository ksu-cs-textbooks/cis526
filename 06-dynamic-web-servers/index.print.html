<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="The Web Comes of Age"><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Dynamic Web Servers :: CIS 526 Textbook"><meta name=twitter:description content="The Web Comes of Age"><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/06-dynamic-web-servers/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Dynamic Web Servers :: CIS 526 Textbook"><meta property="og:description" content="The Web Comes of Age"><meta property="og:locale" content="en-us"><meta property="og:type" content="website"><meta itemprop=name content="Dynamic Web Servers :: CIS 526 Textbook"><meta itemprop=description content="The Web Comes of Age"><meta itemprop=datePublished content="2018-08-24T10:53:05-05:00"><meta itemprop=dateModified content="2023-08-10T16:48:12-05:00"><meta itemprop=wordCount content="5"><title>Dynamic Web Servers :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/06-dynamic-web-servers/ rel=canonical type=text/html title="Dynamic Web Servers :: CIS 526 Textbook"><link href=/cis526/06-dynamic-web-servers/index.xml rel=alternate type=application/rss+xml title="Dynamic Web Servers :: CIS 526 Textbook"><link href=/cis526/06-dynamic-web-servers/tele.html rel=alternate type=text/html title="Dynamic Web Servers :: CIS 526 Textbook"><link href=/cis526/06-dynamic-web-servers/embed.html rel=alternate type=text/html title="Dynamic Web Servers :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1741383309 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1741383309 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1741383309 rel=stylesheet><link href=/cis526/css/auto-complete.css?1741383309 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1741383309 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1741383309 rel=stylesheet><link href=/cis526/css/fonts.css?1741383309 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1741383309 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1741383309 rel=stylesheet><link href=/cis526/css/theme-auto.css?1741383309 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1741383309 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1741383309 rel=stylesheet><link href=/cis526/css/print.css?1741383309 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1741383309 rel=stylesheet><script src=/cis526/js/variant.js?1741383309></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="..",window.relearn.relBaseUri="../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1741383309 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/06-dynamic-web-servers/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Dynamic Web Servers</span><meta itemprop=position content="1"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/05-web-servers/07-partial-downloads/ title="Partial Downloads (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/06-dynamic-web-servers/01-introduction/ title="Introduction (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable chapter narrow" tabindex=-1><div class=flex-block-wrapper><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 6</div><h1 id=dynamic-web-servers>Dynamic Web Servers</h1><p>The Web Comes of Age</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Dynamic Web Servers</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>While the first generation of webservers was used to serve static content (i.e. files), it was not long before developers began to realize that a lot more potential existed in the technologies of the web. A key realization here is that the resources served by the web server <em>don&rsquo;t need to exist</em> to be served.</p><p>Consider the directory listing from the previous chapter. It is <em>not</em> based on an existing file, but rather is <em>dynamically created</em> when requested by querying the file system of the server. This brings one clear benefit - if we add files to the directory, the next time we request the listing they will be included.</p><p><a href=#R-image-1ad74482ce92a75cdb2f684da032685e class=lightbox-link><img alt="Request-Response Pattern" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/6.1.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1ad74482ce92a75cdb2f684da032685e><img alt="Request-Response Pattern" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/6.1.1.png></a></p><p>Thus, we can create resources <em>dynamically</em> in response to a request. This is the core concept of a <em>dynamic web server</em>, which really means any kind of web server that generates at least some of its content dynamically. In this chapter, we will explore this class of web server.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cgi-scripts>CGI Scripts</h1><p>Before we dig too deeply into dynamic web servers, we should review our technologies used in the web. On the client side, we have HTML, CSS, and JavaScript. Managing communication between the client and server, we have HTTP. But on the server side of the equation, what standard web technologies do we use?</p><p><a href=#R-image-ebdc944c467059eaab9fe8417efb7464 class=lightbox-link><img alt="The Web Technologies" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/5.2.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ebdc944c467059eaab9fe8417efb7464><img alt="The Web Technologies" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/5.2.1.png></a></p><p>The answer is <em>none</em>. There <strong>is no standard server development language</strong>. In fact, web servers can be written in <em>almost every programming language</em>. This gives web application developers a tremendous amount of flexibility. Of course, that also means the choice of server-side technologies can quickly become overwhelming.</p><p>One technology that emerged to help manage some of this complexity was the <a href=https://en.wikipedia.org/wiki/Common_Gateway_Interface rel=external target=_blank>Common Gateway Interface (CGI)</a>, a web standard that allowed a traditional static webserver to respond to some requests by running a command-line program and piping the output to the requesting client. The CGI standard defined what variables needed to be collected by the web server and how they would be provided to the script.</p><p>The script itself could be written in any language that could communicate using stdin and stdout, though in practice most CGI scripts were written using Perl or Bash script. This strategy was popular with the system admins responsible for deploying webservers like Apache, as these scripting languages and command-line programs were familiar tools. While CGI scripts can be used to build dynamic web pages, by far their most common use was to consume forms filled out by a user, often saving the results to a file or database or sending them via email.</p><p>CGI scripts are still used today, but they do have some important limitations. First, for each kind of request that needed handled, a new script would need to be written. The open-ended nature of CGI scripts meant that over time a web application become a patchwork of programs developed by different developers, often using different languages and organizational strategies. And since running a CGI script typically means starting a separate OS process <em>for each request</em>, the CGI approach does not scale well to web applications in high demand.</p><p>Thus, web developers began seeking new strategies for building cohesive web servers to provide rich dynamic experiences.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>Your personal web space on the CS Departmental Server supports CGI scripts. So if you would like to try to develop one, you can deploy it there. More details can be found on the support <a href=https://support.cs.ksu.edu/CISDocs/wiki/Personal_Web_Pages#Dynamic_Content rel=external target=_blank>Personal Web Pages</a> entry.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=server-pages>Server Pages</h1><p>The CGI scripting approach eventually evolved into a concept known as server pages and embodied in the technologies of PHP and Microsoft’s Active Server Pages (ASP), as well as Java Server Pages, and many other less-well-known technologies. While each of these use different scripting languages, the basic idea is the same: Take a traditional static webserver functionality, and couple it with a script interpreter. When most files are requested from the server, the file is served using the same techniques we used in the last chapter. But when a script file understood by our augmented server is requested, the script file is executed, and its output is sent as the response.</p><p>This may sound a lot like the CGI Scripts we discussed before, and it certainly is, except for two major innovations. The first of these was that the same interpreter, and therefore OS process, could be used for all requests. As server hardware adopted multiple CPUs and multi-core CPUs, additional interpreter processes were added, allowing incoming requests to be responded to concurrently on separate processors.</p><h3 id=embedded-scripts>Embedded Scripts</h3><p>The second big innovation innovation was the idea of embedding script <em>directly in HTML code</em>. When the server page is interpreted, the embedded scripts would execute, and their output would be concatenated directly into the HTML that was being served.</p><p>For example, a PHP page might look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;!</span><span class=nx>DOCTYPE</span> <span class=nx>html</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>html</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=nx>head</span><span class=o>&gt;&lt;</span><span class=nx>title</span><span class=o>&gt;</span><span class=nx>PHP</span> <span class=nx>Example</span><span class=o>&lt;/</span><span class=nx>title</span><span class=o>&gt;&lt;/</span><span class=nx>head</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=o>&lt;</span><span class=nx>body</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;</span><span class=nx>h1</span><span class=o>&gt;</span><span class=nx>A</span> <span class=nx>PHP</span> <span class=nx>Example</span><span class=o>&lt;/</span><span class=nx>h1</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>      <span class=k>echo</span> <span class=nx>date</span><span class=p>(</span><span class=s1>&#39;D, d M Y H:i:s&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=cp>?&gt;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>  &lt;/body&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;/html&gt;
</span></span></span></code></pre></div><p>Notice everything except the <code>&lt;?php ... ?></code> is perfectly standard HTML. But when served by an <a href=https://httpd.apache.org/ rel=external target=_blank>Apache server</a> with <a href=https://cwiki.apache.org/confluence/display/HTTPD/php rel=external target=_blank>mod_php</a> installed, the code within <code>&lt;?php ... ?></code> would be executed, and its output concatenated into the HTML that would then be served (the <code>echo</code> function prints output, and <code>date()</code> creates the current time in the specified format).</p><p>Similarly, an ASP page doing the same task would look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;&lt;</span><span class=nt>title</span><span class=p>&gt;</span>ASP Example<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>An ASP Example<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=err>&lt;</span>%
</span></span><span class=line><span class=cl>      Response.Write Now()
</span></span><span class=line><span class=cl>    %&gt;
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div><p>These files would typically be saved with a special extension that the server would recognize, i.e. <em>.php</em> for PHP files, and <em>.asp</em> for ASP files. Allowing scripts to be directly embedded within HTML made web development with these tools far faster, and as IDEs were adapted to support syntax highlighting, code completion, and other assistive features with these file types also helped prevent syntax errors in both the HTML and script code.</p><p>Active Server Pages and PHP remain commonly used technologies today, and a large portion of legacy websites built using them are still in service. In fact, your personal web space on the CS department server is running in an Apache server set up to interpret PHP files - you could add a PHP script like the one above and and it would execute when you visited the page. You can visit the support <a href=https://support.cs.ksu.edu/CISDocs/wiki/Personal_Web_Pages#Dynamic_Content rel=external target=_blank>Personal Web Pages</a> entry for details on doing so.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=custom-servers>Custom Servers</h1><p>While CGI Scripts and Server Pages offered ways to build dynamic websites using off-the shelf web server technologies (Apache, IIS), many programmers found these approaches limiting. Instead, they sought to build the entire web server as a custom program.</p><p>Node was actually developed for exactly this approach - it provides abstractions around the fundamental aspects of HTTP in its <a href=https://nodejs.org/api/http.html rel=external target=_blank>http</a> library. This library handles the listening for HTTP requests, and parses the request and uses it to populate a <a href=https://nodejs.org/api/http.html#http_class_http_clientrequest rel=external target=_blank>http.ClientRequest object</a> and provides a <a href=https://nodejs.org/api/http.html#http_class_http_serverresponse rel=external target=_blank>http.ServerResponse object</a> to prepare and send the response. These are abstractions around the HTTP Request and Response we discussed in chapter 2.</p><p>The authors of Node took advantage of the functional nature of JavaScript to make writing servers easy - we just need to provide a function to the server that takes a request/response pair. This has been our <code>handleRequest()</code> method, and we can pack it with custom logic to determine the correct <em>response</em> for the incoming <em>request</em>.</p><p>We&rsquo;ve already written a number of functions that take in a request and response object, and determine the correct response to send. This includes our <code>serveFile()</code>, and our <code>listDirectory()</code>. We can create dynamic pages in much the same way - by writing a custom function to serve the dynamic page.</p><p>For example, a very simple dynamic page could be created with this function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>serveTime</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>html</span> <span class=o>=</span> <span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>        &lt;!doctype html&gt;
</span></span></span><span class=line><span class=cl><span class=sb>        &lt;html&gt;
</span></span></span><span class=line><span class=cl><span class=sb>          &lt;head&gt;
</span></span></span><span class=line><span class=cl><span class=sb>            &lt;title&gt;Server Time&lt;/title&gt;
</span></span></span><span class=line><span class=cl><span class=sb>          &lt;/head&gt;
</span></span></span><span class=line><span class=cl><span class=sb>          &lt;body&gt;
</span></span></span><span class=line><span class=cl><span class=sb>            &lt;h1&gt;Time on the server is </span><span class=si>${</span><span class=k>new</span> <span class=nb>Date</span><span class=p>()</span><span class=si>}</span><span class=sb>&lt;/h1&gt;
</span></span></span><span class=line><span class=cl><span class=sb>          &lt;/body&gt;
</span></span></span><span class=line><span class=cl><span class=sb>        &lt;/html&gt;
</span></span></span><span class=line><span class=cl><span class=sb>    `</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>req</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span> <span class=s2>&#34;text/html&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Content-Length&#34;</span><span class=o>:</span> <span class=nx>html</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>    <span class=p>}).</span><span class=nx>end</span><span class=p>(</span><span class=nx>html</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>But for a server to be <em>dynamic</em>, we typically want more than just the ability to render a page from code. We <em>also</em> want to interact with the user in some meaningful way - and that means receiving data <em>from</em> them. In the HTTP protocol there are several ways for the user to send data:</p><ol><li><p>By the path of the request, i.e. when we request <code>https://support.cs.ksu.edu/CISDocs/wiki/Main_Page</code> the path <code>CISDocs/wiki/Main_Page</code> indicates the page we are requesting</p></li><li><p>By additional information contained in the URL, specifically the <em>query string</em> (the part of the URL that follows the <code>?</code>) and the <em>hash string</em> (the part of hte URL that follows the <code>#</code>)</p></li><li><p>By information contained in the <em>body</em> of the request</p></li></ol><p>We&rsquo;ve already looked at the path portion of the URL in describing how we can implement a file server to serve files and directories. But what about the query string and body of the request? Let&rsquo;s look at how those are handled in Node next.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=query-and-hash-strings>Query and Hash Strings</h1><p>Query strings (aka search strings) are the part of the URL that appear after the <code>?</code> and before the optional <code>#</code>. The hash string is the portion of the url after the <code>#</code>. We&rsquo;ve mentioned them a bit before, but as we dig into dynamic web servers it makes sense to do a deeper dive, as this is where they really come into play.</p><h2 id=the-hash-string>The Hash String</h2><p>First, let&rsquo;s briefly visit the hash string. It&rsquo;s traditional use is to indicate a HTML element on the page the browser should scroll to when visiting the URL. When used this way, its value is the <code>id</code> attribute of the element. The browser will automatically scroll to a position that displays the element on-screen. Thus, the traditional use of the hash string is for &ldquo;bookmarked&rdquo; links that take you to an exact section of the page, like this one which takes you to a description of your personal CS web space: <a href=https://support.cs.ksu.edu/CISDocs/wiki/Personal_Web_Pages#Dynamic_Content rel=external target=_blank>https://support.cs.ksu.edu/CISDocs/wiki/Personal_Web_Pages#Dynamic_Content</a>.</p><p>With the advent of single-page apps, it has come to serve additional purposes; but we&rsquo;ll talk about those when we visit that topic in a future chapter.</p><h2 id=the-querysearch-string>The Query/Search String</h2><p>Now, the query string is a vital tool for dynamic web pages, as it conveys information <em>beyond</em> the specific resource being asked for to the server. Consider what a dynamic webserver does - it takes an incoming request, and sends a response. In many ways, this is similar to a function call - you invoke a function, and it returns a value. With this in mind, the path of the URL is like the function name, and the query string becomes its <em>parameters</em>.</p><p>Much like parameters have a name and a value, the query string is composed of key/value pairs. Between the key and value of each pair is a <code>=</code>, and between the pairs is a <code>&</code>. Because the <code>=</code> and <code>&</code> character now have a special meaning, any that appear in the key or value are swapped with a special percent value, i.e. <code>&</code> becomes <code>%26</code> and <code>=</code> becomes <code>%3D</code>. Similarly, other characters that have special meanings in URLs are likewise swapped. This is known as URL or percent encoding, and you can see the swapped values in the table below:</p><table class=standard-table><tbody><tr><td><code>':'</code></td><td><code>'/'</code></td><td><code>'?'</code></td><td><code>'#'</code></td><td><code>'['</code></td><td><code>']'</code></td><td><code>'@'</code></td><td><code>'!'</code></td><td><code>'$'</code></td><td><code>'&'</code></td><td><code>"'"</code></td><td><code>'('</code></td><td><code>')'</code></td><td><code>'*'</code></td><td><code>'+'</code></td><td><code>','</code></td><td><code>';'</code></td><td><code>'='</code></td><td><code>'%'</code></td><td><code>' '</code></td></tr><tr><td><code>%3A</code></td><td><code>%2F</code></td><td><code>%3F</code></td><td><code>%23</code></td><td><code>%5B</code></td><td><code>%5D</code></td><td><code>%40</code></td><td><code>%21</code></td><td><code>%24</code></td><td><code>%26</code></td><td><code>%27</code></td><td><code>%28</code></td><td><code>%29</code></td><td><code>%2A</code></td><td><code>%2B</code></td><td><code>%2C</code></td><td><code>%3B</code></td><td><code>%3D</code></td><td><code>%25</code></td><td><code>%20</code> or <code>+</code></td></tr></tbody></table><p>In JavaScript, the <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent rel=external target=_blank>encodeURIComponent()</a> function can be used to apply percent encoding to a string, and the <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/decodeURIComponent rel=external target=_blank>decodeURIComponent()</a> can be used to reverse it.</p><p>Node offers the <a href=https://nodejs.org/api/querystring.html rel=external target=_blank>querystring</a> library. It offers a <a href=https://nodejs.org/api/querystring.html#querystring_querystring_parse_str_sep_eq_options rel=external target=_blank>querystring.parse()</a> method which can parse a query string into a JavaScript object with the decoded key/value pairs transformed into properties and a <a href=https://nodejs.org/api/querystring.html#querystring_querystring_stringify_obj_sep_eq_options rel=external target=_blank>querystring.stringify()</a> method which can convert a JavaScript object into an encoded query string. In addition, these methods allow you to override what characters are used as delimiters, potentially allowing you to use alternative encoding schemes.</p><h2 id=forms-and-the-query-string>Forms and the Query String</h2><p>While we can type a URL with a query string manually, by far the most common way to produce a query string is with a <code>&lt;form></code> element. When a form is submitted (the user clicks on a <code>&lt;input></code> with <code>type</code> attribute of <code>"submit"</code>), it is serialized and submitted to the server. By default, it will be sent to the same URL it was served from, using a GET request, with the fields of the form serialized as the query string.</p><p>This is why one name for the query string is the <em>search</em> string, as it is commonly used to submit search requests. For example, Google&rsquo;s search page contains a form similar to this (very simplified form):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;q&#34;</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;Google Search&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span></span></span></code></pre></div><p>Notice the form has one text input, named <code>"q"</code>. If we type in search terms, say &ldquo;k-state computer science&rdquo; and click the search button, you&rsquo;ll notice in the resulting url the query string contains <code>q=k-state+computer+science</code> (plus a lot of other key/value pairs). If you type <code>"https://www.google.com/search?q=k-state+computer+science"</code> into the address bar, you&rsquo;ll get the same page.</p><p>Notice though, that google uses <code>www.google.com/search</code> as the URL to display search results at, instead of the original <code>www.google.com</code> page. We can have a form submit to a different URL than it was served on by setting its <code>action</code> attribute to that URL.</p><p>We can also change the HTTP method used to submit the form with the <code>method</code> attribute. By default it uses a GET request, but we can instead set it to a POST request. When a POST request is used, the form is no longer encoded in the query string - it is instead sent as the body of the POST request.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=form-encoding>Form Encoding</h1><p>When a form is submitted as a POST request, its inputs are serialized according to the form&rsquo;s encoding strategy. This value is also used as the <code>Content-Type</code> header of the request. The three form encoding values are:</p><ul><li><code>application/x-www-form-urlencoded</code> (the default)</li><li><code>multipart/form-data</code> (used for file uploads)</li><li><code>text/plain</code> (used for debugging)</li></ul><p>The <code>&lt;form></code> element&rsquo;s <code>enctype</code> attribute can be set to any of these three possible values.</p><h2 id=applicationx-www-form-urlencoded>application/x-www-form-urlencoded</h2><p>This serialization format consists of key/value pairs where the keys and values are url (percent) encoded, and between each key and value is a <code>=</code> and between each pair is a <code>&</code>. In other words, it is the same encoding that is used in the query string - the only difference is the query string begins with a <code>?</code>.</p><p>Thus, the form:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>method</span><span class=o>=</span><span class=s>&#34;post&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;first&#34;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;Your first name&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;middle&#34;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;Your middle initials&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;last&#34;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;Your last name&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;number&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;age&#34;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;Your age&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;Save My Info&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span></span></span></code></pre></div><p>When submitted by John Jacob Jingleheimer Schmidt would be encoded:</p><div class=highlight><pre tabindex=0><code>first=John&amp;middle=J.+J.&amp;last=Schmidt&amp;age=30</code></pre></div><p>If we parsed this string with <a href=https://nodejs.org/api/querystring.html#querystring_querystring_parse_str_sep_eq_options rel=external target=_blank>querystring.parse()</a> the resulting JavaScript object would be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>first</span><span class=o>:</span> <span class=s2>&#34;John&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>middle</span><span class=o>:</span> <span class=s2>&#34;J. J.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>last</span><span class=o>:</span> <span class=s2>&#34;Schmidt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>age</span><span class=o>:</span> <span class=s2>&#34;30&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>It is important to note that even though age started as a numerical value, it becomes a string in the conversion process. <strong>All values submitted in a form will be interpreted as strings on the server.</strong> If we need it to be a number again, we can always use <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/parseInt rel=external target=_blank>parseInt()</a> on it.</p></div></div><h2 id=multipartform-data>multipart/form-data</h2><p>There is one limitation to the <code>application/x-www-form-urlencoded</code> encoding strategy - there is no way to include binary data, i.e. files. If you submit a form that includes an <code>&lt;input></code> of type <code>file</code> and encode it with <code>application/x-www-form-urlencoded</code>, the value supplied by the <code>&lt;input type="file"></code> will be the filename only. The actual body of the file will not be available. The reason is simple - there&rsquo;s no easy way to put raw binary data into a text file.</p><p>The <code>multipart/form-data</code> solves this in a less-than easy way. It splits the body into blocks - one for each input. Between each block is a sequence of bytes used as a separator. These boundary bytes cannot be found in any of the file data (as if it were, that block would be split up). And each block has its own header section and body section. The header defines what the input is, and what its body contains. If it was a non-file input, it will be text, and if it was a file input, the content will be the raw bytes, encoded in base64.</p><p>When the server receives this body, it must use the boundary bytes to separate the blocks, and then parse each block. There are no built-in libraries in Node for doing this, though there are many npm packages that do. We&rsquo;ll also write our own from scratch so that we get a good feel for it.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=request-body>Request Body</h1><p>While many HTTP libraries will process the entire incoming request before passing control to the program, Node&rsquo;s <code>http</code> module takes a different approach. It constructs and passes the <code>http.IncomingMessage</code> and <code>http.ServerResponse</code> objects as soon as it has received the header portion of the request. This means the body may still be being transmitted to the server as you start to process the request.</p><p>This is fine for GET requests, as they don&rsquo;t have a body. But for requests that <em>do</em> have a body, it means you have to process the incoming data yourself.</p><p>To do so, there are three events made available in the <a href=https://nodejs.org/api/http.html#http_class_http_incomingmessage rel=external target=_blank>http.IncomingMessage</a> object: <code>data</code>, <code>end</code>, and <code>error</code>.</p><p>The <code>data</code> event occurs whenever a new chunk of the body is available, and that chunk is passed to the event listener. The <code>end</code> event occurs once all the chunks have been received. And the <code>error</code> event occurs when something goes wrong. The chunks are <a href=https://nodejs.org/api/buffer.html rel=external target=_blank>Buffer</a> objects, and are always received in order.</p><p>Thus, we need to collect each chunk from each <code>data</code> event, and join them together into a single buffer at the <code>end</code> event. Thus, the basic scaffold for doing so is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>loadBody</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>chunks</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// listen for data events
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>req</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>chunk</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>chunks</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>chunk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// listen for the end event 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>req</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;end&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Combine the chunks 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>Buffer</span><span class=p>.</span><span class=nx>concat</span><span class=p>(</span><span class=nx>chunks</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// DO SOMETHING WITH DATA
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// listen for error events 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>req</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// RESPOND APPROPRIATELY TO ERROR
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Note that these events occur asynchronously, so this scaffold needs to be integrated into an appropriate asynchronous processing strategy.</p><p>You might wonder why the developers of Node chose to handle request bodies in this fashion. Most likely, it was for the degree of control it offers the programmer. Consider the case where you decide your program needs to be able to stop an upload - you can do so with <a href=https://nodejs.org/api/http.html#http_class_http_incomingmessage rel=external target=_blank>http.IncomingMessage.destroy()</a>, which immediately closes the socket connecting the client to the server, effectively terminating the upload.</p><p>This can prevent the server from doing unneeded work and consuming unnecessary bandwidth. Of course, the decision to stop an upload is highly situationally dependent - thus they leave it in your hands as the programmer.</p><p>In fact, a common Denial of Service attack known as an HTTP flood often takes advantage of POST requests to submit requests with large bodies to consume server resources. By giving the programmer the ability to stop uploads this way helps counter this kind of attack.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cookies>Cookies</h1><p>HTML was designed as a <em>stateless</em> protocol. This means that there is no expectation for the server to keep track of prior requests made to it. Each incoming HTTP request is effectively treated as if it is the <em>first</em> request ever made to the server.</p><p>This was an important consideration for making the web possible. Consider what would happen if our server needed to keep track of what every visitor did on the site - especially when you have <em>thousands</em> of unique visitors every second? You would need a lot of memory, and a mechanism to tell which user is which. That&rsquo;s a lot of extra requirements to getting a web server working.</p><p>But at the same time, you probably recognize that many of the websites you use every day <em>must be doing just that</em>. If you use Office 365 or Google Docs, they manage to store your documents, and not serve you someone else&rsquo;s when you log in. When you visit an online store and place products in your shopping basket, they remain there as you navigate around the site, loading new pages. So how are these websites providing state?</p><p>The answer that was adopted as a W3C standard - <a href=https://tools.ietf.org/html/rfc6265 rel=external target=_blank>RFC 2695</a> is <em>cookies</em>. Cookies are nothing more than text that is sent along with HTTP Requests and Responses. A server can ask a client to store a cookie with a <code>Set-Cookie</code> header. From that point on, any request the client makes of that server will include a <code>Cookie</code> header with the cookie information.</p><p>It&rsquo;s kind of like if your forgetful teacher gives you a note to show him the next time you come to office hours, to help remind him of what you talked about previously. This way, the server doesn&rsquo;t have to track state for any visitor - it can ask the visitor&rsquo;s client (their browser) to do it for them.</p><h2 id=what-is-a-cookie>What is a Cookie?</h2><p>Let&rsquo;s dig deeper into this idea and implementation of cookies.</p><p>Much like a web request or response, a cookie is nothing more than a stream of data. It gets passed between client and server through their headers. Specifically, the <code>Set-Cookie</code> header sends the cookie to the client, and the client will automatically return it in subsequent requests using the <code>Cookie</code> header.</p><p>Say we want to establish a session id, (SID), for every unique visitor to our site. We would have our server send the SID in a <code>Set-Cookie</code> header:</p><p><code>Set-Cookie: SID=234</code></p><p>The browser would store this value, and on subsequent requests <em>to the same domain</em>, include a corresponding <code>Cookie</code> header:</p><p><code>Cookie: SID=234</code></p><p>Unless the <code>Domain</code> cookie attribute is specified (see below), a cookie is only sent to the domain that it originated from. It will not be sent to subdomains, i.e. a cookie that came from <code>ksu.edu</code> will not be sent to the server with hostname <code>cs.ksu.edu</code>.</p><h3 id=structure-of-a-cookie>Structure of a Cookie</h3><p>As you might have guessed from the example, the string of a cookie is a set of key/value pairs using the equals sign (<code>=</code>) to assign the value to the key. But we can also include multiple cookie pairs using a semicolon (<code>;</code>) to separate the cookie pairs, i.e.:</p><p><code>Set-Cookie: SID=234; lang=en-US</code></p><p>Both cookie pairs are sent back in a <code>Cookie</code> header:</p><p><code>Cookie: SID=234; lang=en-US</code></p><p>We can chain multiple pairs of cookie pairs. After the last cookie pair, we need another semicolon, then any cookie attributes, also separated by semicolons. For example:</p><p><code>Set-Cookie: SID=234; lang=en-US; EXPIRES=Wed, 04 April 2019 011:30:00 CST</code></p><p>adds a cookie attribute specifying an expiration date for the cookie. The legal cookie attributes are laid out in <a href=https://tools.ietf.org/html/rfc6265 rel=external target=_blank>RFC6265</a>, but we&rsquo;ll reprint them here.</p><h4 id=cookie-attributes>Cookie Attributes</h4><p>There are a limited number of defined cookie attributes, and each changes the nature of the cookie and how a browser will work with it in an important way. Let&rsquo;s examine each in turn:</p><p><strong>Expires</strong> As you might expect, this sets an expiration date for the cookie. After the date, the browser will throw away the cookie, removing it from its internal cache. It will also stop sending the cookie with requests. If you need to erase a value in a cookie you&rsquo;ve already sent to a user, you can respond to their next request with a new <code>Set-Cookie</code> header with the <code>Expires</code> value set in the past. To avoid issues with time zones, the date supplied must conform to the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Date rel=external target=_blank>HTTP-Date</a> format set out in <a href=https://tools.ietf.org/html/rfc1123 rel=external target=_blank>RFC1123</a>.</p><p><strong>Max-Age</strong> The <code>Max-Age</code> also sets an expiration date, but in terms of a number of seconds from the current time. A value of 0 or less (negative) will remove the cookie from the browser&rsquo;s cache, and stop sending the cookie in future requests. IE 7, 8, and 9 do not support the <code>Max-Age</code> attribute; for all other browsers, <code>Max-Age</code> will take precedence over <code>Expires</code>.</p><p><strong>Domain</strong> As described above, cookies are by default sent only to the domain from which they originated, and no subdomains. If the domain is explicitly set with the <code>Domain</code> attribute, subdomains are included.</p><p><strong>Path</strong> The value of this attribute further limits what requests a cookie will be sent to. If the <code>Path</code> is specified, only requests whose url matches the value will be sent. This does include subpaths, i.e. <code>Path=/documents</code> will match the urls <code>/documents/</code>, <code>/documents/1.doc</code>, and <code>/documents/recent/a.pdf</code>.</p><p><strong>Secure</strong> Cookies including this attribute (it does not need a value) will only be sent by the browser with HTTPS requests, not HTTP requests. Note that sending the cookie over HTTPS does not encrypt the cookie data - as a header, it is sent in the clear for both HTTP and HTTPS.</p><p><strong>HttpOnly</strong> Cookies can normally be accessed by JavaScript on the client, from the <code>Document.cookie</code> property. Setting this attribute (it does not need a value) tells the browser not to make it accessible.</p><p><strong>SameSite (in Draft)</strong> This new cookie attribute is intended to help a server assert that its cookies should not be sent with any cross-site requests originating from this page (i.e. <code>&lt;script></code> tags, <code>&lt;img></code> tags, etc. whose source is a different site, or AJAX requests against other sites). This is intended to help combat cross-site scripting attacks. As you might expect, this is only supported in the newest browser versions.</p><h2 id=cookies-and-security>Cookies and Security</h2><p>As with all web technologies, we need to consider the security implications. Cookies are received and returned by the client - and we know that anything the client is responsible for can be manipulated by an adversarial agent. Let&rsquo;s think through the implications.</p><p>All cookies received by a browser and cached there. How long they are stored depends on the <code>Max-Age</code> and <code>Expires</code> attributes. Browsers are told to delete cookies older than their <code>Max-Age</code>, or whose <code>Expires</code> duration has passed. If neither of these are set, the cookie is considered a <em>session</em> cookie - it is deleted when the browser is closed (this is why you should always close a browser you use on a public computer).</p><p>While session cookies only exist in memory, cookies with expiration dates may be persisted as text files in the browser&rsquo;s data directory. If this is the case, it is a simple matter for a knowledgeable adversary with access to the computer to retrieve them. Also remember access doesn&rsquo;t necessarily mean <em>physical</em> access - malware running on your computer can effectively copy this data as well.</p><p>Moreover, cookies are just text - say for example you add the identity of your user with a cookie <code>Set-Cookie: user-id=735</code>. An adversary could sign up for a legitimate account with your application, and then manipulate their cookie to return <code>Cookie: user-id:1</code>. Since user ids are often incrementally generated primary keys in a database, it&rsquo;s a good assumption that one or two low-numbered ones will belong to administrator accounts - and this adversary has just impersonated one!</p><p>So if we need cookies to add state to our web applications, but cookies (and therefore that state) are subject to interception and manipulation - how can we protect our users and our site?</p><h2 id=strategies-for-making-cookies-safeer>Strategies for Making Cookies Safe(er)</h2><p>Some common strategies are:</p><ul><li>Use HTTPS</li><li>Store as little information in a cookie as possible</li><li>Encrypt the cookie&rsquo;s values</li><li>Sign the cookie</li><li>Use Short Lifespans</li></ul><h3 id=use-https>Use HTTPS</h3><p>Using Secure HTTP helps prevent cookies from being intercepted during transit, as the request body and headers are encrypted before they move across the transport layer of the Internet. This does not protect cookies once they arrive at a user&rsquo;s computer, however. Still, it is a great first step.</p><h3 id=storing-as-little-in-the-cookie-as-possible>Storing as Little in the Cookie as Possible</h3><p>A good general strategy is to store as little of importance in the cookie as possible. This also helps keep the size of a site&rsquo;s cookies down, which means less traffic across the network, and less to store on a user&rsquo;s computer. The RFC suggests browsers support a minimum size of 4096 bytes per cookie - but this is not a requirement.</p><p>But where do we store the session information, if not in the cookie? This is the subject of the next section, <a href=https://textbooks.cs.ksu.edu/cis526/06-dynamic-web-servers/09-sessions/ rel=external target=_blank>https://textbooks.cs.ksu.edu/cis526/06-dynamic-web-servers/09-sessions/</a>. This strategy usually entails storing nothing more than a session identifier in the cookie, and storing the actual data that corresponds to that session identifier on the server. Effectively, we make our server <em>statefull</em> instead of <em>stateless</em>.</p><h3 id=encrypting-cookie-values>Encrypting Cookie Values</h3><p>Another common strategy is encrypting the value of a cookie using a reversible encryption algorithm before sending it to the client. This kind of encryption technique is a mathematical function that can easily be reversed, provided you know the key used during the encryption process. This key should be stored in the server and never shared, only used internally to encrypt outgoing cookies and decrypt incoming ones.</p><p>This strategy only works if you don&rsquo;t need to know the cookie&rsquo;s value on the client (as the client will not have the key). Also, be wary of sending any details of the encryption with the encrypted data - anything that helps identify the encryption strategy or provides information like initialization vectors can help an adversary break the encryption. Also, check what algorithms are considered strong enough by current standards; this is always a moving target.</p><h3 id=signing-cookie-values>Signing Cookie Values</h3><p>A third common technique is signing the cookie with a hash. A hash is the result of a one-way cryptographic function - it is easy to perform but very difficult to reverse. How it works is you hash the value of the cookie, and then send both the original data&rsquo;s value and the hashed value as cookies. When you receive the cookie back from the client, you re-hash the value found in the cookie, and compare it to the hashed value in the cookie. If the two values are different, then the cookie has been modified.</p><h3 id=use-short-lifespans>Use Short Lifespans</h3><p>The above strategies only keep adversaries from modifying cookies. There is still the danger of valid cookies being captured and used by an adversary - a technique known as <a href=https://en.wikipedia.org/wiki/Session_hijacking rel=external target=_blank>session hijacking</a>. Using HTTPS can prevent session hijacking from within the network, but will not protect against cookies lifted from the client&rsquo;s computer.</p><p>Making sessions expire quickly can help mitigate some of the risk, especially when the adversary is using physical access to the computer to retrieve cookies - you wouldn&rsquo;t expect them to do this while the user is still using the computer.</p><p>But non-physical access (such as a compromised computer) can lift a cookie while it is in use. Regenerating a session identifier (assuming you are using the first strategy) on each login can help, especially if you prompt users to log in before allowing especially risky actions. Adding some additional tracking information like the originating IP address to the session and prompting the user to validate a session by logging back in when this changes can also help.</p><p>Be aware that these strategies can also be very frustrating for users who are prompted to sign in repeatedly. As always, you need to balance security concerns with user satisfaction for the kind of activities your application supports.</p><h3 id=combinations-of-the-above>Combinations of the Above</h3><p>Clearly these strategies can be used in combination, and doing so will provide a better degree of safety for your clients. But the can also increase computation time, network traffic, and user frustration within your web application. Deciding just how much security your application needs is an important part of the design process.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=sessions>Sessions</h1><p>If HTTP is stateless, how do e-commerce websites manage to keep track of the contents of your shopping cart as you navigate from page to page? The answer is the use of a <em>session</em> - a technique by which state is added to a web application.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>The term <strong>session</strong> appears a <em>lot</em> in web development, and can mean different things in different contexts. But there is a common thread in each - a session is a form of connection between the client and server.</p><p>For example, when your web client make a request from a web server, it opens a Transmission Control Protocol (TCP) session to the server, and sends the HTTP request across this connection. The session stays open until all the packets of the request are sent, and those of the response are received. In HTTP 1.1, the session can stay open for more than a single request-response pair, as it is anticipated a HTML page request will be followed by requests for resources (CSS, JavaScript, images, etc.) embedded in the page. HTTP 2.0 takes this farther, allowing the server to <em>push</em> these additional resources to the client.</p><p>The sessions we are discussing here are implemented at a higher level than TCP sessions (though they are hosted by the TCP session), and represent a single website visitor interacting with the server.</p></div></div><p>A session therefore provides a mechanism for storing information between requests, and must be unique to a specific user. All session techniques begin with a cookie, so you should be familiar with that concept.</p><p>There are three basic session techniques you will likely encounter in web development. Let&rsquo;s take a look at each.</p><h2 id=cookie-session>Cookie Session</h2><p>In a cookie session, the session information is completely stored within the cookie. This has the benefit that no state information needs to be stored on the server, and it is easy to implement.</p><p>There are several downsides to the cookie session. The first is that it comes with a limited amount of reliable storage (the standard suggests that browsers support a minimum cookie size of 4096 bytes per cookie, but there is no hard requirement). Second, cookies are somewhat vulnerable, as they can be intercepted in-transit, and they can also be recovered from a browser&rsquo;s cookie storage by a knowledgeable adversary.</p><h2 id=in-memory-cookies>In-Memory Cookies</h2><p>A second approach is to store the session data on the server using some form of memory cache. A straightforward implementation for a Node server would be to use an object, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>sessions</span> <span class=o>=</span> <span class=p>{}</span></span></span></code></pre></div><p>Each time a new visitor comes to the website, a unique ID is generated, and used as the the key for their session, and sent to the client as a cookie, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>sessionID</span> <span class=o>=</span> <span class=p>[</span><span class=nx>some</span> <span class=nx>unique</span> <span class=nx>id</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nx>res</span><span class=p>.</span><span class=nx>setHeader</span><span class=p>(</span><span class=s2>&#34;Set-Cookie&#34;</span><span class=p>,</span> <span class=sb>`session-id=</span><span class=si>${</span><span class=nx>sessionID</span><span class=si>}</span><span class=sb>; lang=en-US`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>sessions</span><span class=p>[</span><span class=nx>sessionID</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// session data here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div><p>On subsequent requests, the cookie can be retrieved from the request and used to retrieve the session data:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>cookie</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s2>&#34;cookie&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>sessionID</span> <span class=o>=</span> <span class=sr>/session-id=([^;])/</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=nx>cookie</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>session</span> <span class=o>=</span> <span class=nx>sessions</span><span class=p>[</span><span class=nx>sessionID</span><span class=p>];</span></span></span></code></pre></div><p>Because the session data is never sent in its raw form to the client, it is more secure. However, the session can still be hijacked by a malicious user who copies the cookie or guesses a valid session id. To counter this, all requests should be updated to use secure protocol (https) and the cookie should be encrypted.</p><p>Also, in-memory sessions are lost when the server reboots (as they are held in volatile memory). They should also be cleaned out periodically, as each session consumes working memory, and if a session is more than an hour old it probably will not be used again.</p><h2 id=database-sessions>Database Sessions</h2><p>When a website is backed by a database (as we&rsquo;ll cover <a href=https://textbooks.cs.ksu.edu/cis526/07-persistent-storage/03-databases/ rel=external target=_blank>soon</a>), storing the session in that database becomes an option. Functionally, it is similar to an In-Memory session, except that the database becomes the storage mechanism. Because the database offers persistent storage, the session also could be persistent (i.e. you remain &ldquo;logged on&rdquo; every time you visit from the same computer). Still, database sessions typically are cleaned out periodically to keep the sessions table from growing overlarge.</p><p>Database sessions are a good choice if your website is already using a database. For a website with registered users, the session id can be the user&rsquo;s id, as defined in the database schema.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=template-rendering>Template Rendering</h1><p>While skilled programmers may have chafed at the restrictions imposed by server pages, there was one aspect that came to be greatly valued - the ability to embed script directly in HTML, and have it evaluated and concatenated into the HTML text.</p><h2 id=template-libraries>Template Libraries</h2><p>This is where template libraries come in. A template library allows you to write your HTML content <em>as HTML in a separate file</em> with a special syntax to inject dynamic programming script. This is often some variation of <code>&lt;></code> or <code>{}</code>. This approach allows you to validate the HTML, as the script portions are ignored as unknown tags (when using <code>&lt;></code>) or as static text.</p><p>When the server is running, these templates are rendered, evaluating any code and supplying the applicable variables. This process generates the HTML snippet.</p><p>This is similar to what server pages do. However, server pages represent an <em>integrated</em> approach - the server page framework defined all aspects of how you could interact with the OS, the web server, and other programs. In contrast, a template library provides the option of using templates within any project - obviously for generating HTML as part of a dynamic website, but potentially for other kinds of applications as well.</p><p>Thus, a template rendering library gives us a lot of flexibility in how and when we use it. For example, in using the <a href=https://ejs.co/ rel=external target=_blank>Embedded JavaScript</a> template library, we could rewrite our directory listing as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!doctype html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Directory Listing<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>h2</span><span class=p>&gt;</span>Directory Listing for <span class=err>&lt;</span>%= pathname %&gt;<span class=p>&lt;/</span><span class=nt>h2</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;display: flex; flex-direction: column; padding: 2rem 0&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% entries.forEach((entry) =&gt;{ %&gt;
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;&lt;%= path.posix.join(pathname, entry) %&gt;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=err>&lt;</span>%= entry %&gt;
</span></span><span class=line><span class=cl>            <span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% }) %&gt;
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% if (pathname !== &#34;/&#34;) { %&gt;
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;&lt;%= path.dirname(pathname) %&gt;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                Parent directory
</span></span><span class=line><span class=cl>            <span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% } %&gt;
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div><p>Notice how we can embed the JavaScript <em>directly into the file</em>. In a Node server, we can use this template to render html:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Build the dynamic HTML snippets
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pathname</span><span class=o>:</span> <span class=nx>pathname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>entries</span><span class=o>:</span> <span class=nx>entries</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>path</span><span class=o>:</span> <span class=nx>path</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=nx>ejs</span><span class=p>.</span><span class=nx>renderFile</span><span class=p>(</span><span class=s2>&#34;templates/directory-listing.ejs&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>html</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=c1>// TODO: render the HTML in the string variable html
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span></span></span></code></pre></div><p>While this may <em>seem</em> like just as much work as the concatenation approach, where it really shines is the ability to combine multiple templates, separating parts of the pages out into different, reusable template files. These are typically separated into two categories based on how they are used, <em>partials</em> and <em>layouts</em>.</p><h3 id=partials>Partials</h3><p>A partial is simply a <em>part</em> of a larger page. For example, the entries we are rendering in the listing could be defined in their own template file, <em>directory-listing-entry.ejs</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;&lt;%= path %&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=err>&lt;</span>%= entry %&gt;
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span></span></span></code></pre></div><p>And then <em>included</em> in the <em>directory-listing.ejs</em> template:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!doctype html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Directory Listing<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>h2</span><span class=p>&gt;</span>Directory Listing for <span class=err>&lt;</span>%= pathname %&gt;<span class=p>&lt;/</span><span class=nt>h2</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;display: flex; flex-direction: column; padding: 2rem 0&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% entries.forEach((entry) =&gt;{ %&gt;
</span></span><span class=line><span class=cl>            <span class=err>&lt;</span>%- include(&#39;directory-listing-entry&#39; {entry: entry, path: path.posix.join(pathname, entry) }) %&gt;
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% }) %&gt;
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% if (pathname !== &#34;/&#34;) { %&gt;
</span></span><span class=line><span class=cl>            <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;&lt;%= path.dirname(pathname) %&gt;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>                Parent directory
</span></span><span class=line><span class=cl>            <span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>% } %&gt;
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div><p>While this may seem overkill for this simple example, it works incredibly well for complex objects. It also makes our code far more modular - we can use the same partial in many parts of our web application.</p><h3 id=layouts>Layouts</h3><p>A second common use of templates is to define a <em>layout</em> - the parts that every page holds in common. Consider this template file, <em>layout.ejs</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!doctype html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span><span class=err>&lt;</span>%= title %&gt;<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>%- include(&#39;header&#39;) %&gt;
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>%- content %&gt;
</span></span><span class=line><span class=cl>        <span class=err>&lt;</span>%- include(&#39;footer&#39;) %&gt;
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div><p>Now our directory listing can focus entirely on the directory listing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>h2</span><span class=p>&gt;</span>Directory Listing for <span class=err>&lt;</span>%= pathname %&gt;<span class=p>&lt;/</span><span class=nt>h2</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;display: flex; flex-direction: column; padding: 2rem 0&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=err>&lt;</span>% entries.forEach((entry) =&gt;{ %&gt;
</span></span><span class=line><span class=cl>    <span class=err>&lt;</span>%- include(&#39;directory-listing-entry&#39; {entry: entry, path: path.posix.join(pathname, entry) }) %&gt;
</span></span><span class=line><span class=cl><span class=err>&lt;</span>% }) %&gt;
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=err>&lt;</span>% if (pathname !== &#34;/&#34;) { %&gt;
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;&lt;%= path.dirname(pathname) %&gt;&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        Parent directory
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=err>&lt;</span>% } %&gt;</span></span></code></pre></div><p>And we can render our page using the layout:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Build the dynamic HTML snippets
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pathname</span><span class=o>:</span> <span class=nx>pathname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>entries</span><span class=o>:</span> <span class=nx>entries</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>path</span><span class=o>:</span> <span class=nx>path</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=nx>ejs</span><span class=p>.</span><span class=nx>renderFile</span><span class=p>(</span><span class=s2>&#34;templates/directory-listing.ejs&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>content</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// TODO: handle error
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>ejs</span><span class=p>.</span><span class=nx>renderFile</span><span class=p>(</span><span class=s2>&#34;templates/layout.ejs&#34;</span><span class=p>,</span> <span class=p>{</span><span class=nx>content</span><span class=o>:</span> <span class=nx>content</span><span class=p>},</span> <span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>html</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// TODO: render the HTML in the string variable html
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>This layout can be re-used by all pages within our site, allowing us to write the HTML shared in common by the whole website once.</p><p>Also, while these examples show reading the template files as the response is being generated, most template engines support <em>compiling</em> the templates into a function that can be called at any time. This effectively caches the template, and also speeds up the rendering process dramatically.</p><h3 id=concise-templating-languages>Concise Templating Languages</h3><p>Some template libraries have leveraged the compilation idea to provide a more concise syntax for generating HTML code. For example, the directory listing written using <a href=https://pugjs.org/api/getting-started.html rel=external target=_blank>Pug</a> templates would be:</p><div class=highlight><pre tabindex=0><code class=language-pug data-lang=pug>doctype html
html(lang=&#34;en&#34;)
    head
        title= Directory Listing
    body
        h2= &#39;Directory Listing for &#39; + pathname 
        div(style=&#34;display: flex; flex-direction: column; padding: 2rem 0&#34;)
        each entry in entries
            a(href=/cis526/06-dynamic-web-servers/10-template-rendering/path.posix.join(pathname, entry)) entry 
        if pathname !== &#34;/&#34;
            a(href=/cis526/06-dynamic-web-servers/10-template-rendering/path.dirname(pathname))
                Parent directory</code></pre></div><p>Concise templating languages can significantly reduce the amount of typing involved in creating web pages, but they come with a trade-off. As you can see from the code above, learning Pug effectively requires you to learn a new programming language, including its own iteration and conditional syntax.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>EJS is just one template library available in JavaScript. Some of the most popular ones include:</p><ul><li><a href=https://mustache.github.io/ rel=external target=_blank>Mustache</a></li><li><a href=https://handlebarsjs.com/ rel=external target=_blank>Handlebars</a></li><li><a href=https://mozilla.github.io/nunjucks/ rel=external target=_blank>Nunjucks</a></li><li><a href=http://underscorejs.org/ rel=external target=_blank>Underscore</a></li><li><a href=https://pugjs.org/api/getting-started.html rel=external target=_blank>Pug</a></li></ul><p>It is useful to compare how these different libraries approach templates as there are often large differences, not only in syntax but also in function.</p></div></div><h2 id=components>Components</h2><p>A newer approach, popularized by the <a href=https://reactjs.org/ rel=external target=_blank>React</a> framework, emphasizes building <em>components</em> rather than <em>pages</em>. A component can be thought of as a single control or widget on a page. While conceptually similar to the partials described above, it organizes its structure, styling, and scripting into a cohesive and reuseable whole.</p><p>This represents a move away from the separation of concerns we described earlier. It often incorporates aspects of <a href=https://en.wikipedia.org/wiki/Declarative_programming rel=external target=_blank>declarative programming</a> rather than thinking of programming in terms of control flow. This component-based approach also lends itself to developing <a href=https://en.wikipedia.org/wiki/Progressive_web_application rel=external target=_blank>progressive web applications</a>, which only download the script needed to run the portion of the app the user is interacting with at a given time.</p><p>As this approach is significantly different from the more traditional templating libraries, we&rsquo;ll discuss these ideas in a later chapter.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=script-injection>Script Injection</h1><p>Whenever we render content created by users, we open the door to <em>script injection</em>, a kind of attack where a malicious user adds script tags to the content they are posting. Consider this form:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=s>&#34;post&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>   <span class=p>&lt;</span><span class=nt>label</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;comment&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>textarea</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;comment&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>textarea</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span><span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span></span></span></code></pre></div><p>The intent is to allow the user to post comments on the page. But a malicious user could enter something like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>What an awesome site <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;http://malic.ous/dangerous-script.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div><p>If we concatenate this string directly into the webpage, we will serve the <code>&lt;script></code> tag the user included, which means that <em>dangerous-script.js</em> will run on our page! That means it can potentially access our site&rsquo;s cookies, and make AJAX requests from our site. This script will run on the page for <em>all</em> visitors!</p><p>This attack is known as <a href=https://www.softwaretestinghelp.com/javascript-injection-tutorial/ rel=external target=_blank>script injection</a>, and is something you <strong>MUST</strong> prevent. So how can we prevent it? There are several strategies:</p><ol><li>HTML Escaping</li><li>Block Lists</li><li>Allow Lists</li><li>Markdown or other Markup Languages</li></ol><h3 id=html-escaping>HTML Escaping</h3><p>The simplest is to &ldquo;escape&rdquo; html tags by replacing the <code>&lt;</code> and <code>></code> characters with their html code equivalents, <code>&amp;lt;</code> (less than symbol) and <code>&amp;gt;</code> (greater than symbol). By replacing the opening and closing brackets with the equivalent HTML code, the browser will render the tags as ordinary strings, instead of as HTML. Thus, the above example will render on the page as:</p><blockquote><p>What an awesome site &lt;script src=&ldquo;<a href="http://malic.ous/dangerous-script.js%22></script" rel=external target=_blank>http://malic.ous/dangerous-script.js">&lt;/script</a>></p></blockquote><p>This can be accomplished in JavaScript with the <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replace rel=external target=_blank>String.prototype.replace()</a> method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>sanitizedHtmlString</span> <span class=o>=</span> <span class=nx>htmlString</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/&lt;/g</span><span class=p>,</span> <span class=s1>&#39;&amp;lt;&#39;</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/&gt;/g</span><span class=p>,</span> <span class=s1>&#39;&amp;gt&#39;</span><span class=p>);</span></span></span></code></pre></div><p>The <code>replace()</code> method takes either a regular expression or string to search for - and a string to replace the occurrences with. Here we use regular expressions with the global flag, so that <em>all</em> occurrences will be replaced. We also take advantage of the fact that it returns the modified string to do <a href=https://en.wikipedia.org/wiki/Method_chaining rel=external target=_blank>method chaining</a>, invoking a second <code>replace()</code> call on the string returned from the first call.</p><p>The downside to this approach is that <em>all</em> html in the string is reinterpreted as plain text. This means our comments won&rsquo;t support HTML codes like <code>&lt;b></code> and <code>&lt;i></code>, limiting the ability of users to customize their responses.</p><h3 id=allow-lists>Allow Lists</h3><p>Allow lists (also called &ldquo;whitelists&rdquo;) are a technique to allow only certain tags to be embedded into the page. This approach is more involved, as we must first <em>parse</em> the HTML string the same way a browser would to determine what tags it contains, and then remove any tags that don&rsquo;t appear in our allow list.</p><p>Instead of writing your own code to do this, it is common practice to use a well-maintained and tested open-source library. For example, the NPM package <a href=https://www.npmjs.com/package/sanitize-html rel=external target=_blank>sanitize-html</a> provides this ability.</p><h3 id=block-lists>Block Lists</h3><p>Block lists (also called &ldquo;blacklists&rdquo;) are a similar technique, but rather than specifying a list of <em>allowed</em> tags, you specify a list of <em>disallowed</em> tags. These are then stripped from html strings. This approach is slightly less robust, as new tags are added to the HTML standard will need to be evaluated and potentially added to the block list.</p><h3 id=markdown-or-other-markup-languages>Markdown or other Markup Languages</h3><p>A final option is to have users write their contributions using Markdown or another markup language which is transformed <em>into</em> JavaScript. Markdown (used by GitHub and many other websites) is probably the best-known of these, and provides equivalents to bold, italic, headings, links, and images:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-md data-lang=md><span class=line><span class=cl><span class=gh># This is transformed into a h1 element 
</span></span></span><span class=line><span class=cl><span class=gh></span><span class=gu>## This is transformed into a h2 element
</span></span></span><span class=line><span class=cl><span class=gu></span><span class=k>&gt; </span><span class=ge>This is transformed into a blockquote 
</span></span></span><span class=line><span class=cl><span class=ge></span>_this is italicized_ <span class=ge>*as is this*</span>
</span></span><span class=line><span class=cl><span class=gs>__this is bold__</span> <span class=gs>**as is this**</span>
</span></span><span class=line><span class=cl><span class=k>*</span> this
</span></span><span class=line><span class=cl><span class=k>*</span> is
</span></span><span class=line><span class=cl><span class=k>*</span> an 
</span></span><span class=line><span class=cl><span class=k>*</span> unordered 
</span></span><span class=line><span class=cl><span class=k>*</span> list
</span></span><span class=line><span class=cl><span class=k>1.</span> this
</span></span><span class=line><span class=cl><span class=k>2.</span> is 
</span></span><span class=line><span class=cl><span class=k>3.</span> a 
</span></span><span class=line><span class=cl><span class=k>4.</span> numbered
</span></span><span class=line><span class=cl>5. list</span></span></code></pre></div><p>As it does not have conversions for <code>&lt;script></code> and other dangerous tags, HTML generated from it is relatively &ldquo;safe&rdquo; (it is still necessary to escape HTML in the original markup string though).</p><p>As with allow/block lists, Markdown and the like are usually processed with an outside library, like <a href=https://www.npmjs.com/package/markdown rel=external target=_blank>markdown-js</a>. There are similar libraries for most modern programming languages.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=full-stack-development>Full Stack Development</h1><p>Server pages represented one approach to tackling the dynamic web server challenge, and one that was especially suitable for those web developers who primarily worked with static HTML, CSS, and JavaScript backgrounds.</p><p>For those that were already skilled programmers, the custom server approach provided less confinement and greater control. But it came at a cost - the programmer had to author the entire server. Writing a server from scratch is both a <em>lot</em> of work, and also introduces many more points where design issues can lead to poor performance and vulnerable web apps.</p><p>Thus, a third approach was developed, which leveraged existing and well-suited technologies to handle some aspects of the web app needs. We can separate the needed functionality into three primary areas, each of which is tackled with a different technology:</p><ol><li>Serving static content</li><li>Creating and serving dynamic content</li><li>Providing persistent data storage</li></ol><h2 id=serving-static-content>Serving Static Content</h2><p>We&rsquo;ve already discussed file servers extensively, and even discussed some options for optimizing their performance - like caching the most frequently requested files. There are a number of software packages that have been developed and optimized for this task. Some of the best known are:</p><ul><li><a href=https://httpd.apache.org/ rel=external target=_blank>The Apache HTTP Server Project</a>, an open-source server project originally launched in 1995, and consistently the most popular server software on the Internet. The CS department website is hosted on an Apache server, as is your personal web site on the departmental server.</li><li><a href=https://www.iis.net/ rel=external target=_blank>Internet Information Services (IIS)</a>, Microsoft&rsquo;s flagship web server bundled with the Windows Server operating system.</li><li><a href=https://www.nginx.com/ rel=external target=_blank>Nginx</a> is also open-source, and intended to be a lighter-weight alternative to Apache HTTP.</li></ul><h2 id=creating-and-serving-dynamic-content>Creating and Serving Dynamic Content</h2><p>Creating and serving dynamic content is typically done by writing a custom application. As pointed out above, this can be done using any programming language. The strategies employed in such web server designs depend greatly upon the choice of language - for example, Node webservers rely heavily on asynchronous operation.</p><p>Some interpreted programming languages are typically managed by a web server like Apache, which utilizes plug-ins to run <a href=https://cwiki.apache.org/confluence/display/HTTPD/PHP rel=external target=_blank>PHP</a>, <a href=https://www.modruby.net/ rel=external target=_blank>Ruby</a>, or <a href=http://modpython.org/ rel=external target=_blank>Python</a>. Similarly, IIS runs ASP.NET program scripts written in C# or Visual Basic. This helps offset some of the time penalty incurred by creating the dynamic content with an interpreted programming language, as static content benefits from the server optimizations.</p><p>In contrast, other languages are more commonly used to write a web server that handles <em>both</em> static and dynamic content. This includes more system-oriented languages like <a href=https://isocpp.org/ rel=external target=_blank>C/C++</a>, <a href=https://www.java.com/ rel=external target=_blank>Java</a>, and <a href=https://golang.org/ rel=external target=_blank>Go</a> and more interpreted languages like <a href=https://nodejs.org/ rel=external target=_blank>Node.js</a>.</p><p>In either case, the programming language is often combined with a <em>framework</em> written in that language that provides support for building a web application. Some of the best-known frameworks (and their languages) are:</p><ul><li><a href=https://expressjs.com/ rel=external target=_blank>Express</a> (JavaScript)</li><li><a href=https://laravel.com/ rel=external target=_blank>Laravel</a> (PHP)</li><li><a href=https://flask.palletsprojects.com/en/2.0.x/ rel=external target=_blank>Flask</a> (Python)</li><li><a href=https://www.djangoproject.com/ rel=external target=_blank>Django</a> (Python)</li><li><a href=https://dotnet.microsoft.com/apps/aspnet rel=external target=_blank>ASP.NET</a> (C#)</li><li><a href=https://rubyonrails.org/ rel=external target=_blank>Ruby on Rails</a> (Ruby)</li><li><a href=https://grails.org/ rel=external target=_blank>Grails</a> (Java/Groovy)</li><li><a href=https://spring.io/ rel=external target=_blank>Spring</a> (Java)</li><li><a href=https://www.phoenixframework.org/ rel=external target=_blank>Phoenix</a> (Elixir)</li></ul><h2 id=providing-persistent-data-storage>Providing Persistent Data Storage</h2><p>While a file system is the traditional route for persistent storage of data in files, as we saw in our discussion of static file servers, holding data in memory can vastly improve server performance. However, memory is <em>volatile</em> (it is flushed when the hardware is powered down), so an ideal system combines long-term, file-based storage with in-memory caching. Additionally, <em>structured access</em> to that data (allowing it to be queried systematically and efficiently) can also greatly improve performance of a webserver.</p><p>This role is typically managed by some flavor of database application. Relational databases like the open-source <a href=https://www.mysql.com/ rel=external target=_blank>MySQL</a> and <a href=https://www.postgresql.org/ rel=external target=_blank>PostgresSQL</a>, and closed-source <a href=https://www.microsoft.com/en-us/sql-server/ rel=external target=_blank>SQL Server</a> and <a href=https://www.oracle.com/database/ rel=external target=_blank>Oracle Database</a> remain popular options. However, NoSQL databases like <a href=https://www.mongodb.com/ rel=external target=_blank>MongoDB</a> and <a href=https://couchdb.apache.org/ rel=external target=_blank>CouchDB</a> are gaining a greater market share and are ideal for certain kinds of applications. Cloud-based persistence solutions like <a href=https://firebase.google.com/ rel=external target=_blank>Google Firebase</a> are also providing new alternatives.</p><h2 id=the-stack>The Stack</h2><p>This combination of software, programming language, along with the operating system running them have come to be referred to as a <strong>stack</strong>. Web developers who understood and worked with all of the parts came to be known as <strong>full-stack developers</strong>.</p><p>Clearly, there are a <em>lot</em> of possible combinations of technologies to create a stack, so it was important to know <em>which</em> stacks with which a developer was working. For convenience, the stacks often came to be referred to by acronyms. Some common stacks you will hear of are:</p><ul><li><strong>LAMP (Linux, Apache, MySQL, PHP)</strong> - the granddaddy of stacks, composed entirely of open-source, free software packages.</li><li><strong>LEMP (Linux, Nginx, MySQL, PHP)</strong> - basically LAMP substituting the Nginx server for Apache</li><li><strong>MEAN (MongoDB, Express, Angular, Node)</strong> - Also entirely open-source</li></ul><p>Microsoft has their own traditional stack <strong>ASP.NET</strong>, which is built on Windows Server (the OS), IIS (Internet Information Services, the webserver), a .NET language like C# or Visual Basic, and MSSQL. With the launch of .NET Core, you can now also build a .NET stack running on a Linux OS.</p><p>Additionally, frameworks like <a href=https://www.djangoproject.com/ rel=external target=_blank>Django</a>, <a href=https://rubyonrails.org/ rel=external target=_blank>Ruby on Rails</a>, <a href=https://expressjs.com/ rel=external target=_blank>Express</a>, <a href=https://laravel.com/ rel=external target=_blank>Laravel</a>, etc. often incorporate preferred stacks (though some parts, specifically the server and database, can typically be swapped out).</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>Somewhat confusingly, cloud technologies often replace the traditional webserver role completely, leaving the client-side JavaScript talking to a number of web services. We&rsquo;ll discuss this approach in a few chapters.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><p>In this chapter we have learned about several approaches to creating dynamic web servers, including <em>server pages</em>, <em>custom web servers</em>, and <em>full stack development</em>, often using a <em>web development framework</em>. We also learned how dynamic webservers can handle data and file uploads from HTML forms, as well as some security concerns involved. We also saw how state can be introduced to web apps using <em>cookies</em> and <em>sessions</em>.</p><p>In the next few chapters, we&rsquo;ll explore these ideas in more detail.</p><footer class=footline></footer></article></section></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/41163dc548a00400a9f1d4962b4227b9a8ee4d20>Aug 10, 2023</a></p></div></div><script src=/cis526/js/clipboard.min.js?1741383309 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1741383309 defer></script><script src=/cis526/js/theme.js?1741383309 defer></script></body></html>
<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="Serving Content via the World-Wide-Web"><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Basic Web Servers :: CIS 526 Textbook"><meta name=twitter:description content="Serving Content via the World-Wide-Web"><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/05-web-servers/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Basic Web Servers :: CIS 526 Textbook"><meta property="og:description" content="Serving Content via the World-Wide-Web"><meta property="og:locale" content="en-us"><meta property="og:type" content="website"><meta itemprop=name content="Basic Web Servers :: CIS 526 Textbook"><meta itemprop=description content="Serving Content via the World-Wide-Web"><meta itemprop=datePublished content="2018-08-24T10:53:05-05:00"><meta itemprop=dateModified content="2023-08-10T16:48:12-05:00"><meta itemprop=wordCount content="5"><title>Basic Web Servers :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/05-web-servers/ rel=canonical type=text/html title="Basic Web Servers :: CIS 526 Textbook"><link href=/cis526/05-web-servers/index.xml rel=alternate type=application/rss+xml title="Basic Web Servers :: CIS 526 Textbook"><link href=/cis526/05-web-servers/tele.html rel=alternate type=text/html title="Basic Web Servers :: CIS 526 Textbook"><link href=/cis526/05-web-servers/embed.html rel=alternate type=text/html title="Basic Web Servers :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1745004776 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1745004776 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1745004776 rel=stylesheet><link href=/cis526/css/auto-complete.css?1745004776 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1745004776 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1745004776 rel=stylesheet><link href=/cis526/css/fonts.css?1745004776 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1745004776 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1745004776 rel=stylesheet><link href=/cis526/css/theme-auto.css?1745004776 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1745004776 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1745004776 rel=stylesheet><link href=/cis526/css/print.css?1745004776 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1745004776 rel=stylesheet><script src=/cis526/js/variant.js?1745004776></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="..",window.relearn.relBaseUri="../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1745004776 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/05-web-servers/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Basic Web Servers</span><meta itemprop=position content="1"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/04-node/08-summary/ title="Summary (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/05-web-servers/01-introduction/ title="Introduction (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable chapter narrow" tabindex=-1><div class=flex-block-wrapper><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 5</div><h1 id=basic-web-servers>Basic Web Servers</h1><p>Serving Content via the World-Wide-Web</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Basic Web Servers</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>The first web servers were developed to fulfill a simple role - they responded to requests for HTML documents that were (hopefully) located in their physical storage by streaming the contents of those documents to the client.</p><p><a href=#R-image-fcd25a59f7d5b13793ac0b2107a0476c class=lightbox-link><img alt="Request-Response Pattern" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/5.0.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fcd25a59f7d5b13793ac0b2107a0476c><img alt="Request-Response Pattern" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/5.0.1.png></a></p><p>This is embodied in our request-response pattern. The client requests a resource (such as a HTML document), and receives either a status 200 response (containing the document), or an error status code explaining why it couldn&rsquo;t be retrieved.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=http-in-node>HTTP in Node</h1><p>Node was written primarily to provide tools to develop web servers. So it should come as no surprise that it supports HTTP through a built-in library, the <a href=https://nodejs.org/api/http.html rel=external target=_blank>http module</a>. This module provides support for creating <em>both</em> web servers and web clients, as well as working with http requests and responses. Let&rsquo;s start by examining the latter.</p><h2 id=node-http-request>Node HTTP Request</h2><p>Remember that a HTTP request is nothing more than a stream of text formatted according to the HTTP standards, as we discussed in <a href=https://textbooks.cs.ksu.edu/cis526/02-http/03-request-format/ rel=external target=_blank>Chapter 2</a>. Node makes this information easier to work with in your server code by parsing it into an object, an instance of <a href=https://nodejs.org/api/http.html#http_class_http_incomingmessage rel=external target=_blank>http.IncomingMessage</a>. Its properties expose the data of the request, and include:</p><ul><li><a href=https://nodejs.org/api/http.html#http_message_headers rel=external target=_blank>message.headers</a> - the request headers as a JavaScript object, with the keys corresponding to the HTTP header key, and the values corresponding to the HTTP header values.</li><li><a href=https://nodejs.org/api/http.html#http_message_method rel=external target=_blank>message.method</a> - request method, i.e. <code>'GET'</code>, <code>'POST'</code>, <code>'PUT'</code>, <code>'PATCH'</code>, or <code>'DELETE'</code></li><li><a href=https://nodejs.org/api/http.html#http_message_url rel=external target=_blank>message.url</a> - the URL string provided through the request. Note that this URL does not contain the protocol and host information (those were set during the connection opening process)</li></ul><p>You typically won&rsquo;t create an <code>http.IncomingMessage</code>, rather it will be provided to you by an instance of <code>http.Server</code>, which we&rsquo;ll talk about shortly.</p><h2 id=node-http-response>Node HTTP Response</h2><p>The HTTP response is also nothing more than a stream of text formatted according to the HTTP standards, as laid out in <a href=https://textbooks.cs.ksu.edu/cis526/02-http/08-response-format/ rel=external target=_blank>Chapter 2</a>. Node also wraps the response with an object, an instance of <a href=https://nodejs.org/api/http.html#http_class_http_serverresponse rel=external target=_blank>http.ServerResponse</a>. However, this object is used to <em>build</em> the response (which is the primary job of a web server). This process proceeds in several steps:</p><ol><li>Setting the status code & message</li><li>Setting the headers</li><li>Setting the body</li><li>Setting the trailers</li><li>Sending the response</li></ol><p>Not all of these steps are required for all responses, with the exception of the sending of the response. We&rsquo;ll discuss the process of generating a response in more detail later. As with the <code>http.IncomingMessage</code>, you won&rsquo;t directly create <code>http.ServerResponse</code> objects, instead they will be created by an instance of <code>http.Server</code>, which we&rsquo;ll look at next.</p><h2 id=node-http-server>Node HTTP Server</h2><p>The <a href=https://nodejs.org/api/http.html#http_class_http_server rel=external target=_blank>http.Server</a> class embodies the basic operating core of a webserver, which you can build upon to create your own web server implementations. Instances of <code>http.Server</code> are created with the factory method <a href=https://nodejs.org/api/http.html#http_http_createserver_options_requestlistener rel=external target=_blank>http.createServer()</a>. This method takes two parameters, the first is an optional JavaScript object with options for the server, and the second (or first, if the <code>options</code> parameter is omitted) is a callback function to invoke every time the server receives a request. As you might expect, the method returns the created <code>http.Server</code> instance.</p><p>The callback function always takes two parameters. The first is an instance of <code>http.IncomingMessage</code> (often assigned to a variable named <code>req</code>) that represents the request the server has received, and the second is an instance of <code>http.ServerResponse</code> (often assigned to available named <code>res</code>) that represents the response the server will send back to the client, once you have set all its properties. This callback is often called the <em>request handler</em>, for it decides what to do with incoming requests. Each incoming request is handled <em>asynchronously</em>, much like any event.</p><p>Once the server has been created, it needs to be told to listen for incoming requests. It will do so on a specific <a href=https://en.wikipedia.org/wiki/Port_(computer_networking) rel=external target=_blank>port</a>. This port is represented by a number between 0 and 65535. You can think of your computer as an apartment complex, and each port number corresponding to an apartment number where a specific program &ldquo;lives&rdquo;. Thus, to send a message to that particular program, you would address your letter to the apartment address using the apartment number. In this analogy, the apartment address is the <em>host address</em>, i.e. the IP address of your computer, and the specific apartment is the <em>port</em>. Certain port numbers are commonly used by specific applications or families of applications, i.e. web servers typically use port 80 for HTTP and port 443 for HTTPS connections. However, when you are developing a webserver, you&rsquo;ll typically use a non-standard port, often an address 3000 and up.</p><p>Thus, to start your webserver running on port 3000, you would invoke [server.Listen()] with that port as the first argument. An optional second argument is a callback function invoked once the server is up and running - it is usually used to log a message saying the server is running.</p><h3 id=an-example-server>An Example Server</h3><p>A quick example of a server that only responds with the message &ldquo;Hello web!&rdquo; would be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>http</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>((</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>req</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=s2>&#34;Hello web!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>3000</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Server listening at port 3000&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Once the server is running, you can visit <a href=http://localhost:3000 rel=external target=_blank>http://localhost:3000</a> on the same computer to see the phrase &ldquo;Hello web!&rdquo; printed in your browser.</p><p>The <code>localhost</code> hostname is a special <em>loopback</em> host, which indicates instead of looking for a computer on the web, you&rsquo;re wanting to access the computer you&rsquo;re currently on. The <code>:3000</code> specifies the browser should make the request to the non-standard port of <code>3000</code>. If we instead used port <code>80</code>, we could omit the port in the URL, as by default the browser will use port <code>80</code> for http requests.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=request-handling>Request Handling</h1><p>An important aspect to recognize about how Node&rsquo;s http library operates is that <em>all</em> requests to the server are passed to the request handler function. Thus, you need to determine what to do with the incoming request as part of that function.</p><h2 id=working-with-the-request-object>Working with the Request Object</h2><p>You will most likely use the information contained within the <code>http.IncomingMessage</code> object supplied as the first parameter to your request handler. We often use the name <code>req</code> for this parameter, short for <em>request</em>, as it represents the incoming HTTP request.</p><p>Some of its properties we might use:</p><ul><li><p>The <code>req.method</code> parameter indicates what <a href=https://textbooks.cs.ksu.edu/cis526/02-http/04-request-methods/ rel=external target=_blank>HTTP method</a> the request is using. For example, if the method is <code>"GET"</code>, we would expect that the client is requesting a resource like an HTML page or image file. If it were a <code>"POST"</code> request, we would think they are submitting something.</p></li><li><p>The <code>req.url</code> parameter indicates the specific resource path the client is requesting, i.e. <code>"/about.html"</code> suggests they are looking for the &ldquo;about&rdquo; page. The url can have more parts than just the path. It also can contain a query string and a hash string. We&rsquo;ll talk more about these soon.</p></li><li><p>The <code>req.headers</code> parameter contains all the headers that were set on this particular request. Of specific interest are <em>authentication</em> headers (which help say who is behind the request and determine if the server should allow the request), and <em>cookie</em> headers. We&rsquo;ll talk more about this a bit further into the course, when we introduce the associated concepts.</p></li></ul><p>Generally, we use properties in combination to determine what the correct response is. As a programmer, you probably already realize that this decision-making process must involve some sort of <a href=https://en.wikipedia.org/wiki/Control_flow rel=external target=_blank>control flow</a> structure, like an <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/if...else rel=external target=_blank>if statement</a> or <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/switch rel=external target=_blank>switch case statement</a>.</p><p>Let&rsquo;s say we only want to handle <code>"GET"</code> requests for the files <em>index.html</em>, <em>site.css</em>, and <em>site.js</em>. We could write our request handler using both an <code>if else</code> statement and a <code>switch</code> statement:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>handleRequest</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>method</span> <span class=o>===</span> <span class=s2>&#34;GET&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;/index.html&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// TODO: Serve the index page 
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;/site.css&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// TODO: Serve the css file 
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;/site.js&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// TODO: Serve the js file
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// TODO: Serve a 404 Not Found response
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// TODO: Serve a 501 Not Implemented response
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Notice that at each branching point of our control flow, we serve some kind of response to the requesting web client. <em>Every</em> request should be sent a response - even unsuccessful ones. If we do not, then the browser will <em>timeout</em>, and report a timeout error to the user.</p><p><a href=#R-image-490c78a410c16ea9687b0e46652cb42f class=lightbox-link><img alt="handleRequest() flowchart" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/5.3.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-490c78a410c16ea9687b0e46652cb42f><img alt="handleRequest() flowchart" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/5.3.1.png></a></p><h2 id=working-with-the-response-object>Working with the Response Object</h2><p>The second half of responding to requests is putting together the response. You will use the <code>http.ServerResponse</code> object to assemble and send the response. This response consists of a <a href=https://textbooks.cs.ksu.edu/cis526/02-http/09-status-codes/ rel=external target=_blank>status code and message</a>, <a href=https://textbooks.cs.ksu.edu/cis526/02-http/10-response-headers/ rel=external target=_blank>response headers</a>, and a <a href=https://textbooks.cs.ksu.edu/cis526/02-http/11-response-body/ rel=external target=_blank>body</a> which could be text, binary data, or nothing.</p><p>There are a number of properties and methods defined in the <code>http.ServerResponse</code> to help with this, including:</p><ul><li><a href=https://nodejs.org/api/http.html#http_response_statuscode rel=external target=_blank>ServerResponse.statusCode</a> can be used to manually set the status code</li><li><a href=https://nodejs.org/api/http.html#http_response_statusmessage rel=external target=_blank>ServerResponse.statusMessage</a> can be used to manually set the status message. If the code is set but not the message, the default message for the code is used.</li><li><a href=https://nodejs.org/api/http.html#http_response_setheader_name_value rel=external target=_blank>ServerResponse.setHeader()</a> adds a header with the supplied name and value (the first and second parameters)</li><li><a href=https://nodejs.org/api/http.html#http_response_end_data_encoding_callback rel=external target=_blank>ServerResponse.end()</a> sends the request using the currently set status and headers. Takes an optional parameter which is the response body; if this parameter is supplied, an optional second parameter specifying the encoding can also be used. A final optional callback can be supplied that is called when sending the stream is complete.</li></ul><p>Consider the <strong>501 Not Implemented</strong> response in our example above. We need to send the 501 status code, but there is no need for a body or additional headers. We could use the <code>req.statusCode</code> property to set the property, and the <code>req.end()</code> method to send it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>    <span class=c1>// TODO: Serve a 501 Not Implemented response
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span> <span class=o>=</span> <span class=mi>501</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span></span></span></code></pre></div><p>The sending of a response with a body is a bit more involved. For example, to send the <em>index.html</em> file, we would need to retrieve it from the hard drive and send it as the body of a request. But as the default status code is 200, we don&rsquo;t need to specify it. However, it is a good idea to specify the <code>Content-Type</code> header with the appropriate mime-type, and then we can use the <code>res.end()</code> method with the file body once we&rsquo;ve loaded it, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>    <span class=c1>// TODO: Serve the index page 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s1>&#39;index.html&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>body</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>status</span> <span class=o>=</span> <span class=mi>500</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>setHeader</span><span class=p>(</span><span class=s2>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s2>&#34;text/html&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>setHeader</span><span class=p>(</span><span class=s2>&#34;Content-Length&#34;</span><span class=p>,</span> <span class=nx>body</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>end</span><span class=p>(</span><span class=nx>body</span><span class=p>,</span> <span class=s2>&#34;utf8&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span></span></span></code></pre></div><p>Notice too, that we need to account for the possibility of an error while loading the file <em>index.html</em>. If this happens, we send a <strong>500 Server Error</strong> status code indicating that something went wrong, and it happened on <em>our</em> end, not because of a problem in the way the client formatted the request. Notice too that we use a <code>return</code> to prevent executing the rest of our code.</p><p>We also supply the length of the response body, which will be the same as the buffer length or the length of a string sent as the body. Binary data for the web is counted in octets (eight bits) which conveniently is also how Node buffers are sized and the size of a JavaScript character.</p><h2 id=chaining-writehead-and-end>Chaining writeHead() and end()</h2><p>The <code>http.ServerResponse</code> object also has a method <code>writeHead()</code> which combines the writing of status code, message, and headers into a single step, and returns the modified object so its <code>end()</code> method can be chained. In this way, you can write the entire sending of a response on a single line. The parameters to <code>response.writeHead()</code> are the status code, an optional status message, and an optional JavaScript object representing the headers, using the keys as the header names and values as values.</p><p>Serving the css file using this approach would look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>    <span class=c1>// TODO: Serve the site css file 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fs</span><span class=p>.</span><span class=nx>readFile</span><span class=p>(</span><span class=s1>&#39;site.css&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>body</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span> <span class=s2>&#34;text/html&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Content-Length&#34;</span><span class=o>:</span> <span class=nx>body</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>        <span class=p>}).</span><span class=nx>end</span><span class=p>(</span><span class=nx>body</span><span class=p>,</span> <span class=s2>&#34;utf8&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span></span></span></code></pre></div><p>You can use any combination of these approaches to send responses.<div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>Some important considerations:</p><ul><li>Be aware that you can only send <em>one</em> response per request. Once a response is sent, the connection to the client is effectively closed. Thus, once <code>response.end()</code> has been invoked, it will log an error if it is attempted again.</li><li>The <code>response.writeHead()</code> method actually streams the head to the client. Thus, you cannot run <code>response.setHeader()</code> or set <code>response.statusCode</code> or <code>response.statusMessage</code> after it has been set.</li><li>Similarly, any change to the response object after <code>response.end()</code> has been invoked will log an error, as you cannot change the response once it&rsquo;s sent.</li></ul></div></div></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=the-importance-of-being-async>The Importance of Being Async</h1><p>You may have noticed that we used the asynchronous version of <code>fs.readFile()</code> in our response handler. This is critical to good performance with a Node-based webserver - any potentially blocking action taken in the request handler should be asynchronous, because <em>all incoming requests</em> must be processed on the same thread. If our event loop gets bogged down handling a blocked process, then <em>nobody gets a response</em>!</p><p>Consider if we implemented one of the file serving options using the synchronous <code>fs.readFileSync()</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>    <span class=c1>// TODO: Serve the site js file 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>var</span> <span class=nx>body</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;site.js&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span> <span class=s2>&#34;application/javascript&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Content-Length&#34;</span><span class=o>:</span> <span class=nx>body</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>      <span class=p>}).</span><span class=nx>end</span><span class=p>(</span><span class=nx>body</span><span class=p>,</span> <span class=s2>&#34;utf8&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span></span></span></code></pre></div><p>It does not look that different from the asynchronous version, but consider what happens if <em>site.js</em> cannot be opened immediately (perhaps it is locked by a system process that is modifying it). With the synchronous version, we wait for the file to become available. While we wait, incoming requests are added to our event queue&mldr; and none are processed, as the event loop is paused while we are waiting for <code>fs.readFileSync('site.js')</code> to resolve. If it takes more than three seconds, the clients that are waiting will start seeing timeouts in their browsers, and will probably assume our site is down.</p><p><a href=#R-image-d57c6e1e447b7626886e6dda381c27f7 class=lightbox-link><img alt="Async vs Sync operations in the Event Loop" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/5.4.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d57c6e1e447b7626886e6dda381c27f7><img alt="Async vs Sync operations in the Event Loop" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/5.4.1.png></a></p><p>In contrast, if we used the asynchronous version, the reading of the file is handed off to another thread when <code>fs.readFile()</code> is invoked. Any additional processing to do within the event loop for this request is finished, and the next task is pulled from the event queue. Even if our request for the original file never completes, we still are serving requests as quickly as we get them.</p><p>This asynchronous approach is key to making a Node-based website perform and scale well. But it is vitally important that you, as a web developer, <em>understand</em> both why using asynchronous processes is important, and <em>how</em> to use them correctly. Because if you don&rsquo;t, your application performance can be much, much worse than with other approaches.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=caching-for-the-win>Caching for the Win</h1><p>In our example web server, we argued that asynchronous file reading was better than synchronous because reading from a file is a potentially blocking operation that can take a long time to perform. But even when it doesn&rsquo;t block, it can still take a lot of time, making it the most <em>expensive</em> part of our request handling operation in terms of the time it takes to perform.</p><p>If we really want to squeeze all the performance we can out of our server (and therefore handle as many users as possible), we need to consider the strategy of <a href=https://en.wikipedia.org/wiki/Cache_(computing) rel=external target=_blank>caching</a>. This means storing our file content in a location where access is faster - say in <em>memory</em> rather than on the <em>disk</em>. Variables in our application are stored in RAM, even variables whose contents were initialized from disk files. Thus, assigning the contents of a file to a variable effectively caches it for faster access.</p><p>Moreover, because Node variables are only accessible from the Node process, which from our perspective in the event loop is single-threaded, we don&rsquo;t have to worry about blocking once the file has been loaded. One strategy we can employ is to pre-load our files using synchronous operations, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>http</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>html</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;index.html&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>css</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;site.css&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>js</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;site.js&#39;</span><span class=p>);</span></span></span></code></pre></div><p>Now we can define our revised event handler, which uses the cached versions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>handleRequest</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>method</span> <span class=o>===</span> <span class=s2>&#34;GET&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;/index.html&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Serve the index page 
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;text/html&#39;</span><span class=p>,</span> <span class=s1>&#39;Content-Length&#39;</span><span class=o>:</span> <span class=nx>html</span><span class=p>.</span><span class=nx>length</span><span class=p>}).</span><span class=nx>end</span><span class=p>(</span><span class=nx>html</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;/site.css&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Serve the css file 
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;text/html&#39;</span><span class=p>,</span> <span class=s1>&#39;Content-Length&#39;</span><span class=o>:</span> <span class=nx>css</span><span class=p>.</span><span class=nx>length</span><span class=p>}).</span><span class=nx>end</span><span class=p>(</span><span class=nx>css</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;/site.js&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Serve the js file
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;text/html&#39;</span><span class=p>,</span> <span class=s1>&#39;Content-Length&#39;</span><span class=o>:</span> <span class=nx>js</span><span class=p>.</span><span class=nx>length</span><span class=p>}).</span><span class=nx>end</span><span class=p>(</span><span class=nx>js</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Serve a 404 Not Found response
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>404</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Serve a 501 Not Implemented response
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>501</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Finally, we create and start the server:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>(</span><span class=nx>handleRequest</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>80</span><span class=p>,</span> <span class=p>()=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Server listening on port 80&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Notice in this server implementation we use the <em>synchronous</em> <code>fs.readFileSync()</code>, and we don&rsquo;t wrap it in a <code>try ... catch</code>. That means if there is a problem loading one of the files, our Node process will crash. But as these files are loaded <em>first</em>, before the server starts, we should see the error, and realize there is a problem with our site files that needs fixed. This is one instance where it <em>does</em> make sense to use synchronous file calls.</p><p>While caching works well in this instance, like everything in computer science it doesn&rsquo;t work well in all instances. Consider if we had a server with <em>thousands</em> of files - maybe images that were each 500 Megabytes. With only a thousand images, we&rsquo;d have 500 Gigabytes to cache&mldr; which would mean our server would need a <em>lot</em> of expensive RAM. In a case like that, asynchronous file access when the file is requested makes far more sense.</p><p>Also, depending on the use pattern it may make sense to cache <em>some</em> of the most frequently requested images. With careful design, this caching can be dynamic, changing which images are cached based on how frequently they are requested while the server is running.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=index-pages>Index Pages</h1><p>The original purpose of the World-Wide-Web was to share webpages and other digital resources across the Internet. In many ways, an early web server was like a hard drive that was open to the world. Think about the HTTP methods, <code>"GET"</code> is like a file read, <code>"POST"</code> is like a write, <code>"PUT"</code> and <code>"PATCH"</code> like a file modification, and <code>"DELETE"</code> was a file erasure.</p><p>So, just like when you browse your hard drive using Windows Explorer or other software, it was necessary for these early web pages to display an <em>index</em> - a listing of all the contents of a directory. You&rsquo;ve seen similar in Codio if you ever used the &ldquo;Project Index&rdquo; option in the run menu - it displays an index of the project directory:</p><p><a href=#R-image-b249c3ea6f2b2560d4cc939a4038faa8 class=lightbox-link><img alt="Codio Project Index Page" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/5.6.1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b249c3ea6f2b2560d4cc939a4038faa8><img alt="Codio Project Index Page" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/5.6.1.png></a></p><p>This is a pretty standard auto-generated directory listing - it provides the path to the directory being displayed, and all the contents of the directory as hyperlinks. Clicking on a file will open or download it, and clicking a directory will open <em>that</em> directory&rsquo;s auto-generated directory listing.</p><p>As the use of the web expanded into commercial and public life, many web developers wanted to replace auto-generated directory listing pages with a carefully designed home page. But auto-generated directory listing pages remained an important feature for many sites that served as a more traditional file server.</p><p>The compromise adopted by most web servers was that if the directory contained an HTML file named <em>index.html</em> (or sometimes <em>index</em> with any extension, i.e. <em>index.php</em>), that page would be served in leu of an auto-generated index page. Most also allow disabling the directory listing as a configuration option.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>You might be wondering about security if a web server starts exposing directory structure and files willy-nilly. Most web servers will <em>only</em> serve files in a specific directory (often called the <em>root</em> directory) and its subdirectories. In a typical configuration, this root directory is named <em>public</em> or <em>public_html</em> to reinforce the idea that it is available to anyone browsing the web.</p><p>Files that need to have access restricted to certain people should not be placed in this directory, but be placed behind an authentication mechanism (sometimes referred to as an <em>auth wall</em> or <em>pay wall</em> for subscription-based sites). We&rsquo;ll talk about this more in our chapter on authentication.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=partial-downloads>Partial Downloads</h1><p>While we normally think of downloading an entire file from the web, there are some situations where it makes sense to download only <em>part</em> of a file. One case is with a large file download that gets interrupted - it makes a lot of sense to start downloading the remaining bytes from where you left off, rather than starting over again. A second case is when you are streaming media; often the user may not watch or listen to the entire media file, so why download the bytes they don&rsquo;t need? Or if it is a live stream, we explicitly <em>can&rsquo;t</em> download the entire thing, because later parts do not yet exist!</p><h2 id=range-headers>Range Headers</h2><p>HTTP explicitly supports requesting only a part of a resource with the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Range rel=external target=_blank>Range</a> header. This allows us to specify the unit of measure (typically bytes), a starting point, and an optional end. This header is structured:</p><div class=highlight><pre tabindex=0><code>Range: &lt;unit&gt;=&lt;range-start&gt;-&lt;range-end&gt;</code></pre></div><p>Where <code>&lt;unit></code> is the unit of measure, the <code>&lt;range-start></code> is the start of the range to send, measured in the provided unit, and <code>&lt;range-end></code> is the end of the range to send.</p><p>Thus, a real-world Range header might look like:</p><div class=highlight><pre tabindex=0><code>Range: bytes=200-300</code></pre></div><p>You can also specify only the starting point (useful for resuming downloads):</p><div class=highlight><pre tabindex=0><code>Range: &lt;unit&gt;=&lt;range-start&gt;-</code></pre></div><p>Finally, you can specify multiple ranges separated by commas:</p><div class=highlight><pre tabindex=0><code>Range: &lt;unit&gt;=&lt;range1-start&gt;-&lt;range1-end&gt;, &lt;range2-start&gt;-&lt;range2-end&gt;, &lt;range3-start&gt;-</code></pre></div><p>Of course, as with all request headers, this indicates a desire by the web client. It is up to the web server to determine if it will be honored.</p><h3 id=partial-content>Partial Content</h3><p>Which brings us to the <strong>206 Partial Content</strong> response status code. If the server chooses to honor a range specified in the request header, it should respond with this status code, and the body of the response should be just the bytes requested.</p><p>In addition, the response <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Range rel=external target=_blank>Content-Range</a> header should be included with the response, specifying the actual range of bytes returned. This is similar to the Range header, but includes a the total size:</p><div class=highlight><pre tabindex=0><code>Content-Range: &lt;unit&gt; &lt;range-start&gt;-&lt;range-end&gt;/&lt;size&gt;</code></pre></div><p>An asterisk (<code>*</code>) can be used for an unknown size.</p><p>Also, the <a href=/cis526/05-web-servers/07-partial-downloads/>Content-Type</a> header should also be included, and match the type of file being streamed.</p><p>If <em>multiple</em> ranges are included in the response, the Content-Type is <code>"multipart/byteranges"</code> and the response body is formatted similarly to multipart form data.</p><footer class=footline></footer></article></section></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/41163dc548a00400a9f1d4962b4227b9a8ee4d20>Aug 10, 2023</a></p></div></div><script src=/cis526/js/clipboard.min.js?1745004776 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1745004776 defer></script><script src=/cis526/js/theme.js?1745004776 defer></script></body></html>
<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="In our example web server, we argued that asynchronous file reading was better than synchronous because reading from a file is a potentially blocking operation that can take a long time to perform. But even when it doesn’t block, it can still take a lot of time, making it the most expensive part of our request handling operation in terms of the time it takes to perform.
If we really want to squeeze all the performance we can out of our server (and therefore handle as many users as possible), we need to consider the strategy of caching."><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Caching for the Win :: CIS 526 Textbook"><meta name=twitter:description content="In our example web server, we argued that asynchronous file reading was better than synchronous because reading from a file is a potentially blocking operation that can take a long time to perform. But even when it doesn’t block, it can still take a lot of time, making it the most expensive part of our request handling operation in terms of the time it takes to perform.
If we really want to squeeze all the performance we can out of our server (and therefore handle as many users as possible), we need to consider the strategy of caching."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/05-web-servers/05-caching-win/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Caching for the Win :: CIS 526 Textbook"><meta property="og:description" content="In our example web server, we argued that asynchronous file reading was better than synchronous because reading from a file is a potentially blocking operation that can take a long time to perform. But even when it doesn’t block, it can still take a lot of time, making it the most expensive part of our request handling operation in terms of the time it takes to perform.
If we really want to squeeze all the performance we can out of our server (and therefore handle as many users as possible), we need to consider the strategy of caching."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="Basic Web Servers"><meta property="article:published_time" content="2018-08-24T10:53:26-05:00"><meta property="article:modified_time" content="2020-06-19T20:51:18-05:00"><meta itemprop=name content="Caching for the Win :: CIS 526 Textbook"><meta itemprop=description content="In our example web server, we argued that asynchronous file reading was better than synchronous because reading from a file is a potentially blocking operation that can take a long time to perform. But even when it doesn’t block, it can still take a lot of time, making it the most expensive part of our request handling operation in terms of the time it takes to perform.
If we really want to squeeze all the performance we can out of our server (and therefore handle as many users as possible), we need to consider the strategy of caching."><meta itemprop=datePublished content="2018-08-24T10:53:26-05:00"><meta itemprop=dateModified content="2020-06-19T20:51:18-05:00"><meta itemprop=wordCount content="523"><title>Caching for the Win :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/05-web-servers/05-caching-win/ rel=canonical type=text/html title="Caching for the Win :: CIS 526 Textbook"><link href=/cis526/05-web-servers/05-caching-win/index.xml rel=alternate type=application/rss+xml title="Caching for the Win :: CIS 526 Textbook"><link href=/cis526/05-web-servers/05-caching-win/tele.html rel=alternate type=text/html title="Caching for the Win :: CIS 526 Textbook"><link href=/cis526/05-web-servers/05-caching-win/embed.html rel=alternate type=text/html title="Caching for the Win :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1745849584 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1745849584 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1745849584 rel=stylesheet><link href=/cis526/css/auto-complete.css?1745849584 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1745849584 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1745849584 rel=stylesheet><link href=/cis526/css/fonts.css?1745849584 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1745849584 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1745849584 rel=stylesheet><link href=/cis526/css/theme-auto.css?1745849584 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1745849584 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1745849584 rel=stylesheet><link href=/cis526/css/print.css?1745849584 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1745849584 rel=stylesheet><script src=/cis526/js/variant.js?1745849584></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../..",window.relearn.relBaseUri="../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1745849584 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/05-web-servers/05-caching-win/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/cis526/05-web-servers/><span itemprop=name>Basic Web Servers</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Caching for the Win</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/05-web-servers/04-importance-of-async/ title="The Importance of Being Async (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/05-web-servers/06-index-pages/ title="Index Pages (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=caching-for-the-win>Caching for the Win</h1><p>In our example web server, we argued that asynchronous file reading was better than synchronous because reading from a file is a potentially blocking operation that can take a long time to perform. But even when it doesn&rsquo;t block, it can still take a lot of time, making it the most <em>expensive</em> part of our request handling operation in terms of the time it takes to perform.</p><p>If we really want to squeeze all the performance we can out of our server (and therefore handle as many users as possible), we need to consider the strategy of <a href=https://en.wikipedia.org/wiki/Cache_(computing) rel=external target=_blank>caching</a>. This means storing our file content in a location where access is faster - say in <em>memory</em> rather than on the <em>disk</em>. Variables in our application are stored in RAM, even variables whose contents were initialized from disk files. Thus, assigning the contents of a file to a variable effectively caches it for faster access.</p><p>Moreover, because Node variables are only accessible from the Node process, which from our perspective in the event loop is single-threaded, we don&rsquo;t have to worry about blocking once the file has been loaded. One strategy we can employ is to pre-load our files using synchronous operations, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>http</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;http&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>html</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;index.html&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>css</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;site.css&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>js</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;site.js&#39;</span><span class=p>);</span></span></span></code></pre></div><p>Now we can define our revised event handler, which uses the cached versions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>function</span> <span class=nx>handleRequest</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>method</span> <span class=o>===</span> <span class=s2>&#34;GET&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;/index.html&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Serve the index page 
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;text/html&#39;</span><span class=p>,</span> <span class=s1>&#39;Content-Length&#39;</span><span class=o>:</span> <span class=nx>html</span><span class=p>.</span><span class=nx>length</span><span class=p>}).</span><span class=nx>end</span><span class=p>(</span><span class=nx>html</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;/site.css&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Serve the css file 
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;text/html&#39;</span><span class=p>,</span> <span class=s1>&#39;Content-Length&#39;</span><span class=o>:</span> <span class=nx>css</span><span class=p>.</span><span class=nx>length</span><span class=p>}).</span><span class=nx>end</span><span class=p>(</span><span class=nx>css</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=s2>&#34;/site.js&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Serve the js file
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;text/html&#39;</span><span class=p>,</span> <span class=s1>&#39;Content-Length&#39;</span><span class=o>:</span> <span class=nx>js</span><span class=p>.</span><span class=nx>length</span><span class=p>}).</span><span class=nx>end</span><span class=p>(</span><span class=nx>js</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Serve a 404 Not Found response
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>404</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Serve a 501 Not Implemented response
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>res</span><span class=p>.</span><span class=nx>writeHead</span><span class=p>(</span><span class=mi>501</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Finally, we create and start the server:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>(</span><span class=nx>handleRequest</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=mi>80</span><span class=p>,</span> <span class=p>()=&gt;{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Server listening on port 80&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div><p>Notice in this server implementation we use the <em>synchronous</em> <code>fs.readFileSync()</code>, and we don&rsquo;t wrap it in a <code>try ... catch</code>. That means if there is a problem loading one of the files, our Node process will crash. But as these files are loaded <em>first</em>, before the server starts, we should see the error, and realize there is a problem with our site files that needs fixed. This is one instance where it <em>does</em> make sense to use synchronous file calls.</p><p>While caching works well in this instance, like everything in computer science it doesn&rsquo;t work well in all instances. Consider if we had a server with <em>thousands</em> of files - maybe images that were each 500 Megabytes. With only a thousand images, we&rsquo;d have 500 Gigabytes to cache&mldr; which would mean our server would need a <em>lot</em> of expensive RAM. In a case like that, asynchronous file access when the file is requested makes far more sense.</p><p>Also, depending on the use pattern it may make sense to cache <em>some</em> of the most frequently requested images. With careful design, this caching can be dynamic, changing which images are cached based on how frequently they are requested while the server is running.</p><footer class=footline></footer></article></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Nathan Bean
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/698c4493abd6fb4030d44a486d817986806115d3>Jun 19, 2020</a></p></div></div><script src=/cis526/js/clipboard.min.js?1745849584 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1745849584 defer></script><script src=/cis526/js/theme.js?1745849584 defer></script></body></html>
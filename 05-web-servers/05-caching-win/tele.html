<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=html><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.148.1"><meta name=generator content="Relearn 8.0.0"><meta name=description content="In our example web server, we argued that asynchronous file reading was better than synchronous because reading from a file is a potentially blocking operation that can take a long time to perform. But even when it doesn’t block, it can still take a lot of time, making it the most expensive part of our request handling operation in terms of the time it takes to perform.
If we really want to squeeze all the performance we can out of our server (and therefore handle as many users as possible), we need to consider the strategy of caching. This means storing our file content in a location where access is faster - say in memory rather than on the disk. Variables in our application are stored in RAM, even variables whose contents were initialized from disk files. Thus, assigning the contents of a file to a variable effectively caches it for faster access."><meta name=author content="Nathan Bean & Russell Feldhausen"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta name=twitter:title content="Caching for the Win :: CIS 526 Textbook"><meta name=twitter:description content="In our example web server, we argued that asynchronous file reading was better than synchronous because reading from a file is a potentially blocking operation that can take a long time to perform. But even when it doesn’t block, it can still take a lot of time, making it the most expensive part of our request handling operation in terms of the time it takes to perform.
If we really want to squeeze all the performance we can out of our server (and therefore handle as many users as possible), we need to consider the strategy of caching. This means storing our file content in a location where access is faster - say in memory rather than on the disk. Variables in our application are stored in RAM, even variables whose contents were initialized from disk files. Thus, assigning the contents of a file to a variable effectively caches it for faster access."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/05-web-servers/05-caching-win/index.html"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Caching for the Win :: CIS 526 Textbook"><meta property="og:description" content="In our example web server, we argued that asynchronous file reading was better than synchronous because reading from a file is a potentially blocking operation that can take a long time to perform. But even when it doesn’t block, it can still take a lot of time, making it the most expensive part of our request handling operation in terms of the time it takes to perform.
If we really want to squeeze all the performance we can out of our server (and therefore handle as many users as possible), we need to consider the strategy of caching. This means storing our file content in a location where access is faster - say in memory rather than on the disk. Variables in our application are stored in RAM, even variables whose contents were initialized from disk files. Thus, assigning the contents of a file to a variable effectively caches it for faster access."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="Basic Web Servers"><meta property="article:published_time" content="2018-08-24T10:53:26-05:00"><meta property="article:modified_time" content="2020-06-19T20:51:18-05:00"><meta property="og:image" content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta itemprop=name content="Caching for the Win :: CIS 526 Textbook"><meta itemprop=description content="In our example web server, we argued that asynchronous file reading was better than synchronous because reading from a file is a potentially blocking operation that can take a long time to perform. But even when it doesn’t block, it can still take a lot of time, making it the most expensive part of our request handling operation in terms of the time it takes to perform.
If we really want to squeeze all the performance we can out of our server (and therefore handle as many users as possible), we need to consider the strategy of caching. This means storing our file content in a location where access is faster - say in memory rather than on the disk. Variables in our application are stored in RAM, even variables whose contents were initialized from disk files. Thus, assigning the contents of a file to a variable effectively caches it for faster access."><meta itemprop=datePublished content="2018-08-24T10:53:26-05:00"><meta itemprop=dateModified content="2020-06-19T20:51:18-05:00"><meta itemprop=wordCount content="526"><meta itemprop=image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><title>Caching for the Win :: CIS 526 Textbook</title><link href=https://textbooks.cs.ksu.edu/cis526/05-web-servers/05-caching-win/index.html rel=canonical type=text/html title="Caching for the Win :: CIS 526 Textbook"><link href=/cis526/05-web-servers/05-caching-win/index.xml rel=alternate type=application/rss+xml title="Caching for the Win :: CIS 526 Textbook"><link href=/cis526/05-web-servers/05-caching-win/index.print.html rel=alternate type=text/html title="Caching for the Win :: CIS 526 Textbook"><link href=/cis526/05-web-servers/05-caching-win/embed.html rel=alternate type=text/html title="Caching for the Win :: CIS 526 Textbook"><link href=/cis526/css/auto-complete/auto-complete.min.css?1753540871 rel=stylesheet><script src=/cis526/js/auto-complete/auto-complete.min.js?1753540871 defer></script><script src=/cis526/js/search-lunr.min.js?1753540871 defer></script><script src=/cis526/js/search.min.js?1753540871 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/cis526/searchindex.en.js?1753540871"</script><script src=/cis526/js/lunr/lunr.min.js?1753540871 defer></script><script src=/cis526/js/lunr/lunr.stemmer.support.min.js?1753540871 defer></script><script src=/cis526/js/lunr/lunr.multi.min.js?1753540871 defer></script><script src=/cis526/js/lunr/lunr.en.min.js?1753540871 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1753540871 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1753540871 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar/perfect-scrollbar.min.css?1753540871 rel=stylesheet><link href=/cis526/css/theme.min.css?1753540871 rel=stylesheet><link href=/cis526/css/format-html.min.css?1753540871 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/05-web-servers/05-caching-win/index.html",window.relearn.relBasePath="../..",window.relearn.relBaseUri="../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!1,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.relearn.themevariants=["light-theme"],window.relearn.customvariantname="my-custom-variant",window.relearn.writeVariant=!1,window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.writeVariant&&window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><link href=/cis526/css/custom.css?1753540871 rel=stylesheet></head><body class="mobile-support html" data-url=/cis526/05-web-servers/05-caching-win/index.html><div id=tele class="tele mirror"><div id=R-body class=default-animation><div id=R-body-overlay></div><div id=R-main-overlay></div><main id=R-body-inner class="highlightable 05-web-servers" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=caching-for-the-win>Caching for the Win</h1><p>In our example web server, we argued that asynchronous file reading was better than synchronous because reading from a file is a potentially blocking operation that can take a long time to perform. But even when it doesn&rsquo;t block, it can still take a lot of time, making it the most <em>expensive</em> part of our request handling operation in terms of the time it takes to perform.</p><p>If we really want to squeeze all the performance we can out of our server (and therefore handle as many users as possible), we need to consider the strategy of <a href=https://en.wikipedia.org/wiki/Cache_(computing) rel=external target=_blank>caching</a>. This means storing our file content in a location where access is faster - say in <em>memory</em> rather than on the <em>disk</em>. Variables in our application are stored in RAM, even variables whose contents were initialized from disk files. Thus, assigning the contents of a file to a variable effectively caches it for faster access.</p><p>Moreover, because Node variables are only accessible from the Node process, which from our perspective in the event loop is single-threaded, we don&rsquo;t have to worry about blocking once the file has been loaded. One strategy we can employ is to pre-load our files using synchronous operations, i.e.:</p><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>http</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;http&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;fs&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>html</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readFileSync</span>(<span style=color:#e6db74>&#39;index.html&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>css</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readFileSync</span>(<span style=color:#e6db74>&#39;site.css&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>js</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readFileSync</span>(<span style=color:#e6db74>&#39;site.js&#39;</span>);</span></span></code></pre></div><p>Now we can define our revised event handler, which uses the cached versions:</p><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handleRequest</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>method</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;GET&#34;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>url</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;/index.html&#34;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Serve the index page 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>writeHead</span>(<span style=color:#ae81ff>200</span>, {<span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;text/html&#39;</span>, <span style=color:#e6db74>&#39;Content-Length&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>html</span>.<span style=color:#a6e22e>length</span>}).<span style=color:#a6e22e>end</span>(<span style=color:#a6e22e>html</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;/site.css&#34;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Serve the css file 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>writeHead</span>(<span style=color:#ae81ff>200</span>, {<span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;text/html&#39;</span>, <span style=color:#e6db74>&#39;Content-Length&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>css</span>.<span style=color:#a6e22e>length</span>}).<span style=color:#a6e22e>end</span>(<span style=color:#a6e22e>css</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;/site.js&#34;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Serve the js file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>writeHead</span>(<span style=color:#ae81ff>200</span>, {<span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;text/html&#39;</span>, <span style=color:#e6db74>&#39;Content-Length&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>js</span>.<span style=color:#a6e22e>length</span>}).<span style=color:#a6e22e>end</span>(<span style=color:#a6e22e>js</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Serve a 404 Not Found response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>writeHead</span>(<span style=color:#ae81ff>404</span>).<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Serve a 501 Not Implemented response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>writeHead</span>(<span style=color:#ae81ff>501</span>).<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Finally, we create and start the server:</p><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>createServer</span>(<span style=color:#a6e22e>handleRequest</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>80</span>, ()=&gt;{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Server listening on port 80&#34;</span>);
</span></span><span style=display:flex><span>});</span></span></code></pre></div><p>Notice in this server implementation we use the <em>synchronous</em> <code>fs.readFileSync()</code>, and we don&rsquo;t wrap it in a <code>try ... catch</code>. That means if there is a problem loading one of the files, our Node process will crash. But as these files are loaded <em>first</em>, before the server starts, we should see the error, and realize there is a problem with our site files that needs fixed. This is one instance where it <em>does</em> make sense to use synchronous file calls.</p><p>While caching works well in this instance, like everything in computer science it doesn&rsquo;t work well in all instances. Consider if we had a server with <em>thousands</em> of files - maybe images that were each 500 Megabytes. With only a thousand images, we&rsquo;d have 500 Gigabytes to cache&mldr; which would mean our server would need a <em>lot</em> of expensive RAM. In a case like that, asynchronous file access when the file is requested makes far more sense.</p><p>Also, depending on the use pattern it may make sense to cache <em>some</em> of the most frequently requested images. With careful design, this caching can be dynamic, changing which images are cached based on how frequently they are requested while the server is running.</p><footer class=footline></footer></article></div></main></div><script src=/cis526/js/clipboard/clipboard.min.js?1753540871 defer></script><script src=/cis526/js/perfect-scrollbar/perfect-scrollbar.min.js?1753540871 defer></script><script src=/cis526/js/theme.min.js?1753540871 defer></script></div><script src=/cis526/js/tele-scroll.min.js?1753540871 defer></script></body></html>
<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=html><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.148.1"><meta name=generator content="Relearn 8.0.0"><meta name=description content="Users Routes Now that we have written and tested the routes for the Role model, let’s start working on the routes for the User model. These routes will be much more complex, because we want the ability to add, update, and delete users in our database.
To do this, we’ll create several RESTful routes, which pair HTTP verbs and paths to the various CRUD operations that can be performed on the database. Here is a general list of the actions we want to perform on most models in a RESTful API, based on their associated CRUD operation:"><meta name=author content="Nathan Bean & Russell Feldhausen"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta name=twitter:title content="Retrieve All :: CIS 526 Textbook"><meta name=twitter:description content="Users Routes Now that we have written and tested the routes for the Role model, let’s start working on the routes for the User model. These routes will be much more complex, because we want the ability to add, update, and delete users in our database.
To do this, we’ll create several RESTful routes, which pair HTTP verbs and paths to the various CRUD operations that can be performed on the database. Here is a general list of the actions we want to perform on most models in a RESTful API, based on their associated CRUD operation:"><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/03-rest-api/06-retrieve-all/index.html"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Retrieve All :: CIS 526 Textbook"><meta property="og:description" content="Users Routes Now that we have written and tested the routes for the Role model, let’s start working on the routes for the User model. These routes will be much more complex, because we want the ability to add, update, and delete users in our database.
To do this, we’ll create several RESTful routes, which pair HTTP verbs and paths to the various CRUD operations that can be performed on the database. Here is a general list of the actions we want to perform on most models in a RESTful API, based on their associated CRUD operation:"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="Example Projects"><meta property="article:modified_time" content="2025-03-07T15:34:34-06:00"><meta property="og:image" content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta itemprop=name content="Retrieve All :: CIS 526 Textbook"><meta itemprop=description content="Users Routes Now that we have written and tested the routes for the Role model, let’s start working on the routes for the User model. These routes will be much more complex, because we want the ability to add, update, and delete users in our database.
To do this, we’ll create several RESTful routes, which pair HTTP verbs and paths to the various CRUD operations that can be performed on the database. Here is a general list of the actions we want to perform on most models in a RESTful API, based on their associated CRUD operation:"><meta itemprop=dateModified content="2025-03-07T15:34:34-06:00"><meta itemprop=wordCount content="1822"><meta itemprop=image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><title>Retrieve All :: CIS 526 Textbook</title><link href=https://textbooks.cs.ksu.edu/cis526/x-examples/03-rest-api/06-retrieve-all/index.html rel=canonical type=text/html title="Retrieve All :: CIS 526 Textbook"><link href=/cis526/x-examples/03-rest-api/06-retrieve-all/index.xml rel=alternate type=application/rss+xml title="Retrieve All :: CIS 526 Textbook"><link href=/cis526/x-examples/03-rest-api/06-retrieve-all/index.print.html rel=alternate type=text/html title="Retrieve All :: CIS 526 Textbook"><link href=/cis526/x-examples/03-rest-api/06-retrieve-all/tele.html rel=alternate type=text/html title="Retrieve All :: CIS 526 Textbook"><link href=/cis526/css/auto-complete/auto-complete.min.css?1769117712 rel=stylesheet><script src=/cis526/js/auto-complete/auto-complete.min.js?1769117712 defer></script><script src=/cis526/js/search-lunr.min.js?1769117712 defer></script><script src=/cis526/js/search.min.js?1769117712 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/cis526/searchindex.en.js?1769117712"</script><script src=/cis526/js/lunr/lunr.min.js?1769117712 defer></script><script src=/cis526/js/lunr/lunr.stemmer.support.min.js?1769117712 defer></script><script src=/cis526/js/lunr/lunr.multi.min.js?1769117712 defer></script><script src=/cis526/js/lunr/lunr.en.min.js?1769117712 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1769117712 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1769117712 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar/perfect-scrollbar.min.css?1769117712 rel=stylesheet><link href=/cis526/css/theme.min.css?1769117712 rel=stylesheet><link href=/cis526/css/format-html.min.css?1769117712 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/x-examples/03-rest-api/06-retrieve-all/index.html",window.relearn.relBasePath="../../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!1,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.relearn.themevariants=["light-theme"],window.relearn.customvariantname="my-custom-variant",window.relearn.writeVariant=!1,window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.writeVariant&&window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><link href=/cis526/css/custom.css?1769117712 rel=stylesheet></head><body class="mobile-support embed html" data-url=/cis526/x-examples/03-rest-api/06-retrieve-all/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><div id=R-main-overlay></div><main id=R-body-inner class="highlightable x-examples" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=retrieve-all>Retrieve All</h1><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/DkYVNrXEgn8 style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><h2 id=users-routes>Users Routes</h2><p>Now that we have written and tested the routes for the <code>Role</code> model, let&rsquo;s start working on the routes for the <code>User</code> model. These routes will be much more complex, because we want the ability to add, update, and delete users in our database.</p><p>To do this, we&rsquo;ll create several RESTful routes, which pair HTTP verbs and paths to the various CRUD operations that can be performed on the database. Here is a general list of the actions we want to perform on most models in a RESTful API, based on their associated CRUD operation:</p><ul><li>Create New (HTTP POST)</li><li>Retrieve All / Retrieve One (HTTP GET)</li><li>Update One (HTTP PUT)</li><li>Delete One (HTTP DELETE)</li></ul><p>As we build this new API router, we&rsquo;ll see each one of these in action.</p><h2 id=retrieve-all-route>Retrieve All Route</h2><p>The first operation we&rsquo;ll look at is the <strong>retrieve all</strong> operation, which is one we&rsquo;re already very familiar with. To begin, we should start by copying the existing file at <code>routes/users.js</code> to <code>routes/api/v1/users.js</code> and modifying it a bit to contain this content:</p><div class=tab-panel data-tab-group=2957d0a090061967a76c9c80d79ab9a5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2957d0a090061967a76c9c80d79ab9a5","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file Users router
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @exports router an Express router
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * tags:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   name: users
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   description: Users Routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>express</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;express&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create Express router
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>Router</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import models
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>User</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Role</span>,
</span></span><span style=display:flex><span>} <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../../models/models.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e>// Import logger
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>logger</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../../configs/logger.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Gets the list of users
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} req - Express request object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} res - Express response object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Function} next - Express next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e> * /api/v1/users:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   get:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     summary: users list page
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     description: Gets the list of all users in the application
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     tags: [users]
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     responses:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       200:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         description: the list of users
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         content:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *           application/json:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *             schema:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *               type: array
</span></span></span><span style=display:flex><span><span style=color:#75715e> *               items:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *                 $ref: &#39;#/components/schemas/User&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex;background-color:#3c3d38><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>users</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findAll</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>include</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>model</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Role</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>as</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;roles&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;role&#34;</span>],
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>through</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [],
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>users</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex;background-color:#3c3d38><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>router</span>;</span></span></code></pre></div></div></div></div></div><p>This is very similar to the code we included in our <code>roles</code> route. The major difference is that the <code>users</code> route will also output the list of roles assigned to the user. There is a lot of great information in the <a href=https://sequelize.org/docs/v6/core-concepts/assocs/#basics-of-queries-involving-associations rel=external target=_blank>Sequelize Documentation</a> for how to properly query associated records.</p><p>We&rsquo;ll also need to remove the line from our <code>app.js</code> file that directly imports and uses that router:</p><div class=tab-panel data-tab-group=6f2a9a322e85c68007903054db95b922><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6f2a9a322e85c68007903054db95b922","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import routers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>indexRouter</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./routes/index.js&#34;</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>usersRouter</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./routes/users.js&#34;</span>; <span style=color:#75715e>// delete this line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>apiRouter</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./routes/api.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Use routers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>indexRouter</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/users&#34;</span>, <span style=color:#a6e22e>usersRouter</span>); <span style=color:#75715e>// delete this line
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/api&#34;</span>, <span style=color:#a6e22e>apiRouter</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Instead, we can now import and link the new router in our <code>routes/api.js</code> file:</p><div class=tab-panel data-tab-group=096b47226cb65b6ac54a6ffea97e666e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("096b47226cb65b6ac54a6ffea97e666e","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import v1 routers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>rolesRouter</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./api/v1/roles.js&#34;</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>usersRouter</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./api/v1/users.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create Express router
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>Router</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Use v1 routers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/v1/roles&#34;</span>, <span style=color:#a6e22e>rolesRouter</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/v1/users&#34;</span>, <span style=color:#a6e22e>usersRouter</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Before moving on, let&rsquo;s run our application and make sure that the <code>users</code> route is working correctly:</p><div class=tab-panel data-tab-group=e9e99cc4ea5fe8a251939fcb41a099e4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e9e99cc4ea5fe8a251939fcb41a099e4","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once it loads, we can navigate to the <code>/api/v1/users</code> URL to see the output:</p><p><a href=#R-image-7dd8f3b6ceaec847cb9afa3885d6f034 class=lightbox-link><img alt="Retrieve All Ouptut" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/03/retrieveall_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7dd8f3b6ceaec847cb9afa3885d6f034><img alt="Retrieve All Ouptut" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/03/retrieveall_1.png></a></p><h2 id=retrieve-all-unit-tests>Retrieve All Unit Tests</h2><p>As we write each of these routes, we&rsquo;ll also explore the related unit tests. The first three unit tests for this route are very similar to the ones we wrote for the <code>roles</code> routes earlier, so we won&rsquo;t go into too much detail on these. As expected, we&rsquo;ll place all of the unit tests for the <code>users</code> routes in the <code>test/api/v1/users.js</code> file:</p><div class=tab-panel data-tab-group=097a0b55a4484414ce1f6a428cd89739><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("097a0b55a4484414ce1f6a428cd89739","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file /api/v1/users Route Tests
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Load Libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>request</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;supertest&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>use</span>, <span style=color:#a6e22e>should</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Ajv</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;ajv&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>addFormats</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;ajv-formats&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>chaiJsonSchemaAjv</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai-json-schema-ajv&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>chaiShallowDeepEqual</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai-shallow-deep-equal&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Express application
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>app</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../../app.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Configure Chai and AJV
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ajv</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Ajv</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>addFormats</span>(<span style=color:#a6e22e>ajv</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>chaiJsonSchemaAjv</span>.<span style=color:#a6e22e>create</span>({ <span style=color:#a6e22e>ajv</span>, <span style=color:#a6e22e>verbose</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> }));
</span></span><span style=display:flex><span><span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>chaiShallowDeepEqual</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Modify Object.prototype for BDD style assertions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>should</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// User Schema
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userSchema</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;object&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;username&#34;</span>],
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>properties</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;number&#34;</span> },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;string&#34;</span> },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createdAt</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;string&#34;</span>, <span style=color:#a6e22e>format</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;iso-date-time&#34;</span> },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updatedAt</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;string&#34;</span>, <span style=color:#a6e22e>format</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;iso-date-time&#34;</span> },
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>roles</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;array&#34;</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#a6e22e>items</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex;background-color:#3c3d38><span>          <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;object&#39;</span>,
</span></span><span style=display:flex;background-color:#3c3d38><span>          <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;id&#39;</span>, <span style=color:#e6db74>&#39;role&#39;</span>],
</span></span><span style=display:flex;background-color:#3c3d38><span>          <span style=color:#a6e22e>properties</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex;background-color:#3c3d38><span>              <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;number&#39;</span> },
</span></span><span style=display:flex;background-color:#3c3d38><span>              <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;string&#39;</span> },
</span></span><span style=display:flex;background-color:#3c3d38><span>          },
</span></span><span style=display:flex;background-color:#3c3d38><span>      },
</span></span><span style=display:flex;background-color:#3c3d38><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>additionalProperties</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Get all Users
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getAllUsers</span> <span style=color:#f92672>=</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should list all users&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;array&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>lengthOf</span>(<span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Check JSON Schema of Users
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getUsersSchemaMatch</span> <span style=color:#f92672>=</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;all users should match schema&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>schema</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;array&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>items</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>userSchema</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>jsonSchema</span>(<span style=color:#a6e22e>schema</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Check User exists in list
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>findUser</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should contain &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; user&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>foundUser</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>find</span>((<span style=color:#a6e22e>u</span>) =&gt; <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>foundUser</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>shallowDeepEqual</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// List of all expected users in the application
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>users</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;admin&#34;</span>,
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;contributor&#34;</span>,
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;manager&#34;</span>,
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;user&#34;</span>,
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/users route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>getAllUsers</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>getUsersSchemaMatch</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>u</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>findUser</span>(<span style=color:#a6e22e>u</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>The major difference to note is in the highlighted section, where we have to add some additional schema information to account for the <code>roles</code> associated attribute that is part of the <code>users</code> object. It is pretty self-explanatory; each object in the array has a set of attributes that match what we used in the unit test for the <code>roles</code> routes.</p><p>We also moved the schema for the <code>User</code> response object out of that unit test so we can reuse it in other unit tests, as we&rsquo;ll see later in this example.</p><p>However, we also should add a couple of additional unit tests to confirm that each user has the correct roles assigned, since that is a major part of the security and authorization mechanism we&rsquo;ll be building for this application. While we could do that as part of the <code>findUser</code> test, let&rsquo;s go ahead and add separate tests for each of these, which is helpful in debugging anything that is broken or misconfigured.</p><div class=tab-panel data-tab-group=7b3bec48995194ca71f9d1fbcefae1af><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7b3bec48995194ca71f9d1fbcefae1af","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file /api/v1/users Route Tests
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Load Libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>request</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;supertest&#34;</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>use</span>, <span style=color:#a6e22e>should</span>, <span style=color:#a6e22e>expect</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Ajv</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;ajv&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>addFormats</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;ajv-formats&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>chaiJsonSchemaAjv</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai-json-schema-ajv&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>chaiShallowDeepEqual</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai-shallow-deep-equal&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Check that User has correct number of roles
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>findUserCountRoles</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>count</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;user &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>username</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; should have &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>count</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; roles&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>foundUser</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>find</span>((<span style=color:#a6e22e>u</span>) =&gt; <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>username</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>foundUser</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;array&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>foundUser</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>lengthOf</span>(<span style=color:#a6e22e>count</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Check that User has specific role
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>findUserConfirmRole</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>role</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;user &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>username</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; should have &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>role</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; role&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>foundUser</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>find</span>((<span style=color:#a6e22e>u</span>) =&gt; <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>username</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>foundUser</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>some</span>((<span style=color:#a6e22e>r</span>) =&gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>role</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>role</span>)).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// List of all users and expected roles
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>user_roles</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;admin&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>roles</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;manage_users&#34;</span>, <span style=color:#e6db74>&#34;manage_documents&#34;</span>, <span style=color:#e6db74>&#34;manage_communities&#34;</span>]
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;contributor&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>roles</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;add_documents&#34;</span>, <span style=color:#e6db74>&#34;add_communities&#34;</span>]
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;manager&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>roles</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;manage_documents&#34;</span>, <span style=color:#e6db74>&#34;manage_communities&#34;</span>]
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;user&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>roles</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;view_documents&#34;</span>, <span style=color:#e6db74>&#34;view_communities&#34;</span>]
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/users route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>user_roles</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>u</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Check that user has correct number of roles
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>findUserCountRoles</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>length</span>)
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Check that user has each expected role
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>findUserConfirmRole</span>(<span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>This code uses an additional assertion, <code>expect</code>, from the <code>chai</code> library, so we have to import it at the top on the highlighted line. These two tests will confirm that the user has the expected number of roles, and also explicitly confirm that each user has each of the expected roles.</p><details open class="box cstyle notices tip"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-lightbulb"></i>
Testing Arrays for Containment</summary><div class=box-content><p>When writing unit tests that deal with arrays, it is always important to not only check that the array contains the correct elements, but also that it <strong>ONLY</strong> contains those elements and no additional elements. A great way to do this is to explicitly check each element the array should contain is present, and then <strong>also</strong> check the size of the array so that it can only contain those listed elements. Of course, this assumes that each element is only present once in the array!</p><p>If we aren&rsquo;t careful about how these unit tests are constructed, it is possible for arrays to contain additional items. In this case, it might mean that a user is assigned to more roles than they should be, which would be very bad for our application&rsquo;s security!</p></div></details><p>With all of these tests in place, let&rsquo;s go ahead and run them to confirm everything is working properly. Thankfully, with the <code>mocha</code> test runner, we can even specify a single file to run, as shown below:</p><div class=tab-panel data-tab-group=e9aa2f0727ea50a29fae3c74a63f32ed><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e9aa2f0727ea50a29fae3c74a63f32ed","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm run test test/api/v1/users.js</span></span></code></pre></div></div></div></div></div><p>If everything is correct, we should see that this file has 19 tests that pass:</p><div class=tab-panel data-tab-group=31af6d18e396521d6e71de1bdad93a29><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("31af6d18e396521d6e71de1bdad93a29","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0><code>  /api/v1/users
    GET /
      ✔ should list all users
      ✔ all users should match schema
      ✔ should contain &#39;admin&#39; user
      ✔ should contain &#39;contributor&#39; user
      ✔ should contain &#39;manager&#39; user
      ✔ should contain &#39;user&#39; user
      ✔ user &#39;admin&#39; should have 3 roles
      ✔ user &#39;admin&#39; should have &#39;manage_users&#39; role
      ✔ user &#39;admin&#39; should have &#39;manage_documents&#39; role
      ✔ user &#39;admin&#39; should have &#39;manage_communities&#39; role
      ✔ user &#39;contributor&#39; should have 2 roles
      ✔ user &#39;contributor&#39; should have &#39;add_documents&#39; role
      ✔ user &#39;contributor&#39; should have &#39;add_communities&#39; role
      ✔ user &#39;manager&#39; should have 2 roles
      ✔ user &#39;manager&#39; should have &#39;manage_documents&#39; role
      ✔ user &#39;manager&#39; should have &#39;manage_communities&#39; role
      ✔ user &#39;user&#39; should have 2 roles
      ✔ user &#39;user&#39; should have &#39;view_documents&#39; role
      ✔ user &#39;user&#39; should have &#39;view_communities&#39; role


  19 passing (1s)</code></pre></div></div></div></div></div><p>Great! Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub before continuing.</p><footer class=footline></footer></article></div></main></div><script src=/cis526/js/clipboard/clipboard.min.js?1769117712 defer></script><script src=/cis526/js/perfect-scrollbar/perfect-scrollbar.min.js?1769117712 defer></script><script src=/cis526/js/theme.min.js?1769117712 defer></script><script src=/cis526/js/embed-iframe.min.js?1769117712 defer></script></body></html>
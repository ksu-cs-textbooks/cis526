<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=robots content="noindex, nofollow, noarchive, noimageindex"><meta name=description content="This example project builds on the previous Adding a Database project by using that project to create a RESTful API. That API can be used to access and modify the data in the database. We’ll also add a suite of unit tests to explore our API and ensure that it is working correctly.
Project Deliverables At the end of this example, we will have a project with the following features:"><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="RESTful API :: CIS 526 Textbook"><meta name=twitter:description content="This example project builds on the previous Adding a Database project by using that project to create a RESTful API. That API can be used to access and modify the data in the database. We’ll also add a suite of unit tests to explore our API and ensure that it is working correctly.
Project Deliverables At the end of this example, we will have a project with the following features:"><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/03-rest-api/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="RESTful API :: CIS 526 Textbook"><meta property="og:description" content="This example project builds on the previous Adding a Database project by using that project to create a RESTful API. That API can be used to access and modify the data in the database. We’ll also add a suite of unit tests to explore our API and ensure that it is working correctly.
Project Deliverables At the end of this example, we will have a project with the following features:"><meta property="og:locale" content="en-us"><meta property="og:type" content="website"><meta itemprop=name content="RESTful API :: CIS 526 Textbook"><meta itemprop=description content="This example project builds on the previous Adding a Database project by using that project to create a RESTful API. That API can be used to access and modify the data in the database. We’ll also add a suite of unit tests to explore our API and ensure that it is working correctly.
Project Deliverables At the end of this example, we will have a project with the following features:"><meta itemprop=dateModified content="2025-02-10T11:28:51-06:00"><meta itemprop=wordCount content="133"><title>RESTful API :: CIS 526 Textbook</title>
<link href=/cis526/css/fontawesome-all.min.css?1739565344 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1739565344 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1739565344 rel=stylesheet><link href=/cis526/css/auto-complete.css?1739565344 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1739565344 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1739565344 rel=stylesheet><link href=/cis526/css/fonts.css?1739565344 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1739565344 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1739565344 rel=stylesheet><link href=/cis526/css/theme-auto.css?1739565344 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1739565344 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1739565344 rel=stylesheet><link href=/cis526/css/print.css?1739565344 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1739565344 rel=stylesheet><script src=/cis526/js/variant.js?1739565344></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../..",window.relearn.relBaseUri="../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1739565344 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/x-examples/03-rest-api/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/cis526/x-examples/><span itemprop=name>Example Projects</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>RESTful API</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/02-database/07-another-table/ title="Another Table (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/03-rest-api/01-api-design/ title="API Design (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=restful-api>RESTful API</h1><p>This example project builds on the previous Adding a Database project by using that project to create a <a href=https://en.wikipedia.org/wiki/REST rel=external target=_blank>RESTful API</a>. That API can be used to access and modify the data in the database. We&rsquo;ll also add a suite of unit tests to explore our API and ensure that it is working correctly.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li>A RESTful API with several routes for creating, reading, updating, and deleting (CRUD) data in the database</li><li>Open API Documentation for API Routes</li><li>Full Unit Test Suite with Coverage Metrics</li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of RESTful API</h1><article class=default><header class=headline></header><h1 id=api-design>API Design</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=good-api-design>Good API Design</h2><p>There are many articles online that discuss best practices in API design. For this project, we&rsquo;re going to follow a few of the most common recommendations:</p><ul><li><a href=https://www.postman.com/api-platform/api-versioning/ rel=external target=_blank>API Versioning</a></li><li><a href=https://restfulapi.net/resource-naming/ rel=external target=_blank>Proper Naming Conventions</a></li><li><a href=https://restfulapi.net/http-methods/ rel=external target=_blank>Proper HTTP Methods</a></li><li><a href=https://restfulapi.net/http-status-codes/ rel=external target=_blank>Proper HTTP Status Code Responses</a></li></ul><p>Let&rsquo;s start with the first one - we can easily add a version number to our API&rsquo;s URL paths. This allows us to make breaking changes to the API in the future without breaking any of the current functionality.</p><h2 id=api-versioning>API Versioning</h2><p>Our current application contains data for both a <code>User</code> and a <code>Role</code> model. For this example, we&rsquo;ll begin by adding a set of RESTful API routes to work with the <code>Role</code> model. In order to add proper versioning to our API, we will want these routes visible at the <code>/api/v1/roles</code> path.</p><p>First, we should create the folder structure inside of our <code>routes</code> folder to match the routes used in our API. This means we&rsquo;ll create an <code>api</code> folder, then a <code>v1</code> folder, and finally a <code>roles.js</code> file inside of that folder:</p><p><a href=#R-image-e769ed7de928134c737a562ad57901c2 class=lightbox-link><img alt="API Folder Paths" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/api_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e769ed7de928134c737a562ad57901c2><img alt="API Folder Paths" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/api_1.png></a></p><p>Before we create the content in that file, let&rsquo;s also create a new file in the base <code>routes</code> folder named <code>api.js</code> that will become the base file for all of our API routes:</p><div class=tab-panel data-tab-group=6950e4a136a28ab45770499ea829aef8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6950e4a136a28ab45770499ea829aef8","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file API main router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: api
</span></span></span><span class=line><span class=cl><span class=cm> *   description: API routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import v1 routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>rolesRouter</span> <span class=nx>from</span> <span class=s2>&#34;./api/v1/roles.js&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use v1 routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/v1/roles&#34;</span><span class=p>,</span> <span class=nx>rolesRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of API versions
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: list API versions
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [api]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of users
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: object
</span></span></span><span class=line><span class=cl><span class=cm> *                 properties:
</span></span></span><span class=line><span class=cl><span class=cm> *                   version:
</span></span></span><span class=line><span class=cl><span class=cm> *                     type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                   url: 
</span></span></span><span class=line><span class=cl><span class=cm> *                     type: string
</span></span></span><span class=line><span class=cl><span class=cm> *             example:
</span></span></span><span class=line><span class=cl><span class=cm> *               - version: &#34;1.0&#34;
</span></span></span><span class=line><span class=cl><span class=cm> *                 url: /api/v1/
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v1/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span></span></span></code></pre></div></div></div></div></div><p>This file is very simple - it just outputs all possible API versions (in this case, we just have a single API version). It also imports and uses our new <code>roles</code> router. Finally, it includes some basic Open API documentation for the route it contains. Let&rsquo;s quickly add some basic content to our <code>roles</code> router, based on the existing content in our <code>users</code> router from before:</p><div class=tab-panel data-tab-group=a0fc5cf273bf7f8258cadd1da20dc39b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a0fc5cf273bf7f8258cadd1da20dc39b","routesapiv1rolesjs")'>
<span class=tab-nav-text>routes/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Roles router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: roles
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Roles Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/logger.js&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of roles
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/v1/roles:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: roles list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all roles in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [roles]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of roles
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 $ref: &#39;#/components/schemas/Role&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>Role</span><span class=p>.</span><span class=nx>findAll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Notice that we have added an additional <code>try</code> and <code>catch</code> block to the route function. This will ensure any errors that are thrown by the database get caught and logged without leaking any sensitive data from our API. It is always a good practice to wrap each API method in a <code>try</code> and <code>catch</code> block.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Controllers and Services</div><div class=box-content><p>More complex RESTful API designs may include additional files such as <strong>controllers</strong> and <strong>services</strong> to add additional structure to the application. For example, there might be multiple API routes that access the same method in a controller, which then uses a service to perform business logic on the data before storing it in the database.</p><p>For this example project, we will place most of the functionality directly in our routes to simplify our structure.</p><p>You can read more about how to use controllers and services in the <a href=https://developer.mozilla.org/en-US/docs/Learn_web_development/Extensions/Server-side/Express_Nodejs/routes rel=external target=_blank>MDN Express Tutorial</a>.</p></div></div><p>Since we are creating routes in a new subfolder, we also need to update our Open API configuration in <code>configs/openapi.js</code> so that we can see the documentation contained in those routes:</p><div class=tab-panel data-tab-group=c78e83b8cc8ecaaf4d63d97f95cb8d10><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsopenapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c78e83b8cc8ecaaf4d63d97f95cb8d10","configsopenapijs")'>
<span class=tab-nav-text>configs/openapi.js</span></button></div><div class=tab-content-container><div data-tab-item=configsopenapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Configure SwaggerJSDoc options
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>definition</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>openapi</span><span class=o>:</span> <span class=s2>&#34;3.1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>info</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>title</span><span class=o>:</span> <span class=s2>&#34;Lost Communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>description</span><span class=o>:</span> <span class=s2>&#34;Kansas Lost Communities Project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>servers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>url</span><span class=o>:</span> <span class=nx>url</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>apis</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;./routes/*.js&#34;</span><span class=p>,</span> <span class=s2>&#34;./models/*.js&#34;</span><span class=p>,</span> <span class=s2>&#34;.routes/api/v1/*.js&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>swaggerJSDoc</span><span class=p>(</span><span class=nx>options</span><span class=p>);</span></span></span></code></pre></div></div></div></div></div><p>Now that we&rsquo;ve created these two basic routers, let&rsquo;s get them added to our <code>app.js</code> file so they are accessible to the application:</p><div class=tab-panel data-tab-group=908deb5acb65dfbcd0d97c84767da9ff><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("908deb5acb65dfbcd0d97c84767da9ff","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/index.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/users.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>apiRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/api.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>helmet</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>compression</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use middlewares
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use static files
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s2>&#34;public&#34;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/users&#34;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/api&#34;</span><span class=p>,</span> <span class=nx>apiRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, with everything in place, let&rsquo;s run our application and see if we can access that new route at <code>/api/v1/roles</code>:</p><div class=tab-panel data-tab-group=0b0aa85e65b28cdf674c9c36d1158749><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0b0aa85e65b28cdf674c9c36d1158749","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>If everything is working correctly, we should see our roles listed in the output on that page:</p><p><a href=#R-image-c4d23302942b5a46bb940ae6cfa46cd3 class=lightbox-link><img alt="List of Roles" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/api_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c4d23302942b5a46bb940ae6cfa46cd3><img alt="List of Roles" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/api_2.png></a></p><p>We should also be able to query the list of API versions at the path <code>/api</code>:</p><p><a href=#R-image-7795b9db3298e21a47bbd83d16ef361f class=lightbox-link><img alt="List of API Versions" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/api_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7795b9db3298e21a47bbd83d16ef361f><img alt="List of API Versions" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/api_3.png></a></p><p>Finally, we should also check and make sure our Open API documentation at the <code>/docs</code> path is up to date and includes the new routes:</p><p><a href=#R-image-a8a5bb88a5051c7bf90444880e8ffa64 class=lightbox-link><img alt="API Documentation" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/api_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a8a5bb88a5051c7bf90444880e8ffa64><img alt="API Documentation" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/api_4.png></a></p><p><a href=#R-image-0bf5732b9ab8037595a98300ea84e851 class=lightbox-link><img alt="Roles Documentation" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/api_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0bf5732b9ab8037595a98300ea84e851><img alt="Roles Documentation" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/api_5.png></a></p><p>There! This gives us a platform to build our new API upon. We&rsquo;ll continue throughout this example project to add additional routes to the API as well as related unit tests.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=unit-testing>Unit Testing</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=testing-web-apis>Testing Web APIs</h2><p>Now that we have created our first route in our RESTful API, we can start to write unit tests that will confirm our API works as intended. Adding unit testing early in the development process makes it much easier to keep up with unit tests as new features are added or even explore <a href=https://en.wikipedia.org/wiki/Test-driven_development rel=external target=_blank>test-driven development</a>!</p><p>There are many libraries that can be used to unit test a RESTful API using Node.js and Express. For this project, we&rsquo;re going to use a number of testing libraries:</p><ul><li><a href=https://www.npmjs.com/package/mocha rel=external target=_blank>mocha</a> - Node.js testing framework</li><li><a href=https://www.npmjs.com/package/chai rel=external target=_blank>chai</a> - assertion library</li><li><a href=https://www.npmjs.com/package/supertest rel=external target=_blank>supertest</a> - HTTP request testing framework</li><li><a href=https://www.npmjs.com/package/ajv rel=external target=_blank>ajv</a> - JSON schema validator</li><li><a href=https://www.npmjs.com/package/chai-json-schema-ajv rel=external target=_blank>chai-json-schema-ajv</a> - chai plugin for AJV</li><li><a href=https://www.npmjs.com/package/chai-shallow-deep-equal rel=external target=_blank>chai-shallow-deep-equal</a> - chai plugin for deep equal assertion</li></ul><p>To begin, let&rsquo;s install these libraries as development dependencies in our project using <code>npm</code>:</p><div class=tab-panel data-tab-group=80aba01093d6eb2b5ab759a9e685f2fc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("80aba01093d6eb2b5ab759a9e685f2fc","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install --save-dev mocha chai supertest ajv chai-json-schema-ajv chai-shallow-deep-equal</span></span></code></pre></div></div></div></div></div><p>Now that we have those libraries in place, let&rsquo;s make a few modifications to our project configuration to make testing more convenient.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> ESLint Plugin</div><div class=box-content><p>To help with formatting and highlighting of our unit tests, we should update the content of our <code>eslint.config.js</code> to recognize items from <code>mocha</code> as follows:</p><div class=tab-panel data-tab-group=4c0592a9fd1b4acfa27e09236b1767d7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=eslintconfigjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4c0592a9fd1b4acfa27e09236b1767d7","eslintconfigjs")'>
<span class=tab-nav-text>eslint.config.js</span></button></div><div class=tab-content-container><div data-tab-item=eslintconfigjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>globals</span> <span class=nx>from</span> <span class=s2>&#34;globals&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>pluginJs</span> <span class=nx>from</span> <span class=s2>&#34;@eslint/js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** @type {import(&#39;eslint&#39;).Linter.Config[]} */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>languageOptions</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>globals</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>...</span><span class=nx>globals</span><span class=p>.</span><span class=nx>node</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>...</span><span class=nx>globals</span><span class=p>.</span><span class=nx>mocha</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>rules</span><span class=o>:</span> <span class=p>{</span> <span class=s2>&#34;no-unused-vars&#34;</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;error&#34;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>argsIgnorePattern</span><span class=o>:</span> <span class=s2>&#34;next&#34;</span> <span class=p>}]</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>pluginJs</span><span class=p>.</span><span class=nx>configs</span><span class=p>.</span><span class=nx>recommended</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>];</span></span></span></code></pre></div></div></div></div></div><p>If working properly, this should also fix any errors visible in VS Code using the ESLint plugin!</p></div></div><h2 id=mocha-root-hooks>Mocha Root Hooks</h2><p>In testing frameworks such as <code>mocha</code>, we can create <code>hooks</code> that contain actions that should be taken before each test is executed in a file. The <code>mocha</code> framework also has <a href=https://mochajs.org/#root-hook-plugins rel=external target=_blank>root-level hooks</a> that are actions to be taken before each and every test in every file. We can use a root-level hook to manage setting up a simple database for unit testing, as well as configuring other aspects of our application for testing.</p><p>First, let&rsquo;s create a new <code>test</code> directory in our <code>server</code> folder, and inside of that we&rsquo;ll create a file <code>hooks.js</code> to contain the testing hooks for our application.</p><div class=tab-panel data-tab-group=66a2b96483b229047cb57a96d15e0fc1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhooksjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("66a2b96483b229047cb57a96d15e0fc1","testhooksjs")'>
<span class=tab-nav-text>test/hooks.js</span></button></div><div class=tab-content-container><div data-tab-item=testhooksjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Root Mocha Hooks
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports mochaHooks A Mocha Root Hooks Object
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load environment (must be first)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>dotenvx</span> <span class=nx>from</span> <span class=s2>&#34;@dotenvx/dotenvx&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>dotenvx</span><span class=p>.</span><span class=nx>config</span><span class=p>({</span><span class=nx>path</span><span class=o>:</span> <span class=s2>&#34;.env.test&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;../configs/database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>migrations</span> <span class=nx>from</span> <span class=s1>&#39;../configs/migrations.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>seeds</span> <span class=nx>from</span> <span class=s1>&#39;../configs/seeds.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Root Hook Runs Before Each Test
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>mochaHooks</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Hook runs once before any tests are executed
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>beforeAll</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Test database connection
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>database</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Run migrations
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>migrations</span><span class=p>.</span><span class=nx>up</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span> 
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// Hook runs before each individual test
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>beforeEach</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Seed the database
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>seeds</span><span class=p>.</span><span class=nx>up</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>This file contains two hooks. First, the <code>beforeAll</code> hook, which is executed once before any tests are executed, is used to migrate the database. Then, we have the <code>beforeEach()</code> hook, which is executed before each individual test, which will seed the database with some sample data for us to use in our unit tests.</p><p>Notice at the top that we are also loading our environment from a new environment file, <code>.env.test</code>. This allows us to use a different environment configuration when we perform testing. So, let&rsquo;s create that file and populate it with the following content:</p><div class=tab-panel data-tab-group=23e7786bd4a65e8246590c611784d1ac><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=envtest class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("23e7786bd4a65e8246590c611784d1ac","envtest")'>
<span class=tab-nav-text>.env.test</span></button></div><div class=tab-content-container><div data-tab-item=envtest class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>error
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>http://localhost:3000
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>:memory:
</span></span><span class=line><span class=cl><span class=nv>SEED_DATA</span><span class=o>=</span>false</span></span></code></pre></div></div></div></div></div><p>Here, the two major changes are to switch the log level to <code>error</code> so that we only see errors in the log output, and also to switch the database file to <code>:memory:</code> - a special filename that tells SQLite to create an in-memory database that is excellent for testing.</p><p>At this point, we can start writing our unit tests.</p><h2 id=writing-basic-unit-tests>Writing Basic Unit Tests</h2><p>Let&rsquo;s start with a very simple case - the <code>/api</code> route we created earlier. This is a simple route that only has a single method and outputs a single item, but it already clearly demonstrates how complex unit testing can become.</p><p>For these unit tests, we can create a file <code>api.js</code> in the <code>test</code> folder with the following content:</p><div class=tab-panel data-tab-group=04d34801ece33dd8e5ddad1109ee0226><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("04d34801ece33dd8e5ddad1109ee0226","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s1>&#39;supertest&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;chai&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s1>&#39;chai-json-schema-ajv&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s1>&#39;chai-shallow-deep-equal&#39;</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiJsonSchemaAjv</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>verbose</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}))</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiShallowDeepEqual</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s1>&#39;../app.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Modify Object.prototype for BDD style assertions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>should</span><span class=p>()</span></span></span></code></pre></div></div></div></div></div><p>These lines will import the various libraries required for these unit tests. We&rsquo;ll explore how they work as we build the unit tests, but it is also recommended to read the documentation for each library (linked above) to better understand how each one works together in the various unit tests.</p><p>Now, let&rsquo;s write our first unit test, which can be placed right below those lines in the same file:</p><div class=tab-panel data-tab-group=9ad7436044f72d73878d314def4e4ba2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9ad7436044f72d73878d314def4e4ba2","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all API versions
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllVersions</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should list all API versions&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s1>&#39;array&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;/api&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>This code looks quite a bit different than the code we&rsquo;ve been writing so far. This is because the <code>mocha</code> and <code>chai</code> libraries use the <a href=https://en.wikipedia.org/wiki/Behavior-driven_development rel=external target=_blank>Behavior-Driven Development</a>, or BDD, style for writing unit tests. The core idea is that the unit tests should be somewhat &ldquo;readable&rdquo; by anyone looking at the code. So, it defines functions such as <code>it</code> and <code>describe</code> that are used to structure the unit tests.</p><p>In this example, the <code>getAllVersions</code> function is a unit test function that uses the <code>request</code> library to send a request to our Express <code>app</code> at the <code>/api/</code> path. When the response is received from that request, we expect the HTTP status code to be 200, and the body of that request should be an array with a length of 1. Hopefully it is clear to see all of that just by reading the code in that function.</p><p>The other important concept is the special <code>done</code> function, which is provided as an argument to any unit test function that is testing <a href=https://mochajs.org/#asynchronous-code rel=external target=_blank>asynchronous code</a>. Because of the way asynchronous code is handled, the system cannot automatically determine when all promises have been returned. So, once we are done with the unit test and are not waiting for any further async responses, we need to call the <code>done()</code> method. Notice that we call that both at the end of the function, but also in the <code>if</code> statement that checks for any errors returned from the HTTP request.</p><p>Finally, at the bottom of the file, we have a few <code>describe</code> statements that actually build the structure that runs each unit test. When the tests are executed, only functions called inside of the <code>describe</code> statements will be executed.</p><h2 id=running-unit-tests>Running Unit Tests</h2><p>Now that we have created a simple unit test, let&rsquo;s run it using the <code>mocha</code> test framework. To do this, we&rsquo;ll add a new script to the <code>package.json</code> file with all of the appropriate options:</p><div class=tab-panel data-tab-group=2085d646139036c4de96b1f83babc752><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2085d646139036c4de96b1f83babc752","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;nodemon ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;lint&#34;</span><span class=p>:</span> <span class=s2>&#34;npx eslint --fix .&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;format&#34;</span><span class=p>:</span> <span class=s2>&#34;npx prettier . --write&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;test&#34;</span><span class=p>:</span> <span class=s2>&#34;mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Here, we are using the <code>mocha</code> command with many options:</p><ul><li><code>--require test/hooks.js</code> - this requires the global hooks file to be used before each test</li><li><code>--recursive</code> - this will recursively look for any tests in subdirectories</li><li><code>--parallel</code> - this allows tests to run in parallel (this requires the SQLite in-memory database)</li><li><code>--timeout 2000</code> - this will stop any test if it runs for more than 2 seconds</li><li><code>--exit</code> - this forces Mocha to stop after all tests have finished</li></ul><p>So, now let&rsquo;s run our tests using that script:</p><div class=tab-panel data-tab-group=b5043b05e04d3df0339bc7135cbfc275><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b5043b05e04d3df0339bc7135cbfc275","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run test</span></span></code></pre></div></div></div></div></div><p>If everything is working correctly, we should get the following output:</p><div class=tab-panel data-tab-group=f74a464ba6b8fc62d4ca0bb5784d7e6a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f74a464ba6b8fc62d4ca0bb5784d7e6a","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; lost-communities-solution@0.0.1 test
&gt; mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit

[dotenvx@1.34.0] injecting env (6) from .env.test

[dotenvx@1.34.0] injecting env (0) from .env.test
[dotenvx@1.34.0] injecting env (0) from .env

  /api
    GET /
      ✔ should list all API versions


  1 passing (880ms)</code></pre></div></div></div></div></div><p>Great! It looks like our test already passed!</p><p>Just to be sure, let&rsquo;s quickly modify our test to look for an array of size <code>2</code> so that it should fail:</p><div class=tab-panel data-tab-group=b88f4204a2b07aee32f8051e70f2f919><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b88f4204a2b07aee32f8051e70f2f919","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all API versions
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllVersions</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should list all API versions&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s1>&#39;array&#39;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we run the tests, we should clearly see a failure report instead:</p><div class=tab-panel data-tab-group=7d8ea0e0029df992373391eacb800281><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7d8ea0e0029df992373391eacb800281","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; lost-communities-solution@0.0.1 test
&gt; mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit

[dotenvx@1.34.0] injecting env (6) from .env.test

[dotenvx@1.34.0] injecting env (0) from .env.test
[dotenvx@1.34.0] injecting env (0) from .env

  /api
    GET /
      1) should list all API versions


  0 passing (910ms)
  1 failing

  1) /api
       GET /
         should list all API versions:

      Uncaught AssertionError: expected [ { version: &#39;1.0&#39;, url: &#39;/api/v1/&#39; } ] to have a length of 2 but got 1
      + expected - actual

      -1
      +2
      
      at Test.&lt;anonymous&gt; (file:///workspaces/lost-communities-solution/server/test/api.js:31:30)
      at Test.assert (node_modules/supertest/lib/test.js:172:8)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)
      at Object.onceWrapper (node:events:638:28)
      at Server.emit (node:events:524:28)
      at emitCloseNT (node:net:2383:8)
      at process.processTicksAndRejections (node:internal/process/task_queues:89:21)</code></pre></div></div></div></div></div><p>Thankfully, anytime a test fails, we get a very clear and easy to follow error report that pinpoints exactly which line in the test failed, and how the assertion was not met.</p><p>Before moving on, let&rsquo;s update our test so that it should pass again.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=code-coverage>Code Coverage</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=code-coverage>Code Coverage</h2><p>It is often helpful to examine the <a href=https://en.wikipedia.org/wiki/Code_coverage rel=external target=_blank>code coverage</a> of our unit tests. Thankfully, there is an easy way to enable that in our project using the <a href=https://www.npmjs.com/package/c8 rel=external target=_blank>c8</a> library. So, we can start by installing it:</p><div class=tab-panel data-tab-group=afa347f4672649bcc6bb3a0d615663e9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("afa347f4672649bcc6bb3a0d615663e9","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install --save-dev c8</span></span></code></pre></div></div></div></div></div><p>Once it is installed, we can simply add it to a new script in the <code>package.json</code> file that will run our tests with code coverage:</p><div class=tab-panel data-tab-group=916f90a613df4796211704e022d2bb30><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("916f90a613df4796211704e022d2bb30","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;nodemon ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;lint&#34;</span><span class=p>:</span> <span class=s2>&#34;npx eslint --fix .&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;format&#34;</span><span class=p>:</span> <span class=s2>&#34;npx prettier . --write&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;test&#34;</span><span class=p>:</span> <span class=s2>&#34;mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;cov&#34;</span><span class=p>:</span> <span class=s2>&#34;c8 --reporter=html --reporter=text mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>All we have to do is add the <code>c8</code> command with a few options in front of our existing <code>mocha</code> command.</p><p>Now, we can run our tests with code coverage using this script:</p><div class=tab-panel data-tab-group=c5b068c6fcc447812c88280e52eb163b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c5b068c6fcc447812c88280e52eb163b","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run cov</span></span></code></pre></div></div></div></div></div><p>This time, we&rsquo;ll see a bunch of additional output on the terminal</p><div class=tab-panel data-tab-group=69048c22ed1c7225a8fdbcefe50b1908><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("69048c22ed1c7225a8fdbcefe50b1908","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; lost-communities-solution@0.0.1 cov
&gt; c8 --reporter=html --reporter=text mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit

[dotenvx@1.34.0] injecting env (6) from .env.test

[dotenvx@1.34.0] injecting env (0) from .env.test
[dotenvx@1.34.0] injecting env (0) from .env

  /api
    GET /
      ✔ should list all API versions


  1 passing (1s)

------------------------|---------|----------|---------|---------|-------------------------------------------
File                    | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                         
------------------------|---------|----------|---------|---------|-------------------------------------------
All files               |   93.53 |    83.33 |   55.55 |   93.53 |                                           
 server                 |   88.52 |       50 |     100 |   88.52 |                                           
  app.js                |   88.52 |       50 |     100 |   88.52 | 53-59                                     
 server/configs         |   91.86 |    47.36 |     100 |   91.86 |                                           
  database.js           |     100 |      100 |     100 |     100 |                                           
  logger.js             |   85.56 |    30.76 |     100 |   85.56 | 24-25,27-28,30-31,33-34,36-37,39-40,42-43 
  migrations.js         |     100 |      100 |     100 |     100 |                                           
  openapi.js            |   92.85 |    66.66 |     100 |   92.85 | 19-21                                     
  seeds.js              |     100 |      100 |     100 |     100 |                                           
 server/middlewares     |     100 |      100 |     100 |     100 |                                           
  request-logger.js     |     100 |      100 |     100 |     100 |                                           
 server/migrations      |   96.07 |      100 |      50 |   96.07 |                                           
  00_users.js           |   95.55 |      100 |      50 |   95.55 | 44-45                                     
  01_roles.js           |   94.91 |      100 |      50 |   94.91 | 57-59                                     
  02_counties.js        |   96.61 |      100 |      50 |   96.61 | 58-59                                     
  03_communities.js     |   96.61 |      100 |      50 |   96.61 | 58-59                                     
  04_metadata.js        |   96.66 |      100 |      50 |   96.66 | 88-90                                     
  05_documents.js       |   95.71 |      100 |      50 |   95.71 | 68-70                                     
 server/models          |     100 |      100 |     100 |     100 |                                           
  community.js          |     100 |      100 |     100 |     100 |                                           
  county.js             |     100 |      100 |     100 |     100 |                                           
  document.js           |     100 |      100 |     100 |     100 |                                           
  metadata.js           |     100 |      100 |     100 |     100 |                                           
  metadata_community.js |     100 |      100 |     100 |     100 |                                           
  metadata_document.js  |     100 |      100 |     100 |     100 |                                           
  models.js             |     100 |      100 |     100 |     100 |                                           
  role.js               |     100 |      100 |     100 |     100 |                                           
  user.js               |     100 |      100 |     100 |     100 |                                           
  user_role.js          |     100 |      100 |     100 |     100 |                                           
 server/routes          |   68.72 |      100 |     100 |   68.72 |                                           
  api.js                |     100 |      100 |     100 |     100 |                                           
  index.js              |   97.43 |      100 |     100 |   97.43 | 36                                        
  users.js              |    46.8 |      100 |     100 |    46.8 | 52-62,66-73,77-91,95-105,109-138          
 server/routes/api/v1   |   87.71 |      100 |     100 |   87.71 |                                           
  roles.js              |   87.71 |      100 |     100 |   87.71 | 48-54                                     
 server/seeds           |   95.09 |      100 |      50 |   95.09 |                                           
  00_users.js           |   96.36 |      100 |      50 |   96.36 | 54-55                                     
  01_roles.js           |   97.36 |      100 |      50 |   97.36 | 112-114                                   
  02_counties.js        |   95.83 |      100 |      50 |   95.83 | 47-48                                     
  03_communities.js     |   95.65 |      100 |      50 |   95.65 | 45-46                                     
  04_metadata.js        |   89.39 |      100 |      50 |   89.39 | 60-66                                     
  05_documents.js       |   94.82 |      100 |      50 |   94.82 | 56-58</code></pre></div></div></div></div></div><p>Right away we see that a large part of our application achieves 100% code coverage with a single unit test! This highlights both how tightly interconnected all parts of our application are (such that a single unit test exercises much of the code) but also that code coverage can be a very poor metric for unit test quality (seeing this result we might suspect our application is already well tested with just a single unit test).</p><p>We have also enabled the <code>html</code> reporter, so we can see similar results in a <code>coverage</code> folder that appears inside of our <code>server</code> folder. We can use various VS Code Extensions such as <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.live-server" rel=external target=_blank>Live Preview</a> to view that file in our web browser.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Port Conflict</div><div class=box-content><p>The Live Preview extension defaults to port 3000, so we recommend digging into the settings and changing the default port to something else before using it.</p></div></div><p><a href=#R-image-dbd2718782522fe0868887a0c4c1f31d class=lightbox-link><img alt="Coverage Example" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/coverage_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-dbd2718782522fe0868887a0c4c1f31d><img alt="Coverage Example" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/coverage_1.png></a></p><p>In either case, we can see that we&rsquo;ve already reached 100% coverage on our <code>routes/api.js</code> file. However, as we&rsquo;ll see in the next section, that doesn&rsquo;t always mean that we are done writing our unit tests.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=other-tests>Other Tests</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=testing-for-other-issues>Testing for Other Issues</h2><p>Let&rsquo;s consider the scenario where our <code>routes/api.js</code> file was modified slightly to have some incorrect code in it:</p><div class=tab-panel data-tab-group=f3a363330d7d6230a9ef80f636b95623><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f3a363330d7d6230a9ef80f636b95623","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>versoin</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/ver1/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>In this example, we have misspelled the <code>version</code> attribute, and also used an incorrect URL for that version of the API. Unfortunately, if we actually make that change to our code, our existing unit test will not catch either error!</p><p>So, let&rsquo;s look at how we can go about catching these errors and ensuring our unit tests are actually valuable.</p><h2 id=json-schemas>JSON Schemas</h2><p>First, it is often helpful to validate the schema of the JSON output by our API. To do that, we&rsquo;ve installed the <code>ajv</code> JSON schema validator and a <code>chai</code> plugin for using it in a unit test. So, in our <code>test/api.js</code> file, we can add a new test:</p><div class=tab-panel data-tab-group=604caf7ac317e335ee18f6d3dbb65dd7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("604caf7ac317e335ee18f6d3dbb65dd7","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check JSON Schema of API Versions
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllVersionsSchemaMatch</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;all API versions should match schema&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>schema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;array&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>items</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;object&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>required</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;version&#39;</span><span class=p>,</span> <span class=s1>&#39;url&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>properties</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>version</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;string&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>url</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;string&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>additionalProperties</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>jsonSchema</span><span class=p>(</span><span class=nx>schema</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;/api&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersionsSchemaMatch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>In this test, we create a JSON schema following the <a href=https://ajv.js.org/json-schema.html rel=external target=_blank>AJV Instructions</a> that defines the various attributes that should be present in the output. It is especially important to include the <code>additionalProperties: false</code> line, which helps prevent leaking any unintended attributes.</p><p>Now, when we run our tests, we should see that this test fails:</p><div class=tab-panel data-tab-group=124a6a0a2f1eaa4d0349985936ab05c2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("124a6a0a2f1eaa4d0349985936ab05c2","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api
    GET /
      ✔ should list all API versions
      1) all API versions should match schema


  1 passing (1s)
  1 failing

  1) /api
       GET /
         all API versions should match schema:
     Uncaught AssertionError: expected [ { versoin: &#39;1.0&#39;, …(1) } ] to match json-schema
[ { instancePath: &#39;/0&#39;, …(7) } ]
      at Test.&lt;anonymous&gt; (file:///workspaces/lost-communities-solution/server/test/api.js:59:28)
...</code></pre></div></div></div></div></div><p>As we can see, the misspelled <code>version</code> attribute will not match the given schema, causing the test to fail! That shows the value of such a unit test in our code.</p><h2 id=protecting-attributes>Protecting Attributes</h2><p>Let&rsquo;s update our route to include the correct attributes, but also add an additional item that shouldn&rsquo;t be present in the output:</p><div class=tab-panel data-tab-group=badce7168cdc31585548fa6491784d49><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("badce7168cdc31585548fa6491784d49","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/ver1/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>secure_data</span><span class=o>:</span> <span class=s2>&#34;This should not be shared!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>This is an example of <a href=https://owasp.org/API-Security/editions/2023/en/0xa3-broken-object-property-level-authorization/ rel=external target=_blank>Broken Object Properly Level Authorization</a>, one of the top 10 most common API security risks according to OWASP. Often our database models will include attributes that we don&rsquo;t want to expose to our users, so we want to make sure they aren&rsquo;t included in the output by accident.</p><p>If we run our test again, it should also fail:</p><div class=tab-panel data-tab-group=f230d095fc124bbeddc55434801fe0d6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f230d095fc124bbeddc55434801fe0d6","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api
    GET /
      ✔ should list all API versions
      1) all API versions should match schema


  1 passing (1s)
  1 failing

  1) /api
       GET /
         all API versions should match schema:
     Uncaught AssertionError: expected [ { version: &#39;1.0&#39;, …(2) } ] to match json-schema
[ { instancePath: &#39;/0&#39;, …(7) } ]
      at Test.&lt;anonymous&gt; (file:///workspaces/lost-communities-solution/server/test/api.js:59:28)
...</code></pre></div></div></div></div></div><p>However, if we remove the line <code>additionalProperties: false</code> from our JSON schema unit test, it will now succeed. So, it is always important for us to remember to include that line in all of our JSON schemas if we want to avoid this particular security flaw.</p><h2 id=checking-values>Checking Values</h2><p>However, we still have not caught our incorrect value in our API output:</p><div class=tab-panel data-tab-group=77240dc42588fec0b2e5b5fc0b58dc2e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("77240dc42588fec0b2e5b5fc0b58dc2e","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/ver1/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>secure_data</span><span class=o>:</span> <span class=s2>&#34;This should not be shared!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>For this, we need to write one additional unit test to check the actual content of the output. For this, we&rsquo;ll use a deep equality plugin for <code>chai</code>:</p><div class=tab-panel data-tab-group=a5d3ae1bd81cd77c9ec49b8972c88fe6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a5d3ae1bd81cd77c9ec49b8972c88fe6","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check API version exists in list
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>findVersion</span> <span class=o>=</span> <span class=p>(</span><span class=nx>version</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should contain specific version&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>foundVersion</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>v</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>v</span><span class=p>.</span><span class=nx>version</span> <span class=o>===</span> <span class=nx>version</span><span class=p>.</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>foundVersion</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;/api&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersionsSchemaMatch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;version: 1.0&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>version</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v1/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>findVersion</span><span class=p>(</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>The <code>findVersion</code> unit test will check the actual contents of the output received from the API and compare it to the <code>version</code> object that is provided as input. In our <code>describe</code> statements below, we can see how easy it is to define a simple version object that we can use to compare to the output.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Use the Source!</div><div class=box-content><p>One common mistake when writing these unit tests is to simply copy the object structure from the code that is being tested. This is considered <strong>bad practice</strong> since it virtually guarantee that any typos or mistakes are not caught. Instead, when constructing these unit tests, we should always go back to the original source document, typically a design document or API specification, and build our unit tests using that as a guide. This will ensure that our tests will actually catch things such as typos or missing data.</p></div></div><p>With that test in place, we should once again have a unit test that fails:</p><div class=tab-panel data-tab-group=1ab3036a1cb991742a99e6c40b18fc76><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1ab3036a1cb991742a99e6c40b18fc76","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api
    GET /
      ✔ should list all API versions
      ✔ all API versions should match schema
    version: 1.0
      GET /
        1) should contain specific version


  2 passing (987ms)
  1 failing

  1) /api
       version: 1.0
         GET /
           should contain specific version:

      Uncaught AssertionError: Expected to have &#34;/api/v1/&#34; but got &#34;/api/ver1/&#34; at path &#34;/url&#34;.
      + expected - actual

       {
      -  &#34;url&#34;: &#34;/api/ver1/&#34;
      +  &#34;url&#34;: &#34;/api/v1/&#34;
         &#34;version&#34;: &#34;1.0&#34;
       }
      
      at Test.&lt;anonymous&gt; (file:///workspaces/lost-communities-solution/server/test/api.js:76:29)</code></pre></div></div></div></div></div><p>Thankfully, in the output we clearly see the error, and it is easy to go back to our original design document to correct the error in our code.</p><h2 id=reusing-tests>Reusing Tests</h2><p>While it may seem like we are using a very complex structure for these tests, there is actually a very important reason behind it. If done correctly, we can easily reuse most of our tests as we add additional data to the application.</p><p>Let&rsquo;s consider the scenario where we add a second API version to our output:</p><div class=tab-panel data-tab-group=5fdd99e66cb82dc5fc87e868b01d1e1e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5fdd99e66cb82dc5fc87e868b01d1e1e","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v1/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v2/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>To fully test this, all we need to do is update the array size in the <code>getAllVersions</code> and add an additional <code>describe</code> statement for the new version:</p><div class=tab-panel data-tab-group=d7b3fa1a28f8ea1ea7a7e39de9045a77><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d7b3fa1a28f8ea1ea7a7e39de9045a77","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all API versions
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllVersions</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should list all API versions&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s1>&#39;array&#39;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;/api&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersionsSchemaMatch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;version: 1.0&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>version</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v1/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>findVersion</span><span class=p>(</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;version: 2.0&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=kd>let</span> <span class=nx>version</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v2/&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl>    <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>findVersion</span><span class=p>(</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>With those minor changes, we see that our code now passes all unit tests:</p><div class=tab-panel data-tab-group=b303a9e700dddc6ff57c10f89f3a0705><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b303a9e700dddc6ff57c10f89f3a0705","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api
    GET /
      ✔ should list all API versions
      ✔ all API versions should match schema
    version: 1.0
      GET /
        ✔ should contain specific version
    version: 2.0
      GET /
        ✔ should contain specific version</code></pre></div></div></div></div></div><p>By writing reusable functions for our unit tests, we can often deduplicate and simplify our code.</p><p>Before moving on, let&rsquo;s roll back our unit tests and the API to just have a single version. We should make sure all tests are passing before we move ahead!</p><footer class=footline></footer></article></section></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/b3439ded682585a9b9c1f59a9a44905b31ef6760>Feb 10, 2025</a></p></div></div><script src=/cis526/js/clipboard.min.js?1739565344 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1739565344 defer></script><script src=/cis526/js/theme.js?1739565344 defer></script></body></html>
<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=html><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.148.1"><meta name=generator content="Relearn 8.0.0"><meta name=description content="YouTube Video Manual Testing with Open API Before we start unit testing this route, let’s quickly do some manual testing using the Open API documentation site. It is truly a very handy way to work with our RESTful APIs as we are developing them, allowing us to test them quickly in isolation to make sure everything is working properly.
So, let’s start our server:
​ terminal $ npm run dev Once it starts, we can navigate to the /docs URL, and we should see the Open API documentation for our site, including a new POST route for the users section:"><meta name=author content="Nathan Bean & Russell Feldhausen"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta name=twitter:title content="Testing Create :: CIS 526 Textbook"><meta name=twitter:description content="YouTube Video Manual Testing with Open API Before we start unit testing this route, let’s quickly do some manual testing using the Open API documentation site. It is truly a very handy way to work with our RESTful APIs as we are developing them, allowing us to test them quickly in isolation to make sure everything is working properly.
So, let’s start our server:
​ terminal $ npm run dev Once it starts, we can navigate to the /docs URL, and we should see the Open API documentation for our site, including a new POST route for the users section:"><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/03-rest-api/09-testing-create/index.html"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Testing Create :: CIS 526 Textbook"><meta property="og:description" content="YouTube Video Manual Testing with Open API Before we start unit testing this route, let’s quickly do some manual testing using the Open API documentation site. It is truly a very handy way to work with our RESTful APIs as we are developing them, allowing us to test them quickly in isolation to make sure everything is working properly.
So, let’s start our server:
​ terminal $ npm run dev Once it starts, we can navigate to the /docs URL, and we should see the Open API documentation for our site, including a new POST route for the users section:"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="Example Projects"><meta property="article:modified_time" content="2025-03-07T15:34:34-06:00"><meta property="og:image" content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta itemprop=name content="Testing Create :: CIS 526 Textbook"><meta itemprop=description content="YouTube Video Manual Testing with Open API Before we start unit testing this route, let’s quickly do some manual testing using the Open API documentation site. It is truly a very handy way to work with our RESTful APIs as we are developing them, allowing us to test them quickly in isolation to make sure everything is working properly.
So, let’s start our server:
​ terminal $ npm run dev Once it starts, we can navigate to the /docs URL, and we should see the Open API documentation for our site, including a new POST route for the users section:"><meta itemprop=dateModified content="2025-03-07T15:34:34-06:00"><meta itemprop=wordCount content="1824"><meta itemprop=image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><title>Testing Create :: CIS 526 Textbook</title><link href=https://textbooks.cs.ksu.edu/cis526/x-examples/03-rest-api/09-testing-create/index.html rel=canonical type=text/html title="Testing Create :: CIS 526 Textbook"><link href=/cis526/x-examples/03-rest-api/09-testing-create/index.xml rel=alternate type=application/rss+xml title="Testing Create :: CIS 526 Textbook"><link href=/cis526/x-examples/03-rest-api/09-testing-create/index.print.html rel=alternate type=text/html title="Testing Create :: CIS 526 Textbook"><link href=/cis526/x-examples/03-rest-api/09-testing-create/embed.html rel=alternate type=text/html title="Testing Create :: CIS 526 Textbook"><link href=/cis526/css/auto-complete/auto-complete.min.css?1769117712 rel=stylesheet><script src=/cis526/js/auto-complete/auto-complete.min.js?1769117712 defer></script><script src=/cis526/js/search-lunr.min.js?1769117712 defer></script><script src=/cis526/js/search.min.js?1769117712 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/cis526/searchindex.en.js?1769117712"</script><script src=/cis526/js/lunr/lunr.min.js?1769117712 defer></script><script src=/cis526/js/lunr/lunr.stemmer.support.min.js?1769117712 defer></script><script src=/cis526/js/lunr/lunr.multi.min.js?1769117712 defer></script><script src=/cis526/js/lunr/lunr.en.min.js?1769117712 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1769117712 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1769117712 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar/perfect-scrollbar.min.css?1769117712 rel=stylesheet><link href=/cis526/css/theme.min.css?1769117712 rel=stylesheet><link href=/cis526/css/format-html.min.css?1769117712 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/x-examples/03-rest-api/09-testing-create/index.html",window.relearn.relBasePath="../../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!1,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.relearn.themevariants=["light-theme"],window.relearn.customvariantname="my-custom-variant",window.relearn.writeVariant=!1,window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.writeVariant&&window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><link href=/cis526/css/custom.css?1769117712 rel=stylesheet></head><body class="mobile-support html" data-url=/cis526/x-examples/03-rest-api/09-testing-create/index.html><div id=tele class="tele mirror"><div id=R-body class=default-animation><div id=R-body-overlay></div><div id=R-main-overlay></div><main id=R-body-inner class="highlightable x-examples" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=testing-create>Testing Create</h1><a href="https://www.youtube.com/watch?v=37eMKTRxQi4">YouTube Video</a><h2 id=manual-testing-with-open-api>Manual Testing with Open API</h2><p>Before we start unit testing this route, let&rsquo;s quickly do some manual testing using the Open API documentation site. It is truly a very handy way to work with our RESTful APIs as we are developing them, allowing us to test them quickly in isolation to make sure everything is working properly.</p><p>So, let&rsquo;s start our server:</p><div class=tab-panel data-tab-group=ff40944f6d96537d42275723f7d7737b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ff40944f6d96537d42275723f7d7737b","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once it starts, we can navigate to the <code>/docs</code> URL, and we should see the Open API documentation for our site, including a new <code>POST</code> route for the <code>users</code> section:</p><p><a href=#R-image-993c3e28979fb9d763d2b3e3c24f2472 class=lightbox-link><img alt="Create API Documentation" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/03/create_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-993c3e28979fb9d763d2b3e3c24f2472><img alt="Create API Documentation" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/03/create_1.png></a></p><p>If we documented our route correctly, we can see that this documentation includes not only an example for what a new submission should look like, but also examples of the <strong>success</strong> and <strong>model validation error</strong> outputs should be. To test it, we can use the <strong>Try it out</strong> button on the page to try to create a new user.</p><p><a href=#R-image-f8d7b1a5d9baa10cc72d15a41e456f38 class=lightbox-link><img alt="Create Example" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/03/create_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f8d7b1a5d9baa10cc72d15a41e456f38><img alt="Create Example" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/03/create_2.png></a></p><p>Let&rsquo;s go ahead and try to create the user that is suggested by our example input, which should look like this:</p><div class=tab-panel data-tab-group=44fb1b1f2090b3284d7f6a51b209ecb4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=input class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("44fb1b1f2090b3284d7f6a51b209ecb4","input")'>
<span class=tab-nav-text>input</span></button></div><div class=tab-content-container><div data-tab-item=input class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;newuser&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;roles&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div></div><p>This would create a user with the username <code>newuser</code> and assign them to the roles with IDs 6 (<code>view_documents</code>) and 7 (<code>view_communities</code>). So, we can click the <strong>Execute</strong> button to send that request to the server and see if it works.</p><p><a href=#R-image-4d68420ab131080016ad5c4479b2560d class=lightbox-link><img alt="Create Success" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/03/create_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4d68420ab131080016ad5c4479b2560d><img alt="Create Success" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/03/create_3.png></a></p><p>Excellent! We can see that it worked correctly, and we received our expected success message as part of the response. We can also scroll up and try the <code>GET /api/v1/users</code> API endpoint to see if that user appears in our list of all users in the system with the correct roles assigned. If we do, we should see this in the output:</p><div class=tab-panel data-tab-group=08cff92edc75e4992416c19e72289e9e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("08cff92edc75e4992416c19e72289e9e","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>6</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;newuser&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;createdAt&#34;</span>: <span style=color:#e6db74>&#34;2025-02-21T18:34:54.725Z&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;updatedAt&#34;</span>: <span style=color:#e6db74>&#34;2025-02-21T18:34:54.725Z&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;roles&#34;</span>: [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>6</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;view_documents&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>7</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;view_communities&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  }</span></span></code></pre></div></div></div></div></div><p>From here, we can try a couple of different scenarios to see if our server is working properly.</p><h3 id=duplicate-username>Duplicate Username</h3><p>First, what if we try and create a user with a duplicate username? To test this, we can simply resubmit the default example again and see what happens. This time, we get an HTTP 422 response code with a very detailed error message:</p><p><a href=#R-image-2eb05e7b583202e5daa13c98ad81ed8a class=lightbox-link><img alt="Create Failure - Duplicate Username" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/03/create_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2eb05e7b583202e5daa13c98ad81ed8a><img alt="Create Failure - Duplicate Username" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/03/create_4.png></a></p><p>This is great! It tells us exactly what the error is. This is the output created by our <code>handleValidationError</code> utility function from the previous page.</p><h3 id=missing-attributes>Missing Attributes</h3><p>We can also try to submit a new user, but this time we can accidentally leave out some of the attributes, as in this example:</p><div class=tab-panel data-tab-group=20885d42a955e909deba6ba966179f9a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=input class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("20885d42a955e909deba6ba966179f9a","input")'>
<span class=tab-nav-text>input</span></button></div><div class=tab-content-container><div data-tab-item=input class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;user&#34;</span>: <span style=color:#e6db74>&#34;testuser&#34;</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div></div><p>Here, we have mistakenly renamed the <code>username</code> attribute to just <code>user</code>, and we&rsquo;ve left off the <code>roles</code> list entirely. When we submit this, we also get a helpful error message:</p><p><a href=#R-image-14d02632aad33fe15007cd4a82eebffe class=lightbox-link><img alt="Create Failure - Username Null" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/03/create_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-14d02632aad33fe15007cd4a82eebffe><img alt="Create Failure - Username Null" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/03/create_5.png></a></p><p>Since the <code>username</code> attribute was not provided, it will be set to <code>null</code> and the database will not allow a <code>null</code> value for that attribute.</p><p>However, if we correct that, we do see that it will accept a new user without any listed roles! This is by design, since we may need to create users that don&rsquo;t have any roles assigned.</p><h3 id=invalid-roles>Invalid Roles</h3><p>Finally, what if we try to create a user with an invalid list of roles:</p><div class=tab-panel data-tab-group=7336a41b376d02d3b6320f9656a10e6c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=input class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7336a41b376d02d3b6320f9656a10e6c","input")'>
<span class=tab-nav-text>input</span></button></div><div class=tab-content-container><div data-tab-item=input class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;username&#34;</span>: <span style=color:#e6db74>&#34;baduser&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;roles&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div></div></div></div><p>In this instance, we&rsquo;ll get another helpful error message:</p><p><a href=#R-image-cf9fbde1462c335fe6cadf0e5decf9ac class=lightbox-link><img alt="Create Failure - Role Null" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/03/create_6.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-cf9fbde1462c335fe6cadf0e5decf9ac><img alt="Create Failure - Role Null" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/03/create_6.png></a></p><p>Since there is no role with ID 8 in the database, it finds a <code>null</code> value instead and tries to associate that with our user. This causes an SQL constraint error, which we can send back to our user.</p><p>Finally, we should also double-check that our user <code>baduser</code> was not created using <code>GET /api/v1/users</code> API endpoint above. This is because we don&rsquo;t want to create that user unless a list of valid roles are also provided.</p><h2 id=unit-testing>Unit Testing</h2><p>Now that we have a good handle on how this endpoint works in practice, let&rsquo;s write some unit tests to confirm that it works as expected in each of these cases. First, we should have a simple unit test that successfully creates a new user:</p><div class=tab-panel data-tab-group=4e9786c7e8b3d30a5a5452313b7ca255><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4e9786c7e8b3d30a5a5452313b7ca255","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Creates a user successfully
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>createUser</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should successfully create a user &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/api/v1/users/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>201</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;object&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;message&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;id&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>created_id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Find user in list of all users
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>foundUser</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>find</span>(
</span></span><span style=display:flex><span>              (<span style=color:#a6e22e>u</span>) =&gt; <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>created_id</span>,
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>foundUser</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>shallowDeepEqual</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// New user structure for creating users
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>new_user</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;test_user&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>roles</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/users route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;POST /&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUser</span>(<span style=color:#a6e22e>new_user</span>);
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>This first test is very straightforward since it just confirms that we can successfully create a new user in the system. It also confirms that the user now appears in the output from the <strong>get all</strong> route, which is helpful.</p><p>While this at least confirms that the route works as expected, we should write several more unit tests to confirm that the route works correctly even if the user provides invalid input.</p><h3 id=missing-attributes-1>Missing Attributes</h3><p>First, we should confirm that the user will be created even with the list of roles missing. We can do this just by creating a second <code>new_user</code> object that is missing the list of roles.</p><div class=tab-panel data-tab-group=49ef9f5930e675ae91169050c203439c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("49ef9f5930e675ae91169050c203439c","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// New user structure for creating users without roles
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>new_user_no_roles</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;test_user_no_roles&#34;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/users route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;POST /&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUser</span>(<span style=color:#a6e22e>new_user</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUser</span>(<span style=color:#a6e22e>new_user_no_roles</span>);
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>We should also write a test to make sure the process will fail if any required attributes (in this case, just <code>username</code>) are missing. We can even check the output to make sure the missing attribute is listed:</p><div class=tab-panel data-tab-group=2a2bbe4483d17a65db6663c795bcdf7e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2a2bbe4483d17a65db6663c795bcdf7e","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Fails to create user with missing required attribute
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>createUserFailsOnMissingRequiredAttribute</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>attr</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should fail when required attribute &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>attr</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; is missing&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create a copy of the user object and delete the given attribute
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>updated_user</span> <span style=color:#f92672>=</span> {... <span style=color:#a6e22e>user</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>delete</span> <span style=color:#a6e22e>updated_user</span>[<span style=color:#a6e22e>attr</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/api/v1/users/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>updated_user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>422</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;object&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;error&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;errors&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;array&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// the error should be related to the deleted attribute
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>some</span>((<span style=color:#a6e22e>e</span>) =&gt; <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>attribute</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>attr</span>)).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/users route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;POST /&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUser</span>(<span style=color:#a6e22e>new_user</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUser</span>(<span style=color:#a6e22e>new_user_no_roles</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUserFailsOnMissingRequiredAttribute</span>(<span style=color:#a6e22e>new_user</span>, <span style=color:#e6db74>&#34;username&#34;</span>);
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><h3 id=duplicate-username-1>Duplicate Username</h3><p>We also should write a unit test that will make sure we cannot create a user with a duplicate username.</p><div class=tab-panel data-tab-group=1aea623ca2aaa63876546644699bf181><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1aea623ca2aaa63876546644699bf181","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Fails to create user with a duplicate username
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>createUserFailsOnDuplicateUsername</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should fail on duplicate username &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/api/v1/users/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>201</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;object&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;message&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;id&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>created_id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Find user in list of all users
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>foundUser</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>find</span>(
</span></span><span style=display:flex><span>              (<span style=color:#a6e22e>u</span>) =&gt; <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>created_id</span>,
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>foundUser</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>shallowDeepEqual</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Try to create same user again
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>              .<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/api/v1/users/&#34;</span>)
</span></span><span style=display:flex><span>              .<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>              .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>422</span>)
</span></span><span style=display:flex><span>              .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;object&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;error&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;errors&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;array&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#75715e>// the error should be related to the username attribute
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>expect</span>(
</span></span><span style=display:flex><span>                  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>some</span>((<span style=color:#a6e22e>e</span>) =&gt; <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>attribute</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;username&#34;</span>),
</span></span><span style=display:flex><span>                ).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>              });
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/users route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;POST /&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUser</span>(<span style=color:#a6e22e>new_user</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUser</span>(<span style=color:#a6e22e>new_user_no_roles</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUserFailsOnMissingRequiredAttribute</span>(<span style=color:#a6e22e>new_user</span>, <span style=color:#e6db74>&#34;username&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUserFailsOnDuplicateUsername</span>(<span style=color:#a6e22e>new_user</span>);
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>This test builds upon the previous <code>createUser</code> test by first creating the user, and then confirming that it appears in the output, before trying to create it again. This time, it should fail, so we can borrow some of the code from the <code>createUserFailsOnMissingRequiredAttribute</code> to confirm that it is failing because of a duplicate username.</p><h3 id=invalid-roles-1>Invalid Roles</h3><p>Finally, we should write a unit test that makes sure a user won&rsquo;t be created if any invalid role IDs are used, and also that the database transaction is properly rolled back so that the user itself isn&rsquo;t created.</p><div class=tab-panel data-tab-group=770d71e70cdaebe6695b51a5c7f7e294><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("770d71e70cdaebe6695b51a5c7f7e294","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Fails to create user with bad role ID
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>createUserFailsOnInvalidRole</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>role_id</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should fail when invalid role id &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>role_id</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; is used&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create a copy of the user object
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>updated_user</span> <span style=color:#f92672>=</span> { ...<span style=color:#a6e22e>user</span> };
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Make a shallow copy of the roles array
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>updated_user</span>.<span style=color:#a6e22e>roles</span> <span style=color:#f92672>=</span> [... <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>roles</span>]
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add invalid role ID to user object
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>updated_user</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>role_id</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/api/v1/users/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>updated_user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>422</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;object&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;error&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// User with invalid roles should not be created
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>some</span>((<span style=color:#a6e22e>u</span>) =&gt; <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>updated_user</span>.<span style=color:#a6e22e>username</span>)).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/users route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;POST /&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUser</span>(<span style=color:#a6e22e>new_user</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUser</span>(<span style=color:#a6e22e>new_user_no_roles</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUserFailsOnMissingRequiredAttribute</span>(<span style=color:#a6e22e>new_user</span>, <span style=color:#e6db74>&#34;username&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUserFailsOnDuplicateUsername</span>(<span style=color:#a6e22e>new_user</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUserFailsOnInvalidRole</span>(<span style=color:#a6e22e>new_user</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUserFailsOnInvalidRole</span>(<span style=color:#a6e22e>new_user</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUserFailsOnInvalidRole</span>(<span style=color:#a6e22e>new_user</span>, <span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createUserFailsOnInvalidRole</span>(<span style=color:#a6e22e>new_user</span>, <span style=color:#e6db74>&#34;test&#34;</span>)
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>This test will try to create a valid user, but it appends an invalid role ID to the list of roles to assign to the user. It also confirms that the user itself is not created by querying the get all endpoint and checking for a matching username.</p><p>There we go! We have a set of unit tests that cover most of the situations we can anticipate seeing with our route to create new users. If we run all of these tests at this point, they should all pass:</p><div class=tab-panel data-tab-group=6250de813384a3f22469cc3f7ebd3a2e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6250de813384a3f22469cc3f7ebd3a2e","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0><code>    POST /
      ✔ should successfully create a user &#39;test_user&#39;
      ✔ should successfully create a user &#39;test_user_no_roles&#39;
      ✔ should fail when required attribute &#39;username&#39; is missing
      ✔ should fail on duplicate username &#39;test_user&#39;
      ✔ should fail when invalid role id &#39;0&#39; is used
      ✔ should fail when invalid role id &#39;-1&#39; is used
      ✔ should fail when invalid role id &#39;8&#39; is used
      ✔ should fail when invalid role id &#39;test&#39; is used</code></pre></div></div></div></div></div><p>Great! Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub before continuing.</p><footer class=footline></footer></article></div></main></div><script src=/cis526/js/clipboard/clipboard.min.js?1769117712 defer></script><script src=/cis526/js/perfect-scrollbar/perfect-scrollbar.min.js?1769117712 defer></script><script src=/cis526/js/theme.min.js?1769117712 defer></script></div><script src=/cis526/js/tele-scroll.min.js?1769117712 defer></script></body></html>
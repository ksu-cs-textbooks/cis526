<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=html><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.148.1"><meta name=generator content="Relearn 8.0.0"><meta name=description content="YouTube Video Update Route Next, let’s look at adding an additional route in our application that allows us to update a User model. This route is very similar to the route used to create a user, but there are a few key differences as well.
​ routes/api/v1/users.js // -=-=- other code omitted here -=-=- /** * Update a user * * @param {Object} req - Express request object * @param {Object} res - Express response object * @param {Function} next - Express next middleware function * * @swagger * /api/v1/users/{id}: * put: * summary: update user * tags: [users] * parameters: * - in: path * name: id * required: true * schema: * type: integer * description: user ID * requestBody: * description: user * required: true * content: * application/json: * schema: * $ref: '#/components/schemas/User' * example: * username: updateduser * roles: * - id: 6 * - id: 7 * responses: * 201: * $ref: '#/components/responses/Success' * 422: * $ref: '#/components/responses/ValidationError' */ router.put(&#34;/:id&#34;, async function (req, res, next) { try { const user = await User.findByPk(req.params.id) // if the user is not found, return an HTTP 404 not found status code if (user === null) { res.status(404).end(); } else { await database.transaction(async (t) => { await user.update( // Update the user object using body attributes { username: req.body.username, }, // Assign to a database transaction { transaction: t, }, ); // If roles are included in the body if (req.body.roles) { // Find all roles listed const roles = await Promise.all( req.body.roles.map(({ id, ...next }) => { return Role.findByPk(id); }), ); // Attach roles to user await user.setRoles(roles, { transaction: t }); } else { // Remove all roles await user.setRoles([], { transaction: t }); } // Send the success message sendSuccess(&#34;User saved!&#34;, user.id, 201, res); }); } } catch (error) { if (error instanceof ValidationError) { handleValidationError(error, res); } else { logger.error(error); res.status(500).end(); } } }); // -=-=- other code omitted here -=-=- As we can see, overall this route is very similar to the create route. The only major difference is that we must first find the user we want to update based on the query parameter, and then we use the update database method to update the existing values in the database. The rest of the work updating the related Roles models is exactly the same. We can also reuse the utility functions we created for the previous route."><meta name=author content="Nathan Bean & Russell Feldhausen"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta name=twitter:title content="Update :: CIS 526 Textbook"><meta name=twitter:description content="YouTube Video Update Route Next, let’s look at adding an additional route in our application that allows us to update a User model. This route is very similar to the route used to create a user, but there are a few key differences as well.
​ routes/api/v1/users.js // -=-=- other code omitted here -=-=- /** * Update a user * * @param {Object} req - Express request object * @param {Object} res - Express response object * @param {Function} next - Express next middleware function * * @swagger * /api/v1/users/{id}: * put: * summary: update user * tags: [users] * parameters: * - in: path * name: id * required: true * schema: * type: integer * description: user ID * requestBody: * description: user * required: true * content: * application/json: * schema: * $ref: '#/components/schemas/User' * example: * username: updateduser * roles: * - id: 6 * - id: 7 * responses: * 201: * $ref: '#/components/responses/Success' * 422: * $ref: '#/components/responses/ValidationError' */ router.put(&#34;/:id&#34;, async function (req, res, next) { try { const user = await User.findByPk(req.params.id) // if the user is not found, return an HTTP 404 not found status code if (user === null) { res.status(404).end(); } else { await database.transaction(async (t) => { await user.update( // Update the user object using body attributes { username: req.body.username, }, // Assign to a database transaction { transaction: t, }, ); // If roles are included in the body if (req.body.roles) { // Find all roles listed const roles = await Promise.all( req.body.roles.map(({ id, ...next }) => { return Role.findByPk(id); }), ); // Attach roles to user await user.setRoles(roles, { transaction: t }); } else { // Remove all roles await user.setRoles([], { transaction: t }); } // Send the success message sendSuccess(&#34;User saved!&#34;, user.id, 201, res); }); } } catch (error) { if (error instanceof ValidationError) { handleValidationError(error, res); } else { logger.error(error); res.status(500).end(); } } }); // -=-=- other code omitted here -=-=- As we can see, overall this route is very similar to the create route. The only major difference is that we must first find the user we want to update based on the query parameter, and then we use the update database method to update the existing values in the database. The rest of the work updating the related Roles models is exactly the same. We can also reuse the utility functions we created for the previous route."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/03-rest-api/10-update/index.html"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Update :: CIS 526 Textbook"><meta property="og:description" content="YouTube Video Update Route Next, let’s look at adding an additional route in our application that allows us to update a User model. This route is very similar to the route used to create a user, but there are a few key differences as well.
​ routes/api/v1/users.js // -=-=- other code omitted here -=-=- /** * Update a user * * @param {Object} req - Express request object * @param {Object} res - Express response object * @param {Function} next - Express next middleware function * * @swagger * /api/v1/users/{id}: * put: * summary: update user * tags: [users] * parameters: * - in: path * name: id * required: true * schema: * type: integer * description: user ID * requestBody: * description: user * required: true * content: * application/json: * schema: * $ref: '#/components/schemas/User' * example: * username: updateduser * roles: * - id: 6 * - id: 7 * responses: * 201: * $ref: '#/components/responses/Success' * 422: * $ref: '#/components/responses/ValidationError' */ router.put(&#34;/:id&#34;, async function (req, res, next) { try { const user = await User.findByPk(req.params.id) // if the user is not found, return an HTTP 404 not found status code if (user === null) { res.status(404).end(); } else { await database.transaction(async (t) => { await user.update( // Update the user object using body attributes { username: req.body.username, }, // Assign to a database transaction { transaction: t, }, ); // If roles are included in the body if (req.body.roles) { // Find all roles listed const roles = await Promise.all( req.body.roles.map(({ id, ...next }) => { return Role.findByPk(id); }), ); // Attach roles to user await user.setRoles(roles, { transaction: t }); } else { // Remove all roles await user.setRoles([], { transaction: t }); } // Send the success message sendSuccess(&#34;User saved!&#34;, user.id, 201, res); }); } } catch (error) { if (error instanceof ValidationError) { handleValidationError(error, res); } else { logger.error(error); res.status(500).end(); } } }); // -=-=- other code omitted here -=-=- As we can see, overall this route is very similar to the create route. The only major difference is that we must first find the user we want to update based on the query parameter, and then we use the update database method to update the existing values in the database. The rest of the work updating the related Roles models is exactly the same. We can also reuse the utility functions we created for the previous route."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="Example Projects"><meta property="article:modified_time" content="2025-03-07T15:34:34-06:00"><meta property="og:image" content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta itemprop=name content="Update :: CIS 526 Textbook"><meta itemprop=description content="YouTube Video Update Route Next, let’s look at adding an additional route in our application that allows us to update a User model. This route is very similar to the route used to create a user, but there are a few key differences as well.
​ routes/api/v1/users.js // -=-=- other code omitted here -=-=- /** * Update a user * * @param {Object} req - Express request object * @param {Object} res - Express response object * @param {Function} next - Express next middleware function * * @swagger * /api/v1/users/{id}: * put: * summary: update user * tags: [users] * parameters: * - in: path * name: id * required: true * schema: * type: integer * description: user ID * requestBody: * description: user * required: true * content: * application/json: * schema: * $ref: '#/components/schemas/User' * example: * username: updateduser * roles: * - id: 6 * - id: 7 * responses: * 201: * $ref: '#/components/responses/Success' * 422: * $ref: '#/components/responses/ValidationError' */ router.put(&#34;/:id&#34;, async function (req, res, next) { try { const user = await User.findByPk(req.params.id) // if the user is not found, return an HTTP 404 not found status code if (user === null) { res.status(404).end(); } else { await database.transaction(async (t) => { await user.update( // Update the user object using body attributes { username: req.body.username, }, // Assign to a database transaction { transaction: t, }, ); // If roles are included in the body if (req.body.roles) { // Find all roles listed const roles = await Promise.all( req.body.roles.map(({ id, ...next }) => { return Role.findByPk(id); }), ); // Attach roles to user await user.setRoles(roles, { transaction: t }); } else { // Remove all roles await user.setRoles([], { transaction: t }); } // Send the success message sendSuccess(&#34;User saved!&#34;, user.id, 201, res); }); } } catch (error) { if (error instanceof ValidationError) { handleValidationError(error, res); } else { logger.error(error); res.status(500).end(); } } }); // -=-=- other code omitted here -=-=- As we can see, overall this route is very similar to the create route. The only major difference is that we must first find the user we want to update based on the query parameter, and then we use the update database method to update the existing values in the database. The rest of the work updating the related Roles models is exactly the same. We can also reuse the utility functions we created for the previous route."><meta itemprop=dateModified content="2025-03-07T15:34:34-06:00"><meta itemprop=wordCount content="1342"><meta itemprop=image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><title>Update :: CIS 526 Textbook</title><link href=https://textbooks.cs.ksu.edu/cis526/x-examples/03-rest-api/10-update/index.html rel=canonical type=text/html title="Update :: CIS 526 Textbook"><link href=/cis526/x-examples/03-rest-api/10-update/index.xml rel=alternate type=application/rss+xml title="Update :: CIS 526 Textbook"><link href=/cis526/x-examples/03-rest-api/10-update/index.print.html rel=alternate type=text/html title="Update :: CIS 526 Textbook"><link href=/cis526/x-examples/03-rest-api/10-update/embed.html rel=alternate type=text/html title="Update :: CIS 526 Textbook"><link href=/cis526/css/auto-complete/auto-complete.min.css?1770225504 rel=stylesheet><script src=/cis526/js/auto-complete/auto-complete.min.js?1770225504 defer></script><script src=/cis526/js/search-lunr.min.js?1770225504 defer></script><script src=/cis526/js/search.min.js?1770225504 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/cis526/searchindex.en.js?1770225504"</script><script src=/cis526/js/lunr/lunr.min.js?1770225504 defer></script><script src=/cis526/js/lunr/lunr.stemmer.support.min.js?1770225504 defer></script><script src=/cis526/js/lunr/lunr.multi.min.js?1770225504 defer></script><script src=/cis526/js/lunr/lunr.en.min.js?1770225504 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1770225504 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1770225504 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar/perfect-scrollbar.min.css?1770225504 rel=stylesheet><link href=/cis526/css/theme.min.css?1770225504 rel=stylesheet><link href=/cis526/css/format-html.min.css?1770225504 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/x-examples/03-rest-api/10-update/index.html",window.relearn.relBasePath="../../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!1,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.relearn.themevariants=["light-theme"],window.relearn.customvariantname="my-custom-variant",window.relearn.writeVariant=!1,window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.writeVariant&&window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><link href=/cis526/css/custom.css?1770225504 rel=stylesheet></head><body class="mobile-support html" data-url=/cis526/x-examples/03-rest-api/10-update/index.html><div id=tele class="tele mirror"><div id=R-body class=default-animation><div id=R-body-overlay></div><div id=R-main-overlay></div><main id=R-body-inner class="highlightable x-examples" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=update>Update</h1><a href="https://www.youtube.com/watch?v=wH6SmYAGRLs">YouTube Video</a><h2 id=update-route>Update Route</h2><p>Next, let&rsquo;s look at adding an additional route in our application that allows us to update a <code>User</code> model. This route is very similar to the route used to create a user, but there are a few key differences as well.</p><div class=tab-panel data-tab-group=f8a2bbb0afe7c678f40ee8dcdcf03861><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f8a2bbb0afe7c678f40ee8dcdcf03861","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Update a user
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} req - Express request object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} res - Express response object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Function} next - Express next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * /api/v1/users/{id}:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   put:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     summary: update user
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     tags: [users]
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     parameters:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       - in: path
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         name: id
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         required: true
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         schema:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *           type: integer
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         description: user ID
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     requestBody:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       description: user
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       required: true
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       content:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         application/json:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *           schema:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *             $ref: &#39;#/components/schemas/User&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e> *           example:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *             username: updateduser
</span></span></span><span style=display:flex><span><span style=color:#75715e> *             roles:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *               - id: 6
</span></span></span><span style=display:flex><span><span style=color:#75715e> *               - id: 7
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     responses:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       201:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         $ref: &#39;#/components/responses/Success&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       422:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         $ref: &#39;#/components/responses/ValidationError&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;/:id&#34;</span>, <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findByPk</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// if the user is not found, return an HTTP 404 not found status code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>user</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>404</span>).<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>database</span>.<span style=color:#a6e22e>transaction</span>(<span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>t</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>update</span>(
</span></span><span style=display:flex><span>          <span style=color:#75715e>// Update the user object using body attributes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>username</span>,
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          <span style=color:#75715e>// Assign to a database transaction
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>transaction</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>t</span>,
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If roles are included in the body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>roles</span>) {
</span></span><span style=display:flex><span>          <span style=color:#75715e>// Find all roles listed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>roles</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> Promise.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>map</span>(({ <span style=color:#a6e22e>id</span>, ...<span style=color:#a6e22e>next</span> }) =&gt; {
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Role</span>.<span style=color:#a6e22e>findByPk</span>(<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>            }),
</span></span><span style=display:flex><span>          );
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>          <span style=color:#75715e>// Attach roles to user
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>setRoles</span>(<span style=color:#a6e22e>roles</span>, { <span style=color:#a6e22e>transaction</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>t</span> });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#75715e>// Remove all roles
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>setRoles</span>([], { <span style=color:#a6e22e>transaction</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>t</span> });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Send the success message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>sendSuccess</span>(<span style=color:#e6db74>&#34;User saved!&#34;</span>, <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>id</span>, <span style=color:#ae81ff>201</span>, <span style=color:#a6e22e>res</span>);
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> <span style=color:#a6e22e>ValidationError</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>handleValidationError</span>(<span style=color:#a6e22e>error</span>, <span style=color:#a6e22e>res</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>As we can see, overall this route is very similar to the create route. The only major difference is that we must first find the user we want to update based on the query parameter, and then we use the <code>update</code> database method to update the existing values in the database. The rest of the work updating the related <code>Roles</code> models is exactly the same. We can also reuse the utility functions we created for the previous route.</p><p>Just like we did earlier, we can test this route using the Open API documentation website to confirm that it is working correctly before we even move on to testing it.</p><h2 id=unit-testing-update-route>Unit Testing Update Route</h2><p>The unit tests for the route to update a user are very similar to the ones used for creating a user. First, we need a test that will confirm we can successfully update a user entry:</p><div class=tab-panel data-tab-group=f5daa99b96b3f51441e40224bfcb41b0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f5daa99b96b3f51441e40224bfcb41b0","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Update a user successfully
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>updateUser</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should successfully update user ID &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; to &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;/api/v1/users/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>201</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;object&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;message&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;id&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Find user in list of all users
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>foundUser</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>find</span>(
</span></span><span style=display:flex><span>              (<span style=color:#a6e22e>u</span>) =&gt; <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>foundUser</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>shallowDeepEqual</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/users route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;PUT /{id}&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUser</span>(<span style=color:#ae81ff>3</span>, <span style=color:#a6e22e>new_user</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>Next, we also want to check that any updated users have the correct roles attached, including instances where the roles were completely removed:</p><div class=tab-panel data-tab-group=30d9cc8755f7365a6c61f98d53fc139e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("30d9cc8755f7365a6c61f98d53fc139e","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Update a user and roles successfully
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>updateUserAndRoles</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should successfully update user ID &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>id</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; roles&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;/api/v1/users/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>201</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;object&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;message&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;id&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Find user in list of all users
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>foundUser</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>find</span>(
</span></span><span style=display:flex><span>              (<span style=color:#a6e22e>u</span>) =&gt; <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Handle case where user has no roles assigned
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>roles</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>roles</span> <span style=color:#f92672>||</span> []
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>foundUser</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;array&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>foundUser</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>lengthOf</span>(<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>role</span>) =&gt; {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>foundUser</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>some</span>((<span style=color:#a6e22e>r</span>) =&gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>role</span>.<span style=color:#a6e22e>id</span>)).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/users route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;PUT /{id}&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUser</span>(<span style=color:#ae81ff>3</span>, <span style=color:#a6e22e>new_user</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUserAndRoles</span>(<span style=color:#ae81ff>3</span>, <span style=color:#a6e22e>new_user</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUserAndRoles</span>(<span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>new_user_no_roles</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>We also should check that the username is unchanged if an update is sent with no username attribute, but the rest of the update will succeed. For this test, we can just create a new mock object with just roles and no username included.</p><div class=tab-panel data-tab-group=62ae11f2bdd6b8a9da006b7b86e47a4d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("62ae11f2bdd6b8a9da006b7b86e47a4d","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Update user structure with only roles
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>update_user_only_roles</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>roles</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>6</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>7</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/users route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;PUT /{id}&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUser</span>(<span style=color:#ae81ff>3</span>, <span style=color:#a6e22e>new_user</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUserAndRoles</span>(<span style=color:#ae81ff>3</span>, <span style=color:#a6e22e>new_user</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUserAndRoles</span>(<span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>new_user_no_roles</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUserAndRoles</span>(<span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>update_user_only_roles</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>Finally, we should include a couple of tests to handle the situation where a duplicate username is provided, or where an invalid role is provided. These are nearly identical to the tests used in the create route earlier in this example:</p><div class=tab-panel data-tab-group=3fad250a65c7e67db731a40d8112a6f7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3fad250a65c7e67db731a40d8112a6f7","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Fails to update user with a duplicate username
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>updateUserFailsOnDuplicateUsername</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should fail on duplicate username &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;/api/v1/users/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>422</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;object&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;error&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;errors&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;array&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// the error should be related to the username attribute
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>expect</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>some</span>((<span style=color:#a6e22e>e</span>) =&gt; <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>attribute</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;username&#34;</span>),
</span></span><span style=display:flex><span>        ).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Fails to update user with bad role ID
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>updateUserFailsOnInvalidRole</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>role_id</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should fail when invalid role id &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>role_id</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; is used&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create a copy of the user object
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>updated_user</span> <span style=color:#f92672>=</span> { ...<span style=color:#a6e22e>user</span> };
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Make a shallow copy of the roles array
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>updated_user</span>.<span style=color:#a6e22e>roles</span> <span style=color:#f92672>=</span> [... <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>roles</span>]
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add invalid role ID to user object
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>updated_user</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>role_id</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;/api/v1/users/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>updated_user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>422</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;object&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;error&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// User with invalid roles should not be updated
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>some</span>((<span style=color:#a6e22e>u</span>) =&gt; <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>updated_user</span>.<span style=color:#a6e22e>username</span>)).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>            );
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Update user structure with duplicate username
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>update_user_duplicate_username</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;admin&#34;</span>,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/users route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;PUT /{id}&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUser</span>(<span style=color:#ae81ff>3</span>, <span style=color:#a6e22e>new_user</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUserAndRoles</span>(<span style=color:#ae81ff>3</span>, <span style=color:#a6e22e>new_user</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUserAndRoles</span>(<span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>new_user_no_roles</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUserAndRoles</span>(<span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>update_user_only_roles</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUserFailsOnDuplicateUsername</span>(<span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>update_user_duplicate_username</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUserFailsOnInvalidRole</span>(<span style=color:#ae81ff>4</span>, <span style=color:#a6e22e>new_user</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUserFailsOnInvalidRole</span>(<span style=color:#ae81ff>4</span>, <span style=color:#a6e22e>new_user</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUserFailsOnInvalidRole</span>(<span style=color:#ae81ff>4</span>, <span style=color:#a6e22e>new_user</span>, <span style=color:#ae81ff>8</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updateUserFailsOnInvalidRole</span>(<span style=color:#ae81ff>4</span>, <span style=color:#a6e22e>new_user</span>, <span style=color:#e6db74>&#34;test&#34;</span>);
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>There we go! We have a set of unit tests that cover most of the situations we can anticipate seeing with our route to update users. If we run all of these tests at this point, they should all pass:</p><div class=tab-panel data-tab-group=47dfd455b58fc5248aefc228c724b5cd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("47dfd455b58fc5248aefc228c724b5cd","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0><code>    PUT /{id}
      ✔ should successfully update user ID &#39;3&#39; to &#39;test_user&#39;
      ✔ should successfully update user ID &#39;3&#39; roles
      ✔ should successfully update user ID &#39;2&#39; roles
      ✔ should successfully update user ID &#39;1&#39; roles
      ✔ should fail on duplicate username &#39;admin&#39;
      ✔ should fail when invalid role id &#39;0&#39; is used
      ✔ should fail when invalid role id &#39;-1&#39; is used
      ✔ should fail when invalid role id &#39;8&#39; is used
      ✔ should fail when invalid role id &#39;test&#39; is used</code></pre></div></div></div></div></div><p>Great! Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub before continuing.</p><footer class=footline></footer></article></div></main></div><script src=/cis526/js/clipboard/clipboard.min.js?1770225504 defer></script><script src=/cis526/js/perfect-scrollbar/perfect-scrollbar.min.js?1770225504 defer></script><script src=/cis526/js/theme.min.js?1770225504 defer></script></div><script src=/cis526/js/tele-scroll.min.js?1770225504 defer></script></body></html>
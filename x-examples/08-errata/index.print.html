<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="This page lists all of the errors found and updates I have made to the basic project since this was released.
Client Update Token Store In my Vue code, I was often using tokenStore.token.length > 0 to determine if a user was logged in. This is a bit fragile - better to just make a computed value for this:
​ client/src/stores/Token.js // Getters const loggedIn = computed(() => token.value.length > 0 ) This requires changing several other places in ths code where this is used - mainly I just searched for token."><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Errata :: CIS 526 Textbook"><meta name=twitter:description content="This page lists all of the errors found and updates I have made to the basic project since this was released.
Client Update Token Store In my Vue code, I was often using tokenStore.token.length > 0 to determine if a user was logged in. This is a bit fragile - better to just make a computed value for this:
​ client/src/stores/Token.js // Getters const loggedIn = computed(() => token.value.length > 0 ) This requires changing several other places in ths code where this is used - mainly I just searched for token."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/08-errata/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Errata :: CIS 526 Textbook"><meta property="og:description" content="This page lists all of the errors found and updates I have made to the basic project since this was released.
Client Update Token Store In my Vue code, I was often using tokenStore.token.length > 0 to determine if a user was logged in. This is a bit fragile - better to just make a computed value for this:
​ client/src/stores/Token.js // Getters const loggedIn = computed(() => token.value.length > 0 ) This requires changing several other places in ths code where this is used - mainly I just searched for token."><meta property="og:locale" content="en-us"><meta property="og:type" content="website"><meta itemprop=name content="Errata :: CIS 526 Textbook"><meta itemprop=description content="This page lists all of the errors found and updates I have made to the basic project since this was released.
Client Update Token Store In my Vue code, I was often using tokenStore.token.length > 0 to determine if a user was logged in. This is a bit fragile - better to just make a computed value for this:
​ client/src/stores/Token.js // Getters const loggedIn = computed(() => token.value.length > 0 ) This requires changing several other places in ths code where this is used - mainly I just searched for token."><meta itemprop=dateModified content="2025-06-17T13:55:22-05:00"><meta itemprop=wordCount content="1330"><title>Errata :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/x-examples/08-errata/ rel=canonical type=text/html title="Errata :: CIS 526 Textbook"><link href=/cis526/x-examples/08-errata/index.xml rel=alternate type=application/rss+xml title="Errata :: CIS 526 Textbook"><link href=/cis526/x-examples/08-errata/tele.html rel=alternate type=text/html title="Errata :: CIS 526 Textbook"><link href=/cis526/x-examples/08-errata/embed.html rel=alternate type=text/html title="Errata :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1750186567 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1750186567 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1750186567 rel=stylesheet><link href=/cis526/css/auto-complete.css?1750186567 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1750186567 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1750186567 rel=stylesheet><link href=/cis526/css/fonts.css?1750186567 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1750186567 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1750186567 rel=stylesheet><link href=/cis526/css/theme-auto.css?1750186567 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1750186567 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1750186567 rel=stylesheet><link href=/cis526/css/print.css?1750186567 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1750186567 rel=stylesheet><script src=/cis526/js/variant.js?1750186567></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../..",window.relearn.relBaseUri="../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1750186567 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/x-examples/08-errata/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/cis526/x-examples/><span itemprop=name>Example Projects</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Errata</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/07-advanced-topics/07-external-db/ title="External Database (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-milestones/ title="Milestones (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=errata>Errata</h1><p>This page lists all of the errors found and updates I have made to the basic project since this was released.</p><h2 id=client>Client</h2><h3 id=update-token-store>Update Token Store</h3><p>In my Vue code, I was often using <code>tokenStore.token.length > 0</code> to determine if a user was logged in. This is a bit fragile - better to just make a computed value for this:</p><div class=tab-panel data-tab-group=821d3d25f64835243c7b3ea9576328ad><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=clientsrcstorestokenjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("821d3d25f64835243c7b3ea9576328ad","clientsrcstorestokenjs")'>
<span class=tab-nav-text>client/src/stores/Token.js</span></button></div><div class=tab-content-container><div data-tab-item=clientsrcstorestokenjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>  <span class=c1>// Getters
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>loggedIn</span> <span class=o>=</span> <span class=nx>computed</span><span class=p>(()</span> <span class=p>=&gt;</span> 
</span></span><span class=line><span class=cl>    <span class=nx>token</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span></span></span></code></pre></div></div></div></div></div><p>This requires changing several other places in ths code where this is used - mainly I just searched for <code>token.length</code> and went from there.</p><p>I also chose to update it to store the decoded value directly as a state property, just to avoid decoding it multiple times. Finally, I fixed a bug where users with no role would cause issues. Here is the fully updated token store.</p><div class=tab-panel data-tab-group=c64a7e176e81ca3e9f4d2ac858865e47><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=clientsrcstorestokenjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c64a7e176e81ca3e9f4d2ac858865e47","clientsrcstorestokenjs")'>
<span class=tab-nav-text>client/src/stores/Token.js</span></button></div><div class=tab-content-container><div data-tab-item=clientsrcstorestokenjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file JWT Token Store
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span><span class=p>,</span> <span class=nx>computed</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>defineStore</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;pinia&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>jwtDecode</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;jwt-decode&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>axios</span> <span class=nx>from</span> <span class=s1>&#39;axios&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Define Store
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>useTokenStore</span> <span class=o>=</span> <span class=nx>defineStore</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// State properties
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>decoded</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>({})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Getters
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>loggedIn</span> <span class=o>=</span> <span class=nx>computed</span><span class=p>(()</span> <span class=p>=&gt;</span> 
</span></span><span class=line><span class=cl>    <span class=nx>token</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>username</span> <span class=o>=</span> <span class=nx>computed</span><span class=p>(()</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nx>decoded</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>username</span> <span class=o>?</span> <span class=nx>decoded</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>username</span>  <span class=o>:</span> <span class=nx>decoded</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>email</span> <span class=o>?</span> <span class=nx>decoded</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>email</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>has_role</span> <span class=o>=</span> <span class=nx>computed</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nx>decoded</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>roles</span> <span class=o>?</span> <span class=nx>decoded</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>role</span> <span class=o>==</span> <span class=nx>role</span><span class=p>)</span> <span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Actions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Get a token for the user.
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * If this fails, redirect to authentication page if parameter is true
</span></span></span><span class=line><span class=cl><span class=cm>   *
</span></span></span><span class=line><span class=cl><span class=cm>   * @param redirect if true, redirect user to login page on failure
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=kd>function</span> <span class=nx>getToken</span><span class=p>(</span><span class=nx>redirect</span> <span class=o>=</span> <span class=kc>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;token:get&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>axios</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/auth/token&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>withCredentials</span><span class=o>:</span> <span class=kc>true</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=nx>token</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>token</span>
</span></span><span class=line><span class=cl>      <span class=nx>decoded</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>jwtDecode</span><span class=p>(</span><span class=nx>token</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>token</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>      <span class=nx>decoded</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// If the response is a 401, the user is not logged in
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>response</span> <span class=o>&amp;&amp;</span> <span class=nx>error</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>401</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;token:get user not logged in&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>redirect</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;token:get redirecting to login page&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=nb>window</span><span class=p>.</span><span class=nx>location</span><span class=p>.</span><span class=nx>href</span> <span class=o>=</span> <span class=s1>&#39;/auth/cas&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;token:get error&#39;</span> <span class=o>+</span> <span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Log the user out and clear the token
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>logout</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>token</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nx>decoded</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nb>window</span><span class=p>.</span><span class=nx>location</span><span class=p>.</span><span class=nx>href</span> <span class=o>=</span> <span class=s1>&#39;/auth/logout&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Return all state, getters, and actions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=p>{</span> <span class=nx>token</span><span class=p>,</span> <span class=nx>loggedIn</span><span class=p>,</span> <span class=nx>username</span><span class=p>,</span> <span class=nx>has_role</span><span class=p>,</span> <span class=nx>getToken</span><span class=p>,</span> <span class=nx>logout</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><h3 id=switch-from-date-fns-to-dayjs>Switch from date-fns to Day.js</h3><p>The <a href=https://date-fns.org/ rel=external target=_blank>date-fns</a> library has an issue where an invalid date will cause an uncaught exception in the browser, which crashes the Vue application. This can happen when the date is rendered <em>before</em> the data is loaded, as would be the case anytime the data is loaded asynchronously when visiting the page. This was causing all sorts of strange errors in my code upon a refresh of specific pages.</p><p>I swapped to using <a href=https://day.js.org/en/ rel=external target=_blank>Day.js</a> instead, which provides many of the same features as <code>date-fns</code> but <strong>without</strong> unhandled exceptions. I especially use the <a href=https://day.js.org/docs/en/display/from-now rel=external target=_blank>Time from now</a> feature in many places, such as my <code>UsersList.vue</code> component:</p><div class=tab-panel data-tab-group=8c16c6a2026bb456811fb9e077b93752><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=clientsrccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8c16c6a2026bb456811fb9e077b93752","clientsrccomponentsusersuserslistvue")'>
<span class=tab-nav-text>client/src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=clientsrccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>Column</span> <span class=na>field</span><span class=o>=</span><span class=s>&#34;createdAt&#34;</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Created&#34;</span> <span class=na>sortable</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>body</span><span class=o>=</span><span class=s>&#34;{ data }&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>span</span> <span class=na>v</span><span class=nt>-tooltip</span><span class=na>.bottom</span><span class=err>=&#34;</span><span class=na>new</span> <span class=na>Date</span><span class=err>(</span><span class=na>data.createdAt</span><span class=err>)</span><span class=na>.toLocaleString</span><span class=err>()&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>{{</span> <span class=nx>dayjs</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>createdAt</span><span class=p>).</span><span class=nx>fromNow</span><span class=p>()</span> <span class=p>}}</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>Column</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><h3 id=loading-icons-on-data-tables>Loading Icons on Data Tables</h3><p>On most of the data tables, I added a loading icon implementation, such as the <code>UsersList.vue</code> component:</p><div class=tab-panel data-tab-group=940775847fdc04237e0508c79993316d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("940775847fdc04237e0508c79993316d","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>//  -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Loading State
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>loading</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Hydrate Store
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>userStore</span><span class=p>.</span><span class=nx>hydrate</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>loading</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class="line hl"><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//  -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>DataTable</span>
</span></span><span class=line><span class=cl>    <span class=nt>:value</span><span class=o>=</span><span class=s>&#34;users&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>v</span><span class=nt>-model:filters</span><span class=o>=</span><span class=s>&#34;filters&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span><span class=na>globalFilterFields</span><span class=o>=</span><span class=s>&#34;[&#39;username&#39;, &#39;email&#39;, &#39;name&#39;]&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>filterDisplay</span><span class=o>=</span><span class=s>&#34;menu&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>sortField</span><span class=o>=</span><span class=s>&#34;username&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nt>:sortOrder</span><span class=o>=</span><span class=s>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nt>:loading</span><span class=o>=</span><span class=s>&#34;loading&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=na>loading</span><span class=nt>-icon</span><span class=err>=&#34;</span><span class=na>pi</span> <span class=na>pi</span><span class=nt>-spin</span> <span class=na>pi</span><span class=nt>-spinner</span><span class=err>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=c>&lt;!--</span> <span class=o>-=-=-</span> <span class=nx>other</span> <span class=nx>code</span> <span class=nx>omitted</span> <span class=nx>here</span> <span class=o>-=-=-</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>DataTable</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>This also requires the store to return the appropriate type so it can be handled asyncrhonously (in this case, the user store returns the promise from getting the user&rsquo;s list, but the roles list can happen in the background):</p><div class=tab-panel data-tab-group=99ddf28f0e1b6bb955b7b41386297cb9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcstoresuserjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("99ddf28f0e1b6bb955b7b41386297cb9","srcstoresuserjs")'>
<span class=tab-nav-text>src/stores/user.js</span></button></div><div class=tab-content-container><div data-tab-item=srcstoresuserjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>hydrate</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>api</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/v1/roles&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>roles</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>api</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/v1/users&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>users</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div></div></div></div></div><h2 id=server>Server</h2><h3 id=use-default-express-error-handlers>Use Default Express Error Handlers</h3><p>In my code, I added a <code>try...catch</code> block to each route handler. This can be good practice, but it is also inefficient. I have since removed all of them and switched to using this global error handler at the very end of my <code>app.js</code> code:</p><div class=tab-panel data-tab-group=8a2d48c76ae51c4c41dac575c62b30e1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=serverappjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8a2d48c76ae51c4c41dac575c62b30e1","serverappjs")'>
<span class=tab-nav-text>server/app.js</span></button></div><div class=tab-content-container><div data-tab-item=serverappjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Default Error Handler
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// If error already sent, disregard
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>headersSent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Handle Validation Errors
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>err</span> <span class=k>instanceof</span> <span class=nx>ValidationError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>handleValidationError</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This greatly shortens and simplifies the code for each route, and makes coverage testing a bit more straightforward (since each route no longer has an error path that cannot be easily tested)</p><h3 id=better-sequelize-error-handler>Better Sequelize Error Handler</h3><p>I also added a custom format to the Winston logger to better handle the exceptions generated by Sequelize. At the same time, I enabled Winston&rsquo;s ability to catch and log unahndled exceptions and rejected promises:</p><div class=tab-panel data-tab-group=4b6e493c81b41a76522ce181d624ca77><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsloggerjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4b6e493c81b41a76522ce181d624ca77","configsloggerjs")'>
<span class=tab-nav-text>configs/logger.js</span></button></div><div class=tab-content-container><div data-tab-item=configsloggerjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>winston</span> <span class=nx>from</span> <span class=s2>&#34;winston&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>format</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;winston&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Custom formatter for Sequelize Logs
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>sequelizeErrors</span> <span class=o>=</span> <span class=nx>format</span><span class=p>((</span><span class=nx>info</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Adapted from https://github.com/sequelize/sequelize/issues/14807#issuecomment-1853514339
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>info</span> <span class=k>instanceof</span> <span class=nb>Error</span> <span class=o>&amp;&amp;</span> <span class=nx>info</span><span class=p>.</span><span class=nx>name</span><span class=p>.</span><span class=nx>startsWith</span><span class=p>(</span><span class=s2>&#34;Sequelize&#34;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=p>{</span> <span class=nx>message</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>info</span><span class=p>.</span><span class=nx>parent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>info</span><span class=p>.</span><span class=nx>sql</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>message</span> <span class=o>+=</span> <span class=s2>&#34;\nSQL: &#34;</span> <span class=o>+</span> <span class=nx>info</span><span class=p>.</span><span class=nx>sql</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>info</span><span class=p>.</span><span class=nx>parameters</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>stringifiedParameters</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>info</span><span class=p>.</span><span class=nx>parameters</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>stringifiedParameters</span> <span class=o>!==</span> <span class=s2>&#34;undefined&#34;</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=nx>stringifiedParameters</span> <span class=o>!==</span> <span class=s2>&#34;{}&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>message</span> <span class=o>+=</span> <span class=s2>&#34;\nParameters: &#34;</span> <span class=o>+</span> <span class=nx>stringifiedParameters</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Stack is already included in the error
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// message += &#34;\n&#34; + info.stack;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Update the message
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>info</span><span class=p>.</span><span class=nx>message</span> <span class=o>=</span> <span class=nx>info</span><span class=p>.</span><span class=nx>message</span> <span class=o>+=</span> <span class=s2>&#34;\n&#34;</span> <span class=o>+</span> <span class=nx>message</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>info</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//  -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Creates the Winston instance with the desired configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>logger</span> <span class=o>=</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>createLogger</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// call `level` function to get default log level
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>level</span><span class=o>:</span> <span class=nx>level</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>  <span class=nx>levels</span><span class=o>:</span> <span class=nx>levels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Format configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// See https://github.com/winstonjs/logform
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>format</span><span class=o>:</span> <span class=nx>combine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>sequelizeErrors</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>errors</span><span class=p>({</span> <span class=nx>stack</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>colorize</span><span class=p>({</span> <span class=nx>all</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=c1>//shortFormat(),
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>timestamp</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;YYYY-MM-DD hh:mm:ss.SSS A&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>align</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>printf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nx>info</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>        <span class=sb>`[</span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>timestamp</span><span class=si>}</span><span class=sb>] </span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>level</span><span class=si>}</span><span class=sb>: </span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>stack</span> <span class=o>?</span> <span class=nx>info</span><span class=p>.</span><span class=nx>message</span> <span class=o>+</span> <span class=s2>&#34;\n&#34;</span> <span class=o>+</span> <span class=nx>info</span><span class=p>.</span><span class=nx>stack</span> <span class=o>:</span> <span class=nx>info</span><span class=p>.</span><span class=nx>message</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Output configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>transports</span><span class=o>:</span> <span class=p>[</span><span class=k>new</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>transports</span><span class=p>.</span><span class=nx>Console</span><span class=p>()],</span>
</span></span><span class=line><span class=cl>  <span class=nx>exceptionHandlers</span><span class=o>:</span> <span class=p>[</span><span class=k>new</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>transports</span><span class=p>.</span><span class=nx>Console</span><span class=p>()],</span>
</span></span><span class=line><span class=cl>  <span class=nx>rejectionHandlers</span><span class=o>:</span> <span class=p>[</span><span class=k>new</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>transports</span><span class=p>.</span><span class=nx>Console</span><span class=p>()],</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This provides much more useful output whenever there are unhandled SQL exceptions such as violated validation constraints.</p><h3 id=better-passport-user-sessions>Better Passport User Sessions</h3><p>I updated the Passport user sessions to only store a user&rsquo;s ID instead of a full user object. This is because we are only using the Passport sessions to issue a JWT (at least at this point), so a full user session is not needed. It also fixes issues where user data was not updated properly in the session after editing.</p><div class=tab-panel data-tab-group=888a6e38c464b74d63597f17b378cf2d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("888a6e38c464b74d63597f17b378cf2d","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>//  -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Default functions to serialize and deserialize a session
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>serializeUser</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>done</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>passport</span><span class=p>.</span><span class=nx>deserializeUser</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>user_id</span><span class=p>,</span> <span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// We could change this to look up the user in the database here in the future
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Instead, we make a dummy object that just contains the user&#39;s ID as a stand-in
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>done</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=nx>user_id</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>With this change, we now have to look up the user in the database each time we issue a token. This is preferred, as it will get the current user&rsquo;s profile information and roles each time a token is issued.</p><div class=tab-panel data-tab-group=17f04677cdf6f7182566834ecdbfb257><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("17f04677cdf6f7182566834ecdbfb257","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/token&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// If user is logged in
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Load user from database
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findByPk</span><span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;id&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;username&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>JWT_SECRET_KEY</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>expiresIn</span><span class=o>:</span> <span class=s2>&#34;6h&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>token</span><span class=o>:</span> <span class=nx>token</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// user not found - probably deleted recently
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>404</span><span class=p>).</span><span class=nx>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Send unauthorized response
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><footer class=footline></footer></article></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/b033a3fb172049ce87a9a80844380f55498b1376>Jun 17, 2025</a></p></div></div><script src=/cis526/js/clipboard.min.js?1750186567 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1750186567 defer></script><script src=/cis526/js/theme.js?1750186567 defer></script></body></html>
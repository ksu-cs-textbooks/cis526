<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="YouTube Video Testing Role-Based Authorization Middleware Earlier in this example we created a generator function named roleBasedAuth (stored in middlewares/authorized-roles.js) that returns a middleware function named roleAuthMiddleware that we can use as a middleware in any of our RESTful API endpoints to ensure that only users with specific roles are able to perform each and every action in our API.
When it comes to testing, however, this can quickly become really complex."><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Testing Roles :: CIS 526 Textbook"><meta name=twitter:description content="YouTube Video Testing Role-Based Authorization Middleware Earlier in this example we created a generator function named roleBasedAuth (stored in middlewares/authorized-roles.js) that returns a middleware function named roleAuthMiddleware that we can use as a middleware in any of our RESTful API endpoints to ensure that only users with specific roles are able to perform each and every action in our API.
When it comes to testing, however, this can quickly become really complex."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/10-testing-roles/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Testing Roles :: CIS 526 Textbook"><meta property="og:description" content="YouTube Video Testing Role-Based Authorization Middleware Earlier in this example we created a generator function named roleBasedAuth (stored in middlewares/authorized-roles.js) that returns a middleware function named roleAuthMiddleware that we can use as a middleware in any of our RESTful API endpoints to ensure that only users with specific roles are able to perform each and every action in our API.
When it comes to testing, however, this can quickly become really complex."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="Example Projects"><meta property="article:modified_time" content="2025-05-09T14:53:08-05:00"><meta itemprop=name content="Testing Roles :: CIS 526 Textbook"><meta itemprop=description content="YouTube Video Testing Role-Based Authorization Middleware Earlier in this example we created a generator function named roleBasedAuth (stored in middlewares/authorized-roles.js) that returns a middleware function named roleAuthMiddleware that we can use as a middleware in any of our RESTful API endpoints to ensure that only users with specific roles are able to perform each and every action in our API.
When it comes to testing, however, this can quickly become really complex."><meta itemprop=dateModified content="2025-05-09T14:53:08-05:00"><meta itemprop=wordCount content="1363"><title>Testing Roles :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/10-testing-roles/ rel=canonical type=text/html title="Testing Roles :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/10-testing-roles/index.xml rel=alternate type=application/rss+xml title="Testing Roles :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/10-testing-roles/index.print.html rel=alternate type=text/html title="Testing Roles :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/10-testing-roles/embed.html rel=alternate type=text/html title="Testing Roles :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1746823120 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1746823120 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1746823120 rel=stylesheet><link href=/cis526/css/auto-complete.css?1746823120 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1746823120 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1746823120 rel=stylesheet><link href=/cis526/css/fonts.css?1746823120 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1746823120 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1746823120 rel=stylesheet><link href=/cis526/css/theme-auto.css?1746823120 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1746823120 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1746823120 rel=stylesheet><link href=/cis526/css/print.css?1746823120 rel=stylesheet media=print><script src=/cis526/js/variant.js?1746823120></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1746823120 rel=stylesheet></head><body class="mobile-support tele disableInlineCopyToClipboard" data-url=/cis526/x-examples/04-authentication/10-testing-roles/><div id=tele class="tele mirror"><div id=R-body class=default-animation><div id=R-body-overlay></div><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=testing-roles>Testing Roles</h1><a href="https://www.youtube.com/watch?v=lolT-mwmFvc">YouTube Video</a><h2 id=testing-role-based-authorization-middleware>Testing Role-Based Authorization Middleware</h2><p>Earlier in this example we created a generator function named <code>roleBasedAuth</code> (stored in <code>middlewares/authorized-roles.js</code>) that returns a middleware function named <code>roleAuthMiddleware</code> that we can use as a middleware in any of our RESTful API endpoints to ensure that only users with specific roles are able to perform each and every action in our API.</p><p>When it comes to testing, however, this can quickly become really complex. For example, if we have 15 routes and 6 user roles, we must write 120 tests just to test each combination of route and role in order to truly test this setup.</p><p>In addition, if we continue to use our current strategy of integration testing (where each test performs a full action on the API), the tests we write will need to be unique for each endpoint, so even if we simplify things, we&rsquo;ll still need at least 2 tests per endpoint (one for roles that should have access, and another for roles that should not).</p><p>Instead, let&rsquo;s look at a way we can deconstruct our Express application a bit to test two things directly:</p><ol><li>Is the <code>roleAuthMiddleware</code> present on each route?</li><li>Does the <code>roleAuthMiddleware</code> function allow the correct roles for each route?</li></ol><p>If we can confirm both of these for each route, we can assume that our role-based authorization is implemented correctly.</p><h2 id=express-route-stack>Express Route Stack</h2><p>As you may recall, applications written in Express consist of an application that has middlewares and handlers attached in a specific order. In addition, we can create smaller components called routers that each have their own middlewares and handlers attached. Overall, we may end up with a structure similar to this one:</p><p><a href=#R-image-4536ef6f1c1e2122aef5785c9eeb5a6c class=lightbox-link><img alt="Express Architecture" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/express-routing-http.svg style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4536ef6f1c1e2122aef5785c9eeb5a6c><img alt="Express Architecture" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/express-routing-http.svg></a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>A more detailed explanation of the structure of Express applications can be found here: <a href=https://www.sohamkamani.com/nodejs/expressjs-architecture/ rel=external target=_blank>https://www.sohamkamani.com/nodejs/expressjs-architecture/</a></p><p>In code, each Express router has a <code>stack</code> variable that contains a list of layers, which can either be middleware functions or actual route handlers. Middleware layers will contain the <code>name</code> of the middleware function, whereas route handlers can be checked using a <code>match</code> function to determine if the handler matches a given path.</p><p>So, in our <code>test/helpers.js</code> file, we can write a new helper function to this for our tests:</p><div class=tab-panel data-tab-group=dd2b301b5e9f5ec0c0b8a1b29a298ecf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("dd2b301b5e9f5ec0c0b8a1b29a298ecf","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Iterate through the router stack of an Express app to find a matching middleware function
</span></span></span><span class=line><span class=cl><span class=cm> * attached to a particular path and/or method
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} name the name of the function to find
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} path the path of the endpoint
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} method the HTTP method of the endpoint
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Router} router The Express router to search
</span></span></span><span class=line><span class=cl><span class=cm> * @returns
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>findMiddlewareFunction</span> <span class=o>=</span> <span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>app</span><span class=p>.</span><span class=nx>_router</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>layer</span> <span class=k>of</span> <span class=nx>router</span><span class=p>.</span><span class=nx>stack</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Return if the middleware function is found
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>layer</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>layer</span><span class=p>.</span><span class=nx>handle</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>layer</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=nx>path</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Recurse into a router
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>layer</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=s2>&#34;router&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>layer</span><span class=p>.</span><span class=nx>path</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Remove matching portion of path
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>path</span> <span class=o>=</span> <span class=nx>path</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=nx>layer</span><span class=p>.</span><span class=nx>path</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>findMiddlewareFunction</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>layer</span><span class=p>.</span><span class=nx>handle</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find matching handler
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>layer</span><span class=p>.</span><span class=nx>route</span> <span class=o>&amp;&amp;</span> <span class=nx>layer</span><span class=p>.</span><span class=nx>route</span><span class=p>.</span><span class=nx>methods</span><span class=p>[</span><span class=nx>method</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>findMiddlewareFunction</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>layer</span><span class=p>.</span><span class=nx>route</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Express 5.0 Updates</div><div class=box-content><p>Starting with Express version 5.0, <code>app._router</code> has been moved to <code>app.router</code> to make accessing the built-in router easier. This should be updated in the code above if you are running Express 5.0 or later. <a href=https://expressjs.com/en/guide/migrating-5.html#app.router rel=external target=_blank>Changelog</a></p></div></div><p>Using that function, we can now write another function to actually test our middleware using some mock objects:</p><div class=tab-panel data-tab-group=f05689610c0a785d49cb0cfe4140a99b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f05689610c0a785d49cb0cfe4140a99b","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>expect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>sinon</span> <span class=nx>from</span> <span class=s2>&#34;sinon&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test if a role is able to access the route via the roleAuthMiddleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} path the path of the endpoint
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} method the HTTP method of the endpoint
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} role the role to search for
</span></span></span><span class=line><span class=cl><span class=cm> * @param {boolean} allowed whether the role should be allowed to access the route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>testRoleBasedAuth</span> <span class=o>=</span> <span class=p>(</span><span class=nx>path</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>role</span><span class=p>,</span> <span class=nx>allowed</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;should role &#39;&#34;</span> <span class=o>+</span> <span class=nx>role</span> <span class=o>+</span> <span class=s2>&#34;&#39; access &#39;&#34;</span> <span class=o>+</span> <span class=nx>method</span> <span class=o>+</span> <span class=s2>&#34; &#34;</span> <span class=o>+</span> <span class=nx>path</span> <span class=o>+</span> <span class=s2>&#34;&#39;: &#34;</span> <span class=o>+</span> <span class=nx>allowed</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Mock Express Request object with token attached
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>req</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>token</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;test&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>role</span><span class=o>:</span> <span class=nx>role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Mock Express Response object
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>status</span><span class=o>:</span> <span class=nx>sinon</span><span class=p>.</span><span class=nx>stub</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>send</span><span class=o>:</span> <span class=nx>sinon</span><span class=p>.</span><span class=nx>stub</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>.</span><span class=nx>returns</span><span class=p>(</span><span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Mock Express Next Middleware function
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>next</span> <span class=o>=</span> <span class=nx>sinon</span><span class=p>.</span><span class=nx>stub</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Find the middleware function in the router stack for the given path and method
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>middleware</span> <span class=o>=</span> <span class=nx>findMiddlewareFunction</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;roleAuthMiddleware&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>expect</span><span class=p>(</span><span class=nx>middleware</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>not</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Call the middleware function
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>middleware</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>allowed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If allowed, expect the `next` function to be called
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>expect</span><span class=p>(</span><span class=nx>next</span><span class=p>.</span><span class=nx>calledOnce</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Otherwise, it should send a 401 response
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>.</span><span class=nx>calledWith</span><span class=p>(</span><span class=mi>401</span><span class=p>)).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div></div></div></div><p>The comments in the function describe how it works pretty clearly. Most of the code is just setting up barebones mock objects using <a href=https://sinonjs.org/ rel=external target=_blank>Sinon</a> for the Express request <code>req</code>, response <code>res</code>, and <code>next</code> middleware function. Once it finds our <code>roleAuthMiddleware</code> function in the router stack using the helper function above, it will call it and observe the response to determine if the user was allowed to access the desired endpoint or not.</p><p>The last thing we&rsquo;ll add to our <code>test/helpers.js</code> file is a helpful list of all of the roles available in the application, which we can use for our testing:</p><div class=tab-panel data-tab-group=5aa0210bfcf985f792884e2834fdd35c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5aa0210bfcf985f792884e2834fdd35c","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// List of global roles
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>all_roles</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;manage_users&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;manage_documents&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;add_documents&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;manage_communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;add_communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;view_documents&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;view_communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>];</span></span></span></code></pre></div></div></div></div></div><p>With those helpers in place, we can now add a few lines to our <code>test/api/v1/roles.js</code> test file to check whether each and every role can access the endpoint in that router.</p><div class=tab-panel data-tab-group=17c53cc25a1a0cb286d3dcc7555f68a8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("17c53cc25a1a0cb286d3dcc7555f68a8","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import Helpers
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>login</span><span class=p>,</span> <span class=nx>testRoleBasedAuth</span><span class=p>,</span> <span class=nx>all_roles</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../helpers.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/roles route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=s2>&#34;get&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This code does a couple of very nifty things. First, we clearly define which roles should be allowed to access the endpoint. This can be done as part of the unit testing file here, or we may have some global file in our test suite that documents each role and route that we can read from.</p><p>Below that, we iterate through the list of all roles exported from the <code>test/helpers.js</code> file, and call our <code>testRoleBasedAuth</code> method for each one of those roles. The last argument to that function is a boolean that determines whether the role should be able to access this route. To determine that, we simply see if the role from the list of global roles can also be found in the list of allowed roles. If so, that will be <code>true</code> and the function will check that the role can access the route. If not, it will be <code>false</code> and the function will confirm that the user is unable to access the route.</p><p>Now, when we run these tests, we&rsquo;ll see that each role is explicitly checked:</p><div class=tab-panel data-tab-group=878ffd135e78e629a1ecb124c482d992><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("878ffd135e78e629a1ecb124c482d992","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api/v1/roles
    GET /
      ✔ should list all roles
      ✔ all roles should match schema
      ✔ should contain &#39;manage_users&#39; role
      ✔ should contain &#39;manage_documents&#39; role
      ✔ should contain &#39;add_documents&#39; role
      ✔ should contain &#39;manage_communities&#39; role
      ✔ should contain &#39;add_communities&#39; role
      ✔ should contain &#39;view_documents&#39; role
      ✔ should contain &#39;view_communities&#39; role
      ✔ should role &#39;manage_users&#39; access &#39;get /api/v1/roles&#39;: true
      ✔ should role &#39;manage_documents&#39; access &#39;get /api/v1/roles&#39;: false
      ✔ should role &#39;add_documents&#39; access &#39;get /api/v1/roles&#39;: false
      ✔ should role &#39;manage_communities&#39; access &#39;get /api/v1/roles&#39;: false
      ✔ should role &#39;add_communities&#39; access &#39;get /api/v1/roles&#39;: false
      ✔ should role &#39;view_documents&#39; access &#39;get /api/v1/roles&#39;: false
      ✔ should role &#39;view_communities&#39; access &#39;get /api/v1/roles&#39;: false</code></pre></div></div></div></div></div><p>There we go! We now have a very flexible way to test our role-based authorization.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Image Source: <a href=https://www.sohamkamani.com/nodejs/expressjs-architecture/ rel=external target=_blank>https://www.sohamkamani.com/nodejs/expressjs-architecture/</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><footer class=footline></footer></article></div></main></div></div><script src=/cis526/js/clipboard.min.js?1746823120 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1746823120 defer></script><script src=/cis526/js/theme.js?1746823120 defer></script><script src=/cis526/js/tele-scroll.js?1746823120 defer></script></body></html>
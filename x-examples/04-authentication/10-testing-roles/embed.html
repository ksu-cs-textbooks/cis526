<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=html><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.148.1"><meta name=generator content="Relearn 8.0.0"><meta name=description content="Testing Role-Based Authorization Middleware Earlier in this example we created a generator function named roleBasedAuth (stored in middlewares/authorized-roles.js) that returns a middleware function named roleAuthMiddleware that we can use as a middleware in any of our RESTful API endpoints to ensure that only users with specific roles are able to perform each and every action in our API."><meta name=author content="Nathan Bean & Russell Feldhausen"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta name=twitter:title content="Testing Roles :: CIS 526 Textbook"><meta name=twitter:description content="Testing Role-Based Authorization Middleware Earlier in this example we created a generator function named roleBasedAuth (stored in middlewares/authorized-roles.js) that returns a middleware function named roleAuthMiddleware that we can use as a middleware in any of our RESTful API endpoints to ensure that only users with specific roles are able to perform each and every action in our API."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/10-testing-roles/index.html"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Testing Roles :: CIS 526 Textbook"><meta property="og:description" content="Testing Role-Based Authorization Middleware Earlier in this example we created a generator function named roleBasedAuth (stored in middlewares/authorized-roles.js) that returns a middleware function named roleAuthMiddleware that we can use as a middleware in any of our RESTful API endpoints to ensure that only users with specific roles are able to perform each and every action in our API."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="Example Projects"><meta property="article:modified_time" content="2025-05-16T10:51:50-05:00"><meta property="og:image" content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta itemprop=name content="Testing Roles :: CIS 526 Textbook"><meta itemprop=description content="Testing Role-Based Authorization Middleware Earlier in this example we created a generator function named roleBasedAuth (stored in middlewares/authorized-roles.js) that returns a middleware function named roleAuthMiddleware that we can use as a middleware in any of our RESTful API endpoints to ensure that only users with specific roles are able to perform each and every action in our API."><meta itemprop=dateModified content="2025-05-16T10:51:50-05:00"><meta itemprop=wordCount content="1379"><meta itemprop=image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><title>Testing Roles :: CIS 526 Textbook</title><link href=https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/10-testing-roles/index.html rel=canonical type=text/html title="Testing Roles :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/10-testing-roles/index.xml rel=alternate type=application/rss+xml title="Testing Roles :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/10-testing-roles/index.print.html rel=alternate type=text/html title="Testing Roles :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/10-testing-roles/tele.html rel=alternate type=text/html title="Testing Roles :: CIS 526 Textbook"><link href=/cis526/css/auto-complete/auto-complete.min.css?1769118339 rel=stylesheet><script src=/cis526/js/auto-complete/auto-complete.min.js?1769118339 defer></script><script src=/cis526/js/search-lunr.min.js?1769118339 defer></script><script src=/cis526/js/search.min.js?1769118339 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/cis526/searchindex.en.js?1769118339"</script><script src=/cis526/js/lunr/lunr.min.js?1769118339 defer></script><script src=/cis526/js/lunr/lunr.stemmer.support.min.js?1769118339 defer></script><script src=/cis526/js/lunr/lunr.multi.min.js?1769118339 defer></script><script src=/cis526/js/lunr/lunr.en.min.js?1769118339 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1769118339 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1769118339 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar/perfect-scrollbar.min.css?1769118339 rel=stylesheet><link href=/cis526/css/theme.min.css?1769118339 rel=stylesheet><link href=/cis526/css/format-html.min.css?1769118339 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/x-examples/04-authentication/10-testing-roles/index.html",window.relearn.relBasePath="../../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!1,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.relearn.themevariants=["light-theme"],window.relearn.customvariantname="my-custom-variant",window.relearn.writeVariant=!1,window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.writeVariant&&window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><link href=/cis526/css/custom.css?1769118339 rel=stylesheet></head><body class="mobile-support embed html" data-url=/cis526/x-examples/04-authentication/10-testing-roles/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><div id=R-main-overlay></div><main id=R-body-inner class="highlightable x-examples" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=testing-roles>Testing Roles</h1><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/lolT-mwmFvc style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><h2 id=testing-role-based-authorization-middleware>Testing Role-Based Authorization Middleware</h2><p>Earlier in this example we created a generator function named <code>roleBasedAuth</code> (stored in <code>middlewares/authorized-roles.js</code>) that returns a middleware function named <code>roleAuthMiddleware</code> that we can use as a middleware in any of our RESTful API endpoints to ensure that only users with specific roles are able to perform each and every action in our API.</p><p>When it comes to testing, however, this can quickly become really complex. For example, if we have 15 routes and 6 user roles, we must write 120 tests just to test each combination of route and role in order to truly test this setup.</p><p>In addition, if we continue to use our current strategy of integration testing (where each test performs a full action on the API), the tests we write will need to be unique for each endpoint, so even if we simplify things, we&rsquo;ll still need at least 2 tests per endpoint (one for roles that should have access, and another for roles that should not).</p><p>Instead, let&rsquo;s look at a way we can deconstruct our Express application a bit to test two things directly:</p><ol><li>Is the <code>roleAuthMiddleware</code> present on each route?</li><li>Does the <code>roleAuthMiddleware</code> function allow the correct roles for each route?</li></ol><p>If we can confirm both of these for each route, we can assume that our role-based authorization is implemented correctly.</p><h2 id=express-route-stack>Express Route Stack</h2><p>As you may recall, applications written in Express consist of an application that has middlewares and handlers attached in a specific order. In addition, we can create smaller components called routers that each have their own middlewares and handlers attached. Overall, we may end up with a structure similar to this one:</p><p><a href=#R-image-d24c32ad475e45f3802e9e7c57f9752e class=lightbox-link><img alt="Express Architecture" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/express-routing-http.svg style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d24c32ad475e45f3802e9e7c57f9752e><img alt="Express Architecture" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/express-routing-http.svg></a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>A more detailed explanation of the structure of Express applications can be found here: <a href=https://www.sohamkamani.com/nodejs/expressjs-architecture/ rel=external target=_blank>https://www.sohamkamani.com/nodejs/expressjs-architecture/</a></p><p>In code, each Express router has a <code>stack</code> variable that contains a list of layers, which can either be middleware functions or actual route handlers. Middleware layers will contain the <code>name</code> of the middleware function, whereas route handlers can be checked using a <code>match</code> function to determine if the handler matches a given path.</p><p>So, in our <code>test/helpers.js</code> file, we can write a new helper function to this for our tests:</p><div class=tab-panel data-tab-group=0ea8342bf39d3c9c9b4c7cc5de55b613><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0ea8342bf39d3c9c9b4c7cc5de55b613","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Iterate through the router stack of an Express app to find a matching middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> * attached to a particular path and/or method
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {string} name the name of the function to find
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {string} path the path of the endpoint
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {string} method the HTTP method of the endpoint
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Router} router The Express router to search
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @returns
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>findMiddlewareFunction</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>method</span>, <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>_router</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Replace blank paths with the default / path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>layer</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>stack</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Return if the middleware function is found
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>name</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>handle</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>match</span>(<span style=color:#a6e22e>path</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Recurse into a router
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;router&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>          <span style=color:#75715e>// Remove matching portion of path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>slice</span>(<span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>findMiddlewareFunction</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>method</span>, <span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>handle</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Find matching handler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>route</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>route</span>.<span style=color:#a6e22e>methods</span>[<span style=color:#a6e22e>method</span>]) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>findMiddlewareFunction</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>method</span>, <span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>route</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
Express 5.0 Updates</summary><div class=box-content><p>Starting with Express version 5.0, <code>app._router</code> has been moved to <code>app.router</code> to make accessing the built-in router easier. This should be updated in the code above if you are running Express 5.0 or later. <a href=https://expressjs.com/en/guide/migrating-5.html#app.router rel=external target=_blank>Changelog</a></p></div></details><p>Using that function, we can now write another function to actually test our middleware using some mock objects:</p><div class=tab-panel data-tab-group=e64ea45be85027a69efd812b1b9c6e2f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e64ea45be85027a69efd812b1b9c6e2f","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>request</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;supertest&#34;</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai&#34;</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>sinon</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;sinon&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test if a role is able to access the route via the roleAuthMiddleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {string} path the path of the endpoint
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {string} method the HTTP method of the endpoint
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {string} role the role to search for
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {boolean} allowed whether the role should be allowed to access the route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>testRoleBasedAuth</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>method</span>, <span style=color:#a6e22e>role</span>, <span style=color:#a6e22e>allowed</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;should role &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>role</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; access &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>method</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>allowed</span>,
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Mock Express Request object with token attached
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>req</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>roles</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>role</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Mock Express Response object
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>sinon</span>.<span style=color:#a6e22e>stub</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>send</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>sinon</span>.<span style=color:#a6e22e>stub</span>(),
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>returns</span>(<span style=color:#a6e22e>res</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Mock Express Next Middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sinon</span>.<span style=color:#a6e22e>stub</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Find the middleware function in the router stack for the given path and method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>middleware</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>findMiddlewareFunction</span>(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;roleAuthMiddleware&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>path</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span>,
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>middleware</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>not</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Call the middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>middleware</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>allowed</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If allowed, expect the `next` function to be called
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>calledOnce</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Otherwise, it should send a 401 response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>calledWith</span>(<span style=color:#ae81ff>401</span>)).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>};</span></span></code></pre></div></div></div></div></div><p>The comments in the function describe how it works pretty clearly. Most of the code is just setting up barebones mock objects using <a href=https://sinonjs.org/ rel=external target=_blank>Sinon</a> for the Express request <code>req</code>, response <code>res</code>, and <code>next</code> middleware function. Once it finds our <code>roleAuthMiddleware</code> function in the router stack using the helper function above, it will call it and observe the response to determine if the user was allowed to access the desired endpoint or not.</p><p>The last thing we&rsquo;ll add to our <code>test/helpers.js</code> file is a helpful list of all of the roles available in the application, which we can use for our testing:</p><div class=tab-panel data-tab-group=8050708b39ed4969f08fd5f8241c880d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8050708b39ed4969f08fd5f8241c880d","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// List of global roles
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>all_roles</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;manage_users&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;manage_documents&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;add_documents&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;manage_communities&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;add_communities&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;view_documents&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;view_communities&#34;</span>,
</span></span><span style=display:flex><span>];</span></span></code></pre></div></div></div></div></div><p>With those helpers in place, we can now add a few lines to our <code>test/api/v1/roles.js</code> test file to check whether each and every role can access the endpoint in that router.</p><div class=tab-panel data-tab-group=d9ad809d021ef4b89ba7f1540aa59f36><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d9ad809d021ef4b89ba7f1540aa59f36","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Helpers
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>login</span>, <span style=color:#a6e22e>testRoleBasedAuth</span>, <span style=color:#a6e22e>all_roles</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../helpers.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/roles route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/roles&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>allowed_roles</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;manage_users&#34;</span>];
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>all_roles</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#a6e22e>testRoleBasedAuth</span>(<span style=color:#e6db74>&#34;/api/v1/roles&#34;</span>, <span style=color:#e6db74>&#34;get&#34;</span>, <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>allowed_roles</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>r</span>))
</span></span><span style=display:flex;background-color:#3c3d38><span>    })
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>This code does a couple of very nifty things. First, we clearly define which roles should be allowed to access the endpoint. This can be done as part of the unit testing file here, or we may have some global file in our test suite that documents each role and route that we can read from.</p><p>Below that, we iterate through the list of all roles exported from the <code>test/helpers.js</code> file, and call our <code>testRoleBasedAuth</code> method for each one of those roles. The last argument to that function is a boolean that determines whether the role should be able to access this route. To determine that, we simply see if the role from the list of global roles can also be found in the list of allowed roles. If so, that will be <code>true</code> and the function will check that the role can access the route. If not, it will be <code>false</code> and the function will confirm that the user is unable to access the route.</p><p>Now, when we run these tests, we&rsquo;ll see that each role is explicitly checked:</p><div class=tab-panel data-tab-group=27488521b8b38d0a6b5b0d357c44e2a1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("27488521b8b38d0a6b5b0d357c44e2a1","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0><code>  /api/v1/roles
    GET /
      ✔ should list all roles
      ✔ all roles should match schema
      ✔ should contain &#39;manage_users&#39; role
      ✔ should contain &#39;manage_documents&#39; role
      ✔ should contain &#39;add_documents&#39; role
      ✔ should contain &#39;manage_communities&#39; role
      ✔ should contain &#39;add_communities&#39; role
      ✔ should contain &#39;view_documents&#39; role
      ✔ should contain &#39;view_communities&#39; role
      ✔ should role &#39;manage_users&#39; access &#39;get /api/v1/roles&#39;: true
      ✔ should role &#39;manage_documents&#39; access &#39;get /api/v1/roles&#39;: false
      ✔ should role &#39;add_documents&#39; access &#39;get /api/v1/roles&#39;: false
      ✔ should role &#39;manage_communities&#39; access &#39;get /api/v1/roles&#39;: false
      ✔ should role &#39;add_communities&#39; access &#39;get /api/v1/roles&#39;: false
      ✔ should role &#39;view_documents&#39; access &#39;get /api/v1/roles&#39;: false
      ✔ should role &#39;view_communities&#39; access &#39;get /api/v1/roles&#39;: false</code></pre></div></div></div></div></div><p>There we go! We now have a very flexible way to test our role-based authorization.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Image Source: <a href=https://www.sohamkamani.com/nodejs/expressjs-architecture/ rel=external target=_blank>https://www.sohamkamani.com/nodejs/expressjs-architecture/</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><footer class=footline></footer></article></div></main></div><script src=/cis526/js/clipboard/clipboard.min.js?1769118339 defer></script><script src=/cis526/js/perfect-scrollbar/perfect-scrollbar.min.js?1769118339 defer></script><script src=/cis526/js/theme.min.js?1769118339 defer></script><script src=/cis526/js/embed-iframe.min.js?1769118339 defer></script></body></html>
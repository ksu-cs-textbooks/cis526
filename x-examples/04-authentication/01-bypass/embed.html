<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=html><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.148.1"><meta name=generator content="Relearn 8.0.0"><meta name=description content="Authentication Libraries There are many different authentication libraries and methods available for Node.js and Express. For this project, we will use the Passport.js library. It supports many different authentication strategies, and is a very common way that authentication is handled within JavaScript applications.
For our application, we’ll end up using several strategies to authenticate our users:"><meta name=author content="Nathan Bean & Russell Feldhausen"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta name=twitter:title content="Bypass Auth :: CIS 526 Textbook"><meta name=twitter:description content="Authentication Libraries There are many different authentication libraries and methods available for Node.js and Express. For this project, we will use the Passport.js library. It supports many different authentication strategies, and is a very common way that authentication is handled within JavaScript applications.
For our application, we’ll end up using several strategies to authenticate our users:"><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/01-bypass/index.html"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Bypass Auth :: CIS 526 Textbook"><meta property="og:description" content="Authentication Libraries There are many different authentication libraries and methods available for Node.js and Express. For this project, we will use the Passport.js library. It supports many different authentication strategies, and is a very common way that authentication is handled within JavaScript applications.
For our application, we’ll end up using several strategies to authenticate our users:"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="Example Projects"><meta property="article:modified_time" content="2025-04-15T11:23:51-05:00"><meta property="og:image" content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta itemprop=name content="Bypass Auth :: CIS 526 Textbook"><meta itemprop=description content="Authentication Libraries There are many different authentication libraries and methods available for Node.js and Express. For this project, we will use the Passport.js library. It supports many different authentication strategies, and is a very common way that authentication is handled within JavaScript applications.
For our application, we’ll end up using several strategies to authenticate our users:"><meta itemprop=dateModified content="2025-04-15T11:23:51-05:00"><meta itemprop=wordCount content="1590"><meta itemprop=image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><title>Bypass Auth :: CIS 526 Textbook</title><link href=https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/01-bypass/index.html rel=canonical type=text/html title="Bypass Auth :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/01-bypass/index.xml rel=alternate type=application/rss+xml title="Bypass Auth :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/01-bypass/index.print.html rel=alternate type=text/html title="Bypass Auth :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/01-bypass/tele.html rel=alternate type=text/html title="Bypass Auth :: CIS 526 Textbook"><link href=/cis526/css/auto-complete/auto-complete.min.css?1770225504 rel=stylesheet><script src=/cis526/js/auto-complete/auto-complete.min.js?1770225504 defer></script><script src=/cis526/js/search-lunr.min.js?1770225504 defer></script><script src=/cis526/js/search.min.js?1770225504 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/cis526/searchindex.en.js?1770225504"</script><script src=/cis526/js/lunr/lunr.min.js?1770225504 defer></script><script src=/cis526/js/lunr/lunr.stemmer.support.min.js?1770225504 defer></script><script src=/cis526/js/lunr/lunr.multi.min.js?1770225504 defer></script><script src=/cis526/js/lunr/lunr.en.min.js?1770225504 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1770225504 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1770225504 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar/perfect-scrollbar.min.css?1770225504 rel=stylesheet><link href=/cis526/css/theme.min.css?1770225504 rel=stylesheet><link href=/cis526/css/format-html.min.css?1770225504 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/x-examples/04-authentication/01-bypass/index.html",window.relearn.relBasePath="../../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!1,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.relearn.themevariants=["light-theme"],window.relearn.customvariantname="my-custom-variant",window.relearn.writeVariant=!1,window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.writeVariant&&window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><link href=/cis526/css/custom.css?1770225504 rel=stylesheet></head><body class="mobile-support embed html" data-url=/cis526/x-examples/04-authentication/01-bypass/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><div id=R-main-overlay></div><main id=R-body-inner class="highlightable x-examples" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=bypass-auth>Bypass Auth</h1><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/NjrWPg41_B4 style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><h2 id=authentication-libraries>Authentication Libraries</h2><p>There are many different authentication libraries and methods available for Node.js and Express. For this project, we will use the <a href=https://www.passportjs.org/ rel=external target=_blank>Passport.js</a> library. It supports many different authentication strategies, and is a very common way that authentication is handled within JavaScript applications.</p><p>For our application, we&rsquo;ll end up using several strategies to authenticate our users:</p><ul><li><a href=https://www.passportjs.org/packages/passport-unique-token/ rel=external target=_blank>Unique Token</a> - used to bypass authentication for testing</li><li><a href=https://github.com/appdevdesigns/passport-cas rel=external target=_blank>CAS</a> - used to authenticate with <a href=https://apereo.github.io/cas/7.1.x/index.html rel=external target=_blank>Central Authentication Service (CAS)</a> servers such as those used at K-State</li><li><a href=https://www.passportjs.org/packages/passport-jwt-cookiecombo/ rel=external target=_blank>JSON Web Tokens (JWT)</a> - used to identify user requests to the API itself</li></ul><p>Let&rsquo;s first set up our unique token strategy, which allows us to test our authentication routes before setting up anything else.</p><h2 id=authentication-router>Authentication Router</h2><p>First, we&rsquo;ll need to create a new route file at <code>routes/auth.js</code> to contain our authentication routes. We&rsquo;ll start with this basic structure and work on filling in each method as we go.</p><div class=tab-panel data-tab-group=aa4a8bbf14c3931c442445939b0a28f8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("aa4a8bbf14c3931c442445939b0a28f8","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file Auth router
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @exports router an Express router
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * tags:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   name: auth
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   description: Authentication Routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> * components:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   securitySchemes:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     bearerAuth:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       type: http
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       scheme: bearer
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       bearerFormat: JWT
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   responses:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     AuthToken:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       description: authentication success
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       content:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         application/json:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *           schema:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *             type: object
</span></span></span><span style=display:flex><span><span style=color:#75715e> *             required:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *               - token
</span></span></span><span style=display:flex><span><span style=color:#75715e> *             properties:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *               token:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *                 type: string
</span></span></span><span style=display:flex><span><span style=color:#75715e> *                 description: a JWT for the user
</span></span></span><span style=display:flex><span><span style=color:#75715e> *             example:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *               token: abcdefg12345
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>express</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;express&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>passport</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;passport&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import configurations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#34;../configs/auth.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create Express router
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>Router</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Authentication Response Handler
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} req - Express request object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} res - Express response object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Function} next - Express next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authSuccess</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Bypass authentication for testing
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} req - Express request object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} res - Express response object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Function} next - Express next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * /auth/bypass:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   get:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     summary: bypass authentication for testing
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     description: Bypasses CAS authentication for testing purposes
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     tags: [auth]
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     parameters:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       - in: query
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         name: token
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         required: true
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         schema:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *           type: string
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         description: username
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     responses:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       200:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         description: success
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/bypass&#34;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * CAS Authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} req - Express request object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} res - Express response object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Function} next - Express next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * /auth/cas:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   get:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     summary: CAS authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     description:  CAS authentication for deployment
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     tags: [auth]
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     responses:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       200:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         description: success
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/cas&#34;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Request JWT based on previous authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} req - Express request object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} res - Express response object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Function} next - Express next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * /auth/token:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   get:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     summary: request JWT 
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     description: request JWT based on previous authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     tags: [auth]
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     responses:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       200:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         $ref: &#39;#/components/responses/AuthToken&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/token&#34;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>router</span>;</span></span></code></pre></div></div></div></div></div><p>This file includes a few items to take note of:</p><ul><li>In the top-level Open API comment, we define a new <code>AuthToken</code> response that we&rsquo;ll send to the user when they request a token.</li><li>We create three routes. The first two, <code>/auth/bypass</code> and <code>/auth/cas</code>, for each of our authentication strategies. The last one, <code>/auth/token</code> will be used by our frontend to request a token to access the API.</li><li>Finally, we&rsquo;ll build a <code>authSuccess</code> function to handle actually sending the response to the user.</li></ul><p>Before moving on, let&rsquo;s go ahead and add this router to our <code>app.js</code> file along with the other routers:</p><div class=tab-panel data-tab-group=318d42435348def70287dba2c1148cc3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("318d42435348def70287dba2c1148cc3","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import routers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>indexRouter</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./routes/index.js&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>apiRouter</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./routes/api.js&#34;</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>authRouter</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./routes/auth.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Use routers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>indexRouter</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/api&#34;</span>, <span style=color:#a6e22e>apiRouter</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, <span style=color:#a6e22e>authRouter</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll come back to this file once we are ready to link up our authentication strategies.</p><h2 id=unique-token-authentication>Unique Token Authentication</h2><p>Next, let&rsquo;s install both <code>passport</code> and the <code>passport-unique-token</code> authentication strategy:</p><div class=tab-panel data-tab-group=1d85dc02d9a9428fd1e7897e775d34f7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1d85dc02d9a9428fd1e7897e775d34f7","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm install passport passport-unique-token</span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll configure that strategy in a new <code>configs/auth.js</code> file with the following content:</p><div class=tab-panel data-tab-group=a2d15aa7b49e622b4f234739343e6e3a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a2d15aa7b49e622b4f234739343e6e3a","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file Configuration information for Passport.js Authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>passport</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;passport&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>UniqueTokenStrategy</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;passport-unique-token&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import models
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>User</span>, <span style=color:#a6e22e>Role</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../models/models.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import logger
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>logger</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./logger.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Authenticate a user
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {string} username the username to authenticate
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {function} next the next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authenticateUser</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Find user with the username
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findOne</span>({ 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;username&#34;</span>],
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>include</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>model</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Role</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>as</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;roles&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;role&#34;</span>],
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>through</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>username</span> },
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// User not found
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>user</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;Login failed for user: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>username</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// User authenticated
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;Login succeeded for user: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Convert Sequelize object to plain JavaScript object
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>user</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Bypass Authentication via Token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>passport</span>.<span style=color:#a6e22e>use</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>UniqueTokenStrategy</span>(
</span></span><span style=display:flex><span>  <span style=color:#75715e>// verify callback function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  (<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>next</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>authenticateUser</span>(<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>next</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Default functions to serialize and deserialize a session
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>passport</span>.<span style=color:#a6e22e>serializeUser</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>done</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>done</span>(<span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>passport</span>.<span style=color:#a6e22e>deserializeUser</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>done</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>done</span>(<span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>In this file, we created an <code>authenticateUser</code> function that will look for a user based on a given username. If found, it will return that user by calling the <code>next</code> middleware function. Otherwise, it will call that function and provide <code>false</code>.</p><p>Below, we configure Passport.js using the <code>passport.use</code> function to define the various authentication strategies we want to use. In this case, we&rsquo;ll start with the <a href=https://www.passportjs.org/packages/passport-unique-token/ rel=external target=_blank>Unique Token Strategy</a>, which uses a token provided as part of a query to the web server.</p><p>In addition, we need to implement some default functions to handle serializing and deserializing a user from a session. These functions don&rsquo;t really have any content in our implementation; we just need to include the default code.</p><p>Finally, since Passport.js acts as a global object, we don&rsquo;t even have to export anything from this file!</p><h2 id=testing-authentication>Testing Authentication</h2><p>To test this authentication strategy, let&rsquo;s modify <code>routes/auth.js</code> to use this strategy. We&rsquo;ll update the <code>/auth/bypass</code> route and also add some temporary code to the <code>authSuccess</code> function:</p><div class=tab-panel data-tab-group=2f8da9c6d3c226908827c4bcdc8769c8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2f8da9c6d3c226908827c4bcdc8769c8","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>express</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;express&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>passport</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;passport&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e>// Import configurations
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#34;../configs/auth.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authSuccess</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex;background-color:#3c3d38><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/bypass&#34;</span>, <span style=color:#a6e22e>passport</span>.<span style=color:#a6e22e>authenticate</span>(<span style=color:#e6db74>&#39;token&#39;</span>, {<span style=color:#a6e22e>session</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>}), <span style=color:#a6e22e>authSuccess</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>In the <code>authSuccess</code> function, right now we are just sending the content of <code>req.user</code>, which is set by Passport.js on a successful authentication (it is the value we returned when calling the <code>next</code> function in our authentication strategy earlier). We&rsquo;ll come back to this later when we implement JSON Web Tokens (JWT) later in this tutorial.</p><p>The other major change is that now the <code>/auth/bypass</code> route calls the <code>passport.authenticate</code> method with the <code>'token'</code> strategy specified. It also uses <code>{session: false}</code> as one of the options provided to Passport.js since we aren&rsquo;t actually going to be using sessions. Finally, if that middleware is satisfied, it will call the <code>authSuccess</code> function to handle sending the response to the user. This takes advantage of the chaining that we can do in Express!</p><p>With all of that in place, we can test our server and see if it works:</p><div class=tab-panel data-tab-group=bb61d7db1285dd02101d1e878141a588><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bb61d7db1285dd02101d1e878141a588","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once the page loads, we want to navigate to the <code>/auth/bypass?token=admin</code> path to see if we can log in as the <code>admin</code> user. Notice that we are including a query parameter named <code>token</code> to include the username in the URL.</p><p><a href=#R-image-28b51e7b56f463868f48cc1faf695c8a class=lightbox-link><img alt="Successful Authentication" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-28b51e7b56f463868f48cc1faf695c8a><img alt="Successful Authentication" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_1.png></a></p><p>There we go! We see that it successfully finds our <code>admin</code> user and returns data about that user, including the roles assigned. This is what we want to see. We can also test this by providing other usernames to make sure it is working.</p><h2 id=securing-authentication>Securing Authentication</h2><p>Of course, we don&rsquo;t want to have this bypass authentication system available all the time in our application. In fact, we really only want to use it for testing and debugging; otherwise, our application will have a major security flaw! So, let&rsquo;s add a new environment variable <code>BYPASS_AUTH</code> to our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. We should set it to <code>TRUE</code> in the <code>.env.test</code> file, and for now we&rsquo;ll have it enabled in our <code>.env</code> file as well, but this option should <strong>NEVER</strong> be enabled in a production setting.</p><div class=tab-panel data-tab-group=c0bbcf1c9b86de25ad1767d8609c8461><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c0bbcf1c9b86de25ad1767d8609c8461","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-env data-lang=env><span style=display:flex><span><span style=color:#75715e># -=-=- other settings omitted here -=-=-</span>
</span></span><span style=display:flex><span>BYPASS_AUTH<span style=color:#f92672>=</span>true</span></span></code></pre></div></div></div></div></div><p>With that setting in place, we can add it to our <code>configs/auth.js</code> file to only allow bypass authentication if that setting is enabled:</p><div class=tab-panel data-tab-group=048ab8f74811588ea42214d45a7dede1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("048ab8f74811588ea42214d45a7dede1","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Bypass Authentication via Token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>passport</span>.<span style=color:#a6e22e>use</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>UniqueTokenStrategy</span>(
</span></span><span style=display:flex><span>  <span style=color:#75715e>// verify callback function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  (<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>next</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Only allow token authentication when enabled
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BYPASS_AUTH</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;true&#34;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>authenticateUser</span>(<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>next</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>))</span></span></code></pre></div></div></div></div></div><p>Before moving on, we should make sure we test both enabling and disabling this setting <em>actually</em> disables bypass authentication. We want to be absolutely sure it works as intended!</p><p><a href=#R-image-95ab18ca940f4bc5011122a93cf3b684 class=lightbox-link><img alt="Disabled Authentication" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-95ab18ca940f4bc5011122a93cf3b684><img alt="Disabled Authentication" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_2.png></a></p><footer class=footline></footer></article></div></main></div><script src=/cis526/js/clipboard/clipboard.min.js?1770225504 defer></script><script src=/cis526/js/perfect-scrollbar/perfect-scrollbar.min.js?1770225504 defer></script><script src=/cis526/js/theme.min.js?1770225504 defer></script><script src=/cis526/js/embed-iframe.min.js?1770225504 defer></script></body></html>
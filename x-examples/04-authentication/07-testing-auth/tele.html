<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=html><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.148.1"><meta name=generator content="Relearn 8.0.0"><meta name=description content="YouTube Video Testing Authentication Routes Now that we have our authentication system working for our application, let’s write some unit tests to confirm that it works as expected in a variety of situations.
As part of these tests, we’ll end up creating a test double of one part of our authentication system to make it easier to test. To do this, we’ll use the Sinon library, so let’s start by installing it as a development dependency:"><meta name=author content="Nathan Bean & Russell Feldhausen"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta name=twitter:title content="Testing Authentication :: CIS 526 Textbook"><meta name=twitter:description content="YouTube Video Testing Authentication Routes Now that we have our authentication system working for our application, let’s write some unit tests to confirm that it works as expected in a variety of situations.
As part of these tests, we’ll end up creating a test double of one part of our authentication system to make it easier to test. To do this, we’ll use the Sinon library, so let’s start by installing it as a development dependency:"><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/07-testing-auth/index.html"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Testing Authentication :: CIS 526 Textbook"><meta property="og:description" content="YouTube Video Testing Authentication Routes Now that we have our authentication system working for our application, let’s write some unit tests to confirm that it works as expected in a variety of situations.
As part of these tests, we’ll end up creating a test double of one part of our authentication system to make it easier to test. To do this, we’ll use the Sinon library, so let’s start by installing it as a development dependency:"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="Example Projects"><meta property="article:modified_time" content="2025-04-16T16:10:10-05:00"><meta property="og:image" content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta itemprop=name content="Testing Authentication :: CIS 526 Textbook"><meta itemprop=description content="YouTube Video Testing Authentication Routes Now that we have our authentication system working for our application, let’s write some unit tests to confirm that it works as expected in a variety of situations.
As part of these tests, we’ll end up creating a test double of one part of our authentication system to make it easier to test. To do this, we’ll use the Sinon library, so let’s start by installing it as a development dependency:"><meta itemprop=dateModified content="2025-04-16T16:10:10-05:00"><meta itemprop=wordCount content="2989"><meta itemprop=image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><title>Testing Authentication :: CIS 526 Textbook</title><link href=https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/07-testing-auth/index.html rel=canonical type=text/html title="Testing Authentication :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/07-testing-auth/index.xml rel=alternate type=application/rss+xml title="Testing Authentication :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/07-testing-auth/index.print.html rel=alternate type=text/html title="Testing Authentication :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/07-testing-auth/embed.html rel=alternate type=text/html title="Testing Authentication :: CIS 526 Textbook"><link href=/cis526/css/auto-complete/auto-complete.min.css?1768424848 rel=stylesheet><script src=/cis526/js/auto-complete/auto-complete.min.js?1768424848 defer></script><script src=/cis526/js/search-lunr.min.js?1768424848 defer></script><script src=/cis526/js/search.min.js?1768424848 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/cis526/searchindex.en.js?1768424848"</script><script src=/cis526/js/lunr/lunr.min.js?1768424848 defer></script><script src=/cis526/js/lunr/lunr.stemmer.support.min.js?1768424848 defer></script><script src=/cis526/js/lunr/lunr.multi.min.js?1768424848 defer></script><script src=/cis526/js/lunr/lunr.en.min.js?1768424848 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1768424848 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1768424848 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar/perfect-scrollbar.min.css?1768424848 rel=stylesheet><link href=/cis526/css/theme.min.css?1768424848 rel=stylesheet><link href=/cis526/css/format-html.min.css?1768424848 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/x-examples/04-authentication/07-testing-auth/index.html",window.relearn.relBasePath="../../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!1,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.relearn.themevariants=["light-theme"],window.relearn.customvariantname="my-custom-variant",window.relearn.writeVariant=!1,window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.writeVariant&&window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><link href=/cis526/css/custom.css?1768424848 rel=stylesheet></head><body class="mobile-support html" data-url=/cis526/x-examples/04-authentication/07-testing-auth/index.html><div id=tele class="tele mirror"><div id=R-body class=default-animation><div id=R-body-overlay></div><div id=R-main-overlay></div><main id=R-body-inner class="highlightable x-examples" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=testing-authentication>Testing Authentication</h1><a href="https://www.youtube.com/watch?v=W4jM6hkYuks">YouTube Video</a><h2 id=testing-authentication-routes>Testing Authentication Routes</h2><p>Now that we have our authentication system working for our application, let&rsquo;s write some unit tests to confirm that it works as expected in a variety of situations.</p><p>As part of these tests, we&rsquo;ll end up creating a <a href=https://en.wikipedia.org/wiki/Test_double rel=external target=_blank>test double</a> of one part of our authentication system to make it easier to test. To do this, we&rsquo;ll use the <a href=https://sinonjs.org/ rel=external target=_blank>Sinon</a> library, so let&rsquo;s start by installing it as a development dependency:</p><div class=tab-panel data-tab-group=117095d75371674bbbdfbc7591590740><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("117095d75371674bbbdfbc7591590740","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm install --save-dev sinon</span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll store these tests in the <code>test/auth.js</code> file, starting with this content including the libraries we&rsquo;ll need to use:</p><div class=tab-panel data-tab-group=0203af3def456b5fa671ff46938c7c5f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0203af3def456b5fa671ff46938c7c5f","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file /auth Route Tests
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Load Libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>request</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;supertest&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>use</span>, <span style=color:#a6e22e>should</span>, <span style=color:#a6e22e>expect</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>chaiJsonSchemaAjv</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai-json-schema-ajv&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>chaiShallowDeepEqual</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai-shallow-deep-equal&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>sinon</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;sinon&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>jsonwebtoken</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;jsonwebtoken&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>chaiJsonSchemaAjv</span>.<span style=color:#a6e22e>create</span>({ <span style=color:#a6e22e>verbose</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> }));
</span></span><span style=display:flex><span><span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>chaiShallowDeepEqual</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Express application
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>app</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../app.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Database
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>User</span>, <span style=color:#a6e22e>Role</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../models/models.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Modify Object.prototype for BDD style assertions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>should</span>();</span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll continue to build out tests below that content in the same file.</p><h3 id=testing-bypass-authentication>Testing Bypass Authentication</h3><p>First, let&rsquo;s look at some tests for the <code>/auth/bypass</code> route, since that is the simplest. The first test is a very simple one to confirm that bypass authentication works, and also that it sets the expected cookie in the browser when it redirects the user back to the home page:</p><div class=tab-panel data-tab-group=ee2771529808bd0fc4bbb8dc234f0df9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ee2771529808bd0fc4bbb8dc234f0df9","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Regular expression to match the expected cookie
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>regex_valid</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;^&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>SESSION_NAME</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;=\\S*; Path=/; HttpOnly$&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test Bypass authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bypassAuth</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should allow bypass login with user &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// List of existing users to be tested
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>users</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;admin&#34;</span>, <span style=color:#e6db74>&#34;contributor&#34;</span>, <span style=color:#e6db74>&#34;manager&#34;</span>, <span style=color:#e6db74>&#34;user&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /bypass&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bypassAuth</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>Notice that we are using a <a href=https://en.wikipedia.org/wiki/Regular_expression rel=external target=_blank>regular expression</a> to help us verify that the cookie being sent to the user is using the correct name and has the expected content.</p><p>Next, we also should test to make sure that using bypass authentication with any unknown username will create that user:</p><div class=tab-panel data-tab-group=602bcaf1c3e2cad65e2b904846b675ef><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("602bcaf1c3e2cad65e2b904846b675ef","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test Bypass authentication creates user
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bypassAuthCreatesUser</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should allow bypass login with new user &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findOne</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;username&#34;</span>],
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span> },
</span></span><span style=display:flex><span>        }).<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>found_user</span>) =&gt; {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>found_user</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>not</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>found_user</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;username&#34;</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>found_user</span>.<span style=color:#a6e22e>username</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /bypass&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bypassAuth</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bypassAuthCreatesUser</span>(<span style=color:#e6db74>&#34;testuser&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>This test will first log the user in, then it will directly check the database to ensure that the user has been created successfully. Alternatively, we could also use the API, but we&rsquo;re trying to keep our tests independent, so in this case it makes the most sense to query the database directly in our test instead of any other method.</p><h3 id=testing-cas-authentication>Testing CAS Authentication</h3><p>Next, let&rsquo;s write the tests for our CAS authentication strategy. These are similar to the ones we&rsquo;ve already written, but they have some key differences as well.</p><p>First, we can write a simple test just to show that any user who visits the <code>/auth/cas</code> route will be properly redirected to the correct CAS server:</p><div class=tab-panel data-tab-group=af71e13ce73f8f2350561bf85f6c7779><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("af71e13ce73f8f2350561bf85f6c7779","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test CAS authentication redirect
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>casAuthRedirect</span> <span style=color:#f92672>=</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should redirect users to CAS server&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expectedURL</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CAS_URL</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/login?service=&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      encodeURIComponent(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CAS_SERVICE_URL</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/auth/cas&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/cas&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#a6e22e>expectedURL</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /cas&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>casAuthRedirect</span>();
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>In this test, we are building the URL that the user should be redirected to, based on the settings we have already set in our environment file. Then, we simply check that the returned response is an HTTP 302 Found response with the correct location indicated.</p><p>The next two tests are much more complex, because they require us to mock the step where our server confirms that the user is authenticated with the CAS server by sending a request with a ticket attached, and then getting a response for that ticket. We can do this using a bit of clever coding and the <a href=https://sinonjs.org/ rel=external target=_blank>Sinon</a> library.</p><p>First, we need to mock up a response object that mimics what the server would respond with. This is mocked just so it will be understood by our CAS authentication library and may not work in all cases:</p><div class=tab-panel data-tab-group=7ea3a3ce23c070de320772cf8d3e1265><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7ea3a3ce23c070de320772cf8d3e1265","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Helper function to generate a valid mock CAS 2.0 Ticket
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>validTicket</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>ticket</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>`&lt;cas:serviceResponse xmlns:cas=&#39;http://www.yale.edu/tp/cas&#39;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &lt;cas:authenticationSuccess&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &lt;cas:user&gt;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>user</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/cas:user&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &lt;cas:ksuPersonWildcatID&gt;</span><span style=color:#e6db74>${</span><span style=color:#ae81ff>123456789</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/cas:ksuPersonWildcatID&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &lt;cas:proxyGrantingTicket&gt;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>ticket</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/cas:proxyGrantingTicket&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &lt;/cas:authenticationSuccess&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;/cas:serviceResponse&gt;`</span>;
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>This function creates an object with a single method <code>text()</code> that will return a valid XML ticket for the given user and random ticket ID.</p><p>Right below that, we can create a unit test that will mock the global <code>fetch</code> function used by our CAS authentication strategy to contact the CAS server to validate the ticket, and instead it will respond with our mock response object created above:</p><div class=tab-panel data-tab-group=b7d03e4094a86a115a950e2d4f0c85cf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b7d03e4094a86a115a950e2d4f0c85cf","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test CAS with valid ticket
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>casAuthValidTicket</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should log in user &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; via CAS&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ticket</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;abc123&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fetchStub</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sinon</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>stub</span>(<span style=color:#a6e22e>global</span>, <span style=color:#e6db74>&#34;fetch&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>resolves</span>(<span style=color:#a6e22e>validTicket</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>ticket</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/cas?ticket=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>ticket</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sinon</span>.<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>calledOnce</span>(<span style=color:#a6e22e>fetchStub</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>fetchStub</span>.<span style=color:#a6e22e>args</span>[<span style=color:#ae81ff>0</span>][<span style=color:#ae81ff>0</span>]).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>contain</span>(<span style=color:#e6db74>&#34;?ticket=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>ticket</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /cas&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>casAuthRedirect</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>casAuthValidTicket</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>In this test, we create a <code>fetchStub</code> object that is used by our CAS authentication strategy in place of <code>fetch</code>. It will confirm that the user has a valid ticket and can be authenticated, so we can perform the same steps as before and ensure that the cookie is properly set when the user is authenticated.</p><p>We also are checking that the <code>fetch</code> method we mocked was actually called once, and that it contained the ticket we provided as part of the URL. This is just a sanity check to make sure that we mocked up the correct part of our application!</p><p>We must also add a new item in the <code>afterEach()</code> hook for Mocha, which will reset all functions and objects that are mocked by Sinon after each test. This ensures we are always working with a clean slate. We&rsquo;ll update the function in <code>test/hooks.js</code> with this new content:</p><div class=tab-panel data-tab-group=5a3d243917298b46cb0059b027cd02c3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhooksjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5a3d243917298b46cb0059b027cd02c3","testhooksjs")'>
<span class=tab-nav-text>test/hooks.js</span></button></div><div class=tab-content-container><div data-tab-item=testhooksjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e>// Import libraries
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>sinon</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;sinon&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Root Hook Runs Before Each Test
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mochaHooks</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Hook runs after each individual test
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>afterEach</span>(<span style=color:#a6e22e>done</span>) {
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#75715e>// Restore Sinon mocks
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>    <span style=color:#a6e22e>sinon</span>.<span style=color:#a6e22e>restore</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Remove all data from the database
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>seeds</span>.<span style=color:#a6e22e>down</span>({ <span style=color:#a6e22e>to</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span> }).<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>};</span></span></code></pre></div></div></div></div></div><p>Finally, we also should confirm that logging in via CAS will create a new user if the username is not recognized. This test builds upon the previous CAS test in a way similar to the one used for bypass authentication above:</p><div class=tab-panel data-tab-group=0ecec8ffac6eb913b2f665c6fa078128><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0ecec8ffac6eb913b2f665c6fa078128","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test CAS creates user
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>casAuthValidTicketCreatesUser</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should create new user &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; via CAS&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ticket</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;abc123&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fetchStub</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sinon</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>stub</span>(<span style=color:#a6e22e>global</span>, <span style=color:#e6db74>&#34;fetch&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>resolves</span>(<span style=color:#a6e22e>validTicket</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>ticket</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/cas?ticket=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>ticket</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sinon</span>.<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>calledOnce</span>(<span style=color:#a6e22e>fetchStub</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>fetchStub</span>.<span style=color:#a6e22e>args</span>[<span style=color:#ae81ff>0</span>][<span style=color:#ae81ff>0</span>]).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>contain</span>(<span style=color:#e6db74>&#34;?ticket=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>ticket</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findOne</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;username&#34;</span>],
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span> },
</span></span><span style=display:flex><span>        }).<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>found_user</span>) =&gt; {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>found_user</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>not</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>found_user</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;username&#34;</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>found_user</span>.<span style=color:#a6e22e>username</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /cas&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>casAuthRedirect</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>casAuthValidTicket</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>casAuthValidTicketCreatesUser</span>(<span style=color:#e6db74>&#34;testuser&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>As before, this will log a user in via CAS, confirm that it works, and then check in the database to make sure that the new user is properly created.</p><h3 id=testing-jwt>Testing JWT</h3><p>Now that we&rsquo;ve tested both ways to log into our application, we can write some tests to confirm that users can properly request a JWT to be used in our frontend later on. So, our first test simply checks to make sure a user with a valid session can request a token:</p><div class=tab-panel data-tab-group=1d43a831714b5c0e9f01c82fa9a201d4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1d43a831714b5c0e9f01c82fa9a201d4","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test user can request a valid token
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCanRequestToken</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should allow user &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; to request valid JWT&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>agent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>agent</span>(<span style=color:#a6e22e>app</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/token&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;object&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;token&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jsonwebtoken</span>.<span style=color:#a6e22e>decode</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;username&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>username</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /token&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userCanRequestToken</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCanRequestToken</span>(<span style=color:#e6db74>&#34;testuser&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>In this test, we must use a persistent browser agent to make our requests. This will ensure that any cookies or other settings are saved between requests. Thankfully, the <a href=https://www.npmjs.com/package/supertest rel=external target=_blank>Supertest</a> library we are using already has that functionality, so all we have to do is create an <code>agent</code> for our testing as shown in the test above. Once we have successfully logged in, we can confirm that the <code>/auth/token</code> endpoint sends a valid JWT that contains information about the current user. For these tests, we are using bypass authentication for simplicity, but any authentication method could be used.</p><p>When we run the tests at the bottom of the file, notice that we are running this for all existing users, as well as a newly created user. Both types of users should be able to request a token for our application.</p><p>Next, let&rsquo;s confirm that all of a user&rsquo;s roles are listed in the JWT issued for that user. This is important because, later on in this example, we&rsquo;ll be using those roles to implement role-based authorization in our application, so it is vital to make sure our JWTs include the correct roles:</p><div class=tab-panel data-tab-group=1a5b372ced488ae4981425719ee3467b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1a5b372ced488ae4981425719ee3467b","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test user roles are correctly listed in token
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userRolesAreCorrectInToken</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should contain correct roles for user &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; in JWT&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>agent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>agent</span>(<span style=color:#a6e22e>app</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/token&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;object&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;token&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jsonwebtoken</span>.<span style=color:#a6e22e>decode</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findOne</span>({
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;username&#34;</span>],
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>include</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>model</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Role</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>as</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;roles&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;role&#34;</span>],
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>through</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                  <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [],
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>              },
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span> },
</span></span><span style=display:flex><span>            }).<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;roles&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>expected_role</span>) =&gt; {
</span></span><span style=display:flex><span>                  <span style=color:#a6e22e>expect</span>(
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>some</span>((<span style=color:#a6e22e>role</span>) =&gt; <span style=color:#a6e22e>role</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>expected_role</span>.<span style=color:#a6e22e>id</span>),
</span></span><span style=display:flex><span>                  ).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>                });
</span></span><span style=display:flex><span>              } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>not</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;roles&#34;</span>);
</span></span><span style=display:flex><span>              }
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /token&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userCanRequestToken</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userRolesAreCorrectInToken</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCanRequestToken</span>(<span style=color:#e6db74>&#34;testuser&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userRolesAreCorrectInToken</span>(<span style=color:#e6db74>&#34;testuser&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>This test may seem very long and verbose, but it is very straightforward. We first login and request a token for a user, and then we also look up that user in the database including all associated roles. Then, we simply assert that the number of roles in the token is the same as the number of them in the database, and if there are any roles that each role is found as expected.</p><p>Finally, we should write one additional test, that simply confirms that the application will not allow anyone to request a token if they are not currently logged in:</p><div class=tab-panel data-tab-group=ae05f9d70729080658213df3ad7e3610><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ae05f9d70729080658213df3ad7e3610","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * User must have a valid session to request a token
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mustBeLoggedInToRequestToken</span> <span style=color:#f92672>=</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should not allow a user to request a token without logging in&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/token&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>401</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /token&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userCanRequestToken</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userRolesAreCorrectInToken</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCanRequestToken</span>(<span style=color:#e6db74>&#34;testuser&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userRolesAreCorrectInToken</span>(<span style=color:#e6db74>&#34;testuser&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mustBeLoggedInToRequestToken</span>();
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>For this test, we simply check that the application returns an HTTP 401 response if the user tries to request a token without first being logged in.</p><h3 id=testing-logout>Testing Logout</h3><p>Finally, we can write a few tests to make sure our logout process is also working as expected. The first test will confirm that the session cookie we are using is properly removed from the user&rsquo;s browser when they log out:</p><div class=tab-panel data-tab-group=e0d9f543139af646d723b6c7ee4010a2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e0d9f543139af646d723b6c7ee4010a2","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Regular expression to match deleting the cookie
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>regex_destroy</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;^&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>SESSION_NAME</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT$&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Logout will remove the cookie
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>logoutDestroysCookie</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should remove the cookie on logout&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re_destroy</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_destroy</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>agent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>agent</span>(<span style=color:#a6e22e>app</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/logout&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re_destroy</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /logout&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logoutDestroysCookie</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>In this test, we are looking for a second <code>set-cookie</code> header to be sent when the user logs out. This header will both contain an empty cookie, but also will set the cookie&rsquo;s expiration date to the earliest date possible. So, we can simply look for that header to confirm our cookie is being properly removed and expired from the user&rsquo;s browser when they log out. We only really have to test this for a single username, since the process is identical for all of them.</p><p>Next, we should also confirm that the logout process will redirect users to the CAS server as well and log them out of any existing CAS sessions.</p><div class=tab-panel data-tab-group=50b44b91eb25e9721243d36eb513635d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("50b44b91eb25e9721243d36eb513635d","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Regular expression for redirecting to CAS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>regex_redirect</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;^&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CAS_URL</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/logout\\?service=\\S*$&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Logout redirects to CAS
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>logoutRedirectsToCas</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should redirect to CAS on logout&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re_redirect</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_redirect</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>agent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>agent</span>(<span style=color:#a6e22e>app</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/logout&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#a6e22e>re_redirect</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /logout&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logoutDestroysCookie</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logoutRedirectsToCas</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>Once again, we are simply checking the <code>Location</code> header of the HTTP 302 Found response received from our application. We are making use of regular expressions to ensure we are being properly redirected to the correct CAS server and the <code>logout</code> route on that server.</p><p>Finally, we should confirm that once a user has logged out, they are no longer able to request a new token from the application:</p><div class=tab-panel data-tab-group=6b85461e96860b9af351471b633a1507><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6b85461e96860b9af351471b633a1507","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Logout prevents requesting a token
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>logoutPreventsToken</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should prevent access to token after logging out&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>agent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>agent</span>(<span style=color:#a6e22e>app</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/token&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>              .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/logout&#34;</span>)
</span></span><span style=display:flex><span>              .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>              .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>                  .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/token&#34;</span>)
</span></span><span style=display:flex><span>                  .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>401</span>)
</span></span><span style=display:flex><span>                  .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>                  });
</span></span><span style=display:flex><span>              });
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /logout&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logoutDestroysCookie</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logoutRedirectsToCas</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logoutPreventsToken</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>In this test, we simply log in, request a token, then log out, and show that the application will no longer allow us to request a token, even though we are using the same user agent as before. This is a great way to confirm that our entire process is working!</p><p>Now is a great time to lint, format, and commit our code to GitHub before continuing!</p><footer class=footline></footer></article></div></main></div><script src=/cis526/js/clipboard/clipboard.min.js?1768424848 defer></script><script src=/cis526/js/perfect-scrollbar/perfect-scrollbar.min.js?1768424848 defer></script><script src=/cis526/js/theme.min.js?1768424848 defer></script></div><script src=/cis526/js/tele-scroll.min.js?1768424848 defer></script></body></html>
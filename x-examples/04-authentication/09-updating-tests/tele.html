<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=html><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.148.1"><meta name=generator content="Relearn 8.0.0"><meta name=description content="YouTube Video Updating Unit Tests Of course, now that we’re requiring a valid JWT for all API routes, and adding role-based authorization for most routes, all of our existing API unit tests now longer work. So, let’s work on updating those tests to use our new authentication system.
First, let’s build a simple helper function we can use to easily log in as a user and request a token to use in our application. We’ll place this in a new file named test/helpers.js:"><meta name=author content="Nathan Bean & Russell Feldhausen"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta name=twitter:title content="Updating Tests :: CIS 526 Textbook"><meta name=twitter:description content="YouTube Video Updating Unit Tests Of course, now that we’re requiring a valid JWT for all API routes, and adding role-based authorization for most routes, all of our existing API unit tests now longer work. So, let’s work on updating those tests to use our new authentication system.
First, let’s build a simple helper function we can use to easily log in as a user and request a token to use in our application. We’ll place this in a new file named test/helpers.js:"><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/09-updating-tests/index.html"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Updating Tests :: CIS 526 Textbook"><meta property="og:description" content="YouTube Video Updating Unit Tests Of course, now that we’re requiring a valid JWT for all API routes, and adding role-based authorization for most routes, all of our existing API unit tests now longer work. So, let’s work on updating those tests to use our new authentication system.
First, let’s build a simple helper function we can use to easily log in as a user and request a token to use in our application. We’ll place this in a new file named test/helpers.js:"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="Example Projects"><meta property="article:modified_time" content="2025-04-05T18:31:19-05:00"><meta property="og:image" content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta itemprop=name content="Updating Tests :: CIS 526 Textbook"><meta itemprop=description content="YouTube Video Updating Unit Tests Of course, now that we’re requiring a valid JWT for all API routes, and adding role-based authorization for most routes, all of our existing API unit tests now longer work. So, let’s work on updating those tests to use our new authentication system.
First, let’s build a simple helper function we can use to easily log in as a user and request a token to use in our application. We’ll place this in a new file named test/helpers.js:"><meta itemprop=dateModified content="2025-04-05T18:31:19-05:00"><meta itemprop=wordCount content="777"><meta itemprop=image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><title>Updating Tests :: CIS 526 Textbook</title><link href=https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/09-updating-tests/index.html rel=canonical type=text/html title="Updating Tests :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/09-updating-tests/index.xml rel=alternate type=application/rss+xml title="Updating Tests :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/09-updating-tests/index.print.html rel=alternate type=text/html title="Updating Tests :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/09-updating-tests/embed.html rel=alternate type=text/html title="Updating Tests :: CIS 526 Textbook"><link href=/cis526/css/auto-complete/auto-complete.min.css?1755561291 rel=stylesheet><script src=/cis526/js/auto-complete/auto-complete.min.js?1755561291 defer></script><script src=/cis526/js/search-lunr.min.js?1755561291 defer></script><script src=/cis526/js/search.min.js?1755561291 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/cis526/searchindex.en.js?1755561291"</script><script src=/cis526/js/lunr/lunr.min.js?1755561291 defer></script><script src=/cis526/js/lunr/lunr.stemmer.support.min.js?1755561291 defer></script><script src=/cis526/js/lunr/lunr.multi.min.js?1755561291 defer></script><script src=/cis526/js/lunr/lunr.en.min.js?1755561291 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1755561291 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1755561291 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar/perfect-scrollbar.min.css?1755561291 rel=stylesheet><link href=/cis526/css/theme.min.css?1755561291 rel=stylesheet><link href=/cis526/css/format-html.min.css?1755561291 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/x-examples/04-authentication/09-updating-tests/index.html",window.relearn.relBasePath="../../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!1,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.relearn.themevariants=["light-theme"],window.relearn.customvariantname="my-custom-variant",window.relearn.writeVariant=!1,window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.writeVariant&&window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><link href=/cis526/css/custom.css?1755561291 rel=stylesheet></head><body class="mobile-support html" data-url=/cis526/x-examples/04-authentication/09-updating-tests/index.html><div id=tele class="tele mirror"><div id=R-body class=default-animation><div id=R-body-overlay></div><div id=R-main-overlay></div><main id=R-body-inner class="highlightable x-examples" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=updating-tests>Updating Tests</h1><a href="https://www.youtube.com/watch?v=k43QEMKxO9Y">YouTube Video</a><h2 id=updating-unit-tests>Updating Unit Tests</h2><p>Of course, now that we&rsquo;re requiring a valid JWT for all API routes, and adding role-based authorization for most routes, all of our existing API unit tests now longer work. So, let&rsquo;s work on updating those tests to use our new authentication system.</p><p>First, let&rsquo;s build a simple helper function we can use to easily log in as a user and request a token to use in our application. We&rsquo;ll place this in a new file named <code>test/helpers.js</code>:</p><div class=tab-panel data-tab-group=c48fcc7b5e8ee0c98f2f6bbc2a22a8d4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c48fcc7b5e8ee0c98f2f6bbc2a22a8d4","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file Unit Test Helpers
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>request</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;supertest&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>app</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../app.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>login</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>agent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>agent</span>(<span style=color:#a6e22e>app</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>agent</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>).<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/token&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>token</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};</span></span></code></pre></div></div></div></div></div><p>This file is pretty straightforward - it simply uses the bypass login system to authenticate as a user, then it requests a token and returns it. It assumes that all other parts of the authentication process work properly - we can do this because we already have unit tests to check that functionality.</p><p>Now, let&rsquo;s use this in our <code>test/api/v1/roles.js</code> file by adding a few new lines to each test. We&rsquo;ll start with the simple <code>getAllRoles</code> test:</p><div class=tab-panel data-tab-group=c8f602d9221a5a9901f9676c29f5e564><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c8f602d9221a5a9901f9676c29f5e564","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file /api/v1/roles Route Tests
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Load Libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>request</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;supertest&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>use</span>, <span style=color:#a6e22e>should</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Ajv</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;ajv&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>addFormats</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;ajv-formats&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>chaiJsonSchemaAjv</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai-json-schema-ajv&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>chaiShallowDeepEqual</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai-shallow-deep-equal&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Express application
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>app</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../../app.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e>// Import Helpers
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>login</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../helpers.js&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Configure Chai and AJV
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ajv</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Ajv</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>addFormats</span>(<span style=color:#a6e22e>ajv</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>chaiJsonSchemaAjv</span>.<span style=color:#a6e22e>create</span>({ <span style=color:#a6e22e>ajv</span>, <span style=color:#a6e22e>verbose</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> }));
</span></span><span style=display:flex><span><span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>chaiShallowDeepEqual</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Modify Object.prototype for BDD style assertions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>should</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Get all Roles
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getAllRoles</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>state</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should list all roles&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/roles&#34;</span>)
</span></span><span style=display:flex;background-color:#3c3d38><span>      .<span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;Authorization&#39;</span>, <span style=color:#e6db74>`Bearer </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;array&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>lengthOf</span>(<span style=color:#ae81ff>7</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/roles route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/roles&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /&#34;</span>, () =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>beforeEach</span>(<span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>login</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>getAllRoles</span>(<span style=color:#a6e22e>state</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>To update this test, we have created a new <code>state</code> object that is present in our <code>describe</code> block at the bottom of the test. That <code>state</code> object can store various things we&rsquo;ll use in our tests, but for now we&rsquo;ll just use it to store a valid JWT for our application. Then, in a <code>beforeEach</code> <a href=https://mochajs.org/#hooks rel=external target=_blank>Mocha hook</a>, we use the <code>login</code> helper we created earlier to log in as the &ldquo;admin&rdquo; user and store a valid JWT for that user in the <code>state.token</code> property.</p><p>Then, we pass that <code>state</code> object to the <code>getAllRoles</code> test. Inside of that test, we use the <code>state.token</code> property to set an <code>Authorization: Bearer</code> header for our request to the API. If everything works correctly, this test should now pass.</p><p>We can make similar updates to the other tests in this file:</p><div class=tab-panel data-tab-group=692f26c961d2999d4b68913b68b66aba><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("692f26c961d2999d4b68913b68b66aba","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Check JSON Schema of Roles
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getRolesSchemaMatch</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>state</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;all roles should match schema&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>schema</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;array&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>items</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;object&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;role&#34;</span>],
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>properties</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;number&#34;</span> },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;string&#34;</span> },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>createdAt</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;string&#34;</span>, <span style=color:#a6e22e>format</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;iso-date-time&#34;</span> },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>updatedAt</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;string&#34;</span>, <span style=color:#a6e22e>format</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;iso-date-time&#34;</span> },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>additionalProperties</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/roles&#34;</span>)
</span></span><span style=display:flex;background-color:#3c3d38><span>      .<span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;Authorization&#39;</span>, <span style=color:#e6db74>`Bearer </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>jsonSchema</span>(<span style=color:#a6e22e>schema</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Check Role exists in list
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>findRole</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>role</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should contain &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>role</span>.<span style=color:#a6e22e>role</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; role&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/roles&#34;</span>)
</span></span><span style=display:flex;background-color:#3c3d38><span>      .<span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;Authorization&#39;</span>, <span style=color:#e6db74>`Bearer </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>foundRole</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>find</span>((<span style=color:#a6e22e>r</span>) =&gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>role</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>foundRole</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>shallowDeepEqual</span>(<span style=color:#a6e22e>role</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/roles route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/roles&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>beforeEach</span>(<span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>login</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>getAllRoles</span>(<span style=color:#a6e22e>state</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>getRolesSchemaMatch</span>(<span style=color:#a6e22e>state</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>findRole</span>(<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>r</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>This will ensure that each RESTful API action will work properly with an authenticated user, but it doesn&rsquo;t test whether the user has the proper role to perform the action (in this instance, we are using the <code>admin</code> user which has the appropriate role already). On the next page, we&rsquo;ll build a very flexible system to perform unit testing on our role-based authorization middleware.</p><footer class=footline></footer></article></div></main></div><script src=/cis526/js/clipboard/clipboard.min.js?1755561291 defer></script><script src=/cis526/js/perfect-scrollbar/perfect-scrollbar.min.js?1755561291 defer></script><script src=/cis526/js/theme.min.js?1755561291 defer></script></div><script src=/cis526/js/tele-scroll.min.js?1755561291 defer></script></body></html>
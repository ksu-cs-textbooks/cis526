<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="YouTube Video Users API Roles We should also add our role-based authorization middleware to our /api/v1/users routes. This can actually be done really simply, because we only want users with the manage_users role to be able to access any of these routes.
So, instead of attaching the middleware to each handler individually, we can attach it directly to the router before any handlers:
​ routes/api/v1/users.js /** * @file Users router * @author Russell Feldhausen <russfeld@ksu."><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Users API Updates :: CIS 526 Textbook"><meta name=twitter:description content="YouTube Video Users API Roles We should also add our role-based authorization middleware to our /api/v1/users routes. This can actually be done really simply, because we only want users with the manage_users role to be able to access any of these routes.
So, instead of attaching the middleware to each handler individually, we can attach it directly to the router before any handlers:
​ routes/api/v1/users.js /** * @file Users router * @author Russell Feldhausen <russfeld@ksu."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/11-user-updates/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Users API Updates :: CIS 526 Textbook"><meta property="og:description" content="YouTube Video Users API Roles We should also add our role-based authorization middleware to our /api/v1/users routes. This can actually be done really simply, because we only want users with the manage_users role to be able to access any of these routes.
So, instead of attaching the middleware to each handler individually, we can attach it directly to the router before any handlers:
​ routes/api/v1/users.js /** * @file Users router * @author Russell Feldhausen <russfeld@ksu."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="Example Projects"><meta property="article:modified_time" content="2025-03-26T22:39:37-05:00"><meta itemprop=name content="Users API Updates :: CIS 526 Textbook"><meta itemprop=description content="YouTube Video Users API Roles We should also add our role-based authorization middleware to our /api/v1/users routes. This can actually be done really simply, because we only want users with the manage_users role to be able to access any of these routes.
So, instead of attaching the middleware to each handler individually, we can attach it directly to the router before any handlers:
​ routes/api/v1/users.js /** * @file Users router * @author Russell Feldhausen <russfeld@ksu."><meta itemprop=dateModified content="2025-03-26T22:39:37-05:00"><meta itemprop=wordCount content="917"><title>Users API Updates :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/11-user-updates/ rel=canonical type=text/html title="Users API Updates :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/11-user-updates/index.xml rel=alternate type=application/rss+xml title="Users API Updates :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/11-user-updates/tele.html rel=alternate type=text/html title="Users API Updates :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/11-user-updates/embed.html rel=alternate type=text/html title="Users API Updates :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1743522173 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1743522173 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1743522173 rel=stylesheet><link href=/cis526/css/auto-complete.css?1743522173 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1743522173 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1743522173 rel=stylesheet><link href=/cis526/css/fonts.css?1743522173 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1743522173 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1743522173 rel=stylesheet><link href=/cis526/css/theme-auto.css?1743522173 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1743522173 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1743522173 rel=stylesheet><link href=/cis526/css/print.css?1743522173 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1743522173 rel=stylesheet><script src=/cis526/js/variant.js?1743522173></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1743522173 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/x-examples/04-authentication/11-user-updates/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/cis526/x-examples/><span itemprop=name>Example Projects</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/cis526/x-examples/04-authentication/><span itemprop=name>Authentication</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Users API Updates</span><meta itemprop=position content="3"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/04-authentication/10-testing-roles/ title="Testing Roles (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/05-vue-starter/ title="Vue.js Starter Project (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=users-api-updates>Users API Updates</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=users-api-roles>Users API Roles</h2><p>We should also add our role-based authorization middleware to our <code>/api/v1/users</code> routes. This can actually be done really simply, because we only want users with the <code>manage_users</code> role to be able to access any of these routes.</p><p>So, instead of attaching the middleware to each handler individually, we can attach it directly to the router before any handlers:</p><div class=tab-panel data-tab-group=3eea9f221f1c51ec0eb02b04d001b37a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3eea9f221f1c51ec0eb02b04d001b37a","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: users
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Users Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ValidationError</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;sequelize&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import middlewares
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>roleBasedAuth</span> <span class=nx>from</span> <span class=s2>&#34;../../../middlewares/authorized-roles.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import utilities
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>handleValidationError</span> <span class=nx>from</span> <span class=s2>&#34;../../../utilities/handle-validation-error.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>sendSuccess</span> <span class=nx>from</span> <span class=s2>&#34;../../../utilities/send-success.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Add Role Authorization to all routes
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>roleBasedAuth</span><span class=p>(</span><span class=s2>&#34;manage_users&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>That&rsquo;s all it takes to add role-based authorization to an entire router! It is really simple.</p><p>We also should remember to add the new <code>security</code> section to our Open API documentation comments for each route to ensure that our documentation properly displays that each route requires authentication.</p><h2 id=users-api-unit-tests---authentication>Users API Unit Tests - Authentication</h2><p>As part of our updates, we need to add authentication to each of our unit tests for the <code>/api/v1/users</code> routes. This is relatively straightforward based on what we did in the previous page - it just requires a few tweaks per test.</p><p>In short, we need to add a <code>state</code> variable that we can use that contains a token for a user, and then pass that along to each test. We can do this in the global <code>describe</code> section at the bottom:</p><div class=tab-panel data-tab-group=a45997c230ce7abe3fe1c24335462d67><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a45997c230ce7abe3fe1c24335462d67","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api/v1/users Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span><span class=p>,</span> <span class=nx>expect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Ajv</span> <span class=nx>from</span> <span class=s2>&#34;ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>addFormats</span> <span class=nx>from</span> <span class=s2>&#34;ajv-formats&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../../../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import Helpers
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>login</span><span class=p>,</span> <span class=nx>testRoleBasedAuth</span><span class=p>,</span> <span class=nx>all_roles</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../helpers.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=kd>let</span> <span class=nx>state</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>  <span class=nx>beforeEach</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>state</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>login</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Notice that we are able to add that code outside of the <code>describe</code> sections for each API endpoint, greatly simplifying things. Of course, if we need to log in as multiple users, we can either add additional tokens to the <code>state</code> or move the <code>state</code> and <code>beforeEach</code> methods to other locations in the code.</p><p>Once we have our state, we can simply pass it on to the tests and update each test to use it correctly by setting an <code>Authorization: Bearer</code> header on each request:</p><div class=tab-panel data-tab-group=abd6631bf15872ff51e8fd6fc936db0b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("abd6631bf15872ff51e8fd6fc936db0b","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all Users
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>getAllUsers</span> <span class=o>=</span> <span class=p>(</span><span class=nx>state</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should list all users&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s2>&#34;Authorization&#34;</span><span class=p>,</span> <span class=sb>`Bearer </span><span class=si>${</span><span class=nx>state</span><span class=p>.</span><span class=nx>token</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>state</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>beforeEach</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>state</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>login</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>getAllUsers</span><span class=p>(</span><span class=nx>state</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>We won&rsquo;t exhaustively show each update to these tests here since there are so many. Take the time now to update all of the <code>/api/v1/users</code> unit tests to include authentication before continuing. They should all pass once authentication is enabled.</p><h2 id=users-api-unit-tests---role-based-authorization>Users API Unit Tests - Role-Based Authorization</h2><p>Finally, we should add additional unit tests to ensure that each endpoint in the <code>/api/v1/users</code> router is accessible only by users with the correct role. For that, we can simply add a block of code similar to what we did in the <code>roles</code> routes for each endpoint:</p><div class=tab-panel data-tab-group=1638a82f7aefe99045a149e29783c1f6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1638a82f7aefe99045a149e29783c1f6","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>state</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>beforeEach</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>state</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>login</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=s2>&#34;get&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/1&#34;</span><span class=p>,</span> <span class=s2>&#34;get&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;POST /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=s2>&#34;post&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;PUT /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/1&#34;</span><span class=p>,</span> <span class=s2>&#34;put&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;DELETE /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/1&#34;</span><span class=p>,</span> <span class=s2>&#34;delete&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>All told, there should now be 88 total unit test in that file alone - that is a lot of tests for just 5 API endpoints!</p><p>Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub.</p><p>That concludes the first set of tutorials for building a RESTful API. In the next set of tutorials, we&rsquo;ll focus on building a Vue.js frontend for our application.</p><footer class=footline></footer></article></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/ef6481ee2e12e7d59e09d5caf4cbbb8e06037459>Mar 26, 2025</a></p></div></div><script src=/cis526/js/clipboard.min.js?1743522173 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1743522173 defer></script><script src=/cis526/js/theme.js?1743522173 defer></script></body></html>
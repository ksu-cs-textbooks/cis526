<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="YouTube Video Token Middlewares Now that we finally have a working authentication system, we can start to add role-based authorization to our application. This will ensure that only users with specific roles can perform certain actions within our RESTful API. To do this, we’ll need to create a couple of new Express middlewares to help load the contents of our JWT into the request, and also to verify that the authenticated user has the appropriate roles to perform an action."><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Role-Based Authorization :: CIS 526 Textbook"><meta name=twitter:description content="YouTube Video Token Middlewares Now that we finally have a working authentication system, we can start to add role-based authorization to our application. This will ensure that only users with specific roles can perform certain actions within our RESTful API. To do this, we’ll need to create a couple of new Express middlewares to help load the contents of our JWT into the request, and also to verify that the authenticated user has the appropriate roles to perform an action."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/08-role-based/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Role-Based Authorization :: CIS 526 Textbook"><meta property="og:description" content="YouTube Video Token Middlewares Now that we finally have a working authentication system, we can start to add role-based authorization to our application. This will ensure that only users with specific roles can perform certain actions within our RESTful API. To do this, we’ll need to create a couple of new Express middlewares to help load the contents of our JWT into the request, and also to verify that the authenticated user has the appropriate roles to perform an action."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="Example Projects"><meta property="article:modified_time" content="2025-04-05T18:31:19-05:00"><meta itemprop=name content="Role-Based Authorization :: CIS 526 Textbook"><meta itemprop=description content="YouTube Video Token Middlewares Now that we finally have a working authentication system, we can start to add role-based authorization to our application. This will ensure that only users with specific roles can perform certain actions within our RESTful API. To do this, we’ll need to create a couple of new Express middlewares to help load the contents of our JWT into the request, and also to verify that the authenticated user has the appropriate roles to perform an action."><meta itemprop=dateModified content="2025-04-05T18:31:19-05:00"><meta itemprop=wordCount content="1820"><title>Role-Based Authorization :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/08-role-based/ rel=canonical type=text/html title="Role-Based Authorization :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/08-role-based/index.xml rel=alternate type=application/rss+xml title="Role-Based Authorization :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/08-role-based/tele.html rel=alternate type=text/html title="Role-Based Authorization :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/08-role-based/embed.html rel=alternate type=text/html title="Role-Based Authorization :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1746823117 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1746823117 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1746823117 rel=stylesheet><link href=/cis526/css/auto-complete.css?1746823117 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1746823117 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1746823117 rel=stylesheet><link href=/cis526/css/fonts.css?1746823117 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1746823117 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1746823117 rel=stylesheet><link href=/cis526/css/theme-auto.css?1746823117 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1746823117 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1746823117 rel=stylesheet><link href=/cis526/css/print.css?1746823117 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1746823117 rel=stylesheet><script src=/cis526/js/variant.js?1746823117></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1746823117 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/x-examples/04-authentication/08-role-based/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/cis526/x-examples/><span itemprop=name>Example Projects</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/cis526/x-examples/04-authentication/><span itemprop=name>Authentication</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Role-Based Authorization</span><meta itemprop=position content="3"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/04-authentication/07-testing-auth/ title="Testing Authentication (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/04-authentication/09-updating-tests/ title="Updating Tests (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=role-based-authorization>Role-Based Authorization</h1><a href="https://www.youtube.com/watch?v=KMiBMPzHRp8">YouTube Video</a><h2 id=token-middlewares>Token Middlewares</h2><p>Now that we finally have a working authentication system, we can start to add role-based authorization to our application. This will ensure that only users with specific roles can perform certain actions within our RESTful API. To do this, we&rsquo;ll need to create a couple of new Express middlewares to help load the contents of our JWT into the request, and also to verify that the authenticated user has the appropriate roles to perform an action.</p><p>First, let&rsquo;s create a middleware to handle loading our JWT from an authorization header into the Express request object:</p><div class=tab-panel data-tab-group=a1582eff0b53d3c3cf56e9b5a48cae8e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=middlewarestokenjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a1582eff0b53d3c3cf56e9b5a48cae8e","middlewarestokenjs")'>
<span class=tab-nav-text>middlewares/token.js</span></button></div><div class=tab-content-container><div data-tab-item=middlewarestokenjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Middleware for reading JWTs from the Bearer header and storing them in the request
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports tokenMiddleware the token middleware
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>jsonwebtoken</span> <span class=nx>from</span> <span class=s1>&#39;jsonwebtoken&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;../configs/logger.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>tokenMiddleware</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Retrieve the token from the headers
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>authHeader</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s1>&#39;authorization&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>authHeader</span> <span class=o>&amp;&amp;</span> <span class=nx>authHeader</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// If the token is null in the header, send 401 unauthorized
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>token</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s1>&#39;JWT in header is null&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Verify the token
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>JWT_SECRET_KEY</span><span class=p>,</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>token</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Handle common errors
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=s1>&#39;TokenExpiredError&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If the token is expired, send 401 unauthorized 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If the token won&#39;t parse, send 403 forbidden
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&#34;JWT Parsing Error!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>sendStatus</span><span class=p>(</span><span class=mi>403</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Attach token to request
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>req</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=nx>token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Call next middleware
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>tokenMiddleware</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This middleware will extract our JWT from the <code>authorization: Bearer</code> header that should be present in any request from our frontend single-page web application to our API. It then checks that the signature matches the expected signature and that the payload of the JWT has not been tampered with. It also makes sure the JWT has not expired. If all of those checks pass, then it simply attaches the contents of the JWT to the Express request object as <code>req.token</code>, so we can use it later in our application.</p><p>To use this middleware, we need to make a small change to the structure of our <code>routes/api.js</code> file to allow users to access the base API route without needing the token, but all other routes will require a valid token for access:</p><div class=tab-panel data-tab-group=5b865038ca1ab6e832d898861122dd04><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5b865038ca1ab6e832d898861122dd04","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file API main router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: api
</span></span></span><span class=line><span class=cl><span class=cm> *   description: API routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import middleware
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>tokenMiddleware</span> <span class=nx>from</span> <span class=s2>&#34;../middlewares/token.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import v1 routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>rolesRouter</span> <span class=nx>from</span> <span class=s2>&#34;./api/v1/roles.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s2>&#34;./api/v1/users.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of API versions
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: list API versions
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [api]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of users
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: object
</span></span></span><span class=line><span class=cl><span class=cm> *                 properties:
</span></span></span><span class=line><span class=cl><span class=cm> *                   version:
</span></span></span><span class=line><span class=cl><span class=cm> *                     type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                   url:
</span></span></span><span class=line><span class=cl><span class=cm> *                     type: string
</span></span></span><span class=line><span class=cl><span class=cm> *             example:
</span></span></span><span class=line><span class=cl><span class=cm> *               - version: &#34;1.0&#34;
</span></span></span><span class=line><span class=cl><span class=cm> *                 url: /api/v1/
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v1/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Use Token Middleware
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>tokenMiddleware</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use v1 routers after API route
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/v1/roles&#34;</span><span class=p>,</span> <span class=nx>rolesRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/v1/users&#34;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Here, we import our new middleware, and then we rearrange the contents of the file so that the single <code>/api</code> route comes first, then we add our middleware and the rest of the API routes at the end of the file. Remember that everything in Express is executed in the order it is attached to the application, so in this way any routes that occur before our middleware is attached can be accessed without a valid JWT, but any routes or routers added afterward will require a valid JWT for access.</p><h2 id=role-middleware>Role Middleware</h2><p>Next, we can create another middleware function that will check if a user has the appropriate roles to perform an operation via our API. However, instead of writing a simple function as our middleware, or even writing a number of different functions for each possible role, we can take advantage of one of the most powerful features of JavaScript - we can create a function that <em>returns</em> another function! Let&rsquo;s take a look and see how it works:</p><div class=tab-panel data-tab-group=28dc35f10ee86a2825ec7fa1daa3c461><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=middlewaresauthorized-rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("28dc35f10ee86a2825ec7fa1daa3c461","middlewaresauthorized-rolesjs")'>
<span class=tab-nav-text>middlewares/authorized-roles.js</span></button></div><div class=tab-content-container><div data-tab-item=middlewaresauthorized-rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Middleware for role-based authorization
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports roleBasedAuth middleware
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Build a middleware function to validate a user has one of a list of roles
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param  {...any} roles a list of roles that are valid for this operation
</span></span></span><span class=line><span class=cl><span class=cm> * @returns a middleware function for those roles.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>roleBasedAuth</span> <span class=o>=</span> <span class=p>(...</span><span class=nx>roles</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kd>function</span> <span class=nx>roleAuthMiddleware</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Route requires roles: &#34;</span> <span class=o>+</span> <span class=nx>roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;User &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=nx>req</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34; has roles: &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=nx>req</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>role</span><span class=p>).</span><span class=nx>join</span><span class=p>(</span><span class=s2>&#34;,&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>match</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// loop through each role given
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// if the user has that role, then they can proceed
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>role</span> <span class=o>===</span> <span class=nx>role</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Role match!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>match</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>match</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// if no roles match, send an unauthenticated response
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;No role match!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>send</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>roleBasedAuth</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This file contains a function named <code>roleBasedAuth</code> that accepts a list of roles as parameters (they can be provided directly or as an array, but either way we can treat them like an array in our code). Then, we will <em>return</em> a new middleware function named <code>roleAuthMiddleware</code> that will check to see if the currently authenticated user (indicated by <code>req.token</code>) has at least one of the named roles. If so, then there is a match and the user should be able to perform the operation. If the user does not have any of the roles listed, then the user should not be able to perform the operation and a 401 Unauthorized response should be sent. This file also includes some helpful logging information to help ensure things are working properly.</p><h2 id=implementing-role-based-authorization>Implementing Role-Based Authorization</h2><p>Finally, let&rsquo;s look at how we can use that middleware function to implement role-based authorization in our application. Let&rsquo;s start simple - in this instance, we can update our <code>GET /api/v1/roles/</code> operation to require the user to have the <code>manage_users</code> role in order to list all possible roles in the application. To do this, we can import our new middleware function in the <code>routes/api/v1/roles.js</code> file, and then call that function to create a new middleware function to use in that file:</p><div class=tab-panel data-tab-group=ef3f5bb0af274dcfde0c348a2f33e1fb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ef3f5bb0af274dcfde0c348a2f33e1fb","routesapiv1rolesjs")'>
<span class=tab-nav-text>routes/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Roles router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: roles
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Roles Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import middlewares
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>roleBasedAuth</span> <span class=nx>from</span> <span class=s2>&#34;../../../middlewares/authorized-roles.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of roles
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/v1/roles:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: roles list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all roles in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [roles]
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     security:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *       - bearerAuth:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         - &#39;manage_users&#39;
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of roles
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 $ref: &#39;#/components/schemas/Role&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nx>roleBasedAuth</span><span class=p>(</span><span class=s2>&#34;manage_users&#34;</span><span class=p>),</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>Role</span><span class=p>.</span><span class=nx>findAll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Notice here that we are calling the <code>roleBasedAuth</code> function when we add it to our endpoint, which in turn will return a new middleware function that will be called anytime this endpoint is accessed. It is a bit complicated and confusing at first, but hopefully it makes sense.</p><p>We also have added a new <code>security</code> item to our Open API documentation, which allows us to test this route by providing a JWT through the Open API documentation website. We can even include the specific roles that are able to access this endpoint, but as of this writing it is only part of the Open API 3.1 spec but is not supported by the <code>swagger-ui</code> library so it won&rsquo;t appear on our documentation page.</p><p>Let&rsquo;s test it now by starting our server in development mode:</p><div class=tab-panel data-tab-group=2136a098bbb1cf88aec4b8abd358fe44><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2136a098bbb1cf88aec4b8abd358fe44","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once we have loaded our page, let&rsquo;s go ahead and log in as the <code>admin</code> user by navigating to <code>/auth/bypass?token=admin</code> - this will return us to our home page, but now we have an active session we can use.</p><p>Once we have done that, we can now go to the <code>/docs</code> route to view our documentation. We should now notice that there is a new <code>Authorize</code> button at the top of the page:</p><p><a href=#R-image-f610a1fc8be9029d751dacc3586274ea class=lightbox-link><img alt="OpenAPI Authorize" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_11.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f610a1fc8be9029d751dacc3586274ea><img alt="OpenAPI Authorize" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_11.png></a></p><p>In addition, if we scroll down to find our <code>/api/v1/roles</code> route, we should also see that it now has a lock icon next to it, showing that it requires authentication before we can access it:</p><p><a href=#R-image-4268aab7f7df8ed6af8a32720cdec3ee class=lightbox-link><img alt="OpenAPI Protected Route" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_12.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4268aab7f7df8ed6af8a32720cdec3ee><img alt="OpenAPI Protected Route" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_12.png></a></p><p>If we try to test that route now, even though we have a valid session cookie session, it should give us a 401 Unauthorized response because we aren&rsquo;t providing a valid JWT as part of our request:</p><p><a href=#R-image-5bbe89c9a55b99f68953fdbbeb7bc690 class=lightbox-link><img alt="Unauthorized Response" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_13.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5bbe89c9a55b99f68953fdbbeb7bc690><img alt="Unauthorized Response" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_13.png></a></p><p>To fix this, we need to authorize our application using a valid JWT. Thankfully, we can request one by finding the <code>/auth/token</code> route in our documentation and executing that route:</p><p><a href=#R-image-ae664f41e586b28844fc6d38c13fc495 class=lightbox-link><img alt="Requesting JWT" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_14.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ae664f41e586b28844fc6d38c13fc495><img alt="Requesting JWT" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_14.png></a></p><p>Once we have that, we can click the new Authorize button at the top, and paste the text of that token in the window that pops up. We just need the raw part of the JWT in quotes that is the value of the <code>token</code> property, without the quotes themselves included:</p><p><a href=#R-image-ae635ba957574996c5b8ed7e37408063 class=lightbox-link><img alt="Authorizing with JWT" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_15.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ae635ba957574996c5b8ed7e37408063><img alt="Authorizing with JWT" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_15.png></a></p><p>Finally, once that has been done, we can try the <code>/api/v1/roles</code> route again, and it should now let us access that route:</p><p><a href=#R-image-d033255f827d3a09b5c462bd2fc277d6 class=lightbox-link><img alt="Working Request" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_16.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d033255f827d3a09b5c462bd2fc277d6><img alt="Working Request" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_16.png></a></p><p>We can also see that it is properly using our role-based authorization by checking the debug output of our application:</p><div class=tab-panel data-tab-group=a15e367a2bb962ed05960544d714b4bd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a15e367a2bb962ed05960544d714b4bd","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[2025-03-21 12:54:14.085 AM] debug:     Route requires roles: manage_users
[2025-03-21 12:54:14.085 AM] debug:     User admin has roles: manage_users,manage_documents,manage_communities
[2025-03-21 12:54:14.086 AM] debug:     Role match!
[2025-03-21 12:54:14.087 AM] sql:       Executing (default): SELECT `id`, `role`, `createdAt`, `updatedAt` FROM `roles` AS `Role`;
[2025-03-21 12:54:14.090 AM] http:      GET /api/v1/roles 200 9.553 ms - 784</code></pre></div></div></div></div></div><p>There we go! That is all it takes to add role-based authorization to our application. Next, we&rsquo;ll look at how to update our unit tests to use our new authentication system and roles.</p><footer class=footline></footer></article></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/afd035a8f2cc9f8006f8fff543a247a17e0015fb>Apr 5, 2025</a></p></div></div><script src=/cis526/js/clipboard.min.js?1746823117 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1746823117 defer></script><script src=/cis526/js/theme.js?1746823117 defer></script></body></html>
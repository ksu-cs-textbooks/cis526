<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.
Project Deliverables At the end of this example, we will have a project with the following features:
An authentication system using Passport.js and CAS Valid JSON Web Tokens (JWTs) for authentication within the RESTful API Proper middleware to verify users have the correct role for each operation in the API Prior Work This project picks up right where the last one left off, so if you havenâ€™t completed that one yet, go back and do that before starting this one."><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Authentication :: CIS 526 Textbook"><meta name=twitter:description content="This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.
Project Deliverables At the end of this example, we will have a project with the following features:
An authentication system using Passport.js and CAS Valid JSON Web Tokens (JWTs) for authentication within the RESTful API Proper middleware to verify users have the correct role for each operation in the API Prior Work This project picks up right where the last one left off, so if you havenâ€™t completed that one yet, go back and do that before starting this one."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Authentication :: CIS 526 Textbook"><meta property="og:description" content="This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.
Project Deliverables At the end of this example, we will have a project with the following features:
An authentication system using Passport.js and CAS Valid JSON Web Tokens (JWTs) for authentication within the RESTful API Proper middleware to verify users have the correct role for each operation in the API Prior Work This project picks up right where the last one left off, so if you havenâ€™t completed that one yet, go back and do that before starting this one."><meta property="og:locale" content="en-us"><meta property="og:type" content="website"><meta itemprop=name content="Authentication :: CIS 526 Textbook"><meta itemprop=description content="This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.
Project Deliverables At the end of this example, we will have a project with the following features:
An authentication system using Passport.js and CAS Valid JSON Web Tokens (JWTs) for authentication within the RESTful API Proper middleware to verify users have the correct role for each operation in the API Prior Work This project picks up right where the last one left off, so if you havenâ€™t completed that one yet, go back and do that before starting this one."><meta itemprop=dateModified content="2025-03-04T21:42:32-06:00"><meta itemprop=wordCount content="122"><title>Authentication :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/ rel=canonical type=text/html title="Authentication :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/index.xml rel=alternate type=application/rss+xml title="Authentication :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/tele.html rel=alternate type=text/html title="Authentication :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/embed.html rel=alternate type=text/html title="Authentication :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1745614603 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1745614603 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1745614603 rel=stylesheet><link href=/cis526/css/auto-complete.css?1745614603 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1745614603 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1745614603 rel=stylesheet><link href=/cis526/css/fonts.css?1745614603 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1745614603 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1745614603 rel=stylesheet><link href=/cis526/css/theme-auto.css?1745614603 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1745614603 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1745614603 rel=stylesheet><link href=/cis526/css/print.css?1745614603 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1745614603 rel=stylesheet><script src=/cis526/js/variant.js?1745614603></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../..",window.relearn.relBaseUri="../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1745614603 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/x-examples/04-authentication/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/cis526/x-examples/><span itemprop=name>Example Projects</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Authentication</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/03-rest-api/11-delete/ title="Delete (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/04-authentication/01-bypass/ title="Bypass Auth (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=authentication>Authentication</h1><p>This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li>An authentication system using <a href=https://www.passportjs.org/ rel=external target=_blank>Passport.js</a> and <a href=https://apereo.github.io/cas/7.1.x/index.html rel=external target=_blank>CAS</a></li><li>Valid JSON Web Tokens (JWTs) for authentication within the RESTful API</li><li>Proper middleware to verify users have the correct role for each operation in the API</li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Authentication</h1><article class=default><header class=headline></header><h1 id=bypass-auth>Bypass Auth</h1><a href="https://www.youtube.com/watch?v=NjrWPg41_B4">YouTube Video</a><h2 id=authentication-libraries>Authentication Libraries</h2><p>There are many different authentication libraries and methods available for Node.js and Express. For this project, we will use the <a href=https://www.passportjs.org/ rel=external target=_blank>Passport.js</a> library. It supports many different authentication strategies, and is a very common way that authentication is handled within JavaScript applications.</p><p>For our application, we&rsquo;ll end up using several strategies to authenticate our users:</p><ul><li><a href=https://www.passportjs.org/packages/passport-unique-token/ rel=external target=_blank>Unique Token</a> - used to bypass authentication for testing</li><li><a href=https://github.com/appdevdesigns/passport-cas rel=external target=_blank>CAS</a> - used to authenticate with <a href=https://apereo.github.io/cas/7.1.x/index.html rel=external target=_blank>Central Authentication Service (CAS)</a> servers such as those used at K-State</li><li><a href=https://www.passportjs.org/packages/passport-jwt-cookiecombo/ rel=external target=_blank>JSON Web Tokens (JWT)</a> - used to identify user requests to the API itself</li></ul><p>Let&rsquo;s first set up our unique token strategy, which allows us to test our authentication routes before setting up anything else.</p><h2 id=authentication-router>Authentication Router</h2><p>First, we&rsquo;ll need to create a new route file at <code>routes/auth.js</code> to contain our authentication routes. We&rsquo;ll start with this basic structure and work on filling in each method as we go.</p><div class=tab-panel data-tab-group=24c3b80086c1e1955cf6aa40dba0b266><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("24c3b80086c1e1955cf6aa40dba0b266","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Auth router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: auth
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Authentication Routes
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   securitySchemes:
</span></span></span><span class=line><span class=cl><span class=cm> *     bearerAuth:
</span></span></span><span class=line><span class=cl><span class=cm> *       type: http
</span></span></span><span class=line><span class=cl><span class=cm> *       scheme: bearer
</span></span></span><span class=line><span class=cl><span class=cm> *       bearerFormat: JWT
</span></span></span><span class=line><span class=cl><span class=cm> *   responses:
</span></span></span><span class=line><span class=cl><span class=cm> *     AuthToken:
</span></span></span><span class=line><span class=cl><span class=cm> *       description: authentication success
</span></span></span><span class=line><span class=cl><span class=cm> *       content:
</span></span></span><span class=line><span class=cl><span class=cm> *         application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *           schema:
</span></span></span><span class=line><span class=cl><span class=cm> *             type: object
</span></span></span><span class=line><span class=cl><span class=cm> *             required:
</span></span></span><span class=line><span class=cl><span class=cm> *               - token
</span></span></span><span class=line><span class=cl><span class=cm> *             properties:
</span></span></span><span class=line><span class=cl><span class=cm> *               token:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                 description: a JWT for the user
</span></span></span><span class=line><span class=cl><span class=cm> *             example:
</span></span></span><span class=line><span class=cl><span class=cm> *               token: abcdefg12345
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;../configs/auth.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Authentication Response Handler
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>authSuccess</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Bypass authentication for testing
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/bypass:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: bypass authentication for testing
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Bypasses CAS authentication for testing purposes
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     parameters:
</span></span></span><span class=line><span class=cl><span class=cm> *       - in: query
</span></span></span><span class=line><span class=cl><span class=cm> *         name: token
</span></span></span><span class=line><span class=cl><span class=cm> *         required: true
</span></span></span><span class=line><span class=cl><span class=cm> *         schema:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *         description: username
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/bypass&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * CAS Authentication
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/cas:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: CAS authentication
</span></span></span><span class=line><span class=cl><span class=cm> *     description:  CAS authentication for deployment
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/cas&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Request JWT based on previous authentication
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/token:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: request JWT 
</span></span></span><span class=line><span class=cl><span class=cm> *     description: request JWT based on previous authentication
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         $ref: &#39;#/components/responses/AuthToken&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/token&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This file includes a few items to take note of:</p><ul><li>In the top-level Open API comment, we define a new <code>AuthToken</code> response that we&rsquo;ll send to the user when they request a token.</li><li>We create three routes. The first two, <code>/auth/bypass</code> and <code>/auth/cas</code>, for each of our authentication strategies. The last one, <code>/auth/token</code> will be used by our frontend to request a token to access the API.</li><li>Finally, we&rsquo;ll build a <code>authSuccess</code> function to handle actually sending the response to the user.</li></ul><p>Before moving on, let&rsquo;s go ahead and add this router to our <code>app.js</code> file along with the other routers:</p><div class=tab-panel data-tab-group=19e65c7ed1cd9f5853ebe4b748a82103><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("19e65c7ed1cd9f5853ebe4b748a82103","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/index.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>apiRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/api.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>authRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/auth.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Use routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/api&#34;</span><span class=p>,</span> <span class=nx>apiRouter</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=nx>authRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll come back to this file once we are ready to link up our authentication strategies.</p><h2 id=unique-token-authentication>Unique Token Authentication</h2><p>Next, let&rsquo;s install both <code>passport</code> and the <code>passport-unique-token</code> authentication strategy:</p><div class=tab-panel data-tab-group=c4c118693e4fb5a5519f644f1e71f4dd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c4c118693e4fb5a5519f644f1e71f4dd","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install passport passport-unique-token</span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll configure that strategy in a new <code>configs/auth.js</code> file with the following content:</p><div class=tab-panel data-tab-group=5ec413b72a7c2af6886a0cd681890b58><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5ec413b72a7c2af6886a0cd681890b58","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Passport.js Authentication
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UniqueTokenStrategy</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;passport-unique-token&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Authenticate a user
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} username the username to authenticate
</span></span></span><span class=line><span class=cl><span class=cm> * @param {function} next the next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>authenticateUser</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Find user with the username
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span> 
</span></span><span class=line><span class=cl>    <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>username</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// User not found
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span> <span class=o>===</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Login failed for user: &#34;</span> <span class=o>+</span> <span class=nx>username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// User authenticated
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Login succeeded for user: &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Convert Sequelize object to plain JavaScript object
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>user</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>user</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Bypass Authentication via Token
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=k>new</span> <span class=nx>UniqueTokenStrategy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=c1>// verify callback function
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>authenticateUser</span><span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Default functions to serialize and deserialize a session
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>serializeUser</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>done</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>passport</span><span class=p>.</span><span class=nx>deserializeUser</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>done</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this file, we created an <code>authenticateUser</code> function that will look for a user based on a given username. If found, it will return that user by calling the <code>next</code> middleware function. Otherwise, it will call that function and provide <code>false</code>.</p><p>Below, we configure Passport.js using the <code>passport.use</code> function to define the various authentication strategies we want to use. In this case, we&rsquo;ll start with the <a href=https://www.passportjs.org/packages/passport-unique-token/ rel=external target=_blank>Unique Token Strategy</a>, which uses a token provided as part of a query to the web server.</p><p>In addition, we need to implement some default functions to handle serializing and deserializing a user from a session. These functions don&rsquo;t really have any content in our implementation; we just need to include the default code.</p><p>Finally, since Passport.js acts as a global object, we don&rsquo;t even have to export anything from this file!</p><h2 id=testing-authentication>Testing Authentication</h2><p>To test this authentication strategy, let&rsquo;s modify <code>routes/auth.js</code> to use this strategy. We&rsquo;ll update the <code>/auth/bypass</code> route and also add some temporary code to the <code>authSuccess</code> function:</p><div class=tab-panel data-tab-group=27aaabe9e5a39f7fcd5d8c7e91e07d4b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("27aaabe9e5a39f7fcd5d8c7e91e07d4b","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import configurations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;../configs/auth.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>authSuccess</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/bypass&#34;</span><span class=p>,</span> <span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>,</span> <span class=p>{</span><span class=nx>session</span><span class=o>:</span> <span class=kc>false</span><span class=p>}),</span> <span class=nx>authSuccess</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>In the <code>authSuccess</code> function, right now we are just sending the content of <code>req.user</code>, which is set by Passport.js on a successful authentication (it is the value we returned when calling the <code>next</code> function in our authentication strategy earlier). We&rsquo;ll come back to this later when we implement JSON Web Tokens (JWT) later in this tutorial.</p><p>The other major change is that now the <code>/auth/bypass</code> route calls the <code>passport.authenticate</code> method with the <code>'token'</code> strategy specified. It also uses <code>{session: false}</code> as one of the options provided to Passport.js since we aren&rsquo;t actually going to be using sessions. Finally, if that middleware is satisfied, it will call the <code>authSuccess</code> function to handle sending the response to the user. This takes advantage of the chaining that we can do in Express!</p><p>With all of that in place, we can test our server and see if it works:</p><div class=tab-panel data-tab-group=16a0fb40478e21549c03bed100fc941c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("16a0fb40478e21549c03bed100fc941c","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once the page loads, we want to navigate to the <code>/auth/bypass?token=admin</code> path to see if we can log in as the <code>admin</code> user. Notice that we are including a query parameter named <code>token</code> to include the username in the URL.</p><p><a href=#R-image-8ee802a550d7d1a773e026c8f277b3ca class=lightbox-link><img alt="Successful Authentication" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8ee802a550d7d1a773e026c8f277b3ca><img alt="Successful Authentication" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_1.png></a></p><p>There we go! We see that it successfully finds our <code>admin</code> user and returns data about that user, including the roles assigned. This is what we want to see. We can also test this by providing other usernames to make sure it is working.</p><h2 id=securing-authentication>Securing Authentication</h2><p>Of course, we don&rsquo;t want to have this bypass authentication system available all the time in our application. In fact, we really only want to use it for testing and debugging; otherwise, our application will have a major security flaw! So, let&rsquo;s add a new environment variable <code>BYPASS_AUTH</code> to our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. We should set it to <code>TRUE</code> in the <code>.env.test</code> file, and for now we&rsquo;ll have it enabled in our <code>.env</code> file as well, but this option should <strong>NEVER</strong> be enabled in a production setting.</p><div class=tab-panel data-tab-group=fb43c5ad955c2ad5ef2a975f5cabea52><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fb43c5ad955c2ad5ef2a975f5cabea52","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=nv>BYPASS_AUTH</span><span class=o>=</span>true</span></span></code></pre></div></div></div></div></div><p>With that setting in place, we can add it to our <code>configs/auth.js</code> file to only allow bypass authentication if that setting is enabled:</p><div class=tab-panel data-tab-group=19b2e912b4da00cccd7d3d754712d591><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("19b2e912b4da00cccd7d3d754712d591","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Bypass Authentication via Token
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=k>new</span> <span class=nx>UniqueTokenStrategy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=c1>// verify callback function
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Only allow token authentication when enabled
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>BYPASS_AUTH</span> <span class=o>===</span> <span class=s2>&#34;true&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>authenticateUser</span><span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>))</span></span></span></code></pre></div></div></div></div></div><p>Before moving on, we should make sure we test both enabling and disabling this setting <em>actually</em> disables bypass authentication. We want to be absolutely sure it works as intended!</p><p><a href=#R-image-8f5ea9275042758d5d9f3bc1e67e48b6 class=lightbox-link><img alt="Disabled Authentication" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8f5ea9275042758d5d9f3bc1e67e48b6><img alt="Disabled Authentication" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_2.png></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cookie-sessions>Cookie Sessions</h1><a href="https://www.youtube.com/watch?v=HR3gG-9bwts">YouTube Video</a><h2 id=cookie-sessions>Cookie Sessions</h2><p>One of the most common methods for keeping track of users after they are authenticated is by setting a cookie on their browser that is sent with each request. We&rsquo;ve already explored this method earlier in this course, so let&rsquo;s go ahead and configure cookie sessions for our application, storing them in our existing database.</p><p>We&rsquo;ll start by installing both the <a href=https://www.npmjs.com/package/express-session rel=external target=_blank>express-session</a> middleware and the <a href=https://www.npmjs.com/package/connect-session-sequelize rel=external target=_blank>connect-session-sequelize</a> library that we can use to store our sessions in a Sequelize database:</p><div class=tab-panel data-tab-group=8c4448dc2b3a12dc3ff43068427d9814><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8c4448dc2b3a12dc3ff43068427d9814","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install express-session connect-session-sequelize</span></span></code></pre></div></div></div></div></div><p>Once those libraries are installed, we can create a configuration for sessions in a new <code>configs/sessions.js</code> file:</p><div class=tab-panel data-tab-group=77198596afc2c6a553ced2f05c57b78f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configssessionsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("77198596afc2c6a553ced2f05c57b78f","configssessionsjs")'>
<span class=tab-nav-text>configs/sessions.js</span></button></div><div class=tab-content-container><div data-tab-item=configssessionsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration for cookie sessions stored in Sequelize
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports sequelizeSession a Session instance configured for Sequelize
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>session</span> <span class=nx>from</span> <span class=s1>&#39;express-session&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>connectSession</span> <span class=nx>from</span> <span class=s1>&#39;connect-session-sequelize&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s1>&#39;./database.js&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;./logger.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Initialize Store
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>sequelizeStore</span> <span class=o>=</span> <span class=nx>connectSession</span><span class=p>(</span><span class=nx>session</span><span class=p>.</span><span class=nx>Store</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>store</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>sequelizeStore</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=o>:</span> <span class=nx>database</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create tables in Sequelize
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>store</span><span class=p>.</span><span class=nx>sync</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_SECRET</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&#34;Cookie session secret not set! Set a SESSION_SECRET environment variable.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Session configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>sequelizeSession</span> <span class=o>=</span> <span class=nx>session</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_NAME</span> <span class=o>||</span> <span class=s1>&#39;connect.sid&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>secret</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_SECRET</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>store</span><span class=o>:</span> <span class=nx>store</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=nx>resave</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>proxy</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>saveUninitialized</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>sequelizeSession</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This file loads our Sequelize database connection and initializes the Express session middleware and the Sequelize session store. We also have a quick sanity check that will ensure there is a <code>SESSION_SECRET</code> environment variable set, otherwise an error will be printed. Finally, we export that session configuration to our application.</p><p>So, we&rsquo;ll need to add a <code>SESSION_NAME</code> and <code>SESSION_SECRET</code> environment variable to our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. The <code>SESSION_NAME</code> is a unique name for our cookie, and the <code>SESSION_SECRET</code> is a secret key used to secure our cookies and prevent them from being modified.</p><p>There are many ways to generate a secret key, but one of the simplest is to just use the built in functions in Node.js itself. We can launch the Node.js <a href=https://nodejs.org/en/learn/command-line/how-to-use-the-nodejs-repl rel=external target=_blank>REPL</a> environment by just running the <code>node</code> command in the terminal:</p><div class=tab-panel data-tab-group=e0bf61a26d3b41972618df0e41f4e019><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e0bf61a26d3b41972618df0e41f4e019","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node</span></span></code></pre></div></div></div></div></div><p>From there, we can use this line to get a random secret key:</p><div class=tab-panel data-tab-group=164592ee1d9d9e1828eb200afd275c59><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=node class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("164592ee1d9d9e1828eb200afd275c59","node")'>
<span class=tab-nav-text>node</span></button></div><div class=tab-content-container><div data-tab-item=node class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;crypto&#39;</span><span class=p>).</span><span class=nx>randomBytes</span><span class=p>(</span><span class=mi>64</span><span class=p>).</span><span class=nx>toString</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>)</span></span></span></code></pre></div></div></div></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Documenting Terminal Commands</div><div class=box-content><p>Just like we use <code>$</code> as the prompt for Linux terminal commands, the Node.js REPL environment uses <code>></code> so we will include that in our documentation. You should not include that character in your command.</p></div></div><p>If done correctly, we&rsquo;ll get a random string that you can use as your secret key!</p><p><a href=#R-image-aea60a463d584340bfd8833239ef9c24 class=lightbox-link><img alt="Secret Key" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-aea60a463d584340bfd8833239ef9c24><img alt="Secret Key" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_3.png></a></p><p>We can include that key in our <code>.env</code> file. To help remember how to do this in the future, we can even include the Node.js command as a comment above that line:</p><div class=tab-panel data-tab-group=e2f8df2e25857a5220e959e1187d4203><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e2f8df2e25857a5220e959e1187d4203","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=nv>SESSION_NAME</span><span class=o>=</span>lostcommunities
</span></span><span class=line><span class=cl><span class=c1># require(&#39;crypto&#39;).randomBytes(64).toString(&#39;hex&#39;)</span>
</span></span><span class=line><span class=cl><span class=nv>SESSION_SECRET</span><span class=o>=</span>46a5fdfe16fa710867102d1f0dbd2329f2eae69be3ed56ca084d9e0ad....</span></span></code></pre></div></div></div></div></div><p>Finally, we can update our <code>app.js</code> file to use this session configuration. We&rsquo;ll place this between the <code>/api</code> and <code>/auth</code> routes, since we only want to load cookie sessions if the user is accessing the authentication routes, to minimize the number of database requests:</p><div class=tab-panel data-tab-group=461841ea2db8affdf7f5e7e494e362ae><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("461841ea2db8affdf7f5e7e494e362ae","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>compression</span> <span class=nx>from</span> <span class=s2>&#34;compression&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s2>&#34;cookie-parser&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>helmet</span> <span class=nx>from</span> <span class=s2>&#34;helmet&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s2>&#34;path&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>swaggerUi</span> <span class=nx>from</span> <span class=s2>&#34;swagger-ui-express&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>openapi</span> <span class=nx>from</span> <span class=s2>&#34;./configs/openapi.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>sessions</span> <span class=nx>from</span> <span class=s2>&#34;./configs/sessions.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Use routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/api&#34;</span><span class=p>,</span> <span class=nx>apiRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Use sessions
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>sessions</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s2>&#34;session&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use auth routes
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=nx>authRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>There we go! Now we can enable cookie sessions in Passport.js by removing the <code>{session: false}</code> setting in our <code>/auth/bypass</code> route in the <code>routes/auth.js</code> file:</p><div class=tab-panel data-tab-group=6a2c80c45ffdca7bcbeb51734b508750><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6a2c80c45ffdca7bcbeb51734b508750","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/bypass&#34;</span><span class=p>,</span> <span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>),</span> <span class=nx>authSuccess</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we navigate to that route and authenticate, we should see our application set a session cookie as part of the response.</p><p><a href=#R-image-d4a4c8eb87e43d98e12fab4bb58c5e12 class=lightbox-link><img alt="Cookie Session" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_7.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d4a4c8eb87e43d98e12fab4bb58c5e12><img alt="Cookie Session" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_7.png></a></p><p>We can match the SID in the session cookie with the SID in the <code>Sessions</code> table in our database to confirm that it is working:</p><p><a href=#R-image-8b2bbbdd6f8962946d918c964ac90fcd class=lightbox-link><img alt="Cookie Session in Database" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_8.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8b2bbbdd6f8962946d918c964ac90fcd><img alt="Cookie Session in Database" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_8.png></a></p><p>From here, we can use these sessions throughout our application to track users as they make additional requests.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=json-web-token>JSON Web Token</h1><a href="https://www.youtube.com/watch?v=j9tzO3bQxxs">YouTube Video</a><h2 id=json-web-tokens-jwt>JSON Web Tokens (JWT)</h2><p>Now that we have a working authentication system, the next step is to configure a method to request a valid JSON Web Token, or JWT, that contains information about the authenticated user. We&rsquo;ve already learned a bit about JWTs in this course, so we won&rsquo;t cover too many of the details here.</p><p>To work with JWTs, we&rsquo;ll need to install the <a href=https://www.npmjs.com/package/jsonwebtoken rel=external target=_blank>jsonwebtoken</a> package from NPM:</p><div class=tab-panel data-tab-group=0769b87d085b295fd3c18133272358d8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0769b87d085b295fd3c18133272358d8","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install jsonwebtoken</span></span></code></pre></div></div></div></div></div><p>Next, we&rsquo;ll need to create a secret key that we can use to sign our tokens. We&rsquo;ll add this as the <code>JWT_SECRET_KEY</code> setting in our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. We can use the same method discussed on the previous page to generate a new random key:</p><div class=tab-panel data-tab-group=af3d96cb1743019602debb20abcf4fac><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("af3d96cb1743019602debb20abcf4fac","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=c1># require(&#39;crypto&#39;).randomBytes(64).toString(&#39;hex&#39;)</span>
</span></span><span class=line><span class=cl><span class=nv>JWT_SECRET_KEY</span><span class=o>=</span><span class=s1>&#39;46a5fdfe16fa710867102d1f0dbd2329f2eae69be3ed56ca084d9e0ad....&#39;</span></span></span></code></pre></div></div></div></div></div><p>Once we have the library and a key, we can easily create and sign a JWT in the <code>/auth/token</code> route in the <code>routes/auth.js</code> file:</p><div class=tab-panel data-tab-group=6efac084d3bdf4ce92dd8ce773e8adf9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6efac084d3bdf4ce92dd8ce773e8adf9","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>jsonwebtoken</span> <span class=nx>from</span> <span class=s2>&#34;jsonwebtoken&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/token&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// If user is logged in
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>JWT_SECRET_KEY</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>expiresIn</span><span class=o>:</span> <span class=s1>&#39;6h&#39;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>token</span><span class=o>:</span> <span class=nx>token</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Send unauthorized response
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Now, when we visit the <code>/auth/token</code> URL on our working website (after logging in through the <code>/auth/bypass</code> route), we should receive a JWT as a response:</p><p><a href=#R-image-a1a355fff8d74ce618e23002f6409d43 class=lightbox-link><img alt="JWT Response" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a1a355fff8d74ce618e23002f6409d43><img alt="JWT Response" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_4.png></a></p><p>Of course, while that data may seem unreadable, we already know that JWTs are Base64 encoded, so we can easily view the content of the token. Thankfully, there are many great tools we can use to debug our tokens, such as <a href=https://token.dev/ rel=external target=_blank>Token.dev</a>, to confirm that they are working correctly.</p><p><a href=#R-image-e4307c9f3714ca37245a0b93940ef98a class=lightbox-link><img alt="JWT Debugger" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e4307c9f3714ca37245a0b93940ef98a><img alt="JWT Debugger" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_5.png></a></p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Do Not Share Live Keys!</div><div class=box-content><p>While sites like this will also help you confirm that your JWTs are properly signed by asking for your secret key, you <strong>SHOULD NOT</strong> share a secret key for a live production application with these sites. There is always a chance it has been compromised!</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=auth-routing>Auth Routing</h1><a href="https://www.youtube.com/watch?v=8hOtlMwkSow">YouTube Video</a><h2 id=routing-after-authentication>Routing after Authentication</h2><p>The last step we should take in our authentication system is to properly route users back to the index page after a successful login attempt. Since we will eventually be building a single-page application in Vue.js as our frontend for this application, we only need to worry about directing users back to the index page, which will load our frontend.</p><p>So, in our <code>authSuccess</code> method in <code>routes/auth.js</code>, we can update the response to redirect our users back to the index page:</p><div class=tab-panel data-tab-group=8504f47d51f9bf6694a720b96d59596b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=authroutesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8504f47d51f9bf6694a720b96d59596b","authroutesjs")'>
<span class=tab-nav-text>auth/routes.js</span></button></div><div class=tab-content-container><div data-tab-item=authroutesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>authSuccess</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>The <code>res.redirect</code> method will sent an HTTP 302 <code>Found</code> response back to the browser with a new location to navigate to. However, by that point, the authentication process will also send a cookie to the browser with the session ID, so the user will be logged in correctly:</p><p><a href=#R-image-bd76b884e5d5e348c257cb4245f94674 class=lightbox-link><img alt="Session Login with Cookie Set" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_9.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-bd76b884e5d5e348c257cb4245f94674><img alt="Session Login with Cookie Set" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_9.png></a></p><h2 id=logout-route>Logout Route</h2><p>Finally, we should also add a logout route. This route will end any sessions created through Passport.js by removing the session from the database and also telling the browser to delete the session cookie. It uses the special <code>req.logout()</code> method that is added to each request by Passport.js. We&rsquo;ll add our logout route to the bottom of the <code>routes/auth.js</code> file:</p><div class=tab-panel data-tab-group=28a1d6b2b3e25d5bff3a15fc5f07e71b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("28a1d6b2b3e25d5bff3a15fc5f07e71b","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;../configs/auth.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Logout of a Passport.js session
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * See https://www.initialapps.com/properly-logout-passportjs-express-session-for-single-page-app/
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/logout:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: logout current user
</span></span></span><span class=line><span class=cl><span class=cm> *     description:  logout current user and end session
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/logout&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>clearCookie</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_NAME</span> <span class=o>||</span> <span class=s1>&#39;connect.sid&#39;</span><span class=p>);</span>  <span class=c1>// clear the session cookie
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>req</span><span class=p>.</span><span class=nx>logout</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>       <span class=c1>// logout of passport
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>destroy</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// destroy the session
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we access this route with a valid session, we&rsquo;ll see that the user is properly logged out.</p><p>We&rsquo;ll also no longer be able to access the <code>/auth/token</code> route without logging in again.</p><p>However, this route <strong>WILL NOT</strong> invalidate any existing JWTs already issued to that user - they will still be valid until they expire. In our earlier example, we set the JWTs to have a 6 hour lifetime, so in theory a user could still access the application using a valid JWT up to 6 hours after logging out!</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Invalidating JWTs</div><div class=box-content><p>JSON Web Tokens (JWTs) are a very powerful authentication method for web APIs because they allow users to send requests without worrying about the need for a cookie session. In theory, a JWT issued by any instance of our API can be validated anywhere, making it much easier to horizontally scale this application in the future.</p><p>In addition, requests with a JWT generally don&rsquo;t require a database access with each request to validate the session. Our current cookie sessions store the session data in the database, so now each incoming request containing a session cookie requires a database lookup to get information about the user before any work can be done.</p><p>However, this means that any user with a valid JWT will be able to access our application even if they have logged out. This may present a security issue for some applications.</p><p>There are some strategies to mitigate this risk:</p><ol><li>Use JWTs with a short expiration - this means users may have to log in again and/or request new tokens more often, which could be frustrating.</li><li>Add a database session to each JWT - this would mean that each incoming request with a JWT would now result in a database lookup, which could slow things down. Alternatively, sessions could be stored in a faster cache mechanism such as <a href=https://redis.io/ rel=external target=_blank>Redis</a> or <a href=https://valkey.io/ rel=external target=_blank>Valkey</a>.</li><li>To permanently invalidate all existing JWT sessions (in case of a security compromise or other concern), simply change the key used to sign the JWTs to a new secure key. This is a method of last resort, but it is always important to know that it is available if needed.</li></ol></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cas-authentication>CAS Authentication</h1><a href="https://www.youtube.com/watch?v=fnsW2-iKliE">YouTube Video</a><h2 id=cas-authentication>CAS Authentication</h2><p>We&rsquo;ve already studied <a href=https://apereo.github.io/cas/7.1.x/index.html rel=external target=_blank>Central Authentication Service (CAS)</a> as one method for authenticating users through a third party service. In this case, CAS is the service commonly used at K-State for authentication, which is why we like to cover it in our examples. So, let&rsquo;s look at how to add CAS authentication to our application through Passport.</p><h2 id=installing-a-passport-strategy>Installing a Passport Strategy</h2><p>First, we&rsquo;ll need to install a new Passport.js strategy for dealing with CAS authentication. Thankfully, the ALT+CS lab at K-State maintains an updated library for this, which can be installed as shown below:</p><div class=tab-panel data-tab-group=ac3a94a75aa3ca2f1042601598135441><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ac3a94a75aa3ca2f1042601598135441","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install https://github.com/alt-cs-lab/passport-cas</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Finding a Good Strategy</div><div class=box-content><p>Unfortunately, it is very difficult to find an updated Passport.js strategy for CAS authentication. This is partially due to the fact the CAS is not commonly used, and partially because many existing strategies have been written once and then abandoned by the developers. For this class, we sought out the most updated strategy available, then did our best to fix any known/existing bugs.</p></div></div><h2 id=configuring-cas-strategy>Configuring CAS Strategy</h2><p>Next, we can configure our authentication strategy by adding a few items to the <code>configs/auth.js</code> file for our new CAS strategy:</p><div class=tab-panel data-tab-group=324a94e825ec910682d097665f669415><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("324a94e825ec910682d097665f669415","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UniqueTokenStrategy</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;passport-unique-token&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Strategy</span> <span class=nx>as</span> <span class=nx>CasStrategy</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@alt-cs-lab/passport-cas&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// CAS authentication
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=k>new</span> <span class=nx>CasStrategy</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>version</span><span class=o>:</span> <span class=s1>&#39;CAS2.0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>ssoBaseURL</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_URL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>serverBaseURL</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_SERVICE_URL</span> <span class=o>+</span> <span class=s1>&#39;/auth/cas&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nx>profile</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>profile</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>authenticateUser</span><span class=p>(</span><span class=nx>profile</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=s2>&#34;CAS authentication succeeded but no user returned: &#34;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>profile</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>In this file, we are importing our new CAS authentication strategy, then using <code>passport.use</code> to tell Passport.js to use this authentication strategy when requested. Inside, we set up the various settings for our strategy, as well as the callback function when a user successfully authenticates. In this case, the CAS server will give us a <code>profile</code> object that should contain the <code>user</code> attribute with the user&rsquo;s username, which we can send to our <code>authenticateUser</code> method we&rsquo;ve already created. Finally, we also include a short catch to log any errors where the user is able to log in but a username is not provided.</p><p>In our <code>.env</code> file, we&rsquo;ll need to add two more settings. The <code>CAS_URL</code> is the base URL for the CAS server itself, and the <code>CAS_SERVICE_URL</code> is the URL that users should be sent back to, along with a ticket, to complete the log in process. Since we are working in GitHub Codespaces, our <code>CAS_SERVICE_URL</code> will be the same as our <code>OPENAPI_HOST</code>.</p><div class=tab-panel data-tab-group=db25751702016e77b2f8ec000838829d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("db25751702016e77b2f8ec000838829d","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=nv>CAS_URL</span><span class=o>=</span>https://testcas.cs.ksu.edu
</span></span><span class=line><span class=cl><span class=nv>CAS_SERVICE_URL</span><span class=o>=</span>https://<span class=nv>$CODESPACE_NAME</span>-<span class=nv>$PORT</span>.<span class=nv>$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span></span></span></code></pre></div></div></div></div></div><p>Notice that we already add the <code>/auth/cas</code> route to the end of the <code>CAS_SERVICE_URL</code> in the configuration above - since that path won&rsquo;t change, it makes sense to just include it there instead of having to remember to add it to the path in the <code>.env</code> file. We should also put sensible defaults in our <code>.env.example</code> and <code>.env.test</code> files as well.</p><p>Now, to use this authentication method, all we have to do is update our <code>/auth/cas</code> route in <code>routes/auth.js</code> to use this strategy:</p><div class=tab-panel data-tab-group=3bc5b1f3ef261186f1f56162ee0eba27><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3bc5b1f3ef261186f1f56162ee0eba27","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * CAS Authentication
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/cas:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: CAS authentication
</span></span></span><span class=line><span class=cl><span class=cm> *     description:  CAS authentication for deployment
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/cas&#34;</span><span class=p>,</span> <span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s1>&#39;cas&#39;</span><span class=p>),</span> <span class=nx>authSuccess</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>With that in place, we can start our application and test it by navigating to the <code>/auth/cas</code> route to see if our login attempt works:</p><div class=tab-panel data-tab-group=69cc65191260a851ad71a87c2a30a08d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("69cc65191260a851ad71a87c2a30a08d","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>If everything works correctly, we should be directed to our CAS server to authenticate, then we&rsquo;ll be sent back to our own server with a ticket to validate our authentication. Finally, once the ticket is validated, we&rsquo;ll be redirected back to our home page with a session cookie set:</p><p><a href=#R-image-1d410fba900bd56226dd62453c8f2d97 class=lightbox-link><img alt="CAS Login with Cookie Set" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_9.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1d410fba900bd56226dd62453c8f2d97><img alt="CAS Login with Cookie Set" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_9.png></a></p><h2 id=cas-logout>CAS Logout</h2><p>Finally, we&rsquo;ll need to add a bit more logic to our logout process to properly log users out of both our application and the CAS server they originally logged in through. So, let&rsquo;s update our <code>/auth/logout</code> route to include that:</p><div class=tab-panel data-tab-group=5a74714cbac5a5da155bf8a58eafb5d3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5a74714cbac5a5da155bf8a58eafb5d3","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/logout&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>clearCookie</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_NAME</span> <span class=o>||</span> <span class=s1>&#39;connect.sid&#39;</span><span class=p>);</span>  <span class=c1>// clear the session cookie
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>req</span><span class=p>.</span><span class=nx>logout</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>       <span class=c1>// logout of passport
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>destroy</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// destroy the session
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>      <span class=kr>const</span> <span class=nx>redirectURL</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_URL</span> <span class=o>+</span> <span class=s2>&#34;/logout?service=&#34;</span> <span class=o>+</span> <span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_SERVICE_URL</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=nx>redirectURL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Most CAS servers will automatically redirect the user back to the <code>service</code> request parameter, but not all of them. However, this will ensure that the CAS server knows the user has logged out and will invalidate any tickets for that user.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Test CAS Server Updated</div><div class=box-content><p>The test CAS server was updated recently to properly redirect users back to the <code>service</code> request parameter, so you will probably no longer see the Logout page from that server in your testing. This should make developing and testing with that server a bit more straightforward</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=new-users>New Users</h1><a href="https://www.youtube.com/watch?v=53odl8cktpI">YouTube Video</a><h2 id=handling-new-users>Handling New Users</h2><p>What if a user logs in to our application through CAS, but we don&rsquo;t have them in our database of users? Do we want to deny them access to the application? Or should we somehow gracefully add them to the list of users and give them some basic access to our application?</p><p>Since we are building a website meant to be open to a number of users, let&rsquo;s go ahead and implement a strategy where a new user can be created in the event that a user logs on through one of our authentication strategies but isn&rsquo;t found in the database.</p><p>Thankfully, to do this is really simple - all we must do is add a few additional lines to our <code>authenticateUser</code> function in the <code>configs/auth.js</code> file:</p><div class=tab-panel data-tab-group=d8c417ef6263c50657de3f2d2561ab0f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d8c417ef6263c50657de3f2d2561ab0f","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>authenticateUser</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Find user with the username
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span> 
</span></span><span class=line><span class=cl>    <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>username</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// User not found
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span> <span class=o>===</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Create new user
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>User</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>username</span><span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;New user created via login: &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>        
</span></span><span class="line hl"><span class=cl>        <span class=c1>// Convert Sequelize object to plain JavaScript object
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>        <span class=nx>user</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>user</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>        <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// User authenticated
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Login succeeded for user: &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>      
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Convert Sequelize object to plain JavaScript object
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>user</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>user</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>      <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we try to log in using any username, we&rsquo;ll either be logged in as an existing user, or a new user will be created. We can see this in our log output:</p><div class=tab-panel data-tab-group=7eb5a237f1f621748e108e730aac6ecf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7eb5a237f1f621748e108e730aac6ecf","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[2025-03-20 07:15:17.256 PM] http:      GET /auth/cas 302 0.697 ms - 0
[2025-03-20 07:15:23.525 PM] debug:     New user created via login: russfeld
[2025-03-20 07:15:23.564 PM] http:      GET /auth/cas?ticket=aac12881-9bea-449c-bf13-b981525cc8db 302 218.923 ms - 30
[2025-03-20 07:15:23.721 PM] http:      GET / 200 1.299 ms - -</code></pre></div></div></div></div></div><p>That&rsquo;s all there is to it! Of course, we can also configure this process to automatically assign roles to our newly created user, but for right now we won&rsquo;t worry about that.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=testing-authentication>Testing Authentication</h1><a href="https://www.youtube.com/watch?v=W4jM6hkYuks">YouTube Video</a><h2 id=testing-authentication-routes>Testing Authentication Routes</h2><p>Now that we have our authentication system working for our application, let&rsquo;s write some unit tests to confirm that it works as expected in a variety of situations.</p><p>As part of these tests, we&rsquo;ll end up creating a <a href=https://en.wikipedia.org/wiki/Test_double rel=external target=_blank>test double</a> of one part of our authentication system to make it easier to test. To do this, we&rsquo;ll use the <a href=https://sinonjs.org/ rel=external target=_blank>Sinon</a> library, so let&rsquo;s start by installing it as a development dependency:</p><div class=tab-panel data-tab-group=5608cd2e56d27a87d4515fbc73409600><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5608cd2e56d27a87d4515fbc73409600","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install --save-dev sinon</span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll store these tests in the <code>test/auth.js</code> file, starting with this content including the libraries we&rsquo;ll need to use:</p><div class=tab-panel data-tab-group=edea0d1f2bbbdbb283b3a76a1dc28b08><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("edea0d1f2bbbdbb283b3a76a1dc28b08","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /auth Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span><span class=p>,</span> <span class=nx>expect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>sinon</span> <span class=nx>from</span> <span class=s2>&#34;sinon&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>jsonwebtoken</span> <span class=nx>from</span> <span class=s2>&#34;jsonwebtoken&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiJsonSchemaAjv</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>verbose</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiShallowDeepEqual</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Modify Object.prototype for BDD style assertions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>should</span><span class=p>();</span></span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll continue to build out tests below that content in the same file.</p><h3 id=testing-bypass-authentication>Testing Bypass Authentication</h3><p>First, let&rsquo;s look at some tests for the <code>/auth/bypass</code> route, since that is the simplest. The first test is a very simple one to confirm that bypass authentication works, and also that it sets the expected cookie in the browser when it redirects the user back to the home page:</p><div class=tab-panel data-tab-group=cb399593b749cd5c86099634f43b897b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cb399593b749cd5c86099634f43b897b","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Regular expression to match the expected cookie
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>regex_valid</span> <span class=o>=</span> <span class=s2>&#34;^&#34;</span> <span class=o>+</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_NAME</span> <span class=o>+</span> <span class=s2>&#34;=\\S*; Path=/; HttpOnly$&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test Bypass authentication
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>bypassAuth</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should allow bypass login with user &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// List of existing users to be tested
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;admin&#34;</span><span class=p>,</span> <span class=s2>&#34;contributor&#34;</span><span class=p>,</span> <span class=s2>&#34;manager&#34;</span><span class=p>,</span> <span class=s2>&#34;user&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /bypass&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>bypassAuth</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Notice that we are using a <a href=https://en.wikipedia.org/wiki/Regular_expression rel=external target=_blank>regular expression</a> to help us verify that the cookie being sent to the user is using the correct name and has the expected content.</p><p>Next, we also should test to make sure that using bypass authentication with any unknown username will create that user:</p><div class=tab-panel data-tab-group=705a880d3d47f95312c472aeef92c644><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("705a880d3d47f95312c472aeef92c644","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test Bypass authentication creates user
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>bypassAuthCreatesUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should allow bypass login with new user &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>          <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>user</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>found_user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>expect</span><span class=p>(</span><span class=nx>found_user</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>not</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>found_user</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;username&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>expect</span><span class=p>(</span><span class=nx>found_user</span><span class=p>.</span><span class=nx>username</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /bypass&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>bypassAuth</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>bypassAuthCreatesUser</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This test will first log the user in, then it will directly check the database to ensure that the user has been created successfully. Alternatively, we could also use the API, but we&rsquo;re trying to keep our tests independent, so in this case it makes the most sense to query the database directly in our test instead of any other method.</p><h3 id=testing-cas-authentication>Testing CAS Authentication</h3><p>Next, let&rsquo;s write the tests for our CAS authentication strategy. These are similar to the ones we&rsquo;ve already written, but they have some key differences as well.</p><p>First, we can write a simple test just to show that any user who visits the <code>/auth/cas</code> route will be properly redirected to the correct CAS server:</p><div class=tab-panel data-tab-group=b87874e9dda855c318b54e5fb31a251e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b87874e9dda855c318b54e5fb31a251e","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test CAS authentication redirect
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>casAuthRedirect</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should redirect users to CAS server&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>expectedURL</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_URL</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;/login?service=&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>      <span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_SERVICE_URL</span> <span class=o>+</span> <span class=s2>&#34;/auth/cas&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/cas&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=nx>expectedURL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /cas&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>casAuthRedirect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this test, we are building the URL that the user should be redirected to, based on the settings we have already set in our environment file. Then, we simply check that the returned response is an HTTP 302 Found response with the correct location indicated.</p><p>The next two tests are much more complex, because they require us to mock the step where our server confirms that the user is authenticated with the CAS server by sending a request with a ticket attached, and then getting a response for that ticket. We can do this using a bit of clever coding and the <a href=https://sinonjs.org/ rel=external target=_blank>Sinon</a> library.</p><p>First, we need to mock up a response object that mimics what the server would respond with. This is mocked just so it will be understood by our CAS authentication library and may not work in all cases:</p><div class=tab-panel data-tab-group=365b3a45fbe6d03304a09bac77f6867d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("365b3a45fbe6d03304a09bac77f6867d","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Helper function to generate a valid mock CAS 2.0 Ticket
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>validTicket</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>ticket</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=sb>`&lt;cas:serviceResponse xmlns:cas=&#39;http://www.yale.edu/tp/cas&#39;&gt;
</span></span></span><span class=line><span class=cl><span class=sb>          &lt;cas:authenticationSuccess&gt;
</span></span></span><span class=line><span class=cl><span class=sb>              &lt;cas:user&gt;</span><span class=si>${</span><span class=nx>user</span><span class=si>}</span><span class=sb>&lt;/cas:user&gt;
</span></span></span><span class=line><span class=cl><span class=sb>              &lt;cas:ksuPersonWildcatID&gt;</span><span class=si>${</span><span class=mi>123456789</span><span class=si>}</span><span class=sb>&lt;/cas:ksuPersonWildcatID&gt;
</span></span></span><span class=line><span class=cl><span class=sb>              &lt;cas:proxyGrantingTicket&gt;</span><span class=si>${</span><span class=nx>ticket</span><span class=si>}</span><span class=sb>&lt;/cas:proxyGrantingTicket&gt;
</span></span></span><span class=line><span class=cl><span class=sb>          &lt;/cas:authenticationSuccess&gt;
</span></span></span><span class=line><span class=cl><span class=sb>        &lt;/cas:serviceResponse&gt;`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>This function creates an object with a single method <code>text()</code> that will return a valid XML ticket for the given user and random ticket ID.</p><p>Right below that, we can create a unit test that will mock the global <code>fetch</code> function used by our CAS authentication strategy to contact the CAS server to validate the ticket, and instead it will respond with our mock response object created above:</p><div class=tab-panel data-tab-group=c9804ee6e7b186241e3643946f2c60cc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c9804ee6e7b186241e3643946f2c60cc","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test CAS with valid ticket
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>casAuthValidTicket</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should log in user &#34;</span> <span class=o>+</span> <span class=nx>user</span> <span class=o>+</span> <span class=s2>&#34; via CAS&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ticket</span> <span class=o>=</span> <span class=s2>&#34;abc123&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>fetchStub</span> <span class=o>=</span> <span class=nx>sinon</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>stub</span><span class=p>(</span><span class=nx>global</span><span class=p>,</span> <span class=s2>&#34;fetch&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>resolves</span><span class=p>(</span><span class=nx>validTicket</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>ticket</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/cas?ticket=&#34;</span> <span class=o>+</span> <span class=nx>ticket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>sinon</span><span class=p>.</span><span class=nx>assert</span><span class=p>.</span><span class=nx>calledOnce</span><span class=p>(</span><span class=nx>fetchStub</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>fetchStub</span><span class=p>.</span><span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]).</span><span class=nx>to</span><span class=p>.</span><span class=nx>contain</span><span class=p>(</span><span class=s2>&#34;?ticket=&#34;</span> <span class=o>+</span> <span class=nx>ticket</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /cas&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>casAuthRedirect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>casAuthValidTicket</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this test, we create a <code>fetchStub</code> object that is used by our CAS authentication strategy in place of <code>fetch</code>. It will confirm that the user has a valid ticket and can be authenticated, so we can perform the same steps as before and ensure that the cookie is properly set when the user is authenticated.</p><p>We also are checking that the <code>fetch</code> method we mocked was actually called once, and that it contained the ticket we provided as part of the URL. This is just a sanity check to make sure that we mocked up the correct part of our application!</p><p>We must also add a new item in the <code>afterEach()</code> hook for Mocha, which will reset all functions and objects that are mocked by Sinon after each test. This ensures we are always working with a clean slate. We&rsquo;ll update the function in <code>test/hooks.js</code> with this new content:</p><div class=tab-panel data-tab-group=aa2fe928d659f9252bc7287c353890d8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhooksjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("aa2fe928d659f9252bc7287c353890d8","testhooksjs")'>
<span class=tab-nav-text>test/hooks.js</span></button></div><div class=tab-content-container><div data-tab-item=testhooksjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import libraries
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>sinon</span> <span class=nx>from</span> <span class=s2>&#34;sinon&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Root Hook Runs Before Each Test
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>mochaHooks</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// Hook runs after each individual test
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>afterEach</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Restore Sinon mocks
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=nx>sinon</span><span class=p>.</span><span class=nx>restore</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Remove all data from the database
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>seeds</span><span class=p>.</span><span class=nx>down</span><span class=p>({</span> <span class=nx>to</span><span class=o>:</span> <span class=mi>0</span> <span class=p>}).</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div></div></div></div><p>Finally, we also should confirm that logging in via CAS will create a new user if the username is not recognized. This test builds upon the previous CAS test in a way similar to the one used for bypass authentication above:</p><div class=tab-panel data-tab-group=338d57b5667440db0ac6d29a34e99ae4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("338d57b5667440db0ac6d29a34e99ae4","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test CAS creates user
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>casAuthValidTicketCreatesUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should create new user &#34;</span> <span class=o>+</span> <span class=nx>user</span> <span class=o>+</span> <span class=s2>&#34; via CAS&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ticket</span> <span class=o>=</span> <span class=s2>&#34;abc123&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>fetchStub</span> <span class=o>=</span> <span class=nx>sinon</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>stub</span><span class=p>(</span><span class=nx>global</span><span class=p>,</span> <span class=s2>&#34;fetch&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>resolves</span><span class=p>(</span><span class=nx>validTicket</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>ticket</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/cas?ticket=&#34;</span> <span class=o>+</span> <span class=nx>ticket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>sinon</span><span class=p>.</span><span class=nx>assert</span><span class=p>.</span><span class=nx>calledOnce</span><span class=p>(</span><span class=nx>fetchStub</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>fetchStub</span><span class=p>.</span><span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]).</span><span class=nx>to</span><span class=p>.</span><span class=nx>contain</span><span class=p>(</span><span class=s2>&#34;?ticket=&#34;</span> <span class=o>+</span> <span class=nx>ticket</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>          <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>user</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>found_user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>expect</span><span class=p>(</span><span class=nx>found_user</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>not</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>found_user</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;username&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>expect</span><span class=p>(</span><span class=nx>found_user</span><span class=p>.</span><span class=nx>username</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /cas&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>casAuthRedirect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>casAuthValidTicket</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>casAuthValidTicketCreatesUser</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>As before, this will log a user in via CAS, confirm that it works, and then check in the database to make sure that the new user is properly created.</p><h3 id=testing-jwt>Testing JWT</h3><p>Now that we&rsquo;ve tested both ways to log into our application, we can write some tests to confirm that users can properly request a JWT to be used in our frontend later on. So, our first test simply checks to make sure a user with a valid session can request a token:</p><div class=tab-panel data-tab-group=3e369ea0c58edeb608f737383593bcb3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3e369ea0c58edeb608f737383593bcb3","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test user can request a valid token
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>userCanRequestToken</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should allow user &#34;</span> <span class=o>+</span> <span class=nx>user</span> <span class=o>+</span> <span class=s2>&#34; to request valid JWT&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>agent</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;token&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>decode</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>token</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>token</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;username&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>token</span><span class=p>.</span><span class=nx>username</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /token&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this test, we must use a persistent browser agent to make our requests. This will ensure that any cookies or other settings are saved between requests. Thankfully, the <a href=https://www.npmjs.com/package/supertest rel=external target=_blank>Supertest</a> library we are using already has that functionality, so all we have to do is create an <code>agent</code> for our testing as shown in the test above. Once we have successfully logged in, we can confirm that the <code>/auth/token</code> endpoint sends a valid JWT that contains information about the current user. For these tests, we are using bypass authentication for simplicity, but any authentication method could be used.</p><p>When we run the tests at the bottom of the file, notice that we are running this for all existing users, as well as a newly created user. Both types of users should be able to request a token for our application.</p><p>Next, let&rsquo;s confirm that all of a user&rsquo;s roles are listed in the JWT issued for that user. This is important because, later on in this example, we&rsquo;ll be using those roles to implement role-based authorization in our application, so it is vital to make sure our JWTs include the correct roles:</p><div class=tab-panel data-tab-group=9b42bb6d87c2837c4d5c48d36c87f7b7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9b42bb6d87c2837c4d5c48d36c87f7b7","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test user roles are correctly listed in token
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>userRolesAreCorrectInToken</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should contain correct roles for user &#34;</span> <span class=o>+</span> <span class=nx>user</span> <span class=o>+</span> <span class=s2>&#34; in JWT&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>agent</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;token&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>decode</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>token</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span>
</span></span><span class=line><span class=cl>              <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>              <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>              <span class=p>},</span>
</span></span><span class=line><span class=cl>              <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>user</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>if</span> <span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>length</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>token</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;roles&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>expect</span><span class=p>(</span><span class=nx>token</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>length</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>user</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>expected_role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nx>expect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=nx>token</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>role</span><span class=p>.</span><span class=nx>id</span> <span class=o>==</span> <span class=nx>expected_role</span><span class=p>.</span><span class=nx>id</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                  <span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>});</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>token</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>not</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;roles&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /token&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>userRolesAreCorrectInToken</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>userRolesAreCorrectInToken</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This test may seem very long and verbose, but it is very straightforward. We first login and request a token for a user, and then we also look up that user in the database including all associated roles. Then, we simply assert that the number of roles in the token is the same as the number of them in the database, and if there are any roles that each role is found as expected.</p><p>Finally, we should write one additional test, that simply confirms that the application will not allow anyone to request a token if they are not currently logged in:</p><div class=tab-panel data-tab-group=4726c45e7a4ef83c30c50ce20d395375><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4726c45e7a4ef83c30c50ce20d395375","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * User must have a valid session to request a token
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>mustBeLoggedInToRequestToken</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should not allow a user to request a token without logging in&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>401</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /token&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>userRolesAreCorrectInToken</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>userRolesAreCorrectInToken</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>mustBeLoggedInToRequestToken</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>For this test, we simply check that the application returns an HTTP 401 response if the user tries to request a token without first being logged in.</p><h3 id=testing-logout>Testing Logout</h3><p>Finally, we can write a few tests to make sure our logout process is also working as expected. The first test will confirm that the session cookie we are using is properly removed from the user&rsquo;s browser when they log out:</p><div class=tab-panel data-tab-group=a3c015bf134672c2f35c57bfd4410e50><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a3c015bf134672c2f35c57bfd4410e50","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Regular expression to match deleting the cookie
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>regex_destroy</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;^&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>  <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_NAME</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT$&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Logout will remove the cookie
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>logoutDestroysCookie</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should remove the cookie on logout&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re_destroy</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_destroy</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>agent</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/logout&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re_destroy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /logout&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutDestroysCookie</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this test, we are looking for a second <code>set-cookie</code> header to be sent when the user logs out. This header will both contain an empty cookie, but also will set the cookie&rsquo;s expiration date to the earliest date possible. So, we can simply look for that header to confirm our cookie is being properly removed and expired from the user&rsquo;s browser when they log out. We only really have to test this for a single username, since the process is identical for all of them.</p><p>Next, we should also confirm that the logout process will redirect users to the CAS server as well and log them out of any existing CAS sessions.</p><div class=tab-panel data-tab-group=0380144b4e10433ef5161554c8cd2318><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0380144b4e10433ef5161554c8cd2318","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Regular expression for redirecting to CAS
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>regex_redirect</span> <span class=o>=</span> <span class=s2>&#34;^&#34;</span> <span class=o>+</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_URL</span> <span class=o>+</span> <span class=s2>&#34;/logout\\?service=\\S*$&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Logout redirects to CAS
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>logoutRedirectsToCas</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should redirect to CAS on logout&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re_redirect</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_redirect</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>agent</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/logout&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=nx>re_redirect</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /logout&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutDestroysCookie</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutRedirectsToCas</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Once again, we are simply checking the <code>Location</code> header of the HTTP 302 Found response received from our application. We are making use of regular expressions to ensure we are being properly redirected to the correct CAS server and the <code>logout</code> route on that server.</p><p>Finally, we should confirm that once a user has logged out, they are no longer able to request a new token from the application:</p><div class=tab-panel data-tab-group=fc09c9dd85c6a99707d1017daaab782f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fc09c9dd85c6a99707d1017daaab782f","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Logout prevents requesting a token
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>logoutPreventsToken</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should prevent access to token after logging out&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>agent</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>agent</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/logout&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>agent</span>
</span></span><span class=line><span class=cl>                  <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                  <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>401</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                  <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                  <span class=p>});</span>
</span></span><span class=line><span class=cl>              <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /logout&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutDestroysCookie</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutRedirectsToCas</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutPreventsToken</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this test, we simply log in, request a token, then log out, and show that the application will no longer allow us to request a token, even though we are using the same user agent as before. This is a great way to confirm that our entire process is working!</p><p>Now is a great time to lint, format, and commit our code to GitHub before continuing!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=role-based-authorization>Role-Based Authorization</h1><a href="https://www.youtube.com/watch?v=KMiBMPzHRp8">YouTube Video</a><h2 id=token-middlewares>Token Middlewares</h2><p>Now that we finally have a working authentication system, we can start to add role-based authorization to our application. This will ensure that only users with specific roles can perform certain actions within our RESTful API. To do this, we&rsquo;ll need to create a couple of new Express middlewares to help load the contents of our JWT into the request, and also to verify that the authenticated user has the appropriate roles to perform an action.</p><p>First, let&rsquo;s create a middleware to handle loading our JWT from an authorization header into the Express request object:</p><div class=tab-panel data-tab-group=1e3ca41af6c9c517a292a2d54465b5cc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=middlewarestokenjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1e3ca41af6c9c517a292a2d54465b5cc","middlewarestokenjs")'>
<span class=tab-nav-text>middlewares/token.js</span></button></div><div class=tab-content-container><div data-tab-item=middlewarestokenjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Middleware for reading JWTs from the Bearer header and storing them in the request
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports tokenMiddleware the token middleware
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>jsonwebtoken</span> <span class=nx>from</span> <span class=s1>&#39;jsonwebtoken&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;../configs/logger.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>tokenMiddleware</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Retrieve the token from the headers
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>authHeader</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>headers</span><span class=p>[</span><span class=s1>&#39;authorization&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>authHeader</span> <span class=o>&amp;&amp;</span> <span class=nx>authHeader</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39; &#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// If the token is null in the header, send 401 unauthorized
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>token</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s1>&#39;JWT in header is null&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Verify the token
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>verify</span><span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>JWT_SECRET_KEY</span><span class=p>,</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>token</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Handle common errors
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=s1>&#39;TokenExpiredError&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If the token is expired, send 401 unauthorized 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If the token won&#39;t parse, send 403 forbidden
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&#34;JWT Parsing Error!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>sendStatus</span><span class=p>(</span><span class=mi>403</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Attach token to request
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>req</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=nx>token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Call next middleware
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>tokenMiddleware</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This middleware will extract our JWT from the <code>authorization: Bearer</code> header that should be present in any request from our frontend single-page web application to our API. It then checks that the signature matches the expected signature and that the payload of the JWT has not been tampered with. It also makes sure the JWT has not expired. If all of those checks pass, then it simply attaches the contents of the JWT to the Express request object as <code>req.token</code>, so we can use it later in our application.</p><p>To use this middleware, we need to make a small change to the structure of our <code>routes/api.js</code> file to allow users to access the base API route without needing the token, but all other routes will require a valid token for access:</p><div class=tab-panel data-tab-group=b285090e8615494ccdbd29a0b89ee6fe><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b285090e8615494ccdbd29a0b89ee6fe","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file API main router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: api
</span></span></span><span class=line><span class=cl><span class=cm> *   description: API routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import middleware
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>tokenMiddleware</span> <span class=nx>from</span> <span class=s2>&#34;../middlewares/token.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import v1 routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>rolesRouter</span> <span class=nx>from</span> <span class=s2>&#34;./api/v1/roles.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s2>&#34;./api/v1/users.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of API versions
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: list API versions
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [api]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of users
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: object
</span></span></span><span class=line><span class=cl><span class=cm> *                 properties:
</span></span></span><span class=line><span class=cl><span class=cm> *                   version:
</span></span></span><span class=line><span class=cl><span class=cm> *                     type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                   url:
</span></span></span><span class=line><span class=cl><span class=cm> *                     type: string
</span></span></span><span class=line><span class=cl><span class=cm> *             example:
</span></span></span><span class=line><span class=cl><span class=cm> *               - version: &#34;1.0&#34;
</span></span></span><span class=line><span class=cl><span class=cm> *                 url: /api/v1/
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v1/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Use Token Middleware
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>tokenMiddleware</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use v1 routers after API route
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/v1/roles&#34;</span><span class=p>,</span> <span class=nx>rolesRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/v1/users&#34;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Here, we import our new middleware, and then we rearrange the contents of the file so that the single <code>/api</code> route comes first, then we add our middleware and the rest of the API routes at the end of the file. Remember that everything in Express is executed in the order it is attached to the application, so in this way any routes that occur before our middleware is attached can be accessed without a valid JWT, but any routes or routers added afterward will require a valid JWT for access.</p><h2 id=role-middleware>Role Middleware</h2><p>Next, we can create another middleware function that will check if a user has the appropriate roles to perform an operation via our API. However, instead of writing a simple function as our middleware, or even writing a number of different functions for each possible role, we can take advantage of one of the most powerful features of JavaScript - we can create a function that <em>returns</em> another function! Let&rsquo;s take a look and see how it works:</p><div class=tab-panel data-tab-group=e155015c457e2b336fd22f204b19a77f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=middlewaresauthorized-rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e155015c457e2b336fd22f204b19a77f","middlewaresauthorized-rolesjs")'>
<span class=tab-nav-text>middlewares/authorized-roles.js</span></button></div><div class=tab-content-container><div data-tab-item=middlewaresauthorized-rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Middleware for role-based authorization
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports roleBasedAuth middleware
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Build a middleware function to validate a user has one of a list of roles
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param  {...any} roles a list of roles that are valid for this operation
</span></span></span><span class=line><span class=cl><span class=cm> * @returns a middleware function for those roles.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>roleBasedAuth</span> <span class=o>=</span> <span class=p>(...</span><span class=nx>roles</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kd>function</span> <span class=nx>roleAuthMiddleware</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Route requires roles: &#34;</span> <span class=o>+</span> <span class=nx>roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;User &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=nx>req</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34; has roles: &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=nx>req</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>role</span><span class=p>).</span><span class=nx>join</span><span class=p>(</span><span class=s2>&#34;,&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>match</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// loop through each role given
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// if the user has that role, then they can proceed
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>token</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>role</span> <span class=o>===</span> <span class=nx>role</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Role match!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>match</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>match</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// if no roles match, send an unauthenticated response
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;No role match!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>send</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>roleBasedAuth</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This file contains a function named <code>roleBasedAuth</code> that accepts a list of roles as parameters (they can be provided directly or as an array, but either way we can treat them like an array in our code). Then, we will <em>return</em> a new middleware function named <code>roleAuthMiddleware</code> that will check to see if the currently authenticated user (indicated by <code>req.token</code>) has at least one of the named roles. If so, then there is a match and the user should be able to perform the operation. If the user does not have any of the roles listed, then the user should not be able to perform the operation and a 401 Unauthorized response should be sent. This file also includes some helpful logging information to help ensure things are working properly.</p><h2 id=implementing-role-based-authorization>Implementing Role-Based Authorization</h2><p>Finally, let&rsquo;s look at how we can use that middleware function to implement role-based authorization in our application. Let&rsquo;s start simple - in this instance, we can update our <code>GET /api/v1/roles/</code> operation to require the user to have the <code>manage_users</code> role in order to list all possible roles in the application. To do this, we can import our new middleware function in the <code>routes/api/v1/roles.js</code> file, and then call that function to create a new middleware function to use in that file:</p><div class=tab-panel data-tab-group=0ce807fd5833a7d8d6f7265812372384><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0ce807fd5833a7d8d6f7265812372384","routesapiv1rolesjs")'>
<span class=tab-nav-text>routes/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Roles router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: roles
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Roles Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import middlewares
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>roleBasedAuth</span> <span class=nx>from</span> <span class=s2>&#34;../../../middlewares/authorized-roles.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of roles
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/v1/roles:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: roles list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all roles in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [roles]
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     security:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *       - bearerAuth:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         - &#39;manage_users&#39;
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of roles
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 $ref: &#39;#/components/schemas/Role&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nx>roleBasedAuth</span><span class=p>(</span><span class=s2>&#34;manage_users&#34;</span><span class=p>),</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>Role</span><span class=p>.</span><span class=nx>findAll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Notice here that we are calling the <code>roleBasedAuth</code> function when we add it to our endpoint, which in turn will return a new middleware function that will be called anytime this endpoint is accessed. It is a bit complicated and confusing at first, but hopefully it makes sense.</p><p>We also have added a new <code>security</code> item to our Open API documentation, which allows us to test this route by providing a JWT through the Open API documentation website. We can even include the specific roles that are able to access this endpoint, but as of this writing it is only part of the Open API 3.1 spec but is not supported by the <code>swagger-ui</code> library so it won&rsquo;t appear on our documentation page.</p><p>Let&rsquo;s test it now by starting our server in development mode:</p><div class=tab-panel data-tab-group=60004ceeb66c53a33723dbef0c81d254><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("60004ceeb66c53a33723dbef0c81d254","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once we have loaded our page, let&rsquo;s go ahead and log in as the <code>admin</code> user by navigating to <code>/auth/bypass?token=admin</code> - this will return us to our home page, but now we have an active session we can use.</p><p>Once we have done that, we can now go to the <code>/docs</code> route to view our documentation. We should now notice that there is a new <code>Authorize</code> button at the top of the page:</p><p><a href=#R-image-5103b372ab6f43ba2954de9c5f9b8f69 class=lightbox-link><img alt="OpenAPI Authorize" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_11.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5103b372ab6f43ba2954de9c5f9b8f69><img alt="OpenAPI Authorize" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_11.png></a></p><p>In addition, if we scroll down to find our <code>/api/v1/roles</code> route, we should also see that it now has a lock icon next to it, showing that it requires authentication before we can access it:</p><p><a href=#R-image-580073125348f075e622d252a63bfe3a class=lightbox-link><img alt="OpenAPI Protected Route" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_12.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-580073125348f075e622d252a63bfe3a><img alt="OpenAPI Protected Route" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_12.png></a></p><p>If we try to test that route now, even though we have a valid session cookie session, it should give us a 401 Unauthorized response because we aren&rsquo;t providing a valid JWT as part of our request:</p><p><a href=#R-image-6e158a28c2ceb6ed0ef1301105046458 class=lightbox-link><img alt="Unauthorized Response" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_13.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6e158a28c2ceb6ed0ef1301105046458><img alt="Unauthorized Response" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_13.png></a></p><p>To fix this, we need to authorize our application using a valid JWT. Thankfully, we can request one by finding the <code>/auth/token</code> route in our documentation and executing that route:</p><p><a href=#R-image-1588e5914ef4d50cbf53c5277e0149ef class=lightbox-link><img alt="Requesting JWT" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_14.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1588e5914ef4d50cbf53c5277e0149ef><img alt="Requesting JWT" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_14.png></a></p><p>Once we have that, we can click the new Authorize button at the top, and paste the text of that token in the window that pops up. We just need the raw part of the JWT in quotes that is the value of the <code>token</code> property, without the quotes themselves included:</p><p><a href=#R-image-078296bf3a96f84803edf59e9c0549c0 class=lightbox-link><img alt="Authorizing with JWT" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_15.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-078296bf3a96f84803edf59e9c0549c0><img alt="Authorizing with JWT" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_15.png></a></p><p>Finally, once that has been done, we can try the <code>/api/v1/roles</code> route again, and it should now let us access that route:</p><p><a href=#R-image-fb8e5c07e0efec32a55198625830d0bc class=lightbox-link><img alt="Working Request" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_16.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fb8e5c07e0efec32a55198625830d0bc><img alt="Working Request" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_16.png></a></p><p>We can also see that it is properly using our role-based authorization by checking the debug output of our application:</p><div class=tab-panel data-tab-group=6b0ba6182227c98e36a4afc53164e865><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6b0ba6182227c98e36a4afc53164e865","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[2025-03-21 12:54:14.085 AM] debug:     Route requires roles: manage_users
[2025-03-21 12:54:14.085 AM] debug:     User admin has roles: manage_users,manage_documents,manage_communities
[2025-03-21 12:54:14.086 AM] debug:     Role match!
[2025-03-21 12:54:14.087 AM] sql:       Executing (default): SELECT `id`, `role`, `createdAt`, `updatedAt` FROM `roles` AS `Role`;
[2025-03-21 12:54:14.090 AM] http:      GET /api/v1/roles 200 9.553 ms - 784</code></pre></div></div></div></div></div><p>There we go! That is all it takes to add role-based authorization to our application. Next, we&rsquo;ll look at how to update our unit tests to use our new authentication system and roles.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=updating-tests>Updating Tests</h1><a href="https://www.youtube.com/watch?v=k43QEMKxO9Y">YouTube Video</a><h2 id=updating-unit-tests>Updating Unit Tests</h2><p>Of course, now that we&rsquo;re requiring a valid JWT for all API routes, and adding role-based authorization for most routes, all of our existing API unit tests now longer work. So, let&rsquo;s work on updating those tests to use our new authentication system.</p><p>First, let&rsquo;s build a simple helper function we can use to easily log in as a user and request a token to use in our application. We&rsquo;ll place this in a new file named <code>test/helpers.js</code>:</p><div class=tab-panel data-tab-group=94820aa41346de4952458d1cf77c3637><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("94820aa41346de4952458d1cf77c3637","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Unit Test Helpers
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>login</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>agent</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>).</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div></div></div></div><p>This file is pretty straightforward - it simply uses the bypass login system to authenticate as a user, then it requests a token and returns it. It assumes that all other parts of the authentication process work properly - we can do this because we already have unit tests to check that functionality.</p><p>Now, let&rsquo;s use this in our <code>test/api/v1/roles.js</code> file by adding a few new lines to each test. We&rsquo;ll start with the simple <code>getAllRoles</code> test:</p><div class=tab-panel data-tab-group=5ed1263fe5b0c2ca47ba88b847a7a15a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5ed1263fe5b0c2ca47ba88b847a7a15a","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api/v1/roles Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Ajv</span> <span class=nx>from</span> <span class=s2>&#34;ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>addFormats</span> <span class=nx>from</span> <span class=s2>&#34;ajv-formats&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../../../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import Helpers
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>login</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../helpers.js&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Configure Chai and AJV
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>ajv</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Ajv</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>addFormats</span><span class=p>(</span><span class=nx>ajv</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiJsonSchemaAjv</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>ajv</span><span class=p>,</span> <span class=nx>verbose</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiShallowDeepEqual</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Modify Object.prototype for BDD style assertions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>should</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all Roles
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>getAllRoles</span> <span class=o>=</span> <span class=p>(</span><span class=nx>state</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should list all roles&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;Authorization&#39;</span><span class=p>,</span> <span class=sb>`Bearer </span><span class=si>${</span><span class=nx>state</span><span class=p>.</span><span class=nx>token</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/roles route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=kd>let</span> <span class=nx>state</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>    <span class=nx>beforeEach</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>state</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>login</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>    <span class=nx>getAllRoles</span><span class=p>(</span><span class=nx>state</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>To update this test, we have created a new <code>state</code> object that is present in our <code>describe</code> block at the bottom of the test. That <code>state</code> object can store various things we&rsquo;ll use in our tests, but for now we&rsquo;ll just use it to store a valid JWT for our application. Then, in a <code>beforeEach</code> <a href=https://mochajs.org/#hooks rel=external target=_blank>Mocha hook</a>, we use the <code>login</code> helper we created earlier to log in as the &ldquo;admin&rdquo; user and store a valid JWT for that user in the <code>state.token</code> property.</p><p>Then, we pass that <code>state</code> object to the <code>getAllRoles</code> test. Inside of that test, we use the <code>state.token</code> property to set an <code>Authorization: Bearer</code> header for our request to the API. If everything works correctly, this test should now pass.</p><p>We can make similar updates to the other tests in this file:</p><div class=tab-panel data-tab-group=1b747bd749cd0cc047544e5b7ae876e7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1b747bd749cd0cc047544e5b7ae876e7","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check JSON Schema of Roles
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>getRolesSchemaMatch</span> <span class=o>=</span> <span class=p>(</span><span class=nx>state</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;all roles should match schema&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>schema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;array&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>items</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>required</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>properties</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>id</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;number&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>role</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;iso-date-time&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;iso-date-time&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>additionalProperties</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;Authorization&#39;</span><span class=p>,</span> <span class=sb>`Bearer </span><span class=si>${</span><span class=nx>state</span><span class=p>.</span><span class=nx>token</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>jsonSchema</span><span class=p>(</span><span class=nx>schema</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check Role exists in list
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>findRole</span> <span class=o>=</span> <span class=p>(</span><span class=nx>state</span><span class=p>,</span> <span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should contain &#39;&#34;</span> <span class=o>+</span> <span class=nx>role</span><span class=p>.</span><span class=nx>role</span> <span class=o>+</span> <span class=s2>&#34;&#39; role&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;Authorization&#39;</span><span class=p>,</span> <span class=sb>`Bearer </span><span class=si>${</span><span class=nx>state</span><span class=p>.</span><span class=nx>token</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>foundRole</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>role</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>foundRole</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>role</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/roles route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>state</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>beforeEach</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>state</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>login</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>getAllRoles</span><span class=p>(</span><span class=nx>state</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>getRolesSchemaMatch</span><span class=p>(</span><span class=nx>state</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>findRole</span><span class=p>(</span><span class=nx>state</span><span class=p>,</span> <span class=nx>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This will ensure that each RESTful API action will work properly with an authenticated user, but it doesn&rsquo;t test whether the user has the proper role to perform the action (in this instance, we are using the <code>admin</code> user which has the appropriate role already). On the next page, we&rsquo;ll build a very flexible system to perform unit testing on our role-based authorization middleware.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=testing-roles>Testing Roles</h1><a href="https://www.youtube.com/watch?v=lolT-mwmFvc">YouTube Video</a><h2 id=testing-role-based-authorization-middleware>Testing Role-Based Authorization Middleware</h2><p>Earlier in this example we created a generator function named <code>roleBasedAuth</code> (stored in <code>middlewares/authorized-roles.js</code>) that returns a middleware function named <code>roleAuthMiddleware</code> that we can use as a middleware in any of our RESTful API endpoints to ensure that only users with specific roles are able to perform each and every action in our API.</p><p>When it comes to testing, however, this can quickly become really complex. For example, if we have 15 routes and 6 user roles, we must write 120 tests just to test each combination of route and role in order to truly test this setup.</p><p>In addition, if we continue to use our current strategy of integration testing (where each test performs a full action on the API), the tests we write will need to be unique for each endpoint, so even if we simplify things, we&rsquo;ll still need at least 2 tests per endpoint (one for roles that should have access, and another for roles that should not).</p><p>Instead, let&rsquo;s look at a way we can deconstruct our Express application a bit to test two things directly:</p><ol><li>Is the <code>roleAuthMiddleware</code> present on each route?</li><li>Does the <code>roleAuthMiddleware</code> function allow the correct roles for each route?</li></ol><p>If we can confirm both of these for each route, we can assume that our role-based authorization is implemented correctly.</p><h2 id=express-route-stack>Express Route Stack</h2><p>As you may recall, applications written in Express consist of an application that has middlewares and handlers attached in a specific order. In addition, we can create smaller components called routers that each have their own middlewares and handlers attached. Overall, we may end up with a structure similar to this one:</p><p><a href=#R-image-6902034070c2efdaf351ab5dbd20d768 class=lightbox-link><img alt="Express Architecture" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/express-routing-http.svg style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6902034070c2efdaf351ab5dbd20d768><img alt="Express Architecture" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/express-routing-http.svg></a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>A more detailed explanation of the structure of Express applications can be found here: <a href=https://www.sohamkamani.com/nodejs/expressjs-architecture/ rel=external target=_blank>https://www.sohamkamani.com/nodejs/expressjs-architecture/</a></p><p>In code, each Express router has a <code>stack</code> variable that contains a list of layers, which can either be middleware functions or actual route handlers. Middleware layers will contain the <code>name</code> of the middleware function, whereas route handlers can be checked using a <code>match</code> function to determine if the handler matches a given path.</p><p>So, in our <code>test/helpers.js</code> file, we can write a new helper function to this for our tests:</p><div class=tab-panel data-tab-group=73acfb3ccfc4557a9b7431d7e8ecdf14><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("73acfb3ccfc4557a9b7431d7e8ecdf14","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Iterate through the router stack of an Express app to find a matching middleware function
</span></span></span><span class=line><span class=cl><span class=cm> * attached to a particular path and/or method
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} name the name of the function to find
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} path the path of the endpoint
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} method the HTTP method of the endpoint
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Router} router The Express router to search
</span></span></span><span class=line><span class=cl><span class=cm> * @returns
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>findMiddlewareFunction</span> <span class=o>=</span> <span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>app</span><span class=p>.</span><span class=nx>_router</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>layer</span> <span class=k>of</span> <span class=nx>router</span><span class=p>.</span><span class=nx>stack</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Return if the middleware function is found
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>layer</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>layer</span><span class=p>.</span><span class=nx>handle</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>layer</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=nx>path</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Recurse into a router
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>layer</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=s2>&#34;router&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>layer</span><span class=p>.</span><span class=nx>path</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Remove matching portion of path
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>path</span> <span class=o>=</span> <span class=nx>path</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=nx>layer</span><span class=p>.</span><span class=nx>path</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>findMiddlewareFunction</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>layer</span><span class=p>.</span><span class=nx>handle</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find matching handler
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>layer</span><span class=p>.</span><span class=nx>route</span> <span class=o>&amp;&amp;</span> <span class=nx>layer</span><span class=p>.</span><span class=nx>route</span><span class=p>.</span><span class=nx>methods</span><span class=p>[</span><span class=nx>method</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>findMiddlewareFunction</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>layer</span><span class=p>.</span><span class=nx>route</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Using that function, we can now write another function to actually test our middleware using some mock objects:</p><div class=tab-panel data-tab-group=fcbec3f0432ff8c12372c640dd36159a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fcbec3f0432ff8c12372c640dd36159a","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>expect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>sinon</span> <span class=nx>from</span> <span class=s2>&#34;sinon&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test if a role is able to access the route via the roleAuthMiddleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} path the path of the endpoint
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} method the HTTP method of the endpoint
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} role the role to search for
</span></span></span><span class=line><span class=cl><span class=cm> * @param {boolean} allowed whether the role should be allowed to access the route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>testRoleBasedAuth</span> <span class=o>=</span> <span class=p>(</span><span class=nx>path</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=nx>role</span><span class=p>,</span> <span class=nx>allowed</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;should role &#39;&#34;</span> <span class=o>+</span> <span class=nx>role</span> <span class=o>+</span> <span class=s2>&#34;&#39; access &#39;&#34;</span> <span class=o>+</span> <span class=nx>method</span> <span class=o>+</span> <span class=s2>&#34; &#34;</span> <span class=o>+</span> <span class=nx>path</span> <span class=o>+</span> <span class=s2>&#34;&#39;: &#34;</span> <span class=o>+</span> <span class=nx>allowed</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Mock Express Request object with token attached
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>req</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>token</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;test&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>role</span><span class=o>:</span> <span class=nx>role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Mock Express Response object
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>status</span><span class=o>:</span> <span class=nx>sinon</span><span class=p>.</span><span class=nx>stub</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>send</span><span class=o>:</span> <span class=nx>sinon</span><span class=p>.</span><span class=nx>stub</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>.</span><span class=nx>returns</span><span class=p>(</span><span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Mock Express Next Middleware function
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>next</span> <span class=o>=</span> <span class=nx>sinon</span><span class=p>.</span><span class=nx>stub</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Find the middleware function in the router stack for the given path and method
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>middleware</span> <span class=o>=</span> <span class=nx>findMiddlewareFunction</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;roleAuthMiddleware&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>expect</span><span class=p>(</span><span class=nx>middleware</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>not</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Call the middleware function
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>middleware</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>allowed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If allowed, expect the `next` function to be called
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>expect</span><span class=p>(</span><span class=nx>next</span><span class=p>.</span><span class=nx>calledOnce</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Otherwise, it should send a 401 response
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>.</span><span class=nx>calledWith</span><span class=p>(</span><span class=mi>401</span><span class=p>)).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div></div></div></div><p>The comments in the function describe how it works pretty clearly. Most of the code is just setting up barebones mock objects using <a href=https://sinonjs.org/ rel=external target=_blank>Sinon</a> for the Express request <code>req</code>, response <code>res</code>, and <code>next</code> middleware function. Once it finds our <code>roleAuthMiddleware</code> function in the router stack using the helper function above, it will call it and observe the response to determine if the user was allowed to access the desired endpoint or not.</p><p>The last thing we&rsquo;ll add to our <code>test/helpers.js</code> file is a helpful list of all of the roles available in the application, which we can use for our testing:</p><div class=tab-panel data-tab-group=23d427744651bb63e9bc1f9871eec4c9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("23d427744651bb63e9bc1f9871eec4c9","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// List of global roles
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>all_roles</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;manage_users&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;manage_documents&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;add_documents&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;manage_communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;add_communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;view_documents&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;view_communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>];</span></span></span></code></pre></div></div></div></div></div><p>With those helpers in place, we can now add a few lines to our <code>test/api/v1/roles.js</code> test file to check whether each and every role can access the endpoint in that router.</p><div class=tab-panel data-tab-group=8ea5337591e8d8d417f21319fd3f25de><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8ea5337591e8d8d417f21319fd3f25de","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import Helpers
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>login</span><span class=p>,</span> <span class=nx>testRoleBasedAuth</span><span class=p>,</span> <span class=nx>all_roles</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../helpers.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/roles route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=s2>&#34;get&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This code does a couple of very nifty things. First, we clearly define which roles should be allowed to access the endpoint. This can be done as part of the unit testing file here, or we may have some global file in our test suite that documents each role and route that we can read from.</p><p>Below that, we iterate through the list of all roles exported from the <code>test/helpers.js</code> file, and call our <code>testRoleBasedAuth</code> method for each one of those roles. The last argument to that function is a boolean that determines whether the role should be able to access this route. To determine that, we simply see if the role from the list of global roles can also be found in the list of allowed roles. If so, that will be <code>true</code> and the function will check that the role can access the route. If not, it will be <code>false</code> and the function will confirm that the user is unable to access the route.</p><p>Now, when we run these tests, we&rsquo;ll see that each role is explicitly checked:</p><div class=tab-panel data-tab-group=8ed88583a96c7e85ae2b14bf2fc344ee><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8ed88583a96c7e85ae2b14bf2fc344ee","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api/v1/roles
    GET /
      âœ” should list all roles
      âœ” all roles should match schema
      âœ” should contain &#39;manage_users&#39; role
      âœ” should contain &#39;manage_documents&#39; role
      âœ” should contain &#39;add_documents&#39; role
      âœ” should contain &#39;manage_communities&#39; role
      âœ” should contain &#39;add_communities&#39; role
      âœ” should contain &#39;view_documents&#39; role
      âœ” should contain &#39;view_communities&#39; role
      âœ” should role &#39;manage_users&#39; access &#39;get /api/v1/roles&#39;: true
      âœ” should role &#39;manage_documents&#39; access &#39;get /api/v1/roles&#39;: false
      âœ” should role &#39;add_documents&#39; access &#39;get /api/v1/roles&#39;: false
      âœ” should role &#39;manage_communities&#39; access &#39;get /api/v1/roles&#39;: false
      âœ” should role &#39;add_communities&#39; access &#39;get /api/v1/roles&#39;: false
      âœ” should role &#39;view_documents&#39; access &#39;get /api/v1/roles&#39;: false
      âœ” should role &#39;view_communities&#39; access &#39;get /api/v1/roles&#39;: false</code></pre></div></div></div></div></div><p>There we go! We now have a very flexible way to test our role-based authorization.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Image Source: <a href=https://www.sohamkamani.com/nodejs/expressjs-architecture/ rel=external target=_blank>https://www.sohamkamani.com/nodejs/expressjs-architecture/</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=users-api-updates>Users API Updates</h1><a href="https://www.youtube.com/watch?v=9aIS1mF5J-Y">YouTube Video</a><h2 id=users-api-roles>Users API Roles</h2><p>We should also add our role-based authorization middleware to our <code>/api/v1/users</code> routes. This can actually be done really simply, because we only want users with the <code>manage_users</code> role to be able to access any of these routes.</p><p>So, instead of attaching the middleware to each handler individually, we can attach it directly to the router before any handlers:</p><div class=tab-panel data-tab-group=66d4dedf6121b0c2ce42c59e8d89bdf9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("66d4dedf6121b0c2ce42c59e8d89bdf9","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: users
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Users Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ValidationError</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;sequelize&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import middlewares
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>roleBasedAuth</span> <span class=nx>from</span> <span class=s2>&#34;../../../middlewares/authorized-roles.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import utilities
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>handleValidationError</span> <span class=nx>from</span> <span class=s2>&#34;../../../utilities/handle-validation-error.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>sendSuccess</span> <span class=nx>from</span> <span class=s2>&#34;../../../utilities/send-success.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Add Role Authorization to all routes
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>roleBasedAuth</span><span class=p>(</span><span class=s2>&#34;manage_users&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>That&rsquo;s all it takes to add role-based authorization to an entire router! It is really simple.</p><p>We also should remember to add the new <code>security</code> section to our Open API documentation comments for each route to ensure that our documentation properly displays that each route requires authentication.</p><h2 id=users-api-unit-tests---authentication>Users API Unit Tests - Authentication</h2><p>As part of our updates, we need to add authentication to each of our unit tests for the <code>/api/v1/users</code> routes. This is relatively straightforward based on what we did in the previous page - it just requires a few tweaks per test.</p><p>In short, we need to add a <code>state</code> variable that we can use that contains a token for a user, and then pass that along to each test. We can do this in the global <code>describe</code> section at the bottom:</p><div class=tab-panel data-tab-group=b697ac8ad77beba0cb1f2ed12c9cf9f0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b697ac8ad77beba0cb1f2ed12c9cf9f0","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api/v1/users Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span><span class=p>,</span> <span class=nx>expect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Ajv</span> <span class=nx>from</span> <span class=s2>&#34;ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>addFormats</span> <span class=nx>from</span> <span class=s2>&#34;ajv-formats&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../../../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import Helpers
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>login</span><span class=p>,</span> <span class=nx>testRoleBasedAuth</span><span class=p>,</span> <span class=nx>all_roles</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../helpers.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=kd>let</span> <span class=nx>state</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>  <span class=nx>beforeEach</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>state</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>login</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Notice that we are able to add that code outside of the <code>describe</code> sections for each API endpoint, greatly simplifying things. Of course, if we need to log in as multiple users, we can either add additional tokens to the <code>state</code> or move the <code>state</code> and <code>beforeEach</code> methods to other locations in the code.</p><p>Once we have our state, we can simply pass it on to the tests and update each test to use it correctly by setting an <code>Authorization: Bearer</code> header on each request:</p><div class=tab-panel data-tab-group=43efb67a6a11272ed941f59f02875d6c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("43efb67a6a11272ed941f59f02875d6c","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all Users
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>getAllUsers</span> <span class=o>=</span> <span class=p>(</span><span class=nx>state</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should list all users&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s2>&#34;Authorization&#34;</span><span class=p>,</span> <span class=sb>`Bearer </span><span class=si>${</span><span class=nx>state</span><span class=p>.</span><span class=nx>token</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>state</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>beforeEach</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>state</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>login</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>getAllUsers</span><span class=p>(</span><span class=nx>state</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>We won&rsquo;t exhaustively show each update to these tests here since there are so many. Take the time now to update all of the <code>/api/v1/users</code> unit tests to include authentication before continuing. They should all pass once authentication is enabled.</p><h2 id=users-api-unit-tests---role-based-authorization>Users API Unit Tests - Role-Based Authorization</h2><p>Finally, we should add additional unit tests to ensure that each endpoint in the <code>/api/v1/users</code> router is accessible only by users with the correct role. For that, we can simply add a block of code similar to what we did in the <code>roles</code> routes for each endpoint:</p><div class=tab-panel data-tab-group=93d0d0fc895d91584edcd9d2248a42d6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("93d0d0fc895d91584edcd9d2248a42d6","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>state</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>beforeEach</span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>state</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>login</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=s2>&#34;get&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/1&#34;</span><span class=p>,</span> <span class=s2>&#34;get&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;POST /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=s2>&#34;post&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;PUT /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/1&#34;</span><span class=p>,</span> <span class=s2>&#34;put&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;DELETE /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>allowed_roles</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>];</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>all_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>testRoleBasedAuth</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/1&#34;</span><span class=p>,</span> <span class=s2>&#34;delete&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>allowed_roles</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>r</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>All told, there should now be 88 total unit test in that file alone - that is a lot of tests for just 5 API endpoints!</p><p>Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub.</p><p>That concludes the first set of tutorials for building a RESTful API. In the next set of tutorials, we&rsquo;ll focus on building a Vue.js frontend for our application.</p><footer class=footline></footer></article></section></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/9d17f14bd7a7482467dc164e303870bb55f4ef70>Mar 4, 2025</a></p></div></div><script src=/cis526/js/clipboard.min.js?1745614603 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1745614603 defer></script><script src=/cis526/js/theme.js?1745614603 defer></script></body></html>
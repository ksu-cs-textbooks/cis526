<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.
Project Deliverables At the end of this example, we will have a project with the following features:
An authentication system using Passport.js and CAS Valid JSON Web Tokens (JWTs) for authentication within the RESTful API Proper middleware to verify users have the correct role for each operation in the API Prior Work This project picks up right where the last one left off, so if you haven’t completed that one yet, go back and do that before starting this one."><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Authentication :: CIS 526 Textbook"><meta name=twitter:description content="This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.
Project Deliverables At the end of this example, we will have a project with the following features:
An authentication system using Passport.js and CAS Valid JSON Web Tokens (JWTs) for authentication within the RESTful API Proper middleware to verify users have the correct role for each operation in the API Prior Work This project picks up right where the last one left off, so if you haven’t completed that one yet, go back and do that before starting this one."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Authentication :: CIS 526 Textbook"><meta property="og:description" content="This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.
Project Deliverables At the end of this example, we will have a project with the following features:
An authentication system using Passport.js and CAS Valid JSON Web Tokens (JWTs) for authentication within the RESTful API Proper middleware to verify users have the correct role for each operation in the API Prior Work This project picks up right where the last one left off, so if you haven’t completed that one yet, go back and do that before starting this one."><meta property="og:locale" content="en-us"><meta property="og:type" content="website"><meta itemprop=name content="Authentication :: CIS 526 Textbook"><meta itemprop=description content="This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.
Project Deliverables At the end of this example, we will have a project with the following features:
An authentication system using Passport.js and CAS Valid JSON Web Tokens (JWTs) for authentication within the RESTful API Proper middleware to verify users have the correct role for each operation in the API Prior Work This project picks up right where the last one left off, so if you haven’t completed that one yet, go back and do that before starting this one."><meta itemprop=dateModified content="2025-03-04T21:42:32-06:00"><meta itemprop=wordCount content="122"><title>Authentication :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/ rel=canonical type=text/html title="Authentication :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/index.xml rel=alternate type=application/rss+xml title="Authentication :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/tele.html rel=alternate type=text/html title="Authentication :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/embed.html rel=alternate type=text/html title="Authentication :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1741711031 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1741711031 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1741711031 rel=stylesheet><link href=/cis526/css/auto-complete.css?1741711031 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1741711031 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1741711031 rel=stylesheet><link href=/cis526/css/fonts.css?1741711031 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1741711031 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1741711031 rel=stylesheet><link href=/cis526/css/theme-auto.css?1741711031 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1741711031 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1741711031 rel=stylesheet><link href=/cis526/css/print.css?1741711031 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1741711031 rel=stylesheet><script src=/cis526/js/variant.js?1741711031></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../..",window.relearn.relBaseUri="../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1741711031 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/x-examples/04-authentication/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/cis526/x-examples/><span itemprop=name>Example Projects</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Authentication</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/03-rest-api/11-delete/ title="Delete (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/04-authentication/01-bypass/ title="Bypass Auth (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=authentication>Authentication</h1><p>This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li>An authentication system using <a href=https://www.passportjs.org/ rel=external target=_blank>Passport.js</a> and <a href=https://apereo.github.io/cas/7.1.x/index.html rel=external target=_blank>CAS</a></li><li>Valid JSON Web Tokens (JWTs) for authentication within the RESTful API</li><li>Proper middleware to verify users have the correct role for each operation in the API</li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Authentication</h1><article class=default><header class=headline></header><h1 id=bypass-auth>Bypass Auth</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=authentication-libraries>Authentication Libraries</h2><p>There are many different authentication libraries and methods available for Node.js and Express. For this project, we will use the <a href=https://www.passportjs.org/ rel=external target=_blank>Passport.js</a> library. It supports many different authentication strategy, and is a very common way that authentication is handled within JavaScript applications.</p><p>For our application, we&rsquo;ll end up using several strategies to authenticate our users:</p><ul><li><a href=https://www.passportjs.org/packages/passport-unique-token/ rel=external target=_blank>Unique Token</a> - used to bypass authentication for testing</li><li><a href=https://github.com/appdevdesigns/passport-cas rel=external target=_blank>CAS</a> - used to authenticate with <a href=https://apereo.github.io/cas/7.1.x/index.html rel=external target=_blank>Central Authentication Service (CAS)</a> servers such as those used at K-State</li><li><a href=https://www.passportjs.org/packages/passport-jwt-cookiecombo/ rel=external target=_blank>JSON Web Tokens (JWT)</a> - used to identify user requests to the API itself</li></ul><p>Let&rsquo;s first set up our unique token strategy, which allows us to test our authentication routes before setting up anything else.</p><h2 id=authentication-router>Authentication Router</h2><p>First, we&rsquo;ll need to create a new route file at <code>routes/auth.js</code> to contain our authentication routes. We&rsquo;ll start with this basic structure and work on filling in each method as we go.</p><div class=tab-panel data-tab-group=c9276a3e1747263521ee0f0d27826f54><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c9276a3e1747263521ee0f0d27826f54","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Auth router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: auth
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Authentication Routes
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   responses:
</span></span></span><span class=line><span class=cl><span class=cm> *     AuthToken:
</span></span></span><span class=line><span class=cl><span class=cm> *       description: authentication success
</span></span></span><span class=line><span class=cl><span class=cm> *       content:
</span></span></span><span class=line><span class=cl><span class=cm> *         application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *           schema:
</span></span></span><span class=line><span class=cl><span class=cm> *             type: object
</span></span></span><span class=line><span class=cl><span class=cm> *             required:
</span></span></span><span class=line><span class=cl><span class=cm> *               - token
</span></span></span><span class=line><span class=cl><span class=cm> *             properties:
</span></span></span><span class=line><span class=cl><span class=cm> *               token:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                 description: a JWT for the user
</span></span></span><span class=line><span class=cl><span class=cm> *             example:
</span></span></span><span class=line><span class=cl><span class=cm> *               token: abcdefg12345
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;../configs/auth.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Authentication Response Handler
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>authSuccess</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Bypass authentication for testing
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/bypass:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: bypass authentication for testing
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Bypasses CAS authentication for testing purposes
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     parameters:
</span></span></span><span class=line><span class=cl><span class=cm> *       - in: query
</span></span></span><span class=line><span class=cl><span class=cm> *         name: token
</span></span></span><span class=line><span class=cl><span class=cm> *         required: true
</span></span></span><span class=line><span class=cl><span class=cm> *         schema:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *         description: username
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/bypass&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * CAS Authentication
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/cas:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: CAS authentication
</span></span></span><span class=line><span class=cl><span class=cm> *     description:  CAS authentication for deployment
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/cas&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Request JWT based on previous authentication
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/token:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: request JWT 
</span></span></span><span class=line><span class=cl><span class=cm> *     description: request JWT based on previous authentication
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         $ref: &#39;#/components/responses/AuthToken&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/token&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This file includes a few items to take note of:</p><ul><li>In the top-level Open API comment, we define a new <code>AuthToken</code> response that we&rsquo;ll send to the user when they request a token.</li><li>We create three routes. The first two, <code>/auth/bypass</code> and <code>/auth/cas</code>, for each of our authentication strategies. The last one, <code>/auth/token</code> will be used by our frontend to request a token to access the API.</li><li>Finally, we&rsquo;ll build a <code>authSuccess</code> function to handle actually sending the response to the user</li></ul><p>Before moving on, let&rsquo;s go ahead and add this router to our <code>app.js</code> file along with the other routers:</p><div class=tab-panel data-tab-group=ff98b3ff831ec92321287748c333fcdb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ff98b3ff831ec92321287748c333fcdb","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/index.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>apiRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/api.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>authRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/auth.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Use routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/api&#34;</span><span class=p>,</span> <span class=nx>apiRouter</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=nx>authRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll come back to this file once we are ready to link up our authentication strategies.</p><h2 id=unique-token-authentication>Unique Token Authentication</h2><p>Next, let&rsquo;s install both <code>passport</code> and the <code>passport-unique-token</code> authentication strategy:</p><div class=tab-panel data-tab-group=2f064ec29f443f8d04d4a9611156ac87><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2f064ec29f443f8d04d4a9611156ac87","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ passport passport-unique-token</span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll configure that strategy in a new <code>configs/auth.js</code> file with the following content:</p><div class=tab-panel data-tab-group=de77785b6b92a2c19f7cdc987c44c55e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("de77785b6b92a2c19f7cdc987c44c55e","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Passport.js Authentication
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UniqueTokenStrategy</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;passport-unique-token&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Authenticate a user
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} username the username to authenticate
</span></span></span><span class=line><span class=cl><span class=cm> * @param {function} next the next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>authenticateUser</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Find user with the username
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span> 
</span></span><span class=line><span class=cl>    <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>username</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// User not found
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span> <span class=o>===</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Login failed for user: &#34;</span> <span class=o>+</span> <span class=nx>username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// User authenticated
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Login succeeded for user: &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Convert Sequelize object to plain JavaScript object
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>user</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>user</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Bypass Authentication via Token
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=k>new</span> <span class=nx>UniqueTokenStrategy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=c1>// verify callback function
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>authenticateUser</span><span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Default functions to serialize and deserialize a session
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>serializeUser</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>done</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>passport</span><span class=p>.</span><span class=nx>deserializeUser</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>done</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this file, we created an <code>authenticateUser</code> function that will look for a user based on a given username. If found, it will return that user by calling the <code>next</code> middleware function. Otherwise, it will call that function and provide <code>false</code>.</p><p>Below, we configure Passport.js using the <code>passport.use</code> function to define the various authentication strategies we want to use. In this case, we&rsquo;ll start with the <a href=https://www.passportjs.org/packages/passport-unique-token/ rel=external target=_blank>Unique Token Strategy</a>, which uses a token provided as part of a query to the web server.</p><p>In addition, we need to implement some default functions to handle serializing and deserializing a user from a session. These functions don&rsquo;t really have any content in our implementation; we just need to include the default code.</p><p>Finally, since Passport.js acts as a global object, we don&rsquo;t even have to export anything from this file!</p><h2 id=testing-authentication>Testing Authentication</h2><p>To test this authentication strategy, let&rsquo;s modify <code>routes/auth.js</code> to use this strategy. We&rsquo;ll update the <code>/auth/bypass</code> route and also add some temporary code to the <code>authSuccess</code> function:</p><div class=tab-panel data-tab-group=4d3e8cc8b46933cf240118b71ce8d621><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4d3e8cc8b46933cf240118b71ce8d621","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import configurations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;../configs/auth.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>authSuccess</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/bypass&#34;</span><span class=p>,</span> <span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>,</span> <span class=p>{</span><span class=nx>session</span><span class=o>:</span> <span class=kc>false</span><span class=p>}),</span> <span class=nx>authSuccess</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>In the <code>authSuccess</code> function, right now we are just sending the content of <code>req.user</code>, which is set by Passport.js on a successful authentication (it is the value we returned when calling the <code>next</code> function in our authentication strategy earlier). We&rsquo;ll come back to this later when we implement JSON Web Tokens (JWT) later in this tutorial.</p><p>The other major change is that now the <code>/auth/bypass</code> route calls the <code>passport.authenticate</code> method with the <code>'token'</code> strategy specified. It also uses <code>{session: false}</code> as one of the options provided to Passport.js since we aren&rsquo;t actually going to be using sessions. Finally, if that middleware is satisfied, it will call the <code>authSuccess</code> function to handle sending the response to the user. This takes advantage of the chaining that we can do in Express!</p><p>With all of that in place, we can test our server and see if it works:</p><div class=tab-panel data-tab-group=1f306b0ed36ac28b50b3ed6dee3b06da><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1f306b0ed36ac28b50b3ed6dee3b06da","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once the page loads, we want to navigate to the <code>/auth/bypass?token=admin</code> path to see if we can log in as the <code>admin</code> user. Notice that we are including a query parameter named <code>token</code> to include the username in the URL.</p><p><a href=#R-image-dd40e25904e3a0803004bd4e65b5038c class=lightbox-link><img alt="Successful Authentication" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-dd40e25904e3a0803004bd4e65b5038c><img alt="Successful Authentication" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_1.png></a></p><p>There we go! We see that it successfully finds our <code>admin</code> user and returns data about that user, including the roles assigned. This is what we want to see. We can also test this by providing other usernames to make sure it is working.</p><h2 id=securing-authentication>Securing Authentication</h2><p>Of course, we don&rsquo;t want to have this bypass authentication system available all the time in our application. In fact, we really only want to use it for testing and debugging; otherwise, our application will have a major security flaw! So, let&rsquo;s add a new environment variable <code>BYPASS_AUTH</code> to our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. We should set it to <code>TRUE</code> in the <code>.env.test</code> file, and for now we&rsquo;ll have it enabled in our <code>.env</code> file as well, but this option should <strong>NEVER</strong> be enabled in a production setting.</p><div class=tab-panel data-tab-group=913ad540489f5ac53d4f5f03f899d5f9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("913ad540489f5ac53d4f5f03f899d5f9","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=nv>BYPASS_AUTH</span><span class=o>=</span>true</span></span></code></pre></div></div></div></div></div><p>With that setting in place, we can add it to our <code>configs/auth.js</code> file to only allow bypass authentication if that setting is enabled:</p><div class=tab-panel data-tab-group=8cab2c09d1b6c86c9460cd2e1e2d5dd4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8cab2c09d1b6c86c9460cd2e1e2d5dd4","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Bypass Authentication via Token
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=k>new</span> <span class=nx>UniqueTokenStrategy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=c1>// verify callback function
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Only allow token authentication when enabled
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>BYPASS_AUTH</span> <span class=o>===</span> <span class=s2>&#34;true&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>authenticateUser</span><span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>))</span></span></span></code></pre></div></div></div></div></div><p>Before moving on, we should make sure we test both enabling and disabling this setting <em>actually</em> disables bypass authentication. We want to be absolutely sure it works as intended!</p><p><a href=#R-image-40dd7a840f72c097bb29b39b5cbb2be2 class=lightbox-link><img alt="Disabled Authentication" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-40dd7a840f72c097bb29b39b5cbb2be2><img alt="Disabled Authentication" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_2.png></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cookie-sessions>Cookie Sessions</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=cookie-sessions>Cookie Sessions</h2><p>One of the most common methods for keeping track of users after they are authenticated is by setting a cookie on their browser that is sent with each request. We&rsquo;ve already explored this method earlier in this course, so let&rsquo;s go ahead and configure cookie sessions for our application, storing them in our existing database.</p><p>We&rsquo;ll start by installing both the <a href=https://www.npmjs.com/package/express-session rel=external target=_blank>express-session</a> middleware and the <a href=https://www.npmjs.com/package/connect-session-sequelize rel=external target=_blank>connect-session-sequelize</a> library that we can use to store our sessions in a Sequelize database:</p><div class=tab-panel data-tab-group=dbb727df4587c865e9bda0a852a16a42><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("dbb727df4587c865e9bda0a852a16a42","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install express-session connect-session-sequelize</span></span></code></pre></div></div></div></div></div><p>Once those libraries are installed, we can create a configuration for sessions in a new <code>configs/sessions.js</code> file:</p><div class=tab-panel data-tab-group=ccc92a984e19a3537a0f8668d647f3dc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configssessionsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ccc92a984e19a3537a0f8668d647f3dc","configssessionsjs")'>
<span class=tab-nav-text>configs/sessions.js</span></button></div><div class=tab-content-container><div data-tab-item=configssessionsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration for cookie sessions stored in Sequelize
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports sequelizeSession a Session instance configured for Sequelize
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>session</span> <span class=nx>from</span> <span class=s1>&#39;express-session&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>connectSession</span> <span class=nx>from</span> <span class=s1>&#39;connect-session-sequelize&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s1>&#39;./database.js&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;./logger.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Initialize Store
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>sequelizeStore</span> <span class=o>=</span> <span class=nx>connectSession</span><span class=p>(</span><span class=nx>session</span><span class=p>.</span><span class=nx>Store</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>store</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>sequelizeStore</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=o>:</span> <span class=nx>database</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create tables in Sequelize
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>store</span><span class=p>.</span><span class=nx>sync</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_SECRET</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&#34;Cookie session secret not set! Set a SESSION_SECRET environment variable.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Session configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>sequelizeSession</span> <span class=o>=</span> <span class=nx>session</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>secret</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_SECRET</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>store</span><span class=o>:</span> <span class=nx>store</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=nx>resave</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>proxy</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>sequelizeSession</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This file loads our Sequelize database connection and initializes the Express session middleware and the Sequelize session store. We also have a quick sanity check that will ensure there is a <code>SESSION_SECRET</code> environment variable set, otherwise an error will be printed. Finally, we export that session configuration to our application.</p><p>So, we&rsquo;ll need to add a <code>SESSION_SECRET</code> environment variable to our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. This is a secret key used to secure our cookies and prevent them from being modified.</p><p>There are many ways to generate a secret key, but one of the simplest is to just use the built in functions in Node.js itself. We can launch the Node.js <a href=https://nodejs.org/en/learn/command-line/how-to-use-the-nodejs-repl rel=external target=_blank>REPL</a> environment by just running the <code>node</code> command in the terminal:</p><div class=tab-panel data-tab-group=199762614ea0500df1485ae69c64e8eb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("199762614ea0500df1485ae69c64e8eb","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node</span></span></code></pre></div></div></div></div></div><p>From there, we can use this line to get a random secret key:</p><div class=tab-panel data-tab-group=fa0e69b4188f8ab8288d8441d292eff7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=node class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fa0e69b4188f8ab8288d8441d292eff7","node")'>
<span class=tab-nav-text>node</span></button></div><div class=tab-content-container><div data-tab-item=node class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;crypto&#39;</span><span class=p>).</span><span class=nx>randomBytes</span><span class=p>(</span><span class=mi>64</span><span class=p>).</span><span class=nx>toString</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>)</span></span></span></code></pre></div></div></div></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Documenting Terminal Commands</div><div class=box-content><p>Just like we use <code>$</code> as the prompt for Linux terminal commands, the Node.js REPL environment uses <code>></code> so we will include that in our documentation. You should not include that character in your command.</p></div></div><p>If done correctly, we&rsquo;ll get a random string that you can use as your secret key!</p><p><a href=#R-image-9a5ff562e15840588e312fa6eb17d88b class=lightbox-link><img alt="Secret Key" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9a5ff562e15840588e312fa6eb17d88b><img alt="Secret Key" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_3.png></a></p><p>We can include that key in our <code>.env</code> file. To help remember how to do this in the future, we can even include the Node.js command as a comment above that line:</p><div class=tab-panel data-tab-group=594a9c94d2996e1b97229a5adeee7247><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("594a9c94d2996e1b97229a5adeee7247","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=c1># require(&#39;crypto&#39;).randomBytes(64).toString(&#39;hex&#39;)</span>
</span></span><span class=line><span class=cl><span class=nv>SESSION_SECRET</span><span class=o>=</span><span class=s1>&#39;46a5fdfe16fa710867102d1f0dbd2329f2eae69be3ed56ca084d9e0ad....&#39;</span></span></span></code></pre></div></div></div></div></div><p>Finally, we can update our <code>app.js</code> file to use this session configuration:</p><div class=tab-panel data-tab-group=b1321a3ab5dac67414fbf4d1953c54ce><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b1321a3ab5dac67414fbf4d1953c54ce","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>compression</span> <span class=nx>from</span> <span class=s2>&#34;compression&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s2>&#34;cookie-parser&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>helmet</span> <span class=nx>from</span> <span class=s2>&#34;helmet&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s2>&#34;path&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>swaggerUi</span> <span class=nx>from</span> <span class=s2>&#34;swagger-ui-express&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>openapi</span> <span class=nx>from</span> <span class=s2>&#34;./configs/openapi.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>sessions</span> <span class=nx>from</span> <span class=s2>&#34;./configs/sessions.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Use libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>helmet</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>compression</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Use sessions
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>sessions</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s1>&#39;session&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use middlewares
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>There we go! Now we can enable cookie sessions in Passport.js by removing the <code>{session: false}</code> setting in our <code>/auth/bypass</code> route in the <code>routes/auth.js</code> file:</p><div class=tab-panel data-tab-group=faa746a27629a3568e0c2fda16debd69><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("faa746a27629a3568e0c2fda16debd69","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/bypass&#34;</span><span class=p>,</span> <span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>),</span> <span class=nx>authSuccess</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we navigate to that route and authenticate, we should see our application set a session cookie as part of the response.</p><p><a href=#R-image-96f0d63034dcec4ea333aae19ac9a564 class=lightbox-link><img alt="Cookie Session" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_7.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-96f0d63034dcec4ea333aae19ac9a564><img alt="Cookie Session" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_7.png></a></p><p>We can match the SID in the session cookie with the SID in the <code>Sessions</code> table in our database to confirm that it is working:</p><p><a href=#R-image-c450126bf0bb05401f957c243cf6804d class=lightbox-link><img alt="Cookie Session in Database" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_8.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c450126bf0bb05401f957c243cf6804d><img alt="Cookie Session in Database" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_8.png></a></p><p>From here, we can use these sessions throughout our application to track users as they make additional requests.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=json-web-token>JSON Web Token</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=json-web-tokens-jwt>JSON Web Tokens (JWT)</h2><p>Now that we have a working authentication system, the next step is to configure a method to request a valid JSON Web Token, or JWT, that contains information about the authenticated user. We&rsquo;ve already learned a bit about JWTs in this course, so we won&rsquo;t cover too many of the details here.</p><p>To work with JWTs, we&rsquo;ll need to install the <a href=https://www.npmjs.com/package/jsonwebtoken rel=external target=_blank>jsonwebtoken</a> package from NPM:</p><div class=tab-panel data-tab-group=f5829611e9580888e0062ff5477bef95><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f5829611e9580888e0062ff5477bef95","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install jsonwebtoken</span></span></code></pre></div></div></div></div></div><p>Next, we&rsquo;ll need to create a secret key that we can use to sign our tokens. We&rsquo;ll add this as the <code>JWT_SECRET_KEY</code> setting in our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. We can use the same method discussed on the previous page to generate a new random key:</p><div class=tab-panel data-tab-group=79d843e8540c1e59db904e11637e251f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("79d843e8540c1e59db904e11637e251f","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=c1># require(&#39;crypto&#39;).randomBytes(64).toString(&#39;hex&#39;)</span>
</span></span><span class=line><span class=cl><span class=nv>JWT_SECRET_KEY</span><span class=o>=</span><span class=s1>&#39;46a5fdfe16fa710867102d1f0dbd2329f2eae69be3ed56ca084d9e0ad....&#39;</span></span></span></code></pre></div></div></div></div></div><p>Once we have the library and a key, we can easily create and sign a JWT in the <code>/auth/token</code> route in the <code>routes/auth.js</code> file:</p><div class=tab-panel data-tab-group=92fa5ab177348043cb3fa8ff712f022d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("92fa5ab177348043cb3fa8ff712f022d","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>jsonwebtoken</span> <span class=nx>from</span> <span class=s2>&#34;jsonwebtoken&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/token&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// If user is logged in
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>JWT_SECRET_KEY</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>expiresIn</span><span class=o>:</span> <span class=s1>&#39;6h&#39;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>token</span><span class=o>:</span> <span class=nx>token</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Send unauthorized response
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>send</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Now, when we visit the <code>/auth/token</code> URL on our working website (after logging in through the <code>/auth/bypass</code> route), we should receive a JWT as a response:</p><p><a href=#R-image-bf9725eb0a62133814ab9e2f69cd7da6 class=lightbox-link><img alt="JWT Response" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-bf9725eb0a62133814ab9e2f69cd7da6><img alt="JWT Response" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_4.png></a></p><p>Of course, while that data may seem unreadable, we already know that JWTs are Base64 encoded, so we can easily view the content of the token. Thankfully, there are many great tools we can use to debug our tokens, such as <a href=https://token.dev/ rel=external target=_blank>Token.dev</a>, to confirm that they are working correctly.</p><p><a href=#R-image-b9735ef93a605b4161890efde7849148 class=lightbox-link><img alt="JWT Debugger" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b9735ef93a605b4161890efde7849148><img alt="JWT Debugger" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_5.png></a></p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Do Not Share Live Keys!</div><div class=box-content><p>While sites like this will also help you confirm that your JWTs are properly signed by asking for your secret key, you <strong>SHOULD NOT</strong> share a secret key for a live production application with these sites. There is always a chance it has been compromised!</p></div></div><footer class=footline></footer></article></section></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/9d17f14bd7a7482467dc164e303870bb55f4ef70>Mar 4, 2025</a></p></div></div><script src=/cis526/js/clipboard.min.js?1741711031 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1741711031 defer></script><script src=/cis526/js/theme.js?1741711031 defer></script></body></html>
<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=print><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.148.1"><meta name=generator content="Relearn 8.0.0"><meta name=description content="This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.
Project Deliverables At the end of this example, we will have a project with the following features:
An authentication system using Passport.js and CAS Valid JSON Web Tokens (JWTs) for authentication within the RESTful API Proper middleware to verify users have the correct role for each operation in the API Prior Work This project picks up right where the last one left off, so if you haven’t completed that one yet, go back and do that before starting this one."><meta name=author content="Nathan Bean & Russell Feldhausen"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta name=twitter:title content="Authentication :: CIS 526 Textbook"><meta name=twitter:description content="This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.
Project Deliverables At the end of this example, we will have a project with the following features:
An authentication system using Passport.js and CAS Valid JSON Web Tokens (JWTs) for authentication within the RESTful API Proper middleware to verify users have the correct role for each operation in the API Prior Work This project picks up right where the last one left off, so if you haven’t completed that one yet, go back and do that before starting this one."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/index.html"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Authentication :: CIS 526 Textbook"><meta property="og:description" content="This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.
Project Deliverables At the end of this example, we will have a project with the following features:
An authentication system using Passport.js and CAS Valid JSON Web Tokens (JWTs) for authentication within the RESTful API Proper middleware to verify users have the correct role for each operation in the API Prior Work This project picks up right where the last one left off, so if you haven’t completed that one yet, go back and do that before starting this one."><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta property="og:image" content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><meta itemprop=name content="Authentication :: CIS 526 Textbook"><meta itemprop=description content="This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.
Project Deliverables At the end of this example, we will have a project with the following features:
An authentication system using Passport.js and CAS Valid JSON Web Tokens (JWTs) for authentication within the RESTful API Proper middleware to verify users have the correct role for each operation in the API Prior Work This project picks up right where the last one left off, so if you haven’t completed that one yet, go back and do that before starting this one."><meta itemprop=dateModified content="2025-03-04T21:42:32-06:00"><meta itemprop=wordCount content="122"><meta itemprop=image content="https://textbooks.cs.ksu.edu/cis526/images/hero.png"><title>Authentication :: CIS 526 Textbook</title><link href=https://textbooks.cs.ksu.edu/cis526/x-examples/04-authentication/index.html rel=canonical type=text/html title="Authentication :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/index.xml rel=alternate type=application/rss+xml title="Authentication :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/tele.html rel=alternate type=text/html title="Authentication :: CIS 526 Textbook"><link href=/cis526/x-examples/04-authentication/embed.html rel=alternate type=text/html title="Authentication :: CIS 526 Textbook"><link href=/cis526/css/auto-complete/auto-complete.min.css?1769118339 rel=stylesheet><script src=/cis526/js/auto-complete/auto-complete.min.js?1769118339 defer></script><script src=/cis526/js/search-lunr.min.js?1769118339 defer></script><script src=/cis526/js/search.min.js?1769118339 defer></script><script>window.relearn=window.relearn||{},window.relearn.index_js_url="/cis526/searchindex.en.js?1769118339"</script><script src=/cis526/js/lunr/lunr.min.js?1769118339 defer></script><script src=/cis526/js/lunr/lunr.stemmer.support.min.js?1769118339 defer></script><script src=/cis526/js/lunr/lunr.multi.min.js?1769118339 defer></script><script src=/cis526/js/lunr/lunr.en.min.js?1769118339 defer></script><script>window.relearn=window.relearn||{},window.relearn.contentLangs=["en"]</script><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1769118339 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/fonts/fontawesome/css/fontawesome-all.min.css?1769118339 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar/perfect-scrollbar.min.css?1769118339 rel=stylesheet><link href=/cis526/css/theme.min.css?1769118339 rel=stylesheet><link href=/cis526/css/format-print.min.css?1769118339 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.min=`.min`,window.relearn.path="/x-examples/04-authentication/index.html",window.relearn.relBasePath="../..",window.relearn.relBaseUri="../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.disableInlineCopyToClipboard=!0,window.relearn.enableBlockCodeWrap=!1,window.relearn.getItem=(e,t)=>e.getItem(t),window.relearn.setItem=(e,t,n)=>e.setItem(t,n),window.relearn.removeItem=(e,t)=>e.removeItem(t),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`,window.relearn.themevariants=["light-theme"],window.relearn.customvariantname="my-custom-variant",window.relearn.writeVariant=!1,window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&(document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}})),window.relearn.markVariant())},window.relearn.markVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant");document.querySelectorAll(".R-variantswitcher select").forEach(t=>{t.value=e})},window.relearn.initVariant=function(){var e=window.relearn.getItem(window.localStorage,window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.relearn.writeVariant&&window.relearn.setItem(window.localStorage,window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant()</script><link href=/cis526/css/custom.css?1769118339 rel=stylesheet></head><body class="mobile-support print" data-url=/cis526/x-examples/04-authentication/index.html><div id=tele class="tele mirror"><div id=R-body class=default-animation><div id=R-body-overlay></div><div id=R-main-overlay></div><main id=R-body-inner class="highlightable x-examples" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=authentication>Authentication</h1><p>This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li>An authentication system using <a href=https://www.passportjs.org/ rel=external target=_blank>Passport.js</a> and <a href=https://apereo.github.io/cas/7.1.x/index.html rel=external target=_blank>CAS</a></li><li>Valid JSON Web Tokens (JWTs) for authentication within the RESTful API</li><li>Proper middleware to verify users have the correct role for each operation in the API</li></ol><details open class="box cstyle notices warning"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-triangle"></i>
Prior Work</summary><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></details><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Authentication</h1><article class=default><header class=headline></header><h1 id=bypass-auth>Bypass Auth</h1><a href="https://www.youtube.com/watch?v=NjrWPg41_B4">YouTube Video</a><h2 id=authentication-libraries>Authentication Libraries</h2><p>There are many different authentication libraries and methods available for Node.js and Express. For this project, we will use the <a href=https://www.passportjs.org/ rel=external target=_blank>Passport.js</a> library. It supports many different authentication strategies, and is a very common way that authentication is handled within JavaScript applications.</p><p>For our application, we&rsquo;ll end up using several strategies to authenticate our users:</p><ul><li><a href=https://www.passportjs.org/packages/passport-unique-token/ rel=external target=_blank>Unique Token</a> - used to bypass authentication for testing</li><li><a href=https://github.com/appdevdesigns/passport-cas rel=external target=_blank>CAS</a> - used to authenticate with <a href=https://apereo.github.io/cas/7.1.x/index.html rel=external target=_blank>Central Authentication Service (CAS)</a> servers such as those used at K-State</li><li><a href=https://www.passportjs.org/packages/passport-jwt-cookiecombo/ rel=external target=_blank>JSON Web Tokens (JWT)</a> - used to identify user requests to the API itself</li></ul><p>Let&rsquo;s first set up our unique token strategy, which allows us to test our authentication routes before setting up anything else.</p><h2 id=authentication-router>Authentication Router</h2><p>First, we&rsquo;ll need to create a new route file at <code>routes/auth.js</code> to contain our authentication routes. We&rsquo;ll start with this basic structure and work on filling in each method as we go.</p><div class=tab-panel data-tab-group=ca535ac8b822948ec52ef3610d44c68d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ca535ac8b822948ec52ef3610d44c68d","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file Auth router
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @exports router an Express router
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * tags:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   name: auth
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   description: Authentication Routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> * components:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   securitySchemes:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     bearerAuth:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       type: http
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       scheme: bearer
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       bearerFormat: JWT
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   responses:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     AuthToken:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       description: authentication success
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       content:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         application/json:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *           schema:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *             type: object
</span></span></span><span style=display:flex><span><span style=color:#75715e> *             required:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *               - token
</span></span></span><span style=display:flex><span><span style=color:#75715e> *             properties:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *               token:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *                 type: string
</span></span></span><span style=display:flex><span><span style=color:#75715e> *                 description: a JWT for the user
</span></span></span><span style=display:flex><span><span style=color:#75715e> *             example:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *               token: abcdefg12345
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>express</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;express&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>passport</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;passport&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import configurations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#34;../configs/auth.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create Express router
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>Router</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Authentication Response Handler
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} req - Express request object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} res - Express response object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Function} next - Express next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authSuccess</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Bypass authentication for testing
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} req - Express request object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} res - Express response object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Function} next - Express next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * /auth/bypass:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   get:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     summary: bypass authentication for testing
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     description: Bypasses CAS authentication for testing purposes
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     tags: [auth]
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     parameters:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       - in: query
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         name: token
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         required: true
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         schema:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *           type: string
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         description: username
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     responses:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       200:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         description: success
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/bypass&#34;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * CAS Authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} req - Express request object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} res - Express response object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Function} next - Express next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * /auth/cas:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   get:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     summary: CAS authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     description:  CAS authentication for deployment
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     tags: [auth]
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     responses:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       200:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         description: success
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/cas&#34;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Request JWT based on previous authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} req - Express request object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} res - Express response object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Function} next - Express next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * /auth/token:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   get:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     summary: request JWT 
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     description: request JWT based on previous authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     tags: [auth]
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     responses:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       200:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         $ref: &#39;#/components/responses/AuthToken&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/token&#34;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>router</span>;</span></span></code></pre></div></div></div></div></div><p>This file includes a few items to take note of:</p><ul><li>In the top-level Open API comment, we define a new <code>AuthToken</code> response that we&rsquo;ll send to the user when they request a token.</li><li>We create three routes. The first two, <code>/auth/bypass</code> and <code>/auth/cas</code>, for each of our authentication strategies. The last one, <code>/auth/token</code> will be used by our frontend to request a token to access the API.</li><li>Finally, we&rsquo;ll build a <code>authSuccess</code> function to handle actually sending the response to the user.</li></ul><p>Before moving on, let&rsquo;s go ahead and add this router to our <code>app.js</code> file along with the other routers:</p><div class=tab-panel data-tab-group=3297de1b366513340da8ac755c624526><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3297de1b366513340da8ac755c624526","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import routers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>indexRouter</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./routes/index.js&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>apiRouter</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./routes/api.js&#34;</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>authRouter</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./routes/auth.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Use routers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>indexRouter</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/api&#34;</span>, <span style=color:#a6e22e>apiRouter</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, <span style=color:#a6e22e>authRouter</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll come back to this file once we are ready to link up our authentication strategies.</p><h2 id=unique-token-authentication>Unique Token Authentication</h2><p>Next, let&rsquo;s install both <code>passport</code> and the <code>passport-unique-token</code> authentication strategy:</p><div class=tab-panel data-tab-group=28494a452be4da22921de8ae783402cb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("28494a452be4da22921de8ae783402cb","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm install passport passport-unique-token</span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll configure that strategy in a new <code>configs/auth.js</code> file with the following content:</p><div class=tab-panel data-tab-group=8aadd7f1404588da6adf9e2e48726f4d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8aadd7f1404588da6adf9e2e48726f4d","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file Configuration information for Passport.js Authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>passport</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;passport&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>UniqueTokenStrategy</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;passport-unique-token&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import models
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>User</span>, <span style=color:#a6e22e>Role</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../models/models.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import logger
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>logger</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./logger.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Authenticate a user
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {string} username the username to authenticate
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {function} next the next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authenticateUser</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Find user with the username
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findOne</span>({ 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;username&#34;</span>],
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>include</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>model</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Role</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>as</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;roles&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;role&#34;</span>],
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>through</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>username</span> },
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// User not found
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>user</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;Login failed for user: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>username</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// User authenticated
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;Login succeeded for user: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Convert Sequelize object to plain JavaScript object
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>user</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Bypass Authentication via Token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>passport</span>.<span style=color:#a6e22e>use</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>UniqueTokenStrategy</span>(
</span></span><span style=display:flex><span>  <span style=color:#75715e>// verify callback function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  (<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>next</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>authenticateUser</span>(<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>next</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Default functions to serialize and deserialize a session
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>passport</span>.<span style=color:#a6e22e>serializeUser</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>done</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>done</span>(<span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>passport</span>.<span style=color:#a6e22e>deserializeUser</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>done</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>done</span>(<span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>In this file, we created an <code>authenticateUser</code> function that will look for a user based on a given username. If found, it will return that user by calling the <code>next</code> middleware function. Otherwise, it will call that function and provide <code>false</code>.</p><p>Below, we configure Passport.js using the <code>passport.use</code> function to define the various authentication strategies we want to use. In this case, we&rsquo;ll start with the <a href=https://www.passportjs.org/packages/passport-unique-token/ rel=external target=_blank>Unique Token Strategy</a>, which uses a token provided as part of a query to the web server.</p><p>In addition, we need to implement some default functions to handle serializing and deserializing a user from a session. These functions don&rsquo;t really have any content in our implementation; we just need to include the default code.</p><p>Finally, since Passport.js acts as a global object, we don&rsquo;t even have to export anything from this file!</p><h2 id=testing-authentication>Testing Authentication</h2><p>To test this authentication strategy, let&rsquo;s modify <code>routes/auth.js</code> to use this strategy. We&rsquo;ll update the <code>/auth/bypass</code> route and also add some temporary code to the <code>authSuccess</code> function:</p><div class=tab-panel data-tab-group=5753a6cc0e604ef07344e4a0bd49d5f6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5753a6cc0e604ef07344e4a0bd49d5f6","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>express</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;express&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>passport</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;passport&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e>// Import configurations
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#34;../configs/auth.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authSuccess</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex;background-color:#3c3d38><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/bypass&#34;</span>, <span style=color:#a6e22e>passport</span>.<span style=color:#a6e22e>authenticate</span>(<span style=color:#e6db74>&#39;token&#39;</span>, {<span style=color:#a6e22e>session</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>}), <span style=color:#a6e22e>authSuccess</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>In the <code>authSuccess</code> function, right now we are just sending the content of <code>req.user</code>, which is set by Passport.js on a successful authentication (it is the value we returned when calling the <code>next</code> function in our authentication strategy earlier). We&rsquo;ll come back to this later when we implement JSON Web Tokens (JWT) later in this tutorial.</p><p>The other major change is that now the <code>/auth/bypass</code> route calls the <code>passport.authenticate</code> method with the <code>'token'</code> strategy specified. It also uses <code>{session: false}</code> as one of the options provided to Passport.js since we aren&rsquo;t actually going to be using sessions. Finally, if that middleware is satisfied, it will call the <code>authSuccess</code> function to handle sending the response to the user. This takes advantage of the chaining that we can do in Express!</p><p>With all of that in place, we can test our server and see if it works:</p><div class=tab-panel data-tab-group=694c9bea54e4fb619d3762c578c81a6a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("694c9bea54e4fb619d3762c578c81a6a","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once the page loads, we want to navigate to the <code>/auth/bypass?token=admin</code> path to see if we can log in as the <code>admin</code> user. Notice that we are including a query parameter named <code>token</code> to include the username in the URL.</p><p><a href=#R-image-8c4b6f10fbadf9d453ea780e5073406d class=lightbox-link><img alt="Successful Authentication" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8c4b6f10fbadf9d453ea780e5073406d><img alt="Successful Authentication" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_1.png></a></p><p>There we go! We see that it successfully finds our <code>admin</code> user and returns data about that user, including the roles assigned. This is what we want to see. We can also test this by providing other usernames to make sure it is working.</p><h2 id=securing-authentication>Securing Authentication</h2><p>Of course, we don&rsquo;t want to have this bypass authentication system available all the time in our application. In fact, we really only want to use it for testing and debugging; otherwise, our application will have a major security flaw! So, let&rsquo;s add a new environment variable <code>BYPASS_AUTH</code> to our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. We should set it to <code>TRUE</code> in the <code>.env.test</code> file, and for now we&rsquo;ll have it enabled in our <code>.env</code> file as well, but this option should <strong>NEVER</strong> be enabled in a production setting.</p><div class=tab-panel data-tab-group=b6c2ab265aa2c177ecff7204ca36c5b7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b6c2ab265aa2c177ecff7204ca36c5b7","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-env data-lang=env><span style=display:flex><span><span style=color:#75715e># -=-=- other settings omitted here -=-=-</span>
</span></span><span style=display:flex><span>BYPASS_AUTH<span style=color:#f92672>=</span>true</span></span></code></pre></div></div></div></div></div><p>With that setting in place, we can add it to our <code>configs/auth.js</code> file to only allow bypass authentication if that setting is enabled:</p><div class=tab-panel data-tab-group=fc2d646c7576c912d502dbdcbdf0d4e5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fc2d646c7576c912d502dbdcbdf0d4e5","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Bypass Authentication via Token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>passport</span>.<span style=color:#a6e22e>use</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>UniqueTokenStrategy</span>(
</span></span><span style=display:flex><span>  <span style=color:#75715e>// verify callback function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  (<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>next</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Only allow token authentication when enabled
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BYPASS_AUTH</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;true&#34;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>authenticateUser</span>(<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>next</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>))</span></span></code></pre></div></div></div></div></div><p>Before moving on, we should make sure we test both enabling and disabling this setting <em>actually</em> disables bypass authentication. We want to be absolutely sure it works as intended!</p><p><a href=#R-image-e36af00da0bbc5b32d19b66a09634ee7 class=lightbox-link><img alt="Disabled Authentication" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e36af00da0bbc5b32d19b66a09634ee7><img alt="Disabled Authentication" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_2.png></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cookie-sessions>Cookie Sessions</h1><a href="https://www.youtube.com/watch?v=HR3gG-9bwts">YouTube Video</a><h2 id=cookie-sessions>Cookie Sessions</h2><p>One of the most common methods for keeping track of users after they are authenticated is by setting a cookie on their browser that is sent with each request. We&rsquo;ve already explored this method earlier in this course, so let&rsquo;s go ahead and configure cookie sessions for our application, storing them in our existing database.</p><p>We&rsquo;ll start by installing both the <a href=https://www.npmjs.com/package/express-session rel=external target=_blank>express-session</a> middleware and the <a href=https://www.npmjs.com/package/connect-session-sequelize rel=external target=_blank>connect-session-sequelize</a> library that we can use to store our sessions in a Sequelize database:</p><div class=tab-panel data-tab-group=b9937023104513df4712bfcd44beca1e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b9937023104513df4712bfcd44beca1e","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm install express-session connect-session-sequelize</span></span></code></pre></div></div></div></div></div><p>Once those libraries are installed, we can create a configuration for sessions in a new <code>configs/sessions.js</code> file:</p><div class=tab-panel data-tab-group=aea9153bf908d76ee071ec57feb25923><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configssessionsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("aea9153bf908d76ee071ec57feb25923","configssessionsjs")'>
<span class=tab-nav-text>configs/sessions.js</span></button></div><div class=tab-content-container><div data-tab-item=configssessionsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file Configuration for cookie sessions stored in Sequelize
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @exports sequelizeSession a Session instance configured for Sequelize
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>session</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;express-session&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>connectSession</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;connect-session-sequelize&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Database
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>database</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./database.js&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>logger</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./logger.js&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Initialize Store
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sequelizeStore</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>connectSession</span>(<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>Store</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>store</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>sequelizeStore</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>database</span>
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create tables in Sequelize
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>sync</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>SESSION_SECRET</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Cookie session secret not set! Set a SESSION_SECRET environment variable.&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Session configuration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sequelizeSession</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>session</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>SESSION_NAME</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;connect.sid&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>secret</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>SESSION_SECRET</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>store</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>store</span>, 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resave</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>proxy</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>saveUninitialized</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>sequelizeSession</span>;</span></span></code></pre></div></div></div></div></div><p>This file loads our Sequelize database connection and initializes the Express session middleware and the Sequelize session store. We also have a quick sanity check that will ensure there is a <code>SESSION_SECRET</code> environment variable set, otherwise an error will be printed. Finally, we export that session configuration to our application.</p><p>So, we&rsquo;ll need to add a <code>SESSION_NAME</code> and <code>SESSION_SECRET</code> environment variable to our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. The <code>SESSION_NAME</code> is a unique name for our cookie, and the <code>SESSION_SECRET</code> is a secret key used to secure our cookies and prevent them from being modified.</p><p>There are many ways to generate a secret key, but one of the simplest is to just use the built in functions in Node.js itself. We can launch the Node.js <a href=https://nodejs.org/en/learn/command-line/how-to-use-the-nodejs-repl rel=external target=_blank>REPL</a> environment by just running the <code>node</code> command in the terminal:</p><div class=tab-panel data-tab-group=4fbb3caa891442cb48da778a871ab25a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4fbb3caa891442cb48da778a871ab25a","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ node</span></span></code></pre></div></div></div></div></div><p>From there, we can use this line to get a random secret key:</p><div class=tab-panel data-tab-group=dc41fb379a8a9bde5ac4bc467db759db><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=node class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("dc41fb379a8a9bde5ac4bc467db759db","node")'>
<span class=tab-nav-text>node</span></button></div><div class=tab-content-container><div data-tab-item=node class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;crypto&#39;</span>).<span style=color:#a6e22e>randomBytes</span>(<span style=color:#ae81ff>64</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#39;hex&#39;</span>)</span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices info"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-info-circle"></i>
Documenting Terminal Commands</summary><div class=box-content><p>Just like we use <code>$</code> as the prompt for Linux terminal commands, the Node.js REPL environment uses <code>></code> so we will include that in our documentation. You should not include that character in your command.</p></div></details><p>If done correctly, we&rsquo;ll get a random string that you can use as your secret key!</p><p><a href=#R-image-4335c454d887f11c05b5d4a10422c1c3 class=lightbox-link><img alt="Secret Key" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4335c454d887f11c05b5d4a10422c1c3><img alt="Secret Key" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_3.png></a></p><p>We can include that key in our <code>.env</code> file. To help remember how to do this in the future, we can even include the Node.js command as a comment above that line:</p><div class=tab-panel data-tab-group=ac2182a60557643e6e1d8f79c518fd12><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ac2182a60557643e6e1d8f79c518fd12","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-env data-lang=env><span style=display:flex><span><span style=color:#75715e># -=-=- other settings omitted here -=-=-</span>
</span></span><span style=display:flex><span>SESSION_NAME<span style=color:#f92672>=</span>lostcommunities
</span></span><span style=display:flex><span><span style=color:#75715e># require(&#39;crypto&#39;).randomBytes(64).toString(&#39;hex&#39;)</span>
</span></span><span style=display:flex><span>SESSION_SECRET<span style=color:#f92672>=</span>46a5fdfe16fa710867102d1f0dbd2329f2eae69be3ed56ca084d9e0ad....</span></span></code></pre></div></div></div></div></div><p>Finally, we can update our <code>app.js</code> file to use this session configuration. We&rsquo;ll place this between the <code>/api</code> and <code>/auth</code> routes, since we only want to load cookie sessions if the user is accessing the authentication routes, to minimize the number of database requests:</p><div class=tab-panel data-tab-group=98411010b8e5dd134b983dacfe3de68d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("98411010b8e5dd134b983dacfe3de68d","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>compression</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;compression&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>cookieParser</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;cookie-parser&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>express</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;express&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>helmet</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;helmet&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>path</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;path&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>swaggerUi</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;swagger-ui-express&#34;</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>passport</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;passport&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import configurations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>logger</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./configs/logger.js&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>openapi</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./configs/openapi.js&#34;</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>sessions</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./configs/sessions.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Use routers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>indexRouter</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/api&#34;</span>, <span style=color:#a6e22e>apiRouter</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e>// Use sessions
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>sessions</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>passport</span>.<span style=color:#a6e22e>authenticate</span>(<span style=color:#e6db74>&#34;session&#34;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Use auth routes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, <span style=color:#a6e22e>authRouter</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>There we go! Now we can enable cookie sessions in Passport.js by removing the <code>{session: false}</code> setting in our <code>/auth/bypass</code> route in the <code>routes/auth.js</code> file:</p><div class=tab-panel data-tab-group=ade3bd28a09e72ee143b3b2219020257><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ade3bd28a09e72ee143b3b2219020257","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/bypass&#34;</span>, <span style=color:#a6e22e>passport</span>.<span style=color:#a6e22e>authenticate</span>(<span style=color:#e6db74>&#39;token&#39;</span>), <span style=color:#a6e22e>authSuccess</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we navigate to that route and authenticate, we should see our application set a session cookie as part of the response.</p><p><a href=#R-image-8fc910007ff354f65ead11abb1882db8 class=lightbox-link><img alt="Cookie Session" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_7.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8fc910007ff354f65ead11abb1882db8><img alt="Cookie Session" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_7.png></a></p><p>We can match the SID in the session cookie with the SID in the <code>Sessions</code> table in our database to confirm that it is working:</p><p><a href=#R-image-ad6360f5ed8b06e3ae8edb17358de5a1 class=lightbox-link><img alt="Cookie Session in Database" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_8.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ad6360f5ed8b06e3ae8edb17358de5a1><img alt="Cookie Session in Database" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_8.png></a></p><p>From here, we can use these sessions throughout our application to track users as they make additional requests.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=json-web-token>JSON Web Token</h1><a href="https://www.youtube.com/watch?v=j9tzO3bQxxs">YouTube Video</a><h2 id=json-web-tokens-jwt>JSON Web Tokens (JWT)</h2><p>Now that we have a working authentication system, the next step is to configure a method to request a valid JSON Web Token, or JWT, that contains information about the authenticated user. We&rsquo;ve already learned a bit about JWTs in this course, so we won&rsquo;t cover too many of the details here.</p><p>To work with JWTs, we&rsquo;ll need to install the <a href=https://www.npmjs.com/package/jsonwebtoken rel=external target=_blank>jsonwebtoken</a> package from NPM:</p><div class=tab-panel data-tab-group=31dac16c2d41c263f35f14ded473f35f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("31dac16c2d41c263f35f14ded473f35f","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm install jsonwebtoken</span></span></code></pre></div></div></div></div></div><p>Next, we&rsquo;ll need to create a secret key that we can use to sign our tokens. We&rsquo;ll add this as the <code>JWT_SECRET_KEY</code> setting in our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. We can use the same method discussed on the previous page to generate a new random key:</p><div class=tab-panel data-tab-group=9b40ebdd751de1f93211c37d84da9668><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9b40ebdd751de1f93211c37d84da9668","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-env data-lang=env><span style=display:flex><span><span style=color:#75715e># -=-=- other settings omitted here -=-=-</span>
</span></span><span style=display:flex><span><span style=color:#75715e># require(&#39;crypto&#39;).randomBytes(64).toString(&#39;hex&#39;)</span>
</span></span><span style=display:flex><span>JWT_SECRET_KEY<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;46a5fdfe16fa710867102d1f0dbd2329f2eae69be3ed56ca084d9e0ad....&#39;</span></span></span></code></pre></div></div></div></div></div><p>Once we have the library and a key, we can easily create and sign a JWT in the <code>/auth/token</code> route in the <code>routes/auth.js</code> file:</p><div class=tab-panel data-tab-group=9e09daf76b62575766e74f1442d60718><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9e09daf76b62575766e74f1442d60718","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>express</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;express&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>passport</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;passport&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>jsonwebtoken</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;jsonwebtoken&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/token&#34;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// If user is logged in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>user</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jsonwebtoken</span>.<span style=color:#a6e22e>sign</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>user</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>JWT_SECRET_KEY</span>,
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expiresIn</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;6h&#39;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>token</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Send unauthorized response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>end</span>()
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>Now, when we visit the <code>/auth/token</code> URL on our working website (after logging in through the <code>/auth/bypass</code> route), we should receive a JWT as a response:</p><p><a href=#R-image-e447b785486f53e550567a4f7249fc1b class=lightbox-link><img alt="JWT Response" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e447b785486f53e550567a4f7249fc1b><img alt="JWT Response" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_4.png></a></p><p>Of course, while that data may seem unreadable, we already know that JWTs are Base64 encoded, so we can easily view the content of the token. Thankfully, there are many great tools we can use to debug our tokens, such as <a href=https://token.dev/ rel=external target=_blank>Token.dev</a>, to confirm that they are working correctly.</p><p><a href=#R-image-234bf40dfe5f90cfed943a90226ebf3a class=lightbox-link><img alt="JWT Debugger" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-234bf40dfe5f90cfed943a90226ebf3a><img alt="JWT Debugger" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_5.png></a></p><details open class="box cstyle notices warning"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-triangle"></i>
Do Not Share Live Keys!</summary><div class=box-content><p>While sites like this will also help you confirm that your JWTs are properly signed by asking for your secret key, you <strong>SHOULD NOT</strong> share a secret key for a live production application with these sites. There is always a chance it has been compromised!</p></div></details><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=auth-routing>Auth Routing</h1><a href="https://www.youtube.com/watch?v=8hOtlMwkSow">YouTube Video</a><h2 id=routing-after-authentication>Routing after Authentication</h2><p>The last step we should take in our authentication system is to properly route users back to the index page after a successful login attempt. Since we will eventually be building a single-page application in Vue.js as our frontend for this application, we only need to worry about directing users back to the index page, which will load our frontend.</p><p>So, in our <code>authSuccess</code> method in <code>routes/auth.js</code>, we can update the response to redirect our users back to the index page:</p><div class=tab-panel data-tab-group=4ace999a65b8bf04904253aaa2e6073c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=authroutesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4ace999a65b8bf04904253aaa2e6073c","authroutesjs")'>
<span class=tab-nav-text>auth/routes.js</span></button></div><div class=tab-content-container><div data-tab-item=authroutesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authSuccess</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>redirect</span>(<span style=color:#e6db74>&#34;/&#34;</span>);
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>The <code>res.redirect</code> method will sent an HTTP 302 <code>Found</code> response back to the browser with a new location to navigate to. However, by that point, the authentication process will also send a cookie to the browser with the session ID, so the user will be logged in correctly:</p><p><a href=#R-image-f7b061f8b9e5a0395aa1bd0bd4f7c944 class=lightbox-link><img alt="Session Login with Cookie Set" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_9.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f7b061f8b9e5a0395aa1bd0bd4f7c944><img alt="Session Login with Cookie Set" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_9.png></a></p><h2 id=logout-route>Logout Route</h2><p>Finally, we should also add a logout route. This route will end any sessions created through Passport.js by removing the session from the database and also telling the browser to delete the session cookie. It uses the special <code>req.logout()</code> method that is added to each request by Passport.js. We&rsquo;ll add our logout route to the bottom of the <code>routes/auth.js</code> file:</p><div class=tab-panel data-tab-group=02aa4f538c97bb366dad61d408406710><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("02aa4f538c97bb366dad61d408406710","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import configurations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#34;../configs/auth.js&#34;</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>logger</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../configs/logger.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Logout of a Passport.js session
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 
</span></span></span><span style=display:flex><span><span style=color:#75715e> * See https://www.initialapps.com/properly-logout-passportjs-express-session-for-single-page-app/
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} req - Express request object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} res - Express response object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Function} next - Express next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * /auth/logout:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   get:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     summary: logout current user
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     description:  logout current user and end session
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     tags: [auth]
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     responses:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       200:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         description: success
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/logout&#39;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>clearCookie</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>SESSION_NAME</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;connect.sid&#39;</span>);  <span style=color:#75715e>// clear the session cookie
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>logout</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>err</span>) {       <span style=color:#75715e>// logout of passport
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>destroy</span>(<span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {  <span style=color:#75715e>// destroy the session
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>redirect</span>(<span style=color:#e6db74>&#39;/&#39;</span>);
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we access this route with a valid session, we&rsquo;ll see that the user is properly logged out.</p><p>We&rsquo;ll also no longer be able to access the <code>/auth/token</code> route without logging in again.</p><p>However, this route <strong>WILL NOT</strong> invalidate any existing JWTs already issued to that user - they will still be valid until they expire. In our earlier example, we set the JWTs to have a 6 hour lifetime, so in theory a user could still access the application using a valid JWT up to 6 hours after logging out!</p><details open class="box cstyle notices warning"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-triangle"></i>
Invalidating JWTs</summary><div class=box-content><p>JSON Web Tokens (JWTs) are a very powerful authentication method for web APIs because they allow users to send requests without worrying about the need for a cookie session. In theory, a JWT issued by any instance of our API can be validated anywhere, making it much easier to horizontally scale this application in the future.</p><p>In addition, requests with a JWT generally don&rsquo;t require a database access with each request to validate the session. Our current cookie sessions store the session data in the database, so now each incoming request containing a session cookie requires a database lookup to get information about the user before any work can be done.</p><p>However, this means that any user with a valid JWT will be able to access our application even if they have logged out. This may present a security issue for some applications.</p><p>There are some strategies to mitigate this risk:</p><ol><li>Use JWTs with a short expiration - this means users may have to log in again and/or request new tokens more often, which could be frustrating.</li><li>Add a database session to each JWT - this would mean that each incoming request with a JWT would now result in a database lookup, which could slow things down. Alternatively, sessions could be stored in a faster cache mechanism such as <a href=https://redis.io/ rel=external target=_blank>Redis</a> or <a href=https://valkey.io/ rel=external target=_blank>Valkey</a>.</li><li>To permanently invalidate all existing JWT sessions (in case of a security compromise or other concern), simply change the key used to sign the JWTs to a new secure key. This is a method of last resort, but it is always important to know that it is available if needed.</li></ol></div></details><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cas-authentication>CAS Authentication</h1><a href="https://www.youtube.com/watch?v=fnsW2-iKliE">YouTube Video</a><h2 id=cas-authentication>CAS Authentication</h2><p>We&rsquo;ve already studied <a href=https://apereo.github.io/cas/7.1.x/index.html rel=external target=_blank>Central Authentication Service (CAS)</a> as one method for authenticating users through a third party service. In this case, CAS is the service commonly used at K-State for authentication, which is why we like to cover it in our examples. So, let&rsquo;s look at how to add CAS authentication to our application through Passport.</p><h2 id=installing-a-passport-strategy>Installing a Passport Strategy</h2><p>First, we&rsquo;ll need to install a new Passport.js strategy for dealing with CAS authentication. Thankfully, the ALT+CS lab at K-State maintains an updated library for this, which can be installed as shown below:</p><div class=tab-panel data-tab-group=bcadba681cd7c972cad258f30776152f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bcadba681cd7c972cad258f30776152f","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm install https://github.com/alt-cs-lab/passport-cas</span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
Finding a Good Strategy</summary><div class=box-content><p>Unfortunately, it is very difficult to find an updated Passport.js strategy for CAS authentication. This is partially due to the fact the CAS is not commonly used, and partially because many existing strategies have been written once and then abandoned by the developers. For this class, we sought out the most updated strategy available, then did our best to fix any known/existing bugs.</p></div></details><h2 id=configuring-cas-strategy>Configuring CAS Strategy</h2><p>Next, we can configure our authentication strategy by adding a few items to the <code>configs/auth.js</code> file for our new CAS strategy:</p><div class=tab-panel data-tab-group=b963ef2c5ce8892b2294dc3763274a58><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b963ef2c5ce8892b2294dc3763274a58","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>passport</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;passport&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>UniqueTokenStrategy</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;passport-unique-token&#34;</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Strategy</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>CasStrategy</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;@alt-cs-lab/passport-cas&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// CAS authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>passport</span>.<span style=color:#a6e22e>use</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CasStrategy</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>version</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;CAS2.0&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ssoBaseURL</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CAS_URL</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>serverBaseURL</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CAS_SERVICE_URL</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;/auth/cas&#39;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>profile</span>, <span style=color:#a6e22e>next</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>profile</span>.<span style=color:#a6e22e>user</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>authenticateUser</span>(<span style=color:#a6e22e>profile</span>.<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>next</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;CAS authentication succeeded but no user returned: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>profile</span>));
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>In this file, we are importing our new CAS authentication strategy, then using <code>passport.use</code> to tell Passport.js to use this authentication strategy when requested. Inside, we set up the various settings for our strategy, as well as the callback function when a user successfully authenticates. In this case, the CAS server will give us a <code>profile</code> object that should contain the <code>user</code> attribute with the user&rsquo;s username, which we can send to our <code>authenticateUser</code> method we&rsquo;ve already created. Finally, we also include a short catch to log any errors where the user is able to log in but a username is not provided.</p><p>In our <code>.env</code> file, we&rsquo;ll need to add two more settings. The <code>CAS_URL</code> is the base URL for the CAS server itself, and the <code>CAS_SERVICE_URL</code> is the URL that users should be sent back to, along with a ticket, to complete the log in process. Since we are working in GitHub Codespaces, our <code>CAS_SERVICE_URL</code> will be the same as our <code>OPENAPI_HOST</code>.</p><div class=tab-panel data-tab-group=3968305272ebb20e0fc4018aa42f8465><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3968305272ebb20e0fc4018aa42f8465","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-env data-lang=env><span style=display:flex><span><span style=color:#75715e># -=-=- other settings omitted here -=-=-</span>
</span></span><span style=display:flex><span>CAS_URL<span style=color:#f92672>=</span>https://testcas.cs.ksu.edu
</span></span><span style=display:flex><span>CAS_SERVICE_URL<span style=color:#f92672>=</span>https://$CODESPACE_NAME-$PORT.$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span></span></code></pre></div></div></div></div></div><p>Notice that we already add the <code>/auth/cas</code> route to the end of the <code>CAS_SERVICE_URL</code> in the configuration above - since that path won&rsquo;t change, it makes sense to just include it there instead of having to remember to add it to the path in the <code>.env</code> file. We should also put sensible defaults in our <code>.env.example</code> and <code>.env.test</code> files as well.</p><p>Now, to use this authentication method, all we have to do is update our <code>/auth/cas</code> route in <code>routes/auth.js</code> to use this strategy:</p><div class=tab-panel data-tab-group=790dd2468b25322c600869e920699f4f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("790dd2468b25322c600869e920699f4f","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * CAS Authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} req - Express request object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} res - Express response object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Function} next - Express next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * /auth/cas:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   get:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     summary: CAS authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     description:  CAS authentication for deployment
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     tags: [auth]
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     responses:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       200:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         description: success
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/cas&#34;</span>, <span style=color:#a6e22e>passport</span>.<span style=color:#a6e22e>authenticate</span>(<span style=color:#e6db74>&#39;cas&#39;</span>), <span style=color:#a6e22e>authSuccess</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>With that in place, we can start our application and test it by navigating to the <code>/auth/cas</code> route to see if our login attempt works:</p><div class=tab-panel data-tab-group=ae74c6122aa34fd919f53907c5a7200f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ae74c6122aa34fd919f53907c5a7200f","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>If everything works correctly, we should be directed to our CAS server to authenticate, then we&rsquo;ll be sent back to our own server with a ticket to validate our authentication. Finally, once the ticket is validated, we&rsquo;ll be redirected back to our home page with a session cookie set:</p><p><a href=#R-image-3a1c270e5d9ddf1689a4f8b13c36d81b class=lightbox-link><img alt="CAS Login with Cookie Set" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_9.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-3a1c270e5d9ddf1689a4f8b13c36d81b><img alt="CAS Login with Cookie Set" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_9.png></a></p><h2 id=cas-logout>CAS Logout</h2><p>Finally, we&rsquo;ll need to add a bit more logic to our logout process to properly log users out of both our application and the CAS server they originally logged in through. So, let&rsquo;s update our <code>/auth/logout</code> route to include that:</p><div class=tab-panel data-tab-group=5c62aa2cccdbc28f9cc52f7055cdc531><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5c62aa2cccdbc28f9cc52f7055cdc531","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#39;/logout&#39;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>clearCookie</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>SESSION_NAME</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;connect.sid&#39;</span>);  <span style=color:#75715e>// clear the session cookie
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>logout</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>err</span>) {       <span style=color:#75715e>// logout of passport
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>destroy</span>(<span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>) {  <span style=color:#75715e>// destroy the session
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>redirectURL</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CAS_URL</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/logout?service=&#34;</span> <span style=color:#f92672>+</span> encodeURIComponent(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CAS_SERVICE_URL</span>)
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>redirect</span>(<span style=color:#a6e22e>redirectURL</span>);
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Most CAS servers will automatically redirect the user back to the <code>service</code> request parameter, but not all of them. However, this will ensure that the CAS server knows the user has logged out and will invalidate any tickets for that user.</p><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
Test CAS Server Updated</summary><div class=box-content><p>The test CAS server was updated recently to properly redirect users back to the <code>service</code> request parameter, so you will probably no longer see the Logout page from that server in your testing. This should make developing and testing with that server a bit more straightforward</p></div></details><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=new-users>New Users</h1><a href="https://www.youtube.com/watch?v=53odl8cktpI">YouTube Video</a><h2 id=handling-new-users>Handling New Users</h2><p>What if a user logs in to our application through CAS, but we don&rsquo;t have them in our database of users? Do we want to deny them access to the application? Or should we somehow gracefully add them to the list of users and give them some basic access to our application?</p><p>Since we are building a website meant to be open to a number of users, let&rsquo;s go ahead and implement a strategy where a new user can be created in the event that a user logs on through one of our authentication strategies but isn&rsquo;t found in the database.</p><p>Thankfully, to do this is really simple - all we must do is add a few additional lines to our <code>authenticateUser</code> function in the <code>configs/auth.js</code> file:</p><div class=tab-panel data-tab-group=67f44f22808622917ca8e06cf4e4c13e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("67f44f22808622917ca8e06cf4e4c13e","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authenticateUser</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Find user with the username
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findOne</span>({ 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;username&#34;</span>],
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>include</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>model</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Role</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>as</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;roles&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;role&#34;</span>],
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>through</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [],
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>username</span> },
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  .<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#75715e>// User not found
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>user</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#75715e>// Create new user
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>      <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>create</span>({ <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>username</span>}).<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>        <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;New user created via login: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span>        
</span></span><span style=display:flex;background-color:#3c3d38><span>        <span style=color:#75715e>// Convert Sequelize object to plain JavaScript object
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>        <span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>user</span>))
</span></span><span style=display:flex;background-color:#3c3d38><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span>      })
</span></span><span style=display:flex;background-color:#3c3d38><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#75715e>// User authenticated
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;Login succeeded for user: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span>      
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#75715e>// Convert Sequelize object to plain JavaScript object
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>      <span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>user</span>))
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>(<span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span>    }
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we try to log in using any username, we&rsquo;ll either be logged in as an existing user, or a new user will be created. We can see this in our log output:</p><div class=tab-panel data-tab-group=0c59764c3e891f669172ad03acdc50f6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0c59764c3e891f669172ad03acdc50f6","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0><code>[2025-03-20 07:15:17.256 PM] http:      GET /auth/cas 302 0.697 ms - 0
[2025-03-20 07:15:23.525 PM] debug:     New user created via login: russfeld
[2025-03-20 07:15:23.564 PM] http:      GET /auth/cas?ticket=aac12881-9bea-449c-bf13-b981525cc8db 302 218.923 ms - 30
[2025-03-20 07:15:23.721 PM] http:      GET / 200 1.299 ms - -</code></pre></div></div></div></div></div><p>That&rsquo;s all there is to it! Of course, we can also configure this process to automatically assign roles to our newly created user, but for right now we won&rsquo;t worry about that.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=testing-authentication>Testing Authentication</h1><a href="https://www.youtube.com/watch?v=W4jM6hkYuks">YouTube Video</a><h2 id=testing-authentication-routes>Testing Authentication Routes</h2><p>Now that we have our authentication system working for our application, let&rsquo;s write some unit tests to confirm that it works as expected in a variety of situations.</p><p>As part of these tests, we&rsquo;ll end up creating a <a href=https://en.wikipedia.org/wiki/Test_double rel=external target=_blank>test double</a> of one part of our authentication system to make it easier to test. To do this, we&rsquo;ll use the <a href=https://sinonjs.org/ rel=external target=_blank>Sinon</a> library, so let&rsquo;s start by installing it as a development dependency:</p><div class=tab-panel data-tab-group=5a7226a385010a13e75143a8e9a316b0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5a7226a385010a13e75143a8e9a316b0","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm install --save-dev sinon</span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll store these tests in the <code>test/auth.js</code> file, starting with this content including the libraries we&rsquo;ll need to use:</p><div class=tab-panel data-tab-group=26553ec83097547f25a125a4e9209009><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("26553ec83097547f25a125a4e9209009","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file /auth Route Tests
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Load Libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>request</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;supertest&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>use</span>, <span style=color:#a6e22e>should</span>, <span style=color:#a6e22e>expect</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>chaiJsonSchemaAjv</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai-json-schema-ajv&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>chaiShallowDeepEqual</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai-shallow-deep-equal&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>sinon</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;sinon&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>jsonwebtoken</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;jsonwebtoken&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>chaiJsonSchemaAjv</span>.<span style=color:#a6e22e>create</span>({ <span style=color:#a6e22e>verbose</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> }));
</span></span><span style=display:flex><span><span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>chaiShallowDeepEqual</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Express application
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>app</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../app.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Database
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>User</span>, <span style=color:#a6e22e>Role</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../models/models.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Modify Object.prototype for BDD style assertions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>should</span>();</span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll continue to build out tests below that content in the same file.</p><h3 id=testing-bypass-authentication>Testing Bypass Authentication</h3><p>First, let&rsquo;s look at some tests for the <code>/auth/bypass</code> route, since that is the simplest. The first test is a very simple one to confirm that bypass authentication works, and also that it sets the expected cookie in the browser when it redirects the user back to the home page:</p><div class=tab-panel data-tab-group=213710f8419843b1af11a1e6a8ef95eb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("213710f8419843b1af11a1e6a8ef95eb","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Regular expression to match the expected cookie
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>regex_valid</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;^&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>SESSION_NAME</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;=\\S*; Path=/; HttpOnly$&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test Bypass authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bypassAuth</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should allow bypass login with user &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// List of existing users to be tested
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>users</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;admin&#34;</span>, <span style=color:#e6db74>&#34;contributor&#34;</span>, <span style=color:#e6db74>&#34;manager&#34;</span>, <span style=color:#e6db74>&#34;user&#34;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /bypass&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bypassAuth</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>Notice that we are using a <a href=https://en.wikipedia.org/wiki/Regular_expression rel=external target=_blank>regular expression</a> to help us verify that the cookie being sent to the user is using the correct name and has the expected content.</p><p>Next, we also should test to make sure that using bypass authentication with any unknown username will create that user:</p><div class=tab-panel data-tab-group=f2cc3e720a705a47df8d8147c6c04980><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f2cc3e720a705a47df8d8147c6c04980","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test Bypass authentication creates user
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bypassAuthCreatesUser</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should allow bypass login with new user &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findOne</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;username&#34;</span>],
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span> },
</span></span><span style=display:flex><span>        }).<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>found_user</span>) =&gt; {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>found_user</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>not</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>found_user</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;username&#34;</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>found_user</span>.<span style=color:#a6e22e>username</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /bypass&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>bypassAuth</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bypassAuthCreatesUser</span>(<span style=color:#e6db74>&#34;testuser&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>This test will first log the user in, then it will directly check the database to ensure that the user has been created successfully. Alternatively, we could also use the API, but we&rsquo;re trying to keep our tests independent, so in this case it makes the most sense to query the database directly in our test instead of any other method.</p><h3 id=testing-cas-authentication>Testing CAS Authentication</h3><p>Next, let&rsquo;s write the tests for our CAS authentication strategy. These are similar to the ones we&rsquo;ve already written, but they have some key differences as well.</p><p>First, we can write a simple test just to show that any user who visits the <code>/auth/cas</code> route will be properly redirected to the correct CAS server:</p><div class=tab-panel data-tab-group=0c50dc8900284a758ee3d986eb5cf834><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0c50dc8900284a758ee3d986eb5cf834","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test CAS authentication redirect
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>casAuthRedirect</span> <span style=color:#f92672>=</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should redirect users to CAS server&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expectedURL</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CAS_URL</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;/login?service=&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>      encodeURIComponent(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CAS_SERVICE_URL</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/auth/cas&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/cas&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#a6e22e>expectedURL</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /cas&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>casAuthRedirect</span>();
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>In this test, we are building the URL that the user should be redirected to, based on the settings we have already set in our environment file. Then, we simply check that the returned response is an HTTP 302 Found response with the correct location indicated.</p><p>The next two tests are much more complex, because they require us to mock the step where our server confirms that the user is authenticated with the CAS server by sending a request with a ticket attached, and then getting a response for that ticket. We can do this using a bit of clever coding and the <a href=https://sinonjs.org/ rel=external target=_blank>Sinon</a> library.</p><p>First, we need to mock up a response object that mimics what the server would respond with. This is mocked just so it will be understood by our CAS authentication library and may not work in all cases:</p><div class=tab-panel data-tab-group=fe58ad07c5d3cdd3e12e0bd4c5b911fb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fe58ad07c5d3cdd3e12e0bd4c5b911fb","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Helper function to generate a valid mock CAS 2.0 Ticket
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>validTicket</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>ticket</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>`&lt;cas:serviceResponse xmlns:cas=&#39;http://www.yale.edu/tp/cas&#39;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &lt;cas:authenticationSuccess&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &lt;cas:user&gt;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>user</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/cas:user&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &lt;cas:ksuPersonWildcatID&gt;</span><span style=color:#e6db74>${</span><span style=color:#ae81ff>123456789</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/cas:ksuPersonWildcatID&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>              &lt;cas:proxyGrantingTicket&gt;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>ticket</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&lt;/cas:proxyGrantingTicket&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          &lt;/cas:authenticationSuccess&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;/cas:serviceResponse&gt;`</span>;
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>This function creates an object with a single method <code>text()</code> that will return a valid XML ticket for the given user and random ticket ID.</p><p>Right below that, we can create a unit test that will mock the global <code>fetch</code> function used by our CAS authentication strategy to contact the CAS server to validate the ticket, and instead it will respond with our mock response object created above:</p><div class=tab-panel data-tab-group=64d00e7b898eead4a0f492b541038370><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("64d00e7b898eead4a0f492b541038370","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test CAS with valid ticket
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>casAuthValidTicket</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should log in user &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; via CAS&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ticket</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;abc123&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fetchStub</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sinon</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>stub</span>(<span style=color:#a6e22e>global</span>, <span style=color:#e6db74>&#34;fetch&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>resolves</span>(<span style=color:#a6e22e>validTicket</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>ticket</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/cas?ticket=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>ticket</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sinon</span>.<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>calledOnce</span>(<span style=color:#a6e22e>fetchStub</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>fetchStub</span>.<span style=color:#a6e22e>args</span>[<span style=color:#ae81ff>0</span>][<span style=color:#ae81ff>0</span>]).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>contain</span>(<span style=color:#e6db74>&#34;?ticket=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>ticket</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /cas&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>casAuthRedirect</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>casAuthValidTicket</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>In this test, we create a <code>fetchStub</code> object that is used by our CAS authentication strategy in place of <code>fetch</code>. It will confirm that the user has a valid ticket and can be authenticated, so we can perform the same steps as before and ensure that the cookie is properly set when the user is authenticated.</p><p>We also are checking that the <code>fetch</code> method we mocked was actually called once, and that it contained the ticket we provided as part of the URL. This is just a sanity check to make sure that we mocked up the correct part of our application!</p><p>We must also add a new item in the <code>afterEach()</code> hook for Mocha, which will reset all functions and objects that are mocked by Sinon after each test. This ensures we are always working with a clean slate. We&rsquo;ll update the function in <code>test/hooks.js</code> with this new content:</p><div class=tab-panel data-tab-group=8215e532577601901a1c5a425f1a5fbe><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhooksjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8215e532577601901a1c5a425f1a5fbe","testhooksjs")'>
<span class=tab-nav-text>test/hooks.js</span></button></div><div class=tab-content-container><div data-tab-item=testhooksjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e>// Import libraries
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>sinon</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;sinon&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Root Hook Runs Before Each Test
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mochaHooks</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Hook runs after each individual test
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>afterEach</span>(<span style=color:#a6e22e>done</span>) {
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#75715e>// Restore Sinon mocks
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span>    <span style=color:#a6e22e>sinon</span>.<span style=color:#a6e22e>restore</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Remove all data from the database
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>seeds</span>.<span style=color:#a6e22e>down</span>({ <span style=color:#a6e22e>to</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span> }).<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>};</span></span></code></pre></div></div></div></div></div><p>Finally, we also should confirm that logging in via CAS will create a new user if the username is not recognized. This test builds upon the previous CAS test in a way similar to the one used for bypass authentication above:</p><div class=tab-panel data-tab-group=67f8e80b68c061559199ac2bc4d569e9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("67f8e80b68c061559199ac2bc4d569e9","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test CAS creates user
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>casAuthValidTicketCreatesUser</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should create new user &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; via CAS&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ticket</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;abc123&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fetchStub</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sinon</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>stub</span>(<span style=color:#a6e22e>global</span>, <span style=color:#e6db74>&#34;fetch&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>resolves</span>(<span style=color:#a6e22e>validTicket</span>(<span style=color:#a6e22e>user</span>, <span style=color:#a6e22e>ticket</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/cas?ticket=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>ticket</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sinon</span>.<span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>calledOnce</span>(<span style=color:#a6e22e>fetchStub</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>fetchStub</span>.<span style=color:#a6e22e>args</span>[<span style=color:#ae81ff>0</span>][<span style=color:#ae81ff>0</span>]).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>contain</span>(<span style=color:#e6db74>&#34;?ticket=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>ticket</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findOne</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;username&#34;</span>],
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span> },
</span></span><span style=display:flex><span>        }).<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>found_user</span>) =&gt; {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>found_user</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>not</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>found_user</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;username&#34;</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>found_user</span>.<span style=color:#a6e22e>username</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /cas&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>casAuthRedirect</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>casAuthValidTicket</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>casAuthValidTicketCreatesUser</span>(<span style=color:#e6db74>&#34;testuser&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>As before, this will log a user in via CAS, confirm that it works, and then check in the database to make sure that the new user is properly created.</p><h3 id=testing-jwt>Testing JWT</h3><p>Now that we&rsquo;ve tested both ways to log into our application, we can write some tests to confirm that users can properly request a JWT to be used in our frontend later on. So, our first test simply checks to make sure a user with a valid session can request a token:</p><div class=tab-panel data-tab-group=219bc577179ccb4c0b45f4ef8c5e1ac8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("219bc577179ccb4c0b45f4ef8c5e1ac8","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test user can request a valid token
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userCanRequestToken</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should allow user &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; to request valid JWT&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>agent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>agent</span>(<span style=color:#a6e22e>app</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/token&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;object&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;token&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jsonwebtoken</span>.<span style=color:#a6e22e>decode</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;username&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>username</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /token&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userCanRequestToken</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCanRequestToken</span>(<span style=color:#e6db74>&#34;testuser&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>In this test, we must use a persistent browser agent to make our requests. This will ensure that any cookies or other settings are saved between requests. Thankfully, the <a href=https://www.npmjs.com/package/supertest rel=external target=_blank>Supertest</a> library we are using already has that functionality, so all we have to do is create an <code>agent</code> for our testing as shown in the test above. Once we have successfully logged in, we can confirm that the <code>/auth/token</code> endpoint sends a valid JWT that contains information about the current user. For these tests, we are using bypass authentication for simplicity, but any authentication method could be used.</p><p>When we run the tests at the bottom of the file, notice that we are running this for all existing users, as well as a newly created user. Both types of users should be able to request a token for our application.</p><p>Next, let&rsquo;s confirm that all of a user&rsquo;s roles are listed in the JWT issued for that user. This is important because, later on in this example, we&rsquo;ll be using those roles to implement role-based authorization in our application, so it is vital to make sure our JWTs include the correct roles:</p><div class=tab-panel data-tab-group=0b8c688f86ddb0adeadcf57070fd333a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0b8c688f86ddb0adeadcf57070fd333a","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test user roles are correctly listed in token
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userRolesAreCorrectInToken</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should contain correct roles for user &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; in JWT&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>agent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>agent</span>(<span style=color:#a6e22e>app</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/token&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;object&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;token&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jsonwebtoken</span>.<span style=color:#a6e22e>decode</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>User</span>.<span style=color:#a6e22e>findOne</span>({
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;username&#34;</span>],
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>include</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>model</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Role</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>as</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;roles&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;role&#34;</span>],
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>through</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                  <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> [],
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>              },
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>where</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span> },
</span></span><span style=display:flex><span>            }).<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;roles&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>length</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>expected_role</span>) =&gt; {
</span></span><span style=display:flex><span>                  <span style=color:#a6e22e>expect</span>(
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>some</span>((<span style=color:#a6e22e>role</span>) =&gt; <span style=color:#a6e22e>role</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>expected_role</span>.<span style=color:#a6e22e>id</span>),
</span></span><span style=display:flex><span>                  ).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>                });
</span></span><span style=display:flex><span>              } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>not</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>property</span>(<span style=color:#e6db74>&#34;roles&#34;</span>);
</span></span><span style=display:flex><span>              }
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /token&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userCanRequestToken</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userRolesAreCorrectInToken</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCanRequestToken</span>(<span style=color:#e6db74>&#34;testuser&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userRolesAreCorrectInToken</span>(<span style=color:#e6db74>&#34;testuser&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>This test may seem very long and verbose, but it is very straightforward. We first login and request a token for a user, and then we also look up that user in the database including all associated roles. Then, we simply assert that the number of roles in the token is the same as the number of them in the database, and if there are any roles that each role is found as expected.</p><p>Finally, we should write one additional test, that simply confirms that the application will not allow anyone to request a token if they are not currently logged in:</p><div class=tab-panel data-tab-group=21bf1f2109efd4c8743b904059eb7fc1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("21bf1f2109efd4c8743b904059eb7fc1","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * User must have a valid session to request a token
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mustBeLoggedInToRequestToken</span> <span style=color:#f92672>=</span> () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should not allow a user to request a token without logging in&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/token&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>401</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /token&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>users</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userCanRequestToken</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userRolesAreCorrectInToken</span>(<span style=color:#a6e22e>user</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userCanRequestToken</span>(<span style=color:#e6db74>&#34;testuser&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userRolesAreCorrectInToken</span>(<span style=color:#e6db74>&#34;testuser&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mustBeLoggedInToRequestToken</span>();
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>For this test, we simply check that the application returns an HTTP 401 response if the user tries to request a token without first being logged in.</p><h3 id=testing-logout>Testing Logout</h3><p>Finally, we can write a few tests to make sure our logout process is also working as expected. The first test will confirm that the session cookie we are using is properly removed from the user&rsquo;s browser when they log out:</p><div class=tab-panel data-tab-group=69a5c6a6dd73dba38af61b9b6f9595eb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("69a5c6a6dd73dba38af61b9b6f9595eb","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Regular expression to match deleting the cookie
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>regex_destroy</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;^&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>SESSION_NAME</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT$&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Logout will remove the cookie
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>logoutDestroysCookie</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should remove the cookie on logout&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re_destroy</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_destroy</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>agent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>agent</span>(<span style=color:#a6e22e>app</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/logout&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re_destroy</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /logout&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logoutDestroysCookie</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>In this test, we are looking for a second <code>set-cookie</code> header to be sent when the user logs out. This header will both contain an empty cookie, but also will set the cookie&rsquo;s expiration date to the earliest date possible. So, we can simply look for that header to confirm our cookie is being properly removed and expired from the user&rsquo;s browser when they log out. We only really have to test this for a single username, since the process is identical for all of them.</p><p>Next, we should also confirm that the logout process will redirect users to the CAS server as well and log them out of any existing CAS sessions.</p><div class=tab-panel data-tab-group=d35d3a753fcb269c5d6fd4ea04521eec><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d35d3a753fcb269c5d6fd4ea04521eec","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Regular expression for redirecting to CAS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>regex_redirect</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;^&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CAS_URL</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/logout\\?service=\\S*$&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Logout redirects to CAS
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>logoutRedirectsToCas</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should redirect to CAS on logout&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re_redirect</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_redirect</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>agent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>agent</span>(<span style=color:#a6e22e>app</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/logout&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#a6e22e>re_redirect</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /logout&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logoutDestroysCookie</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logoutRedirectsToCas</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>Once again, we are simply checking the <code>Location</code> header of the HTTP 302 Found response received from our application. We are making use of regular expressions to ensure we are being properly redirected to the correct CAS server and the <code>logout</code> route on that server.</p><p>Finally, we should confirm that once a user has logged out, they are no longer able to request a new token from the application:</p><div class=tab-panel data-tab-group=540f206f8723883d340701efb6558296><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("540f206f8723883d340701efb6558296","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Logout prevents requesting a token
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>logoutPreventsToken</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should prevent access to token after logging out&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>regex_valid</span>, <span style=color:#e6db74>&#34;gm&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>agent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>agent</span>(<span style=color:#a6e22e>app</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;Location&#34;</span>, <span style=color:#e6db74>&#34;/&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#e6db74>&#34;set-cookie&#34;</span>, <span style=color:#a6e22e>re</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/token&#34;</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>          .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>              .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/logout&#34;</span>)
</span></span><span style=display:flex><span>              .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>302</span>)
</span></span><span style=display:flex><span>              .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>                  .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/token&#34;</span>)
</span></span><span style=display:flex><span>                  .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>401</span>)
</span></span><span style=display:flex><span>                  .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>                  });
</span></span><span style=display:flex><span>              });
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /auth/ routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/auth&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /logout&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logoutDestroysCookie</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logoutRedirectsToCas</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logoutPreventsToken</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>In this test, we simply log in, request a token, then log out, and show that the application will no longer allow us to request a token, even though we are using the same user agent as before. This is a great way to confirm that our entire process is working!</p><p>Now is a great time to lint, format, and commit our code to GitHub before continuing!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=role-based-authorization>Role-Based Authorization</h1><a href="https://www.youtube.com/watch?v=KMiBMPzHRp8">YouTube Video</a><details open class="box cstyle notices warning"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-triangle"></i>
Updated Authorized Roles Middleware</summary><div class=box-content><p>The <code>authorized-roles.js</code> file shown in the video is out of date. Refer to the code below for a corrected version. Corrections are discussed in the Errata chapter.</p></div></details><h2 id=token-middlewares>Token Middlewares</h2><p>Now that we finally have a working authentication system, we can start to add role-based authorization to our application. This will ensure that only users with specific roles can perform certain actions within our RESTful API. To do this, we&rsquo;ll need to create a couple of new Express middlewares to help load the contents of our JWT into the request, and also to verify that the authenticated user has the appropriate roles to perform an action.</p><p>First, let&rsquo;s create a middleware to handle loading our JWT from an authorization header into the Express request object:</p><div class=tab-panel data-tab-group=eb0745fc92d8cb155ad6190fdff7c0cf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=middlewarestokenjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("eb0745fc92d8cb155ad6190fdff7c0cf","middlewarestokenjs")'>
<span class=tab-nav-text>middlewares/token.js</span></button></div><div class=tab-content-container><div data-tab-item=middlewarestokenjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file Middleware for reading JWTs from the Bearer header and storing them in the request
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @exports tokenMiddleware the token middleware
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>jsonwebtoken</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;jsonwebtoken&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import configurations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>logger</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;../configs/logger.js&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>tokenMiddleware</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Retrieve the token from the headers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authHeader</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>[<span style=color:#e6db74>&#39;authorization&#39;</span>]
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>authHeader</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>authHeader</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#39; &#39;</span>)[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// If the token is null in the header, send 401 unauthorized
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>token</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#39;JWT in header is null&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Verify the token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>jsonwebtoken</span>.<span style=color:#a6e22e>verify</span>(<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>JWT_SECRET_KEY</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>token</span>) =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Handle common errors
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;TokenExpiredError&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If the token is expired, send 401 unauthorized 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>end</span>()
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If the token won&#39;t parse, send 403 forbidden
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;JWT Parsing Error!&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>sendStatus</span>(<span style=color:#ae81ff>403</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Attach token to request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>token</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Call next middleware
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>tokenMiddleware</span>;</span></span></code></pre></div></div></div></div></div><p>This middleware will extract our JWT from the <code>authorization: Bearer</code> header that should be present in any request from our frontend single-page web application to our API. It then checks that the signature matches the expected signature and that the payload of the JWT has not been tampered with. It also makes sure the JWT has not expired. If all of those checks pass, then it simply attaches the contents of the JWT to the Express request object as <code>req.token</code>, so we can use it later in our application.</p><p>To use this middleware, we need to make a small change to the structure of our <code>routes/api.js</code> file to allow users to access the base API route without needing the token, but all other routes will require a valid token for access:</p><div class=tab-panel data-tab-group=2ad42feac0cca88e2aa8125e9f7a9ba1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2ad42feac0cca88e2aa8125e9f7a9ba1","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file API main router
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @exports router an Express router
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * tags:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   name: api
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   description: API routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>express</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;express&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e>// Import middleware
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>tokenMiddleware</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../middlewares/token.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import v1 routers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>rolesRouter</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./api/v1/roles.js&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>usersRouter</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;./api/v1/users.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create Express router
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>Router</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Gets the list of API versions
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} req - Express request object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} res - Express response object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Function} next - Express next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * /api/:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   get:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     summary: list API versions
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     tags: [api]
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     responses:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       200:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         description: the list of users
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         content:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *           application/json:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *             schema:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *               type: array
</span></span></span><span style=display:flex><span><span style=color:#75715e> *               items:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *                 type: object
</span></span></span><span style=display:flex><span><span style=color:#75715e> *                 properties:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *                   version:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *                     type: string
</span></span></span><span style=display:flex><span><span style=color:#75715e> *                   url:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *                     type: string
</span></span></span><span style=display:flex><span><span style=color:#75715e> *             example:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *               - version: &#34;1.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e> *                 url: /api/v1/
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>([
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>version</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>url</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;/api/v1/&#34;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  ]);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e>// Use Token Middleware
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>tokenMiddleware</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Use v1 routers after API route
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/v1/roles&#34;</span>, <span style=color:#a6e22e>rolesRouter</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>use</span>(<span style=color:#e6db74>&#34;/v1/users&#34;</span>, <span style=color:#a6e22e>usersRouter</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>router</span>;</span></span></code></pre></div></div></div></div></div><p>Here, we import our new middleware, and then we rearrange the contents of the file so that the single <code>/api</code> route comes first, then we add our middleware and the rest of the API routes at the end of the file. Remember that everything in Express is executed in the order it is attached to the application, so in this way any routes that occur before our middleware is attached can be accessed without a valid JWT, but any routes or routers added afterward will require a valid JWT for access.</p><h2 id=role-middleware>Role Middleware</h2><p>Next, we can create another middleware function that will check if a user has the appropriate roles to perform an operation via our API. However, instead of writing a simple function as our middleware, or even writing a number of different functions for each possible role, we can take advantage of one of the most powerful features of JavaScript - we can create a function that <em>returns</em> another function! Let&rsquo;s take a look and see how it works:</p><div class=tab-panel data-tab-group=61c3aae6839960ab62d3e3badc482142><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=middlewaresauthorized-rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("61c3aae6839960ab62d3e3badc482142","middlewaresauthorized-rolesjs")'>
<span class=tab-nav-text>middlewares/authorized-roles.js</span></button></div><div class=tab-content-container><div data-tab-item=middlewaresauthorized-rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file Middleware for role-based authorization
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @exports roleBasedAuth middleware
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import configurations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>logger</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../configs/logger.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Build a middleware function to validate a user has one of a list of roles
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param  {...any} roles a list of roles that are valid for this operation
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @returns a middleware function for those roles.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>roleBasedAuth</span> <span style=color:#f92672>=</span> (...<span style=color:#a6e22e>roles</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>roleAuthMiddleware</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;Route requires roles: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>roles</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>debug</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;User &#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>username</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34; has roles: &#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>r</span>) =&gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>role</span>).<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#34;,&#34;</span>),
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>match</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// loop through each role given
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>role</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// if the user has that role, then they can proceed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>some</span>((<span style=color:#a6e22e>r</span>) =&gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>role</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>role</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;Role match!&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>match</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>match</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>match</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// if no roles match, send an unauthenticated response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;No role match!&#34;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>401</span>).<span style=color:#a6e22e>send</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>roleBasedAuth</span>;</span></span></code></pre></div></div></div></div></div><p>This file contains a function named <code>roleBasedAuth</code> that accepts a list of roles as parameters (they can be provided directly or as an array, but either way we can treat them like an array in our code). Then, we will <em>return</em> a new middleware function named <code>roleAuthMiddleware</code> that will check to see if the currently authenticated user (indicated by <code>req.token</code>) has at least one of the named roles. If so, then there is a match and the user should be able to perform the operation. If the user does not have any of the roles listed, then the user should not be able to perform the operation and a 401 Unauthorized response should be sent. This file also includes some helpful logging information to help ensure things are working properly.</p><h2 id=implementing-role-based-authorization>Implementing Role-Based Authorization</h2><p>Finally, let&rsquo;s look at how we can use that middleware function to implement role-based authorization in our application. Let&rsquo;s start simple - in this instance, we can update our <code>GET /api/v1/roles/</code> operation to require the user to have the <code>manage_users</code> role in order to list all possible roles in the application. To do this, we can import our new middleware function in the <code>routes/api/v1/roles.js</code> file, and then call that function to create a new middleware function to use in that file:</p><div class=tab-panel data-tab-group=034f37177278d430937ecada68954d20><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("034f37177278d430937ecada68954d20","routesapiv1rolesjs")'>
<span class=tab-nav-text>routes/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file Roles router
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @exports router an Express router
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * tags:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   name: roles
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   description: Roles Routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>express</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;express&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create Express router
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>Router</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import models
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Role</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../../models/models.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import logger
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>logger</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../../configs/logger.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e>// Import middlewares
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>roleBasedAuth</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../../middlewares/authorized-roles.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Gets the list of roles
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} req - Express request object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Object} res - Express response object
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Function} next - Express next middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * /api/v1/roles:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   get:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     summary: roles list page
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     description: Gets the list of all roles in the application
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     tags: [roles]
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e> *     security:
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e> *       - bearerAuth:
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e> *         - &#39;manage_users&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e> *     responses:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *       200:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         description: the list of roles
</span></span></span><span style=display:flex><span><span style=color:#75715e> *         content:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *           application/json:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *             schema:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *               type: array
</span></span></span><span style=display:flex><span><span style=color:#75715e> *               items:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *                 $ref: &#39;#/components/schemas/Role&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>roleBasedAuth</span>(<span style=color:#e6db74>&#34;manage_users&#34;</span>), <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>roles</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Role</span>.<span style=color:#a6e22e>findAll</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>(<span style=color:#a6e22e>roles</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>router</span>;</span></span></code></pre></div></div></div></div></div><p>Notice here that we are calling the <code>roleBasedAuth</code> function when we add it to our endpoint, which in turn will return a new middleware function that will be called anytime this endpoint is accessed. It is a bit complicated and confusing at first, but hopefully it makes sense.</p><p>We also have added a new <code>security</code> item to our Open API documentation, which allows us to test this route by providing a JWT through the Open API documentation website. We can even include the specific roles that are able to access this endpoint, but as of this writing it is only part of the Open API 3.1 spec but is not supported by the <code>swagger-ui</code> library so it won&rsquo;t appear on our documentation page.</p><p>Let&rsquo;s test it now by starting our server in development mode:</p><div class=tab-panel data-tab-group=c8d48162fdedca118922020dab93a86e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c8d48162fdedca118922020dab93a86e","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once we have loaded our page, let&rsquo;s go ahead and log in as the <code>admin</code> user by navigating to <code>/auth/bypass?token=admin</code> - this will return us to our home page, but now we have an active session we can use.</p><p>Once we have done that, we can now go to the <code>/docs</code> route to view our documentation. We should now notice that there is a new <code>Authorize</code> button at the top of the page:</p><p><a href=#R-image-2f6ecce2fe4b08117b16e1cf83a7eddd class=lightbox-link><img alt="OpenAPI Authorize" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_11.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2f6ecce2fe4b08117b16e1cf83a7eddd><img alt="OpenAPI Authorize" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_11.png></a></p><p>In addition, if we scroll down to find our <code>/api/v1/roles</code> route, we should also see that it now has a lock icon next to it, showing that it requires authentication before we can access it:</p><p><a href=#R-image-29db202db8897e0cd3e9caab44a48ffb class=lightbox-link><img alt="OpenAPI Protected Route" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_12.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-29db202db8897e0cd3e9caab44a48ffb><img alt="OpenAPI Protected Route" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_12.png></a></p><p>If we try to test that route now, even though we have a valid session cookie session, it should give us a 401 Unauthorized response because we aren&rsquo;t providing a valid JWT as part of our request:</p><p><a href=#R-image-d9d5010933b18f31750bf7bf2b2251e2 class=lightbox-link><img alt="Unauthorized Response" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_13.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d9d5010933b18f31750bf7bf2b2251e2><img alt="Unauthorized Response" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_13.png></a></p><p>To fix this, we need to authorize our application using a valid JWT. Thankfully, we can request one by finding the <code>/auth/token</code> route in our documentation and executing that route:</p><p><a href=#R-image-d0c13809e0eeaf7d6b534740720f9b37 class=lightbox-link><img alt="Requesting JWT" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_14.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d0c13809e0eeaf7d6b534740720f9b37><img alt="Requesting JWT" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_14.png></a></p><p>Once we have that, we can click the new Authorize button at the top, and paste the text of that token in the window that pops up. We just need the raw part of the JWT in quotes that is the value of the <code>token</code> property, without the quotes themselves included:</p><p><a href=#R-image-915f7bc2cf498295ec1aec1b4022b383 class=lightbox-link><img alt="Authorizing with JWT" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_15.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-915f7bc2cf498295ec1aec1b4022b383><img alt="Authorizing with JWT" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_15.png></a></p><p>Finally, once that has been done, we can try the <code>/api/v1/roles</code> route again, and it should now let us access that route:</p><p><a href=#R-image-1afa4ccc51bc9ecf73768d769597bf9b class=lightbox-link><img alt="Working Request" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/auth_16.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1afa4ccc51bc9ecf73768d769597bf9b><img alt="Working Request" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_16.png></a></p><p>We can also see that it is properly using our role-based authorization by checking the debug output of our application:</p><div class=tab-panel data-tab-group=a7797ebc0296dd76e38a35e2af7a3a28><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a7797ebc0296dd76e38a35e2af7a3a28","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0><code>[2025-03-21 12:54:14.085 AM] debug:     Route requires roles: manage_users
[2025-03-21 12:54:14.085 AM] debug:     User admin has roles: manage_users,manage_documents,manage_communities
[2025-03-21 12:54:14.086 AM] debug:     Role match!
[2025-03-21 12:54:14.087 AM] sql:       Executing (default): SELECT `id`, `role`, `createdAt`, `updatedAt` FROM `roles` AS `Role`;
[2025-03-21 12:54:14.090 AM] http:      GET /api/v1/roles 200 9.553 ms - 784</code></pre></div></div></div></div></div><p>There we go! That is all it takes to add role-based authorization to our application. Next, we&rsquo;ll look at how to update our unit tests to use our new authentication system and roles.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=updating-tests>Updating Tests</h1><a href="https://www.youtube.com/watch?v=k43QEMKxO9Y">YouTube Video</a><h2 id=updating-unit-tests>Updating Unit Tests</h2><p>Of course, now that we&rsquo;re requiring a valid JWT for all API routes, and adding role-based authorization for most routes, all of our existing API unit tests now longer work. So, let&rsquo;s work on updating those tests to use our new authentication system.</p><p>First, let&rsquo;s build a simple helper function we can use to easily log in as a user and request a token to use in our application. We&rsquo;ll place this in a new file named <code>test/helpers.js</code>:</p><div class=tab-panel data-tab-group=b95ef1d2e740c33a49bbb786742e2c93><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b95ef1d2e740c33a49bbb786742e2c93","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file Unit Test Helpers
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>request</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;supertest&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>app</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../app.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>login</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>user</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>agent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>agent</span>(<span style=color:#a6e22e>app</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>agent</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/bypass?token=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>user</span>).<span style=color:#a6e22e>then</span>(() =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>agent</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/auth/token&#34;</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>token</span>;
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};</span></span></code></pre></div></div></div></div></div><p>This file is pretty straightforward - it simply uses the bypass login system to authenticate as a user, then it requests a token and returns it. It assumes that all other parts of the authentication process work properly - we can do this because we already have unit tests to check that functionality.</p><p>Now, let&rsquo;s use this in our <code>test/api/v1/roles.js</code> file by adding a few new lines to each test. We&rsquo;ll start with the simple <code>getAllRoles</code> test:</p><div class=tab-panel data-tab-group=e67cfcb470c8aab5c325ff5311aaf8b1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e67cfcb470c8aab5c325ff5311aaf8b1","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file /api/v1/roles Route Tests
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Load Libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>request</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;supertest&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>use</span>, <span style=color:#a6e22e>should</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Ajv</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;ajv&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>addFormats</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;ajv-formats&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>chaiJsonSchemaAjv</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai-json-schema-ajv&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>chaiShallowDeepEqual</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai-shallow-deep-equal&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Express application
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>app</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../../app.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e>// Import Helpers
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>login</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../helpers.js&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Configure Chai and AJV
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ajv</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Ajv</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>addFormats</span>(<span style=color:#a6e22e>ajv</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>chaiJsonSchemaAjv</span>.<span style=color:#a6e22e>create</span>({ <span style=color:#a6e22e>ajv</span>, <span style=color:#a6e22e>verbose</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> }));
</span></span><span style=display:flex><span><span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>chaiShallowDeepEqual</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Modify Object.prototype for BDD style assertions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>should</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Get all Roles
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getAllRoles</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>state</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should list all roles&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/roles&#34;</span>)
</span></span><span style=display:flex;background-color:#3c3d38><span>      .<span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;Authorization&#39;</span>, <span style=color:#e6db74>`Bearer </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;array&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>lengthOf</span>(<span style=color:#ae81ff>7</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/roles route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/roles&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /&#34;</span>, () =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>beforeEach</span>(<span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>login</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>getAllRoles</span>(<span style=color:#a6e22e>state</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>To update this test, we have created a new <code>state</code> object that is present in our <code>describe</code> block at the bottom of the test. That <code>state</code> object can store various things we&rsquo;ll use in our tests, but for now we&rsquo;ll just use it to store a valid JWT for our application. Then, in a <code>beforeEach</code> <a href=https://mochajs.org/#hooks rel=external target=_blank>Mocha hook</a>, we use the <code>login</code> helper we created earlier to log in as the &ldquo;admin&rdquo; user and store a valid JWT for that user in the <code>state.token</code> property.</p><p>Then, we pass that <code>state</code> object to the <code>getAllRoles</code> test. Inside of that test, we use the <code>state.token</code> property to set an <code>Authorization: Bearer</code> header for our request to the API. If everything works correctly, this test should now pass.</p><p>We can make similar updates to the other tests in this file:</p><div class=tab-panel data-tab-group=f087e091685af135911a5cdc3186c03a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f087e091685af135911a5cdc3186c03a","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Check JSON Schema of Roles
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getRolesSchemaMatch</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>state</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;all roles should match schema&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>schema</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;array&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>items</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;object&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#34;id&#34;</span>, <span style=color:#e6db74>&#34;role&#34;</span>],
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>properties</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;number&#34;</span> },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;string&#34;</span> },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>createdAt</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;string&#34;</span>, <span style=color:#a6e22e>format</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;iso-date-time&#34;</span> },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>updatedAt</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;string&#34;</span>, <span style=color:#a6e22e>format</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;iso-date-time&#34;</span> },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>additionalProperties</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/roles&#34;</span>)
</span></span><span style=display:flex;background-color:#3c3d38><span>      .<span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;Authorization&#39;</span>, <span style=color:#e6db74>`Bearer </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>jsonSchema</span>(<span style=color:#a6e22e>schema</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Check Role exists in list
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>findRole</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>role</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should contain &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>role</span>.<span style=color:#a6e22e>role</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; role&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/roles&#34;</span>)
</span></span><span style=display:flex;background-color:#3c3d38><span>      .<span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#39;Authorization&#39;</span>, <span style=color:#e6db74>`Bearer </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>foundRole</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>find</span>((<span style=color:#a6e22e>r</span>) =&gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>id</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>role</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>foundRole</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>shallowDeepEqual</span>(<span style=color:#a6e22e>role</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/roles route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/roles&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>beforeEach</span>(<span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>login</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>getAllRoles</span>(<span style=color:#a6e22e>state</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>getRolesSchemaMatch</span>(<span style=color:#a6e22e>state</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>findRole</span>(<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>r</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>This will ensure that each RESTful API action will work properly with an authenticated user, but it doesn&rsquo;t test whether the user has the proper role to perform the action (in this instance, we are using the <code>admin</code> user which has the appropriate role already). On the next page, we&rsquo;ll build a very flexible system to perform unit testing on our role-based authorization middleware.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=testing-roles>Testing Roles</h1><a href="https://www.youtube.com/watch?v=lolT-mwmFvc">YouTube Video</a><h2 id=testing-role-based-authorization-middleware>Testing Role-Based Authorization Middleware</h2><p>Earlier in this example we created a generator function named <code>roleBasedAuth</code> (stored in <code>middlewares/authorized-roles.js</code>) that returns a middleware function named <code>roleAuthMiddleware</code> that we can use as a middleware in any of our RESTful API endpoints to ensure that only users with specific roles are able to perform each and every action in our API.</p><p>When it comes to testing, however, this can quickly become really complex. For example, if we have 15 routes and 6 user roles, we must write 120 tests just to test each combination of route and role in order to truly test this setup.</p><p>In addition, if we continue to use our current strategy of integration testing (where each test performs a full action on the API), the tests we write will need to be unique for each endpoint, so even if we simplify things, we&rsquo;ll still need at least 2 tests per endpoint (one for roles that should have access, and another for roles that should not).</p><p>Instead, let&rsquo;s look at a way we can deconstruct our Express application a bit to test two things directly:</p><ol><li>Is the <code>roleAuthMiddleware</code> present on each route?</li><li>Does the <code>roleAuthMiddleware</code> function allow the correct roles for each route?</li></ol><p>If we can confirm both of these for each route, we can assume that our role-based authorization is implemented correctly.</p><h2 id=express-route-stack>Express Route Stack</h2><p>As you may recall, applications written in Express consist of an application that has middlewares and handlers attached in a specific order. In addition, we can create smaller components called routers that each have their own middlewares and handlers attached. Overall, we may end up with a structure similar to this one:</p><p><a href=#R-image-1f72d37c96ab680e793e1225d9a0c520 class=lightbox-link><img alt="Express Architecture" class="border lazy lightbox figure-image" loading=lazy src=/cis526/images/examples/04/express-routing-http.svg style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1f72d37c96ab680e793e1225d9a0c520><img alt="Express Architecture" class="border lazy lightbox lightbox-image" loading=lazy src=/cis526/images/examples/04/express-routing-http.svg></a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>A more detailed explanation of the structure of Express applications can be found here: <a href=https://www.sohamkamani.com/nodejs/expressjs-architecture/ rel=external target=_blank>https://www.sohamkamani.com/nodejs/expressjs-architecture/</a></p><p>In code, each Express router has a <code>stack</code> variable that contains a list of layers, which can either be middleware functions or actual route handlers. Middleware layers will contain the <code>name</code> of the middleware function, whereas route handlers can be checked using a <code>match</code> function to determine if the handler matches a given path.</p><p>So, in our <code>test/helpers.js</code> file, we can write a new helper function to this for our tests:</p><div class=tab-panel data-tab-group=f745d50aaab1b1453aeb15ce06fa80ff><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f745d50aaab1b1453aeb15ce06fa80ff","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Iterate through the router stack of an Express app to find a matching middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> * attached to a particular path and/or method
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {string} name the name of the function to find
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {string} path the path of the endpoint
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {string} method the HTTP method of the endpoint
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {Router} router The Express router to search
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @returns
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>findMiddlewareFunction</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>method</span>, <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>_router</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Replace blank paths with the default / path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>layer</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>stack</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Return if the middleware function is found
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>name</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>handle</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>match</span>(<span style=color:#a6e22e>path</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Recurse into a router
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;router&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>          <span style=color:#75715e>// Remove matching portion of path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>slice</span>(<span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>findMiddlewareFunction</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>method</span>, <span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>handle</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Find matching handler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>route</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>route</span>.<span style=color:#a6e22e>methods</span>[<span style=color:#a6e22e>method</span>]) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>findMiddlewareFunction</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>method</span>, <span style=color:#a6e22e>layer</span>.<span style=color:#a6e22e>route</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><details open class="box cstyle notices note"><summary class=box-label tabindex=-1><i class="fa-fw fas fa-exclamation-circle"></i>
Express 5.0 Updates</summary><div class=box-content><p>Starting with Express version 5.0, <code>app._router</code> has been moved to <code>app.router</code> to make accessing the built-in router easier. This should be updated in the code above if you are running Express 5.0 or later. <a href=https://expressjs.com/en/guide/migrating-5.html#app.router rel=external target=_blank>Changelog</a></p></div></details><p>Using that function, we can now write another function to actually test our middleware using some mock objects:</p><div class=tab-panel data-tab-group=44e76a1ed24f795f365b1ef5ec90f284><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("44e76a1ed24f795f365b1ef5ec90f284","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>request</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;supertest&#34;</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai&#34;</span>;
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>sinon</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;sinon&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test if a role is able to access the route via the roleAuthMiddleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {string} path the path of the endpoint
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {string} method the HTTP method of the endpoint
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {string} role the role to search for
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param {boolean} allowed whether the role should be allowed to access the route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>testRoleBasedAuth</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>method</span>, <span style=color:#a6e22e>role</span>, <span style=color:#a6e22e>allowed</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;should role &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>role</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; access &#39;&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>method</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>allowed</span>,
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Mock Express Request object with token attached
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>req</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>token</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>roles</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>role</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Mock Express Response object
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>sinon</span>.<span style=color:#a6e22e>stub</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>send</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>sinon</span>.<span style=color:#a6e22e>stub</span>(),
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>returns</span>(<span style=color:#a6e22e>res</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Mock Express Next Middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>sinon</span>.<span style=color:#a6e22e>stub</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Find the middleware function in the router stack for the given path and method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>middleware</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>findMiddlewareFunction</span>(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;roleAuthMiddleware&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>path</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span>,
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>middleware</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>not</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Call the middleware function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>middleware</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>next</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>allowed</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// If allowed, expect the `next` function to be called
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>calledOnce</span>).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Otherwise, it should send a 401 response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>calledWith</span>(<span style=color:#ae81ff>401</span>)).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>};</span></span></code></pre></div></div></div></div></div><p>The comments in the function describe how it works pretty clearly. Most of the code is just setting up barebones mock objects using <a href=https://sinonjs.org/ rel=external target=_blank>Sinon</a> for the Express request <code>req</code>, response <code>res</code>, and <code>next</code> middleware function. Once it finds our <code>roleAuthMiddleware</code> function in the router stack using the helper function above, it will call it and observe the response to determine if the user was allowed to access the desired endpoint or not.</p><p>The last thing we&rsquo;ll add to our <code>test/helpers.js</code> file is a helpful list of all of the roles available in the application, which we can use for our testing:</p><div class=tab-panel data-tab-group=01105af4edcfadf04c04dc81eb680ab9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhelpersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("01105af4edcfadf04c04dc81eb680ab9","testhelpersjs")'>
<span class=tab-nav-text>test/helpers.js</span></button></div><div class=tab-content-container><div data-tab-item=testhelpersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// List of global roles
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>all_roles</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;manage_users&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;manage_documents&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;add_documents&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;manage_communities&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;add_communities&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;view_documents&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;view_communities&#34;</span>,
</span></span><span style=display:flex><span>];</span></span></code></pre></div></div></div></div></div><p>With those helpers in place, we can now add a few lines to our <code>test/api/v1/roles.js</code> test file to check whether each and every role can access the endpoint in that router.</p><div class=tab-panel data-tab-group=4c5f68979123d2b05f4159402a1a935a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4c5f68979123d2b05f4159402a1a935a","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Helpers
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>login</span>, <span style=color:#a6e22e>testRoleBasedAuth</span>, <span style=color:#a6e22e>all_roles</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../helpers.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/roles route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/roles&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>allowed_roles</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;manage_users&#34;</span>];
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>all_roles</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#a6e22e>testRoleBasedAuth</span>(<span style=color:#e6db74>&#34;/api/v1/roles&#34;</span>, <span style=color:#e6db74>&#34;get&#34;</span>, <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>allowed_roles</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>r</span>))
</span></span><span style=display:flex;background-color:#3c3d38><span>    })
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>This code does a couple of very nifty things. First, we clearly define which roles should be allowed to access the endpoint. This can be done as part of the unit testing file here, or we may have some global file in our test suite that documents each role and route that we can read from.</p><p>Below that, we iterate through the list of all roles exported from the <code>test/helpers.js</code> file, and call our <code>testRoleBasedAuth</code> method for each one of those roles. The last argument to that function is a boolean that determines whether the role should be able to access this route. To determine that, we simply see if the role from the list of global roles can also be found in the list of allowed roles. If so, that will be <code>true</code> and the function will check that the role can access the route. If not, it will be <code>false</code> and the function will confirm that the user is unable to access the route.</p><p>Now, when we run these tests, we&rsquo;ll see that each role is explicitly checked:</p><div class=tab-panel data-tab-group=9df7bfd08827064bed1c3cdc265807e1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9df7bfd08827064bed1c3cdc265807e1","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0><code>  /api/v1/roles
    GET /
      ✔ should list all roles
      ✔ all roles should match schema
      ✔ should contain &#39;manage_users&#39; role
      ✔ should contain &#39;manage_documents&#39; role
      ✔ should contain &#39;add_documents&#39; role
      ✔ should contain &#39;manage_communities&#39; role
      ✔ should contain &#39;add_communities&#39; role
      ✔ should contain &#39;view_documents&#39; role
      ✔ should contain &#39;view_communities&#39; role
      ✔ should role &#39;manage_users&#39; access &#39;get /api/v1/roles&#39;: true
      ✔ should role &#39;manage_documents&#39; access &#39;get /api/v1/roles&#39;: false
      ✔ should role &#39;add_documents&#39; access &#39;get /api/v1/roles&#39;: false
      ✔ should role &#39;manage_communities&#39; access &#39;get /api/v1/roles&#39;: false
      ✔ should role &#39;add_communities&#39; access &#39;get /api/v1/roles&#39;: false
      ✔ should role &#39;view_documents&#39; access &#39;get /api/v1/roles&#39;: false
      ✔ should role &#39;view_communities&#39; access &#39;get /api/v1/roles&#39;: false</code></pre></div></div></div></div></div><p>There we go! We now have a very flexible way to test our role-based authorization.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Image Source: <a href=https://www.sohamkamani.com/nodejs/expressjs-architecture/ rel=external target=_blank>https://www.sohamkamani.com/nodejs/expressjs-architecture/</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=users-api-updates>Users API Updates</h1><a href="https://www.youtube.com/watch?v=9aIS1mF5J-Y">YouTube Video</a><h2 id=users-api-roles>Users API Roles</h2><p>We should also add our role-based authorization middleware to our <code>/api/v1/users</code> routes. This can actually be done really simply, because we only want users with the <code>manage_users</code> role to be able to access any of these routes.</p><p>So, instead of attaching the middleware to each handler individually, we can attach it directly to the router before any handlers:</p><div class=tab-panel data-tab-group=1f2f6643c42411f1704fb6b16d8fd176><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1f2f6643c42411f1704fb6b16d8fd176","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file Users router
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @exports router an Express router
</span></span></span><span style=display:flex><span><span style=color:#75715e> *
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @swagger
</span></span></span><span style=display:flex><span><span style=color:#75715e> * tags:
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   name: users
</span></span></span><span style=display:flex><span><span style=color:#75715e> *   description: Users Routes
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>express</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;express&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ValidationError</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;sequelize&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create Express router
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>Router</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import models
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>User</span>, <span style=color:#a6e22e>Role</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../../models/models.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import logger
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>logger</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../../configs/logger.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import database
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>database</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../../configs/database.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e>// Import middlewares
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>roleBasedAuth</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../../middlewares/authorized-roles.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import utilities
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>handleValidationError</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../../utilities/handle-validation-error.js&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>sendSuccess</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../../utilities/send-success.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e>// Add Role Authorization to all routes
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>roleBasedAuth</span>(<span style=color:#e6db74>&#34;manage_users&#34;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>That&rsquo;s all it takes to add role-based authorization to an entire router! It is really simple.</p><p>We also should remember to add the new <code>security</code> section to our Open API documentation comments for each route to ensure that our documentation properly displays that each route requires authentication.</p><h2 id=users-api-unit-tests---authentication>Users API Unit Tests - Authentication</h2><p>As part of our updates, we need to add authentication to each of our unit tests for the <code>/api/v1/users</code> routes. This is relatively straightforward based on what we did in the previous page - it just requires a few tweaks per test.</p><p>In short, we need to add a <code>state</code> variable that we can use that contains a token for a user, and then pass that along to each test. We can do this in the global <code>describe</code> section at the bottom:</p><div class=tab-panel data-tab-group=e7d5330bec0f748950e1817356e19b69><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e7d5330bec0f748950e1817356e19b69","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @file /api/v1/users Route Tests
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Load Libraries
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>request</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;supertest&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>use</span>, <span style=color:#a6e22e>should</span>, <span style=color:#a6e22e>expect</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Ajv</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;ajv&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>addFormats</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;ajv-formats&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>chaiJsonSchemaAjv</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai-json-schema-ajv&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>chaiShallowDeepEqual</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;chai-shallow-deep-equal&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Import Express application
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>app</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../../app.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e>// Import Helpers
</span></span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>login</span>, <span style=color:#a6e22e>testRoleBasedAuth</span>, <span style=color:#a6e22e>all_roles</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#34;../../helpers.js&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/users route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, () =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span>  <span style=color:#a6e22e>beforeEach</span>(<span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>login</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex;background-color:#3c3d38><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});</span></span></code></pre></div></div></div></div></div><p>Notice that we are able to add that code outside of the <code>describe</code> sections for each API endpoint, greatly simplifying things. Of course, if we need to log in as multiple users, we can either add additional tokens to the <code>state</code> or move the <code>state</code> and <code>beforeEach</code> methods to other locations in the code.</p><p>Once we have our state, we can simply pass it on to the tests and update each test to use it correctly by setting an <code>Authorization: Bearer</code> header on each request:</p><div class=tab-panel data-tab-group=18ad503498a469dfd19691c3e6a5d1d0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("18ad503498a469dfd19691c3e6a5d1d0","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Get all Users
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getAllUsers</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>state</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;should list all users&#34;</span>, (<span style=color:#a6e22e>done</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>request</span>(<span style=color:#a6e22e>app</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>)
</span></span><span style=display:flex;background-color:#3c3d38><span>      .<span style=color:#a6e22e>set</span>(<span style=color:#e6db74>&#34;Authorization&#34;</span>, <span style=color:#e6db74>`Bearer </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>expect</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>end</span>((<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>done</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>an</span>(<span style=color:#e6db74>&#34;array&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>should</span>.<span style=color:#a6e22e>have</span>.<span style=color:#a6e22e>lengthOf</span>(<span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>done</span>();
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/users route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>beforeEach</span>(<span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>login</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /&#34;</span>, () =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>getAllUsers</span>(<span style=color:#a6e22e>state</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});</span></span></code></pre></div></div></div></div></div><p>We won&rsquo;t exhaustively show each update to these tests here since there are so many. Take the time now to update all of the <code>/api/v1/users</code> unit tests to include authentication before continuing. They should all pass once authentication is enabled.</p><h2 id=users-api-unit-tests---role-based-authorization>Users API Unit Tests - Role-Based Authorization</h2><p>Finally, we should add additional unit tests to ensure that each endpoint in the <code>/api/v1/users</code> router is accessible only by users with the correct role. For that, we can simply add a block of code similar to what we did in the <code>roles</code> routes for each endpoint:</p><div class=tab-panel data-tab-group=df925055080b3e3d3dc0e57c21ab5f80><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("df925055080b3e3d3dc0e57c21ab5f80","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight dir=auto><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Test /api/v1/users route
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>beforeEach</span>(<span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>token</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>login</span>(<span style=color:#e6db74>&#34;admin&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>allowed_roles</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;manage_users&#34;</span>];
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>all_roles</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#a6e22e>testRoleBasedAuth</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, <span style=color:#e6db74>&#34;get&#34;</span>, <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>allowed_roles</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>r</span>))
</span></span><span style=display:flex;background-color:#3c3d38><span>    })
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;GET /{id}&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>allowed_roles</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;manage_users&#34;</span>];
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>all_roles</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#a6e22e>testRoleBasedAuth</span>(<span style=color:#e6db74>&#34;/api/v1/users/1&#34;</span>, <span style=color:#e6db74>&#34;get&#34;</span>, <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>allowed_roles</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>r</span>))
</span></span><span style=display:flex;background-color:#3c3d38><span>    })
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;POST /&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>allowed_roles</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;manage_users&#34;</span>];
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>all_roles</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#a6e22e>testRoleBasedAuth</span>(<span style=color:#e6db74>&#34;/api/v1/users&#34;</span>, <span style=color:#e6db74>&#34;post&#34;</span>, <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>allowed_roles</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>r</span>))
</span></span><span style=display:flex;background-color:#3c3d38><span>    })
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;PUT /{id}&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>allowed_roles</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;manage_users&#34;</span>];
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>all_roles</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#a6e22e>testRoleBasedAuth</span>(<span style=color:#e6db74>&#34;/api/v1/users/1&#34;</span>, <span style=color:#e6db74>&#34;put&#34;</span>, <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>allowed_roles</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>r</span>))
</span></span><span style=display:flex;background-color:#3c3d38><span>    })
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;DELETE /{id}&#34;</span>, () =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// -=-=- other code omitted here -=-=-
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>allowed_roles</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;manage_users&#34;</span>];
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#a6e22e>all_roles</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>r</span>) =&gt; {
</span></span><span style=display:flex;background-color:#3c3d38><span>      <span style=color:#a6e22e>testRoleBasedAuth</span>(<span style=color:#e6db74>&#34;/api/v1/users/1&#34;</span>, <span style=color:#e6db74>&#34;delete&#34;</span>, <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>allowed_roles</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>r</span>))
</span></span><span style=display:flex;background-color:#3c3d38><span>    })
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});</span></span></code></pre></div></div></div></div></div><p>All told, there should now be 88 total unit test in that file alone - that is a lot of tests for just 5 API endpoints!</p><p>Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub.</p><p>That concludes the first set of tutorials for building a RESTful API. In the next set of tutorials, we&rsquo;ll focus on building a Vue.js frontend for our application.</p><footer class=footline></footer></article></section></div></main></div><script src=/cis526/js/clipboard/clipboard.min.js?1769118339 defer></script><script src=/cis526/js/perfect-scrollbar/perfect-scrollbar.min.js?1769118339 defer></script><script src=/cis526/js/theme.min.js?1769118339 defer></script></div><script src=/cis526/js/tele-scroll.min.js?1769118339 defer></script></body></html>
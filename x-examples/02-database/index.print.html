<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="This example project builds on the previous Express Starter Project by adding a database. A database is a powerful way to store and retrieve the data used by our web application.
To accomplish this, weâ€™ll learn about different libraries that interface between our application and a database. Once weâ€™ve installed a library, weâ€™ll discover how to use that library to create database tables, add initial data to those tables, and then easily access them within our application."><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Adding a Database :: CIS 526 Textbook"><meta name=twitter:description content="This example project builds on the previous Express Starter Project by adding a database. A database is a powerful way to store and retrieve the data used by our web application.
To accomplish this, weâ€™ll learn about different libraries that interface between our application and a database. Once weâ€™ve installed a library, weâ€™ll discover how to use that library to create database tables, add initial data to those tables, and then easily access them within our application."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/02-database/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Adding a Database :: CIS 526 Textbook"><meta property="og:description" content="This example project builds on the previous Express Starter Project by adding a database. A database is a powerful way to store and retrieve the data used by our web application.
To accomplish this, weâ€™ll learn about different libraries that interface between our application and a database. Once weâ€™ve installed a library, weâ€™ll discover how to use that library to create database tables, add initial data to those tables, and then easily access them within our application."><meta property="og:locale" content="en-us"><meta property="og:type" content="website"><meta itemprop=name content="Adding a Database :: CIS 526 Textbook"><meta itemprop=description content="This example project builds on the previous Express Starter Project by adding a database. A database is a powerful way to store and retrieve the data used by our web application.
To accomplish this, weâ€™ll learn about different libraries that interface between our application and a database. Once weâ€™ve installed a library, weâ€™ll discover how to use that library to create database tables, add initial data to those tables, and then easily access them within our application."><meta itemprop=dateModified content="2025-02-03T15:11:09-06:00"><meta itemprop=wordCount content="171"><title>Adding a Database :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/x-examples/02-database/ rel=canonical type=text/html title="Adding a Database :: CIS 526 Textbook"><link href=/cis526/x-examples/02-database/index.xml rel=alternate type=application/rss+xml title="Adding a Database :: CIS 526 Textbook"><link href=/cis526/x-examples/02-database/tele.html rel=alternate type=text/html title="Adding a Database :: CIS 526 Textbook"><link href=/cis526/x-examples/02-database/embed.html rel=alternate type=text/html title="Adding a Database :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1744316876 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1744316876 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1744316876 rel=stylesheet><link href=/cis526/css/auto-complete.css?1744316876 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1744316876 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1744316876 rel=stylesheet><link href=/cis526/css/fonts.css?1744316876 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1744316876 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1744316876 rel=stylesheet><link href=/cis526/css/theme-auto.css?1744316876 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1744316876 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1744316876 rel=stylesheet><link href=/cis526/css/print.css?1744316876 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1744316876 rel=stylesheet><script src=/cis526/js/variant.js?1744316876></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../..",window.relearn.relBaseUri="../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1744316876 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/x-examples/02-database/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/cis526/x-examples/><span itemprop=name>Example Projects</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Adding a Database</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/01-express-starter/11-summary/ title="Summary (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/02-database/01-sequelize/ title="Sequelize (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=adding-a-database>Adding a Database</h1><p>This example project builds on the previous Express Starter Project by adding a database. A database is a powerful way to store and retrieve the data used by our web application.</p><p>To accomplish this, we&rsquo;ll learn about different libraries that interface between our application and a database. Once we&rsquo;ve installed a library, we&rsquo;ll discover how to use that library to create database tables, add initial data to those tables, and then easily access them within our application.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li>An SQLite database</li><li>The Sequelize ORM tool</li><li>The Umzug migration tool</li><li>A simple migration to create tables for Users and Roles</li><li>Seed data for those tables</li><li>Automated processes to migrate and seed the data on application startup</li><li>A simple route to query user information</li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Adding a Database</h1><article class=default><header class=headline></header><h1 id=sequelize>Sequelize</h1><a href="https://www.youtube.com/watch?v=RN46EzaMHy0">YouTube Video</a><h2 id=database-libraries>Database Libraries</h2><p>To begin, we must first select a library to use when interfacing with our database. There are many different types of libraries, and many different options to choose from.</p><ol><li><p>First and foremost, we can always just write raw SQL queries directly in our code. This is often very straightforward, but also can lead to very complex code and security issues. It also doesn&rsquo;t offer many of the more advanced features such as mapping database results to object types and automatically managing database schemas.</p></li><li><p>Another option is an SQL query library, such as <a href=https://knexjs.org/ rel=external target=_blank>Knex.js</a> or <a href=https://kysely.dev/ rel=external target=_blank>Kysely</a>. These libraries provide a helpful abstraction on top of SQL, allowing developers to build queries using syntax that is more comfortable and familiar to them. These libraries also have additional features to manage database schemas and sample data</p></li><li><p>The final option is an <a href=https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping rel=external target=_blank>Object-Relational Mapping (ORM)</a> library such as <a href=https://vincit.github.io/objection.js/ rel=external target=_blank>Objection</a> or <a href=https://sequelize.org/ rel=external target=_blank>Sequelize</a>. These libraries provide the most abstraction away from raw SQL, often allowing developers to store and retrieve data in a database as if it were stored in a list or dictionary data structure.</p></li></ol><p>For this project, we&rsquo;re going to use the <a href=https://sequelize.org/ rel=external target=_blank>Sequelize</a> ORM, coupled with the <a href=https://github.com/sequelize/umzug rel=external target=_blank>Umzug</a> migration tool. Both of these libraries are very commonly used in Node.js projects, and are actively maintained.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Database Engines</div><div class=box-content><p>We also have many choices for the database engine we want to use for our web projects. Some common options include <a href=https://www.postgresql.org/ rel=external target=_blank>PostgreSQL</a>, <a href=https://www.mysql.com/ rel=external target=_blank>MySQL</a>, <a href=https://mariadb.org/ rel=external target=_blank>MariaDB</a>, <a href=https://www.mongodb.com/ rel=external target=_blank>MongoDB</a>, <a href=https://firebase.google.com/ rel=external target=_blank>Firebase</a>, and many more.</p><p>For this project, we&rsquo;re going to use <a href=https://www.sqlite.org/ rel=external target=_blank>SQLite</a>. SQLite is unique because it is a database engine that only requires a single file, so it is self-contained and easy to work with. It doesn&rsquo;t require any external database servers or software, making it perfect for a small development project. In fact, SQLite may be one of the most <a href=https://www.sqlite.org/mostdeployed.html rel=external target=_blank>widely deployed software modules</a> in the whole world!</p><p>Naturally, if wer plan on growing a web application beyond a simple hobby project with a few users, we should spend some time researching a reliable database solution. Thankfully, the Sequelize ORM supports <a href=https://sequelize.org/docs/v6/other-topics/dialect-specific-things/ rel=external target=_blank>many different database engines</a> so it is easy to switch.</p></div></div><h2 id=installing-sequelize>Installing Sequelize</h2><p>To begin, let&rsquo;s install both <code>sequelize</code> as well as the <code>sqlite3</code> library using <code>npm</code>:</p><div class=tab-panel data-tab-group=f11d3b45a25e1c1a1e2a3d2d27d093fc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f11d3b45a25e1c1a1e2a3d2d27d093fc","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install sqlite3 sequelize</span></span></code></pre></div></div></div></div></div><p>Once those libraries are installed, we can now configure <code>sequelize</code> following the information in the <a href=https://sequelize.org/docs/v6/getting-started/ rel=external target=_blank>Sequelize Documentation</a>. Let&rsquo;s create a new file <code>configs/database.js</code> to store our database configuration:</p><div class=tab-panel data-tab-group=dd486b5931521d551589248dd10a41c6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsdatabasejs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("dd486b5931521d551589248dd10a41c6","configsdatabasejs")'>
<span class=tab-nav-text>configs/database.js</span></button></div><div class=tab-content-container><div data-tab-item=configsdatabasejs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Sequelize database ORM
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports sequelize a Sequelize instance
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Sequelize</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Sequelize instance
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>sequelize</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Sequelize</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>dialect</span><span class=o>:</span> <span class=s1>&#39;sqlite&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>storage</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DATABASE_FILE</span> <span class=o>||</span> <span class=s2>&#34;:memory:&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>logging</span><span class=o>:</span> <span class=nx>logger</span><span class=p>.</span><span class=nx>sql</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=nx>logger</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>sequelize</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This file creates a very simple configuration for <code>sequelize</code> that uses the <code>sqlite</code> dialect. It uses the <code>DATABASE_FILE</code> environment variable to control the location of the database in the file system, and it also uses the <code>logger.sql</code> log level to log any data produced by the library. If a <code>DATABASE_FILE</code> environment variable is not provided, it will default to storing data in the SQLite <a href=https://www.sqlite.org/inmemorydb.html rel=external target=_blank>In-Memory Database</a>, which is great for testing and quick development.</p><p>Of course, a couple of those items don&rsquo;t actually exist yet, so let&rsquo;s add those in before we move on! First, we need to add a <code>DATABASE_FILE</code> environment variable to both our <code>.env</code> and <code>.env.example</code> files:</p><div class=tab-panel data-tab-group=b6af8685aeea5f9d5c5c833d837cd8ff><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b6af8685aeea5f9d5c5c833d837cd8ff","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>https://<span class=nv>$CODESPACE_NAME</span>-<span class=nv>$PORT</span>.<span class=nv>$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class="line hl"><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>database.sqlite</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=b6a4187f24c76fd456fabbb0cce2223d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=envexample class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b6a4187f24c76fd456fabbb0cce2223d","envexample")'>
<span class=tab-nav-text>.env.example</span></button></div><div class=tab-content-container><div data-tab-item=envexample class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>http://localhost:3000
</span></span><span class=line><span class=cl><span class=c1># For GitHub Codespaces</span>
</span></span><span class=line><span class=cl><span class=c1># OPENAPI_HOST=https://$CODESPACE_NAME-$PORT.$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class="line hl"><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>database.sqlite</span></span></code></pre></div></div></div></div></div><p>We also need to add a new logging level called <code>sql</code> to our logger configuration in <code>configs/logger.js</code>. This is a bit more involved, because it means we have to now list all intended logging levels explicitly. See the highlighted lines below for what has been changed, but the entire file is included for convenience:</p><div class=tab-panel data-tab-group=f8c35a7c0821cce564f0c71c87e69bcf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsloggerjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f8c35a7c0821cce564f0c71c87e69bcf","configsloggerjs")'>
<span class=tab-nav-text>configs/logger.js</span></button></div><div class=tab-content-container><div data-tab-item=configsloggerjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Winston logger
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports logger a Winston logger object
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>winston</span> <span class=nx>from</span> <span class=s2>&#34;winston&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Extract format options
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=p>{</span> <span class=nx>combine</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=nx>printf</span><span class=p>,</span> <span class=nx>colorize</span><span class=p>,</span> <span class=nx>align</span><span class=p>,</span> <span class=nx>errors</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>format</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Determines the correct logging level based on the Node environment
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @returns {string} the desired log level
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>level</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;0&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;error&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;error&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;1&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;warn&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;warn&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;2&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;info&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;info&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;3&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;http&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;4&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;verbose&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;verbose&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;5&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;debug&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;debug&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;6&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;sql&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=k>return</span> <span class=s1>&#39;sql&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;7&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;silly&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=k>return</span> <span class=s1>&#39;silly&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Custom logging levels for the application
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>levels</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>error</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>warn</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>info</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>http</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>verbose</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>debug</span><span class=o>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>sql</span><span class=o>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>silly</span><span class=o>:</span> <span class=mi>7</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Custom colors
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>colors</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;red&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>warn</span><span class=o>:</span> <span class=s1>&#39;yellow&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>info</span><span class=o>:</span> <span class=s1>&#39;green&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>http</span><span class=o>:</span> <span class=s1>&#39;green&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>verbose</span><span class=o>:</span> <span class=s1>&#39;cyan&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>debug</span><span class=o>:</span> <span class=s1>&#39;blue&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>sql</span><span class=o>:</span> <span class=s1>&#39;gray&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>silly</span><span class=o>:</span> <span class=s1>&#39;magenta&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=nx>winston</span><span class=p>.</span><span class=nx>addColors</span><span class=p>(</span><span class=nx>colors</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Creates the Winston instance with the desired configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>logger</span> <span class=o>=</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>createLogger</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// call `level` function to get default log level
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>level</span><span class=o>:</span> <span class=nx>level</span><span class=p>(),</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>levels</span><span class=o>:</span> <span class=nx>levels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Format configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// See https://github.com/winstonjs/logform
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>format</span><span class=o>:</span> <span class=nx>combine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>colorize</span><span class=p>({</span> <span class=nx>all</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>errors</span><span class=p>({</span> <span class=nx>stack</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>timestamp</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;YYYY-MM-DD hh:mm:ss.SSS A&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>align</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>printf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nx>info</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>        <span class=sb>`[</span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>timestamp</span><span class=si>}</span><span class=sb>] </span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>level</span><span class=si>}</span><span class=sb>: </span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>stack</span> <span class=o>?</span> <span class=nx>info</span><span class=p>.</span><span class=nx>stack</span> <span class=o>:</span> <span class=nx>info</span><span class=p>.</span><span class=nx>message</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Output configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>transports</span><span class=o>:</span> <span class=p>[</span><span class=k>new</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>transports</span><span class=p>.</span><span class=nx>Console</span><span class=p>()],</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>logger</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>We have added a new <code>sql</code> logging level that is now part of our logging setup. One of the unique features of <code>sequelize</code> is that it will actually allow us to log all SQL queries run against our database, so we can enable and disable that level of logging by adjusting the <code>LOG_LEVEL</code> environment variable as desired.</p><p>There! We now have a working database configuration. Before we can make use of it, however, we need to add additional code to create and populate our database. So, we&rsquo;ll need to continue on in this tutorial before we can actually test our application.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=migrations>Migrations</h1><a href="https://www.youtube.com/watch?v=P-0Iuaj_BAE">YouTube Video</a><h2 id=umzug>Umzug</h2><p>Now that we have a database configured in our application, we need to create some way to actually populate that database with the tables and information our app requires. We could obviously do that manually, but that really makes it difficult (if not impossible) to automatically build, test, and deploy this application.</p><p>Thankfully, most database libraries also have a way to automate building the database structure. This is known as <a href=https://en.wikipedia.org/wiki/Schema_migration rel=external target=_blank>schema migration</a> or often just <strong>migration</strong>. We call it migration because it allows us to update the database schema along with new versions of the application, effectively <em>migrating</em> our data to new versions as we go.</p><p>The <code>sequelize</code> library recommends using another library, named <a href=https://github.com/sequelize/umzug rel=external target=_blank>Umzug</a>, as the preferred way to manage database migrations. It is actually completely framework agnostic, and would even work with ORMs other than Sequelize.</p><h2 id=setting-up-umzug>Setting up Umzug</h2><p>To begin, let&rsquo;s install <code>umzug</code> using <code>npm</code>:</p><div class=tab-panel data-tab-group=a518438d7a9a4c356bab3f2ada52abbf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a518438d7a9a4c356bab3f2ada52abbf","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install umzug</span></span></code></pre></div></div></div></div></div><p>Next, we can create a configuration file to handle our migrations, named <code>configs/migrations.js</code>, with the following content as described in the <a href=https://github.com/sequelize/umzug rel=external target=_blank>Umzug Documentation</a>:</p><div class=tab-panel data-tab-group=68043859ea09a6f32b392a6f2a1bab78><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsmigrationsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("68043859ea09a6f32b392a6f2a1bab78","configsmigrationsjs")'>
<span class=tab-nav-text>configs/migrations.js</span></button></div><div class=tab-content-container><div data-tab-item=configsmigrationsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Umzug migration engine
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports umzug an Umzug instance
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Umzug</span><span class=p>,</span> <span class=nx>SequelizeStorage</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;umzug&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import database configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;./database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Umzug instance
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>umzug</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Umzug</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>migrations</span><span class=o>:</span> <span class=p>{</span><span class=nx>glob</span><span class=o>:</span> <span class=s1>&#39;migrations/*.js&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span><span class=o>:</span> <span class=nx>database</span><span class=p>.</span><span class=nx>getQueryInterface</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>storage</span><span class=o>:</span> <span class=k>new</span> <span class=nx>SequelizeStorage</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>sequelize</span><span class=o>:</span> <span class=nx>database</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>modelName</span><span class=o>:</span> <span class=s1>&#39;migrations&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=o>:</span> <span class=nx>logger</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>umzug</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Notice that this configuration uses our existing <code>sequelize</code> database configuration, and also uses an instance of our <code>logger</code> as well. It is set to look for any migrations stored in the <code>migrations/</code> folder.</p><p>The <code>umzug</code> library also has a very handy way to run migrations directly from the terminal using a simple JavaScript file, so let&rsquo;s create a new file named <code>migrate.js</code> in the root of the <code>server</code> directory as well with this content:</p><div class=tab-panel data-tab-group=f5773a71e1a3cd6ef23c604da2186c7d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=migratejs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f5773a71e1a3cd6ef23c604da2186c7d","migratejs")'>
<span class=tab-nav-text>migrate.js</span></button></div><div class=tab-content-container><div data-tab-item=migratejs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Load environment (must be first)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;@dotenvx/dotenvx/config&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>migrations</span> <span class=nx>from</span> <span class=s1>&#39;./configs/migrations.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Run Umzug as CLI application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>migrations</span><span class=p>.</span><span class=nx>runAsCLI</span><span class=p>();</span></span></span></code></pre></div></div></div></div></div><p>This file will simply load our environment configuration as well as the <code>umzug</code> instance for migrations, and then instruct it to run as a command-line interface (CLI) application. This is very handy, as we&rsquo;ll see shortly.</p><h2 id=creating-a-migration>Creating a Migration</h2><p>Now we can create a new migration to actually start building our database structure for our application. For this simple example, we&rsquo;ll build a <code>users</code> table with four fields:</p><p><a href=#R-image-e03da31b17f7c752dae1845e26534001 class=lightbox-link><img alt="Users ERD" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/migration_users.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e03da31b17f7c752dae1845e26534001><img alt="Users ERD" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/migration_users.png></a></p><p>We can refer to both the <a href=https://github.com/sequelize/umzug rel=external target=_blank>Umzug Documentation</a> and <a href=https://github.com/sequelize/umzug/tree/main/examples/1-sequelize-typescript rel=external target=_blank>Examples</a> as well as the <a href=https://sequelize.org/docs/v6/other-topics/migrations/ rel=external target=_blank>Sequelize Documentation</a>. So, let&rsquo;s create a new folder named <code>migrations</code> to match our configuration above, then a new file named <code>00_users.js</code> to hold the migration for our <code>users</code> table:</p><div class=tab-panel data-tab-group=cc23e7de0bc427401c80ed86ecff950f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=migrations00_usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cc23e7de0bc427401c80ed86ecff950f","migrations00_usersjs")'>
<span class=tab-nav-text>migrations/00_users.js</span></button></div><div class=tab-content-container><div data-tab-item=migrations00_usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users table migration
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports up the Up migration
</span></span></span><span class=line><span class=cl><span class=cm> * @exports down the Down migration
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span><span class=nx>Sequelize</span><span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Apply the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>createTable</span><span class=p>(</span><span class=s1>&#39;users&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>autoIncrement</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>STRING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>unique</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Roll back the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>down</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>dropTable</span><span class=p>(</span><span class=s1>&#39;users&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>A migration consists of two functions. First, the <code>up</code> function is called when the migration is applied, and it should define or modify the database structure as desired. In this case, since this is the first migration, we can assume we are starting with a blank database and go from there. The other function, <code>down</code>, is called whenever we want to undo, or <em>rollback</em>, the migration. It should effectively undo any changes made by the <code>up</code> function, leaving the database in the state it was before the migration was applied.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Sequential File Names</div><div class=box-content><p>Most migration systems, including <code>umzug</code>, apply the migrations in order according to the filenames of the migrations. Some systems automatically append a timestamp to the name of the migration file when it is created, such as <code>20250203112345_users.js</code>. For our application, we will simply number them sequentially, starting with <code>00</code>.</p></div></div><p>Finally, we can use the <code>migrate.js</code> file we created to run <code>umzug</code> from the command line to apply the migration:</p><div class=tab-panel data-tab-group=0231e4ccc53c8894cd6a25710dadc6de><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0231e4ccc53c8894cd6a25710dadc6de","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node migrate up</span></span></code></pre></div></div></div></div></div><p>If everything works correctly, we should receive some output showing that our migration succeeded:</p><div class=tab-panel data-tab-group=c5d3c38a31c9006297f6fdc1953927d7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c5d3c38a31c9006297f6fdc1953927d7","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[dotenvx@1.34.0] injecting env (5) from .env
[2025-02-03 10:59:35.066 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }
[2025-02-03 10:59:35.080 PM] info:      { event: &#39;migrated&#39;, name: &#39;00_users.js&#39;, durationSeconds: 0.014 }
[2025-02-03 10:59:35.080 PM] info:      applied 1 migrations.</code></pre></div></div></div></div></div><p>We should also see a file named <code>database.sqlite</code> added to our file structure. If desired, we can install the <a href="https://marketplace.visualstudio.com/items?itemName=qwtel.sqlite-viewer" rel=external target=_blank>SQLite Viewer</a> extension in VS Code to explore the contents of that file to confirm it is working correctly.</p><p><a href=#R-image-87ac4f6c19ec0b66ac265df9e4abcd80 class=lightbox-link><img alt="Users Table in SQLite" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/migrations_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-87ac4f6c19ec0b66ac265df9e4abcd80><img alt="Users Table in SQLite" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/migrations_3.png></a></p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Add Extension to Dev Container</div><div class=box-content><p>When installing a VS Code extension, we can also choose to have it added directly to our <code>devcontainer.json</code> file so it is available automatically whenever we close this repository into a new codespace or dev container. Just click the gear icon on the marketplace page and choose &ldquo;Add to devcontainer.json&rdquo; from the menu!</p><p><a href=#R-image-12582f9d04b17b940f486b260ba1fa2e class=lightbox-link><img alt="Add to Dev Container" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/migrations_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-12582f9d04b17b940f486b260ba1fa2e><img alt="Add to Dev Container" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/migrations_2.png></a></p></div></div><p>If we need to roll back that migration, we can use a similar command:</p><div class=tab-panel data-tab-group=dd323668331fb630493c4855e1b7736b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("dd323668331fb630493c4855e1b7736b","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node migrate down</span></span></code></pre></div></div></div></div></div><p>There are many more commands available to apply migrations individually and more. Check the <a href="https://github.com/sequelize/umzug/?tab=readme-ov-file#cli" rel=external target=_blank>Umzug Documentation</a> for more details.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=seeds>Seeds</h1><a href="https://www.youtube.com/watch?v=UZTSyvzFjAw">YouTube Video</a><h2 id=database-seeding>Database Seeding</h2><p>Another useful task that <code>umzug</code> can handle is adding some initial data to a new database. This process is known as <em>seeding</em> the database. Thankfully, the process for seeding is nearly identical to the process for migrations - in fact, it uses the same operations in different ways! So, let&rsquo;s explore how to set that up.</p><p>First, we&rsquo;ll create a new configuration file at <code>configs/seeds.js</code> that contains nearly the same content as <code>configs/migrations.js</code> with a couple of important changes on the highlighted lines:</p><div class=tab-panel data-tab-group=e52425f538559e213a70d46401b6e8f2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsseedsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e52425f538559e213a70d46401b6e8f2","configsseedsjs")'>
<span class=tab-nav-text>configs/seeds.js</span></button></div><div class=tab-content-container><div data-tab-item=configsseedsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Umzug seed engine
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports umzug an Umzug instance
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Umzug</span><span class=p>,</span> <span class=nx>SequelizeStorage</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;umzug&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import database configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;./database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Umzug instance
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>umzug</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Umzug</span><span class=p>({</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>migrations</span><span class=o>:</span> <span class=p>{</span><span class=nx>glob</span><span class=o>:</span> <span class=s1>&#39;seeds/*.js&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span><span class=o>:</span> <span class=nx>database</span><span class=p>.</span><span class=nx>getQueryInterface</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>storage</span><span class=o>:</span> <span class=k>new</span> <span class=nx>SequelizeStorage</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>sequelize</span><span class=o>:</span> <span class=nx>database</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>modelName</span><span class=o>:</span> <span class=s1>&#39;seeds&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=o>:</span> <span class=nx>logger</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>umzug</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>All we really have to do is change the folder where the migrations (in this case, the seeds) are stored, and we also change the name of the model, or table, where that information will be kept in the database.</p><p>Next, we&rsquo;ll create a <code>seed.js</code> file that allows us to run the seeds from the command line. Again, this file is nearly identical to the <code>migrate.js</code> file from earlier, with a couple of simple changes:</p><div class=tab-panel data-tab-group=e5f0ec2b8c85a3bd66ff09e37c91ee47><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=seedjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e5f0ec2b8c85a3bd66ff09e37c91ee47","seedjs")'>
<span class=tab-nav-text>seed.js</span></button></div><div class=tab-content-container><div data-tab-item=seedjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Load environment (must be first)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;@dotenvx/dotenvx/config&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>seeds</span> <span class=nx>from</span> <span class=s1>&#39;./configs/seeds.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Run Umzug as CLI application
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>seeds</span><span class=p>.</span><span class=nx>runAsCLI</span><span class=p>();</span></span></span></code></pre></div></div></div></div></div><p>Finally, we can create a new folder <code>seeds</code> to store our seeds, and then create the first seed also called <code>00_users.js</code> to add a few default users to our database:</p><div class=tab-panel data-tab-group=043d890b5c30928e5e6ffd8c59975807><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=seeds00_usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("043d890b5c30928e5e6ffd8c59975807","seeds00_usersjs")'>
<span class=tab-nav-text>seeds/00_users.js</span></button></div><div class=tab-content-container><div data-tab-item=seeds00_usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users seed
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports up the Up migration
</span></span></span><span class=line><span class=cl><span class=cm> * @exports down the Down migration
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Timestamp in the appropriate format for the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>now</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>().</span><span class=nx>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>23</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=s2>&#34;T&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34; +00:00&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Array of objects to add to the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=s1>&#39;admin&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=s1>&#39;contributor&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=s1>&#39;manager&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=s1>&#39;user&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Apply the seed
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=s1>&#39;users&#39;</span><span class=p>,</span> <span class=nx>users</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Roll back the seed
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>down</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkDelete</span><span class=p>(</span><span class=s2>&#34;users&#34;</span><span class=p>,</span> <span class=p>{},</span> <span class=p>{</span> <span class=nx>truncate</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>This seed will add 4 users to the database. Notice that we are setting both the <code>createdAt</code> and <code>updatedAt</code> fields manually - while the <code>sequelize</code> library will manage those for us in certain situations, we must handle them manually when doing a bulk insert directly to the database.</p><p>At this point we can insert our seeds into the database using the command line interface:</p><div class=tab-panel data-tab-group=f8c5281a52749144cbb9817f040b0af1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f8c5281a52749144cbb9817f040b0af1","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node seed up</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=286b993d921cc9bb1766411fa8697315><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("286b993d921cc9bb1766411fa8697315","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[dotenvx@1.34.0] injecting env (5) from .env
[2025-02-04 02:47:20.702 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }
[2025-02-04 02:47:20.716 PM] info:      { event: &#39;migrated&#39;, name: &#39;00_users.js&#39;, durationSeconds: 0.013 }
[2025-02-04 02:47:20.716 PM] info:      applied 1 migrations.</code></pre></div></div></div></div></div><p>Now, once we&rsquo;ve done that, we can go back to the <a href="https://marketplace.visualstudio.com/items?itemName=qwtel.sqlite-viewer" rel=external target=_blank>SQLite Viewer</a> extension in VS Code to confirm that our data was properly inserted into the database.</p><p><a href=#R-image-282618135c92470dab5cd40d18517096 class=lightbox-link><img alt="Seeded Data" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/seed_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-282618135c92470dab5cd40d18517096><img alt="Seeded Data" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/seed_1.png></a></p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Migrate Before Seeding</div><div class=box-content><p>One common mistake that is very easy to do is to try and seed the database without first migrating it.</p><div class=tab-panel data-tab-group=63dc5915a2cd4e05b090bd92980620e7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("63dc5915a2cd4e05b090bd92980620e7","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[2025-02-04 02:51:39.452 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }

Error: Migration 00_users.js (up) failed: Original error: SQLITE_ERROR: no such table: users</code></pre></div></div></div></div></div><p>Thankfully <code>umzug</code> gives a pretty helpful error in this case.</p><p>Another common error is to forget to roll back seeds before rolling back and resetting any migrations. In that case, when you try to apply your seeds again, they will not be applied since the database thinks the data is still present. So, remember to roll back your seeds <em>before</em> rolling back any migrations!</p></div></div><p>We&rsquo;re almost ready to test our app! The last step is to create a model for our data, which we&rsquo;ll cover on the next page.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=models>Models</h1><a href="https://www.youtube.com/watch?v=c4iNYRhqxTs">YouTube Video</a><h2 id=database-models>Database Models</h2><p>Now that we have our database table structure and sample data set up, we can finally configure <code>sequelize</code> to query our database by defining a <a href=https://sequelize.org/docs/v6/core-concepts/model-basics/ rel=external target=_blank>model</a> representing that data. At its core, a model is simply an abstraction that represents the structure of the data in a table of our database. We can equate this to a <code>class</code> in object-oriented programming - each row or <em>record</em> in our database can be thought of as an <em>instance</em> of our model class. You can learn more about models in the <a href=https://sequelize.org/docs/v6/core-concepts/model-basics/ rel=external target=_blank>Sequelize Documentation</a></p><p>To create a model, let&rsquo;s first create a <code>models</code> folder in our app, then we can create a file <code>user.js</code> that contains the schema for the <code>User</code> model, based on the <code>users</code> table.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Singular vs. Plural</div><div class=box-content><p>By convention, model names are usually singular like &ldquo;user&rdquo; while table names are typically pluralized like &ldquo;users.&rdquo; This is not a rule that must be followed, but many web frameworks use this convention so we&rsquo;ll also follow it.</p></div></div><p>The <code>User</code> model schema should look very similar to the table definition used in the migration created earlier in this example:</p><div class=tab-panel data-tab-group=bdd4645372fd9dafa19f4515f50287ad><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsuserjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bdd4645372fd9dafa19f4515f50287ad","modelsuserjs")'>
<span class=tab-nav-text>models/user.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsuserjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file User schema
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports UserSchema the schema for the User model
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Sequelize</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>UserSchema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>autoIncrement</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>STRING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>unique</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>UserSchema</span></span></span></code></pre></div></div></div></div></div><p>At a minimum, a model schema defines the attributes that are stored in the database, but there are many more features that can be added over time, such as additional computed fields (for example, a <code>fullName</code> field that concatenates the <code>giveName</code> and <code>familyName</code> fields stored in the database). We&rsquo;ll explore ways to improve our models in later examples.</p><p>Once we have the model schema created, we&rsquo;ll create a second file named <code>models.js</code> that will pull together all of our schemas and actually build the <code>sequelize</code> models that can be used throughout our application.</p><div class=tab-panel data-tab-group=d101b17c28b2063603c8d13a6a48a8a0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsmodelsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d101b17c28b2063603c8d13a6a48a8a0","modelsmodelsjs")'>
<span class=tab-nav-text>models/models.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsmodelsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Database models
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports User a Sequelize User model
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import database connection
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;../configs/database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Schemas
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>UserSchema</span> <span class=nx>from</span> <span class=s1>&#39;./user.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create User Model
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>User</span> <span class=o>=</span> <span class=nx>database</span><span class=p>.</span><span class=nx>define</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Model Name
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s1>&#39;User&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Schema
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>UserSchema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Other options
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>tableName</span><span class=o>:</span> <span class=s1>&#39;users&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>User</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>It is also important to note that we can define the name of the table that stores instances of the model in the <code>tableName</code> option.</p><p>We will see why it is important to use this <code>models.js</code> file (instead of just defining the model itself and not just the schema in the <code>users.js</code> file) once we start adding relations between the models. For now, we&rsquo;ll start with this simple scaffold that we can expand upon in the future.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Models vs. Migrations</div><div class=box-content><p>One of the more interesting features of <code>sequelize</code> is that it can use just the models themselves to define the structure of the tables in the database. It has features such as <a href=https://sequelize.org/docs/v6/core-concepts/model-basics/#model-synchronization rel=external target=_blank>Model Synchronization</a> to keep the database structure updated to match the given models.</p><p>However, even in the documentation, <code>sequelize</code> recommends using migrations for more complex database structures. So, in our application, the migrations will represent the incremental steps required over time to construct our application&rsquo;s database tables, whereas the models will represent the full structure of the database tables at this point in time. As we add new features to our application, this difference will become more apparent.</p></div></div><h2 id=model-querying>Model Querying</h2><p>Finally, we are at the point where we can actually use our database in our application! So, let&rsquo;s update the route for the <code>users</code> endpoint to actually return a list of the users of our application in a JSON format:</p><div class=tab-panel data-tab-group=d4e73a01cd97cb9458b8f4f0afeeffcf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesusersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d4e73a01cd97cb9458b8f4f0afeeffcf","routesusersjs")'>
<span class=tab-nav-text>routes/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesusersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: users
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Users Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import models
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;../models/models.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of users
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /users:
</span></span></span><span class=line><span class=cl><span class=cm> *   get: 
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: users list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all users in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200: 
</span></span></span><span class=line><span class=cl><span class=cm> *         description: a resource         
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findAll</span><span class=p>();</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>The only change we need to make is to import our <code>User</code> model we just created in the <code>models/models.js</code> file, and then use the <code>User.findAll()</code> query method inside of our first route method. A full list of all the querying functions in <code>sequelize</code> can be found in the <a href=https://sequelize.org/docs/v6/core-concepts/model-querying-basics/ rel=external target=_blank>Sequelize Documentation</a></p><p>Now, let&rsquo;s start our application and see if it works! We should make sure we have migrated and seeded the database recently before starting. If everything works correctly, we should be able to navigate to the <code>/users</code> path and see the following JSON output on the page:</p><div class=tab-panel data-tab-group=9090fdebc44fd51f55b4ff7d9a474d5e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=route-users class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9090fdebc44fd51f55b4ff7d9a474d5e","route-users")'>
<span class=tab-nav-text>route: /users</span></button></div><div class=tab-content-container><div data-tab-item=route-users class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;createdAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;updatedAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;contributor&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;createdAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;updatedAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;manager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;createdAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;updatedAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;createdAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;updatedAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div></div></div></div></div><p>Awesome! We have now developed a basic web application that is able to query a database and present data to the user in a JSON format. This is the first big step toward actually building a RESTful API application.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Committing Database Files</div><div class=box-content><p>One thing we might notice is that our <code>database.sqlite</code> file is in the list of files to be committed to our GitHub repository for this project. In many cases, you may or may not want to do this, depending on what type of data you are storing in the database and how you are using it.</p><p>For this application, and the projects in this course, we&rsquo;ll go ahead and commit our database to GitHub since that is the simplest way to share that information.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=documenting-models>Documenting Models</h1><a href="https://www.youtube.com/watch?v=ebVJ4R08ZZM">YouTube Video</a><h2 id=documenting-models-with-open-api>Documenting Models with Open API</h2><p>Before we move ahead, let&rsquo;s quickly take a minute to add some documentation to our models using the Open API specification. The details can be found in the <a href=https://swagger.io/specification/ rel=external target=_blank>Open API Specification Document</a></p><p>First, let&rsquo;s update our configuration in the <code>configs/openapi.js</code> file to include the <code>models</code> directory:</p><div class=tab-panel data-tab-group=1c8945bae04d129431762f7454853112><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsopenapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1c8945bae04d129431762f7454853112","configsopenapijs")'>
<span class=tab-nav-text>configs/openapi.js</span></button></div><div class=tab-content-container><div data-tab-item=configsopenapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Configure SwaggerJSDoc options
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>definition</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>openapi</span><span class=o>:</span> <span class=s2>&#34;3.1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>info</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>title</span><span class=o>:</span> <span class=s2>&#34;Example Project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>description</span><span class=o>:</span> <span class=s2>&#34;Example Project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>servers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>url</span><span class=o>:</span> <span class=nx>url</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>apis</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;./routes/*.js&#34;</span><span class=p>,</span> <span class=s2>&#34;./models/*.js&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Next, at the top of our <code>models/user.js</code> file, we can add information in an <code>@swagger</code> tag about our newly created <code>User</code> model, usually placed right above the model definition itself:</p><div class=tab-panel data-tab-group=96ed6c605c65a68dd494a38072d62f58><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsuserjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("96ed6c605c65a68dd494a38072d62f58","modelsuserjs")'>
<span class=tab-nav-text>models/user.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsuserjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   schemas:
</span></span></span><span class=line><span class=cl><span class=cm> *     User:
</span></span></span><span class=line><span class=cl><span class=cm> *       type: object
</span></span></span><span class=line><span class=cl><span class=cm> *       required:
</span></span></span><span class=line><span class=cl><span class=cm> *         - username
</span></span></span><span class=line><span class=cl><span class=cm> *       properties:
</span></span></span><span class=line><span class=cl><span class=cm> *         id:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *           description: autogenerated id
</span></span></span><span class=line><span class=cl><span class=cm> *         username:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           description: username for the user
</span></span></span><span class=line><span class=cl><span class=cm> *         createdAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was created
</span></span></span><span class=line><span class=cl><span class=cm> *         updatedAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was last updated
</span></span></span><span class=line><span class=cl><span class=cm> *       example:
</span></span></span><span class=line><span class=cl><span class=cm> *           id: 1
</span></span></span><span class=line><span class=cl><span class=cm> *           username: admin
</span></span></span><span class=line><span class=cl><span class=cm> *           createdAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class=line><span class=cl><span class=cm> *           updatedAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>UserSchema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Finally, we can now update our route in the <code>routes/users.js</code> file to show that it is outputting an array of <code>User</code> objects:</p><div class=tab-panel data-tab-group=5396e81f73f0bc610b5809ccc7d24187><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesusersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5396e81f73f0bc610b5809ccc7d24187","routesusersjs")'>
<span class=tab-nav-text>routes/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesusersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of users
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /users:
</span></span></span><span class=line><span class=cl><span class=cm> *   get: 
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: users list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all users in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     responses:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *       200:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         description: the list of users
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         content:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *           application/json:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *             schema:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *               type: array
</span></span></span><span class="line hl"><span class=cl><span class=cm> *               items:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *                 $ref: &#39;#/components/schemas/User&#39;       
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findAll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>With all of that in place, we can start our application with the Open API documentation enabled, then navigate to the <code>/docs</code> route to see our updated documentation. We should now see our <code>User</code> model listed as a schema at the bottom of the page:</p><p><a href=#R-image-4b9cba763a79ba652bb04daa09b2fc88 class=lightbox-link><img alt="User Schema" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/documenting_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4b9cba763a79ba652bb04daa09b2fc88><img alt="User Schema" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/documenting_1.png></a></p><p>In addition, we can see that the <code>/users</code> route has also been updated to show that it returns an array of <code>User</code> objects, along with the relevant data:</p><p><a href=#R-image-93695759d2272873dc80c5dc1e0e2c83 class=lightbox-link><img alt="User Route Documentation" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/documenting_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-93695759d2272873dc80c5dc1e0e2c83><img alt="User Route Documentation" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/documenting_2.png></a></p><p>As we continue to add models and routes to our application, we should also make sure our Open API documentation is kept up to date with the latest information.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=automation>Automation</h1><a href="https://www.youtube.com/watch?v=LMQZ6OXpzGU">YouTube Video</a><h2 id=automating-database-deployment>Automating Database Deployment</h2><p>One very helpful feature we can add to our application is the ability to automatically migrate and seed the database when the application first starts. This can be especially helpful when deploying this application in a container.</p><p>To do this, let&rsquo;s add some additional code to our <code>bin/www</code> file that is executed when our project starts:</p><div class=tab-panel data-tab-group=3512ad7404ab7c093dc66fbabfc722ca><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3512ad7404ab7c093dc66fbabfc722ca","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Executable entrypoint for the web application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s1>&#39;../app.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s1>&#39;../configs/database.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;../configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>migrations</span> <span class=nx>from</span> <span class=s1>&#39;../configs/migrations.js&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>seeds</span> <span class=nx>from</span> <span class=s1>&#39;../configs/seeds.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get port from environment and store in Express.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>port</span> <span class=o>=</span> <span class=nx>normalizePort</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>||</span> <span class=s1>&#39;3000&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;port&#39;</span><span class=p>,</span> <span class=nx>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create HTTP server.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Attach event handlers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>server</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=nx>onError</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>server</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;listening&#39;</span><span class=p>,</span> <span class=nx>onListening</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Call startup function
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>startup</span><span class=p>();</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=cm>/**
</span></span></span><span class="line hl"><span class=cl><span class=cm> * Server startup function
</span></span></span><span class="line hl"><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kd>function</span> <span class=nx>startup</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Test database connection
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=nx>database</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Database connection successful&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Run migrations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>migrations</span><span class=p>.</span><span class=nx>up</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Database migrations complete&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SEED_DATA</span> <span class=o>===</span> <span class=s1>&#39;true&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=s2>&#34;Database data seeding is enabled!&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>seeds</span><span class=p>.</span><span class=nx>up</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>            <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Database seeding complete&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>            <span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>port</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>          <span class=c1>// Listen on provided port, on all network interfaces.
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>          <span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>port</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>){</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>We now have a new <code>startup</code> function that will first test the database connection, then run the migrations, and finally it will seed the database if the <code>SEED_DATA</code> environment variable is set to <code>true</code>. Once all that is done, it will start the application by calling <code>server.listen</code> using the port.</p><p>Notice that this code uses the <code>then()</code> function to resolve promises instead of the <code>async</code> and <code>await</code> keywords. This is because it is running at the top level, and cannot include any <code>await</code> keywords.</p><p>To enable this, let&rsquo;s add the <code>SEED_DATA</code> environment variable to both <code>.env</code> and <code>.env.example</code>:</p><div class=tab-panel data-tab-group=3bfcafd832857c0fe1c65ba45834a62c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3bfcafd832857c0fe1c65ba45834a62c","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>https://<span class=nv>$CODESPACE_NAME</span>-<span class=nv>$PORT</span>.<span class=nv>$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>database.sqlite
</span></span><span class="line hl"><span class=cl><span class=nv>SEED_DATA</span><span class=o>=</span>true</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=8dda4a94d1f0303c47dfb0b79f4c45eb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=envexample class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8dda4a94d1f0303c47dfb0b79f4c45eb","envexample")'>
<span class=tab-nav-text>.env.example</span></button></div><div class=tab-content-container><div data-tab-item=envexample class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>http://localhost:3000
</span></span><span class=line><span class=cl><span class=c1># For GitHub Codespaces</span>
</span></span><span class=line><span class=cl><span class=c1># OPENAPI_HOST=https://$CODESPACE_NAME-$PORT.$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>database.sqlite
</span></span><span class="line hl"><span class=cl><span class=nv>SEED_DATA</span><span class=o>=</span>false</span></span></code></pre></div></div></div></div></div><p>To test this, we can delete the <code>database.sqlite</code> file in our repository, then start our project:</p><div class=tab-panel data-tab-group=d6438e9f2f52385030c6c2ed8f325ed9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d6438e9f2f52385030c6c2ed8f325ed9","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>If it works correctly, we should see that our application is able to connect to the database, migrate the schema, and add the seed data, before fully starting:</p><div class=tab-panel data-tab-group=5256a75a935eddc7f3a08dbbbd74b7f2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5256a75a935eddc7f3a08dbbbd74b7f2","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight hl_lines=11-23><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[dotenvx@1.34.0] injecting env (6) from .env
[2025-02-04 06:56:11.823 PM] warn:      OpenAPI documentation visible!
[2025-02-04 06:56:12.163 PM] debug:     Database connection successful
[2025-02-04 06:56:12.208 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }
[2025-02-04 06:56:12.265 PM] info:      { event: &#39;migrated&#39;, name: &#39;00_users.js&#39;, durationSeconds: 0.058 }
[2025-02-04 06:56:12.266 PM] debug:     Database migrations complete
[2025-02-04 06:56:12.266 PM] warn:      Database data seeding is enabled!
[2025-02-04 06:56:12.296 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }
[2025-02-04 06:56:12.321 PM] info:      { event: &#39;migrated&#39;, name: &#39;00_users.js&#39;, durationSeconds: 0.024 }
[2025-02-04 06:56:12.321 PM] debug:     Database seeding complete
[2025-02-04 06:56:12.323 PM] info:      Listening on port 3000</code></pre></div></div></div></div></div><p>There we go! Our application will now always make sure the database is properly migrated, and optionally seeded, before it starts. Now, when another developer or user starts our application, it will be sure to have a working database.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=another-table>Another Table</h1><a href="https://www.youtube.com/watch?v=MWRW1LgN7gI">YouTube Video</a><h2 id=adding-another-table>Adding Another Table</h2><p>Now that we have a working database, let&rsquo;s explore what it takes to add a new table to our application to represent additional models and data in our database.</p><p>We&rsquo;ve already created a <code>users</code> table, which contains information about the users of our application. Now we want to add a <code>roles</code> table to contain all of the possible roles that our users can hold. In addition, we need some way to associate a user with a number of roles. Each user can have multiple roles, and each role can be assigned to multiple users. This is known as a <strong>many to many</strong> database relation, and requires an additional <strong>junction table</strong> to implement it properly. The end goal is to create the database schema represented in this diagram:</p><p><a href=#R-image-e5f19e34c75a8fbec07d3fa85ff13ba2 class=lightbox-link><img alt="User Roles Database Diagram" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/user_roles.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e5f19e34c75a8fbec07d3fa85ff13ba2><img alt="User Roles Database Diagram" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/user_roles.png></a></p><p>To do this, we&rsquo;ll go through three steps:</p><ol><li>Create a migration to modify the database schema</li><li>Create a model for each table</li><li>Add additional seed data for these tables</li></ol><h2 id=migration>Migration</h2><p>First, we need to create a new migration to modify the database schema to include the two new tables. So, we&rsquo;ll create a file named <code>01_roles.js</code> in the <code>migrations</code> folder and add content to it to represent the two new tables we need to create:</p><div class=tab-panel data-tab-group=a1bbccde0da454a7ae9efead7bf8de36><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=migrations01_rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a1bbccde0da454a7ae9efead7bf8de36","migrations01_rolesjs")'>
<span class=tab-nav-text>migrations/01_roles.js</span></button></div><div class=tab-content-container><div data-tab-item=migrations01_rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Roles table migration
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports up the Up migration
</span></span></span><span class=line><span class=cl><span class=cm> * @exports down the Down migration
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span><span class=nx>Sequelize</span><span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Apply the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>createTable</span><span class=p>(</span><span class=s1>&#39;roles&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>autoIncrement</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>STRING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>createTable</span><span class=p>(</span><span class=s1>&#39;user_roles&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>references</span><span class=o>:</span> <span class=p>{</span> <span class=nx>model</span><span class=o>:</span> <span class=s1>&#39;users&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;id&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>onDelete</span><span class=o>:</span> <span class=s2>&#34;cascade&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>references</span><span class=o>:</span> <span class=p>{</span> <span class=nx>model</span><span class=o>:</span> <span class=s1>&#39;roles&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;id&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>onDelete</span><span class=o>:</span> <span class=s2>&#34;cascade&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Roll back the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>down</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>dropTable</span><span class=p>(</span><span class=s1>&#39;user_roles&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>dropTable</span><span class=p>(</span><span class=s1>&#39;roles&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>In this migration, we are creating two tables. The first, named <code>roles</code>, stores the list of roles in the application. The second, named <code>user_roles</code>, is the junction table used for the many-to-many relationship between the <code>users</code> and <code>roles</code> table. Notice that we have to add the tables in the correct order, and also in the <code>down</code> method we have to remove them in reverse order. Finally, it is important to include the <code>onDelete: "cascade"</code> option for each of our reference fields in the <code>user_roles</code> table, as that will handle deleting associated entries in the junction table when a user or role is deleted.</p><p>The <code>user_roles</code> table also includes a great example for adding a foreign key reference between two tables. More information can be found in the <a href=https://sequelize.org/docs/v6/core-concepts/assocs/ rel=external target=_blank>Sequelize Documentation</a>.</p><h2 id=models>Models</h2><p>Next, we need to create two models to represent these tables. The first is the <code>role</code> model schema, stored in <code>models/role.js</code> with the following content:</p><div class=tab-panel data-tab-group=4654f583227451fbe4ad06355cc8f976><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsrolejs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4654f583227451fbe4ad06355cc8f976","modelsrolejs")'>
<span class=tab-nav-text>models/role.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsrolejs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Role model
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports RoleSchema the schema for the Role model
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Sequelize</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   schemas:
</span></span></span><span class=line><span class=cl><span class=cm> *     Role:
</span></span></span><span class=line><span class=cl><span class=cm> *       type: object
</span></span></span><span class=line><span class=cl><span class=cm> *       required:
</span></span></span><span class=line><span class=cl><span class=cm> *         - role
</span></span></span><span class=line><span class=cl><span class=cm> *       properties:
</span></span></span><span class=line><span class=cl><span class=cm> *         id:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *           description: autogenerated id
</span></span></span><span class=line><span class=cl><span class=cm> *         role:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           description: name of the role
</span></span></span><span class=line><span class=cl><span class=cm> *         createdAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was created
</span></span></span><span class=line><span class=cl><span class=cm> *         updatedAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was last updated
</span></span></span><span class=line><span class=cl><span class=cm> *       example:
</span></span></span><span class=line><span class=cl><span class=cm> *           id: 1
</span></span></span><span class=line><span class=cl><span class=cm> *           role: manage_users
</span></span></span><span class=line><span class=cl><span class=cm> *           createdAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class=line><span class=cl><span class=cm> *           updatedAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>RoleSchema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>autoIncrement</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>role</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>STRING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>RoleSchema</span></span></span></code></pre></div></div></div></div></div><p>Notice that this file is very similar to the <code>models/user.js</code> file created earlier, with a few careful changes made to match the table schema.</p><p>We also need to create a model schema for the <code>user_roles</code> table, which we will store in the <code>models/user_role.js</code> file with the following content:</p><div class=tab-panel data-tab-group=8d81ae2374270b3cc712f68fa7a7d476><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsuser_rolejs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8d81ae2374270b3cc712f68fa7a7d476","modelsuser_rolejs")'>
<span class=tab-nav-text>models/user_role.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsuser_rolejs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file User role junction model
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports RoleSchema the schema for the UserRole model
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Sequelize</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>UserRoleSchema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>userId</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>references</span><span class=o>:</span> <span class=p>{</span> <span class=nx>model</span><span class=o>:</span> <span class=s1>&#39;User&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;id&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>onDelete</span><span class=o>:</span> <span class=s2>&#34;cascade&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>roleId</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>references</span><span class=o>:</span> <span class=p>{</span> <span class=nx>model</span><span class=o>:</span> <span class=s1>&#39;Role&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;id&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>onDelete</span><span class=o>:</span> <span class=s2>&#34;cascade&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>UserRoleSchema</span></span></span></code></pre></div></div></div></div></div><p>Finally, we can now update our <code>models/models.js</code> file to create the <code>Role</code> and <code>UserRole</code> models, and also to define the associations between them and the <code>User</code> model.</p><div class=tab-panel data-tab-group=607ef37fcbed88e9d3d892bcece1118f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsmodelsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("607ef37fcbed88e9d3d892bcece1118f","modelsmodelsjs")'>
<span class=tab-nav-text>models/models.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsmodelsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Database models
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports User a Sequelize User model
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @exports Role a Sequelize Role model
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @exports UserRole a Sequelize UserRole model
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import database connection
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;../configs/database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Schemas
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>UserSchema</span> <span class=nx>from</span> <span class=s1>&#39;./user.js&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>RoleSchema</span> <span class=nx>from</span> <span class=s2>&#34;./role.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>UserRoleSchema</span> <span class=nx>from</span> <span class=s2>&#34;./user_role.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create User Model
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>User</span> <span class=o>=</span> <span class=nx>database</span><span class=p>.</span><span class=nx>define</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Model Name
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s1>&#39;User&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Schema
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>UserSchema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Other options
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>tableName</span><span class=o>:</span> <span class=s1>&#39;users&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Create Role Model
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>Role</span> <span class=o>=</span> <span class=nx>database</span><span class=p>.</span><span class=nx>define</span><span class=p>(</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Model Name
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=s1>&#39;Role&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Schema
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=nx>RoleSchema</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Other options
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>tableName</span><span class=o>:</span> <span class=s1>&#39;roles&#39;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Create UserRole Model
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>UserRole</span> <span class=o>=</span> <span class=nx>database</span><span class=p>.</span><span class=nx>define</span><span class=p>(</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Model Name
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=s1>&#39;UserRole&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Schema
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=nx>UserRoleSchema</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Other options
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>tableName</span><span class=o>:</span> <span class=s1>&#39;user_roles&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>timestamps</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>underscored</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Define Associations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>Role</span><span class=p>.</span><span class=nx>belongsToMany</span><span class=p>(</span><span class=nx>User</span><span class=p>,</span> <span class=p>{</span> <span class=nx>through</span><span class=o>:</span> <span class=nx>UserRole</span><span class=p>,</span> <span class=nx>unique</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;users&#34;</span> <span class=p>})</span>
</span></span><span class="line hl"><span class=cl><span class=nx>User</span><span class=p>.</span><span class=nx>belongsToMany</span><span class=p>(</span><span class=nx>Role</span><span class=p>,</span> <span class=p>{</span> <span class=nx>through</span><span class=o>:</span> <span class=nx>UserRole</span><span class=p>,</span> <span class=nx>unique</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>User</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>Role</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>UserRole</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Notice that this file contains two lines at the bottom to define the associations included as part of this table, so that <code>sequelize</code> will know how to handle it. This will instruct <code>sequelize</code> to add additional attributes and features to the <code>User</code> and <code>Role</code> models for querying the related data, as we&rsquo;ll see shortly.</p><p>We also added the line <code>timestamps: false</code> to the other options for the <code>User_roles</code> table to disable the creation and management of timestamps (the <code>createdAt</code> and <code>updatedAt</code> attributes), since they may not be needed for this relation.</p><p>Finally, we added the <code>underscored: true</code> line to tell <code>sequelize</code> that it should interpret the <code>userId</code> and <code>roleId</code> attributes (written in camel case as preferred by Sequelize) as <code>user_id</code> and <code>role_id</code>, respectively (written in snake case as we did in the migration).</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Camel Case vs. Snake Case</div><div class=box-content><p>The choice of either CamelCase or snake_case naming for database attributes is a matter of preference. In this example, we show both methods, and it is up to each developer to select their own preferred style.</p></div></div><h2 id=seed>Seed</h2><p>Finally, let&rsquo;s create a new seed file in <code>seeds/01_roles.js</code> to add some default data to the <code>roles</code> and <code>user_roles</code> tables:</p><div class=tab-panel data-tab-group=cf9e55e8adb4955643f0f7b86ef33411><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=seeds01_rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cf9e55e8adb4955643f0f7b86ef33411","seeds01_rolesjs")'>
<span class=tab-nav-text>seeds/01_roles.js</span></button></div><div class=tab-content-container><div data-tab-item=seeds01_rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Roles seed
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports up the Up migration
</span></span></span><span class=line><span class=cl><span class=cm> * @exports down the Down migration
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Timestamp in the appropriate format for the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>now</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>().</span><span class=nx>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>23</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=s2>&#34;T&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34; +00:00&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Array of objects to add to the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;manage_users&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;manage_documents&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;add_documents&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;manage_communities&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;add_communities&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;view_documents&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;view_communities&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>user_roles</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Apply the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=s1>&#39;roles&#39;</span><span class=p>,</span> <span class=nx>roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=s1>&#39;user_roles&#39;</span><span class=p>,</span> <span class=nx>user_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Roll back the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>down</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkDelete</span><span class=p>(</span><span class=s1>&#39;user_roles&#39;</span><span class=p>,</span> <span class=p>{}</span> <span class=p>,</span> <span class=p>{</span> <span class=nx>truncate</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkDelete</span><span class=p>(</span><span class=s2>&#34;roles&#34;</span><span class=p>,</span> <span class=p>{},</span> <span class=p>{</span> <span class=nx>truncate</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Once again, this seed is very similar to what we&rsquo;ve seen before. Notice that we use the <code>truncate</code> option to remove all entries in the <code>user_roles</code> table when we undo this seed as well as the <code>roles</code> table.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Seeding from a CSV File</div><div class=box-content><p>It is also possible to seed the database from a CSV or other data file using a bit of JavaScript code. Here&rsquo;s an example for seeding a table that contains all of the counties in Kansas using a CSV file with that data that is read with the <a href=https://www.npmjs.com/package/convert-csv-to-json rel=external target=_blank>convert-csv-to-json</a> library:</p><div class=tab-panel data-tab-group=7ed95d54b3c9cc9a367f9b49915adeee><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=seeds02_countiesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7ed95d54b3c9cc9a367f9b49915adeee","seeds02_countiesjs")'>
<span class=tab-nav-text>seeds/02_counties.js</span></button></div><div class=tab-content-container><div data-tab-item=seeds02_countiesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>csvToJson</span> <span class=o>=</span> <span class=kr>import</span><span class=p>(</span><span class=s2>&#34;convert-csv-to-json&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Timestamp in the appropriate format for the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>now</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>().</span><span class=nx>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>23</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=s2>&#34;T&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34; +00:00&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span> <span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Read data from CSV file
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// id,name,code,seat,population,est_year
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 1,Allen,AL,Iola,&#34;12,464&#34;,1855
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>counties</span> <span class=o>=</span> <span class=p>(</span><span class=kr>await</span> <span class=nx>csvToJson</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>formatValueByType</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>supportQuotedField</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>fieldDelimiter</span><span class=p>(</span><span class=s2>&#34;,&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>getJsonFromCsv</span><span class=p>(</span><span class=s2>&#34;./seeds/counties.csv&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// append timestamps and parse fields
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>counties</span><span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>c</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// handle parsing numbers with comma separators
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>c</span><span class=p>.</span><span class=nx>population</span> <span class=o>=</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>population</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/,/g</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nx>createdAt</span> <span class=o>=</span> <span class=nx>now</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nx>updatedAt</span> <span class=o>=</span> <span class=nx>now</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// insert into database
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=s2>&#34;counties&#34;</span><span class=p>,</span> <span class=nx>counties</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>down</span><span class=p>({</span> <span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkDelete</span><span class=p>(</span><span class=s2>&#34;counties&#34;</span><span class=p>,</span> <span class=p>{},</span> <span class=p>{</span> <span class=nx>truncate</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div></div></div><h2 id=update-user-model>Update User Model</h2><p>Finally, let&rsquo;s update the <code>User</code> model schema to include related roles. At this point, we just have to update the Open API documentation to match:</p><div class=tab-panel data-tab-group=2e72ce90e3707a5af8912076c7d4dd61><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsuserjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2e72ce90e3707a5af8912076c7d4dd61","modelsuserjs")'>
<span class=tab-nav-text>models/user.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsuserjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   schemas:
</span></span></span><span class=line><span class=cl><span class=cm> *     User:
</span></span></span><span class=line><span class=cl><span class=cm> *       type: object
</span></span></span><span class=line><span class=cl><span class=cm> *       required:
</span></span></span><span class=line><span class=cl><span class=cm> *         - username
</span></span></span><span class=line><span class=cl><span class=cm> *       properties:
</span></span></span><span class=line><span class=cl><span class=cm> *         id:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *           description: autogenerated id
</span></span></span><span class=line><span class=cl><span class=cm> *         username:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           description: username for the user
</span></span></span><span class=line><span class=cl><span class=cm> *         createdAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was created
</span></span></span><span class=line><span class=cl><span class=cm> *         updatedAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was last updated
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         roles:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *           type: array
</span></span></span><span class="line hl"><span class=cl><span class=cm> *           items:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *             $ref: &#39;#/components/schemas/Role&#39;
</span></span></span><span class=line><span class=cl><span class=cm> *       example:
</span></span></span><span class=line><span class=cl><span class=cm> *           id: 1
</span></span></span><span class=line><span class=cl><span class=cm> *           username: admin
</span></span></span><span class=line><span class=cl><span class=cm> *           createdAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class=line><span class=cl><span class=cm> *           updatedAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class="line hl"><span class=cl><span class=cm> *           roles:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *             - id: 1
</span></span></span><span class="line hl"><span class=cl><span class=cm> *               role: manage_users
</span></span></span><span class="line hl"><span class=cl><span class=cm> *             - id: 2
</span></span></span><span class="line hl"><span class=cl><span class=cm> *               role: manage_documents
</span></span></span><span class="line hl"><span class=cl><span class=cm> *             - id: 4
</span></span></span><span class="line hl"><span class=cl><span class=cm> *               role: manage_communities
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now we can modify our route in <code>routes/users.js</code> to include the data from the related <code>Role</code> model in our query:</p><div class=tab-panel data-tab-group=f25fe302f170c8be0989edbc75f9dadb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesusersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f25fe302f170c8be0989edbc75f9dadb","routesusersjs")'>
<span class=tab-nav-text>routes/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesusersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: users
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Users Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;../models/models.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of users
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /users:
</span></span></span><span class=line><span class=cl><span class=cm> *   get: 
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: users list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all users in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of users
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 $ref: &#39;#/components/schemas/User&#39;          
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findAll</span><span class=p>({</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=s1>&#39;role&#39;</span><span class=p>],</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>You can learn more about querying associations in the <a href=https://sequelize.org/docs/v6/core-concepts/assocs/#basics-of-queries-involving-associations rel=external target=_blank>Sequelize Documentation</a>.</p><p>If everything works, we should see our roles now included in our JSON output when we navigate to the <code>/users</code> route:</p><div class=tab-panel data-tab-group=29286c6fd7abe490fd969b3ad0046878><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=route-users class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("29286c6fd7abe490fd969b3ad0046878","route-users")'>
<span class=tab-nav-text>route: /users</span></button></div><div class=tab-content-container><div data-tab-item=route-users class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[
  {
    &#34;id&#34;: 1,
    &#34;username&#34;: &#34;admin&#34;,
    &#34;createdAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;updatedAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;roles&#34;: [
      {
        &#34;id&#34;: 1,
        &#34;role&#34;: &#34;manage_users&#34;
      },
      {
        &#34;id&#34;: 2,
        &#34;role&#34;: &#34;manage_documents&#34;
      },
      {
        &#34;id&#34;: 4,
        &#34;role&#34;: &#34;manage_communities&#34;
      }
    ]
  },
  {
    &#34;id&#34;: 2,
    &#34;username&#34;: &#34;contributor&#34;,
    &#34;createdAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;updatedAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;roles&#34;: [
      {
        &#34;id&#34;: 3,
        &#34;role&#34;: &#34;add_documents&#34;
      },
      {
        &#34;id&#34;: 5,
        &#34;role&#34;: &#34;add_communities&#34;
      }
    ]
  },
  {
    &#34;id&#34;: 3,
    &#34;username&#34;: &#34;manager&#34;,
    &#34;createdAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;updatedAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;roles&#34;: [
      {
        &#34;id&#34;: 2,
        &#34;role&#34;: &#34;manage_documents&#34;
      },
      {
        &#34;id&#34;: 4,
        &#34;role&#34;: &#34;manage_communities&#34;
      }
    ]
  },
  {
    &#34;id&#34;: 4,
    &#34;username&#34;: &#34;user&#34;,
    &#34;createdAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;updatedAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;roles&#34;: [
      {
        &#34;id&#34;: 6,
        &#34;role&#34;: &#34;view_documents&#34;
      },
      {
        &#34;id&#34;: 7,
        &#34;role&#34;: &#34;view_communities&#34;
      }
    ]
  }
]</code></pre></div></div></div></div></div><p>That should also exactly match the schema and route information in our Open API documentation provided at the <code>/docs</code> route.</p><p>There we go! That&rsquo;s a quick example of adding an additional table to our application, including a relationship and more.</p><p>As a last step before finalizing our code, we should run the <code>lint</code> and <code>format</code> commands and deal with any errors they find. Finally, we can <strong>commit and push</strong> our work.</p><footer class=footline></footer></article></section></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/abfa6fce3f9ac37e49a25e050e271652415a0dc4>Feb 3, 2025</a></p></div></div><script src=/cis526/js/clipboard.min.js?1744316876 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1744316876 defer></script><script src=/cis526/js/theme.js?1744316876 defer></script></body></html>
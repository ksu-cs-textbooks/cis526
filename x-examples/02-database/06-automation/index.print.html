<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=robots content="noindex, nofollow, noarchive, noimageindex"><meta name=description content="YouTube Video Automating Database Deployment One very helpful feature we can add to our application is the ability to automatically migrate and seed the database when the application first starts. This can be especially helpful when deploying this application in a container.
To do this, let’s add some additional code to our bin/www file that is executed when our project starts:
​ bin/www /** * @file Executable entrypoint for the web application * @author Russell Feldhausen <russfeld@ksu."><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Automation :: CIS 526 Textbook"><meta name=twitter:description content="YouTube Video Automating Database Deployment One very helpful feature we can add to our application is the ability to automatically migrate and seed the database when the application first starts. This can be especially helpful when deploying this application in a container.
To do this, let’s add some additional code to our bin/www file that is executed when our project starts:
​ bin/www /** * @file Executable entrypoint for the web application * @author Russell Feldhausen <russfeld@ksu."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/02-database/06-automation/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Automation :: CIS 526 Textbook"><meta property="og:description" content="YouTube Video Automating Database Deployment One very helpful feature we can add to our application is the ability to automatically migrate and seed the database when the application first starts. This can be especially helpful when deploying this application in a container.
To do this, let’s add some additional code to our bin/www file that is executed when our project starts:
​ bin/www /** * @file Executable entrypoint for the web application * @author Russell Feldhausen <russfeld@ksu."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="Example Projects"><meta property="article:modified_time" content="2025-02-04T12:58:51-06:00"><meta itemprop=name content="Automation :: CIS 526 Textbook"><meta itemprop=description content="YouTube Video Automating Database Deployment One very helpful feature we can add to our application is the ability to automatically migrate and seed the database when the application first starts. This can be especially helpful when deploying this application in a container.
To do this, let’s add some additional code to our bin/www file that is executed when our project starts:
​ bin/www /** * @file Executable entrypoint for the web application * @author Russell Feldhausen <russfeld@ksu."><meta itemprop=dateModified content="2025-02-04T12:58:51-06:00"><meta itemprop=wordCount content="572"><title>Automation :: CIS 526 Textbook</title>
<link href=/cis526/css/fontawesome-all.min.css?1738972486 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1738972486 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1738972486 rel=stylesheet><link href=/cis526/css/auto-complete.css?1738972486 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1738972486 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1738972486 rel=stylesheet><link href=/cis526/css/fonts.css?1738972486 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1738972486 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1738972486 rel=stylesheet><link href=/cis526/css/theme-auto.css?1738972486 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1738972486 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1738972486 rel=stylesheet><link href=/cis526/css/print.css?1738972486 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1738972486 rel=stylesheet><script src=/cis526/js/variant.js?1738972486></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../../..",window.relearn.relBaseUri="../../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1738972486 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/x-examples/02-database/06-automation/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/cis526/x-examples/><span itemprop=name>Example Projects</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/cis526/x-examples/02-database/><span itemprop=name>Adding a Database</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Automation</span><meta itemprop=position content="3"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/02-database/05-documenting/ title="Documenting Models (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/02-database/07-another-table/ title="Another Table (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=automation>Automation</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=automating-database-deployment>Automating Database Deployment</h2><p>One very helpful feature we can add to our application is the ability to automatically migrate and seed the database when the application first starts. This can be especially helpful when deploying this application in a container.</p><p>To do this, let&rsquo;s add some additional code to our <code>bin/www</code> file that is executed when our project starts:</p><div class=tab-panel data-tab-group=0f74785f53c2610041b999e42f0c1018><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0f74785f53c2610041b999e42f0c1018","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Executable entrypoint for the web application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s1>&#39;../app.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s1>&#39;../configs/database.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;../configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>migrations</span> <span class=nx>from</span> <span class=s1>&#39;../configs/migrations.js&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>seeds</span> <span class=nx>from</span> <span class=s1>&#39;../configs/seeds.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get port from environment and store in Express.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>port</span> <span class=o>=</span> <span class=nx>normalizePort</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>||</span> <span class=s1>&#39;3000&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;port&#39;</span><span class=p>,</span> <span class=nx>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create HTTP server.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Attach event handlers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>server</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=nx>onError</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>server</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;listening&#39;</span><span class=p>,</span> <span class=nx>onListening</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Call startup function
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>startup</span><span class=p>();</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=cm>/**
</span></span></span><span class="line hl"><span class=cl><span class=cm> * Server startup function
</span></span></span><span class="line hl"><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kd>function</span> <span class=nx>startup</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Test database connection
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=nx>database</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Database connection successful&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Run migrations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>migrations</span><span class=p>.</span><span class=nx>up</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Database migrations complete&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SEED_DATA</span> <span class=o>===</span> <span class=s1>&#39;true&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=s2>&#34;Database data seeding is enabled!&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>seeds</span><span class=p>.</span><span class=nx>up</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>            <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Database seeding complete&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>            <span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>port</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>          <span class=c1>// Listen on provided port, on all network interfaces.
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>          <span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>port</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>){</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>We now have a new <code>startup</code> function that will first test the database connection, then run the migrations, and finally it will seed the database if the <code>SEED_DATA</code> environment variable is set to <code>true</code>. Once all that is done, it will start the application by calling <code>server.listen</code> using the port.</p><p>Notice that this code uses the <code>then()</code> function to resolve promises instead of the <code>async</code> and <code>await</code> keywords. This is because it is running at the top level, and cannot include any <code>await</code> keywords.</p><p>To enable this, let&rsquo;s add the <code>SEED_DATA</code> environment variable to both <code>.env</code> and <code>.env.example</code>:</p><div class=tab-panel data-tab-group=e694b2dfb130f38b00d31ec09930b8b2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e694b2dfb130f38b00d31ec09930b8b2","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>https://<span class=nv>$CODESPACE_NAME</span>-<span class=nv>$PORT</span>.<span class=nv>$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>database.sqlite
</span></span><span class="line hl"><span class=cl><span class=nv>SEED_DATA</span><span class=o>=</span>true</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=51f290c7da5b947eb52b4170894a6b27><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=envexample class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("51f290c7da5b947eb52b4170894a6b27","envexample")'>
<span class=tab-nav-text>.env.example</span></button></div><div class=tab-content-container><div data-tab-item=envexample class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>http://localhost:3000
</span></span><span class=line><span class=cl><span class=c1># For GitHub Codespaces</span>
</span></span><span class=line><span class=cl><span class=c1># OPENAPI_HOST=https://$CODESPACE_NAME-$PORT.$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>database.sqlite
</span></span><span class="line hl"><span class=cl><span class=nv>SEED_DATA</span><span class=o>=</span>false</span></span></code></pre></div></div></div></div></div><p>To test this, we can delete the <code>database.sqlite</code> file in our repository, then start our project:</p><div class=tab-panel data-tab-group=db38a5116b90f3a5d210c19a34500c08><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("db38a5116b90f3a5d210c19a34500c08","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>If it works correctly, we should see that our application is able to connect to the database, migrate the schema, and add the seed data, before fully starting:</p><div class=tab-panel data-tab-group=379fc7a16254108bd9cd8b8522957805><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("379fc7a16254108bd9cd8b8522957805","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight hl_lines=11-23><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[dotenvx@1.34.0] injecting env (6) from .env
[2025-02-04 06:56:11.823 PM] warn:      OpenAPI documentation visible!
[2025-02-04 06:56:12.163 PM] debug:     Database connection successful
[2025-02-04 06:56:12.208 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }
[2025-02-04 06:56:12.265 PM] info:      { event: &#39;migrated&#39;, name: &#39;00_users.js&#39;, durationSeconds: 0.058 }
[2025-02-04 06:56:12.266 PM] debug:     Database migrations complete
[2025-02-04 06:56:12.266 PM] warn:      Database data seeding is enabled!
[2025-02-04 06:56:12.296 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }
[2025-02-04 06:56:12.321 PM] info:      { event: &#39;migrated&#39;, name: &#39;00_users.js&#39;, durationSeconds: 0.024 }
[2025-02-04 06:56:12.321 PM] debug:     Database seeding complete
[2025-02-04 06:56:12.323 PM] debug:     Listening on port 3000</code></pre></div></div></div></div></div><p>There we go! Our application will now always make sure the database is properly migrated, and optionally seeded, before it starts. Now, when another developer or user starts our application, it will be sure to have a working database.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><footer class=footline></footer></article></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/6812b19d4992624a53c44a6be7840de25bd8afe7>Feb 4, 2025</a></p></div></div><script src=/cis526/js/clipboard.min.js?1738972486 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1738972486 defer></script><script src=/cis526/js/theme.js?1738972486 defer></script></body></html>
<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="This example project builds on the previous Vue.js CRUD app by discussing some more advanced topics related to web application development.
Project Deliverables At the end of this example, we will have a project with the following features:
A Pinia store that handles storing users and roles, and all Vue components adapted to use that Pinia store A DynamicDialog for editing and creating users, which repurposes the UserEdit component A working Dockerfile for the project A working GitHub Action to build the Docker image and release it on GitHub A working Docker Compose file to deploy the application The application is adapted to optionally use Postgres instead of SQLite as the database engine Prior Work This project picks up right where the last one left off, so if you havenâ€™t completed that one yet, go back and do that before starting this one."><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Advanced Topics :: CIS 526 Textbook"><meta name=twitter:description content="This example project builds on the previous Vue.js CRUD app by discussing some more advanced topics related to web application development.
Project Deliverables At the end of this example, we will have a project with the following features:
A Pinia store that handles storing users and roles, and all Vue components adapted to use that Pinia store A DynamicDialog for editing and creating users, which repurposes the UserEdit component A working Dockerfile for the project A working GitHub Action to build the Docker image and release it on GitHub A working Docker Compose file to deploy the application The application is adapted to optionally use Postgres instead of SQLite as the database engine Prior Work This project picks up right where the last one left off, so if you havenâ€™t completed that one yet, go back and do that before starting this one."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/07-advanced-topics/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Advanced Topics :: CIS 526 Textbook"><meta property="og:description" content="This example project builds on the previous Vue.js CRUD app by discussing some more advanced topics related to web application development.
Project Deliverables At the end of this example, we will have a project with the following features:
A Pinia store that handles storing users and roles, and all Vue components adapted to use that Pinia store A DynamicDialog for editing and creating users, which repurposes the UserEdit component A working Dockerfile for the project A working GitHub Action to build the Docker image and release it on GitHub A working Docker Compose file to deploy the application The application is adapted to optionally use Postgres instead of SQLite as the database engine Prior Work This project picks up right where the last one left off, so if you havenâ€™t completed that one yet, go back and do that before starting this one."><meta property="og:locale" content="en-us"><meta property="og:type" content="website"><meta itemprop=name content="Advanced Topics :: CIS 526 Textbook"><meta itemprop=description content="This example project builds on the previous Vue.js CRUD app by discussing some more advanced topics related to web application development.
Project Deliverables At the end of this example, we will have a project with the following features:
A Pinia store that handles storing users and roles, and all Vue components adapted to use that Pinia store A DynamicDialog for editing and creating users, which repurposes the UserEdit component A working Dockerfile for the project A working GitHub Action to build the Docker image and release it on GitHub A working Docker Compose file to deploy the application The application is adapted to optionally use Postgres instead of SQLite as the database engine Prior Work This project picks up right where the last one left off, so if you havenâ€™t completed that one yet, go back and do that before starting this one."><meta itemprop=dateModified content="2025-04-28T09:12:19-05:00"><meta itemprop=wordCount content="146"><title>Advanced Topics :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/x-examples/07-advanced-topics/ rel=canonical type=text/html title="Advanced Topics :: CIS 526 Textbook"><link href=/cis526/x-examples/07-advanced-topics/index.xml rel=alternate type=application/rss+xml title="Advanced Topics :: CIS 526 Textbook"><link href=/cis526/x-examples/07-advanced-topics/tele.html rel=alternate type=text/html title="Advanced Topics :: CIS 526 Textbook"><link href=/cis526/x-examples/07-advanced-topics/embed.html rel=alternate type=text/html title="Advanced Topics :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1747410760 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1747410760 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1747410760 rel=stylesheet><link href=/cis526/css/auto-complete.css?1747410760 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1747410760 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1747410760 rel=stylesheet><link href=/cis526/css/fonts.css?1747410760 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1747410760 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1747410760 rel=stylesheet><link href=/cis526/css/theme-auto.css?1747410760 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1747410760 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1747410760 rel=stylesheet><link href=/cis526/css/print.css?1747410760 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1747410760 rel=stylesheet><script src=/cis526/js/variant.js?1747410760></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../..",window.relearn.relBaseUri="../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1747410760 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/x-examples/07-advanced-topics/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/cis526/x-examples/><span itemprop=name>Example Projects</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Advanced Topics</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/06-vue-crud-app/06-delete-user/ title="Delete User (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/07-advanced-topics/01-pinia/ title="Pinia (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=advanced-topics>Advanced Topics</h1><p>This example project builds on the previous Vue.js CRUD app by discussing some more advanced topics related to web application development.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li>A Pinia store that handles storing users and roles, and all Vue components adapted to use that Pinia store</li><li>A DynamicDialog for editing and creating users, which repurposes the UserEdit component</li><li>A working Dockerfile for the project</li><li>A working GitHub Action to build the Docker image and release it on GitHub</li><li>A working Docker Compose file to deploy the application</li><li>The application is adapted to optionally use Postgres instead of SQLite as the database engine</li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Advanced Topics</h1><article class=default><header class=headline></header><h1 id=pinia>Pinia</h1><a href="https://www.youtube.com/watch?v=YioSayQjW70">YouTube Video</a><h2 id=props>Props</h2><p>So far, we&rsquo;ve mostly been dealing with data in our Vue components in one of two ways:</p><ol><li>It is requested directly from the RESTful API for the component (as in the <code>UsersList</code> and <code>UserEdit</code> components)</li><li>It is passed in from a parent component, especially if it is a small helper component (as in the <code>RoleChip</code> and <code>TextField</code> components)</li></ol><p>The only exception is the user&rsquo;s JSON Web Token (JWT), which we have stored in a Pinia store. However, we didn&rsquo;t spend much time talking about <em>why</em> we stored that token in a Pinia store instead of just making it a global reactive state component and passing that state down the component tree using props.</p><p>The concept of passing props down through components, especially between many layers of components, is known as <a href=https://vuejs.org/guide/components/provide-inject rel=external target=_blank>Prop Drilling</a></p><p><a href=#R-image-29471c5e0af964c2de208d29d3473a2f class=lightbox-link><img alt="Prop Drilling" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/07/prop-drilling.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-29471c5e0af964c2de208d29d3473a2f><img alt="Prop Drilling" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/07/prop-drilling.png></a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>While this method can work well, it can also make an application very complicated with the sheer number of props that must be passed through each component. For example, imagine if each page and component needed access to the user&rsquo;s JWT to determine which actions to allow (a very real example from the project we are working). In that case, each component may need to be aware of the token as an incoming prop, and may also need to pass it along to any child components that may need it, even if it is three or four layers deep.</p><h2 id=provide--inject>Provide / Inject</h2><p>The Vue framework itself does have a solution to this problem, which is the <a href=https://vuejs.org/guide/components/provide-inject rel=external target=_blank>Provide / Inject</a> interface. In effect, a component can declare a reactive state item and add it to a global dictionary of state items that are available using the <code>provide</code> method along with a unique key for that item, and any other component can receive a reference to that state item using the <code>inject</code> method with the same key.</p><p><a href=#R-image-ade12ccd058c4529542eff48aef08710 class=lightbox-link><img alt="Provide Inject" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/07/provide-inject.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ade12ccd058c4529542eff48aef08710><img alt="Provide Inject" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/07/provide-inject.png></a><sup id=fnref1:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>This is a bit of an improvement, but still has many issues that are discussed in the documentation. For example, it is best to only modify the state at the top-level component that is providing the state, so an additional function may need to be provided to enable proper editing of the state. In addition, for large apps it can be very difficult to ensure that each key is unique, and having hundreds or thousands of keys to keep track of can be a huge burden for programmers.</p><h2 id=pinia>Pinia</h2><p>The <a href=https://pinia.vuejs.org/ rel=external target=_blank>Pinia</a> library tries to solve all of these issues by providing convenient <em>stores</em> for different types of information in the application. Each store is typically oriented toward a specific type of data (such as users or documents), and it contains all the methods needed to read and modify the state as needed. Then, each component that needs access to the state can simply request a reference to the stores it needs, and everything is nicely compartmentalized and easy to maintain.</p><p>To see how this can help simplify our application, let&rsquo;s look at how we can create a <code>Users</code> store to interface with our RESTful API and maintain a globally-accessible store for data about our users.</p><h2 id=creating-a-pinia-store>Creating a Pinia Store</h2><p>To create a Pinia store, we can create a new file <code>src/stores/User.js</code> with the following initial content:</p><div class=tab-panel data-tab-group=919b281cb09632c8eeec4e39c4bac192><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcstoresuserjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("919b281cb09632c8eeec4e39c4bac192","srcstoresuserjs")'>
<span class=tab-nav-text>src/stores/User.js</span></button></div><div class=tab-content-container><div data-tab-item=srcstoresuserjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file User Store
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>defineStore</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;pinia&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>api</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/configs/api&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Define Store
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>useUserStore</span> <span class=o>=</span> <span class=nx>defineStore</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// State Properties
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Getters
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Actions
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Return all state, getters, and actions
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=p>{</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>This is a nice starting structure for a store. At the bare minimum, we use the <a href=https://pinia.vuejs.org/core-concepts/ rel=external target=_blank>defineStore</a> method from Pinia to create the store. Inside of that method is a lambda function that actually defines the contents of the store itself, which we&rsquo;ll iteratively build over time. We&rsquo;ve also imported a few useful library functions, including our pre-built Axios API interface to make it easy to send requests to our API.</p><h2 id=properties>Properties</h2><p>The first items we should add to our Pinia store are the state properties that we&rsquo;ll be tracking. These can be anything from simple values all the way up to entire arrays of objects full of data. In most cases, it makes sense to have each Pinia store track data in a format similar to what our application will need. For this example, we&rsquo;ll use this store to track both the <code>users</code> and <code>roles</code> that are available in our system. So, we&rsquo;ll need to create two reactive state variables using the <code>ref()</code> function from Vue to store that data as state in our Pinia store:</p><div class=tab-panel data-tab-group=cc9de13ba5eb2554748471ed8b41a1ea><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcstoresuserjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cc9de13ba5eb2554748471ed8b41a1ea","srcstoresuserjs")'>
<span class=tab-nav-text>src/stores/User.js</span></button></div><div class=tab-content-container><div data-tab-item=srcstoresuserjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Define Store
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>useUserStore</span> <span class=o>=</span> <span class=nx>defineStore</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// State Properties
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([])</span>
</span></span><span class="line hl"><span class=cl>  <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Getters
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// Actions
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// Return all state, getters, and actions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=p>{</span> <span class=nx>users</span><span class=p>,</span> <span class=nx>roles</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>Each state property in Pinia is just a reactive state variable from Vue that can be shared across our entire application. So, we&rsquo;ll just initialize each one to an empty array for now.</p><h2 id=actions---hydrate>Actions - Hydrate</h2><p>Before we tackle any getters, let&rsquo;s look at how we can actually get this data from our RESTful API. In many web development frameworks, the process of loading data from the AI is sometimes referred to as <a href=https://en.wikipedia.org/wiki/Hydration_(web_development) rel=external target=_blank>Hydration</a>. So, let&rsquo;s write a method we can use the <em>hydrate</em> these two state variables by making a request to our RESTful API. Most of this code is lifted directly from our existing <code>UsersList</code> component:</p><div class=tab-panel data-tab-group=10160e4c31c9b8f53e4d1947c4d51167><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcstoresuserjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("10160e4c31c9b8f53e4d1947c4d51167","srcstoresuserjs")'>
<span class=tab-nav-text>src/stores/User.js</span></button></div><div class=tab-content-container><div data-tab-item=srcstoresuserjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Define Store
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>useUserStore</span> <span class=o>=</span> <span class=nx>defineStore</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// Actions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Load users and roles from the API
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=kd>function</span> <span class=nx>hydrate</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>api</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/v1/users&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>users</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>api</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/v1/roles&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>roles</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Return all state, getters, and actions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=p>{</span> <span class=nx>users</span><span class=p>,</span> <span class=nx>roles</span><span class=p>,</span> <span class=nx>hydrate</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>As we can see, this function will make two asynchronous requests to the RESTful API to load both the users and roles, and when those requests are resolved it will store the data in the appropriate state variable.</p><h2 id=getters>Getters</h2><p>For this Pinia store, we won&rsquo;t need any individual getters. Instead, we&rsquo;ll just use some functions in the component as needed to extract data from the store.</p><h2 id=actions---save--delete>Actions - Save & Delete</h2><p>Finally, let&rsquo;s add two more actions to allow us to both save and delete a user through our RESTful API. The code for the <code>save</code> function is mostly taken from our <code>UserEdit</code> component, while the code to delete a user comes from the <code>UserList</code> component, both with minor changes.</p><div class=tab-panel data-tab-group=37738629e6bba3283eca4341ab525118><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcstoresuserjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("37738629e6bba3283eca4341ab525118","srcstoresuserjs")'>
<span class=tab-nav-text>src/stores/User.js</span></button></div><div class=tab-content-container><div data-tab-item=srcstoresuserjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Define Store
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>useUserStore</span> <span class=o>=</span> <span class=nx>defineStore</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// Actions
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Save a user
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=kd>function</span> <span class=nx>saveUser</span><span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>method</span> <span class=o>=</span> <span class=s1>&#39;post&#39;</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>url</span> <span class=o>=</span> <span class=s1>&#39;/api/v1/users&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>id</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>method</span> <span class=o>=</span> <span class=s1>&#39;put&#39;</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span> <span class=o>=</span> <span class=nx>url</span> <span class=o>+</span> <span class=s1>&#39;/&#39;</span> <span class=o>+</span> <span class=nx>id</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>api</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>method</span><span class=o>:</span> <span class=nx>method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=nx>url</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>data</span><span class=o>:</span> <span class=nx>user</span><span class=p>.</span><span class=nx>value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// rehydrate data
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>hydrate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>response</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Error saving user!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=nx>error</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Delete a user
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=kd>function</span> <span class=nx>deleteUser</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>api</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=s1>&#39;/api/v1/users/&#39;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// rehydrate data
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>hydrate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>response</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Error deleting user!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=nx>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Return all state, getters, and actions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=p>{</span> <span class=nx>users</span><span class=p>,</span> <span class=nx>roles</span><span class=p>,</span> <span class=nx>hydrate</span><span class=p>,</span> <span class=nx>saveUser</span><span class=p>,</span> <span class=nx>deleteUser</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>As we can see in the code above, after each successful API call, we immediately call the <code>hydrate</code> method to update the contents of our <code>users</code> and <code>roles</code> list before passing the response back to the calling method. This ensures that our data is always in sync with the RESTful API backend anytime we make a change. In addition, we are carefully logging any errors we receive here, but we are still throwing the errors back to the calling method so they can be handled there as well.</p><p>That is the basic contents of our <code>Users</code> store, which we can use throughout our application.</p><h2 id=using-a-store---userslist>Using a Store - UsersList</h2><p>Now, let&rsquo;s look at how we can use our store in our various components that require data from the <code>Users</code> and <code>Roles</code> APIs. First, we can take a look at our existing <code>UsersList</code> component - there are many lines that we&rsquo;ll remove or change within the component. Each change is highlighted and described below, with removed lines commented out.</p><div class=tab-panel data-tab-group=de8d967a9a349c91ca2febddb080841d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("de8d967a9a349c91ca2febddb080841d","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=c1>// Create Reactive State
</span></span></span><span class="line hl"><span class=cl><span class=c1>// const users = ref([])
</span></span></span><span class="line hl"><span class=cl><span class=c1>// const roles = ref([])
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=c1>// Stores
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>storeToRefs</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;pinia&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useUserStore</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/stores/User&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>userStore</span> <span class=o>=</span> <span class=nx>useUserStore</span><span class=p>();</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>users</span><span class=p>,</span> <span class=nx>roles</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>storeToRefs</span><span class=p>(</span><span class=nx>userStore</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>First, we replace the two reactive state variables for <code>users</code> and <code>roles</code> with the same state variables that are extracted from the Pinia store using the <code>storeToRefs()</code> function, which will <a href=https://pinia.vuejs.org/core-concepts/#Destructuring-from-a-Store rel=external target=_blank>Destructure the Store</a> and make the variables directly available to our code.</p><div class=tab-panel data-tab-group=ae7f2e270f260197f9d16a0a0bdd1c2f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ae7f2e270f260197f9d16a0a0bdd1c2f","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=c1>// Load Users
</span></span></span><span class="line hl"><span class=cl><span class=c1>//api
</span></span></span><span class="line hl"><span class=cl><span class=c1>//  .get(&#39;/api/v1/users&#39;)
</span></span></span><span class="line hl"><span class=cl><span class=c1>//  .then(function (response) {
</span></span></span><span class="line hl"><span class=cl><span class=c1>//    users.value = response.data
</span></span></span><span class="line hl"><span class=cl><span class=c1>//  })
</span></span></span><span class="line hl"><span class=cl><span class=c1>//  .catch(function (error) {
</span></span></span><span class="line hl"><span class=cl><span class=c1>//    console.log(error)
</span></span></span><span class="line hl"><span class=cl><span class=c1>//  })
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=c1>// Load Roles
</span></span></span><span class="line hl"><span class=cl><span class=c1>//api
</span></span></span><span class="line hl"><span class=cl><span class=c1>//  .get(&#39;/api/v1/roles&#39;)
</span></span></span><span class="line hl"><span class=cl><span class=c1>//  .then(function (response) {
</span></span></span><span class="line hl"><span class=cl><span class=c1>//    roles.value = response.data
</span></span></span><span class="line hl"><span class=cl><span class=c1>//  })
</span></span></span><span class="line hl"><span class=cl><span class=c1>//  .catch(function (error) {
</span></span></span><span class="line hl"><span class=cl><span class=c1>//    console.log(error)
</span></span></span><span class="line hl"><span class=cl><span class=c1>//  })
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=c1>// Hydrate Store
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>userStore</span><span class=p>.</span><span class=nx>hydrate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Next, we can replace all of the code used to load the users and roles on the page to a simple call to the <code>hydrate</code> method in the store itself.</p><div class=tab-panel data-tab-group=42995ec99a6e875d332c77d324693084><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("42995ec99a6e875d332c77d324693084","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Delete User
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>deleteUser</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>id</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=c1>// api
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>  <span class=c1>//   .delete(&#39;/api/v1/users/&#39; + id)
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>  <span class=nx>userStore</span><span class=p>.</span><span class=nx>deleteUser</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>200</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>toast</span><span class=p>.</span><span class=nx>add</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>severity</span><span class=o>:</span> <span class=s1>&#39;success&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>summary</span><span class=o>:</span> <span class=s1>&#39;Success&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>detail</span><span class=o>:</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>life</span><span class=o>:</span> <span class=mi>5000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>        <span class=c1>// Remove that element from the reactive array
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>        <span class=c1>// users.value.splice(
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>        <span class=c1>//   users.value.findIndex((u) =&gt; u.id == id),
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>        <span class=c1>//   1,
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>        <span class=c1>// )
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>toast</span><span class=p>.</span><span class=nx>add</span><span class=p>({</span> <span class=nx>severity</span><span class=o>:</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=nx>summary</span><span class=o>:</span> <span class=s1>&#39;Error&#39;</span><span class=p>,</span> <span class=nx>detail</span><span class=o>:</span> <span class=nx>error</span><span class=p>,</span> <span class=nx>life</span><span class=o>:</span> <span class=mi>5000</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Finally, in the method to delete a user, we can replace the API call with a call to the <code>deleteUser</code> method inside of the Pinia store to handle deleting the user with the selected ID. We can also remove the code that will remove the user from the list, since we no longer need to do that here; instead, the Pinia store will query the updated data from the RESTful API, and the user should no longer be present in that data when it is received.</p><p>Those are all of the changes needed to switch the <code>UsersList</code> component to use the store. The template itself remains exactly the same.</p><h2 id=using-a-store---useredit>Using a Store - UserEdit</h2><p>We can also update our <code>UserEdit</code> component in a similar way:</p><div class=tab-panel data-tab-group=2b06ee1caa6e35e36a28a9ce0700d96a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2b06ee1caa6e35e36a28a9ce0700d96a","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span><span class=p>,</span> <span class=nx>computed</span><span class=p>,</span> <span class=nx>inject</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Declare State
</span></span></span><span class="line hl"><span class=cl><span class=c1>// const user = ref({})
</span></span></span><span class="line hl"><span class=cl><span class=c1>// const roles = ref([])
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>errors</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([])</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Stores
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>storeToRefs</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;pinia&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useUserStore</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/stores/User&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>userStore</span> <span class=o>=</span> <span class=nx>useUserStore</span><span class=p>();</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>users</span><span class=p>,</span> <span class=nx>roles</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>storeToRefs</span><span class=p>(</span><span class=nx>userStore</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Find single user or a blank user
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=nx>computed</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=nx>users</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>id</span> <span class=o>==</span> <span class=nx>props</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span> <span class=o>||</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=nx>roles</span><span class=o>:</span> <span class=p>[]</span> <span class=p>})</span>
</span></span><span class="line hl"><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>First, we can replace the reactive state variables with the same variables from the Users store. To get a single user, we can create a computed state variable that will find the user in the list that matches the incoming <code>props.id</code>. If a user can&rsquo;t be found, it will generate a blank <code>User</code> object that can be used to create a new user.</p><p>Likewise, we can remove all of the code that loads users and roles and replace that with a <code>hydrate</code> function call in our Pinia store:</p><div class=tab-panel data-tab-group=7295afa79795b062ccc900e9bd1890ac><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7295afa79795b062ccc900e9bd1890ac","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=c1>// Load Users
</span></span></span><span class="line hl"><span class=cl><span class=c1>// if (props.id) {
</span></span></span><span class="line hl"><span class=cl><span class=c1>//   api
</span></span></span><span class="line hl"><span class=cl><span class=c1>//     .get(&#39;/api/v1/users/&#39; + props.id)
</span></span></span><span class="line hl"><span class=cl><span class=c1>//     .then(function (response) {
</span></span></span><span class="line hl"><span class=cl><span class=c1>//       user.value = response.data
</span></span></span><span class="line hl"><span class=cl><span class=c1>//     })
</span></span></span><span class="line hl"><span class=cl><span class=c1>//     .catch(function (error) {
</span></span></span><span class="line hl"><span class=cl><span class=c1>//       console.log(error)
</span></span></span><span class="line hl"><span class=cl><span class=c1>//     })
</span></span></span><span class="line hl"><span class=cl><span class=c1>// } else {
</span></span></span><span class="line hl"><span class=cl><span class=c1>//   // Empty Value for User Object
</span></span></span><span class="line hl"><span class=cl><span class=c1>//   user.value = {
</span></span></span><span class="line hl"><span class=cl><span class=c1>//     username: &#39;&#39;,
</span></span></span><span class="line hl"><span class=cl><span class=c1>//     roles: [],
</span></span></span><span class="line hl"><span class=cl><span class=c1>//   }
</span></span></span><span class="line hl"><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=c1>// Load Roles
</span></span></span><span class="line hl"><span class=cl><span class=c1>// api
</span></span></span><span class="line hl"><span class=cl><span class=c1>//   .get(&#39;/api/v1/roles&#39;)
</span></span></span><span class="line hl"><span class=cl><span class=c1>//   .then(function (response) {
</span></span></span><span class="line hl"><span class=cl><span class=c1>//     roles.value = response.data
</span></span></span><span class="line hl"><span class=cl><span class=c1>//   })
</span></span></span><span class="line hl"><span class=cl><span class=c1>//   .catch(function (error) {
</span></span></span><span class="line hl"><span class=cl><span class=c1>//     console.log(error)
</span></span></span><span class="line hl"><span class=cl><span class=c1>//   })
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=nx>userStore</span><span class=p>.</span><span class=nx>hydrate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Finally, we can replace the call to the <code>api</code> library to save the user with a call to the <code>saveUser</code> method in the <code>UserStore</code>:</p><div class=tab-panel data-tab-group=a8e346f0b7246d3e11d2de0603661367><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a8e346f0b7246d3e11d2de0603661367","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Save User
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>save</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>errors</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=nx>userStore</span><span class=p>.</span><span class=nx>saveUser</span><span class=p>(</span><span class=nx>props</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>201</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>toast</span><span class=p>.</span><span class=nx>add</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>severity</span><span class=o>:</span> <span class=s1>&#39;success&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>summary</span><span class=o>:</span> <span class=s1>&#39;Success&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>detail</span><span class=o>:</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>life</span><span class=o>:</span> <span class=mi>5000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;users&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>422</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>toast</span><span class=p>.</span><span class=nx>add</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>severity</span><span class=o>:</span> <span class=s1>&#39;warn&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>summary</span><span class=o>:</span> <span class=s1>&#39;Warning&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>detail</span><span class=o>:</span> <span class=nx>error</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>error</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>life</span><span class=o>:</span> <span class=mi>5000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=nx>errors</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>error</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>errors</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>toast</span><span class=p>.</span><span class=nx>add</span><span class=p>({</span> <span class=nx>severity</span><span class=o>:</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=nx>summary</span><span class=o>:</span> <span class=s1>&#39;Error&#39;</span><span class=p>,</span> <span class=nx>detail</span><span class=o>:</span> <span class=nx>error</span><span class=p>,</span> <span class=nx>life</span><span class=o>:</span> <span class=mi>5000</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>With those changes in place, we can also edit our users and create new users.</p><h2 id=using-a-store---roles>Using a Store - Roles</h2><p>Finally, we can update our <code>RolesList</code> to also use the store:</p><div class=tab-panel data-tab-group=987737eccf450249ac60fd570bb4b450><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsrolesroleslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("987737eccf450249ac60fd570bb4b450","srccomponentsrolesroleslistvue")'>
<span class=tab-nav-text>src/components/roles/RolesList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsrolesroleslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=c1>// Stores
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>storeToRefs</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;pinia&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useUserStore</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@/stores/User&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>userStore</span> <span class=o>=</span> <span class=nx>useUserStore</span><span class=p>();</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>roles</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>storeToRefs</span><span class=p>(</span><span class=nx>userStore</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Hydrate Store
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>userStore</span><span class=p>.</span><span class=nx>hydrate</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>At this point, all API calls to the <code>users</code> and <code>roles</code> endpoints should now be routed through our <code>User</code> Pinia store.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Image Source: <a href=https://vuejs.org/guide/components/provide-inject rel=external target=_blank>Pinia Documentation</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=reusing-components>Reusing Components</h1><a href="https://www.youtube.com/watch?v=6skldOnt7Sc">YouTube Video</a><h2 id=reusing-components>Reusing Components</h2><p>One of the many amazing features of a front-end framework such as Vue is the ability to reuse components in very powerful ways. For example, right now our application uses an entirely separate view and component to handle editing and updating users, but that means that we have to constantly jump back and forth between two views when working with users. Now that those views are using a shared Pinia store, we can use a <a href=https://primevue.org/dynamicdialog/ rel=external target=_blank>PrimeVue DynamicDialog</a> component to allow us to open the <code>UserEdit</code> component in a popup dialog on our <code>UsersList</code> component.</p><h2 id=installing-dynamicdialog>Installing DynamicDialog</h2><p>To begin, we must install the service for this component in our <code>src/main.js</code> along with the other services for PrimeVue components:</p><div class=tab-panel data-tab-group=dc6ec8644e3808d96443ae0701ebb2a1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcmainjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("dc6ec8644e3808d96443ae0701ebb2a1","srcmainjs")'>
<span class=tab-nav-text>src/main.js</span></button></div><div class=tab-content-container><div data-tab-item=srcmainjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Main Vue application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>createApp</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>createPinia</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;pinia&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>PrimeVue</span> <span class=nx>from</span> <span class=s1>&#39;primevue/config&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Aura</span> <span class=nx>from</span> <span class=s1>&#39;@primeuix/themes/aura&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Tooltip</span> <span class=nx>from</span> <span class=s1>&#39;primevue/tooltip&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>ToastService</span> <span class=nx>from</span> <span class=s1>&#39;primevue/toastservice&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>ConfirmationService</span> <span class=nx>from</span> <span class=s1>&#39;primevue/confirmationservice&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>DialogService</span> <span class=nx>from</span> <span class=s1>&#39;primevue/dialogservice&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Create Vue App
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>createApp</span><span class=p>(</span><span class=nx>App</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Install Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>createPinia</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>router</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>PrimeVue</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Theme Configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>theme</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>preset</span><span class=o>:</span> <span class=nx>Aura</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>darkModeSelector</span><span class=o>:</span> <span class=s1>&#39;.app-dark-mode&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>ToastService</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>ConfirmationService</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>DialogService</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Then, we can add the single instance of the component to our top-level <code>App.vue</code> component along with the other service components:</p><div class=tab-panel data-tab-group=c780615029d7a8e8167c29aa7fd6cf8c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srcappvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c780615029d7a8e8167c29aa7fd6cf8c","srcappvue")'>
<span class=tab-nav-text>src/App.vue</span></button></div><div class=tab-content-container><div data-tab-item=srcappvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Main Vue Application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Components
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Toast</span> <span class=nx>from</span> <span class=s1>&#39;primevue/toast&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>ConfirmDialog</span> <span class=nx>from</span> <span class=s1>&#39;primevue/confirmdialog&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>DynamicDialog</span> <span class=nx>from</span> <span class=s1>&#39;primevue/dynamicdialog&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>TopMenu</span> <span class=nx>from</span> <span class=s1>&#39;./components/layout/TopMenu.vue&#39;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>header</span><span class=p>&gt;&lt;/</span><span class=nt>header</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>nav</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>Navigation</span> <span class=nx>Menu</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>TopMenu</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>nav</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;m-2&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=c>&lt;!--</span> <span class=nx>Main</span> <span class=nx>Application</span> <span class=nx>View</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>RouterView</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>footer</span><span class=p>&gt;&lt;/</span><span class=nt>footer</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>Toast</span> <span class=na>position</span><span class=o>=</span><span class=s>&#34;bottom-right&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>ConfirmDialog</span> <span class=p>/&gt;</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>&lt;</span><span class=nt>DynamicDialog</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>That&rsquo;s all it takes to make this feature available throughout our application.</p><h2 id=updating-userslist-to-use-dynamicdialog>Updating UsersList to use DynamicDialog</h2><p>Now, in our <code>UsersList</code> component, we simply have to add a few imports as well as function to load the component in a dialog box:</p><div class=tab-panel data-tab-group=c180e3d141866c778dc30188a6a6d084><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c180e3d141866c778dc30188a6a6d084","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span><span class=p>,</span> <span class=nx>defineAsyncComponent</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>formatDistance</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;date-fns&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>DataTable</span> <span class=nx>from</span> <span class=s1>&#39;primevue/datatable&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Column</span> <span class=nx>from</span> <span class=s1>&#39;primevue/column&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>IconField</span><span class=p>,</span> <span class=nx>InputIcon</span><span class=p>,</span> <span class=nx>InputText</span><span class=p>,</span> <span class=nx>MultiSelect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>FilterMatchMode</span><span class=p>,</span> <span class=nx>FilterService</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@primevue/core/api&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>RoleChip</span> <span class=nx>from</span> <span class=s1>&#39;../roles/RoleChip.vue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Button</span> <span class=nx>from</span> <span class=s1>&#39;primevue/button&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useRouter</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue-router&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>useRouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useToast</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue/usetoast&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>toast</span> <span class=o>=</span> <span class=nx>useToast</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useConfirm</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>confirm</span> <span class=o>=</span> <span class=nx>useConfirm</span><span class=p>()</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useDialog</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;primevue/usedialog&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>dialog</span> <span class=o>=</span> <span class=nx>useDialog</span><span class=p>();</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>userEditComponent</span> <span class=o>=</span> <span class=nx>defineAsyncComponent</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;./UserEdit.vue&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class="line hl"><span class=cl><span class=c1>// Load Dialog
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>editDialog</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>id</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>dialog</span><span class=p>.</span><span class=nx>open</span><span class=p>(</span><span class=nx>userEditComponent</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>props</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>style</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>width</span><span class=o>:</span> <span class=s1>&#39;40vw&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>modal</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>data</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>id</span><span class=o>:</span> <span class=nx>id</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>});</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Notice in the <code>dialog.open</code> function call, we are including the <code>userEditComponent</code> that we are loading asynchronously in the background using the <code>defineAsyncComponent</code> function in Vue. This allows us to load the main <code>UsersList</code> component fully first, and then in the background it will load the <code>UserEdit</code> component as needed. We are also passing along the <code>id</code> of the user to be edited as part of the <code>data</code> that is sent to the component.</p><p>Finally, in the template, we just replace the click handlers for the <strong>New</strong> and <strong>Edit</strong> buttons to call this new <code>editDialog</code> function:</p><div class=tab-panel data-tab-group=fc31d16d7e41566c383984101e3429e7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersuserslistvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fc31d16d7e41566c383984101e3429e7","srccomponentsusersuserslistvue")'>
<span class=tab-nav-text>src/components/users/UsersList.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersuserslistvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>DataTable</span>
</span></span><span class=line><span class=cl>    <span class=nt>:value</span><span class=o>=</span><span class=s>&#34;users&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>v</span><span class=nt>-model:filters</span><span class=o>=</span><span class=s>&#34;filters&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nt>:globalFilterFields</span><span class=o>=</span><span class=s>&#34;[&#39;username&#39;]&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>filterDisplay</span><span class=o>=</span><span class=s>&#34;menu&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>sortField</span><span class=o>=</span><span class=s>&#34;username&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nt>:sortOrder</span><span class=o>=</span><span class=s>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>header</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;flex justify-between&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>Button</span>
</span></span><span class=line><span class=cl>          <span class=na>label</span><span class=o>=</span><span class=s>&#34;New User&#34;</span>
</span></span><span class=line><span class=cl>          <span class=na>icon</span><span class=o>=</span><span class=s>&#34;pi pi-user-plus&#34;</span>
</span></span><span class=line><span class=cl>          <span class=na>severity</span><span class=o>=</span><span class=s>&#34;success&#34;</span>
</span></span><span class="line hl"><span class=cl>          <span class=nt>@click</span><span class=s>=&#34;editDialog()&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c>&lt;!--</span> <span class=nx>other</span> <span class=nx>code</span> <span class=nx>omitted</span> <span class=nx>here</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>other</span> <span class=nx>code</span> <span class=nx>omitted</span> <span class=nx>here</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>Column</span> <span class=na>header</span><span class=o>=</span><span class=s>&#34;Actions&#34;</span> <span class=na>style</span><span class=o>=</span><span class=s>&#34;min-width: 8rem&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>template</span> <span class=err>#</span><span class=na>body</span><span class=o>=</span><span class=s>&#34;slotProps&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;flex gap-2&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>Button</span>
</span></span><span class=line><span class=cl>            <span class=na>icon</span><span class=o>=</span><span class=s>&#34;pi pi-pencil&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>outlined</span>
</span></span><span class=line><span class=cl>            <span class=na>rounded</span>
</span></span><span class="line hl"><span class=cl>            <span class=nt>@click</span><span class=s>=&#34;editDialog(slotProps.data.id)&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>v</span><span class=nt>-tooltip</span><span class=na>.bottom</span><span class=err>=&#34;&#39;</span><span class=na>Edit</span><span class=err>&#39;&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>Button</span>
</span></span><span class=line><span class=cl>            <span class=na>icon</span><span class=o>=</span><span class=s>&#34;pi pi-trash&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>outlined</span>
</span></span><span class=line><span class=cl>            <span class=na>rounded</span>
</span></span><span class=line><span class=cl>            <span class=na>severity</span><span class=o>=</span><span class=s>&#34;danger&#34;</span>
</span></span><span class=line><span class=cl>            <span class=nt>@click</span><span class=s>=&#34;confirmDelete(slotProps.data.id)&#34;</span>
</span></span><span class=line><span class=cl>            <span class=na>v</span><span class=nt>-tooltip</span><span class=na>.bottom</span><span class=err>=&#34;&#39;</span><span class=na>Delete</span><span class=err>&#39;&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>Column</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>DataTable</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Now, when we click those buttons, it will open the <code>EditUser</code> component in a modal popup dialog instead of directing users to a new route. Of course, on some pages, we may need to check that the user has specific roles before allowing the user to actually load the popup, just like we have to check for those roles before the user navigates to those routes. Since we are now bypassing the Vue Router, any logic in the router may need to be recreated here.</p><h2 id=updating-useredit-component>Updating UserEdit Component</h2><p>Finally, we must make a few minor tweaks to the <code>UserEdit</code> component so that it can run seamlessly in both a stand-alone view as well as part of a popup dialog. The major change comes in the way the incoming data is received, and what should happen when the user is successfully saved.</p><p>The PrimeVue DynamicDialog service uses Vue&rsquo;s <a href=https://vuejs.org/guide/components/provide-inject rel=external target=_blank>Provide / Inject</a> interface to send data to the component loaded in a dialog. So, in our component, we must declare a few additional state variables, as well as small piece of code to detect whether it is running in a dialog or as a standalone component in a view.</p><div class=tab-panel data-tab-group=7cc17042f4f2de47f0cd985bcc4907cd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7cc17042f4f2de47f0cd985bcc4907cd","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>ref</span><span class=p>,</span> <span class=nx>computed</span><span class=p>,</span> <span class=nx>inject</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;vue&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Declare State
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>errors</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>([])</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>isDialog</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl><span class=kr>const</span> <span class=nx>userId</span> <span class=o>=</span> <span class=nx>ref</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Detect Dialog
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>dialogRef</span> <span class=o>=</span> <span class=nx>inject</span><span class=p>(</span><span class=s1>&#39;dialogRef&#39;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>dialogRef</span> <span class=o>&amp;&amp;</span> <span class=nx>dialogRef</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=c1>// running in a dialog
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>  <span class=nx>isDialog</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>userId</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>dialogRef</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=c1>// running in a view
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>  <span class=nx>userId</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>props</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>For this component, we have created a new <code>isDialog</code> reactive state variable that will be set to <code>true</code> if the component detects it has been loaded in a dynamic dialog. It does this by checking for the status of the <code>dialogRef</code> injected state variable. We are also now storing the ID of the user to be edited in a new <code>userId</code> reactive state variable instead of relying on the <code>props.id</code> variable, which will not be present when the component is loaded in a dialog.</p><p>So, we simply need to replace all references to <code>props.id</code> to use <code>userId</code> instead. We can also change the action that occurs when the user is successfully saved - if the component is running in a dialog, it should simply close the dialog instead of using the router to navigate back to the previous page.</p><div class=tab-panel data-tab-group=797e442f45af85ffb5528e83ca3b869e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("797e442f45af85ffb5528e83ca3b869e","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>setup</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Find Single User
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=nx>computed</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>return</span> <span class=nx>users</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>id</span> <span class=o>==</span> <span class=nx>userId</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span> <span class=o>||</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nx>roles</span><span class=o>:</span> <span class=p>[]</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Save User
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>save</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>errors</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=nx>userStore</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>.</span><span class=nx>saveUser</span><span class=p>(</span><span class=nx>userId</span><span class=p>.</span><span class=nx>value</span><span class=p>,</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>201</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>toast</span><span class=p>.</span><span class=nx>add</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>severity</span><span class=o>:</span> <span class=s1>&#39;success&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>summary</span><span class=o>:</span> <span class=s1>&#39;Success&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>detail</span><span class=o>:</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>life</span><span class=o>:</span> <span class=mi>5000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>leave</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>status</span> <span class=o>===</span> <span class=mi>422</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>toast</span><span class=p>.</span><span class=nx>add</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>severity</span><span class=o>:</span> <span class=s1>&#39;warn&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>summary</span><span class=o>:</span> <span class=s1>&#39;Warning&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>detail</span><span class=o>:</span> <span class=nx>error</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>error</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>life</span><span class=o>:</span> <span class=mi>5000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=nx>errors</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>error</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>errors</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>toast</span><span class=p>.</span><span class=nx>add</span><span class=p>({</span> <span class=nx>severity</span><span class=o>:</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=nx>summary</span><span class=o>:</span> <span class=s1>&#39;Error&#39;</span><span class=p>,</span> <span class=nx>detail</span><span class=o>:</span> <span class=nx>error</span><span class=p>,</span> <span class=nx>life</span><span class=o>:</span> <span class=mi>5000</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Leave Component
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>leave</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isDialog</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>dialogRef</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>close</span><span class=p>()</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span> <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;users&#39;</span> <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Finally, we can make a minor update to the template to also use the <code>userId</code> value instead of <code>props.id</code></p><div class=tab-panel data-tab-group=e660564ea50d0a8aad0060df6a12cc93><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e660564ea50d0a8aad0060df6a12cc93","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;flex flex-col gap-3 max-w-xl justify-items-center&#34;</span><span class=p>&gt;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>h1</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;text-xl text-center m-1&#34;</span><span class=p>&gt;{{</span> <span class=nx>userId</span> <span class=o>?</span> <span class=s1>&#39;Edit User&#39;</span> <span class=o>:</span> <span class=s1>&#39;New User&#39;</span> <span class=p>}}&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>&lt;!--</span> <span class=nx>other</span> <span class=nx>code</span> <span class=nx>omitted</span> <span class=nx>here</span> <span class=o>--&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>    <span class=p>&lt;</span><span class=nt>Button</span> <span class=na>severity</span><span class=o>=</span><span class=s>&#34;secondary&#34;</span> <span class=nt>@click</span><span class=s>=&#34;leave&#34;</span> <span class=na>label</span><span class=o>=</span><span class=s>&#34;Cancel&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>That&rsquo;s all it takes! Now, when we click the <strong>New User</strong> or <strong>Edit User</strong> buttons on our <code>UsersList</code> component, we&rsquo;ll see a pop-up dialog that contains our <code>UserEdit</code> component instead of being taken to an entirely new page.</p><p><a href=#R-image-d2a1e5ed05a97bdee68b7c4ff9ce7e33 class=lightbox-link><img alt=DynamicDialog class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/07/dynamicdialog.gif style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d2a1e5ed05a97bdee68b7c4ff9ce7e33><img alt=DynamicDialog class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/07/dynamicdialog.gif></a></p><h2 id=a-bug-reactive-state-across-components>A Bug! Reactive State Across Components</h2><p>A very keen eye may notice a bug in the implementation of this component already - what if the user changes a value but then clicks the <strong>Cancel</strong> button on the modal dialog? Let&rsquo;s see what that looks like:</p><p><a href=#R-image-58022527ba0d69a22f5752877bafe52f class=lightbox-link><img alt=DynamicDialogBug class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/07/dynamicdialogbug.gif style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-58022527ba0d69a22f5752877bafe52f><img alt=DynamicDialogBug class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/07/dynamicdialogbug.gif></a></p><p>As we can see, the edits made in the <code>UserEdit</code> dialog are immediately reflected in the contents of the <code>UsersList</code> component as well. This is because they are both using the same Pinia store and referencing the same list of users in both components. So, this can present all sorts of strange issues in our program.</p><p>There are at least a couple of different ways we can go about fixing this:</p><ol><li>When the dialog closes, we can call <code>userStore.hydrate()</code> from the <code>UsersList</code> component to ensure that it has the latest version of the data from the server. However, if we do this, we could end up calling it twice when a user is saved, since the <code>User</code> store already does this.</li><li>In our <code>EditUser</code> component, we can make sure we are editing a deep copy of our user, and not the same user reference as the one in our Pinia store.</li></ol><p>Let&rsquo;s implement the second solution. Thankfully, it is as simple as using <code>JSON.parse</code> and <code>JSON.stringify</code> to create a quick deep copy of the user we are editing. We can do this in our computed Vue state variable in that component:</p><div class=tab-panel data-tab-group=ebd54ff3ea3f859665a09c36e2da4f01><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=srccomponentsusersusereditvue class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ebd54ff3ea3f859665a09c36e2da4f01","srccomponentsusersusereditvue")'>
<span class=tab-nav-text>src/components/users/UserEdit.vue</span></button></div><div class=tab-content-container><div data-tab-item=srccomponentsusersusereditvue class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-vue data-lang=vue><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Find Single User
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=nx>computed</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>return</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>users</span><span class=p>.</span><span class=nx>value</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>id</span> <span class=o>==</span> <span class=nx>userId</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span> <span class=o>||</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nx>roles</span><span class=o>:</span> <span class=p>[]</span> <span class=p>}),</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>// -=-=- other code omitted here -=-=-</span></span></span></code></pre></div></div></div></div></div><p>With that change in place, we no longer see the bug in our output:</p><p><a href=#R-image-7c78e313a7d59384f327d9c032e5d7c6 class=lightbox-link><img alt="DynamicDialog Fixed" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/07/dynamicdialogfixed.gif style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7c78e313a7d59384f327d9c032e5d7c6><img alt="DynamicDialog Fixed" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/07/dynamicdialogfixed.gif></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=preparing-for-deployment>Preparing for Deployment</h1><a href="https://www.youtube.com/watch?v=b1WeopVfwfU">YouTube Video</a><h2 id=preparing-for-deployment>Preparing for Deployment</h2><p>At this point, we have a pretty well developed application, so let&rsquo;s start preparing for deployment. Our end goal is to build a single Docker container that contains our application, as well as the ability to deploy it along with a production database like <a href=https://www.postgresql.org/ rel=external target=_blank>Postgres</a>.</p><p>To begin, we need to create a finalized version of our Vue frontend that can be embedded into our backend application directly.</p><h2 id=building-in-vue>Building in Vue</h2><p>To create a deployment build of our Vue application, we can simply run the following command in the <code>client</code> folder of our application:</p><div class=tab-panel data-tab-group=f5779dc01931d73addb06ff34c87afe3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f5779dc01931d73addb06ff34c87afe3","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run build</span></span></code></pre></div></div></div></div></div><p>When we run that command, we get lots of output about the different parts of our application that are put together to make the final version. We may also get some warnings about chunks being larger than the cutoff, which we won&rsquo;t worry about for now.</p><p>The final version of our application can be found in a new <code>dist</code> folder inside of our <code>client</code> folder, with a long list of contents:</p><p><a href=#R-image-b32f672641511d1b19a101356cb8b476 class=lightbox-link><img alt="Dist Folder Contents" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/07/build_dist.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b32f672641511d1b19a101356cb8b476><img alt="Dist Folder Contents" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/07/build_dist.png></a></p><p>The <code>assets</code> folder contains a large number of items that are all compiled and assembled by the Vite build tool for our application. The key file, however, is the <code>index.html</code> file, which is placed there to serve as the starting point for our application.</p><h2 id=testing-the-built-application>Testing the Built Application</h2><p>To fully test this application, we can simply copy the entire contents of the <code>client/dist</code> folder into the <code>server/public</code> folder, overwriting the existing <code>index.html</code> file in that location.</p><p><a href=#R-image-b470f2b5c45ac874b10c38962ed6d45a class=lightbox-link><img alt="Public Folder Contents" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/07/deploy_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b470f2b5c45ac874b10c38962ed6d45a><img alt="Public Folder Contents" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/07/deploy_1.png></a></p><p>In addition, if we&rsquo;ve changed any of the settings in the <code>.env</code> file to refer to the client in development mode, such as the <code>CAS_SERVICE_URL</code> or <code>OPENAPI_HOST</code>, we&rsquo;ll need to change those back to using our server port.</p><p>Now, all we have to do is run the server in development mode, but we don&rsquo;t need to start the client at all:</p><div class=tab-panel data-tab-group=0a28b668d3a1b4bf0338749615d0a040><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0a28b668d3a1b4bf0338749615d0a040","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>When the application loads, we can open our web browser on port 3000 (or whichever port our application is configured to use), and we should be greeted with a working version of our application!</p><p><a href=#R-image-5acea80f5a85ed77f4ef93442fc08ded class=lightbox-link><img alt="Working App" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/07/deploy_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5acea80f5a85ed77f4ef93442fc08ded><img alt="Working App" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/07/deploy_2.png></a></p><p>However, we quickly notice that our placeholder image is no longer appearing in our top menu bar. A quick peek at the console in our browser gives us more information:</p><p><a href=#R-image-c78b27ba41282f1b1af56c9fe0d138ff class=lightbox-link><img alt="Broken Image" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/07/deploy_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c78b27ba41282f1b1af56c9fe0d138ff><img alt="Broken Image" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/07/deploy_3.png></a></p><p>A bit of online searching can reveal this error - the <a href=https://helmetjs.github.io/ rel=external target=_blank>helmet</a> middleware we are using will prevent images from loading unless they are hosted on our own domain or if they are retrieved from memory using a <code>data:</code> URL. Since we want to allow our placeholder image to load, we can simply update the settings for <code>helmet</code> to allow this in our <code>server/app.js</code> file:</p><div class=tab-panel data-tab-group=a67bae7b9d01ce8cb6ba647c6b4a0e4e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a67bae7b9d01ce8cb6ba647c6b4a0e4e","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Use libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>helmet</span><span class=p>({</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>contentSecurityPolicy</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>useDefaults</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>directives</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=s2>&#34;img-src&#34;</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;&#39;self&#39;&#34;</span><span class=p>,</span> <span class=s2>&#34;https:&#34;</span><span class=p>],</span>
</span></span><span class="line hl"><span class=cl>      <span class=s2>&#34;connect-src&#34;</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;&#39;self&#39;&#34;</span><span class=p>,</span> <span class=s2>&#34;blob:&#34;</span><span class=p>],</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>compression</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span></span></span></code></pre></div></div></div></div></div><p>With that change in place, our placeholder image will now load since it is using an <code>https</code> URL. It will also allow us to properly upload files using the <code>blob:</code> URLs.</p><p>Another issue we&rsquo;ll quickly run into is that anytime we refresh our application on any page other than the homepage, we&rsquo;ll end up with a 404 error message! This is because the server does not know to properly redirect those requests back to the Vue application&rsquo;s router. We can get around that by installing one more middleware, the <a href=https://www.npmjs.com/package/connect-history-api-fallback rel=external target=_blank>connect-history-api-fallback
</a>middleware in our server&rsquo;s <code>app.js</code> file. We&rsquo;ll also need to disable the <code>indexRouter</code> since it is no longer needed, and move the static files and this new middleware to after the authentication routes to allow our application to properly redirect to CAS.</p><div class=tab-panel data-tab-group=8393ef4c0316d9a3fea47cd6fa0d8781><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8393ef4c0316d9a3fea47cd6fa0d8781","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install connect-history-api-fallback</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=1cb6e9aab8695c02d9203cac4645e1f3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1cb6e9aab8695c02d9203cac4645e1f3","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>compression</span> <span class=nx>from</span> <span class=s2>&#34;compression&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s2>&#34;cookie-parser&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>helmet</span> <span class=nx>from</span> <span class=s2>&#34;helmet&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s2>&#34;path&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>swaggerUi</span> <span class=nx>from</span> <span class=s2>&#34;swagger-ui-express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>fs</span> <span class=nx>from</span> <span class=s2>&#34;node:fs/promises&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>history</span> <span class=nx>from</span> <span class=s2>&#34;connect-history-api-fallback&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Use middlewares
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use routers
</span></span></span><span class=line><span class=cl><span class=c1>//app.use(&#34;/&#34;, indexRouter);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/api&#34;</span><span class=p>,</span> <span class=nx>apiRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use sessions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>sessions</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s2>&#34;session&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use auth routes
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=nx>authRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Redirect other requests to Vue application
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>history</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use static files
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s2>&#34;public&#34;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we refresh our application on any route that is not recognized by the server, it will direct those requests to the Vue application.</p><h2 id=updating-gitignore-files>Updating GitIgnore Files</h2><p>Finally, we should double-check our <code>.gitignore</code> files on both the <code>server</code> and the <code>client</code> to ensure that the built version of our project is not committed to git. In the <code>client/.gitignore</code> file, we already see an entry for <code>dist</code>, so we know that the <code>dist</code> folder and all of its contents will not be committed to git already.</p><p>In the <code>server/.gitignore</code> file, we should add a line to ignore the <code>public</code> folder to the bottom of the file. Then, we can use <code>git rm -r --cached public</code> from within the <code>server</code> folder to remove it from our git index before committing.</p><p>At this point, we can do one last lint, format, commit, and push before we set up our application for deployment!</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Ignoring Files in ESLint</div><div class=box-content><p>We may run into issues with ESLint trying to clean up our production version of our code if it is stored in the <code>public</code> folder of our <code>server</code> directory. We can ignore it by adding a few lines to the <code>server/eslint.config.js</code> file:</p><div class=tab-panel data-tab-group=73a358e30b8aa43f048310cbbc4e4749><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=eslintconfigjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("73a358e30b8aa43f048310cbbc4e4749","eslintconfigjs")'>
<span class=tab-nav-text>eslint.config.js</span></button></div><div class=tab-content-container><div data-tab-item=eslintconfigjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>globals</span> <span class=nx>from</span> <span class=s2>&#34;globals&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>pluginJs</span> <span class=nx>from</span> <span class=s2>&#34;@eslint/js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** @type {import(&#39;eslint&#39;).Linter.Config[]} */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>languageOptions</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>globals</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span><span class=nx>globals</span><span class=p>.</span><span class=nx>node</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span><span class=nx>globals</span><span class=p>.</span><span class=nx>mocha</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>rules</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;no-unused-vars&#34;</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;error&#34;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>argsIgnorePattern</span><span class=o>:</span> <span class=s2>&#34;next&#34;</span> <span class=p>}],</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;no-console&#34;</span><span class=o>:</span> <span class=s2>&#34;error&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>ignores</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;public/*&#34;</span><span class=p>],</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>pluginJs</span><span class=p>.</span><span class=nx>configs</span><span class=p>.</span><span class=nx>recommended</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>];</span></span></span></code></pre></div></div></div></div></div><p>This will tell ESLint to ignore all files in the <code>public</code> directory.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=dockerfile>Dockerfile</h1><a href="https://www.youtube.com/watch?v=iX5whyRpZJ0">YouTube Video</a><h2 id=dockerfile>Dockerfile</h2><p>We are now ready to create a <code>Dockerfile</code> that will build our application into a single Docker container that can be easily deployed in a variety of different infrastructures. Because our application is really two parts (the <strong>server</strong> and the <strong>client</strong>), we can use a <a href=https://docs.docker.com/get-started/docker-concepts/building-images/multi-stage-builds/ rel=external target=_blank>Multi-Stage Build</a> in Docker to make a very streamlined version of our image.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Docker Init</div><div class=box-content><p>In this tutorial, we&rsquo;ll go through building this <code>Dockerfile</code> manually. On systems that have Docker Desktop already installed, we can run <code>docker init</code> to scaffold some of this process. See the documentation for <a href=https://docs.docker.com/reference/cli/docker/init/ rel=external target=_blank>Docker Init</a> for more details on how to use that tool.</p></div></div><h2 id=building-the-client>Building the Client</h2><p>We&rsquo;ll start by creating a new <code>Dockerfile</code> outside of both the <code>client</code> and <code>server</code> folders, so it is at the top level of our project. At the top of the file, we&rsquo;ll add a simple <code>ARG</code> entry to denote the version of Node.js we want to use:</p><div class=tab-panel data-tab-group=8b393716395d31030c0980030b079972><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=dockerfile class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8b393716395d31030c0980030b079972","dockerfile")'>
<span class=tab-nav-text>Dockerfile</span></button></div><div class=tab-content-container><div data-tab-item=dockerfile class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-docker data-lang=docker><span class=line><span class=cl><span class=c># Node Version</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>NODE_VERSION</span><span class=o>=</span><span class=m>22</span></span></span></code></pre></div></div></div></div></div><p>Next, we need to chose the Docker image we want to use to build our client. There are many different options to choose from, but we can look at the <a href=https://hub.docker.com/_/node/ rel=external target=_blank>Official Docker Node</a> package list to find the correct one fo our project. In this case, we&rsquo;ll use the image <code>22-alpine</code> as the basis for our Docker image. When building Docker images for deployment, we often look for images based on the Alpine Linux distribution, which is very lightweight and generally more secure since it only contains the bare minimum set of features needed for our application. We can read more about using Alpine Docker images in the <a href=https://www.docker.com/blog/how-to-use-the-alpine-docker-official-image/ rel=external target=_blank>Docker Blog</a></p><p>So, we&rsquo;ll add a <code>FROM</code> entry to define the source of our build process, and we&rsquo;ll name this container <code>client</code> to help us keep track of it.</p><div class=tab-panel data-tab-group=17f895b5b9db3a942d48740b75731fef><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=dockerfile class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("17f895b5b9db3a942d48740b75731fef","dockerfile")'>
<span class=tab-nav-text>Dockerfile</span></button></div><div class=tab-content-container><div data-tab-item=dockerfile class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-docker data-lang=docker><span class=line><span class=cl><span class=c># Node Version</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>NODE_VERSION</span><span class=o>=</span><span class=m>22</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Client Base Image</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># See https://hub.docker.com/_/node/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> node:${NODE_VERSION}-alpine as client</span></span></span></code></pre></div></div></div></div></div><p>Now, we need to actually build our application. This usually involves 2 steps:</p><ol><li>Copy our code to the container image</li><li>Run the build process to build our application</li></ol><p>However, we can further optimize this by realizing that we can further separate this by installing all of our Node libraries first, then building our application. Since each step creates a new <a href=https://docs.docker.com/get-started/docker-concepts/building-images/understanding-image-layers/ rel=external target=_blank>Docker Image Layer</a>, we can make our images more efficient by spreading these steps out.</p><p>By doing so, if we make a change to the source code of our application, but we don&rsquo;t change the underlying Node libraries, we can reuse that earlier image layer containing our libraries since we know that it hasn&rsquo;t changed at all. We can read more about this in the <a href=https://docs.docker.com/build/cache/optimize/ rel=external target=_blank>Docker Documentation</a> on optimizing builds by using caching.</p><p>In practice, the steps will look like this:</p><div class=tab-panel data-tab-group=d4dd5c1fdf49e244c201d78591a1194f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=dockerfile class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d4dd5c1fdf49e244c201d78591a1194f","dockerfile")'>
<span class=tab-nav-text>Dockerfile</span></button></div><div class=tab-content-container><div data-tab-item=dockerfile class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-docker data-lang=docker><span class=line><span class=cl><span class=c># Node Version</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>NODE_VERSION</span><span class=o>=</span><span class=m>22</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>###############################</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># STAGE 1 - BUILD CLIENT      #</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>###############################</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Client Base Image</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># See https://hub.docker.com/_/node/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> node:${NODE_VERSION}-alpine as client</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Use production node environment by default</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> NODE_ENV production<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Store files in /usr/src/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /usr/src/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Download dependencies as a separate step to take advantage of Docker&#39;s caching.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Leverage a cache mount to /root/.npm to speed up subsequent builds.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Leverage a bind mounts to package.json and package-lock.json to avoid having to copy them into</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># into this layer.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># See https://docs.docker.com/build/cache/optimize/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>bind,source<span class=o>=</span>client/package.json,target<span class=o>=</span>package.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>bind,source<span class=o>=</span>client/package-lock.json,target<span class=o>=</span>package-lock.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>cache,target<span class=o>=</span>/root/.npm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    npm ci --include<span class=o>=</span>dev<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Copy the rest of the source files into the image.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./client .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Build the client application</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> npm run build</span></span></code></pre></div></div></div></div></div><p>At the end of this process, we&rsquo;ll have a Docker image named <code>client</code> that contains a completely compiled version of our application in the <code>/usr/src/app/dist</code> folder. That&rsquo;s really the important outcome of this process.</p><h2 id=building-the-server>Building the Server</h2><p>On the server side of things, there are several files and folders we want to make sure are not included in our final Docker image. So, we can create a file <code>server/.dockerignore</code> with the following contents:</p><div class=tab-panel data-tab-group=567de803d81d2c2187f81d0d51ee9a75><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=dockerignore class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("567de803d81d2c2187f81d0d51ee9a75","dockerignore")'>
<span class=tab-nav-text>.dockerignore</span></button></div><div class=tab-content-container><div data-tab-item=dockerignore class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code class=language-dockerignore data-lang=dockerignore>node_modules
coverage
.env
.env.example
.env.test
.prettierrc
database.sqlite
eslint.config.js
public</code></pre></div></div></div></div></div><p>These are all folders and files that contain information we don&rsquo;t want to include for a variety of security reasons.</p><p>Now, we can initiate the second stage of this build process, which will create a finalized version of our server to run our application. We&rsquo;ll continue building this in the same <code>Dockerfile</code> below the first stage. The first few steps are mostly identical to the client, except this time we are referencing content in the <code>server</code> folder.</p><div class=tab-panel data-tab-group=2b2babd0fcf2a1df7edf9a57c6f243fb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=dockerfile class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2b2babd0fcf2a1df7edf9a57c6f243fb","dockerfile")'>
<span class=tab-nav-text>Dockerfile</span></button></div><div class=tab-content-container><div data-tab-item=dockerfile class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-docker data-lang=docker><span class=line><span class=cl><span class=c>#  -=-=- other code omitted here -=-=-</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>###############################</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># STAGE 2 - BUILD SERVER      #</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>###############################</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Server Base Image</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># See https://hub.docker.com/_/node/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> node:${NODE_VERSION}-alpine as server</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Use production node environment by default</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> NODE_ENV production<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Store files in /usr/src/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /usr/src/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Download dependencies as a separate step to take advantage of Docker&#39;s caching.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Leverage a cache mount to /root/.npm to speed up subsequent builds.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Leverage a bind mounts to package.json and package-lock.json to avoid having to copy them into</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># into this layer.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># See https://docs.docker.com/build/cache/optimize/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>bind,source<span class=o>=</span>server/package.json,target<span class=o>=</span>package.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>bind,source<span class=o>=</span>server/package-lock.json,target<span class=o>=</span>package-lock.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>cache,target<span class=o>=</span>/root/.npm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    npm ci --omit<span class=o>=</span>dev<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Copy the rest of the source files into the image</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./server .</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Node Dev Dependencies</div><div class=box-content><p>Notice that the <code>client</code> build step uses <code>npm ci --include=dev</code> to include the development dependencies for the Vue.js project. These dependencies include tools such as Vite that are actually required to build the project for production, so we have to make sure they are installed.</p><p>In the <code>server</code> build step, however, we are using <code>npm ci --omit=dev</code> to omit any development dependencies from being installed in the container. These dependencies should be tools such as Nodemon and ESLint, which we won&rsquo;t need in the deployed version of our application.</p><p>If we run into errors at either of these steps, we may need to ensure that each Node dependency is properly included in the correct place of the respective <code>package.json</code> file for each project.</p></div></div><p>Once we have installed the libraries and copied the contents of the <code>server</code> folder into the <code>server</code> image, we can also copy the <code>/usr/src/app/dist</code> folder from the <code>client</code> image into the <code>public</code> folder of the <code>server</code> image.</p><div class=tab-panel data-tab-group=e6e210e69afe999e4d9912eccfbdd808><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=dockerfile class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e6e210e69afe999e4d9912eccfbdd808","dockerfile")'>
<span class=tab-nav-text>Dockerfile</span></button></div><div class=tab-content-container><div data-tab-item=dockerfile class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-docker data-lang=docker><span class=line><span class=cl><span class=c>#  -=-=- other code omitted here -=-=-</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>###############################</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># STAGE 2 - BUILD SERVER      #</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>###############################</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Server Base Image</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># See https://hub.docker.com/_/node/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> node:${NODE_VERSION}-alpine as server</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Use production node environment by default</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> NODE_ENV production<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Store files in /usr/src/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /usr/src/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Download dependencies as a separate step to take advantage of Docker&#39;s caching.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Leverage a cache mount to /root/.npm to speed up subsequent builds.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Leverage a bind mounts to package.json and package-lock.json to avoid having to copy them into</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># into this layer.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># See https://docs.docker.com/build/cache/optimize/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>bind,source<span class=o>=</span>server/package.json,target<span class=o>=</span>package.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>bind,source<span class=o>=</span>server/package-lock.json,target<span class=o>=</span>package-lock.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>cache,target<span class=o>=</span>/root/.npm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    npm ci --omit<span class=o>=</span>dev<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Copy the rest of the source files into the image</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./server .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Copy the built version of the client into the image</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>client /usr/src/app/dist ./public</span></span></code></pre></div></div></div></div></div><p>Then, we&rsquo;ll need to make a couple of directories in our container that we can use as volume mounts when we deploy it. These directories will contain our database and our uploaded files:</p><div class=tab-panel data-tab-group=1900fb23ca2c5008c9d90e3a87bed4cd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=dockerfile class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1900fb23ca2c5008c9d90e3a87bed4cd","dockerfile")'>
<span class=tab-nav-text>Dockerfile</span></button></div><div class=tab-content-container><div data-tab-item=dockerfile class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-docker data-lang=docker><span class=line><span class=cl><span class=c>#  -=-=- other code omitted here -=-=-</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>###############################</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># STAGE 2 - BUILD SERVER      #</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>###############################</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Server Base Image</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># See https://hub.docker.com/_/node/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> node:${NODE_VERSION}-alpine as server</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Use production node environment by default</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> NODE_ENV production<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Store files in /usr/src/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /usr/src/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Download dependencies as a separate step to take advantage of Docker&#39;s caching.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Leverage a cache mount to /root/.npm to speed up subsequent builds.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Leverage a bind mounts to package.json and package-lock.json to avoid having to copy them into</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># into this layer.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># See https://docs.docker.com/build/cache/optimize/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>bind,source<span class=o>=</span>server/package.json,target<span class=o>=</span>package.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>bind,source<span class=o>=</span>server/package-lock.json,target<span class=o>=</span>package-lock.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>cache,target<span class=o>=</span>/root/.npm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    npm ci --omit<span class=o>=</span>dev<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Copy the rest of the source files into the image</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./server .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Copy the built version of the client into the image</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>client /usr/src/app/dist ./public<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Make a directory for the database and make it writable</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> mkdir -p ./data<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> chown -R node:node ./data<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Make a directory for the uploads and make it writable</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> mkdir -p ./public/uploads<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> chown -R node:node ./public/uploads</span></span></code></pre></div></div></div></div></div><p>Finally, we&rsquo;ll end by defining the user the container should use, the default port of our application, a command to check if the application in the container is healthy, and the command to start our application.</p><div class=tab-panel data-tab-group=3096efb3fd5924a72f118971c4cdd083><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=dockerfile class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3096efb3fd5924a72f118971c4cdd083","dockerfile")'>
<span class=tab-nav-text>Dockerfile</span></button></div><div class=tab-content-container><div data-tab-item=dockerfile class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-docker data-lang=docker><span class=line><span class=cl><span class=c>#  -=-=- other code omitted here -=-=-</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>###############################</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># STAGE 2 - BUILD SERVER      #</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>###############################</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Server Base Image</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># See https://hub.docker.com/_/node/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> node:${NODE_VERSION}-alpine as server</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Use production node environment by default</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> NODE_ENV production<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Store files in /usr/src/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /usr/src/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Download dependencies as a separate step to take advantage of Docker&#39;s caching.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Leverage a cache mount to /root/.npm to speed up subsequent builds.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Leverage a bind mounts to package.json and package-lock.json to avoid having to copy them into</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># into this layer.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># See https://docs.docker.com/build/cache/optimize/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>bind,source<span class=o>=</span>server/package.json,target<span class=o>=</span>package.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>bind,source<span class=o>=</span>server/package-lock.json,target<span class=o>=</span>package-lock.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --mount<span class=o>=</span><span class=nv>type</span><span class=o>=</span>cache,target<span class=o>=</span>/root/.npm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    npm ci --omit<span class=o>=</span>dev<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Copy the rest of the source files into the image</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./server .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Copy the built version of the client into the image</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>client /usr/src/app/dist ./public<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Make a directory for the database and make it writable</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> mkdir -p ./data<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> chown -R node:node ./data<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Make a directory for the uploads and make it writable</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> mkdir -p ./public/uploads<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> chown -R node:node ./public/uploads<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Run the application as a non-root user.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> node</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Expose the port that the application listens on.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 3000</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Command to check for a healthy application</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>HEALTHCHECK</span> CMD wget --no-verbose --tries<span class=o>=</span><span class=m>1</span> --spider http://localhost:3000/api <span class=o>||</span> <span class=nb>exit</span> <span class=m>1</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Run the application.</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> npm run start</span></span></code></pre></div></div></div></div></div><p>There we go! That is what it takes to build a deployable version of this application. Notice that the <code>Dockerfile</code> we created here is very different from the devcontainer image we are using to develop our application in. A common misconception when using Docker is that we can use the same image for both development and deployment, but generally that is a very insecure and unsafe practice. It is much better to have a fully-featured image available for development, and then use a very secure and minimal image for deployment, often one that is built using a multi-stage build process that takes advantage of layer caching to make it much more efficient.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=github-actions>GitHub Actions</h1><a href="https://www.youtube.com/watch?v=HRYpkcwdyIw">YouTube Video</a><h2 id=github-actions>GitHub Actions</h2><p>The last step in configuring our application for deployment is to create a <a href=https://github.com/features/actions rel=external target=_blank>GitHub Action</a> that will automatically build our Docker container when we commit a release tag to GitHub. This process will ensure that our image is always up to date and available for users to download and use.</p><p>Learning how to build a GitHub Action script could be an entire course unto itself. For this project, we&rsquo;ll run through the basic steps used to test and build our application&rsquo;s Docker image, but there are many more steps that could be added. For example, we could have GitHub automatically run our test scripts before building the image, preventing any broken images if the tests aren&rsquo;t passing. We can also add options to automatically deploy our image to our hosting service whenever it is updated. We can even have it send us a message on our messaging platform of choice when it is done building. Feel free to read up on all of the different actions available in the <a href="https://github.com/marketplace?type=actions" rel=external target=_blank>GitHub Actions Marketplace</a>.</p><h2 id=build-docker-action>Build Docker Action</h2><p>To create this GitHub action, we&rsquo;ll place a file named <code>build_docker.yml</code> in the <code>.github/workflows</code> directory at the very top level of our project.</p><p>We&rsquo;ll start with a name for the workflow, as well as a list of triggers that will start the workflow when a particular action is taken on our GitHub repository:</p><div class=tab-panel data-tab-group=b44e34233a81fd134c30cef5a9d9a08d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=githubworkflowsbuild_dockeryml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b44e34233a81fd134c30cef5a9d9a08d","githubworkflowsbuild_dockeryml")'>
<span class=tab-nav-text>.github/workflows/build_docker.yml</span></button></div><div class=tab-content-container><div data-tab-item=githubworkflowsbuild_dockeryml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># Workflow name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Build Docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Run only on new tags being pushed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># https://docs.github.com/en/actions/using-workflows/triggering-a-workflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>push</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;v*.*.*&#39;</span></span></span></code></pre></div></div></div></div></div><p>Next, we&rsquo;ll define the jobs to be executed as part of this GitHub Action. In this case, we&rsquo;ll only have a single job, <code>build</code>, which will build our Docker image. For that job, we&rsquo;ll use <a href=https://docs.github.com/en/actions/using-github-hosted-runners/using-github-hosted-runners/about-github-hosted-runners rel=external target=_blank>GitHub&rsquo;s Ubuntu Job Runner</a>, but there are many different options available for us.</p><div class=tab-panel data-tab-group=4902eda4e8decf4ede90d649e6e44d8b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=githubworkflowsbuild_dockeryml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4902eda4e8decf4ede90d649e6e44d8b","githubworkflowsbuild_dockeryml")'>
<span class=tab-nav-text>.github/workflows/build_docker.yml</span></button></div><div class=tab-content-container><div data-tab-item=githubworkflowsbuild_dockeryml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># Workflow name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Build Docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Run only on new tags being pushed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># https://docs.github.com/en/actions/using-workflows/triggering-a-workflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>push</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;v*.*.*&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Define a single job named build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Run job on Ubuntu runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span></span></span></code></pre></div></div></div></div></div><p>Following that, we&rsquo;ll list the steps required to complete the job. Each step is documented with a link to the documentation for that step.</p><div class=tab-panel data-tab-group=adcdec62facedcbd40fe3ca662c2b3f8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=githubworkflowsbuild_dockeryml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("adcdec62facedcbd40fe3ca662c2b3f8","githubworkflowsbuild_dockeryml")'>
<span class=tab-nav-text>.github/workflows/build_docker.yml</span></button></div><div class=tab-content-container><div data-tab-item=githubworkflowsbuild_dockeryml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># Workflow name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Build Docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Run only on new tags being pushed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># https://docs.github.com/en/actions/using-workflows/triggering-a-workflow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>push</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;v*.*.*&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Define a single job named build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Run job on Ubuntu runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Job Steps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Step 1 - Checkout the Repository</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># https://github.com/actions/checkout</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w> </span>- <span class=l>Checkout Repository</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Step 2 - Log In to GitHub Container Registry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># https://github.com/docker/login-action</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w> </span>- <span class=l>Login to GitHub Container Registry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>docker/login-action@v3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>registry</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>${{ github.repository_owner }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.GITHUB_TOKEN }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Step 3 - Build and Push Docker Image</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># https://github.com/docker/build-push-action</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w> </span>- <span class=l>Build and Push Docker Image</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>docker/build-push-action@v6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class=l>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>push</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            ghcr.io/${{ github.repository }}:${{ github.ref_name }}
</span></span></span><span class=line><span class=cl><span class=sd>            ghcr.io/${{ github.repository }}:latest</span><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Step 4 - Make Release on GitHub</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># https://github.com/softprops/action-gh-release</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w> </span>- <span class=l>Release</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>softprops/action-gh-release@v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>generate_release_notes</span><span class=p>:</span><span class=w> </span><span class=kc>true</span></span></span></code></pre></div></div></div></div></div><p>As we can see, the basic steps are as follows:</p><ol><li>Checkout the current GitHub repository code</li><li>Connect to the GitHub Container Registry to store the image</li><li>Build and Push the Docker Image to the GitHub Container Registry</li><li>Create a Release on GitHub with the version information</li></ol><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Handling Uppercase Repository Names</div><div class=box-content><p>GitHub is case-preserving, and allows repository names and usernames to include uppercase letters. However, Docker tags must be lowercase, so any repository names with uppercase letters will cause issues with this process.</p><p>To solve this, we can add a new step to convert our repository name to lowercase:</p><div class=tab-panel data-tab-group=240629e7a38b4980c05c5381d3147a95><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=githubworkflowsbuild_dockeryml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("240629e7a38b4980c05c5381d3147a95","githubworkflowsbuild_dockeryml")'>
<span class=tab-nav-text>.github/workflows/build_docker.yml</span></button></div><div class=tab-content-container><div data-tab-item=githubworkflowsbuild_dockeryml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=w>      </span><span class=c># Step 3a - Get Lowercase Repository Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># See https://github.com/orgs/community/discussions/27086</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>3a - Get Lowercase Repository Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          echo &#34;REPO_LOWER=${GITHUB_REPOSITORY,,}&#34; &gt;&gt; ${GITHUB_ENV}</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Step 3b - Build and Push Docker Image</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># https://github.com/docker/build-push-action</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>3b - Build and Push Docker Image</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>docker/build-push-action@v6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class=l>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>push</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            ghcr.io/${{ env.REPO_LOWER }}:${{ github.ref_name }}
</span></span></span><span class=line><span class=cl><span class=sd>            ghcr.io/${{ env.REPO_LOWER }}:latest</span><span class=w>            </span></span></span></code></pre></div></div></div></div></div><p>Alternatively, much of this is also handled by the <a href=https://github.com/docker/metadata-action rel=external target=_blank>Docker Metadata Action</a>, which can be used to automatically configure tags and labels attached to a Docker container built by a GitHub action. For larger-scale projects, adding the Docker Metadata Action to this process is a helpful step.</p></div></div><h2 id=triggering-a-release>Triggering a Release</h2><p>Before we can trigger this workflow, we should commit and push it to GitHub along with our <code>Dockerfile</code> from the previous page.</p><p>Once we have done that, we can create a new <a href=https://semver.org/ rel=external target=_blank>Semantic Versioning</a>, or SemVer, style release tag and push it to GitHub:</p><div class=tab-panel data-tab-group=4f566dd25bf8bb468eaa49d1fc2dd5c8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4f566dd25bf8bb468eaa49d1fc2dd5c8","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ git tag v0.0.1
</span></span><span class=line><span class=cl>$ git push --tags</span></span></code></pre></div></div></div></div></div><p>When we do so, we can go back to our GitHub repository and check for a small yellow circle to appear at the top of our code, which shows that the GitHub Action is executing</p><p><a href=#R-image-307fbe18c1bf289daeef4b7cead6e7b8 class=lightbox-link><img alt="Running Action" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/07/deploy_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-307fbe18c1bf289daeef4b7cead6e7b8><img alt="Running Action" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/07/deploy_4.png></a></p><p>After a minute or so, we can refresh the page to see a green checkmark in its place, as well as additional information on the right side of the page showing the release version and a link to the newly built Docker container stored in the GitHub Container Registry.</p><p><a href=#R-image-112ad75d8a4281e7307590db4dabd02e class=lightbox-link><img alt="Completed Build" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/07/deploy_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-112ad75d8a4281e7307590db4dabd02e><img alt="Completed Build" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/07/deploy_5.png></a></p><p>If we click on that link, we can find information about how to actually pull and use that Docker container in our deployment environment:</p><p><a href=#R-image-9b58e80c80c18734bdf14bbb18d84769 class=lightbox-link><img alt="Final Container" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/07/deploy_6.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9b58e80c80c18734bdf14bbb18d84769><img alt="Final Container" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/07/deploy_6.png></a></p><p>There we go! We now have a working Docker container for our application.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=docker-compose>Docker Compose</h1><a href="https://www.youtube.com/watch?v=SjfFPNsLDn0">YouTube Video</a><h2 id=docker-compose>Docker Compose</h2><p>The last step we can take to make our application easier to deploy is to create a <a href=https://docs.docker.com/compose/ rel=external target=_blank>Docker Compose</a> file that shows how to deploy this application easily within a Docker environment. It is becoming more and more popular for self-hosted projects and web applications to include a sample Docker Compose file to show how the application should be deployed in practice. So, let&rsquo;s look at a quick example for our application.</p><p>We&rsquo;ll place this file at the top-level of our application in a file named <code>compose.yml</code> with the following contents:</p><div class=tab-panel data-tab-group=81c7af831bb5d090749242a37a99be63><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=composeyml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("81c7af831bb5d090749242a37a99be63","composeyml")'>
<span class=tab-nav-text>compose.yml</span></button></div><div class=tab-content-container><div data-tab-item=composeyml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Lost Communities Solution</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Repository:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># https://github.com/cis526-codio/lost-communities-solution</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lostcommunities</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Docker Image</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io/cis526-codio/lost-communities-solution:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Container Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>lostcommunities</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Restart Container Unless Stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Network Ports</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;3000:3000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Volumes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>lostcommunities_data:/usr/src/app/data:rw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>lostcommunities_uploads:/usr/src/app/public/uploads:rw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Environment Variables</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># =+=+=+= REQUIRED VALUES =+=+=+=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># These values must be configured for deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Session Secret Key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>SESSION_SECRET</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;thisisasupersecretkey&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># JWT Secret Key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>JWT_SECRET_KEY</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;thisisasupersecretkey&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Use Node and run `require(&#39;crypto&#39;).randomBytes(64).toString(&#39;hex&#39;)` to get a random value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># CAS Authentication Settings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># CAS Server URL (send users here to login)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>CAS_URL</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;https://testcas.cs.ksu.edu&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># CAS Service URL (CAS returns users here; usually where this app is deployed)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>CAS_SERVICE_URL</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;http://localhost:3000&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Database File Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Options: &#39;:memory:&#39; to use an in-memory database (not recommended), or any file name otherwise</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>DATABASE_FILE</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;data/database.sqlite&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Seed initial data on first startup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>SEED_DATA</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;true&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># =+=+=+= OPTIONAL VALUES =+=+=+=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># These values are set to reasonable defaults</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># but can be overridden. Default values are shown as comments</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Log Level</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Options: error | warn | info | http | verbose | debug | sql | silly</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#LOG_LEVEL: &#39;http&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Network Port</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#PORT: &#39;3000&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># =+=+=+= OTHER VALUES =+=+=+=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># These values are not recommended for deployment but are available</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Custom Session Cookie Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#SESSION_NAME: &#39;connect.sid&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Open API Documentation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Show OpenAPI Documentation at `/docs` path</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#OPENAPI_VISIBLE: &#39;false&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Open API Host for testing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#OPENAPI_HOST: &#39;http://localhost:3000&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Export Open API JSON File</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#OPENAPI_EXPORT: &#39;false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Open API Export File Path</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#OPENAPI_EXPORT_PATH: &#39;openapi.json&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Enable Bypass Authentication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Use path `/auth/bypass?token=&lt;username&gt;` to log in as any user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># DO NOT ENABLE IN PRODUCTION - THIS IS INSECURE!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#BYPASS_AUTH: &#39;false&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lostcommunities_data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>lostcommunities_uploads:</span></span></span></code></pre></div></div></div></div></div><p>Most of this file is pretty straightforward. The one unique bit to point out is the two <code>volume</code> mounts, which connect a Docker volume to both the <code>data</code> and the <code>public/uploads</code> folders of our container. The first folder was created to specifically store our database file, and the second one will store all uploaded files from the users. In our Docker Compose file we are simply storing these in Docker volumes, but an experienced system administrator could change these to link directly to a path on the host system, making it easy to access.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Update the Image Path</div><div class=box-content><p>Remember to update the image path in the Docker Compose file to match the path where your own Docker image can be found on the GitHub Container Registry - you can find it in your repository by clicking the Package name on the right side of the page.</p></div></div><h2 id=using-docker-compose>Using Docker Compose</h2><p>To actually deploy this application, we can simply download a copy of this <code>compose.yml</code> file on any system with Docker installed, and then run the following command to deploy it:</p><div class=tab-panel data-tab-group=f2581dc2b72c0f28c2660a771db23f9a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f2581dc2b72c0f28c2660a771db23f9a","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ docker compose up -d</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Authenticating with GitHub Container Registry</div><div class=box-content><p>Since our Docker image is stored in a private repository on GitHub, we&rsquo;ll need to authenticate with the GitHub Container Registry. Instructions for doing this with a GitHub Personal Access Token can be found in the <a href=https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry#authenticating-with-a-personal-access-token-classic rel=external target=_blank>GitHub Documentation</a>.</p></div></div><p>If everything works correctly, we should see our application start in the terminal:</p><p><a href=#R-image-d66aab4a2140394f0e4395ca0dcca907 class=lightbox-link><img alt="Docker Compose Deploy" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/07/deploy_7.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d66aab4a2140394f0e4395ca0dcca907><img alt="Docker Compose Deploy" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/07/deploy_7.png></a></p><p>We can test it by going to <code>http://localhost:3000</code> on our local system, or whatever URL is attached to the deployed container.</p><p><a href=#R-image-68b2ff2e4cfcbf0eae9d584bbbc1e6b6 class=lightbox-link><img alt="Docker Container Running" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/07/deploy_8.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-68b2ff2e4cfcbf0eae9d584bbbc1e6b6><img alt="Docker Container Running" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/07/deploy_8.png></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=external-database>External Database</h1><a href="https://www.youtube.com/watch?v=z95i3xT8DN4">YouTube Video</a><h2 id=connecting-to-an-external-database>Connecting to an External Database</h2><p>Finally, what if we&rsquo;d like to update our application to connect to an external database? This could be very useful if we plan on using this application in production with a large amount of data, because an external database will be much faster and handle large amounts of data much better than our SQLite database stored in a single file.</p><p>For this example, we&rsquo;ll update our application to be able to use <a href=https://www.postgresql.org/ rel=external target=_blank>Postgres</a>. Most of this process can be discovered by reading the <a href=https://sequelize.org/docs/v6/getting-started/ rel=external target=_blank>Sequelize Documentation</a> to see how to connect other database types to our application.</p><h2 id=update-database-configuration>Update Database Configuration</h2><p>First, we need to update the database configuration for our application, which is in the <code>configs/database.js</code> file in our <code>server</code> folder. We&rsquo;ll add several additional options to allow us to specify the dialect, hostname, username, and password for another database engine.</p><div class=tab-panel data-tab-group=f192399f8034cf1fdda6ff092da1e6b5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsdatabasejs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f192399f8034cf1fdda6ff092da1e6b5","configsdatabasejs")'>
<span class=tab-nav-text>configs/database.js</span></button></div><div class=tab-content-container><div data-tab-item=configsdatabasejs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Sequelize database ORM
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports sequelize a Sequelize instance
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Sequelize</span> <span class=nx>from</span> <span class=s2>&#34;sequelize&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Sequelize instance
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>sequelize</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Sequelize</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Supports &#34;sqlite&#34; or &#34;postgres&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>dialect</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DATABASE_DIALECT</span> <span class=o>||</span> <span class=s2>&#34;sqlite&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Only used by SQLite
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>storage</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DATABASE_FILE</span> <span class=o>||</span> <span class=s2>&#34;:memory:&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Used by Postgres
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>host</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DATABASE_HOST</span> <span class=o>||</span> <span class=s2>&#34;lostcommunities_db&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>port</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DATABASE_PORT</span> <span class=o>||</span> <span class=mi>5432</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>username</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DATABASE_USERNAME</span> <span class=o>||</span> <span class=s2>&#34;lostcommunities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>password</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DATABASE_PASSWORD</span> <span class=o>||</span> <span class=s2>&#34;lostcommunities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>database</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DATABASE_NAME</span> <span class=o>||</span> <span class=s2>&#34;lostcommunities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>logging</span><span class=o>:</span> <span class=nx>logger</span><span class=p>.</span><span class=nx>sql</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=nx>logger</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>sequelize</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll also need to install the appropriate database libraries in our <code>server</code> application:</p><div class=tab-panel data-tab-group=f2dd3c13103803058896a499fc239315><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f2dd3c13103803058896a499fc239315","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install pg pg-hstore</span></span></code></pre></div></div></div></div></div><h2 id=properly-update-ids-after-seeding>Properly Update IDs after Seeding</h2><p>In addition, we also must handle a bug where Postgres will not properly keep track of any IDs that are added during the seeding process, so in each of our seeds we need to update the internal sequence used by Postgres to keep track of the next ID to use:</p><div class=tab-panel data-tab-group=beb8176b56856b9184f4ec6a4234369c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=seeds00_usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("beb8176b56856b9184f4ec6a4234369c","seeds00_usersjs")'>
<span class=tab-nav-text>seeds/00_users.js</span></button></div><div class=tab-content-container><div data-tab-item=seeds00_usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span> <span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=s2>&#34;users&#34;</span><span class=p>,</span> <span class=nx>users</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DATABASE_DIALECT</span> <span class=o>==</span> <span class=s1>&#39;postgres&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>sequelize</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=s2>&#34;SELECT setval(&#39;users_id_seq&#39;, max(id)) FROM users;&#34;</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=b3b20e1eb86c9a12b071196bdb8f4a8f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=seeds01_rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b3b20e1eb86c9a12b071196bdb8f4a8f","seeds01_rolesjs")'>
<span class=tab-nav-text>seeds/01_roles.js</span></button></div><div class=tab-content-container><div data-tab-item=seeds01_rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span> <span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=s2>&#34;roles&#34;</span><span class=p>,</span> <span class=nx>roles</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DATABASE_DIALECT</span> <span class=o>==</span> <span class=s1>&#39;postgres&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>sequelize</span><span class=p>.</span><span class=nx>query</span><span class=p>(</span><span class=s2>&#34;SELECT setval(&#39;roles_id_seq&#39;, max(id)) FROM roles;&#34;</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=s2>&#34;user_roles&#34;</span><span class=p>,</span> <span class=nx>user_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>This error is discussed at length in a <a href=https://github.com/sequelize/sequelize/issues/9295 rel=external target=_blank>Sequelize GitHub Issue</a>.</p><h2 id=environment-variables>Environment Variables</h2><p>We should also add these new environment variable entries to our <code>.env.example</code> file, including relocating the existing <code>DATABASE_FILE</code> entry to this section with the others. Since we aren&rsquo;t using them in development or testing, we can leave them out of the other files for now.</p><div class=tab-panel data-tab-group=dac1cff24c49c1d25cc1b7375b6902f1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=envexample class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("dac1cff24c49c1d25cc1b7375b6902f1","envexample")'>
<span class=tab-nav-text>.env.example</span></button></div><div class=tab-content-container><div data-tab-item=envexample class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=c1># Database Settings</span>
</span></span><span class=line><span class=cl><span class=c1># Options are &#34;sqlite&#34; or &#34;postgres&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_DIALECT</span><span class=o>=</span>sqlite
</span></span><span class=line><span class=cl><span class=c1># File is specified for SQLite</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>database.sqlite
</span></span><span class=line><span class=cl><span class=c1># Other settings are for Postgres</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_HOST</span><span class=o>=</span>localhost
</span></span><span class=line><span class=cl><span class=nv>DATABASE_PORT</span><span class=o>=</span><span class=m>5432</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_USERNAME</span><span class=o>=</span>lostcommunities
</span></span><span class=line><span class=cl><span class=nv>DATABASE_PASSWORD</span><span class=o>=</span>lostcommunities
</span></span><span class=line><span class=cl><span class=nv>DATABASE_NAME</span><span class=o>=</span>lostcommunities</span></span></code></pre></div></div></div></div></div><h2 id=update-docker-compose>Update Docker Compose</h2><p>To test this, we&rsquo;ll need a running Postgres instance. While we can create one in our GitHub Codespaces by adding some additional configuration files, it is a bit more complex. So, let&rsquo;s just update our <code>compose.yml</code> file for deployment and test using another database there.</p><div class=tab-panel data-tab-group=8ee62b78b1952b29660625bbf3e36f19><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=composeyml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8ee62b78b1952b29660625bbf3e36f19","composeyml")'>
<span class=tab-nav-text>compose.yml</span></button></div><div class=tab-content-container><div data-tab-item=composeyml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Lost Communities Solution</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Repository:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># https://github.com/cis526-codio/lost-communities-solution</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lostcommunities</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Docker Image</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io/cis526-codio/lost-communities-solution:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Container Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>lostcommunities</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Restart Container Unless Stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Networks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>lostcommunities_network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Network Ports</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;3000:3000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Volumes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>lostcommunities_data:/usr/src/app/data:rw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>lostcommunities_uploads:/usr/src/app/public/uploads:rw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Environment Variables</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># =+=+=+= REQUIRED VALUES =+=+=+=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># These values must be configured for deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Session Secret Key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>SESSION_SECRET</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;thisisasupersecretkey&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># JWT Secret Key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>JWT_SECRET_KEY</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;thisisasupersecretkey&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Use Node and run `require(&#39;crypto&#39;).randomBytes(64).toString(&#39;hex&#39;)` to get a random value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># CAS Authentication Settings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># CAS Server URL (send users here to login)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>CAS_URL</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;https://testcas.cs.ksu.edu&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># CAS Service URL (CAS returns users here; usually where this app is deployed)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>CAS_SERVICE_URL</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;http://localhost:3000&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Database Options</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Database Dialect</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Options: &#39;sqlite&#39; (default) or &#39;postgres&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>DATABASE_DIALECT</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;postgres&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># For SQLite Only - Specify file location</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Options: &#39;:memory:&#39; to use an in-memory database (not recommended), or any file name otherwise</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># DATABASE_FILE: &#39;data/database.sqlite&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># For Postgres Only - Specify database information</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>DATABASE_HOST</span><span class=p>:</span><span class=w> </span><span class=l>lostcommunities_db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>DATABASE_PORT</span><span class=p>:</span><span class=w> </span><span class=m>5432</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>DATABASE_USERNAME</span><span class=p>:</span><span class=w> </span><span class=l>lostcommunities</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>DATABASE_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=l>lostcommunities</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>DATABASE_NAME</span><span class=p>:</span><span class=w> </span><span class=l>lostcommunities</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Seed initial data on first startup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>SEED_DATA</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;true&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># =+=+=+= OPTIONAL VALUES =+=+=+=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># These values are set to reasonable defaults</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># but can be overridden. Default values are shown as comments</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Log Level</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Options: error | warn | info | http | verbose | debug | sql | silly</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#LOG_LEVEL: &#39;http&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Network Port Within the Container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#PORT: &#39;3000&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># =+=+=+= OTHER VALUES =+=+=+=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># These values are not recommended for deployment but are available</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Custom Session Cookie Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#SESSION_NAME: &#39;connect.sid&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Open API Documentation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Show OpenAPI Documentation at `/docs` path</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#OPENAPI_VISIBLE: &#39;false&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Open API Host for testing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#OPENAPI_HOST: &#39;http://localhost:3000&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Export Open API JSON File</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#OPENAPI_EXPORT: &#39;false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Open API Export File Path</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#OPENAPI_EXPORT_PATH: &#39;openapi.json&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Enable Bypass Authentication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Use path `/auth/bypass?token=&lt;username&gt;` to log in as any user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># DO NOT ENABLE IN PRODUCTION - THIS IS INSECURE!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#BYPASS_AUTH: &#39;false&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>######################################</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Postgres Database</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Image Location:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># https://hub.docker.com/_/postgres</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lostcommunities_db</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Docker Image</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>postgres:17-alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Container Name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>lostcommunities_db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Restart Container Unless Stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Networks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>lostcommunities_network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Volumes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>lostcommunities_db_data:/var/lib/postgresql/data:rw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Environment Variables</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_USER</span><span class=p>:</span><span class=w> </span><span class=l>lostcommunities</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=l>lostcommunities</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_DB</span><span class=p>:</span><span class=w> </span><span class=l>lostcommunities</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lostcommunities_data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lostcommunities_uploads</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lostcommunities_db_data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lostcommunities_network</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>internal</span><span class=p>:</span><span class=w> </span><span class=kc>true</span></span></span></code></pre></div></div></div></div></div><p>This Docker Compose file follows some best practices for deploying a Postgres container in the cloud, and even separates the database connection between our application container and the Postgres container in an internal Docker network to make it even more secure.</p><p>Once we deploy this application, we can even check that the Postgres server has our current data to ensure it is working properly:</p><p><a href=#R-image-f923e122c47800aabb36bf2cb3b7d850 class=lightbox-link><img alt="Postgres Running" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/07/deploy_9.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f923e122c47800aabb36bf2cb3b7d850><img alt="Postgres Running" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/07/deploy_9.png></a></p><p>Now our application is ready for a full deployment!</p><footer class=footline></footer></article></section></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/88dc52af7821b9338bcedf83c0737bdfbc9b262e>Apr 28, 2025</a></p></div></div><script src=/cis526/js/clipboard.min.js?1747410760 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1747410760 defer></script><script src=/cis526/js/theme.js?1747410760 defer></script></body></html>
<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="Example projects you can follow along with!"><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Example Projects :: CIS 526 Textbook"><meta name=twitter:description content="Example projects you can follow along with!"><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/x-examples/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Example Projects :: CIS 526 Textbook"><meta property="og:description" content="Example projects you can follow along with!"><meta property="og:locale" content="en-us"><meta property="og:type" content="website"><meta itemprop=name content="Example Projects :: CIS 526 Textbook"><meta itemprop=description content="Example projects you can follow along with!"><meta itemprop=dateModified content="2025-03-03T12:52:30-06:00"><meta itemprop=wordCount content="7"><title>Example Projects :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/x-examples/ rel=canonical type=text/html title="Example Projects :: CIS 526 Textbook"><link href=/cis526/x-examples/index.xml rel=alternate type=application/rss+xml title="Example Projects :: CIS 526 Textbook"><link href=/cis526/x-examples/tele.html rel=alternate type=text/html title="Example Projects :: CIS 526 Textbook"><link href=/cis526/x-examples/embed.html rel=alternate type=text/html title="Example Projects :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1742510271 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1742510271 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1742510271 rel=stylesheet><link href=/cis526/css/auto-complete.css?1742510271 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1742510271 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1742510271 rel=stylesheet><link href=/cis526/css/fonts.css?1742510271 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1742510271 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1742510271 rel=stylesheet><link href=/cis526/css/theme-auto.css?1742510271 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1742510271 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1742510271 rel=stylesheet><link href=/cis526/css/print.css?1742510271 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1742510271 rel=stylesheet><script src=/cis526/js/variant.js?1742510271></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="..",window.relearn.relBaseUri="../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1742510271 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/x-examples/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Example Projects</span><meta itemprop=position content="1"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/c-js/11-ajax/ title="AJAX (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/x-examples/01-express-starter/ title="Express Starter Project (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable chapter narrow" tabindex=-1><div class=flex-block-wrapper><article class=chapter><header class=headline></header><div class=article-subheading>Chapter X</div><h1 id=example-projects>Example Projects</h1><p>Example projects you can follow along with!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Example Projects</h1><article class=default><header class=headline></header><h1 id=express-starter-project>Express Starter Project</h1><a href="https://www.youtube.com/watch?v=4NUyZMgtHEw">YouTube Video</a><p>This example project is the first in a series toward building a complete full-stack web application using <a href=https://nodejs.org/en rel=external target=_blank>Node.js</a> and <a href=https://expressjs.com/ rel=external target=_blank>Express</a> to create a RESTful API on the backend that connects to a database, and then a <a href=https://vuejs.org/ rel=external target=_blank>Vue</a> single page application on the frontend.</p><p>In doing so, we&rsquo;ll explore some of the standard ways web developers use existing tools, frameworks, and libraries to perform many of the operations we&rsquo;ve learned how to do manually throughout this course. In essence, you&rsquo;ve already learned how to build these things <em>from scratch</em>, but now we&rsquo;ll look at how professionals use <em>dependencies</em> to accomplish many of the same things.</p><p>We&rsquo;ll also explore techniques for writing good, clean JavaScript code that includes documentation and API information, unit testing, and more.</p><p>Finally, we&rsquo;ll learn how to do all of this using <a href=https://github.com/features/codespaces rel=external target=_blank>GitHub Codespaces</a>, so everything runs directly in the web browser with no additional software or hardware needed. Of course, you can also do everything locally using <a href=https://www.docker.com/products/docker-desktop/ rel=external target=_blank>Docker Desktop</a> and <a href=https://code.visualstudio.com/ rel=external target=_blank>Visual Studio Code</a> as well.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li>A working GitHub Codespace containing Node.js</li><li>A bare-bones Express application</li><li>Update Express application from CommonJS to ES Modules</li><li>Application logs with Winston and Morgan</li><li>Install other useful Express libraries</li><li>A better development server using Nodemon</li><li>A tool for managing environment variables</li><li>Code documentation with JSDoc and OpenAPI comments</li><li>Linting and Formatting with ESLint and Prettier</li></ol><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Express Starter Project</h1><article class=default><header class=headline></header><h1 id=github-codespace>GitHub Codespace</h1><a href="https://www.youtube.com/watch?v=nO3-TJlFW8U">YouTube Video</a><h2 id=creating-a-codespace>Creating a Codespace</h2><p>To begin, we will start with an empty GitHub repository. You can either create one yourself, or you may be working from a repository provided through GitHub Classroom.</p><p>At the top of the page, you may see either a <strong>Create a Codespace</strong> button in an empty repository, or a <strong>Code</strong> button that opens a panel with a <strong>Codespaces</strong> tab and a <strong>Create Codespace on main</strong> button in an initialized repository. Go ahead and click that button.</p><p><a href=#R-image-30c5f7125d5d881f60879c9e35bc7399 class=lightbox-link><img alt="Codespace in Empty Repository" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/codespace_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-30c5f7125d5d881f60879c9e35bc7399><img alt="Codespace in Empty Repository" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/codespace_1.png></a></p><p><a href=#R-image-57e2605bdc0754f69c62b52232aa7266 class=lightbox-link><img alt="Codespace in Initialized Repository" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/codespace_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-57e2605bdc0754f69c62b52232aa7266><img alt="Codespace in Initialized Repository" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/codespace_2.png></a></p><p>Once you do, GitHub will start creating a new <a href=https://github.com/features/codespaces rel=external target=_blank>GitHub Codespace</a> for your project. This process may take a few moments.</p><p>Once it is done, you&rsquo;ll be presented with a window that looks very similar to Visual Studio Code&rsquo;s main interface. In fact - it is! It is just a version of Visual Studio Code running directly in a web browser. Pretty neat!</p><p>For the rest of this project, we&rsquo;ll do all of our work here in GitHub Codespaces directly in our web browser.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Working Locally?</div><div class=box-content><p>If you would rather do this work on your own computer, you&rsquo;ll need to install the following prerequisites:</p><ul><li><a href=https://code.visualstudio.com/ rel=external target=_blank>Visual Studio Code</a></li><li><a href=https://www.docker.com/products/docker-desktop/ rel=external target=_blank>Docker Desktop</a></li><li><a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers" rel=external target=_blank>Dev Containers Extension</a></li></ul><p>For now, you&rsquo;ll start by cloning your GitHub repository to your local computer, and opening it in Visual Studio Code. We&rsquo;ll create some configuration files, and then reopen the project using a Dev Container in Docker. When looking in the Command Palette, just swap the &ldquo;Codespaces&rdquo; prefix with the &ldquo;Dev Containers&rdquo; prefix in the command names.</p></div></div><p>Once you&rsquo;ve created your GitHub Codespace, you can always find it again by visiting the repository in your web browser, clicking the <strong>Code</strong> button and choosing the <strong>Codespaces</strong> tab.</p><p><a href=#R-image-f89d4597aad7faa9acfbe5b2dab05233 class=lightbox-link><img alt="Existing Codespace" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/codespace_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f89d4597aad7faa9acfbe5b2dab05233><img alt="Existing Codespace" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/codespace_3.png></a></p><h2 id=configuring-the-codespace>Configuring the Codespace</h2><p>When we first create a GitHub Codespace, GitHub will use a <a href=https://docs.github.com/en/codespaces/setting-up-your-project-for-codespaces/adding-a-dev-container-configuration/introduction-to-dev-containers#using-the-default-dev-container-configuration rel=external target=_blank>default dev container</a> configuration. It includes many tools that are preinstalled for working on a wide variety of projects. Inside of the Codespace, you can run the following command in the terminal to get a URL that contains a list of all tools installed and their versions:</p><div class=tab-panel data-tab-group=6829599b77c7db2190198210002538aa><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6829599b77c7db2190198210002538aa","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ devcontainer-info content-url</span></span></code></pre></div></div></div></div></div><p>The current default configuration as of this writing can be found <a href=https://github.com/devcontainers/images/blob/main/src/universal/history/2.12.6.md rel=external target=_blank>here</a>.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Documenting Terminal Commands</div><div class=box-content><p>In these example projects, we&rsquo;ll prefix any terminal commands with a dollar sign <code>$</code> symbol, representing the standard Linux terminal command prompt. You <strong>should not</strong> enter this character into the terminal, just the content after it. This makes it easy to see individual commands in the documentation, and also makes it easy to tell the difference between commands to be executed and the output produced by that command.</p><p>You can learn more in the <a href=https://developers.google.com/style/code-syntax rel=external target=_blank>Google Developer Documentation Style Guide</a>.</p></div></div><p>For this project, we are going to configure our own <a href=https://containers.dev/ rel=external target=_blank>dev container</a> that just contains the tools we need for this project. This also allows us to use the same configuration both in GitHub Codespaces as well as locally on our own systems using Docker.</p><p>To configure our own dev container, we first must open the <a href=https://code.visualstudio.com/docs/getstarted/userinterface#_command-palette rel=external target=_blank>Visual Studio Code Command Palette</a>. We can do this by pressing <kbd>CTRL</kbd>+<kbd>SHIFT</kbd>+<kbd>P</kbd>, or by clicking the top search bar on the page and choosing <strong>Show and Run Commands ></strong>.</p><p>In the Command Palette, search for and choose the <strong>Codespaces: Add Dev Container Configuration Files&mldr;</strong> option, then choose <strong>Create a new configuration&mldr;</strong>. In the list that appears, search for &ldquo;node&rdquo; to find the container titled &ldquo;Node.js & TypeScript&rdquo; and choose that option.</p><p><a href=#R-image-6db391eec1cf70f02c98c1426d021cd4 class=lightbox-link><img alt="Choosing a Dev Container Configuration" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/codespace_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6db391eec1cf70f02c98c1426d021cd4><img alt="Choosing a Dev Container Configuration" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/codespace_4.png></a></p><p>You&rsquo;ll then be prompted to choose a version to use. We&rsquo;ll use <code>22-bookworm</code> for this project. That refers to <a href=https://nodejs.org/en/blog/release/v22.11.0 rel=external target=_blank>Node version 22 LTS</a> running on a <a href=https://www.debian.org/releases/bookworm/ rel=external target=_blank>Debian Bookworm LTS</a> Linux image. Both of these are current, long term supported (LTS) versions of the software, making them an excellent choice for a new project.</p><p>Finally, the last question will ask if we&rsquo;d like to add any additional features to our dev container configuration. We&rsquo;ll leave this blank for now, but in the future you may find some of these additional features useful and choose to add them here.</p><p>Once that is done, a <code>.devcontainer</code> folder will be created, with a <code>devcontainer.json</code> file inside of it. The content of that file should match what is shown below:</p><div class=tab-panel data-tab-group=14128c90d46934a697a615002fc6b0ef><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=devcontainerdevcontainerjson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("14128c90d46934a697a615002fc6b0ef","devcontainerdevcontainerjson")'>
<span class=tab-nav-text>.devcontainer/devcontainer.json</span></button></div><div class=tab-content-container><div data-tab-item=devcontainerdevcontainerjson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// For format details, see https://aka.ms/devcontainer.json. For config options, see the
</span></span></span><span class=line><span class=cl><span class=c1>// README at: https://github.com/devcontainers/templates/tree/main/src/typescript-node
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;name&#34;</span><span class=o>:</span> <span class=s2>&#34;Node.js &amp; TypeScript&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Or use a Dockerfile or Docker Compose file. More info: https://containers.dev/guide/dockerfile
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=s2>&#34;image&#34;</span><span class=o>:</span> <span class=s2>&#34;mcr.microsoft.com/devcontainers/typescript-node:1-22-bookworm&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Features to add to the dev container. More info: https://containers.dev/features.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// &#34;features&#34;: {},
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Use &#39;forwardPorts&#39; to make a list of ports inside the container available locally.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// &#34;forwardPorts&#34;: [],
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Use &#39;postCreateCommand&#39; to run commands after the container is created.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// &#34;postCreateCommand&#34;: &#34;yarn install&#34;,
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Configure tool-specific properties.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// &#34;customizations&#34;: {},
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Uncomment to connect as root instead. More info: https://aka.ms/dev-containers-non-root.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// &#34;remoteUser&#34;: &#34;root&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Over time, we&rsquo;ll come back to this file to add additional features to our dev container. For now, we&rsquo;ll just leave it as-is.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Dependabot</div><div class=box-content><p>You may also see a second file, <code>.github/dependabot.yml</code> that is also created. This file is used by the <a href=https://docs.github.com/en/code-security/getting-started/dependabot-quickstart-guide rel=external target=_blank>GitHub Dependabot</a> to keep your dev container configuration up to date. You may get occasional notices from GitHub in the future if there are any updates to software included in your dev container configuration.</p></div></div><p>At this point, we are ready to rebuilt our GitHub Codespace to use our new dev container configuration. To do this, open the Command Palette once again and look for the <strong>Codespaces: Rebuild Container</strong> option. Click that option, then select the <strong>Full Rebuild</strong> option in the popup window since we have completely changed our dev container configuration.</p><p>Now, we can sit back and be patient while GitHub Codespaces rebuilds our environment using the new configuration. This may take several minutes.</p><p>Once it is complete, we can confirm that Node.js is installed and running the correct version by running the following command and checking the output matches our expected version of Node.js:</p><div class=tab-panel data-tab-group=eb2e4591b62f4df90a89c2082a9090f0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("eb2e4591b62f4df90a89c2082a9090f0","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node --version
</span></span><span class=line><span class=cl>v22.12.0</span></span></code></pre></div></div></div></div></div><p>If that works, then our dev container environment in GitHub Codespaces should be set up and ready to go!</p><p>Now is a good time to commit our current work to git and push it to GitHub. Even though we are working in a GitHub Codespace, we still have to <strong>commit and push</strong> our work to get it saved. You can do this using the Source Control sidebar tab on the page, or using the classic terminal commands as shown below.</p><div class=tab-panel data-tab-group=c3ad0d049c539ac1eed773cc11adf63c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c3ad0d049c539ac1eed773cc11adf63c","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ git add .
</span></span><span class=line><span class=cl>$ git commit -m <span class=s2>&#34;Dev Container&#34;</span>
</span></span><span class=line><span class=cl>$ git push -u origin main</span></span></code></pre></div></div></div></div></div><p>For the rest of this exercise, we&rsquo;ll assume that you are comfortable with git and GitHub and can take care of committing and pushing your work yourself, but we&rsquo;ll give you several hints showing when we hit a good opportunity to save your work.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=express-starter>Express Starter</h1><a href="https://www.youtube.com/watch?v=Wh4jmh9A7V4">YouTube Video</a><h2 id=generating-an-express-application>Generating an Express Application</h2><p>Now that we have our dev container configured, we can start setting up an Express application. The recommended method in the documentation is to use the <a href=https://expressjs.com/en/starter/generator.html rel=external target=_blank>Express application generator</a>, so we&rsquo;ll use that method. You may want to refer to the documentation for this command to see what options are available.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Express Documentation</div><div class=box-content><p>You may also want to bookmark the <a href=https://expressjs.com/ rel=external target=_blank>Express Documentation</a> website as well, since it contains lots of helpful information about how Express works that may not be covered in this tutorial.</p></div></div><p>For this project, we&rsquo;ll use the following command to build our application:</p><div class=tab-panel data-tab-group=c84f5571139f50aa352c4fe6f921bebf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c84f5571139f50aa352c4fe6f921bebf","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npx express-generator --no-view --git server</span></span></code></pre></div></div></div></div></div><p>Let&rsquo;s break down that command to see what it is doing:</p><ul><li><code>npx</code> - The <a href=https://docs.npmjs.com/cli/v7/commands/npx rel=external target=_blank>npx</a> command is included with Node.js and <code>npm</code> and allows us to run a command from an <code>npm</code> package, including packages that <em>aren&rsquo;t currently installed!</em>. This is the preferred way to run commands that are available in any <code>npm</code> packages.</li><li><code>express-generator</code> - This is the <a href=https://www.npmjs.com/package/express-generator rel=external target=_blank>express-generator</a> package in <code>npm</code> that contains the command we are using to build our Express application.</li><li><code>--no-view</code> - This option will generate a project without a built-in view engine.</li><li><code>--git</code> - This option will add a <code>.gitignore</code> file to our project</li><li><code>server</code> - This is the name of the directory where we would like to create our application.</li></ul><p>When we run that command, we may be prompted to install the <code>express-generator</code> package, so we can press <code>y</code> to install it.</p><p>That command will produce a large amount of output, similar to what is shown below:</p><div class=tab-panel data-tab-group=9325a3b63d2854ea89b691e240baf35d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9325a3b63d2854ea89b691e240baf35d","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>Need to install the following packages:
express-generator@4.16.1
Ok to proceed? (y) y

npm warn deprecated mkdirp@0.5.1: Legacy versions of mkdirp are no longer supported. Please update to mkdirp 1.x. (Note that the API surface has changed to use Promises in 1.x.)

   create : server/
   create : server/public/
   create : server/public/javascripts/
   create : server/public/images/
   create : server/public/stylesheets/
   create : server/public/stylesheets/style.css
   create : server/routes/
   create : server/routes/index.js
   create : server/routes/users.js
   create : server/public/index.html
   create : server/.gitignore
   create : server/app.js
   create : server/package.json
   create : server/bin/
   create : server/bin/www

   change directory:
     $ cd server

   install dependencies:
     $ npm install

   run the app:
     $ DEBUG=server:* npm start</code></pre></div></div></div></div></div><p>As we can see, it created quite a few files for us! Let&rsquo;s briefly review what each of these files and folders are for:</p><ul><li><code>public</code> - this folder contains the static HTML, CSS, and JavaScript files that will be served from our application. Much later down the road, we&rsquo;ll place the compiled version of our Vue frontend application in this folder. For now, it just serves as a placeholder for where those files will be placed.</li><li><code>routes</code> - this folder contains the Express application routers for our application. There are currently only two routers, the <code>index.js</code> router connected to the <code>/</code> path, and the <code>users.js</code> router connected to the <code>/users</code> path.</li><li><code>.gitignore</code> - this file tells git which files or folders can be ignored when committing to the repository. We&rsquo;ll discuss this file in detail below.</li><li><code>app.js</code> - this is the main file for our Express application. It loads all of the libraries, configurations, and routers and puts them all together into a single Express application.</li><li><code>package.json</code> - this file contains information about the project, including some metadata, scripts, and the list of external dependencies. More information on the structure and content of that file can be found in the <a href=https://docs.npmjs.com/cli/v11/configuring-npm/package-json rel=external target=_blank>documentation</a>.</li><li><code>bin/www</code> - this file is the actual entrypoint for our web application. It loads the Express application defined in <code>app.js</code>, and then creates an <code>http</code> server to listen for incoming connections and sends them to the Express application. It also handles figuring out which port the application should listen on, as well as some common errors.</li></ul><p>Since we are only building a RESTful API application, there are a few files that we can delete or quickly modify:</p><ul><li>Delete everything in the <code>public</code> folder <strong>except</strong> the file <code>index.html</code></li><li>Inside of the <code>public/index.html</code> file, remove the line referencing the stylesheet: <code>&lt;link rel="stylesheet" href="/stylesheets/style.css"></code> since it has been deleted.</li></ul><p>At this point, we should also update the contents of the <code>package.json</code> file to describe our project. It currently contains information similar to this:</p><div class=tab-panel data-tab-group=71ab167186e46965fcd655a25066ca78><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("71ab167186e46965fcd655a25066ca78","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;node ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cookie-parser&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.4.4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;debug&#34;</span><span class=p>:</span> <span class=s2>&#34;~2.6.9&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;express&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.16.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;morgan&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.9.1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>For now, let&rsquo;s update the <code>name</code> and <code>version</code> entries to match our project:</p><div class=tab-panel data-tab-group=569c0e17bf9757e75bcf0ca98d05342c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("569c0e17bf9757e75bcf0ca98d05342c","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;node ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cookie-parser&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.4.4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;debug&#34;</span><span class=p>:</span> <span class=s2>&#34;~2.6.9&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;express&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.16.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;morgan&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.9.1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>In a stand-alone application like ours, these values really don&rsquo;t matter, but if we do decide to publish this application as an <code>npm</code> module in the future, these values will be used to build the module itself.</p><h2 id=exploring-appjs>Exploring App.js</h2><p>Let&rsquo;s quickly take a look at the contents of the <code>app.js</code> file to get an idea of what this application does:</p><div class=tab-panel data-tab-group=da2249907d6eff8ea90c413bcc46be2f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("da2249907d6eff8ea90c413bcc46be2f","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kd>var</span> <span class=nx>express</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;express&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>path</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;path&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>cookieParser</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;cookie-parser&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>logger</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;morgan&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>indexRouter</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;./routes/index&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>usersRouter</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;./routes/users&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>logger</span><span class=p>(</span><span class=s1>&#39;dev&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=nx>__dirname</span><span class=p>,</span> <span class=s1>&#39;public&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/users&#39;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>app</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>At the top, the file loads several libraries, including <a href=https://www.npmjs.com/package/cookie-parser rel=external target=_blank>cookie-parser</a> for parsing cookies sent from the browser, and <a href=https://www.npmjs.com/package/morgan rel=external target=_blank>morgan</a> for logging requests. It then also loads the two routers, <code>index</code> and <code>users</code>.</p><p>Next, we see the line <code>var app = express()</code> - this line actually creates the Express application and stores a reference to it in the <code>app</code> variable.</p><p>The next few lines add various middlewares to the Express application using the <code>app.use()</code> function. Each of these is effectively a function that is called each time the application receives a request, one after the other, until a response is generated and sent. See <a href=https://expressjs.com/en/guide/using-middleware.html rel=external target=_blank>Using middleware</a> in the Express documentation for more details.</p><p>The last line of that group uses the <code>express.static</code> middleware to serve static files from the <code>public</code> directory (it uses the <code>path</code> library and the <code>__dirname</code> global variable to construct the correct absolute path to those files). So, if the user requests any path that matches a static file, that file will be sent to the user. This will happen even if a static file matches an existing route, since this middleware is added to the application before the routes. So, there are some instances where we may want to connect this middleware to the application <em>after</em> adding some important routes - we&rsquo;ll discuss that in the future as we continue to build this application.</p><p>After that, the two routers are added as well. Each router is given a base path - the <code>index</code> router is given the <code>/</code> path, then the <code>users</code> router is given the <code>/users</code> path. These are the URL paths that are used to determine where each incoming request should be sent in the application. See <a href=https://expressjs.com/en/guide/routing.html rel=external target=_blank>routing</a> in the Express documentation for more details.</p><p>Finally, the Express application referenced in <code>app</code> is exported from this file. It is used by the <code>bin/www</code> file and attached to an <code>http</code> server to listen for incoming requests.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Order Matters</div><div class=box-content><p>Because Express is a routing and middleware framework, the order in which you add middlewares and routers determines how the application functions. So, we must be very thoughtful about the order in which we add middlewares and routers to our application. In this example, notice, that we add the logger first, then parse any incoming JSON requests, then decode any URL encoded requests, then parse any cookies, before doing anything else.</p><p>This is a common error that trips up many first-time Express developers, so be mindful as you add and adjust content in this file!</p></div></div><h2 id=installing-dependencies>Installing Dependencies</h2><p>Now that we&rsquo;ve generated a basic Express web application, we need to install all of the dependencies. This is also the first step we&rsquo;ll need to do anytime we clone this project for the first time or if we rebuild our GitHub codespace or dev container.</p><p>To do this, we need to go to the terminal and change directory to the <code>server</code> folder:</p><div class=tab-panel data-tab-group=7c717d3746736435100589801504ffe8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7c717d3746736435100589801504ffe8","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>cd</span> server</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Working Directory</div><div class=box-content><p>Remember that we can always see the current working directory by looking at the command prompt in the terminal, or by typing the <code>pwd</code> command:</p><p><a href=#R-image-d59db4ecc5448e51aa51f72e7ac6576d class=lightbox-link><img alt="Working Directory in Terminal" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/express_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d59db4ecc5448e51aa51f72e7ac6576d><img alt="Working Directory in Terminal" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/express_1.png></a></p><p><a href=#R-image-5323368d239bd9ffaaa90b8fb5b68106 class=lightbox-link><img alt="Present Working Directory" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/express_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5323368d239bd9ffaaa90b8fb5b68106><img alt="Present Working Directory" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/express_2.png></a></p></div></div><p>Once inside of the <code>server</code> folder, we can install all our dependencies using the following command:</p><div class=tab-panel data-tab-group=6bcb6e498a20efad88f9e721de69154f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6bcb6e498a20efad88f9e721de69154f","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install</span></span></code></pre></div></div></div></div></div><p>When we run that command, we&rsquo;ll see output similar to the following:</p><div class=tab-panel data-tab-group=4bc9cd87b82f9d9de3d055f772187821><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4bc9cd87b82f9d9de3d055f772187821","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>added 53 packages, and audited 54 packages in 4s

7 vulnerabilities (3 low, 4 high)

To address all issues, run:
  npm audit fix --force

Run `npm audit` for details.</code></pre></div></div></div></div></div><p>It looks like we have some out of date packages and vulnerabilities to fix!</p><h2 id=updating-dependencies>Updating Dependencies</h2><p>Thankfully, there is a very useful command called <a href=https://www.npmjs.com/package/npm-check-updates rel=external target=_blank>npm-check-updates</a> that we can use to update our dependencies anytime there is a problem. We can run that package&rsquo;s command using <code>npx</code> as we saw earlier:</p><div class=tab-panel data-tab-group=a2c24a554f50169728d1efd5b278cc6f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a2c24a554f50169728d1efd5b278cc6f","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npx npm-check-updates</span></span></code></pre></div></div></div></div></div><p>As before, we&rsquo;ll be prompted to install the package if it isn&rsquo;t installed already. Once it is done, we&rsquo;ll see output like this:</p><div class=tab-panel data-tab-group=1dfe0e75618b1dbdf543ee118e978274><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1dfe0e75618b1dbdf543ee118e978274","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>Need to install the following packages:
npm-check-updates@17.1.14
Ok to proceed? (y) y

Checking /workspaces/example-project/server/package.json
[====================] 4/4 100%

 cookie-parser   ~1.4.4  â†’   ~1.4.7
 debug           ~2.6.9  â†’   ~4.4.0
 express        ~4.16.1  â†’  ~4.21.2
 morgan          ~1.9.1  â†’  ~1.10.0

Run npx npm-check-updates -u to upgrade package.json</code></pre></div></div></div></div></div><p>When we run the command, it tells us which packages are out of date and lists a newer version of the package we can install.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Tread Carefully!</div><div class=box-content><p>In an actual production application, it is important to make sure your dependencies are kept up to date. At the same time, you&rsquo;ll want to carefully read the documentation for these dependencies and test your project after any dependency updates, just to ensure that your application works correctly using the new versions.</p><p>For example, in the output above, we see this:</p><div class=highlight><pre tabindex=0><code> debug           ~2.6.9  â†’   ~4.4.0</code></pre></div><p>This means that the <code>debug</code> library is <strong>two major versions</strong> out of date (see <a href=https://semver.org/ rel=external target=_blank>Semantic Versioning</a> for more information on how to interpret version numbers)! If we check the <a href="https://www.npmjs.com/package/debug?activeTab=versions" rel=external target=_blank><code>debug</code> versions list</a> on npm, we can see that version <code>2.6.9</code> was released in September 2017 - a very long time ago.</p><p>When a package undergoes a major version change, it often comes with incompatible API changes. So, we may want to consult the documentation for each major version or find release notes or upgrade guides to refer to. In this case, we can refer to the release notes for each version on GitHub:</p><ul><li>3.0.0: <a href=https://github.com/debug-js/debug/releases/tag/3.0.0 rel=external target=_blank>https://github.com/debug-js/debug/releases/tag/3.0.0</a></li><li>4.0.0: <a href=https://github.com/debug-js/debug/releases/tag/4.0.0 rel=external target=_blank>https://github.com/debug-js/debug/releases/tag/4.0.0</a></li></ul><p>We may even need to check some of the release notes for minor releases as well.</p><p>Thankfully, the latest version of the <code>debug</code> library is compatible with our existing code, and later in this project we&rsquo;ll replace it with a better logging infrastructure anyway.</p></div></div><p>Now that we know which dependencies can be updated, we can use the same command with the <code>-u</code> option to update our <code>package.json</code> file easily:</p><div class=tab-panel data-tab-group=4df6bd9b9f670e1221d12260387198bc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4df6bd9b9f670e1221d12260387198bc","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npx npm-check-updates -u</span></span></code></pre></div></div></div></div></div><p>We should see output similar to this:</p><div class=tab-panel data-tab-group=a14c982cb1b1402d5f9241e92d160039><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a14c982cb1b1402d5f9241e92d160039","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>Upgrading /workspaces/example-project/server/package.json
[====================] 4/4 100%

 cookie-parser   ~1.4.4  â†’   ~1.4.7
 debug           ~2.6.9  â†’   ~4.4.0
 express        ~4.16.1  â†’  ~4.21.2
 morgan          ~1.9.1  â†’  ~1.10.0

Run npm install to install new versions.</code></pre></div></div></div></div></div><p>We can also check our <code>package.json</code> file to see the changes:</p><div class=tab-panel data-tab-group=67571cfed3ff9feea2f4f8cc32a204fb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("67571cfed3ff9feea2f4f8cc32a204fb","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;node ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cookie-parser&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.4.7&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;debug&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.4.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;express&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.21.2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;morgan&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.10.0&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Finally, we can install those dependencies:</p><div class=tab-panel data-tab-group=3761cb7a878f556099d4838fb60301b6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3761cb7a878f556099d4838fb60301b6","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install</span></span></code></pre></div></div></div></div></div><p>Now when we run that command, we should see that everything is up to date!</p><div class=tab-panel data-tab-group=21ded411eee8a0283f36a70f10f1b269><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("21ded411eee8a0283f36a70f10f1b269","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>added 36 packages, changed 24 packages, and audited 90 packages in 4s

14 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities</code></pre></div></div></div></div></div><p>There we go! We now have a sample Express application configured with updated dependencies.</p><h2 id=testing-the-application>Testing the Application</h2><p>At this point, we are ready to actually test our application. To do this, we can run the following command from within the <code>server</code> directory in our project:</p><div class=tab-panel data-tab-group=e907e9069d80cf3cdfb957f5051bb05b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e907e9069d80cf3cdfb957f5051bb05b","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm start</span></span></code></pre></div></div></div></div></div><p>When we do, we&rsquo;ll see a bit of information on the terminal:</p><div class=tab-panel data-tab-group=d91ffb22f679c41026f22722aced14e4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d91ffb22f679c41026f22722aced14e4","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 start
&gt; node ./bin/www</code></pre></div></div></div></div></div><p>We&rsquo;ll also see a small popup in the bottom right corner of the screen, telling us that it has detected that our application is listening on port <code>3000</code>.</p><p><a href=#R-image-8866943a497b3790b3a12fb99a756ce8 class=lightbox-link><img alt="Listening Port Popup" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/express_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8866943a497b3790b3a12fb99a756ce8><img alt="Listening Port Popup" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/express_3.png></a></p><p>So, to access our application, we can click on the <strong>Open in Browser</strong> button on that popup. If everything works correctly, we should be able to see our application running in our web browser:</p><p><a href=#R-image-0a88c190bd4acec663fc479f6fe7af56 class=lightbox-link><img alt="Running Example Application" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/express_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0a88c190bd4acec663fc479f6fe7af56><img alt="Running Example Application" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/express_4.png></a></p><p>Take a look at the long URL in the browser - that URL includes the name of the GitHub Codespace (<code>laughing-computing-machine</code> in this example), followed by a random Codespace ID (<code>jj5j9p97vx435jqj</code>), followed by the port our application is listening on (<code>3000</code>). We&rsquo;ll look at ways we can build this URL inside of our application in the future, but for now it is just worth noting.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Finding Listening Ports</div><div class=box-content><p>If you didn&rsquo;t see the popup appear, or you cannot find where your application is running, check the <strong>PORTS</strong> tab above the console in GitHub Codespaces:</p><p><a href=#R-image-c4106c3a36154ba6a93a7edd043d177b class=lightbox-link><img alt="Listening Port List" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/express_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c4106c3a36154ba6a93a7edd043d177b><img alt="Listening Port List" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/express_5.png></a></p><p>We can click on the URL under the <strong>Forwarded Addresses</strong> heading to access the port in our web browser. We can also use this interface to configure additional ports that we want to be able to access outside of the GitHub Codespace.</p></div></div><p>We can also access any routes that are configured in our application. For example, the default Express application includes a <code>/users</code> route, so we can just add <code>/users</code> to the end of the URL in our web browser to access it. We should see this page when we do:</p><p><a href=#R-image-04b7beafb47c3c6763c112829c9fe9b1 class=lightbox-link><img alt="Running Example Users Path" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/express_6.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-04b7beafb47c3c6763c112829c9fe9b1><img alt="Running Example Users Path" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/express_6.png></a></p><p>Great! It looks like our example application in running correctly.</p><h2 id=committing-to-github>Committing to GitHub</h2><p>Now is a great time to commit and push our project to GitHub. Before we do, however, we should double-check that our project has a proper <code>server/.gitignore</code> file. It should have been created by the Express application generator if we used the <code>--git</code> option, but it is always important to double-check that it is there before trying to commit a new project.</p><p><a href=#R-image-4155834e3ee65d6bbe7c41abc62a2bde class=lightbox-link><img alt="Gitignore File" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/express_7.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4155834e3ee65d6bbe7c41abc62a2bde><img alt="Gitignore File" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/express_7.png></a></p><p>A <a href=https://docs.github.com/en/get-started/getting-started-with-git/ignoring-files rel=external target=_blank>.gitignore</a> file is used to tell git which files should not be committed to a repository. For a project using Node.js, we especially don&rsquo;t want to commit our <code>node_modules</code> folder. This folder contains all of the dependencies for our project, and can often be very large.</p><p>Why don&rsquo;t we want to commit it? Because it contains lots of code that isn&rsquo;t ours, and it is much better to just install the dependencies locally whenever we develop or use our application. That is the whole function of the <code>package.json</code> file and the <code>npm</code> command - it lets us focus on only developing our own code, and it will find and manage all other external dependencies for us.</p><p>So, as a general rule of thumb, we should <strong>NEVER</strong> commit the <code>node_modules</code> folder to our repository.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Missing gitignore file?</div><div class=box-content><p>If your project does not have a <code>.gitignore</code> file, you can usually find one for the language or framework you are using in the excellent <a href=https://github.com/github/gitignore rel=external target=_blank>gitignore GitHub Repository</a>. Just look for the appropriate file and add the contents to a <code>.gitignore</code> file in your project. For example, you can find a <a href=https://github.com/github/gitignore/blob/main/Node.gitignore rel=external target=_blank>Node.gitignore</a> file to use in this project.</p></div></div><p>At long last, we are ready to <strong>commit and push</strong> all of our changes to this project. If it works correctly, it should only commit the code files we&rsquo;ve created, but none of the files that are ignored in the <code>.gitignore</code> file.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=convert-to-es-modules>Convert to ES Modules</h1><a href="https://www.youtube.com/watch?v=6dDn8qBPTgs">YouTube Video</a><h2 id=commonjs-vs-es-modules>CommonJS vs ES Modules</h2><p>By default, the Express application generator creates an application using the <a href=https://nodejs.org/api/modules.html#modules-commonjs-modules rel=external target=_blank>CommonJS module format</a>. This is the original way that JavaScript modules were packaged. However, many libraries and frameworks have been moving to the new <a href=https://nodejs.org/api/esm.html rel=external target=_blank>ECMAScript module format</a> (commonly referred to as ES modules), which is current official standard way of packaging JavaScript modules.</p><p>Since we want to build an industry-grade application, it would be best to update our application to use the new ES module format. This format will become more and more common over time, and many dependencies on npm have already started to shift to only supporting the ES module format. So, let&rsquo;s take the time now to update our application to use that new format before we go any further.</p><h2 id=enabling-es-module-support>Enabling ES Module Support</h2><p>To enable ES module support in our application, we must simply add <code>"type": "module",</code> to the <code>package.json</code> file:</p><div class=tab-panel data-tab-group=3494a6729cf56b7dff496961a0ce7087><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3494a6729cf56b7dff496961a0ce7087","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;module&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;node ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cookie-parser&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.4.7&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;debug&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.4.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;express&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.21.2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;morgan&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.10.0&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Now, let&rsquo;s try to run our application:</p><div class=tab-panel data-tab-group=6e703f7f9a999d42427534d9761357bc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6e703f7f9a999d42427534d9761357bc","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm start</span></span></code></pre></div></div></div></div></div><p>When we do, we&rsquo;ll get some errors:</p><div class=tab-panel data-tab-group=6c9ba9b5999df040681d91a961f0f285><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6c9ba9b5999df040681d91a961f0f285","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 start
&gt; node ./bin/www

file:///workspaces/example-project/server/bin/www:7
var app = require(&#39;../app&#39;);
          ^

ReferenceError: require is not defined in ES module scope, you can use import instead
    at file:///workspaces/example-project/server/bin/www:7:11
    at ModuleJob.run (node:internal/modules/esm/module_job:271:25)
    at async onImport.tracePromise.__proto__ (node:internal/modules/esm/loader:547:26)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:116:5)

Node.js v22.12.0</code></pre></div></div></div></div></div><p>By changing that one line in <code>package.json</code>, the Node.js runtime is trying to load our project using ES modules instead of CommonJS modules, and it causes all sorts of errors. Thankfully, most of them are easy to fix! In most cases, we are simply making two updates:</p><ol><li>Replacing <code>require</code> statements with <code>import</code> statements</li><li>Replacing <code>module.exports</code> statements with <code>export default</code> statements.</li></ol><p>Let&rsquo;s go file by file and make these updates. We&rsquo;ll only show the lines that are commented out and their replacements directly below - you&rsquo;ll need to look carefully at each file, find the commented line, and replace it with the new line.</p><ul><li><code>bin/www</code></li></ul><div class=tab-panel data-tab-group=17d9f8da66a934d5f54833e235645072><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("17d9f8da66a934d5f54833e235645072","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// var app = require(&#39;../app&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s1>&#39;../app.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var debug = require(&#39;debug&#39;)(&#39;server:server&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>debugLibrary</span> <span class=nx>from</span> <span class=s1>&#39;debug&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>debug</span> <span class=o>=</span> <span class=nx>debugLibrary</span><span class=p>(</span><span class=s1>&#39;server:server&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var http = require(&#39;http&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><ul><li><code>app.js</code></li></ul><div class=tab-panel data-tab-group=dded215c5063dfe1c16dda6bac9c7f88><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("dded215c5063dfe1c16dda6bac9c7f88","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// var express = require(&#39;express&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var path = require(&#39;path&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var cookieParser = require(&#39;cookie-parser&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var logger = require(&#39;morgan&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;morgan&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var indexRouter = require(&#39;./routes/index&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/index.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var usersRouter = require(&#39;./routes/users&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/users.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>//module.exports = app;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=k>default</span> <span class=nx>app</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><ul><li><code>routes/index.js</code> and <code>routes/users.js</code></li></ul><div class=tab-panel data-tab-group=5dcfa614b1319c875044d6b442fcf880><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesindexjs-amp-routesusersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5dcfa614b1319c875044d6b442fcf880","routesindexjs-amp-routesusersjs")'>
<span class=tab-nav-text>routes/index.js & routes/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesindexjs-amp-routesusersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// var express = require(&#39;express&#39;);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var router = express.Router();
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// module.exports = router;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>At this point, let&rsquo;s test our application again to see if we&rsquo;ve updated everything correctly:</p><div class=tab-panel data-tab-group=1f4712949ac31355c37ba4b177418271><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1f4712949ac31355c37ba4b177418271","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm start</span></span></code></pre></div></div></div></div></div><p>Now, we should get an error message similar to this:</p><div class=tab-panel data-tab-group=981c7679bfd17f8597a3f8352eaf982f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("981c7679bfd17f8597a3f8352eaf982f","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>file:///workspaces/example-project/server/app.js:25
app.use(express.static(path.join(__dirname, &#39;public&#39;)));
                                 ^

ReferenceError: __dirname is not defined in ES module scope
    at file:///workspaces/example-project/server/app.js:25:34
    at ModuleJob.run (node:internal/modules/esm/module_job:271:25)
    at async onImport.tracePromise.__proto__ (node:internal/modules/esm/loader:547:26)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:116:5)

Node.js v22.12.0</code></pre></div></div></div></div></div><p>This is a bit trickier to debug, but a quick Google search usually leads to the correct answer. In this case, the <code>__dirname</code> variable is a global variable that is defined when Node.js is running a CommonJS module, as discussed in the <a href=https://nodejs.org/docs/latest/api/modules.html#__dirname rel=external target=_blank>documentation</a>. However, when Node.js is running an ES module, many of these global variables have been relocated to the <code>import.meta</code> property, as shown in the <a href=https://nodejs.org/api/esm.html#importmetadirname rel=external target=_blank>documentation</a>. So, we can just replace <code>__dirname</code> with the <code>import.meta.dirname</code> variable in <code>app.js</code>:</p><div class=tab-panel data-tab-group=927356cc30fc192896ec136dac996ca2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("927356cc30fc192896ec136dac996ca2","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>//app.use(express.static(path.join(__dirname, &#39;public&#39;)));
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s1>&#39;public&#39;</span><span class=p>)));</span></span></span></code></pre></div></div></div></div></div><p>Let&rsquo;s try to run our application again - it should be able to start this time:</p><div class=tab-panel data-tab-group=66cdda76f99db730184cf58065c2e29a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("66cdda76f99db730184cf58065c2e29a","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm start</span></span></code></pre></div></div></div></div></div><p>Updating a Node.js application to use ES modules is not terribly difficult, especially if it is done early in development. However, since we&rsquo;ve made this change, we&rsquo;ll have to be careful as we continue to develop our application. Many online tutorials, documentation, and references assume that any Node.js and Express application is still using CommonJS modules, so we may have to translate any code we find to match our new ES module setup.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><h2 id=references>References</h2><ul><li><a href=https://electerious.medium.com/from-commonjs-to-es-modules-how-to-modernize-your-node-js-app-ad8cdd4fb662 rel=external target=_blank>From CommonJS to ES Modules: How to modernize your Node.js app</a></li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=debugging--logging>Debugging & Logging</h1><a href="https://www.youtube.com/watch?v=iykPYL9FQMs">YouTube Video</a><h2 id=debugging-with-the-debug-utility>Debugging with the Debug Utility</h2><p>Now that we have a basic Express application, let&rsquo;s add some helpful tools for developers to make our application easier to work with and debug in the future. These are some great quality of life tweaks that many professional web applications include, but often new developers fail to add them early on in development and waste lots of time adding them later. So, let&rsquo;s take some time now to add these features before we start developing any actual RESTful endpoints.</p><p>First, you may have noticed that the <code>bin/www</code> file includes the <a href=https://www.npmjs.com/package/debug rel=external target=_blank>debug</a> utility. This is a very common debugging module that is included in many Node.sj applications, and is modeled after how Node.js itself handles debugging internally. It is a very powerful module, and one that you should make use of anytime you are creating a Node.js library to be published on npm and shared with others.</p><p>Let&rsquo;s quickly look at how we can use the <code>debug</code> utility in our application. Right now, when we start our application, we see very little output on the terminal:</p><div class=tab-panel data-tab-group=fad38687e900fc20bd81f805260f3a55><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fad38687e900fc20bd81f805260f3a55","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm start</span></span></code></pre></div></div></div></div></div><p>That command produces this output:</p><div class=tab-panel data-tab-group=942c548bb414002feb90a6a1f6c84b13><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("942c548bb414002feb90a6a1f6c84b13","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 start
&gt; node ./bin/www</code></pre></div></div></div></div></div><p>As we access various pages and routes, we may see some additional lines of output appear, like this:</p><div class=tab-panel data-tab-group=50edfccc86195311f991d0b8b4a2106d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("50edfccc86195311f991d0b8b4a2106d","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>GET / 304 2.569 ms - -
GET /users 200 2.417 ms - 23
GET / 200 1.739 ms - 120</code></pre></div></div></div></div></div><p>These lines come from the <a href=https://www.npmjs.com/package/morgan rel=external target=_blank>morgan</a> request logging middleware, which we&rsquo;ll discuss on the next page of this example.</p><p>To enable the <code>debug</code> library, we simply must set an environment variable in the terminal when we run our application, as shown here:</p><div class=tab-panel data-tab-group=6b9d6def6bd41aa8589a0c4a2abcab8b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6b9d6def6bd41aa8589a0c4a2abcab8b","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nv>DEBUG</span><span class=o>=</span>* npm start</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Environment Variables</div><div class=box-content><p>An <a href=https://en.wikipedia.org/wiki/Environment_variable rel=external target=_blank><strong>environment variable</strong></a> is a value that is present in memory in a running instance of an operating system. These generally give running processes information about the system, but may also include data and information provided by the user or system administrator. Environment variables are very common ways to configure applications that run in containers, like our application will when it is finally deployed. We&rsquo;ll cover this in detail later in this course; for now, just understand that we are setting a variable in memory that can be accessed inside of our application.</p></div></div><p>Now, we&rsquo;ll be provided with a lot of debugging output from all throughout our application:</p><div class=tab-panel data-tab-group=e5ea3cbc87e7fee89527ac8a69dcc00f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e5ea3cbc87e7fee89527ac8a69dcc00f","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 start
&gt; node ./bin/www

  express:router:route new &#39;/&#39; +0ms
  express:router:layer new &#39;/&#39; +1ms
  express:router:route get &#39;/&#39; +0ms
  express:router:layer new &#39;/&#39; +1ms
  express:router:route new &#39;/&#39; +0ms
  express:router:layer new &#39;/&#39; +0ms
  express:router:route get &#39;/&#39; +0ms
  express:router:layer new &#39;/&#39; +0ms
  express:application set &#34;x-powered-by&#34; to true +1ms
  express:application set &#34;etag&#34; to &#39;weak&#39; +0ms
  express:application set &#34;etag fn&#34; to [Function: generateETag] +0ms
  express:application set &#34;env&#34; to &#39;development&#39; +0ms
  express:application set &#34;query parser&#34; to &#39;extended&#39; +0ms
  express:application set &#34;query parser fn&#34; to [Function: parseExtendedQueryString] +0ms
  express:application set &#34;subdomain offset&#34; to 2 +0ms
  express:application set &#34;trust proxy&#34; to false +0ms
  express:application set &#34;trust proxy fn&#34; to [Function: trustNone] +1ms
  express:application booting in development mode +0ms
  express:application set &#34;view&#34; to [Function: View] +0ms
  express:application set &#34;views&#34; to &#39;/workspaces/example-project/server/views&#39; +0ms
  express:application set &#34;jsonp callback name&#34; to &#39;callback&#39; +0ms
  express:router use &#39;/&#39; query +1ms
  express:router:layer new &#39;/&#39; +0ms
  express:router use &#39;/&#39; expressInit +0ms
  express:router:layer new &#39;/&#39; +0ms
  express:router use &#39;/&#39; logger +0ms
  express:router:layer new &#39;/&#39; +0ms
  express:router use &#39;/&#39; jsonParser +0ms
  express:router:layer new &#39;/&#39; +0ms
  express:router use &#39;/&#39; urlencodedParser +1ms
  express:router:layer new &#39;/&#39; +0ms
  express:router use &#39;/&#39; cookieParser +0ms
  express:router:layer new &#39;/&#39; +0ms
  express:router use &#39;/&#39; serveStatic +0ms
  express:router:layer new &#39;/&#39; +0ms
  express:router use &#39;/&#39; router +0ms
  express:router:layer new &#39;/&#39; +1ms
  express:router use &#39;/users&#39; router +0ms
  express:router:layer new &#39;/users&#39; +0ms
  express:application set &#34;port&#34; to 3000 +2ms
  server:server Listening on port 3000 +0ms</code></pre></div></div></div></div></div><p>Each line of output starts with a package name, such as <code>express:application</code> showing the <em>namespace</em> where the logging message came from (which usually corresponds to the library or module it is contained in), followed by the message itself. The last part of the line looks like <code>+0ms</code>, and is simply a timestamp showing the time elapsed since the last debug message was printed.</p><p>At the very bottom we see the debug line <code>server:server Listening on port 3000 +0ms</code> - this line is what is actually printed in the <code>bin/www</code> file. Let&rsquo;s look at that file and see where that comes from:</p><div class=tab-panel data-tab-group=f354cbb0f2769512bd782082a8094dd2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f354cbb0f2769512bd782082a8094dd2","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>debugLibrary</span> <span class=nx>from</span> <span class=s1>&#39;debug&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>debug</span> <span class=o>=</span> <span class=nx>debugLibrary</span><span class=p>(</span><span class=s1>&#39;server:server&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>onListening</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>addr</span> <span class=o>=</span> <span class=nx>server</span><span class=p>.</span><span class=nx>address</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>bind</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>addr</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=s1>&#39;pipe &#39;</span> <span class=o>+</span> <span class=nx>addr</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=s1>&#39;port &#39;</span> <span class=o>+</span> <span class=nx>addr</span><span class=p>.</span><span class=nx>port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>debug</span><span class=p>(</span><span class=s1>&#39;Listening on &#39;</span> <span class=o>+</span> <span class=nx>bind</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>At the top of that file, we import the <code>debug</code> library, and then instantiate it using the name <code>'server:server'</code>. This becomes the <em>namespace</em> for our debug messages printed using this instance of the <code>debug</code> library. Then, inside of the <code>onListening()</code> function, we call the <code>debug</code> function and provide a message to be printed.</p><p>When we run our application, we can change the value of the <code>DEBUG</code> environment variable to match a particular namespace to only see messages from that part of our application:</p><div class=tab-panel data-tab-group=b1f09a18ef6f6e3d65f96a2a1da74d7e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b1f09a18ef6f6e3d65f96a2a1da74d7e","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ $ <span class=nv>DEBUG</span><span class=o>=</span>server:* npm start</span></span></code></pre></div></div></div></div></div><p>This will only show output from our <code>server</code> namespace:</p><div class=tab-panel data-tab-group=9cf094041b955cf1bd04469262cee4a4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9cf094041b955cf1bd04469262cee4a4","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; example-project@0.0.1 start
</span></span><span class=line><span class=cl>&gt; node ./bin/www
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  server:server Listening on port <span class=m>3000</span> +0ms</span></span></code></pre></div></div></div></div></div><p>The <code>debug</code> utility is a very powerful tool for diagnosing issues with a Node.js and Express application. You can learn more about how to use and configure the <code>debug</code> utility in the <a href=https://www.npmjs.com/package/debug rel=external target=_blank>documentation</a>.</p><h2 id=logging-with-winston>Logging with Winston</h2><p>However, since we are focused on creating a web application and not a library, let&rsquo;s replace <code>debug</code> with the more powerful <a href=https://www.npmjs.com/package/winston rel=external target=_blank>winston</a> logger. This allows us to create a robust logging system based on the traditional concept of <a href=https://en.wikipedia.org/wiki/Syslog#Severity_level rel=external target=_blank>severity levels</a> of the logs we want to see.</p><p>To start, let&rsquo;s install <code>winston</code> using the <code>npm</code> command (as always, we should make sure we are working in the <code>server</code> directory of our application):</p><div class=tab-panel data-tab-group=610f25abdb568e6d108e8bf758bd1d8b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("610f25abdb568e6d108e8bf758bd1d8b","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install winston</span></span></code></pre></div></div></div></div></div><p>We should see output similar to the following:</p><div class=highlight><pre tabindex=0><code>added 28 packages, and audited 118 packages in 2s

15 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities</code></pre></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Multiple Dependencies</div><div class=box-content><p>Notice how installing a single dependency actually installed 28 individual packages? This is a very useful feature of how Node.js and npm packages are structured, since each package can focus on doing only one task really well while reusing common tools and utilities that other packages may also use (thereby reducing the number of duplicated packages that may need to be installed). Unfortunately, this can also lead to situations where an issue with a single package can cause cascading failures and incompatibilities across the board. So, while it is very helpful to install these dependencies in our application, we always want to do so with caution and make sure are always using dependencies that are well maintained and actually add value to our application.</p></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> The <code>left-pad</code> Incident</div><div class=box-content><p>For a vivid case study of the concerns around using unnecessary dependencies, look at the <a href=https://en.wikipedia.org/wiki/Npm_left-pad_incident rel=external target=_blank>npm left-pad incident</a>. The <code>left-pad</code> library was a simple utility that added padding to the left side of a string. The entire library itself was a single function that contained less than 10 lines of actual code. However, when the developer of that library removed access to it due to a dispute, it ended up nearly breaking the entire npm ecosystem. Core development tools such as Babel, Webpack and more all used that library as a dependency, and with the rise of automated build systems, each tool broke as soon as the next rebuild cycle was initiated. It also caused issues with major online platforms such as Facebook, PayPal, Netflix, and Spotify.</p><p>Even today, nearly 9 years after the incident, the <a href=https://www.npmjs.com/package/left-pad rel=external target=_blank>left-pad</a> library is still present on npm, even though it is listed as deprecated since JavaScript now includes a method <code>String.prototype.padStart()</code> that performs the same action. As of January 2025, there are still 540 libraries on npm that list <code>left-pad</code> as a dependency, and it is downloaded over 1 million times per week!</p></div></div><p>Now that we&rsquo;ve installed <code>winston</code>, we should configure it. We could place all of the code to configure it inside of each file where it is used, but let&rsquo;s instead create a standalone configuration file for <code>winston</code> that we can use throughout our application.</p><p>To do this, let&rsquo;s create a new folder named <code>configs</code> inside of our <code>server</code> folder to house configurations for various dependencies, and then inside of that folder create a new file named <code>logger.js</code> for this configuration. In that file, we can place the following content:</p><div class=tab-panel data-tab-group=54c6d4270672cbde39dccc527391481b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsloggerjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("54c6d4270672cbde39dccc527391481b","configsloggerjs")'>
<span class=tab-nav-text>configs/logger.js</span></button></div><div class=tab-content-container><div data-tab-item=configsloggerjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>winston</span> <span class=nx>from</span> <span class=s1>&#39;winston&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>combine</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=nx>printf</span><span class=p>,</span> <span class=nx>colorize</span><span class=p>,</span> <span class=nx>align</span><span class=p>,</span> <span class=nx>errors</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>format</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Log Levels
</span></span></span><span class=line><span class=cl><span class=c1>//   error: 0
</span></span></span><span class=line><span class=cl><span class=c1>//   warn: 1
</span></span></span><span class=line><span class=cl><span class=c1>//   info: 2
</span></span></span><span class=line><span class=cl><span class=c1>//   http: 3
</span></span></span><span class=line><span class=cl><span class=c1>//   verbose: 4
</span></span></span><span class=line><span class=cl><span class=c1>//   debug: 5
</span></span></span><span class=line><span class=cl><span class=c1>//   silly: 6
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>level</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;0&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;error&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;error&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;1&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;warn&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;warn&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;2&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;info&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;info&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;3&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;http&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;4&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;verbose&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;verbose&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;5&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;debug&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;debug&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;6&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;silly&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;silly&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>logger</span> <span class=o>=</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>createLogger</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=c1>// call `level` function to get default log level
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>level</span><span class=o>:</span> <span class=nx>level</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Format configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>format</span><span class=o>:</span> <span class=nx>combine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>colorize</span><span class=p>({</span> <span class=nx>all</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=nx>errors</span><span class=p>({</span> <span class=nx>stack</span><span class=o>:</span> <span class=kc>true</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=nx>timestamp</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=nx>format</span><span class=o>:</span> <span class=s1>&#39;YYYY-MM-DD hh:mm:ss.SSS A&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=nx>align</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>printf</span><span class=p>((</span><span class=nx>info</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=sb>`[</span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>timestamp</span><span class=si>}</span><span class=sb>] </span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>level</span><span class=si>}</span><span class=sb>: </span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>stack</span> <span class=o>?</span> <span class=nx>info</span><span class=p>.</span><span class=nx>stack</span> <span class=o>:</span> <span class=nx>info</span><span class=p>.</span><span class=nx>message</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Output configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>transports</span><span class=o>:</span> <span class=p>[</span><span class=k>new</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>transports</span><span class=p>.</span><span class=nx>Console</span><span class=p>()]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>logger</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>At the top, we see a helpful comment just reminding us which log levels are available by default in <code>winston</code>. Then, we have a <code>level</code> function that determines what our desired log level should be based on an environment variable named <code>LOG_LEVEL</code>. We&rsquo;ll set that variable a bit later in this tutorial. Based on that log level, our system will print any logs at that level or lower in severity level. Finally, we create an instance of the <code>winston</code> logger and provide lots of configuration information about our desired output format. All of this is highly configurable. To fully understand this configuration, take some time to review the <a href=https://www.npmjs.com/package/winston rel=external target=_blank>winston documentation</a>.</p><p>Now, let&rsquo;s update our <code>bin/www</code> file to use this logger instead of the <code>debug</code> utility. Lines that have been changed are highlighted:</p><div class=tab-panel data-tab-group=9459391f292b66fdd1f8b9e100e3b5c3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9459391f292b66fdd1f8b9e100e3b5c3","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// var debug = require(&#39;debug&#39;)(&#39;server:server&#39;);
</span></span></span><span class="line hl"><span class=cl><span class=c1>// import debugLibrary from &#39;debug&#39;;
</span></span></span><span class="line hl"><span class=cl><span class=c1>// const debug = debugLibrary(&#39;server:server&#39;);
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;../configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>onError</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>syscall</span> <span class=o>!==</span> <span class=s1>&#39;listen&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=nx>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>bind</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>port</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=s1>&#39;Pipe &#39;</span> <span class=o>+</span> <span class=nx>port</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=s1>&#39;Port &#39;</span> <span class=o>+</span> <span class=nx>port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// handle specific listen errors with friendly messages
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>switch</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>code</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s1>&#39;EACCES&#39;</span><span class=o>:</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// console.error(bind + &#39; requires elevated privileges&#39;);
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=nx>bind</span> <span class=o>+</span> <span class=s1>&#39; requires elevated privileges&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s1>&#39;EADDRINUSE&#39;</span><span class=o>:</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// console.error(bind + &#39; is already in use&#39;);
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=nx>bind</span> <span class=o>+</span> <span class=s1>&#39; is already in use&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=nx>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Event listener for HTTP server &#34;listening&#34; event.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>onListening</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>addr</span> <span class=o>=</span> <span class=nx>server</span><span class=p>.</span><span class=nx>address</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>bind</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>addr</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=s1>&#39;pipe &#39;</span> <span class=o>+</span> <span class=nx>addr</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=s1>&#39;port &#39;</span> <span class=o>+</span> <span class=nx>addr</span><span class=p>.</span><span class=nx>port</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl>  <span class=c1>// debug(&#39;Listening on &#39; + bind);
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>  <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s1>&#39;Listening on &#39;</span> <span class=o>+</span> <span class=nx>bind</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Basically, we&rsquo;ve replaced all instances of the <code>debug</code> method with <code>logger.debug</code>. We&rsquo;ve also replaced a couple of uses of <code>console.error</code> to instead use <code>logger.error</code>. They will also create new <code>Error</code> object, which will cause <code>winston</code> to print a stack trace as well.</p><p>With that change in place, we can now remove the <code>debug</code> utility from our list of dependencies:</p><div class=tab-panel data-tab-group=e670b9d9686e4fafdd6051e7ed7b1865><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e670b9d9686e4fafdd6051e7ed7b1865","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm uninstall debug</span></span></code></pre></div></div></div></div></div><p>Now, let&rsquo;s run our program to see <code>winston</code> in action:</p><div class=tab-panel data-tab-group=a01e8c4bf17b3070c33c3d33e6449cda><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a01e8c4bf17b3070c33c3d33e6449cda","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm start</span></span></code></pre></div></div></div></div></div><p>When we run it, we should see this output:</p><div class=tab-panel data-tab-group=dbad25a19d9bf2ee3c42e83b23b1e550><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("dbad25a19d9bf2ee3c42e83b23b1e550","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 start
&gt; node ./bin/www</code></pre></div></div></div></div></div><p>Notice how <code>winston</code> didn&rsquo;t print any debug messages? That is because we haven&rsquo;t set our <code>LOG_LEVEL</code> environment variable. So, let&rsquo;s do that by creating two different scripts in our <code>package.json</code> file - one to run the application with a default log level, and another to run it with the <code>debug</code> log level:</p><div class=tab-panel data-tab-group=da6c6c27a481d763b59e00b5723829a3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("da6c6c27a481d763b59e00b5723829a3","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;module&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=debug node ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cookie-parser&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.4.7&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;express&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.21.2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;morgan&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.10.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;winston&#34;</span><span class=p>:</span> <span class=s2>&#34;^3.17.0&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>The <code>npm run</code> command can be used to run any of the scripts in the <code>scripts</code> section of our <code>package.json</code> file.
So, if we want to run our application so we can see the debug messages, we can use the following command:</p><div class=tab-panel data-tab-group=d5f67a4c54ff95ec8fc67844b3fc1f33><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d5f67a4c54ff95ec8fc67844b3fc1f33","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Now we should see some debug messages in the output:</p><div class=tab-panel data-tab-group=6af78b797662bed41a7a2992e018820d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6af78b797662bed41a7a2992e018820d","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; LOG_LEVEL=debug node ./bin/www

[2025-01-17 06:23:03.622 PM] info:      Listening on port 3000</code></pre></div></div></div></div></div><p>Great! Notice how the logger outputs a timestamp, the log level, and the message, all on the same line? This matches the configuration we used in the <code>configs/logger.js</code> file. On most terminals, each log level will even be a different color!</p><p><a href=#R-image-fc8b800e793be3cbda9da30014c40e45 class=lightbox-link><img alt="Debug Logging in Color" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/debug_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fc8b800e793be3cbda9da30014c40e45><img alt="Debug Logging in Color" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/debug_1.png></a></p><p>Finally, since we really should make sure the message that the application is successfully listening on a port is printed by default, let&rsquo;s change it to the <code>info</code> log level in our <code>bin/www</code> file:</p><div class=tab-panel data-tab-group=61af6ceaff7b641f8b343f32eca20306><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("61af6ceaff7b641f8b343f32eca20306","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>onListening</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>addr</span> <span class=o>=</span> <span class=nx>server</span><span class=p>.</span><span class=nx>address</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>bind</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>addr</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=s1>&#39;pipe &#39;</span> <span class=o>+</span> <span class=nx>addr</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=s1>&#39;port &#39;</span> <span class=o>+</span> <span class=nx>addr</span><span class=p>.</span><span class=nx>port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// debug(&#39;Listening on &#39; + bind);
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>  <span class=nx>logger</span><span class=p>.</span><span class=nx>info</span><span class=p>(</span><span class=s1>&#39;Listening on &#39;</span> <span class=o>+</span> <span class=nx>bind</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Why Not Use NODE_ENV?</div><div class=box-content><p>In many web applications written using Node.js and Express, you may have come across the <code>NODE_ENV</code> environment variable, which is often set to either <code>development</code>, <code>production</code>, or sometimes <code>test</code> to configure the application. While this may have made sense in the past, it is now considered an <em>anti-pattern</em> in Node.js. This is because there no fundamental difference between development and production in Node.js, and it is often very confusing if an application runs differently in different environments. So, it is better to directly configure logging via its own environment variable instead of using an overall variable that configures multiple services. See the <a href=https://nodejs.org/en/learn/getting-started/nodejs-the-difference-between-development-and-production rel=external target=_blank>Node.js Documentation</a> for a deeper discussion of this topic.</p></div></div><p>This is a good point to <strong>commit and push</strong> our work!</p><h2 id=references>References</h2><ul><li><a href=https://betterstack.com/community/guides/logging/how-to-install-setup-and-use-winston-and-morgan-to-log-node-js-applications/ rel=external target=_blank>A Complete Guide to Winston Logging in Node.js</a></li><li><a href=https://levelup.gitconnected.com/better-logs-for-expressjs-using-winston-and-morgan-with-typescript-1c31c1ab9342 rel=external target=_blank>Better logs for ExpressJS using Winston and Morgan with Typescript</a></li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=request-logging>Request Logging</h1><a href="https://www.youtube.com/watch?v=0d9YbadZ3Mk">YouTube Video</a><h2 id=logging-requests-with-morgan>Logging Requests with Morgan</h2><p>Now that we have configured a logging utility, let&rsquo;s use it to also log all incoming requests sent to our web application. This will definitely make it much easier to keep track of what is going on in our application and make sure it is working correctly.</p><p>The Express application generator already installs a library for this, called <a href=https://www.npmjs.com/package/morgan rel=external target=_blank>morgan</a>. We have already seen output from <code>morgan</code> before:</p><div class=tab-panel data-tab-group=1b81f6cf4eff8300689c3cb5ba2c872a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1b81f6cf4eff8300689c3cb5ba2c872a","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>GET / 304 2.569 ms - -
GET /users 200 2.417 ms - 23
GET / 200 1.739 ms - 120</code></pre></div></div></div></div></div><p>While this is useful, let&rsquo;s reconfigure <code>morgan</code> to use our new <code>winston</code> logger and add some additional detail to the output.</p><p>Since <code>morgan</code> is technically a <a href=https://expressjs.com/en/guide/using-middleware.html rel=external target=_blank>middleware</a> in our application, let&rsquo;s create a new folder called <code>middlewares</code> to store configuration for our various middlewares, and then we can create a new middleware file named <code>request-logger.js</code> in that folder. Inside of that file, we can place the following configuration:</p><div class=tab-panel data-tab-group=48ba67541bf8cf22dc78c21d045617cf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=middlewaresrequest-loggerjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("48ba67541bf8cf22dc78c21d045617cf","middlewaresrequest-loggerjs")'>
<span class=tab-nav-text>middlewares/request-logger.js</span></button></div><div class=tab-content-container><div data-tab-item=middlewaresrequest-loggerjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>morgan</span> <span class=nx>from</span> <span class=s1>&#39;morgan&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;../configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Override morgan stream method to use our custom logger
</span></span></span><span class=line><span class=cl><span class=c1>// Log Format
</span></span></span><span class=line><span class=cl><span class=c1>// :method :url :status :response-time ms - :res[content-length]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>stream</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>write</span><span class=o>:</span> <span class=p>(</span><span class=nx>message</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// log using the &#39;http&#39; severity
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>logger</span><span class=p>.</span><span class=nx>http</span><span class=p>(</span><span class=nx>message</span><span class=p>.</span><span class=nx>trim</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// See https://github.com/expressjs/morgan?tab=readme-ov-file#api
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>requestLogger</span> <span class=o>=</span> <span class=nx>morgan</span><span class=p>(</span><span class=s1>&#39;dev&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>stream</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>requestLogger</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>In effect, this file basically tells <code>morgan</code> to write output through the <code>logger.http()</code> method instead of just directly to the console. We are importing our <code>winston</code> configuration from <code>configs/logger.js</code> to accomplish this. We are also configuring <code>morgan</code> to use the <code>dev</code> logging format; more information on log formats can be found in the <a href=https://www.npmjs.com/package/morgan rel=external target=_blank>documentation</a>.</p><p>Finally, let&rsquo;s update our <code>app.js</code> file to use this new request logger middleware instead of <code>morgan</code>:</p><div class=tab-panel data-tab-group=bfc8a9ffacd87294e4ff0cf72439a471><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bfc8a9ffacd87294e4ff0cf72439a471","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=c1>// import logger from &#39;morgan&#39;;
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>requestLogger</span> <span class=nx>from</span> <span class=s1>&#39;./middlewares/request-logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/index.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/users.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// app.use(logger(&#39;dev&#39;));
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s1>&#39;public&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, let&rsquo;s run our application and access a few of the routes via our web browser:</p><div class=tab-panel data-tab-group=2c09f74f24bb236614bbc88b8f1887d6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2c09f74f24bb236614bbc88b8f1887d6","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>We should now see output from <code>morgan</code> included as <code>http</code> logs from <code>winston</code>:</p><div class=tab-panel data-tab-group=57b9229336bc8ec2e7c252a806013a76><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("57b9229336bc8ec2e7c252a806013a76","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; LOG_LEVEL=debug node ./bin/www

[2025-01-17 06:39:30.975 PM] info:      Listening on port 3000
[2025-01-17 06:39:37.430 PM] http:      GET / 200 3.851 ms - 120
[2025-01-17 06:39:40.665 PM] http:      GET /users 200 3.184 ms - 23
[2025-01-17 06:39:43.069 PM] http:      GET / 304 0.672 ms - -
[2025-01-17 06:39:45.424 PM] http:      GET /users 304 1.670 ms - -</code></pre></div></div></div></div></div><p>When viewed on a modern terminal, they should even be colorized!</p><p><a href=#R-image-661a621f2a0126799bbe81f5703a1cb0 class=lightbox-link><img alt="Request Logging" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/request_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-661a621f2a0126799bbe81f5703a1cb0><img alt="Request Logging" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/request_1.png></a></p><p>Here, we can see each log level is colorized, and also the HTTP status codes in our <code>morgan</code> log output are also colorized. The first time each page is accessed, the browser receives a <code>200</code> status code in green with the content. The second time, our application correctly sends back a <code>304</code> status code in light blue, indicating that the content has not been modified and that the browser can use the cached version instead.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=other-libraries>Other Libraries</h1><a href="https://www.youtube.com/watch?v=ntg2fQQ1FQ8">YouTube Video</a><h2 id=other-useful-libraries>Other Useful Libraries</h2><p>Before we move on, let&rsquo;s install a few other useful libraries that perform various tasks in our Express application.</p><h3 id=compression>Compression</h3><p>The <a href=https://www.npmjs.com/package/compression rel=external target=_blank>compression</a> middleware library does exactly what it says it will - it compresses any responses generated by the server and sent through the network. This can be helpful in many situations, but not all. Recall that compression is really just trading more processing time in exchange for less network bandwidth, so we may need to consider which of those we are more concerned about. Thankfully, adding or removing the <code>compression</code> middleware library is simple.</p><p>First, let&rsquo;s install it using <code>npm</code>:</p><div class=tab-panel data-tab-group=4228f6052e35ddad5fa6a4a13cba4273><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4228f6052e35ddad5fa6a4a13cba4273","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install compression</span></span></code></pre></div></div></div></div></div><p>Then, we can add it to our <code>app.js</code> file, generally early in the chain of middlewares since it will impact all responses after that point in the chain.</p><div class=tab-panel data-tab-group=6a3c618fe8f2307f166ee275766204dd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6a3c618fe8f2307f166ee275766204dd","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>compression</span> <span class=nx>from</span> <span class=s1>&#39;compression&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>requestLogger</span> <span class=nx>from</span> <span class=s1>&#39;./middlewares/request-logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/index.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/users.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>compression</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s1>&#39;public&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/users&#39;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>app</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>To test this library, we can run our application with all built-in debugging enabled through the <code>debug</code> library as documented in the <a href=https://expressjs.com/en/guide/debugging.html rel=external target=_blank>Express Documentation</a>:</p><div class=tab-panel data-tab-group=74214fb8fb00c16ad23640fbc54bc1bc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("74214fb8fb00c16ad23640fbc54bc1bc","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nv>DEBUG</span><span class=o>=</span>* npm run dev</span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll see a bunch of output as our Express application is initialized. Once it is done, we can open the home page in our web browser to send an HTTP GET request to the server. This will produce the following log output:</p><div class=tab-panel data-tab-group=82f0c347137e9aa2011fa84719763c51><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("82f0c347137e9aa2011fa84719763c51","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  express:router dispatching GET / +1m
</span></span><span class=line><span class=cl>  express:router query  : / +0ms
</span></span><span class=line><span class=cl>  express:router expressInit  : / +1ms
</span></span><span class=line><span class=cl>  express:router compression  : / +0ms
</span></span><span class=line><span class=cl>  express:router logger  : / +0ms
</span></span><span class=line><span class=cl>  express:router urlencodedParser  : / +0ms
</span></span><span class=line><span class=cl>  body-parser:urlencoded skip empty body +1ms
</span></span><span class=line><span class=cl>  express:router cookieParser  : / +0ms
</span></span><span class=line><span class=cl>  express:router serveStatic  : / +0ms
</span></span><span class=line><span class=cl>  send stat <span class=s2>&#34;/workspaces/example-project/server/public/index.html&#34;</span> +0ms
</span></span><span class=line><span class=cl>  send pipe <span class=s2>&#34;/workspaces/example-project/server/public/index.html&#34;</span> +1ms
</span></span><span class=line><span class=cl>  send accept ranges +0ms
</span></span><span class=line><span class=cl>  send cache-control public, max-age<span class=o>=</span><span class=m>0</span> +0ms
</span></span><span class=line><span class=cl>  send modified Thu, <span class=m>16</span> Jan <span class=m>2025</span> 23:17:14 GMT +0ms
</span></span><span class=line><span class=cl>  send etag W/<span class=s2>&#34;78-1947168173e&#34;</span> +1ms
</span></span><span class=line><span class=cl>  send content-type text/html +0ms
</span></span><span class="line hl"><span class=cl>  compression no compression: size below threshold +1ms
</span></span><span class=line><span class=cl>  morgan log request +2ms
</span></span><span class=line><span class=cl><span class=o>[</span>2025-01-25 07:00:35.013 PM<span class=o>]</span> http:      GET / <span class=m>200</span> 3.166 ms - <span class=m>120</span></span></span></code></pre></div></div></div></div></div><p>We can see in the highlighted line that the <code>compression</code> library did not apply any compression to the response because it was below the minium size threshold. This is set to 1kb by default according to the <a href=https://www.npmjs.com/package/compression rel=external target=_blank>compression</a> documentation.</p><p>So, to really see what it does, let&rsquo;s generate a much larger response by adding some additional text to our <code>public/index.html</code> file (this text was generated using <a href=https://www.lipsum.com/ rel=external target=_blank>Lorem Ipsum</a>):</p><div class=tab-panel data-tab-group=5d41fc73e999e8ef644db9476ef0aa8e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=publicindexhtml class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5d41fc73e999e8ef644db9476ef0aa8e","publicindexhtml")'>
<span class=tab-nav-text>public/index.html</span></button></div><div class=tab-content-container><div data-tab-item=publicindexhtml class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Express<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>Express<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Welcome to Express<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam sed arcu tincidunt, porttitor diam a, porta nibh. Duis pretium tellus euismod, imperdiet elit id, gravida turpis. Fusce vitae pulvinar tellus. Donec cursus pretium justo, sed vehicula erat iaculis lobortis. Mauris dapibus scelerisque aliquet. Nullam posuere, magna vitae viverra lacinia, sapien magna imperdiet erat, ac sagittis ante ante tristique eros. Phasellus eget fermentum mauris. Integer justo lorem, finibus a ullamcorper in, feugiat in nunc. Etiam ut felis a magna aliquam consectetur. Duis eu mauris ut leo vehicula fringilla scelerisque vel mi. Donec placerat quam nulla, at commodo orci maximus sit amet. Curabitur tincidunt euismod enim, non feugiat nulla eleifend sed. Sed finibus metus sit amet metus congue commodo. Cras ullamcorper turpis sed mi scelerisque porta.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Sed maximus diam in blandit elementum. Integer diam ante, tincidunt in pulvinar at, luctus in dui. Fusce tincidunt hendrerit dolor in suscipit. Nullam vitae tellus at justo bibendum blandit a vel ligula. Nunc sed augue blandit, finibus nisi nec, posuere orci. Maecenas ut egestas diam. Donec non orci nec ex rhoncus malesuada at eget ante. Proin ultricies cursus nunc eu mollis. Donec vel ligula vel eros luctus pulvinar. Proin vitae dui imperdiet, rutrum risus non, maximus purus. Vivamus fringilla augue tincidunt, venenatis arcu eu, dictum nunc. Mauris eu ullamcorper orci. Cras efficitur egestas ligula. Maecenas a nisl bibendum turpis tristique lobortis.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span></span></span></code></pre></div></div></div></div></div><p>Now, when we request that file, we should see this line in our debug output:</p><div class=tab-panel data-tab-group=766f2e2947bebb2fe1d6ffcfec69d607><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("766f2e2947bebb2fe1d6ffcfec69d607","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>express:router dispatching GET / +24s
</span></span><span class=line><span class=cl>  express:router query  : / +1ms
</span></span><span class=line><span class=cl>  express:router expressInit  : / +0ms
</span></span><span class=line><span class=cl>  express:router compression  : / +0ms
</span></span><span class=line><span class=cl>  express:router logger  : / +0ms
</span></span><span class=line><span class=cl>  express:router urlencodedParser  : / +0ms
</span></span><span class=line><span class=cl>  body-parser:urlencoded skip empty body +0ms
</span></span><span class=line><span class=cl>  express:router cookieParser  : / +1ms
</span></span><span class=line><span class=cl>  express:router serveStatic  : / +0ms
</span></span><span class=line><span class=cl>  send stat <span class=s2>&#34;/workspaces/example-project/server/public/index.html&#34;</span> +0ms
</span></span><span class=line><span class=cl>  send pipe <span class=s2>&#34;/workspaces/example-project/server/public/index.html&#34;</span> +0ms
</span></span><span class=line><span class=cl>  send accept ranges +0ms
</span></span><span class=line><span class=cl>  send cache-control public, max-age<span class=o>=</span><span class=m>0</span> +0ms
</span></span><span class=line><span class=cl>  send modified Sat, <span class=m>25</span> Jan <span class=m>2025</span> 19:05:18 GMT +0ms
</span></span><span class=line><span class=cl>  send etag W/<span class=s2>&#34;678-1949edaaa4c&#34;</span> +0ms
</span></span><span class=line><span class=cl>  send content-type text/html +0ms
</span></span><span class="line hl"><span class=cl>  compression gzip compression +1ms
</span></span><span class=line><span class=cl>  morgan log request +1ms
</span></span><span class=line><span class=cl><span class=o>[</span>2025-01-25 07:05:20.234 PM<span class=o>]</span> http:      GET / <span class=m>200</span> 1.232 ms - -</span></span></code></pre></div></div></div></div></div><p>As we can see, the <code>compression</code> middleware is now compressing the response before it is sent to the server using the <a href=https://en.wikipedia.org/wiki/Gzip rel=external target=_blank>gzip</a> compression algorithm. We can also see this in our web browser&rsquo;s debugging tools - in Google Chrome, we notice that the <code>Content-Encoding</code> header is set to <code>gzip</code> as shown below:</p><p><a href=#R-image-0f6b4032fc3b51509870b1fb61a55ace class=lightbox-link><img alt="Compressed Server Response" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/other_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0f6b4032fc3b51509870b1fb61a55ace><img alt="Compressed Server Response" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/other_1.png></a></p><p>We&rsquo;ll go ahead and integrate the <code>compression</code> middleware into our project for this course, but as discussed above, it is always worth considering whether the tradeoff of additional processing time to save network bandwidth is truly worth it.</p><h3 id=helmet>Helmet</h3><p>Another very useful Express library is <a href=https://www.npmjs.com/package/helmet rel=external target=_blank>helmet</a>. Helmet sets several headers in the HTTP response from an Express application to help improve security. This includes things such as setting an appropriate <a href=https://helmetjs.github.io/#content-security-policy rel=external target=_blank>Content-Security-Policy</a> and removing information about the web server that could be leaked in the <a href=https://helmetjs.github.io/#x-powered-by rel=external target=_blank>X-Powered-By</a> header.</p><p>To install <code>helmet</code> we can simply use <code>npm</code> as always:</p><div class=tab-panel data-tab-group=436b3b8501d29184acfe5c6deb760555><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("436b3b8501d29184acfe5c6deb760555","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install helmet</span></span></code></pre></div></div></div></div></div><p>Similar to the <code>compression</code> library above, we can simply add <code>helmet</code> to our Express application&rsquo;s <code>app.js</code> file:</p><div class=tab-panel data-tab-group=46e77f9069ea4d3eb33b234576300e8c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("46e77f9069ea4d3eb33b234576300e8c","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>compression</span> <span class=nx>from</span> <span class=s1>&#39;compression&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>helmet</span> <span class=nx>from</span> <span class=s1>&#39;helmet&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>requestLogger</span> <span class=nx>from</span> <span class=s1>&#39;./middlewares/request-logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/index.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/users.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>helmet</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>compression</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s1>&#39;public&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/users&#39;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>app</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>To really see what the <code>helmet</code> library does, we can examine the headers sent by the server with and without <code>helmet</code> enabled.</p><p>First, here are the headers sent by the server without <code>helmet</code> enabled:</p><p><a href=#R-image-c010b1f5b3169218d746c9f683bdd396 class=lightbox-link><img alt="Insecure Headers" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/other_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c010b1f5b3169218d746c9f683bdd396><img alt="Insecure Headers" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/other_2.png></a></p><p>When <code>helmet</code> is enabled, we see an entirely different set of headers:</p><p><a href=#R-image-346f9d3a18814544a29ca66c816c9f4d class=lightbox-link><img alt="Secure Headers" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/other_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-346f9d3a18814544a29ca66c816c9f4d><img alt="Secure Headers" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/other_3.png></a></p><p>In the second screenshot, notice that the <code>Content-Security-Policy</code> header is now present, but the <code>X-Powered-By</code> header is not? Those changes, along with many others, are provided by the <code>helmet</code> library.</p><p>In general, it is always a good idea to review the security of the headers sent by our application. Installing <code>helmet</code> is a good start, but as we continue to develop applications we may learn additional ways we can configure <code>helmet</code> to provide even more security for our applications.</p><h3 id=nodemon>Nodemon</h3><p>Finally, let&rsquo;s also install the <a href=https://www.npmjs.com/package/nodemon rel=external target=_blank>nodemon</a> package to make developing our application a bit easier. At its core, <code>nodemon</code> is a simple tool that will auotmatically restart our application anytime it detects that a file has changed. In this way, we can just leave our application running in the background, and any changes we make to the code will immediately be availbale for us to test without having to manually restart the server.</p><p>To begin, let&rsquo;s install <code>nodemon</code> as a development dependency using <code>npm</code> with the <code>--save-dev</code> flag:</p><div class=tab-panel data-tab-group=a60b171af8a304ecce2bc82fd60f2af8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a60b171af8a304ecce2bc82fd60f2af8","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install nodemon --save-dev</span></span></code></pre></div></div></div></div></div><p>Notice that this will cause that library to be installed in a new section of our <code>package.json</code> file called <code>devDependencies</code>:</p><div class=tab-panel data-tab-group=87e8433c696d47ccd9d96dc58545df68><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("87e8433c696d47ccd9d96dc58545df68","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;compression&#34;</span><span class=p>:</span> <span class=s2>&#34;^1.7.5&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cookie-parser&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.4.7&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;express&#34;</span><span class=p>:</span> <span class=s2>&#34;~4.21.2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;helmet&#34;</span><span class=p>:</span> <span class=s2>&#34;^8.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;morgan&#34;</span><span class=p>:</span> <span class=s2>&#34;~1.10.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;winston&#34;</span><span class=p>:</span> <span class=s2>&#34;^3.17.0&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;devDependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;nodemon&#34;</span><span class=p>:</span> <span class=s2>&#34;^3.1.9&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>These dependencies are only installed by <code>npm</code> when we are developing our application. The default <code>npm install</code> command will install all dependencies, including development dependencies. However, we can instead either use <code>npm install --omit=dev</code> or set the <code>NODE_ENV</code> environment variable to <code>production</code> to avoid installing development dependencies.</p><p>Next, we can simply update our <code>package.json</code> file to use the <code>nodemon</code> command instead of <code>node</code> in the <code>dev</code> script:</p><div class=tab-panel data-tab-group=fe9b5e126ade3733ac9b2b2efd283fa3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fe9b5e126ade3733ac9b2b2efd283fa3","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;module&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=debug nodemon ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Now, when we execute our application:</p><div class=tab-panel data-tab-group=376ffab5780dce7ac28c7e81df8fc87c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("376ffab5780dce7ac28c7e81df8fc87c","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>We should see additional output from <code>nodemon</code> to see that it is working:</p><div class=tab-panel data-tab-group=fbf6fffce57f14eb0eb94680f1a976d6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fbf6fffce57f14eb0eb94680f1a976d6","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; LOG_LEVEL=debug nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[2025-01-25 09:37:24.734 PM] info:      Listening on port 3000</code></pre></div></div></div></div></div><p>Now, with our application running, we can make any change to a file in our application, such as <code>app.js</code>, and it will automatically restart our application:</p><div class=tab-panel data-tab-group=11db160508f139eec1323d0a0809aebf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("11db160508f139eec1323d0a0809aebf","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[nodemon] restarting due to changes...
[nodemon] starting `node ./bin/www`
[2025-01-25 09:39:02.858 PM] info:      Listening on port 3000</code></pre></div></div></div></div></div><p>We can also always manually type <code>rs</code> in the terminal to restart the application when it is running inside of <code>nodemon</code>.</p><p>In general, using <code>nodemon</code> to develop a Node.js application is recommended, but we don&rsquo;t want to use that in a production environment. So, we are careful to install <code>nodemon</code> as a development dependency only.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=environment>Environment</h1><a href="https://www.youtube.com/watch?v=RwurcrpXW7g">YouTube Video</a><h2 id=environment-variables>Environment Variables</h2><p>As discussed earlier, an <a href=https://en.wikipedia.org/wiki/Environment_variable rel=external target=_blank><strong>environment variable</strong></a> is a value present in memory in the operating system environment where a process is running. They contain important information about the system where the application is running, but they can also be configured by the user or system administrator to provide information and configuration to any processes running in that environment. This is especially used when working with <strong>containers</strong> like the dev container we built for this project.</p><p>To explore this, we can use the <code>printenv</code> command in any Linux terminal:</p><div class=tab-panel data-tab-group=075add97e46719fd366c472fd206988f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("075add97e46719fd366c472fd206988f","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ printenv</span></span></code></pre></div></div></div></div></div><p>When we run that command in our GitHub codespace, we&rsquo;ll see output containing lines similar to this (many lines have been omitted as they contain secure information):</p><div class=tab-panel data-tab-group=bed0e2fecbbf78a6a659a03193767788><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bed0e2fecbbf78a6a659a03193767788","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>SHELL=/bin/bash
GITHUB_USER=russfeld
CODESPACE_NAME=laughing-computing-machine-jj5j9p97vx435jqj
HOSTNAME=codespaces-f1a983
RepositoryName=example-project
CODESPACES=true
YARN_VERSION=1.22.22
PWD=/workspaces/example-project/server
ContainerVersion=13
GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN=app.github.dev
USER=node
NODE_VERSION=22.12.0
OLDPWD=/workspaces/example-project
TERM_PROGRAM=vscode</code></pre></div></div></div></div></div><p>As we can see, the environment contains many useful variables, including a <code>CODESPACES</code> variable showing that the application is running in GitHub Codespaces. We can also find our <code>GITHUB_USER</code>, <code>CODESPACE_NAME</code> and even the <code>NODE_VERSION</code> all in the environment.</p><h2 id=configuring-the-environment>Configuring the Environment</h2><p>Because many web applications eventually run in a containerized environment anyway, it is very common practice to configure those applications through the use of environment variables. Thankfully, we can more easily control and configure our application through the use of a special library <a href=https://dotenvx.com/ rel=external target=_blank>dotenvx</a> that allows us to load a set of environment variables from a file named <code>.env</code>.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> dotenv</div><div class=box-content><p>The <code>dotenvx</code> library is a newer version of the <a href=https://www.npmjs.com/package/dotenv rel=external target=_blank>dotenv</a> library that has been used for this purpose for many years. <code>dotenvx</code> was developed by the same developer, and is often recommended as a new, modern replacement to <code>dotenv</code> for most users. It includes features that allow us to create multiple environments and even encrypt values. So, for this project we&rsquo;ll use the newer library to take advantage of some of those features.</p></div></div><p>To begin, let&rsquo;s install <code>dotenvx</code> using <code>npm</code>:</p><div class=tab-panel data-tab-group=3072224a694f80ab69d3e45aa94bb8d1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3072224a694f80ab69d3e45aa94bb8d1","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install @dotenvx/dotenvx</span></span></code></pre></div></div></div></div></div><p>Next, we&rsquo;ll need to import that library as early as possible in our application, since we want to make sure that the environment is properly loaded before any other configuration files are referenced, since they may require environment variables to work properly. In this case, we want to do that as the very first thing in <code>app.js</code>:</p><div class=tab-panel data-tab-group=cde460db193e81d2ea3d74f8488d16a7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cde460db193e81d2ea3d74f8488d16a7","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class="line hl"><span class=cl><span class=kr>import</span> <span class=s1>&#39;@dotenvx/dotenvx/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>compression</span> <span class=nx>from</span> <span class=s1>&#39;compression&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>helmet</span> <span class=nx>from</span> <span class=s1>&#39;helmet&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>requestLogger</span> <span class=nx>from</span> <span class=s1>&#39;./middlewares/request-logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we run our application, we should get a helpful message letting us know that our environment file is missing:</p><div class=tab-panel data-tab-group=cabfbbe71fe02055a0f05e48d1a47279><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cabfbbe71fe02055a0f05e48d1a47279","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; LOG_LEVEL=debug nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[MISSING_ENV_FILE] missing .env file (/workspaces/example-project/server/.env)
[MISSING_ENV_FILE] https://github.com/dotenvx/dotenvx/issues/484
[dotenvx@1.34.0] injecting env (0)
[2025-01-25 08:15:56.135 PM] info:      Listening on port 3000</code></pre></div></div></div></div></div><p>This is one of the many benefits that comes from using the newer <code>dotenvx</code> library - it will helpfully remind us when we are running without an environment file, just in case we forgot to create one.</p><p>So, now let&rsquo;s create the <code>.env</code> file in the <code>server</code> folder of our application, and add an environment variable to that file:</p><div class=tab-panel data-tab-group=141b911b9996e174c34180dfaaf6aafd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("141b911b9996e174c34180dfaaf6aafd","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>error</span></span></code></pre></div></div></div></div></div><p>This should set the logging level of our application to <strong>error</strong>, meaning that only errors will be logged to the terminal. So, let&rsquo;s run our application and see what it does:</p><div class=tab-panel data-tab-group=7b94a6d1a6b9d0e70ca9dfeebfea1af6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7b94a6d1a6b9d0e70ca9dfeebfea1af6","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>However, when we do, we notice that we are still getting <strong>http</strong> logging in the output:</p><div class=tab-panel data-tab-group=3d6457c2bbfbb37e714ba47c7b9c914a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3d6457c2bbfbb37e714ba47c7b9c914a","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; LOG_LEVEL=debug nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[dotenvx@1.34.0] injecting env (0) from .env
[2025-01-25 08:20:17.438 PM] info:      Listening on port 3000
[2025-01-25 08:23:56.896 PM] http:      GET / 304 3.405 ms -</code></pre></div></div></div></div></div><p>This is because we are already setting the <code>LOG_LEVEL</code> environment variable directly in our <code>package.json</code> file:</p><div class=tab-panel data-tab-group=642f316cdc1c9c7b655ba8c015487b02><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("642f316cdc1c9c7b655ba8c015487b02","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;module&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=debug nodemon ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>This is actually a great feature! The <code>dotenvx</code> library will not override any existing environment variables - so, if the environment is already configured, or we want to override anything that may be present in our <code>.env</code> file, we can just set it in the environment before running our application, and those values will take precedence!</p><p>For now, let&rsquo;s go ahead and remove that variable from the <code>dev</code> script in our <code>package.json</code> file:</p><div class=tab-panel data-tab-group=1295a5cb0d5d6f7f9ebf2b0056f35bfb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1295a5cb0d5d6f7f9ebf2b0056f35bfb","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;module&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;nodemon ./bin/www&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Now, when we run our program, we should not see any logging output (unless we can somehow cause the server to raise an error, which is unlikely right now):</p><div class=tab-panel data-tab-group=e1e6109e370c9a2d59c0d37218dff80b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e1e6109e370c9a2d59c0d37218dff80b","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[dotenvx@1.34.0] injecting env (1) from .env</code></pre></div></div></div></div></div><p>Finally, let&rsquo;s go ahead and set the value in our <code>.env</code> file back to the <code>debug</code> setting:</p><div class=tab-panel data-tab-group=2f9642ef95c87cb3484b7260bfab3b8b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2f9642ef95c87cb3484b7260bfab3b8b","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug</span></span></code></pre></div></div></div></div></div><p>Now, when we run our application, we can see that it is following that configuration:</p><div class=tab-panel data-tab-group=ea61dd82d26d8e62a0b986c1c46fbadc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ea61dd82d26d8e62a0b986c1c46fbadc","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[dotenvx@1.34.0] injecting env (1) from .env
[2025-01-25 08:28:54.587 PM] info:      Listening on port 3000
[2025-01-25 08:28:58.625 PM] http:      GET / 200 3.475 ms - -</code></pre></div></div></div></div></div><p>Great! We now have a powerful way to configure our application using a <code>.env</code> file.</p><h2 id=other-environment-variables>Other Environment Variables</h2><p>Right now, our program only uses one other environment variable, which can be found in the <code>bin/www</code> file:</p><div class=tab-panel data-tab-group=b20780a2c1e4f50ab18ec6fa6fd0c530><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b20780a2c1e4f50ab18ec6fa6fd0c530","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=ch>#!/usr/bin/env node
</span></span></span><span class=line><span class=cl><span class=ch></span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s1>&#39;../app.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;../configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get port from environment and store in Express.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kd>var</span> <span class=nx>port</span> <span class=o>=</span> <span class=nx>normalizePort</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>||</span> <span class=s1>&#39;3000&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;port&#39;</span><span class=p>,</span> <span class=nx>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>The code <code>process.env.PORT || '3000'</code> is a commonly used shorthand in JavaScript to check for the presence of a variable. Basically, if <code>process.env.PORT</code> is set, then that code will resolve to that value. If not, then the or operator <code>||</code> will use the second option, which is the value <code>'3000'</code> that is just hard-coded into our application.</p><p>So, we can set that value explicitly in our <code>.env</code> file:</p><div class=tab-panel data-tab-group=5989a883179dbeeaa0aa38677f96b67f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5989a883179dbeeaa0aa38677f96b67f","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span></span></span></code></pre></div></div></div></div></div><p>In general, it is always good practice to explicitly list all configurable values in the <code>.env</code> file when developing an application, since it helps us keep track of them.</p><p>However, each value should also have a <strong>logical default value</strong> if no configuration is provided. Ideally, our application should be able to run correctly with minimal configuration, or it should at least provide clear errors to the user when a configuration value is not provided. For example, we can look back at the <code>level()</code> function in <code>configs/logger.js</code> to see that it will set the logging level to <code>http</code> if it cannot find an appropriate <code>LOG_LEVEL</code> environment variable.</p><h2 id=environment-variable-security>Environment Variable Security</h2><p>Storing the configuration for our application in a <code>.env</code> file is a great option, and it is even included as item 3 of the <a href=https://12factor.net/config rel=external target=_blank>twelve-factor methodology</a> for developing modern web applications.</p><p>Unfortunately, this can present one <strong>major security flaw</strong> - often, the information stored in the <code>.env</code> file is very sensitive, since it may include database passwords, encryption keys, and more. So, we want to make absolutely sure that our <code>.env</code> file is never committed to git or GitHub, and it should never be shared between developers.</p><p>We can enforce this by ensuring that our <code>.gitignore</code> file inside of our <code>server</code> folder includes a line that prevents us from accidentally committing the <code>.env</code> file. Thankfully, both the <code>.gitignore</code> produced by the Express application generator, as well as the one in the GitHub <a href=https://github.com/github/gitignore/blob/main/Node.gitignore rel=external target=_blank>gitignore</a> repository both already include that line.</p><p>Instead, it is common practice to create a second file called <code>.env.example</code> (or similar) that contains a list of all configurable environment variables, along with safe default values for each. So, for this application, we might create a <code>.env.example</code> file that looks like this:</p><div class=tab-panel data-tab-group=1618ca006bd38951cd3c27a33207620d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=envexample class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1618ca006bd38951cd3c27a33207620d","envexample")'>
<span class=tab-nav-text>.env.example</span></button></div><div class=tab-content-container><div data-tab-item=envexample class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>http
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span></span></span></code></pre></div></div></div></div></div><p>This file can safely be committed to git and stored in GitHub. When a new developer or user clones our project, they can easily copy the <code>.env.example</code> file to <code>.env</code> and update it to match their desired configuration.</p><p>As we continue to add environment variables to our <code>.env</code> file, we should also make sure the <code>.env.example</code> file is kept up to date.</p><p>This is a good point to <strong>commit and push</strong> our work, but be extra sure that our <code>.env</code> file <strong>DOES NOT</strong> get committed to git!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=openapi-documentation>OpenAPI Documentation</h1><a href="https://www.youtube.com/watch?v=MW-NA86npRw">YouTube Video</a><h2 id=openapi-documentation>OpenAPI Documentation</h2><p>There are many different ways to document the features of a RESTful web application. One of the most commonly used methods is the <a href=https://www.openapis.org/ rel=external target=_blank>OpenAPI Specification (OAS)</a>. OpenAPI was originally based on the Swagger specification, so we&rsquo;ll sometimes still see references to the name Swagger in online resources.</p><p>At its core, the OpenAPI Specification defines a way to describe the functionality of a RESTful web application in a simple document format, typically structured as a JSON or YAML file. For example, we can find an example YAML file for a <a href=https://github.com/swagger-api/swagger-petstore/blob/master/src/main/resources/openapi.yaml rel=external target=_blank>Petstore API</a> that is commonly cited as an example project for understanding the OpenAPI Specification format.</p><p>That file can then be parsed and rendered as an interactive documentation website for developers and users of the API itself. So, we can find a current version of the <a href=https://petstore3.swagger.io/ rel=external target=_blank>Petstore API Documentation</a> online and compare it to the YAML document to see how it works.</p><p>For more information on the OpenAPI Specification, consult their <a href=https://learn.openapis.org/ rel=external target=_blank>Getting Started</a> page.</p><h2 id=configuration-openapi>Configuration OpenAPI</h2><p>For our project, we are going to take advantage of two helpful libraries to automatically generate and serve OpenAPI documentation for our code using documentation comments:</p><ul><li><a href=https://www.npmjs.com/package/swagger-jsdoc rel=external target=_blank>swagger-jsdoc</a> - generates OpenAPI Specification based on JSDoc comments.</li><li><a href=https://www.npmjs.com/package/swagger-ui-express rel=external target=_blank>swagger-ui-express</a> - serves an OpenAPI Documentation page based on the specification generated by other tools.</li></ul><p>First, let&rsquo;s install both of those libraries into our project:</p><div class=tab-panel data-tab-group=37f65c76293f2c0813dc53e6a347af38><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("37f65c76293f2c0813dc53e6a347af38","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install swagger-jsdoc swagger-ui-express</span></span></code></pre></div></div></div></div></div><p>Next, we should create a configuration file for the <code>swagger-jsdoc</code> library that contains some basic information about our API. We can store that in the <code>configs/openapi.js</code> file with the following content:</p><div class=tab-panel data-tab-group=d9be66935efe3260f545c13196ae4f83><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsopenapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d9be66935efe3260f545c13196ae4f83","configsopenapijs")'>
<span class=tab-nav-text>configs/openapi.js</span></button></div><div class=tab-content-container><div data-tab-item=configsopenapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>swaggerJSDoc</span> <span class=nx>from</span> <span class=s1>&#39;swagger-jsdoc&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>url</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OPENAPI_HOST</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OPENAPI_HOST</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>port</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>||</span> <span class=s1>&#39;3000&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=sb>`http://localhost:</span><span class=si>${</span><span class=nx>port</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>definition</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>openapi</span><span class=o>:</span> <span class=s1>&#39;3.1.0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>info</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>title</span><span class=o>:</span> <span class=s1>&#39;Example Project&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s1>&#39;0.0.1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>description</span><span class=o>:</span> <span class=s1>&#39;Example Project&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>servers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>url</span><span class=o>:</span> <span class=nx>url</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>apis</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;./routes/*.js&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>swaggerJSDoc</span><span class=p>(</span><span class=nx>options</span><span class=p>)</span></span></span></code></pre></div></div></div></div></div><p>Let&rsquo;s look at a few items in this file to see what it does:</p><ul><li><code>url()</code> - this function checks for the <code>OPENAPI_HOST</code> environment variable. If that is set, then it will use that value. Otherwise, it uses a sensible default value of <code>http://localhost:3000</code> or whatever port is set in the environment.</li><li><code>options</code> - the <code>options</code> object is used to configure the <code>swagger-jsdoc</code> library. We can read more about how to configure that library in the <a href=https://www.npmjs.com/package/swagger-jsdoc rel=external target=_blank>documentation</a>. At a minimum, it provides some basic information about the API, as well as the URL where the API is located, and a list of source files to read information from. For now, we only want to read from the routes stored in the <code>routes</code> folder, so we include that path along with a wildcard filename.</li></ul><p>We should also take a minute to add the <code>OPENAPI_HOST</code> environment variable to our <code>.env</code> and <code>.env.example</code> files. If we are running our application locally, we can figure out what this value should be pretty easily (usually it will look similar to <code>http://localhost:3000</code> or similar). However, when we are running in GitHub Codespaces, our URL changes each time. Thankfully, we can find all the information we need in the environment variables provided by GitHub Codespaces (see the previous page for a full list).</p><p>So, the item we need to add to our <code>.env</code> file will look something like this:</p><div class=tab-panel data-tab-group=d5901685209eae6a7b0613c70f474735><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d5901685209eae6a7b0613c70f474735","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>https://<span class=nv>$CODESPACE_NAME</span>-<span class=nv>$PORT</span>.<span class=nv>$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span></span></span></code></pre></div></div></div></div></div><p>This is one of the key features of the <code>dotenvx</code> library we are using - it will <strong>expand</strong> environment variables based on the existing environment. So, we are using the values stored in the <code>CODESPACE_NAME</code>, <code>PORT</code>, and <code>GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</code> environment variables to construct the appropriate URL for our application.</p><p>In our <code>.env.example</code> file, we might want to make a note of this in a comment, just to be helpful for future developers. Comments in the <code>.env</code> file format are prefixed with hashes <code>#</code>.</p><div class=tab-panel data-tab-group=32a3dde02950b0a60ab53b7f03fa3981><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=envexample class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("32a3dde02950b0a60ab53b7f03fa3981","envexample")'>
<span class=tab-nav-text>.env.example</span></button></div><div class=tab-content-container><div data-tab-item=envexample class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>http://localhost:3000
</span></span><span class=line><span class=cl><span class=c1># For GitHub Codespaces</span>
</span></span><span class=line><span class=cl><span class=c1># OPENAPI_HOST=https://$CODESPACE_NAME-$PORT.$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span></span></span></code></pre></div></div></div></div></div><p>Once that configuration is created, we can add it to our <code>app.js</code> file, along with a few lines to actually make the documentation visible:</p><div class=tab-panel data-tab-group=ad5449f5b59b62ce3e9d1a538ee3fded><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ad5449f5b59b62ce3e9d1a538ee3fded","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=s1>&#39;@dotenvx/dotenvx/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>compression</span> <span class=nx>from</span> <span class=s1>&#39;compression&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>helmet</span> <span class=nx>from</span> <span class=s1>&#39;helmet&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>requestLogger</span> <span class=nx>from</span> <span class=s1>&#39;./middlewares/request-logger.js&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;./configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>openapi</span> <span class=nx>from</span> <span class=s1>&#39;./configs/openapi.js&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>swaggerUi</span> <span class=nx>from</span> <span class=s1>&#39;swagger-ui-express&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/index.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/users.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>helmet</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>compression</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s1>&#39;public&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/users&#39;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OPENAPI_VISIBLE</span> <span class=o>===</span> <span class=s1>&#39;true&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;OpenAPI documentation visible!&#39;</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/docs&#39;</span><span class=p>,</span> <span class=nx>swaggerUi</span><span class=p>.</span><span class=nx>serve</span><span class=p>,</span> <span class=nx>swaggerUi</span><span class=p>.</span><span class=nx>setup</span><span class=p>(</span><span class=nx>openapi</span><span class=p>,</span> <span class=p>{</span><span class=nx>explorer</span><span class=o>:</span> <span class=kc>true</span><span class=p>}));</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>app</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Notice that we are using the <code>OPENAPI_VISIBLE</code> environment variable to control whether the documentation is visible or not, and we print a warning to the terminal if it is enabled. This is because it is often considered very insecure to make the details of our API visible to users unless that is the explicit intent, so it is better to be cautious.</p><p>Of course, to make the documentation appear, we&rsquo;ll have to set the <code>OPENAPI_VISIBLE</code> value to <code>true</code> in our <code>.env</code> file, and also add a default entry to the <code>.env.example</code> file as well:</p><div class=tab-panel data-tab-group=6089173e2283ae9e9ccd8b2e114bce12><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6089173e2283ae9e9ccd8b2e114bce12","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>https://<span class=nv>$CODESPACE_NAME</span>-<span class=nv>$PORT</span>.<span class=nv>$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span>true</span></span></code></pre></div></div></div></div></div><p>Now, let&rsquo;s run our application and see what happens:</p><div class=tab-panel data-tab-group=c0350559ff384ac0f3e263e5ee20b6a6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c0350559ff384ac0f3e263e5ee20b6a6","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>We should see the following output when our application initializes:</p><div class=tab-panel data-tab-group=511c6b4ea905a37a7517792fd7e1fdb7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("511c6b4ea905a37a7517792fd7e1fdb7","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[dotenvx@1.34.0] injecting env (4) from .env
[2025-01-25 09:10:37.646 PM] warn:      OpenAPI documentation visible!
[2025-01-25 09:10:37.649 PM] info:      Listening on port 3000</code></pre></div></div></div></div></div><p>Now, let&rsquo;s load our application in a web browser, and go to the <code>/docs</code> path. We should see our OpenAPI Documentation website!</p><p><a href=#R-image-32a313e22f062168da8a940900328196 class=lightbox-link><img alt="OpenAPI Documentation Example" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/openapi_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-32a313e22f062168da8a940900328196><img alt="OpenAPI Documentation Example" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/openapi_1.png></a></p><p>Notice that the <strong>Servers</strong> URL matches the URL at the top of the page! That means our complex <code>OPENAPI_HOST</code> environment variable is working correctly.</p><p>However, we notice that our server does not have any operations defined yet, so we need to add those before we can really make use of this documentation website.</p><h2 id=documenting-routes>Documenting Routes</h2><p>To document our routes using the OpenAPI Specification, we can add a simple JSDoc comment above each route function with some basic information, prefixed by the <code>@swagger</code> tag.</p><div class=tab-panel data-tab-group=be82817114cf276e80b9871254b7c6fd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesindexjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("be82817114cf276e80b9871254b7c6fd","routesindexjs")'>
<span class=tab-nav-text>routes/index.js</span></button></div><div class=tab-content-container><div data-tab-item=routesindexjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class="line hl"><span class=cl><span class=cm>/**
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @swagger
</span></span></span><span class="line hl"><span class=cl><span class=cm> * tags:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *   name: index
</span></span></span><span class="line hl"><span class=cl><span class=cm> *   description: Index Routes
</span></span></span><span class="line hl"><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=cm>/**
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @swagger
</span></span></span><span class="line hl"><span class=cl><span class=cm> * /:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *   get: 
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     summary: index page
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     description: Gets the index page for the application
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     tags: [index]
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     responses:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *       200: 
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         description: success
</span></span></span><span class="line hl"><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>render</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>title</span><span class=o>:</span> <span class=s1>&#39;Express&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=d605e75b6701587aa21d48accaecf3be><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesusersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d605e75b6701587aa21d48accaecf3be","routesusersjs")'>
<span class=tab-nav-text>routes/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesusersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class="line hl"><span class=cl><span class=cm>/**
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @swagger
</span></span></span><span class="line hl"><span class=cl><span class=cm> * tags:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *   name: users
</span></span></span><span class="line hl"><span class=cl><span class=cm> *   description: Users Routes
</span></span></span><span class="line hl"><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=cm>/**
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @swagger
</span></span></span><span class="line hl"><span class=cl><span class=cm> * /users:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *   get: 
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     summary: users list page
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     description: Gets the list of all users in the application
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     responses:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *       200: 
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         description: a resource            
</span></span></span><span class="line hl"><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;respond with a resource&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Now, when we run our application and view the documentation, we see two operations:</p><p><a href=#R-image-8737c8bdd5fb64f99de6d3df35af8da9 class=lightbox-link><img alt="OpenAPI Documentation With Operations" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/openapi_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8737c8bdd5fb64f99de6d3df35af8da9><img alt="OpenAPI Documentation With Operations" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/openapi_2.png></a></p><p>We can expand the operation to learn more about it, and even test it on a running server if our URL is set correctly:</p><p><a href=#R-image-be0103a145fbb11fee44cf087019d82b class=lightbox-link><img alt="OpenAPI Documentation Operation Example" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/01/openapi_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-be0103a145fbb11fee44cf087019d82b><img alt="OpenAPI Documentation Operation Example" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/01/openapi_3.png></a></p><p>As we develop our RESTful API, this documentation tool will be a very powerful way for us to understand our own API&rsquo;s design, and it will help us communicate easily with other developers who wish to use our API as well.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><h2 id=references>References</h2><ul><li><a href=https://dev.to/qbentil/swagger-express-documenting-your-nodejs-rest-api-4lj7 rel=external target=_blank>Swagger & Express: Documenting Your Node.js REST API</a></li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=jsdoc-documentation>JSDoc Documentation</h1><a href="https://www.youtube.com/watch?v=CfiI16ysn-Q">YouTube Video</a><h2 id=jsdoc-documentation>JSDoc Documentation</h2><p>It is also considered good practice to add additional documentation to all of the source files we create for this application. One common standard is <a href=https://jsdoc.app/ rel=external target=_blank>JSDoc</a>, which is somewhat similar to the JavaDoc comments we may have seen in previous courses. JSDoc can be used to generate documentation, but we won&rsquo;t be using that directly in this project. However, we will be loosely following the JSDoc documentation standard to give our code comments some consistency. We can find a full list of the tags in the <a href=https://jsdoc.app/ rel=external target=_blank>JSDoc Documentation</a>.</p><p>For example, we can add a file header to the top of each source file with a few important tags. We may also want to organize our import statements and add notes for each group. We can also document individual functions, such as the <code>normalizePort</code> function in the <code>bin/www</code> file. Here&rsquo;s a fully documented and commented version of that file:</p><div class=tab-panel data-tab-group=4a8545f1fad0ea33f366827e5f2250b1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4a8545f1fad0ea33f366827e5f2250b1","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Executable entrypoint for the web application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s1>&#39;../app.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logging configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;../configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get port from environment and store in Express
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>port</span> <span class=o>=</span> <span class=nx>normalizePort</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>||</span> <span class=s1>&#39;3000&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;port&#39;</span><span class=p>,</span> <span class=nx>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create HTTP server
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Listen on provided port, on all network interfaces
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Attach event handlers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>server</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=nx>onError</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>server</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;listening&#39;</span><span class=p>,</span> <span class=nx>onListening</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Normalize a port into a number, string, or false.
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {(string|number)} val - a value representing a port to connect to
</span></span></span><span class=line><span class=cl><span class=cm> * @returns {(number|string|boolean)} the port or `false`
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>normalizePort</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>port</span> <span class=o>=</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nx>val</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>isNaN</span><span class=p>(</span><span class=nx>port</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// named pipe
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>port</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// port number
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nx>port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Event listener for HTTP server &#34;error&#34; event.
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {error} error - the HTTP error event
</span></span></span><span class=line><span class=cl><span class=cm> * @throws error if the error cannot be determined
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>onError</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>syscall</span> <span class=o>!==</span> <span class=s1>&#39;listen&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>throw</span> <span class=nx>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>bind</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>port</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=s1>&#39;Pipe &#39;</span> <span class=o>+</span> <span class=nx>port</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=s1>&#39;Port &#39;</span> <span class=o>+</span> <span class=nx>port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// handle specific listen errors with friendly messages
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>switch</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>code</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s1>&#39;EACCES&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=nx>bind</span> <span class=o>+</span> <span class=s1>&#39; requires elevated privileges&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s1>&#39;EADDRINUSE&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=nx>bind</span> <span class=o>+</span> <span class=s1>&#39; is already in use&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=nx>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Event listener for HTTP server &#34;listening&#34; event.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>onListening</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>addr</span> <span class=o>=</span> <span class=nx>server</span><span class=p>.</span><span class=nx>address</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>var</span> <span class=nx>bind</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>addr</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=s1>&#39;pipe &#39;</span> <span class=o>+</span> <span class=nx>addr</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=s1>&#39;port &#39;</span> <span class=o>+</span> <span class=nx>addr</span><span class=p>.</span><span class=nx>port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>logger</span><span class=p>.</span><span class=nx>info</span><span class=p>(</span><span class=s1>&#39;Listening on &#39;</span> <span class=o>+</span> <span class=nx>bind</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Here is another example of a cleaned up, reorganized, and documented version of the <code>app.js</code> file. Notice that it also includes an <code>@export</code> tag at the top to denote the type of object that is exported from this file.</p><div class=tab-panel data-tab-group=c3eaa172241c63c6a3a90e3e8ebfaafc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c3eaa172241c63c6a3a90e3e8ebfaafc","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Main Express application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports app Express application
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load environment (must be first)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s1>&#39;@dotenvx/dotenvx/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>compression</span> <span class=nx>from</span> <span class=s1>&#39;compression&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>helmet</span> <span class=nx>from</span> <span class=s1>&#39;helmet&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>swaggerUi</span> <span class=nx>from</span> <span class=s1>&#39;swagger-ui-express&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;./configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>openapi</span> <span class=nx>from</span> <span class=s1>&#39;./configs/openapi.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import middlewares
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>requestLogger</span> <span class=nx>from</span> <span class=s1>&#39;./middlewares/request-logger.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/index.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s1>&#39;./routes/users.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>helmet</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>compression</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span> 
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use middlewares
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use static files
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s1>&#39;public&#39;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/users&#39;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use SwaggerJSDoc router if enabled
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>OPENAPI_VISIBLE</span> <span class=o>===</span> <span class=s1>&#39;true&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;OpenAPI documentation visible!&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s1>&#39;/docs&#39;</span><span class=p>,</span> <span class=nx>swaggerUi</span><span class=p>.</span><span class=nx>serve</span><span class=p>,</span> <span class=nx>swaggerUi</span><span class=p>.</span><span class=nx>setup</span><span class=p>(</span><span class=nx>openapi</span><span class=p>,</span> <span class=p>{</span><span class=nx>explorer</span><span class=o>:</span> <span class=kc>true</span><span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>app</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Finally, here is a fully documented <code>routes/index.js</code> file, showing how routes can be documented both with JSDoc tags as well as OpenAPI Specification items:</p><div class=tab-panel data-tab-group=5985475baaa172d5e305543d9cd84bf0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesindexjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5985475baaa172d5e305543d9cd84bf0","routesindexjs")'>
<span class=tab-nav-text>routes/index.js</span></button></div><div class=tab-content-container><div data-tab-item=routesindexjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Index router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: index
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Index Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the index page for the application
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /:
</span></span></span><span class=line><span class=cl><span class=cm> *   get: 
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: index page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the index page for the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [index]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200: 
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>render</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>title</span><span class=o>:</span> <span class=s1>&#39;Express&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Now is a great time to document all of the JavaScript files in our application following the <a href=https://jsdoc.app/ rel=external target=_blank>JSDoc</a> standard.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=linting--formatting>Linting & Formatting</h1><a href="https://www.youtube.com/watch?v=1AIUiGW2FNs">YouTube Video</a><h2 id=linting>Linting</h2><p>Finally, let&rsquo;s look at two other tools that will help us write clean and maintainable JavaScript code. The first tool is <a href=https://www.npmjs.com/package/eslint rel=external target=_blank>eslint</a>, which is a <a href=https://en.wikipedia.org/wiki/Lint_(software) rel=external target=_blank>linting</a> tool to find bugs and issues in JavaScript code by performing some static analysis on it. This helps us avoid any major issues in our code that can be easily detected just by looking at the overall style and structure of our code.</p><p>To begin, we can install <code>eslint</code> following the recommended process in their documentation:</p><div class=tab-panel data-tab-group=05b0ce86a56b42e9ba2ed0e5a5519ee1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("05b0ce86a56b42e9ba2ed0e5a5519ee1","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm init @eslint/config@latest</span></span></code></pre></div></div></div></div></div><p>It will install the package and ask several configuration questions along the way. We can follow along with the answers shown in the output below:</p><div class=tab-panel data-tab-group=dec714dc109d5e968ee77abbd9b9aed9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("dec714dc109d5e968ee77abbd9b9aed9","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>Need to install the following packages:
@eslint/create-config@1.4.0
Ok to proceed? (y) y

@eslint/create-config: v1.4.0

âœ” How would you like to use ESLint? Â· problems
âœ” What type of modules does your project use? Â· esm
âœ” Which framework does your project use? Â· none
âœ” Does your project use TypeScript? Â· javascript
âœ” Where does your code run? Â· node
The config that you&#39;ve selected requires the following dependencies:

eslint, globals, @eslint/js
âœ” Would you like to install them now? Â· No / Yes
âœ” Which package manager do you want to use? Â· npm
â˜•ï¸Installing...

added 70 packages, and audited 273 packages in 5s

52 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities
Successfully created /workspaces/example-project/server/eslint.config.js file.</code></pre></div></div></div></div></div><p>Once it is installed, we can run <code>eslint</code> using the following command:</p><div class=tab-panel data-tab-group=71d2d51b4dcf3e5467b07f2edafc9ef9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("71d2d51b4dcf3e5467b07f2edafc9ef9","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npx eslint --fix .</span></span></code></pre></div></div></div></div></div><p>When we do, we&rsquo;ll probably get a couple of errors:</p><div class=tab-panel data-tab-group=20ab0ded27b70d1dce4e6a36f4c7326a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("20ab0ded27b70d1dce4e6a36f4c7326a","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>/workspaces/example-project/server/routes/index.js
  35:36  error  &#39;next&#39; is defined but never used  no-unused-vars

/workspaces/example-project/server/routes/users.js
  35:36  error  &#39;next&#39; is defined but never used  no-unused-vars

âœ– 2 problems (2 errors, 0 warnings)</code></pre></div></div></div></div></div><p>In both of our routes files, we have included the <code>next</code> parameter, but it is unused. We could remove it, but it is often considered good practice to include that parameter in case we need to explicitly use it. So, in our <code>eslint.config.js</code> we can add an option to ignore that parameter (pay careful attention to the formatting; for some reason the file by default does not have much spacing between the curly braces):</p><div class=tab-panel data-tab-group=679856d0377e76e7bfe0f32aa2bb4ac8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=eslintconfigjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("679856d0377e76e7bfe0f32aa2bb4ac8","eslintconfigjs")'>
<span class=tab-nav-text>eslint.config.js</span></button></div><div class=tab-content-container><div data-tab-item=eslintconfigjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>globals</span> <span class=nx>from</span> <span class=s2>&#34;globals&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>pluginJs</span> <span class=nx>from</span> <span class=s2>&#34;@eslint/js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** @type {import(&#39;eslint&#39;).Linter.Config[]} */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>languageOptions</span><span class=o>:</span> <span class=p>{</span> <span class=nx>globals</span><span class=o>:</span> <span class=nx>globals</span><span class=p>.</span><span class=nx>node</span> <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>rules</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=s1>&#39;no-unused-vars&#39;</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class="line hl"><span class=cl>        <span class=s1>&#39;error&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>argsIgnorePattern</span><span class=o>:</span> <span class=s1>&#39;next&#39;</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>]</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>pluginJs</span><span class=p>.</span><span class=nx>configs</span><span class=p>.</span><span class=nx>recommended</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>];</span></span></span></code></pre></div></div></div></div></div><p>Now, when we run that command, we should not get any output!</p><div class=tab-panel data-tab-group=8f74eb4fa5e34355d7d0da7bb08e5d3c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8f74eb4fa5e34355d7d0da7bb08e5d3c","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npx eslint --fix .</span></span></code></pre></div></div></div></div></div><p>To make this even easier, let&rsquo;s add a new script to the <code>scripts</code> section of our <code>package.json</code> file for this tool:</p><div class=tab-panel data-tab-group=ebf391b031e82ed426dc011e106fd646><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ebf391b031e82ed426dc011e106fd646","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=debug nodemon ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;lint&#34;</span><span class=p>:</span> <span class=s2>&#34;npx eslint --fix .&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Now we can just run this command to check our project for errors:</p><div class=tab-panel data-tab-group=0043601cf7a6a481919be82508ac338e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0043601cf7a6a481919be82508ac338e","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run lint</span></span></code></pre></div></div></div></div></div><h2 id=formatting>Formatting</h2><p>Another commonly used tool for JavaScript developers is <a href=https://www.npmjs.com/package/prettier rel=external target=_blank>prettier</a>. Prettier will reformat our JavaScript code to match a defined coding style, making it much easier to read and maintain.</p><p>First, let&rsquo;s install <code>prettier</code> using <code>npm</code> as a development dependency:</p><div class=tab-panel data-tab-group=65191f10165955cd8cb10b62dfe4c0d4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("65191f10165955cd8cb10b62dfe4c0d4","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install prettier --save-dev</span></span></code></pre></div></div></div></div></div><p>We also need to create a <code>.prettierrc</code> configuration file that just contains an empty JavaScript object for now:</p><div class=tab-panel data-tab-group=836fab86ac94ba8fbb3f8dc89600166c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=prettierrc class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("836fab86ac94ba8fbb3f8dc89600166c","prettierrc")'>
<span class=tab-nav-text>.prettierrc</span></button></div><div class=tab-content-container><div data-tab-item=prettierrc class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=p>{}</span></span></span></code></pre></div></div></div></div></div><p>There are many options that can be placed in that configuration file - see the <a href=https://prettier.io/docs/en/options rel=external target=_blank>Prettier Documentation</a> for details. For now, we&rsquo;ll just leave it blank.</p><p>We can now run the <code>prettier</code> command on our code:</p><div class=tab-panel data-tab-group=38f20841277cefeeca3689332990fc20><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("38f20841277cefeeca3689332990fc20","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npx prettier . --write</span></span></code></pre></div></div></div></div></div><p>When we do, we&rsquo;ll see output listing all of the files that have been changed:</p><div class=tab-panel data-tab-group=d3ee94f4d68f1b96913e28845f98cc79><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d3ee94f4d68f1b96913e28845f98cc79","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>.prettierrc 34ms
app.js 34ms
configs/logger.js 19ms
configs/openapi.js 7ms
eslint.config.js 5ms
middlewares/request-logger.js 5ms
package-lock.json 111ms (unchanged)
package.json 2ms (unchanged)
public/index.html 29ms
routes/index.js 4ms
routes/users.js 3ms</code></pre></div></div></div></div></div><p>Notice that nearly all of the files have been updated in some way. Many times it simply aligns code and removes extra spaces, but other times it will rewrite long lines.</p><p>Just like with <code>eslint</code>, let&rsquo;s add a new script to <code>package.json</code> to make this process simpler as well:</p><div class=tab-panel data-tab-group=eb33870db98eee04725c97e679bac4c2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("eb33870db98eee04725c97e679bac4c2","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=debug nodemon ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;lint&#34;</span><span class=p>:</span> <span class=s2>&#34;npx eslint --fix .&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;format&#34;</span><span class=p>:</span> <span class=s2>&#34;npx prettier . --write&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>With that script in place, we can clean up our code anytime using this command:</p><div class=tab-panel data-tab-group=a42c0cdd2b43e3019941b2377708189e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a42c0cdd2b43e3019941b2377708189e","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run format</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Best Practice</div><div class=box-content><p>Now that we have installed both <code>eslint</code> and <code>prettier</code>, it is always a good practice to run both tools before committing any code to git and pushing to GitHub. This ensures that your codebase is always clean, well formatted, and free of errors or bugs that could be easily spotted by these tools.</p></div></div><p>This is a good point to <strong>commit and push</strong> our work!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=summary>Summary</h1><a href="https://www.youtube.com/watch?v=1WhAMeX0Seo">YouTube Video</a><h2 id=summary>Summary</h2><p>In this example project, we created an Express application with the following features:</p><ol><li>GitHub Codespaces</li><li>A sample Express application</li><li>Updated to ES Modules</li><li>Application logs with Winston and Morgan</li><li>Other useful libraries such as Compression and Helmet</li><li>A better development server using Nodemon</li><li>Environment variables through Dotenvx</li><li>Code documentation with JSDoc and OpenAPI comments</li><li>Linting and Formatting with ESLint and Prettier</li></ol><p>This example project makes a great basis for building robust RESTful web APIs and other Express applications.</p><p>As you work on projects built from this framework, we welcome any feedback or additions to be made. Feel free to submit requests to the course instructor for updates to this project.</p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=adding-a-database>Adding a Database</h1><p>This example project builds on the previous Express Starter Project by adding a database. A database is a powerful way to store and retrieve the data used by our web application.</p><p>To accomplish this, we&rsquo;ll learn about different libraries that interface between our application and a database. Once we&rsquo;ve installed a library, we&rsquo;ll discover how to use that library to create database tables, add initial data to those tables, and then easily access them within our application.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li>An SQLite database</li><li>The Sequelize ORM tool</li><li>The Umzug migration tool</li><li>A simple migration to create tables for Users and Roles</li><li>Seed data for those tables</li><li>Automated processes to migrate and seed the data on application startup</li><li>A simple route to query user information</li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Adding a Database</h1><article class=default><header class=headline></header><h1 id=sequelize>Sequelize</h1><a href="https://www.youtube.com/watch?v=RN46EzaMHy0">YouTube Video</a><h2 id=database-libraries>Database Libraries</h2><p>To begin, we must first select a library to use when interfacing with our database. There are many different types of libraries, and many different options to choose from.</p><ol><li><p>First and foremost, we can always just write raw SQL queries directly in our code. This is often very straightforward, but also can lead to very complex code and security issues. It also doesn&rsquo;t offer many of the more advanced features such as mapping database results to object types and automatically managing database schemas.</p></li><li><p>Another option is an SQL query library, such as <a href=https://knexjs.org/ rel=external target=_blank>Knex.js</a> or <a href=https://kysely.dev/ rel=external target=_blank>Kysely</a>. These libraries provide a helpful abstraction on top of SQL, allowing developers to build queries using syntax that is more comfortable and familiar to them. These libraries also have additional features do manage database schemas and sample data</p></li><li><p>The final option is an <a href=https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping rel=external target=_blank>Object-Relational Mapping (ORM)</a> library such as <a href=https://vincit.github.io/objection.js/ rel=external target=_blank>Objection</a> or <a href=https://sequelize.org/ rel=external target=_blank>Sequelize</a>. These libraries provide the most abstraction away from raw SQL, often allowing developers to store and retrieve data in a database as if it were stored in a list or dictionary data structure.</p></li></ol><p>For this project, we&rsquo;re going to use the <a href=https://sequelize.org/ rel=external target=_blank>Sequelize</a> ORM, coupled with the <a href=https://github.com/sequelize/umzug rel=external target=_blank>Umzug</a> migration tool. Both of these libraries are very commonly used in Node.js projects, and are actively maintained.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Database Engines</div><div class=box-content><p>We also have many choices for the database engine we want to use for our web projects. Some common options include <a href=https://www.postgresql.org/ rel=external target=_blank>PostgreSQL</a>, <a href=https://www.mysql.com/ rel=external target=_blank>MySQL</a>, <a href=https://mariadb.org/ rel=external target=_blank>MariaDB</a>, <a href=https://www.mongodb.com/ rel=external target=_blank>MongoDB</a>, <a href=https://firebase.google.com/ rel=external target=_blank>Firebase</a>, and many more.</p><p>For this project, we&rsquo;re going to use <a href=https://www.sqlite.org/ rel=external target=_blank>SQLite</a>. SQLite is unique because it is a database engine that only requires a single file, so it is self-contained and easy to work with. It doesn&rsquo;t require any external database servers or software, making it perfect for a small development project. In fact, SQLite may be one of the most <a href=https://www.sqlite.org/mostdeployed.html rel=external target=_blank>widely deployed software modules</a> in the whole world!</p><p>Naturally, if wer plan on growing a web application beyond a simple hobby project with a few users, we should spend some time researching a reliable database solution. Thankfully, the Sequelize ORM supports <a href=https://sequelize.org/docs/v6/other-topics/dialect-specific-things/ rel=external target=_blank>many different database engines</a> so it is easy to switch.</p></div></div><h2 id=installing-sequelize>Installing Sequelize</h2><p>To begin, let&rsquo;s install both <code>sequelize</code> as well as the <code>sqlite3</code> library using <code>npm</code>:</p><div class=tab-panel data-tab-group=db236ce7103f5b7d0624df2304c1612a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("db236ce7103f5b7d0624df2304c1612a","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install sqlite3 sequelize</span></span></code></pre></div></div></div></div></div><p>Once those libraries are installed, we can now configure <code>sequelize</code> following the information in the <a href=https://sequelize.org/docs/v6/getting-started/ rel=external target=_blank>Sequelize Documentation</a>. Let&rsquo;s create a new file <code>configs/database.js</code> to store our database configuration:</p><div class=tab-panel data-tab-group=be856352e4589aaa1074676e9e4fefa4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsdatabasejs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("be856352e4589aaa1074676e9e4fefa4","configsdatabasejs")'>
<span class=tab-nav-text>configs/database.js</span></button></div><div class=tab-content-container><div data-tab-item=configsdatabasejs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Sequelize database ORM
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports sequelize a Sequelize instance
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Sequelize</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Sequelize instance
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>sequelize</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Sequelize</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>dialect</span><span class=o>:</span> <span class=s1>&#39;sqlite&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>storage</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DATABASE_FILE</span> <span class=o>||</span> <span class=s2>&#34;:memory:&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>logging</span><span class=o>:</span> <span class=nx>logger</span><span class=p>.</span><span class=nx>sql</span><span class=p>.</span><span class=nx>bind</span><span class=p>(</span><span class=nx>logger</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>sequelize</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This file creates a very simple configuration for <code>sequelize</code> that uses the <code>sqlite</code> dialect. It uses the <code>DATABASE_FILE</code> environment variable to control the location of the database in the file system, and it also uses the <code>logger.sql</code> log level to log any data produced by the library. If a <code>DATABASE_FILE</code> environment variable is not provided, it will default to storing data in the SQLite <a href=https://www.sqlite.org/inmemorydb.html rel=external target=_blank>In-Memory Database</a>, which is great for testing and quick development.</p><p>Of course, a couple of those items don&rsquo;t actually exist yet, so let&rsquo;s add those in before we move on! First, we need to add a <code>DATABASE_FILE</code> environment variable to both our <code>.env</code> and <code>.env.example</code> files:</p><div class=tab-panel data-tab-group=d563b8b1c65b464c72aac60fd62e86dd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d563b8b1c65b464c72aac60fd62e86dd","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>https://<span class=nv>$CODESPACE_NAME</span>-<span class=nv>$PORT</span>.<span class=nv>$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class="line hl"><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>database.sqlite</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=a7bcaea18fc819cfdf8cd87d626e0634><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=envexample class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a7bcaea18fc819cfdf8cd87d626e0634","envexample")'>
<span class=tab-nav-text>.env.example</span></button></div><div class=tab-content-container><div data-tab-item=envexample class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>http://localhost:3000
</span></span><span class=line><span class=cl><span class=c1># For GitHub Codespaces</span>
</span></span><span class=line><span class=cl><span class=c1># OPENAPI_HOST=https://$CODESPACE_NAME-$PORT.$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class="line hl"><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>database.sqlite</span></span></code></pre></div></div></div></div></div><p>We also need to add a new logging level called <code>sql</code> to our logger configuration in <code>configs/logger.js</code>. This is a bit more involved, because it means we have to now list all intended logging levels explicitly. See the highlighted lines below for what has been changed, but the entire file is included for convenience:</p><div class=tab-panel data-tab-group=9422f88039329b80fa01c9700280de86><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsloggerjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9422f88039329b80fa01c9700280de86","configsloggerjs")'>
<span class=tab-nav-text>configs/logger.js</span></button></div><div class=tab-content-container><div data-tab-item=configsloggerjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Winston logger
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports logger a Winston logger object
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>winston</span> <span class=nx>from</span> <span class=s2>&#34;winston&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Extract format options
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=p>{</span> <span class=nx>combine</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=nx>printf</span><span class=p>,</span> <span class=nx>colorize</span><span class=p>,</span> <span class=nx>align</span><span class=p>,</span> <span class=nx>errors</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>format</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Determines the correct logging level based on the Node environment
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @returns {string} the desired log level
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>level</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;0&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;error&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;error&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;1&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;warn&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;warn&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;2&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;info&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;info&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;3&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;http&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;4&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;verbose&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;verbose&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;5&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;debug&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=s1>&#39;debug&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;6&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;sql&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=k>return</span> <span class=s1>&#39;sql&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;7&#39;</span> <span class=o>||</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>LOG_LEVEL</span> <span class=o>===</span> <span class=s1>&#39;silly&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=k>return</span> <span class=s1>&#39;silly&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Custom logging levels for the application
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>levels</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>error</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>warn</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>info</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>http</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>verbose</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>debug</span><span class=o>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>sql</span><span class=o>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>silly</span><span class=o>:</span> <span class=mi>7</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Custom colors
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>colors</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;red&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>warn</span><span class=o>:</span> <span class=s1>&#39;yellow&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>info</span><span class=o>:</span> <span class=s1>&#39;green&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>http</span><span class=o>:</span> <span class=s1>&#39;green&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>verbose</span><span class=o>:</span> <span class=s1>&#39;cyan&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>debug</span><span class=o>:</span> <span class=s1>&#39;blue&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>sql</span><span class=o>:</span> <span class=s1>&#39;gray&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>silly</span><span class=o>:</span> <span class=s1>&#39;magenta&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=nx>winston</span><span class=p>.</span><span class=nx>addColors</span><span class=p>(</span><span class=nx>colors</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Creates the Winston instance with the desired configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>logger</span> <span class=o>=</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>createLogger</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// call `level` function to get default log level
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>level</span><span class=o>:</span> <span class=nx>level</span><span class=p>(),</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>levels</span><span class=o>:</span> <span class=nx>levels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Format configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// See https://github.com/winstonjs/logform
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>format</span><span class=o>:</span> <span class=nx>combine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>colorize</span><span class=p>({</span> <span class=nx>all</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>errors</span><span class=p>({</span> <span class=nx>stack</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>timestamp</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;YYYY-MM-DD hh:mm:ss.SSS A&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>align</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>printf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nx>info</span><span class=p>)</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>        <span class=sb>`[</span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>timestamp</span><span class=si>}</span><span class=sb>] </span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>level</span><span class=si>}</span><span class=sb>: </span><span class=si>${</span><span class=nx>info</span><span class=p>.</span><span class=nx>stack</span> <span class=o>?</span> <span class=nx>info</span><span class=p>.</span><span class=nx>stack</span> <span class=o>:</span> <span class=nx>info</span><span class=p>.</span><span class=nx>message</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Output configuration
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>transports</span><span class=o>:</span> <span class=p>[</span><span class=k>new</span> <span class=nx>winston</span><span class=p>.</span><span class=nx>transports</span><span class=p>.</span><span class=nx>Console</span><span class=p>()],</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>logger</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>We have added a new <code>sql</code> logging level that is now part of our logging setup. One of the unique features of <code>sequelize</code> is that it will actually allow us to log all SQL queries run against our database, so we can enable and disable that level of logging by adjusting the <code>LOG_LEVEL</code> environment variable as desired.</p><p>There! We now have a working database configuration. Before we can make use of it, however, we need to add additional code to create and populate our database. So, we&rsquo;ll need to continue on in this tutorial before we can actually test our application.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=migrations>Migrations</h1><a href="https://www.youtube.com/watch?v=P-0Iuaj_BAE">YouTube Video</a><h2 id=umzug>Umzug</h2><p>Now that we have a database configured in our application, we need to create some way to actually populate that database with the tables and information our app requires. We could obviously do that manually, but that really makes it difficult (if not impossible) to automatically build, test, and deploy this application.</p><p>Thankfully, most database libraries also have a way to automate building the database structure. This is known as <a href=https://en.wikipedia.org/wiki/Schema_migration rel=external target=_blank>schema migration</a> or often just <strong>migration</strong>. We call it migration because it allows us to update the database schema along with new versions of the application, effectively <em>migrating</em> our data to new versions as we go.</p><p>The <code>sequelize</code> library recommends using another library, named <a href=https://github.com/sequelize/umzug rel=external target=_blank>Umzug</a>, as the preferred way to manage database migrations. It is actually completely framework agnostic, and would even work with ORMs other than Sequelize.</p><h2 id=setting-up-umzug>Setting up Umzug</h2><p>To begin, let&rsquo;s install <code>umzug</code> using <code>npm</code>:</p><div class=tab-panel data-tab-group=fd0f33efc461c0b55e4d1b8d458d16ef><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fd0f33efc461c0b55e4d1b8d458d16ef","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install umzug</span></span></code></pre></div></div></div></div></div><p>Next, we can create a configuration file to handle our migrations, named <code>configs/migrations.js</code>, with the following content as described in the <a href=https://github.com/sequelize/umzug rel=external target=_blank>Umzug Documentation</a>:</p><div class=tab-panel data-tab-group=6e8eb7af8846b3222bcfdb119324b0fd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsmigrationsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6e8eb7af8846b3222bcfdb119324b0fd","configsmigrationsjs")'>
<span class=tab-nav-text>configs/migrations.js</span></button></div><div class=tab-content-container><div data-tab-item=configsmigrationsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Umzug migration engine
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports umzug an Umzug instance
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Umzug</span><span class=p>,</span> <span class=nx>SequelizeStorage</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;umzug&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import database configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;./database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Umzug instance
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>umzug</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Umzug</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>migrations</span><span class=o>:</span> <span class=p>{</span><span class=nx>glob</span><span class=o>:</span> <span class=s1>&#39;migrations/*.js&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span><span class=o>:</span> <span class=nx>database</span><span class=p>.</span><span class=nx>getQueryInterface</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>storage</span><span class=o>:</span> <span class=k>new</span> <span class=nx>SequelizeStorage</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>sequelize</span><span class=o>:</span> <span class=nx>database</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>modelName</span><span class=o>:</span> <span class=s1>&#39;migrations&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=o>:</span> <span class=nx>logger</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>umzug</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Notice that this configuration uses our existing <code>sequelize</code> database configuration, and also uses an instance of our <code>logger</code> as well. It is set to look for any migrations stored in the <code>migrations/</code> folder.</p><p>The <code>umzug</code> library also has a very handy way to run migrations directly from the terminal using a simple JavaScript file, so let&rsquo;s create a new file named <code>migrate.js</code> in the root of the <code>server</code> directory as well with this content:</p><div class=tab-panel data-tab-group=7bf2dc211c78ea063fe519e3e70b4a5b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=migratejs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7bf2dc211c78ea063fe519e3e70b4a5b","migratejs")'>
<span class=tab-nav-text>migrate.js</span></button></div><div class=tab-content-container><div data-tab-item=migratejs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Load environment (must be first)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;@dotenvx/dotenvx/config&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>migrations</span> <span class=nx>from</span> <span class=s1>&#39;./configs/migrations.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Run Umzug as CLI application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>migrations</span><span class=p>.</span><span class=nx>runAsCLI</span><span class=p>();</span></span></span></code></pre></div></div></div></div></div><p>This file will simply load our environment configuration as well as the <code>umzug</code> instance for migrations, and then instruct it to run as a command-line interface (CLI) application. This is very handy, as we&rsquo;ll see shortly.</p><h2 id=creating-a-migration>Creating a Migration</h2><p>Now we can create a new migration to actually start building our database structure for our application. For this simple example, we&rsquo;ll build a <code>users</code> table with four fields:</p><p><a href=#R-image-23ad1586040b0dcff77a78620b04d7c0 class=lightbox-link><img alt="Users ERD" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/migration_users.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-23ad1586040b0dcff77a78620b04d7c0><img alt="Users ERD" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/migration_users.png></a></p><p>We can refer to both the <a href=https://github.com/sequelize/umzug rel=external target=_blank>Umzug Documentation</a> and <a href=https://github.com/sequelize/umzug/tree/main/examples/1-sequelize-typescript rel=external target=_blank>Examples</a> as well as the <a href=https://sequelize.org/docs/v6/other-topics/migrations/ rel=external target=_blank>Sequelize Documentation</a>. So, let&rsquo;s create a new folder named <code>migrations</code> to match our configuration above, then a new file named <code>00_users.js</code> to hold the migration for our <code>users</code> table:</p><div class=tab-panel data-tab-group=2e6b4c2e8340a3d76b036d23f413f478><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=migrations00_usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2e6b4c2e8340a3d76b036d23f413f478","migrations00_usersjs")'>
<span class=tab-nav-text>migrations/00_users.js</span></button></div><div class=tab-content-container><div data-tab-item=migrations00_usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users table migration
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports up the Up migration
</span></span></span><span class=line><span class=cl><span class=cm> * @exports down the Down migration
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span><span class=nx>Sequelize</span><span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Apply the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>createTable</span><span class=p>(</span><span class=s1>&#39;users&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>autoIncrement</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>STRING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>unique</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Roll back the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>down</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>dropTable</span><span class=p>(</span><span class=s1>&#39;users&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>A migration consists of two functions. First, the <code>up</code> function is called when the migration is applied, and it should define or modify the database structure as desired. In this case, since this is the first migration, we can assume we are starting with a blank database and go from there. The other function, <code>down</code>, is called whenever we want to undo, or <em>rollback</em>, the migration. It should effectively undo any changes made by the <code>up</code> function, leaving the database in the state it was before the migration was applied.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Sequential File Names</div><div class=box-content><p>Most migration systems, including <code>umzug</code>, apply the migrations in order according to the filenames of the migrations. Some systems automatically append a timestamp to the name of the migration file when it is created, such as <code>20250203112345_users.js</code>. For our application, we will simply number them sequentially, starting with <code>00</code>.</p></div></div><p>Finally, we can use the <code>migrate.js</code> file we created to run <code>umzug</code> from the command line to apply the migration:</p><div class=tab-panel data-tab-group=cc0cdccf4b74f3b1e086800b7f470eeb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cc0cdccf4b74f3b1e086800b7f470eeb","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node migrate up</span></span></code></pre></div></div></div></div></div><p>If everything works correctly, we should receive some output showing that our migration succeeded:</p><div class=tab-panel data-tab-group=3bb48c861ae05d16886fb33bf7e22c04><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3bb48c861ae05d16886fb33bf7e22c04","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[dotenvx@1.34.0] injecting env (5) from .env
[2025-02-03 10:59:35.066 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }
[2025-02-03 10:59:35.080 PM] info:      { event: &#39;migrated&#39;, name: &#39;00_users.js&#39;, durationSeconds: 0.014 }
[2025-02-03 10:59:35.080 PM] info:      applied 1 migrations.</code></pre></div></div></div></div></div><p>We should also see a file named <code>database.sqlite</code> added to our file structure. If desired, we can install the <a href="https://marketplace.visualstudio.com/items?itemName=qwtel.sqlite-viewer" rel=external target=_blank>SQLite Viewer</a> extension in VS Code to explore the contents of that file to confirm it is working correctly.</p><p><a href=#R-image-b10820a1401307f0f7c232d8f649dfa0 class=lightbox-link><img alt="Users Table in SQLite" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/migrations_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b10820a1401307f0f7c232d8f649dfa0><img alt="Users Table in SQLite" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/migrations_3.png></a></p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Add Extension to Dev Container</div><div class=box-content><p>When installing a VS Code extension, we can also choose to have it added directly to our <code>devcontainer.json</code> file so it is available automatically whenever we close this repository into a new codespace or dev container. Just click the gear icon on the marketplace page and choose &ldquo;Add to devcontainer.json` from the menu!</p><p><a href=#R-image-e75d7a490371553ad513d204ce365546 class=lightbox-link><img alt="Add to Dev Container" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/migrations_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e75d7a490371553ad513d204ce365546><img alt="Add to Dev Container" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/migrations_2.png></a></p></div></div><p>If we need to roll back that migration, we can use a similar command:</p><div class=tab-panel data-tab-group=29fd6f60bdccfd028e8100b5fb89efe8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("29fd6f60bdccfd028e8100b5fb89efe8","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node migrate down</span></span></code></pre></div></div></div></div></div><p>There are many more commands available to apply migrations individually and more. Check the <a href="https://github.com/sequelize/umzug/?tab=readme-ov-file#cli" rel=external target=_blank>Umzug Documentation</a> for more details</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=seeds>Seeds</h1><a href="https://www.youtube.com/watch?v=UZTSyvzFjAw">YouTube Video</a><h2 id=database-seeding>Database Seeding</h2><p>Another useful task that <code>umzug</code> can handle is adding some initial data to a new database. This process is known as <em>seeding</em> the database. Thankfully, the process for seeding is nearly identical to the process for migrations - in fact, it uses the same operations in different ways! So, let&rsquo;s explore how to set that up.</p><p>First, we&rsquo;ll create a new configuration file at <code>configs/seeds.js</code> that contains nearly the same content as <code>configs/migrations.js</code> with a couple of important changes on the highlighted lines:</p><div class=tab-panel data-tab-group=8aad9b45ed49af3f17acf27a91793a15><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsseedsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8aad9b45ed49af3f17acf27a91793a15","configsseedsjs")'>
<span class=tab-nav-text>configs/seeds.js</span></button></div><div class=tab-content-container><div data-tab-item=configsseedsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Umzug seed engine
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports umzug an Umzug instance
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Umzug</span><span class=p>,</span> <span class=nx>SequelizeStorage</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;umzug&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import database configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;./database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Umzug instance
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>umzug</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Umzug</span><span class=p>({</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>migrations</span><span class=o>:</span> <span class=p>{</span><span class=nx>glob</span><span class=o>:</span> <span class=s1>&#39;seeds/*.js&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span><span class=o>:</span> <span class=nx>database</span><span class=p>.</span><span class=nx>getQueryInterface</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>storage</span><span class=o>:</span> <span class=k>new</span> <span class=nx>SequelizeStorage</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>sequelize</span><span class=o>:</span> <span class=nx>database</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>modelName</span><span class=o>:</span> <span class=s1>&#39;seeds&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=o>:</span> <span class=nx>logger</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>umzug</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>All we really have to do is change the folder where the migrations (in this case, the seeds) are stored, and we also change the name of the model, or table, where that information will be kept in the database.</p><p>Next, we&rsquo;ll create a <code>seed.js</code> file that allows us to run the seeds from the command line. Again, this file is nearly identical to the <code>migrate.js</code> file from earlier, with a couple of simple changes:</p><div class=tab-panel data-tab-group=35d74b2be42a2ab6623ba4d5decf260f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=seedjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("35d74b2be42a2ab6623ba4d5decf260f","seedjs")'>
<span class=tab-nav-text>seed.js</span></button></div><div class=tab-content-container><div data-tab-item=seedjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Load environment (must be first)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;@dotenvx/dotenvx/config&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>seeds</span> <span class=nx>from</span> <span class=s1>&#39;./configs/seeds.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Run Umzug as CLI application
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>seeds</span><span class=p>.</span><span class=nx>runAsCLI</span><span class=p>();</span></span></span></code></pre></div></div></div></div></div><p>Finally, we can create a new folder <code>seeds</code> to store our seeds, and then create the first seed also called <code>00_users.js</code> to add a few default users to our database:</p><div class=tab-panel data-tab-group=6b72fc316f8287c923354cdae3dfb46d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=seeds00_usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6b72fc316f8287c923354cdae3dfb46d","seeds00_usersjs")'>
<span class=tab-nav-text>seeds/00_users.js</span></button></div><div class=tab-content-container><div data-tab-item=seeds00_usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users seed
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports up the Up migration
</span></span></span><span class=line><span class=cl><span class=cm> * @exports down the Down migration
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Timestamp in the appropriate format for the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>now</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>().</span><span class=nx>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>23</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=s2>&#34;T&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34; +00:00&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Array of objects to add to the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=s1>&#39;admin&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=s1>&#39;contributor&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=s1>&#39;manager&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>username</span><span class=o>:</span> <span class=s1>&#39;user&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Apply the seed
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=s1>&#39;users&#39;</span><span class=p>,</span> <span class=nx>users</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Roll back the seed
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>down</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkDelete</span><span class=p>(</span><span class=s2>&#34;users&#34;</span><span class=p>,</span> <span class=p>{},</span> <span class=p>{</span> <span class=nx>truncate</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>This seed will add 4 users to the database. Notice that we are setting both the <code>createdAt</code> and <code>updatedAt</code> fields manually - while the <code>sequelize</code> library will manage those for us in certain situations, we must handle them manually when doing a bulk insert directly to the database.</p><p>At this point we can insert our seeds into the database using the command line interface:</p><div class=tab-panel data-tab-group=dbf88283c00d4bfe46e6ba9eaa845c41><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("dbf88283c00d4bfe46e6ba9eaa845c41","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node seed up</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=b9a5a39e050db1a397640c77e6a49507><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b9a5a39e050db1a397640c77e6a49507","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[dotenvx@1.34.0] injecting env (5) from .env
[2025-02-04 02:47:20.702 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }
[2025-02-04 02:47:20.716 PM] info:      { event: &#39;migrated&#39;, name: &#39;00_users.js&#39;, durationSeconds: 0.013 }
[2025-02-04 02:47:20.716 PM] info:      applied 1 migrations.</code></pre></div></div></div></div></div><p>Now, once we&rsquo;ve done that, we can go back to the <a href="https://marketplace.visualstudio.com/items?itemName=qwtel.sqlite-viewer" rel=external target=_blank>SQLite Viewer</a> extension in VS Code to confirm that our data was properly inserted into the database.</p><p><a href=#R-image-4127735ad6a713122ad765031999f813 class=lightbox-link><img alt="Seeded Data" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/seed_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-4127735ad6a713122ad765031999f813><img alt="Seeded Data" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/seed_1.png></a></p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Migrate Before Seeding</div><div class=box-content><p>One common mistake that is very easy to do is to try and seed the database without first migrating it.</p><div class=tab-panel data-tab-group=e38aa7611bf84243b34a61d6a64f593d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e38aa7611bf84243b34a61d6a64f593d","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[2025-02-04 02:51:39.452 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }

Error: Migration 00_users.js (up) failed: Original error: SQLITE_ERROR: no such table: users</code></pre></div></div></div></div></div><p>Thankfully <code>umzug</code> gives a pretty helpful error in this case.</p><p>Another common error is to forget to roll back seeds before rolling back and resetting any migrations. In that case, when you try to apply your seeds again, they will not be applied since the database thinks the data is still present. So, remember to roll back your seeds <em>before</em> rolling back any migrations!</p></div></div><p>We&rsquo;re almost ready to test our app! The last step is to create a model for our data, which we&rsquo;ll cover on the next page.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=models>Models</h1><a href="https://www.youtube.com/watch?v=c4iNYRhqxTs">YouTube Video</a><h2 id=database-models>Database Models</h2><p>Now that we have our database table structure and sample data set up, we can finally configure <code>sequelize</code> to query our database by defining a <a href=https://sequelize.org/docs/v6/core-concepts/model-basics/ rel=external target=_blank>model</a> representing that data. At its core, a model sis simply an abstraction that represents the structure of the data in a table of our database. We can equate this to a <code>class</code> in object-oriented programming - each row or <em>record</em> in our database can be thought of as an <em>instance</em> of our model class. You can learn more about models in the <a href=https://sequelize.org/docs/v6/core-concepts/model-basics/ rel=external target=_blank>Sequelize Documentation</a></p><p>To create a model, let&rsquo;s first create a <code>models</code> folder in our app, then we can create a file <code>user.js</code> that contains the schema for the <code>User</code> model, based on the <code>users</code> table.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Singular vs. Plural</div><div class=box-content><p>By convention, model names are usually singular like &ldquo;user&rdquo; while table names are typically pluralized like &ldquo;users.&rdquo; This is not a rule that must be followed, but many web frameworks use this convention so we&rsquo;ll also follow it.</p></div></div><p>The <code>User</code> model schema should look very similar to the table definition used in the migration created earlier in this example:</p><div class=tab-panel data-tab-group=976aa7db988983b80a6fe352076c33a7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsuserjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("976aa7db988983b80a6fe352076c33a7","modelsuserjs")'>
<span class=tab-nav-text>models/user.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsuserjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file User schema
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports UserSchema the schema for the User model
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Sequelize</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>UserSchema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>autoIncrement</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>STRING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>unique</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>UserSchema</span></span></span></code></pre></div></div></div></div></div><p>At a minimum, a model schema defines the attributes that are stored in the database, but there are many more features that can be added over time, such as additional computed fields (for example, a <code>fullName</code> field that concatenates the <code>giveName</code> and <code>familyName</code> fields stored in the database). We&rsquo;ll explore ways to improve our models in later examples.</p><p>Once we have the model schema created, we&rsquo;ll create a second file named <code>models.js</code> that will pull together all of our schemas and actually build the <code>sequelize</code> models that can be used throughout our application.</p><div class=tab-panel data-tab-group=249e87254684cd0fe5071cc6162cab07><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsmodelsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("249e87254684cd0fe5071cc6162cab07","modelsmodelsjs")'>
<span class=tab-nav-text>models/models.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsmodelsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Database models
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports User a Sequelize User model
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import database connection
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;../configs/database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Schemas
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>UserSchema</span> <span class=nx>from</span> <span class=s1>&#39;./user.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create User Model
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>User</span> <span class=o>=</span> <span class=nx>database</span><span class=p>.</span><span class=nx>define</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Model Name
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s1>&#39;User&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Schema
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>UserSchema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Other options
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>tableName</span><span class=o>:</span> <span class=s1>&#39;users&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>User</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>It is also important to note that we can define the name of the table that stores instances of the model in the <code>tableName</code> option.</p><p>We will see why it is important to use this <code>models.js</code> file (instead of just defining the model itself and not just the schema in the <code>users.js</code> file) once we start adding relations between the models. For now, we&rsquo;ll start with this simple scaffold that we can expand upon in the future.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Models vs. Migrations</div><div class=box-content><p>One of the more interesting features of <code>sequelize</code> is that it can use just the models themselves to define the structure of the tables in the database. It has features such as <a href=https://sequelize.org/docs/v6/core-concepts/model-basics/#model-synchronization rel=external target=_blank>Model Synchronization</a> to keep the database structure updated to match the given models.</p><p>However, even in the documentation, <code>sequelize</code> recommends using migrations for more complex database structures. So, in our application, the migrations will represent the incremental steps required over time to construct our application&rsquo;s database tables, whereas the models will represent the full structure of the database tables at this point in time. As we add new features to our application, this difference will become more apparent.</p></div></div><h2 id=model-querying>Model Querying</h2><p>Finally, we are at the point where we can actually use our database in our application! So, let&rsquo;s update the route for the <code>users</code> endpoint to actually return a list of the users of our application in a JSON format:</p><div class=tab-panel data-tab-group=6bf5dcefb7422a5dc18da93fab4e0646><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesusersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6bf5dcefb7422a5dc18da93fab4e0646","routesusersjs")'>
<span class=tab-nav-text>routes/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesusersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: users
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Users Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import models
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;../models/models.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of users
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /users:
</span></span></span><span class=line><span class=cl><span class=cm> *   get: 
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: users list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all users in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200: 
</span></span></span><span class=line><span class=cl><span class=cm> *         description: a resource         
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findAll</span><span class=p>();</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>The only change we need to make is to import our <code>User</code> model we just created in the <code>models/models.js</code> file, and then use the <code>User.findAll()</code> query method inside of our first route method. A full list of all the querying functions in <code>sequelize</code> can be found in the <a href=https://sequelize.org/docs/v6/core-concepts/model-querying-basics/ rel=external target=_blank>Sequelize Documentation</a></p><p>Now, let&rsquo;s start our application and see if it works! We should make sure we have migrated and seeded the database recently before starting. If everything works correctly, we should be able to navigate to the <code>/users</code> path and see the following JSON output on the page:</p><div class=tab-panel data-tab-group=b1d957b176278a818a5bc2b0b07b8658><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=route-users class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b1d957b176278a818a5bc2b0b07b8658","route-users")'>
<span class=tab-nav-text>route: /users</span></button></div><div class=tab-content-container><div data-tab-item=route-users class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;createdAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;updatedAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;contributor&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;createdAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;updatedAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;manager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;createdAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;updatedAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;createdAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;updatedAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-04T15:36:32.000Z&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div></div></div></div></div><p>Awesome! We have now developed a basic web application that is able to query a database and present data to the user in a JSON format. This is the first big step toward actually building a RESTful API application.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Committing Database Files</div><div class=box-content><p>One thing we might notice is that our <code>database.sqlite</code> file is in the list of files to be committed to our GitHub repository for this project. In many cases, you may or may not want to do this, depending on what type of data you are storing in the database and how you are using it.</p><p>For this application, and the projects in this course, we&rsquo;ll go ahead and commit our database to GitHub since that is the simplest way to share that information.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=documenting-models>Documenting Models</h1><a href="https://www.youtube.com/watch?v=ebVJ4R08ZZM">YouTube Video</a><h2 id=documenting-models-with-open-api>Documenting Models with Open API</h2><p>Before we move ahead, let&rsquo;s quickly take a minute to add some documentation to our models using the Open API specification. The details can be found in the <a href=https://swagger.io/specification/ rel=external target=_blank>Open API Specification Document</a></p><p>First, let&rsquo;s update our configuration in the <code>configs/openapi.js</code> file to include the <code>models</code> directory:</p><div class=tab-panel data-tab-group=a8edddd32196c4b0ecf7455ed756e65e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsopenapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a8edddd32196c4b0ecf7455ed756e65e","configsopenapijs")'>
<span class=tab-nav-text>configs/openapi.js</span></button></div><div class=tab-content-container><div data-tab-item=configsopenapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Configure SwaggerJSDoc options
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>definition</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>openapi</span><span class=o>:</span> <span class=s2>&#34;3.1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>info</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>title</span><span class=o>:</span> <span class=s2>&#34;Example Project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>description</span><span class=o>:</span> <span class=s2>&#34;Example Project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>servers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>url</span><span class=o>:</span> <span class=nx>url</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>apis</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;./routes/*.js&#34;</span><span class=p>,</span> <span class=s2>&#34;./models/*.js&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Next, at the top of our <code>models/user.js</code> file, we can add information in an <code>@swagger</code> tag about our newly created <code>User</code> model, usually placed right above the model definition itself:</p><div class=tab-panel data-tab-group=8c3922c5f8b80111ba3a99f949b0b942><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsuserjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8c3922c5f8b80111ba3a99f949b0b942","modelsuserjs")'>
<span class=tab-nav-text>models/user.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsuserjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   schemas:
</span></span></span><span class=line><span class=cl><span class=cm> *     User:
</span></span></span><span class=line><span class=cl><span class=cm> *       type: object
</span></span></span><span class=line><span class=cl><span class=cm> *       required:
</span></span></span><span class=line><span class=cl><span class=cm> *         - username
</span></span></span><span class=line><span class=cl><span class=cm> *       properties:
</span></span></span><span class=line><span class=cl><span class=cm> *         id:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *           description: autogenerated id
</span></span></span><span class=line><span class=cl><span class=cm> *         username:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           description: username for the user
</span></span></span><span class=line><span class=cl><span class=cm> *         createdAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was created
</span></span></span><span class=line><span class=cl><span class=cm> *         updatedAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was last updated
</span></span></span><span class=line><span class=cl><span class=cm> *       example:
</span></span></span><span class=line><span class=cl><span class=cm> *           id: 1
</span></span></span><span class=line><span class=cl><span class=cm> *           username: admin
</span></span></span><span class=line><span class=cl><span class=cm> *           createdAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class=line><span class=cl><span class=cm> *           updatedAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>UserSchema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Finally, we can now update our route in the <code>routes/users.js</code> file to show that it is outputting an array of <code>User</code> objects:</p><div class=tab-panel data-tab-group=5844dba1934fa5a72abf09ab8c3fba3a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesusersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5844dba1934fa5a72abf09ab8c3fba3a","routesusersjs")'>
<span class=tab-nav-text>routes/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesusersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of users
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /users:
</span></span></span><span class=line><span class=cl><span class=cm> *   get: 
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: users list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all users in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class="line hl"><span class=cl><span class=cm> *     responses:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *       200:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         description: the list of users
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         content:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *           application/json:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *             schema:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *               type: array
</span></span></span><span class="line hl"><span class=cl><span class=cm> *               items:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *                 $ref: &#39;#/components/schemas/User&#39;       
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findAll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>With all of that in place, we can start our application with the Open API documentation enabled, then navigate to the <code>/docs</code> route to see our updated documentation. We should now see our <code>User</code> model listed as a schema at the bottom of the page:</p><p><a href=#R-image-df2758a0c7b37564c52e1a7c1d2334c0 class=lightbox-link><img alt="User Schema" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/documenting_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-df2758a0c7b37564c52e1a7c1d2334c0><img alt="User Schema" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/documenting_1.png></a></p><p>In addition, we can see that the <code>/users</code> route has also been updated to show that it returns an array of <code>User</code> objects, along with the relevant data:</p><p><a href=#R-image-886eeda27d5a323754206c97b54dd101 class=lightbox-link><img alt="User Route Documentation" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/documenting_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-886eeda27d5a323754206c97b54dd101><img alt="User Route Documentation" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/documenting_2.png></a></p><p>As we continue to add models and routes to our application, we should also make sure our Open API documentation is kept up to date with the latest information.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=automation>Automation</h1><a href="https://www.youtube.com/watch?v=LMQZ6OXpzGU">YouTube Video</a><h2 id=automating-database-deployment>Automating Database Deployment</h2><p>One very helpful feature we can add to our application is the ability to automatically migrate and seed the database when the application first starts. This can be especially helpful when deploying this application in a container.</p><p>To do this, let&rsquo;s add some additional code to our <code>bin/www</code> file that is executed when our project starts:</p><div class=tab-panel data-tab-group=ae1d3c6dcc1ef2c941b5cab3998f4058><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=binwww class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ae1d3c6dcc1ef2c941b5cab3998f4058","binwww")'>
<span class=tab-nav-text>bin/www</span></button></div><div class=tab-content-container><div data-tab-item=binwww class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Executable entrypoint for the web application
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>http</span> <span class=nx>from</span> <span class=s1>&#39;http&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s1>&#39;../app.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s1>&#39;../configs/database.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;../configs/logger.js&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>migrations</span> <span class=nx>from</span> <span class=s1>&#39;../configs/migrations.js&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>seeds</span> <span class=nx>from</span> <span class=s1>&#39;../configs/seeds.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get port from environment and store in Express.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>port</span> <span class=o>=</span> <span class=nx>normalizePort</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>||</span> <span class=s1>&#39;3000&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;port&#39;</span><span class=p>,</span> <span class=nx>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create HTTP server.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>server</span> <span class=o>=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>createServer</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Attach event handlers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>server</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=nx>onError</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>server</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;listening&#39;</span><span class=p>,</span> <span class=nx>onListening</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Call startup function
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>startup</span><span class=p>();</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=cm>/**
</span></span></span><span class="line hl"><span class=cl><span class=cm> * Server startup function
</span></span></span><span class="line hl"><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=kd>function</span> <span class=nx>startup</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Test database connection
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=nx>database</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Database connection successful&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Run migrations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>migrations</span><span class=p>.</span><span class=nx>up</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Database migrations complete&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SEED_DATA</span> <span class=o>===</span> <span class=s1>&#39;true&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=s2>&#34;Database data seeding is enabled!&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>seeds</span><span class=p>.</span><span class=nx>up</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>            <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Database seeding complete&#34;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>            <span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>port</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>          <span class=c1>// Listen on provided port, on all network interfaces.
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>          <span class=nx>server</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>port</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>){</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span>
</span></span><span class="line hl"><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>We now have a new <code>startup</code> function that will first test the database connection, then run the migrations, and finally it will seed the database if the <code>SEED_DATA</code> environment variable is set to <code>true</code>. Once all that is done, it will start the application by calling <code>server.listen</code> using the port.</p><p>Notice that this code uses the <code>then()</code> function to resolve promises instead of the <code>async</code> and <code>await</code> keywords. This is because it is running at the top level, and cannot include any <code>await</code> keywords.</p><p>To enable this, let&rsquo;s add the <code>SEED_DATA</code> environment variable to both <code>.env</code> and <code>.env.example</code>:</p><div class=tab-panel data-tab-group=f9bee6dae0fcfa7d3435be152c684164><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f9bee6dae0fcfa7d3435be152c684164","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>https://<span class=nv>$CODESPACE_NAME</span>-<span class=nv>$PORT</span>.<span class=nv>$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>database.sqlite
</span></span><span class="line hl"><span class=cl><span class=nv>SEED_DATA</span><span class=o>=</span>true</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=61d6d1320c1094cc59b8bcfcba6637ec><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=envexample class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("61d6d1320c1094cc59b8bcfcba6637ec","envexample")'>
<span class=tab-nav-text>.env.example</span></button></div><div class=tab-content-container><div data-tab-item=envexample class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>debug
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>http://localhost:3000
</span></span><span class=line><span class=cl><span class=c1># For GitHub Codespaces</span>
</span></span><span class=line><span class=cl><span class=c1># OPENAPI_HOST=https://$CODESPACE_NAME-$PORT.$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>database.sqlite
</span></span><span class="line hl"><span class=cl><span class=nv>SEED_DATA</span><span class=o>=</span>false</span></span></code></pre></div></div></div></div></div><p>To test this, we can delete the <code>database.sqlite</code> file in our repository, then start our project:</p><div class=tab-panel data-tab-group=65da10939c911dce5e5510cc394a2f15><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("65da10939c911dce5e5510cc394a2f15","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>If it works correctly, we should see that our application is able to connect to the database, migrate the schema, and add the seed data, before fully starting:</p><div class=tab-panel data-tab-group=fa76cf07dba67a2943c369a01456dc78><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fa76cf07dba67a2943c369a01456dc78","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight hl_lines=11-23><pre tabindex=0><code>&gt; example-project@0.0.1 dev
&gt; nodemon ./bin/www

[nodemon] 3.1.9
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,cjs,json
[nodemon] starting `node ./bin/www`
[dotenvx@1.34.0] injecting env (6) from .env
[2025-02-04 06:56:11.823 PM] warn:      OpenAPI documentation visible!
[2025-02-04 06:56:12.163 PM] debug:     Database connection successful
[2025-02-04 06:56:12.208 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }
[2025-02-04 06:56:12.265 PM] info:      { event: &#39;migrated&#39;, name: &#39;00_users.js&#39;, durationSeconds: 0.058 }
[2025-02-04 06:56:12.266 PM] debug:     Database migrations complete
[2025-02-04 06:56:12.266 PM] warn:      Database data seeding is enabled!
[2025-02-04 06:56:12.296 PM] info:      { event: &#39;migrating&#39;, name: &#39;00_users.js&#39; }
[2025-02-04 06:56:12.321 PM] info:      { event: &#39;migrated&#39;, name: &#39;00_users.js&#39;, durationSeconds: 0.024 }
[2025-02-04 06:56:12.321 PM] debug:     Database seeding complete
[2025-02-04 06:56:12.323 PM] info:      Listening on port 3000</code></pre></div></div></div></div></div><p>There we go! Our application will now always make sure the database is properly migrated, and optionally seeded, before it starts. Now, when another developer or user starts our application, it will be sure to have a working database.</p><p>This is a good point to <strong>commit and push</strong> our work!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=another-table>Another Table</h1><a href="https://www.youtube.com/watch?v=MWRW1LgN7gI">YouTube Video</a><h2 id=adding-another-table>Adding Another Table</h2><p>Now that we have a working database, let&rsquo;s explore what it takes to add a new table to our application to represent additional models and data in our database.</p><p>We&rsquo;ve already created a <code>users</code> table, which contains information about the users of our application. Now we want to add a <code>roles</code> table to contain all of the possible roles that our users can hold. In addition, we need some way to associate a user with a number of roles. Each user can have multiple roles, and each role can be assigned to multiple users. This is known as a <strong>many to many</strong> database relation, and requires an additional <strong>junction table</strong> to implement it properly. The end goal is to create the database schema represented in this diagram:</p><p><a href=#R-image-c6fca6d2b118dd0c86749da6a1b9c00e class=lightbox-link><img alt="User Roles Database Diagram" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/02/user_roles.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c6fca6d2b118dd0c86749da6a1b9c00e><img alt="User Roles Database Diagram" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/02/user_roles.png></a></p><p>To do this, we&rsquo;ll go through three steps:</p><ol><li>Create a migration to modify the database schema</li><li>Create a model for each table</li><li>Add additional seed data for these tables</li></ol><h2 id=migration>Migration</h2><p>First, we need to create a new migration to modify the database schema to include the two new tables. So, we&rsquo;ll create a file named <code>01_roles.js</code> in the <code>migrations</code> folder and add content to it to represent the two new tables we need to create:</p><div class=tab-panel data-tab-group=8dad6ac6ab29ae518148152f7d83c60e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=migrations01_rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8dad6ac6ab29ae518148152f7d83c60e","migrations01_rolesjs")'>
<span class=tab-nav-text>migrations/01_roles.js</span></button></div><div class=tab-content-container><div data-tab-item=migrations01_rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Roles table migration
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports up the Up migration
</span></span></span><span class=line><span class=cl><span class=cm> * @exports down the Down migration
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span><span class=nx>Sequelize</span><span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Apply the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>createTable</span><span class=p>(</span><span class=s1>&#39;roles&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>autoIncrement</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>STRING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>createTable</span><span class=p>(</span><span class=s1>&#39;user_roles&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>references</span><span class=o>:</span> <span class=p>{</span> <span class=nx>model</span><span class=o>:</span> <span class=s1>&#39;users&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;id&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>onDelete</span><span class=o>:</span> <span class=s2>&#34;cascade&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>references</span><span class=o>:</span> <span class=p>{</span> <span class=nx>model</span><span class=o>:</span> <span class=s1>&#39;roles&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;id&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>onDelete</span><span class=o>:</span> <span class=s2>&#34;cascade&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Roll back the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>down</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>dropTable</span><span class=p>(</span><span class=s1>&#39;user_roles&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>dropTable</span><span class=p>(</span><span class=s1>&#39;roles&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>In this migration, we are creating two tables. The first, named <code>roles</code>, stores the list of roles in the application. The second, named <code>user_roles</code>, is the junction table used for the many-to-many relationship between the <code>users</code> and <code>roles</code> table. Notice that we have to add the tables in the correct order, and also in the <code>down</code> method we have to remove them in reverse order. Finally, it is important to include the <code>onDelete: "cascade"</code> option for each of our reference fields in the <code>user_roles</code> table, as that will handle deleting associated entries in the junction table when a user or role is deleted.</p><p>The <code>user_roles</code> table also includes a great example for adding a foreign key reference between two tables. More information can be found in the <a href=https://sequelize.org/docs/v6/core-concepts/assocs/ rel=external target=_blank>Sequelize Documentation</a>.</p><h2 id=models>Models</h2><p>Next, we need to create two models to represent these tables. The first is the <code>role</code> model schema, stored in <code>models/role.js</code> with the following content:</p><div class=tab-panel data-tab-group=8707fb6056f759d6e3e3a067bd5be5a0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsrolejs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8707fb6056f759d6e3e3a067bd5be5a0","modelsrolejs")'>
<span class=tab-nav-text>models/role.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsrolejs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Role model
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports RoleSchema the schema for the Role model
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Sequelize</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   schemas:
</span></span></span><span class=line><span class=cl><span class=cm> *     Role:
</span></span></span><span class=line><span class=cl><span class=cm> *       type: object
</span></span></span><span class=line><span class=cl><span class=cm> *       required:
</span></span></span><span class=line><span class=cl><span class=cm> *         - role
</span></span></span><span class=line><span class=cl><span class=cm> *       properties:
</span></span></span><span class=line><span class=cl><span class=cm> *         id:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *           description: autogenerated id
</span></span></span><span class=line><span class=cl><span class=cm> *         role:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           description: name of the role
</span></span></span><span class=line><span class=cl><span class=cm> *         createdAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was created
</span></span></span><span class=line><span class=cl><span class=cm> *         updatedAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was last updated
</span></span></span><span class=line><span class=cl><span class=cm> *       example:
</span></span></span><span class=line><span class=cl><span class=cm> *           id: 1
</span></span></span><span class=line><span class=cl><span class=cm> *           role: manage_users
</span></span></span><span class=line><span class=cl><span class=cm> *           createdAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class=line><span class=cl><span class=cm> *           updatedAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>RoleSchema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>autoIncrement</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>role</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>STRING</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>DATE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowNull</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>RoleSchema</span></span></span></code></pre></div></div></div></div></div><p>Notice that this file is very similar to the <code>models/user.js</code> file created earlier, with a few careful changes made to match the table schema.</p><p>We also need to create a model schema for the <code>user_roles</code> table, which we will store in the <code>models/user_role.js</code> file with the following content:</p><div class=tab-panel data-tab-group=25d8e570b20dfaa554337d8ce5c7c9f1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsuser_rolejs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("25d8e570b20dfaa554337d8ce5c7c9f1","modelsuser_rolejs")'>
<span class=tab-nav-text>models/user_role.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsuser_rolejs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file User role junction model
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports RoleSchema the schema for the UserRole model
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>Sequelize</span> <span class=nx>from</span> <span class=s1>&#39;sequelize&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>UserRoleSchema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>userId</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>references</span><span class=o>:</span> <span class=p>{</span> <span class=nx>model</span><span class=o>:</span> <span class=s1>&#39;User&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;id&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>onDelete</span><span class=o>:</span> <span class=s2>&#34;cascade&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>roleId</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=nx>Sequelize</span><span class=p>.</span><span class=nx>INTEGER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>primaryKey</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>references</span><span class=o>:</span> <span class=p>{</span> <span class=nx>model</span><span class=o>:</span> <span class=s1>&#39;Role&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;id&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>onDelete</span><span class=o>:</span> <span class=s2>&#34;cascade&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>UserRoleSchema</span></span></span></code></pre></div></div></div></div></div><p>Finally, we can now update our <code>models/models.js</code> file to create the <code>Role</code> and <code>UserRole</code> models, and also to define the associations between them and the <code>User</code> model.</p><div class=tab-panel data-tab-group=39b21d725b4c6b6b9c309a3607971f30><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsmodelsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("39b21d725b4c6b6b9c309a3607971f30","modelsmodelsjs")'>
<span class=tab-nav-text>models/models.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsmodelsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Database models
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports User a Sequelize User model
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @exports Role a Sequelize Role model
</span></span></span><span class="line hl"><span class=cl><span class=cm> * @exports UserRole a Sequelize UserRole model
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import database connection
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;../configs/database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Schemas
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>UserSchema</span> <span class=nx>from</span> <span class=s1>&#39;./user.js&#39;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>RoleSchema</span> <span class=nx>from</span> <span class=s2>&#34;./role.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>UserRoleSchema</span> <span class=nx>from</span> <span class=s2>&#34;./user_role.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create User Model
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>User</span> <span class=o>=</span> <span class=nx>database</span><span class=p>.</span><span class=nx>define</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Model Name
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s1>&#39;User&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Schema
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>UserSchema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Other options
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>tableName</span><span class=o>:</span> <span class=s1>&#39;users&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Create Role Model
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>Role</span> <span class=o>=</span> <span class=nx>database</span><span class=p>.</span><span class=nx>define</span><span class=p>(</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Model Name
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=s1>&#39;Role&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Schema
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=nx>RoleSchema</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Other options
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>tableName</span><span class=o>:</span> <span class=s1>&#39;roles&#39;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Create UserRole Model
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>UserRole</span> <span class=o>=</span> <span class=nx>database</span><span class=p>.</span><span class=nx>define</span><span class=p>(</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Model Name
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=s1>&#39;UserRole&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Schema
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=nx>UserRoleSchema</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// Other options
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>tableName</span><span class=o>:</span> <span class=s1>&#39;user_roles&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>timestamps</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>underscored</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Define Associations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>Role</span><span class=p>.</span><span class=nx>belongsToMany</span><span class=p>(</span><span class=nx>User</span><span class=p>,</span> <span class=p>{</span> <span class=nx>through</span><span class=o>:</span> <span class=nx>UserRole</span><span class=p>,</span> <span class=nx>unique</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;users&#34;</span> <span class=p>})</span>
</span></span><span class="line hl"><span class=cl><span class=nx>User</span><span class=p>.</span><span class=nx>belongsToMany</span><span class=p>(</span><span class=nx>Role</span><span class=p>,</span> <span class=p>{</span> <span class=nx>through</span><span class=o>:</span> <span class=nx>UserRole</span><span class=p>,</span> <span class=nx>unique</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>User</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>Role</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>UserRole</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Notice that this file contains two lines at the bottom to define the associations included as part of this table, so that <code>sequelize</code> will know how to handle it. This will instruct <code>sequelize</code> to add additional attributes and features to the <code>User</code> and <code>Role</code> models for querying the related data, as we&rsquo;ll see shortly.</p><p>We also added the line <code>timestamps: false</code> to the other options for the <code>User_roles</code> table to disable the creation and management of timestamps (the <code>createdAt</code> and <code>updatedAt</code> attributes), since they may not be needed for this relation.</p><p>Finally, we added the <code>underscored: true</code> line to tell <code>sequelize</code> that it should interpret the <code>userId</code> and <code>roleId</code> attributes (written in camel case as preferred by Sequelize) as <code>user_id</code> and <code>role_id</code>, respectively (written in snake case as we did in the migration).</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Camel Case vs. Snake Case</div><div class=box-content><p>The choice of either CamelCase or snake_case naming for database attributes is a matter of preference. In this example, we show both methods, and it is up to each developer to select their own preferred style.</p></div></div><h2 id=seed>Seed</h2><p>Finally, let&rsquo;s create a new seed file in <code>seeds/01_roles.js</code> to add some default data to the <code>roles</code> and <code>user_roles</code> tables:</p><div class=tab-panel data-tab-group=84649544457eb42abf0fc7e8d44b6273><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=seeds01_rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("84649544457eb42abf0fc7e8d44b6273","seeds01_rolesjs")'>
<span class=tab-nav-text>seeds/01_roles.js</span></button></div><div class=tab-content-container><div data-tab-item=seeds01_rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Roles seed
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports up the Up migration
</span></span></span><span class=line><span class=cl><span class=cm> * @exports down the Down migration
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Timestamp in the appropriate format for the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>now</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>().</span><span class=nx>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>23</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=s2>&#34;T&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34; +00:00&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Array of objects to add to the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;manage_users&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;manage_documents&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;add_documents&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;manage_communities&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;add_communities&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;view_documents&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s1>&#39;view_communities&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>createdAt</span><span class=o>:</span> <span class=nx>now</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>updatedAt</span><span class=o>:</span> <span class=nx>now</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>user_roles</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>user_id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role_id</span><span class=o>:</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Apply the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=s1>&#39;roles&#39;</span><span class=p>,</span> <span class=nx>roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=s1>&#39;user_roles&#39;</span><span class=p>,</span> <span class=nx>user_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Roll back the migration
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {queryInterface} context the database context to use 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>down</span><span class=p>({</span><span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkDelete</span><span class=p>(</span><span class=s1>&#39;user_roles&#39;</span><span class=p>,</span> <span class=p>{}</span> <span class=p>,</span> <span class=p>{</span> <span class=nx>truncate</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkDelete</span><span class=p>(</span><span class=s2>&#34;roles&#34;</span><span class=p>,</span> <span class=p>{},</span> <span class=p>{</span> <span class=nx>truncate</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Once again, this seed is very similar to what we&rsquo;ve seen before. Notice that we use the <code>truncate</code> option to remove all entries in the <code>user_roles</code> table when we undo this seed as well as the <code>roles</code> table.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Seeding from a CSV File</div><div class=box-content><p>It is also possible to seed the database from a CSV or other data file using a bit of JavaScript code. Here&rsquo;s an example for seeding a table that contains all of the counties in Kansas using a CSV file with that data that is read with the <a href=https://www.npmjs.com/package/convert-csv-to-json rel=external target=_blank>convert-csv-to-json</a> library:</p><div class=tab-panel data-tab-group=9035c496f2fabec1cc70812d99f1e6fe><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=seeds02_countiesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9035c496f2fabec1cc70812d99f1e6fe","seeds02_countiesjs")'>
<span class=tab-nav-text>seeds/02_counties.js</span></button></div><div class=tab-content-container><div data-tab-item=seeds02_countiesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>csvToJson</span> <span class=o>=</span> <span class=kr>import</span><span class=p>(</span><span class=s2>&#34;convert-csv-to-json&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Timestamp in the appropriate format for the database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>now</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>().</span><span class=nx>slice</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>23</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=s2>&#34;T&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34; +00:00&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>up</span><span class=p>({</span> <span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Read data from CSV file
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// id,name,code,seat,population,est_year
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 1,Allen,AL,Iola,&#34;12,464&#34;,1855
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>counties</span> <span class=o>=</span> <span class=p>(</span><span class=kr>await</span> <span class=nx>csvToJson</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>formatValueByType</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>supportQuotedField</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>fieldDelimiter</span><span class=p>(</span><span class=s2>&#34;,&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>getJsonFromCsv</span><span class=p>(</span><span class=s2>&#34;./seeds/counties.csv&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// append timestamps and parse fields
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>counties</span><span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>c</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// handle parsing numbers with comma separators
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>c</span><span class=p>.</span><span class=nx>population</span> <span class=o>=</span> <span class=nb>parseInt</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>population</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/,/g</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nx>createdAt</span> <span class=o>=</span> <span class=nx>now</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nx>updatedAt</span> <span class=o>=</span> <span class=nx>now</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// insert into database
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkInsert</span><span class=p>(</span><span class=s2>&#34;counties&#34;</span><span class=p>,</span> <span class=nx>counties</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>down</span><span class=p>({</span> <span class=nx>context</span><span class=o>:</span> <span class=nx>queryInterface</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>await</span> <span class=nx>queryInterface</span><span class=p>.</span><span class=nx>bulkDelete</span><span class=p>(</span><span class=s2>&#34;counties&#34;</span><span class=p>,</span> <span class=p>{},</span> <span class=p>{</span> <span class=nx>truncate</span><span class=o>:</span> <span class=kc>true</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div></div></div><h2 id=update-user-model>Update User Model</h2><p>Finally, let&rsquo;s update the <code>User</code> model schema to include related roles. At this point, we just have to update the Open API documentation to match:</p><div class=tab-panel data-tab-group=a319cda13de4a30b36ab18e5c90619ea><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=modelsuserjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a319cda13de4a30b36ab18e5c90619ea","modelsuserjs")'>
<span class=tab-nav-text>models/user.js</span></button></div><div class=tab-content-container><div data-tab-item=modelsuserjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   schemas:
</span></span></span><span class=line><span class=cl><span class=cm> *     User:
</span></span></span><span class=line><span class=cl><span class=cm> *       type: object
</span></span></span><span class=line><span class=cl><span class=cm> *       required:
</span></span></span><span class=line><span class=cl><span class=cm> *         - username
</span></span></span><span class=line><span class=cl><span class=cm> *       properties:
</span></span></span><span class=line><span class=cl><span class=cm> *         id:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *           description: autogenerated id
</span></span></span><span class=line><span class=cl><span class=cm> *         username:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           description: username for the user
</span></span></span><span class=line><span class=cl><span class=cm> *         createdAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was created
</span></span></span><span class=line><span class=cl><span class=cm> *         updatedAt:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *           format: date-time
</span></span></span><span class=line><span class=cl><span class=cm> *           description: when the user was last updated
</span></span></span><span class="line hl"><span class=cl><span class=cm> *         roles:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *           type: array
</span></span></span><span class="line hl"><span class=cl><span class=cm> *           items:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *             $ref: &#39;#/components/schemas/Role&#39;
</span></span></span><span class=line><span class=cl><span class=cm> *       example:
</span></span></span><span class=line><span class=cl><span class=cm> *           id: 1
</span></span></span><span class=line><span class=cl><span class=cm> *           username: admin
</span></span></span><span class=line><span class=cl><span class=cm> *           createdAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class=line><span class=cl><span class=cm> *           updatedAt: 2025-02-04T15:36:32.000Z
</span></span></span><span class="line hl"><span class=cl><span class=cm> *           roles:
</span></span></span><span class="line hl"><span class=cl><span class=cm> *             - id: 1
</span></span></span><span class="line hl"><span class=cl><span class=cm> *               role: manage_users
</span></span></span><span class="line hl"><span class=cl><span class=cm> *             - id: 2
</span></span></span><span class="line hl"><span class=cl><span class=cm> *               role: manage_documents
</span></span></span><span class="line hl"><span class=cl><span class=cm> *             - id: 4
</span></span></span><span class="line hl"><span class=cl><span class=cm> *               role: manage_communities
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now we can modify our route in <code>routes/users.js</code> to include the data from the related <code>Role</code> model in our query:</p><div class=tab-panel data-tab-group=a4464f53b7498bfdba38a122381ad9fd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesusersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a4464f53b7498bfdba38a122381ad9fd","routesusersjs")'>
<span class=tab-nav-text>routes/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesusersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: users
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Users Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;../models/models.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of users
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /users:
</span></span></span><span class=line><span class=cl><span class=cm> *   get: 
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: users list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all users in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of users
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 $ref: &#39;#/components/schemas/User&#39;          
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findAll</span><span class=p>({</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=s1>&#39;role&#39;</span><span class=p>],</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>users</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>You can learn more about querying associations in the <a href=https://sequelize.org/docs/v6/core-concepts/assocs/#basics-of-queries-involving-associations rel=external target=_blank>Sequelize Documentation</a>.</p><p>If everything works, we should see our roles now included in our JSON output when we navigate to the <code>/users</code> route:</p><div class=tab-panel data-tab-group=4be92a9a41d1fddd6a6f7cf9d5e85995><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=route-users class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4be92a9a41d1fddd6a6f7cf9d5e85995","route-users")'>
<span class=tab-nav-text>route: /users</span></button></div><div class=tab-content-container><div data-tab-item=route-users class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[
  {
    &#34;id&#34;: 1,
    &#34;username&#34;: &#34;admin&#34;,
    &#34;createdAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;updatedAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;roles&#34;: [
      {
        &#34;id&#34;: 1,
        &#34;role&#34;: &#34;manage_users&#34;
      },
      {
        &#34;id&#34;: 2,
        &#34;role&#34;: &#34;manage_documents&#34;
      },
      {
        &#34;id&#34;: 4,
        &#34;role&#34;: &#34;manage_communities&#34;
      }
    ]
  },
  {
    &#34;id&#34;: 2,
    &#34;username&#34;: &#34;contributor&#34;,
    &#34;createdAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;updatedAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;roles&#34;: [
      {
        &#34;id&#34;: 3,
        &#34;role&#34;: &#34;add_documents&#34;
      },
      {
        &#34;id&#34;: 5,
        &#34;role&#34;: &#34;add_communities&#34;
      }
    ]
  },
  {
    &#34;id&#34;: 3,
    &#34;username&#34;: &#34;manager&#34;,
    &#34;createdAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;updatedAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;roles&#34;: [
      {
        &#34;id&#34;: 2,
        &#34;role&#34;: &#34;manage_documents&#34;
      },
      {
        &#34;id&#34;: 4,
        &#34;role&#34;: &#34;manage_communities&#34;
      }
    ]
  },
  {
    &#34;id&#34;: 4,
    &#34;username&#34;: &#34;user&#34;,
    &#34;createdAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;updatedAt&#34;: &#34;2025-01-28T23:06:01.000Z&#34;,
    &#34;roles&#34;: [
      {
        &#34;id&#34;: 6,
        &#34;role&#34;: &#34;view_documents&#34;
      },
      {
        &#34;id&#34;: 7,
        &#34;role&#34;: &#34;view_communities&#34;
      }
    ]
  }
]</code></pre></div></div></div></div></div><p>That should also exactly match the schema and route information in our Open API documentation provided at the <code>/docs</code> route.</p><p>There we go! That&rsquo;s a quick example of adding an additional table to our application, including a relationship and more.</p><p>As a last step before finalizing our code, we should run the <code>lint</code> and <code>format</code> commands and deal with any errors they find. Finally, we can <strong>commit and push</strong> our work.</p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=restful-api>RESTful API</h1><p>This example project builds on the previous Adding a Database project by using that project to create a <a href=https://en.wikipedia.org/wiki/REST rel=external target=_blank>RESTful API</a>. That API can be used to access and modify the data in the database. We&rsquo;ll also add a suite of unit tests to explore our API and ensure that it is working correctly.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li>A RESTful API with several routes for creating, reading, updating, and deleting (CRUD) data in the database</li><li>Open API Documentation for API Routes</li><li>Full Unit Test Suite with Coverage Metrics</li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of RESTful API</h1><article class=default><header class=headline></header><h1 id=api-design>API Design</h1><a href="https://www.youtube.com/watch?v=FwJ139xkhTc">YouTube Video</a><h2 id=good-api-design>Good API Design</h2><p>There are many articles online that discuss best practices in API design. For this project, we&rsquo;re going to follow a few of the most common recommendations:</p><ul><li><a href=https://www.postman.com/api-platform/api-versioning/ rel=external target=_blank>API Versioning</a></li><li><a href=https://restfulapi.net/resource-naming/ rel=external target=_blank>Proper Naming Conventions</a></li><li><a href=https://restfulapi.net/http-methods/ rel=external target=_blank>Proper HTTP Methods</a></li><li><a href=https://restfulapi.net/http-status-codes/ rel=external target=_blank>Proper HTTP Status Code Responses</a></li></ul><p>Let&rsquo;s start with the first one - we can easily add a version number to our API&rsquo;s URL paths. This allows us to make breaking changes to the API in the future without breaking any of the current functionality.</p><h2 id=api-versioning>API Versioning</h2><p>Our current application contains data for both a <code>User</code> and a <code>Role</code> model. For this example, we&rsquo;ll begin by adding a set of RESTful API routes to work with the <code>Role</code> model. In order to add proper versioning to our API, we will want these routes visible at the <code>/api/v1/roles</code> path.</p><p>First, we should create the folder structure inside of our <code>routes</code> folder to match the routes used in our API. This means we&rsquo;ll create an <code>api</code> folder, then a <code>v1</code> folder, and finally a <code>roles.js</code> file inside of that folder:</p><p><a href=#R-image-a09d8314cc8e70b2bb6acd6a8c9db358 class=lightbox-link><img alt="API Folder Paths" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/api_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a09d8314cc8e70b2bb6acd6a8c9db358><img alt="API Folder Paths" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/api_1.png></a></p><p>Before we create the content in that file, let&rsquo;s also create a new file in the base <code>routes</code> folder named <code>api.js</code> that will become the base file for all of our API routes:</p><div class=tab-panel data-tab-group=25e1f91f414d71c0611f43be5f469341><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("25e1f91f414d71c0611f43be5f469341","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file API main router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: api
</span></span></span><span class=line><span class=cl><span class=cm> *   description: API routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import v1 routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>rolesRouter</span> <span class=nx>from</span> <span class=s2>&#34;./api/v1/roles.js&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use v1 routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/v1/roles&#34;</span><span class=p>,</span> <span class=nx>rolesRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of API versions
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: list API versions
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [api]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of users
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: object
</span></span></span><span class=line><span class=cl><span class=cm> *                 properties:
</span></span></span><span class=line><span class=cl><span class=cm> *                   version:
</span></span></span><span class=line><span class=cl><span class=cm> *                     type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                   url: 
</span></span></span><span class=line><span class=cl><span class=cm> *                     type: string
</span></span></span><span class=line><span class=cl><span class=cm> *             example:
</span></span></span><span class=line><span class=cl><span class=cm> *               - version: &#34;1.0&#34;
</span></span></span><span class=line><span class=cl><span class=cm> *                 url: /api/v1/
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v1/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span></span></span></code></pre></div></div></div></div></div><p>This file is very simple - it just outputs all possible API versions (in this case, we just have a single API version). It also imports and uses our new <code>roles</code> router. Finally, it includes some basic Open API documentation for the route it contains. Let&rsquo;s quickly add some basic content to our <code>roles</code> router, based on the existing content in our <code>users</code> router from before:</p><div class=tab-panel data-tab-group=919936b75ffc4bf5cdc2aa35129e93fc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("919936b75ffc4bf5cdc2aa35129e93fc","routesapiv1rolesjs")'>
<span class=tab-nav-text>routes/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Roles router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: roles
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Roles Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/logger.js&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of roles
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/v1/roles:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: roles list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all roles in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [roles]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of roles
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 $ref: &#39;#/components/schemas/Role&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>Role</span><span class=p>.</span><span class=nx>findAll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Notice that we have added an additional <code>try</code> and <code>catch</code> block to the route function. This will ensure any errors that are thrown by the database get caught and logged without leaking any sensitive data from our API. It is always a good practice to wrap each API method in a <code>try</code> and <code>catch</code> block.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Get All Route Only</div><div class=box-content><p>For this particular application&rsquo;s API design, we will only be creating the <strong>get all</strong> RESTful method for the <code>Role</code> model. This is because we don&rsquo;t actually want any users of the application modifying the roles themselves, since those roles will eventually be used in the overall authorization structure of the application (to be added in a later example). However, when creating or updating users, we need to be able to access a full list of all available roles, which can be found using this particular API endpoint.</p><p>We&rsquo;ll explore the rest of the RESTful API methods in the <code>User</code> model later in this example.</p></div></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Controllers and Services</div><div class=box-content><p>More complex RESTful API designs may include additional files such as <strong>controllers</strong> and <strong>services</strong> to add additional structure to the application. For example, there might be multiple API routes that access the same method in a controller, which then uses a service to perform business logic on the data before storing it in the database.</p><p>For this example project, we will place most of the functionality directly in our routes to simplify our structure.</p><p>You can read more about how to use controllers and services in the <a href=https://developer.mozilla.org/en-US/docs/Learn_web_development/Extensions/Server-side/Express_Nodejs/routes rel=external target=_blank>MDN Express Tutorial</a>.</p></div></div><p>Since we are creating routes in a new subfolder, we also need to update our Open API configuration in <code>configs/openapi.js</code> so that we can see the documentation contained in those routes:</p><div class=tab-panel data-tab-group=3b2a3005fa60d2ca67a2fa91eb000614><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsopenapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("3b2a3005fa60d2ca67a2fa91eb000614","configsopenapijs")'>
<span class=tab-nav-text>configs/openapi.js</span></button></div><div class=tab-content-container><div data-tab-item=configsopenapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Configure SwaggerJSDoc options
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>definition</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>openapi</span><span class=o>:</span> <span class=s2>&#34;3.1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>info</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>title</span><span class=o>:</span> <span class=s2>&#34;Lost Communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>description</span><span class=o>:</span> <span class=s2>&#34;Kansas Lost Communities Project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>servers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>url</span><span class=o>:</span> <span class=nx>url</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>apis</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;./routes/*.js&#34;</span><span class=p>,</span> <span class=s2>&#34;./models/*.js&#34;</span><span class=p>,</span> <span class=s2>&#34;./routes/api/v1/*.js&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>swaggerJSDoc</span><span class=p>(</span><span class=nx>options</span><span class=p>);</span></span></span></code></pre></div></div></div></div></div><p>Now that we&rsquo;ve created these two basic routers, let&rsquo;s get them added to our <code>app.js</code> file so they are accessible to the application:</p><div class=tab-panel data-tab-group=7909da9a76aeb0cdbad6fbf38cba7f78><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7909da9a76aeb0cdbad6fbf38cba7f78","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/index.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/users.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>apiRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/api.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>helmet</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>compression</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use middlewares
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use static files
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=kr>static</span><span class=p>(</span><span class=nx>path</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=kr>import</span><span class=p>.</span><span class=nx>meta</span><span class=p>.</span><span class=nx>dirname</span><span class=p>,</span> <span class=s2>&#34;public&#34;</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/users&#34;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/api&#34;</span><span class=p>,</span> <span class=nx>apiRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, with everything in place, let&rsquo;s run our application and see if we can access that new route at <code>/api/v1/roles</code>:</p><div class=tab-panel data-tab-group=9bb49c5b22fbf2f0730c6de66f95d90e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9bb49c5b22fbf2f0730c6de66f95d90e","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>If everything is working correctly, we should see our roles listed in the output on that page:</p><p><a href=#R-image-72155fc259fa37924f86e94ef50ecf4f class=lightbox-link><img alt="List of Roles" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/api_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-72155fc259fa37924f86e94ef50ecf4f><img alt="List of Roles" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/api_2.png></a></p><p>We should also be able to query the list of API versions at the path <code>/api</code>:</p><p><a href=#R-image-0ad8c52cde8033e3d0b31c19b58b62c0 class=lightbox-link><img alt="List of API Versions" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/api_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0ad8c52cde8033e3d0b31c19b58b62c0><img alt="List of API Versions" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/api_3.png></a></p><p>Finally, we should also check and make sure our Open API documentation at the <code>/docs</code> path is up to date and includes the new routes:</p><p><a href=#R-image-b9ac12db6c84b152b4681db9c3d240a2 class=lightbox-link><img alt="API Documentation" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/api_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b9ac12db6c84b152b4681db9c3d240a2><img alt="API Documentation" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/api_4.png></a></p><p><a href=#R-image-b0363f32d3cb34a952a28a0e05c5fcb2 class=lightbox-link><img alt="Roles Documentation" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/api_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b0363f32d3cb34a952a28a0e05c5fcb2><img alt="Roles Documentation" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/api_5.png></a></p><p>There! This gives us a platform to build our new API upon. We&rsquo;ll continue throughout this example project to add additional routes to the API as well as related unit tests.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=unit-testing>Unit Testing</h1><a href="https://www.youtube.com/watch?v=0jqhrmsuny0">YouTube Video</a><h2 id=testing-web-apis>Testing Web APIs</h2><p>Now that we have created our first route in our RESTful API, we can start to write unit tests that will confirm our API works as intended. Adding unit testing early in the development process makes it much easier to keep up with unit tests as new features are added or even explore <a href=https://en.wikipedia.org/wiki/Test-driven_development rel=external target=_blank>test-driven development</a>!</p><p>There are many libraries that can be used to unit test a RESTful API using Node.js and Express. For this project, we&rsquo;re going to use a number of testing libraries:</p><ul><li><a href=https://www.npmjs.com/package/mocha rel=external target=_blank>mocha</a> - Node.js testing framework</li><li><a href=https://www.npmjs.com/package/chai rel=external target=_blank>chai</a> - assertion library</li><li><a href=https://www.npmjs.com/package/supertest rel=external target=_blank>supertest</a> - HTTP request testing framework</li><li><a href=https://www.npmjs.com/package/ajv rel=external target=_blank>ajv</a> - JSON schema validator</li><li><a href=https://www.npmjs.com/package/chai-json-schema-ajv rel=external target=_blank>chai-json-schema-ajv</a> - chai plugin for AJV</li><li><a href=https://www.npmjs.com/package/chai-shallow-deep-equal rel=external target=_blank>chai-shallow-deep-equal</a> - chai plugin for deep equal assertion</li></ul><p>To begin, let&rsquo;s install these libraries as development dependencies in our project using <code>npm</code>:</p><div class=tab-panel data-tab-group=e7d9cf5c43857b99a4952129f576ee03><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e7d9cf5c43857b99a4952129f576ee03","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install --save-dev mocha chai supertest ajv chai-json-schema-ajv chai-shallow-deep-equal</span></span></code></pre></div></div></div></div></div><p>Now that we have those libraries in place, let&rsquo;s make a few modifications to our project configuration to make testing more convenient.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> ESLint Plugin</div><div class=box-content><p>To help with formatting and highlighting of our unit tests, we should update the content of our <code>eslint.config.js</code> to recognize items from <code>mocha</code> as follows:</p><div class=tab-panel data-tab-group=1803f5afd904d7991494e8326b9b60da><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=eslintconfigjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1803f5afd904d7991494e8326b9b60da","eslintconfigjs")'>
<span class=tab-nav-text>eslint.config.js</span></button></div><div class=tab-content-container><div data-tab-item=eslintconfigjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>globals</span> <span class=nx>from</span> <span class=s2>&#34;globals&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>pluginJs</span> <span class=nx>from</span> <span class=s2>&#34;@eslint/js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** @type {import(&#39;eslint&#39;).Linter.Config[]} */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>languageOptions</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>globals</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>...</span><span class=nx>globals</span><span class=p>.</span><span class=nx>node</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>        <span class=p>...</span><span class=nx>globals</span><span class=p>.</span><span class=nx>mocha</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>rules</span><span class=o>:</span> <span class=p>{</span> <span class=s2>&#34;no-unused-vars&#34;</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;error&#34;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>argsIgnorePattern</span><span class=o>:</span> <span class=s2>&#34;next&#34;</span> <span class=p>}]</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>pluginJs</span><span class=p>.</span><span class=nx>configs</span><span class=p>.</span><span class=nx>recommended</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>];</span></span></span></code></pre></div></div></div></div></div><p>If working properly, this should also fix any errors visible in VS Code using the ESLint plugin!</p></div></div><h2 id=mocha-root-hooks>Mocha Root Hooks</h2><p>In testing frameworks such as <code>mocha</code>, we can create <code>hooks</code> that contain actions that should be taken before each test is executed in a file. The <code>mocha</code> framework also has <a href=https://mochajs.org/#root-hook-plugins rel=external target=_blank>root-level hooks</a> that are actions to be taken before each and every test in every file. We can use a root-level hook to manage setting up a simple database for unit testing, as well as configuring other aspects of our application for testing.</p><p>First, let&rsquo;s create a new <code>test</code> directory in our <code>server</code> folder, and inside of that we&rsquo;ll create a file <code>hooks.js</code> to contain the testing hooks for our application.</p><div class=tab-panel data-tab-group=b844c1cf141d7e8d1d7af522fa18b44b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testhooksjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b844c1cf141d7e8d1d7af522fa18b44b","testhooksjs")'>
<span class=tab-nav-text>test/hooks.js</span></button></div><div class=tab-content-container><div data-tab-item=testhooksjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Root Mocha Hooks
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports mochaHooks A Mocha Root Hooks Object
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load environment (must be first)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>dotenvx</span> <span class=nx>from</span> <span class=s2>&#34;@dotenvx/dotenvx&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>dotenvx</span><span class=p>.</span><span class=nx>config</span><span class=p>({</span><span class=nx>path</span><span class=o>:</span> <span class=s2>&#34;.env.test&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;../configs/database.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>migrations</span> <span class=nx>from</span> <span class=s1>&#39;../configs/migrations.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>seeds</span> <span class=nx>from</span> <span class=s1>&#39;../configs/seeds.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Root Hook Runs Before Each Test
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>mochaHooks</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Hook runs once before any tests are executed
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>beforeAll</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Test database connection
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>database</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Run migrations
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>migrations</span><span class=p>.</span><span class=nx>up</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span> 
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// Hook runs before each individual test
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>beforeEach</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Seed the database
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>seeds</span><span class=p>.</span><span class=nx>up</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Hook runs after each individual test
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>afterEach</span><span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Remove all data from the database
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>seeds</span><span class=p>.</span><span class=nx>down</span><span class=p>({</span><span class=nx>to</span><span class=o>:</span> <span class=mi>0</span><span class=p>}).</span><span class=nx>then</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>This file contains three hooks. First, the <code>beforeAll</code> hook, which is executed once before any tests are executed, is used to migrate the database. Then, we have the <code>beforeEach()</code> hook, which is executed before each individual test, which will seed the database with some sample data for us to use in our unit tests. Finally, we have an <code>afterEach()</code> hook that will remove any data from the database by undoing all of the seeds, which will truncate each table in the database.</p><p>Notice at the top that we are also loading our environment from a new environment file, <code>.env.test</code>. This allows us to use a different environment configuration when we perform testing. So, let&rsquo;s create that file and populate it with the following content:</p><div class=tab-panel data-tab-group=f407bc51e15d9a4c0793c0cf34b2f3b4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=envtest class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f407bc51e15d9a4c0793c0cf34b2f3b4","envtest")'>
<span class=tab-nav-text>.env.test</span></button></div><div class=tab-content-container><div data-tab-item=envtest class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=nv>LOG_LEVEL</span><span class=o>=</span>error
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=m>3000</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_HOST</span><span class=o>=</span>http://localhost:3000
</span></span><span class=line><span class=cl><span class=nv>OPENAPI_VISIBLE</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=nv>DATABASE_FILE</span><span class=o>=</span>:memory:
</span></span><span class=line><span class=cl><span class=nv>SEED_DATA</span><span class=o>=</span>false</span></span></code></pre></div></div></div></div></div><p>Here, the two major changes are to switch the log level to <code>error</code> so that we only see errors in the log output, and also to switch the database file to <code>:memory:</code> - a special filename that tells SQLite to create an in-memory database that is excellent for testing.</p><p>At this point, we can start writing our unit tests.</p><h2 id=writing-basic-unit-tests>Writing Basic Unit Tests</h2><p>Let&rsquo;s start with a very simple case - the <code>/api</code> route we created earlier. This is a simple route that only has a single method and outputs a single item, but it already clearly demonstrates how complex unit testing can become.</p><p>For these unit tests, we can create a file <code>api.js</code> in the <code>test</code> folder with the following content:</p><div class=tab-panel data-tab-group=a2bb21768e5ed06f286c5e0ac9ccf6ef><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a2bb21768e5ed06f286c5e0ac9ccf6ef","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s1>&#39;supertest&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;chai&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s1>&#39;chai-json-schema-ajv&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s1>&#39;chai-shallow-deep-equal&#39;</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiJsonSchemaAjv</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>verbose</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}))</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiShallowDeepEqual</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s1>&#39;../app.js&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Modify Object.prototype for BDD style assertions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>should</span><span class=p>()</span></span></span></code></pre></div></div></div></div></div><p>These lines will import the various libraries required for these unit tests. We&rsquo;ll explore how they work as we build the unit tests, but it is also recommended to read the documentation for each library (linked above) to better understand how each one works together in the various unit tests.</p><p>Now, let&rsquo;s write our first unit test, which can be placed right below those lines in the same file:</p><div class=tab-panel data-tab-group=4f011404fed80b148a5bfb4579d43d58><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4f011404fed80b148a5bfb4579d43d58","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all API versions
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllVersions</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should list all API versions&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s1>&#39;array&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;/api&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>This code looks quite a bit different than the code we&rsquo;ve been writing so far. This is because the <code>mocha</code> and <code>chai</code> libraries use the <a href=https://en.wikipedia.org/wiki/Behavior-driven_development rel=external target=_blank>Behavior-Driven Development</a>, or BDD, style for writing unit tests. The core idea is that the unit tests should be somewhat &ldquo;readable&rdquo; by anyone looking at the code. So, it defines functions such as <code>it</code> and <code>describe</code> that are used to structure the unit tests.</p><p>In this example, the <code>getAllVersions</code> function is a unit test function that uses the <code>request</code> library to send a request to our Express <code>app</code> at the <code>/api/</code> path. When the response is received from that request, we expect the HTTP status code to be 200, and the body of that request should be an array with a length of 1. Hopefully it is clear to see all of that just by reading the code in that function.</p><p>The other important concept is the special <code>done</code> function, which is provided as an argument to any unit test function that is testing <a href=https://mochajs.org/#asynchronous-code rel=external target=_blank>asynchronous code</a>. Because of the way asynchronous code is handled, the system cannot automatically determine when all promises have been returned. So, once we are done with the unit test and are not waiting for any further async responses, we need to call the <code>done()</code> method. Notice that we call that both at the end of the function, but also in the <code>if</code> statement that checks for any errors returned from the HTTP request.</p><p>Finally, at the bottom of the file, we have a few <code>describe</code> statements that actually build the structure that runs each unit test. When the tests are executed, only functions called inside of the <code>describe</code> statements will be executed.</p><h2 id=running-unit-tests>Running Unit Tests</h2><p>Now that we have created a simple unit test, let&rsquo;s run it using the <code>mocha</code> test framework. To do this, we&rsquo;ll add a new script to the <code>package.json</code> file with all of the appropriate options:</p><div class=tab-panel data-tab-group=f5f531fae8f73366cd5556dc09ae2c91><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f5f531fae8f73366cd5556dc09ae2c91","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;nodemon ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;lint&#34;</span><span class=p>:</span> <span class=s2>&#34;npx eslint --fix .&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;format&#34;</span><span class=p>:</span> <span class=s2>&#34;npx prettier . --write&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;test&#34;</span><span class=p>:</span> <span class=s2>&#34;mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Here, we are using the <code>mocha</code> command with many options:</p><ul><li><code>--require test/hooks.js</code> - this requires the global hooks file to be used before each test</li><li><code>--recursive</code> - this will recursively look for any tests in subdirectories</li><li><code>--parallel</code> - this allows tests to run in parallel (this requires the SQLite in-memory database)</li><li><code>--timeout 2000</code> - this will stop any test if it runs for more than 2 seconds</li><li><code>--exit</code> - this forces Mocha to stop after all tests have finished</li></ul><p>So, now let&rsquo;s run our tests using that script:</p><div class=tab-panel data-tab-group=29a52ff6ffc47582a1d80214e28ea3c6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("29a52ff6ffc47582a1d80214e28ea3c6","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run test</span></span></code></pre></div></div></div></div></div><p>If everything is working correctly, we should get the following output:</p><div class=tab-panel data-tab-group=fabc887b4244694cc68ae0fdcea446eb><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fabc887b4244694cc68ae0fdcea446eb","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; lost-communities-solution@0.0.1 test
&gt; mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit

[dotenvx@1.34.0] injecting env (6) from .env.test

[dotenvx@1.34.0] injecting env (0) from .env.test
[dotenvx@1.34.0] injecting env (0) from .env

  /api
    GET /
      âœ” should list all API versions


  1 passing (880ms)</code></pre></div></div></div></div></div><p>Great! It looks like our test already passed!</p><p>Just to be sure, let&rsquo;s quickly modify our test to look for an array of size <code>2</code> so that it should fail:</p><div class=tab-panel data-tab-group=dab2659e518b14db0e88c0280aafeaaa><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("dab2659e518b14db0e88c0280aafeaaa","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all API versions
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllVersions</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should list all API versions&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s1>&#39;array&#39;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we run the tests, we should clearly see a failure report instead:</p><div class=tab-panel data-tab-group=0dc894a1eed0440f059f3522a30be0c7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0dc894a1eed0440f059f3522a30be0c7","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; lost-communities-solution@0.0.1 test
&gt; mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit

[dotenvx@1.34.0] injecting env (6) from .env.test

[dotenvx@1.34.0] injecting env (0) from .env.test
[dotenvx@1.34.0] injecting env (0) from .env

  /api
    GET /
      1) should list all API versions


  0 passing (910ms)
  1 failing

  1) /api
       GET /
         should list all API versions:

      Uncaught AssertionError: expected [ { version: &#39;1.0&#39;, url: &#39;/api/v1/&#39; } ] to have a length of 2 but got 1
      + expected - actual

      -1
      +2
      
      at Test.&lt;anonymous&gt; (file:///workspaces/lost-communities-solution/server/test/api.js:31:30)
      at Test.assert (node_modules/supertest/lib/test.js:172:8)
      at Server.localAssert (node_modules/supertest/lib/test.js:120:14)
      at Object.onceWrapper (node:events:638:28)
      at Server.emit (node:events:524:28)
      at emitCloseNT (node:net:2383:8)
      at process.processTicksAndRejections (node:internal/process/task_queues:89:21)</code></pre></div></div></div></div></div><p>Thankfully, anytime a test fails, we get a very clear and easy to follow error report that pinpoints exactly which line in the test failed, and how the assertion was not met.</p><p>Before moving on, let&rsquo;s update our test so that it should pass again.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=code-coverage>Code Coverage</h1><a href="https://www.youtube.com/watch?v=2Yl9zF6iz-U">YouTube Video</a><h2 id=code-coverage>Code Coverage</h2><p>It is often helpful to examine the <a href=https://en.wikipedia.org/wiki/Code_coverage rel=external target=_blank>code coverage</a> of our unit tests. Thankfully, there is an easy way to enable that in our project using the <a href=https://www.npmjs.com/package/c8 rel=external target=_blank>c8</a> library. So, we can start by installing it:</p><div class=tab-panel data-tab-group=31acdf2901ed41d726549919db6f7a96><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("31acdf2901ed41d726549919db6f7a96","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install --save-dev c8</span></span></code></pre></div></div></div></div></div><p>Once it is installed, we can simply add it to a new script in the <code>package.json</code> file that will run our tests with code coverage:</p><div class=tab-panel data-tab-group=cd853f58941e219c861746d0394a9db1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=packagejson class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cd853f58941e219c861746d0394a9db1","packagejson")'>
<span class=tab-nav-text>package.json</span></button></div><div class=tab-content-container><div data-tab-item=packagejson class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;start&#34;</span><span class=p>:</span> <span class=s2>&#34;LOG_LEVEL=http node ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;dev&#34;</span><span class=p>:</span> <span class=s2>&#34;nodemon ./bin/www&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;lint&#34;</span><span class=p>:</span> <span class=s2>&#34;npx eslint --fix .&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;format&#34;</span><span class=p>:</span> <span class=s2>&#34;npx prettier . --write&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;test&#34;</span><span class=p>:</span> <span class=s2>&#34;mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>    <span class=nt>&#34;cov&#34;</span><span class=p>:</span> <span class=s2>&#34;c8 --reporter=html --reporter=text mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=err>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>All we have to do is add the <code>c8</code> command with a few options in front of our existing <code>mocha</code> command.</p><p>Now, we can run our tests with code coverage using this script:</p><div class=tab-panel data-tab-group=d85d9ff9d69365c521fe743980dd55c0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d85d9ff9d69365c521fe743980dd55c0","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run cov</span></span></code></pre></div></div></div></div></div><p>This time, we&rsquo;ll see a bunch of additional output on the terminal</p><div class=tab-panel data-tab-group=5827a52577fecab2c03140e1d9edda19><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5827a52577fecab2c03140e1d9edda19","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>&gt; lost-communities-solution@0.0.1 cov
&gt; c8 --reporter=html --reporter=text mocha --require test/hooks.js --recursive --parallel --timeout 2000 --exit

[dotenvx@1.34.0] injecting env (6) from .env.test

[dotenvx@1.34.0] injecting env (0) from .env.test
[dotenvx@1.34.0] injecting env (0) from .env

  /api
    GET /
      âœ” should list all API versions


  1 passing (1s)

------------------------|---------|----------|---------|---------|-------------------------------------------
File                    | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                         
------------------------|---------|----------|---------|---------|-------------------------------------------
All files               |   93.53 |    83.33 |   55.55 |   93.53 |                                           
 server                 |   88.52 |       50 |     100 |   88.52 |                                           
  app.js                |   88.52 |       50 |     100 |   88.52 | 53-59                                     
 server/configs         |   91.86 |    47.36 |     100 |   91.86 |                                           
  database.js           |     100 |      100 |     100 |     100 |                                           
  logger.js             |   85.56 |    30.76 |     100 |   85.56 | 24-25,27-28,30-31,33-34,36-37,39-40,42-43 
  migrations.js         |     100 |      100 |     100 |     100 |                                           
  openapi.js            |   92.85 |    66.66 |     100 |   92.85 | 19-21                                     
  seeds.js              |     100 |      100 |     100 |     100 |                                           
 server/middlewares     |     100 |      100 |     100 |     100 |                                           
  request-logger.js     |     100 |      100 |     100 |     100 |                                           
 server/migrations      |   96.07 |      100 |      50 |   96.07 |                                           
  00_users.js           |   95.55 |      100 |      50 |   95.55 | 44-45                                     
  01_roles.js           |   94.91 |      100 |      50 |   94.91 | 57-59                                     
  02_counties.js        |   96.61 |      100 |      50 |   96.61 | 58-59                                     
  03_communities.js     |   96.61 |      100 |      50 |   96.61 | 58-59                                     
  04_metadata.js        |   96.66 |      100 |      50 |   96.66 | 88-90                                     
  05_documents.js       |   95.71 |      100 |      50 |   95.71 | 68-70                                     
 server/models          |     100 |      100 |     100 |     100 |                                           
  community.js          |     100 |      100 |     100 |     100 |                                           
  county.js             |     100 |      100 |     100 |     100 |                                           
  document.js           |     100 |      100 |     100 |     100 |                                           
  metadata.js           |     100 |      100 |     100 |     100 |                                           
  metadata_community.js |     100 |      100 |     100 |     100 |                                           
  metadata_document.js  |     100 |      100 |     100 |     100 |                                           
  models.js             |     100 |      100 |     100 |     100 |                                           
  role.js               |     100 |      100 |     100 |     100 |                                           
  user.js               |     100 |      100 |     100 |     100 |                                           
  user_role.js          |     100 |      100 |     100 |     100 |                                           
 server/routes          |   68.72 |      100 |     100 |   68.72 |                                           
  api.js                |     100 |      100 |     100 |     100 |                                           
  index.js              |   97.43 |      100 |     100 |   97.43 | 36                                        
  users.js              |    46.8 |      100 |     100 |    46.8 | 52-62,66-73,77-91,95-105,109-138          
 server/routes/api/v1   |   87.71 |      100 |     100 |   87.71 |                                           
  roles.js              |   87.71 |      100 |     100 |   87.71 | 48-54                                     
 server/seeds           |   95.09 |      100 |      50 |   95.09 |                                           
  00_users.js           |   96.36 |      100 |      50 |   96.36 | 54-55                                     
  01_roles.js           |   97.36 |      100 |      50 |   97.36 | 112-114                                   
  02_counties.js        |   95.83 |      100 |      50 |   95.83 | 47-48                                     
  03_communities.js     |   95.65 |      100 |      50 |   95.65 | 45-46                                     
  04_metadata.js        |   89.39 |      100 |      50 |   89.39 | 60-66                                     
  05_documents.js       |   94.82 |      100 |      50 |   94.82 | 56-58</code></pre></div></div></div></div></div><p>Right away we see that a large part of our application achieves 100% code coverage with a single unit test! This highlights both how tightly interconnected all parts of our application are (such that a single unit test exercises much of the code) but also that code coverage can be a very poor metric for unit test quality (seeing this result we might suspect our application is already well tested with just a single unit test).</p><p>We have also enabled the <code>html</code> reporter, so we can see similar results in a <code>coverage</code> folder that appears inside of our <code>server</code> folder. We can use various VS Code Extensions such as <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.live-server" rel=external target=_blank>Live Preview</a> to view that file in our web browser.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Port Conflict</div><div class=box-content><p>The Live Preview extension defaults to port 3000, so we recommend digging into the settings and changing the default port to something else before using it.</p></div></div><p><a href=#R-image-b7b2bf8c70bed8da144e409d81c134f4 class=lightbox-link><img alt="Coverage Example" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/coverage_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b7b2bf8c70bed8da144e409d81c134f4><img alt="Coverage Example" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/coverage_1.png></a></p><p>In either case, we can see that we&rsquo;ve already reached 100% coverage on our <code>routes/api.js</code> file. However, as we&rsquo;ll see in the next section, that doesn&rsquo;t always mean that we are done writing our unit tests.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=other-tests>Other Tests</h1><a href="https://www.youtube.com/watch?v=ENWHzaMXMMk">YouTube Video</a><h2 id=testing-for-other-issues>Testing for Other Issues</h2><p>Let&rsquo;s consider the scenario where our <code>routes/api.js</code> file was modified slightly to have some incorrect code in it:</p><div class=tab-panel data-tab-group=31fe2a9df67c0b6a9e7a1f497a966eef><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("31fe2a9df67c0b6a9e7a1f497a966eef","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>versoin</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/ver1/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>In this example, we have misspelled the <code>version</code> attribute, and also used an incorrect URL for that version of the API. Unfortunately, if we actually make that change to our code, our existing unit test will not catch either error!</p><p>So, let&rsquo;s look at how we can go about catching these errors and ensuring our unit tests are actually valuable.</p><h2 id=json-schemas>JSON Schemas</h2><p>First, it is often helpful to validate the schema of the JSON output by our API. To do that, we&rsquo;ve installed the <code>ajv</code> JSON schema validator and a <code>chai</code> plugin for using it in a unit test. So, in our <code>test/api.js</code> file, we can add a new test:</p><div class=tab-panel data-tab-group=ade7882d492ccd66dd05f342317ba401><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ade7882d492ccd66dd05f342317ba401","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check JSON Schema of API Versions
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllVersionsSchemaMatch</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;all API versions should match schema&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>schema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;array&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>items</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;object&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>required</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;version&#39;</span><span class=p>,</span> <span class=s1>&#39;url&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>properties</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>version</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;string&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>url</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;string&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>additionalProperties</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>jsonSchema</span><span class=p>(</span><span class=nx>schema</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;/api&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersionsSchemaMatch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>In this test, we create a JSON schema following the <a href=https://ajv.js.org/json-schema.html rel=external target=_blank>AJV Instructions</a> that defines the various attributes that should be present in the output. It is especially important to include the <code>additionalProperties: false</code> line, which helps prevent leaking any unintended attributes.</p><p>Now, when we run our tests, we should see that this test fails:</p><div class=tab-panel data-tab-group=35ceac2bf7a473879442cb1c61789109><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("35ceac2bf7a473879442cb1c61789109","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api
    GET /
      âœ” should list all API versions
      1) all API versions should match schema


  1 passing (1s)
  1 failing

  1) /api
       GET /
         all API versions should match schema:
     Uncaught AssertionError: expected [ { versoin: &#39;1.0&#39;, â€¦(1) } ] to match json-schema
[ { instancePath: &#39;/0&#39;, â€¦(7) } ]
      at Test.&lt;anonymous&gt; (file:///workspaces/lost-communities-solution/server/test/api.js:59:28)
...</code></pre></div></div></div></div></div><p>As we can see, the misspelled <code>version</code> attribute will not match the given schema, causing the test to fail! That shows the value of such a unit test in our code.</p><h2 id=protecting-attributes>Protecting Attributes</h2><p>Let&rsquo;s update our route to include the correct attributes, but also add an additional item that shouldn&rsquo;t be present in the output:</p><div class=tab-panel data-tab-group=c510050687cfa311bed913ed8cb39752><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c510050687cfa311bed913ed8cb39752","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/ver1/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>secure_data</span><span class=o>:</span> <span class=s2>&#34;This should not be shared!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>This is an example of <a href=https://owasp.org/API-Security/editions/2023/en/0xa3-broken-object-property-level-authorization/ rel=external target=_blank>Broken Object Properly Level Authorization</a>, one of the top 10 most common API security risks according to OWASP. Often our database models will include attributes that we don&rsquo;t want to expose to our users, so we want to make sure they aren&rsquo;t included in the output by accident.</p><p>If we run our test again, it should also fail:</p><div class=tab-panel data-tab-group=9aef571e422291e4625fbbf472885ae7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9aef571e422291e4625fbbf472885ae7","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api
    GET /
      âœ” should list all API versions
      1) all API versions should match schema


  1 passing (1s)
  1 failing

  1) /api
       GET /
         all API versions should match schema:
     Uncaught AssertionError: expected [ { version: &#39;1.0&#39;, â€¦(2) } ] to match json-schema
[ { instancePath: &#39;/0&#39;, â€¦(7) } ]
      at Test.&lt;anonymous&gt; (file:///workspaces/lost-communities-solution/server/test/api.js:59:28)
...</code></pre></div></div></div></div></div><p>However, if we remove the line <code>additionalProperties: false</code> from our JSON schema unit test, it will now succeed. So, it is always important for us to remember to include that line in all of our JSON schemas if we want to avoid this particular security flaw.</p><h2 id=checking-values>Checking Values</h2><p>However, we still have not caught our incorrect value in our API output:</p><div class=tab-panel data-tab-group=52ba41d25a8ebb5a91aa119f725f3f21><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("52ba41d25a8ebb5a91aa119f725f3f21","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/ver1/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>secure_data</span><span class=o>:</span> <span class=s2>&#34;This should not be shared!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>For this, we need to write one additional unit test to check the actual content of the output. For this, we&rsquo;ll use a deep equality plugin for <code>chai</code>:</p><div class=tab-panel data-tab-group=8c79d82209079c77175f4fd51849fa89><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8c79d82209079c77175f4fd51849fa89","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check API version exists in list
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>findVersion</span> <span class=o>=</span> <span class=p>(</span><span class=nx>version</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should contain specific version&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>foundVersion</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>v</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>v</span><span class=p>.</span><span class=nx>version</span> <span class=o>===</span> <span class=nx>version</span><span class=p>.</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>foundVersion</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;/api&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersionsSchemaMatch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;version: 1.0&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>version</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v1/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>findVersion</span><span class=p>(</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>The <code>findVersion</code> unit test will check the actual contents of the output received from the API and compare it to the <code>version</code> object that is provided as input. In our <code>describe</code> statements below, we can see how easy it is to define a simple version object that we can use to compare to the output.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Use the Source!</div><div class=box-content><p>One common mistake when writing these unit tests is to simply copy the object structure from the code that is being tested. This is considered <strong>bad practice</strong> since it virtually guarantee that any typos or mistakes are not caught. Instead, when constructing these unit tests, we should always go back to the original source document, typically a design document or API specification, and build our unit tests using that as a guide. This will ensure that our tests will actually catch things such as typos or missing data.</p></div></div><p>With that test in place, we should once again have a unit test that fails:</p><div class=tab-panel data-tab-group=4ff0bd49c72378a091be5240bb01e03c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4ff0bd49c72378a091be5240bb01e03c","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api
    GET /
      âœ” should list all API versions
      âœ” all API versions should match schema
    version: 1.0
      GET /
        1) should contain specific version


  2 passing (987ms)
  1 failing

  1) /api
       version: 1.0
         GET /
           should contain specific version:

      Uncaught AssertionError: Expected to have &#34;/api/v1/&#34; but got &#34;/api/ver1/&#34; at path &#34;/url&#34;.
      + expected - actual

       {
      -  &#34;url&#34;: &#34;/api/ver1/&#34;
      +  &#34;url&#34;: &#34;/api/v1/&#34;
         &#34;version&#34;: &#34;1.0&#34;
       }
      
      at Test.&lt;anonymous&gt; (file:///workspaces/lost-communities-solution/server/test/api.js:76:29)</code></pre></div></div></div></div></div><p>Thankfully, in the output we clearly see the error, and it is easy to go back to our original design document to correct the error in our code.</p><h2 id=reusing-tests>Reusing Tests</h2><p>While it may seem like we are using a very complex structure for these tests, there is actually a very important reason behind it. If done correctly, we can easily reuse most of our tests as we add additional data to the application.</p><p>Let&rsquo;s consider the scenario where we add a second API version to our output:</p><div class=tab-panel data-tab-group=8b044d06a3267671c333a7c6aac7eb61><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8b044d06a3267671c333a7c6aac7eb61","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v1/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v2/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>To fully test this, all we need to do is update the array size in the <code>getAllVersions</code> and add an additional <code>describe</code> statement for the new version:</p><div class=tab-panel data-tab-group=36cfb1e084d7929cb099c1dda89435e7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("36cfb1e084d7929cb099c1dda89435e7","testapijs")'>
<span class=tab-nav-text>test/api.js</span></button></div><div class=tab-content-container><div data-tab-item=testapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all API versions
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllVersions</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should list all API versions&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/api/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s1>&#39;array&#39;</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;/api&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllVersionsSchemaMatch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;version: 1.0&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>version</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v1/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>findVersion</span><span class=p>(</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;version: 2.0&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=kr>const</span> <span class=nx>version</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s2>&#34;/api/v2/&#34;</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>
</span></span><span class="line hl"><span class=cl>    <span class=nx>describe</span><span class=p>(</span><span class=s1>&#39;GET /&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>findVersion</span><span class=p>(</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div></div></div></div></div><p>With those minor changes, we see that our code now passes all unit tests:</p><div class=tab-panel data-tab-group=e2281491dc6320924a7a3a8e19eb622a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e2281491dc6320924a7a3a8e19eb622a","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api
    GET /
      âœ” should list all API versions
      âœ” all API versions should match schema
    version: 1.0
      GET /
        âœ” should contain specific version
    version: 2.0
      GET /
        âœ” should contain specific version</code></pre></div></div></div></div></div><p>By writing reusable functions for our unit tests, we can often deduplicate and simplify our code.</p><p>Before moving on, let&rsquo;s roll back our unit tests and the API to just have a single version. We should make sure all tests are passing before we move ahead!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=testing-roles>Testing Roles</h1><a href="https://www.youtube.com/watch?v=ClN_Vp3s5eA">YouTube Video</a><h2 id=unit-testing-roles-routes>Unit Testing Roles Routes</h2><p>Now that we&rsquo;ve created a basic unit test for the <code>/api</code> route, we can now expand on that to test our other existing route, the <code>/api/v1/roles</code> route. Once again, there is only one method inside of this route, the <strong>GET ALL</strong> method, so the unit tests should be similar between these two routes. The only difference here is this route is now reading from the database instead of just returning a static JSON array.</p><p>We can begin by creating a new <code>api</code> folder inside of the <code>test</code> folder, and then a <code>v1</code> folder inside of that, and finally a new <code>roles.js</code> file to contain our tests. By doing this, the path to our tests match the path to the routes themselves, making it easy to match up the tests with the associated routers.</p><p>Inside of that file, we can place the first unit test for the <code>roles</code> routes:</p><div class=tab-panel data-tab-group=c776bdba8e0ae7a9df250745951bf2dc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("c776bdba8e0ae7a9df250745951bf2dc","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api/v1/roles Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiJsonSchemaAjv</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>verbose</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiShallowDeepEqual</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../../../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Modify Object.prototype for BDD style assertions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>should</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all Roles
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllRoles</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should list all roles&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/roles route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllRoles</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Just like before, this unit test will simply send an HTTP GET request to the <code>/api/v1/roles</code> and expect to receive a response that contains an array of 7 elements, which matches the 7 roles defined in the <code>seeds/01_roles.js</code> file.</p><h2 id=adding-additional-formats-to-ajv>Adding Additional Formats to AJV</h2><p>Next, we can create a test to confirm that the structure of that response matches our expectation:</p><div class=tab-panel data-tab-group=f7bcbb11e5fc393f4f5da2a374ebb191><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f7bcbb11e5fc393f4f5da2a374ebb191","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check JSON Schema of Roles
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getRolesSchemaMatch</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;all roles should match schema&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>schema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;array&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>items</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>required</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>properties</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>id</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;number&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>role</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>additionalProperties</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>jsonSchema</span><span class=p>(</span><span class=nx>schema</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/roles route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllRoles</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>getRolesSchemaMatch</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>However, as we write that test, we might notice that the <code>createdAt</code> and <code>updatedAt</code> fields are just defined as strings, when really they should be storing a timestamp. Thankfully, the AJV Schema Validator has an extension called <a href=https://ajv.js.org/packages/ajv-formats.html rel=external target=_blank>AJV Formats</a> that adds many new formats we can use. So, let&rsquo;s install it as a development dependency using <code>npm</code>:</p><div class=tab-panel data-tab-group=b37b777c695a9efc6a240f6d8a6bccc9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b37b777c695a9efc6a240f6d8a6bccc9","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install --save-dev ajv-formats</span></span></code></pre></div></div></div></div></div><p>Then, we can add it to AJV at the top of our unit tests and use all of the additional types in the <a href=https://ajv.js.org/packages/ajv-formats.html rel=external target=_blank>AJV Formats</a> documentation in our tests:</p><div class=tab-panel data-tab-group=d37a1b0d36477d48709bc37de5fcd3f5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d37a1b0d36477d48709bc37de5fcd3f5","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api/v1/roles Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>Ajv</span> <span class=nx>from</span> <span class=s1>&#39;ajv&#39;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>addFormats</span> <span class=nx>from</span> <span class=s1>&#39;ajv-formats&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../../../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Configure Chai and AJV
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>ajv</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Ajv</span><span class=p>()</span>
</span></span><span class="line hl"><span class=cl><span class=nx>addFormats</span><span class=p>(</span><span class=nx>ajv</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiJsonSchemaAjv</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>ajv</span><span class=p>,</span> <span class=nx>verbose</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}));</span>
</span></span><span class="line hl"><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiShallowDeepEqual</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Modify Object.prototype for BDD style assertions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>should</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check JSON Schema of Roles
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getRolesSchemaMatch</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;all roles should match schema&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>schema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;array&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>items</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>required</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>properties</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>id</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;number&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nx>role</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span> <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;iso-date-time&#34;</span> <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;iso-date-time&#34;</span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>additionalProperties</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>jsonSchema</span><span class=p>(</span><span class=nx>schema</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now we can use the <code>iso-date-time</code> string format to confirm that the <code>createdAt</code> and <code>updatedAt</code> fields match the expected format. The <a href=https://ajv.js.org/packages/ajv-formats.html rel=external target=_blank>AJV Formats</a> package supports a number of helpful formats, such as <code>email</code>, <code>uri</code>, <code>uuid</code>, and more.</p><h2 id=testing-each-role>Testing Each Role</h2><p>Finally, we should also check that each role we expect to be included in the database is present and accounted for. We can write a single unit test function for this, but we&rsquo;ll end up calling it several times with different roles:</p><div class=tab-panel data-tab-group=5937946ba258226f712ac193cb7bdbad><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1rolesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5937946ba258226f712ac193cb7bdbad","testapiv1rolesjs")'>
<span class=tab-nav-text>test/api/v1/roles.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1rolesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check Role exists in list
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>findRole</span> <span class=o>=</span> <span class=p>(</span><span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should contain &#39;&#34;</span> <span class=o>+</span> <span class=nx>role</span><span class=p>.</span><span class=nx>role</span> <span class=o>+</span> <span class=s2>&#34;&#39; role&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>foundRole</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>role</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>foundRole</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>role</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/roles route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/roles&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllRoles</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>getRolesSchemaMatch</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// List of all expected roles in the application
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=p>[</span> 
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;manage_users&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;manage_documents&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;add_documents&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;manage_communities&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;add_communities&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;view_documents&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=o>:</span> <span class=mi>7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>role</span><span class=o>:</span> <span class=s2>&#34;view_communities&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span> <span class=p>(</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>findRole</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Here we are creating a simple array of roles, which looks similar to the one that is already present in our <code>seeds/01_roles.js</code> seed file, but importantly it is <strong>not copied from that file</strong>! Instead, we should go back to the original design documentation for this application, if any, and read the roles from there to make sure they are all correctly added to the database. In this case we don&rsquo;t have an original design document so we won&rsquo;t worry about that here.</p><p>With all of that in place, let&rsquo;s run our unit tests and confirm they are working:</p><div class=tab-panel data-tab-group=7a2417c5f431ecbffef248f8159376b4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7a2417c5f431ecbffef248f8159376b4","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run test</span></span></code></pre></div></div></div></div></div><p>If everything is correct, we should find the following in our output showing all tests are successful:</p><div class=tab-panel data-tab-group=cc075069416d7b028040e42cf586cec5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("cc075069416d7b028040e42cf586cec5","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api/v1/roles
    GET /
      âœ” should list all roles
      âœ” all roles should match schema
      âœ” should contain &#39;manage_users&#39; role
      âœ” should contain &#39;manage_documents&#39; role
      âœ” should contain &#39;add_documents&#39; role
      âœ” should contain &#39;manage_communities&#39; role
      âœ” should contain &#39;add_communities&#39; role
      âœ” should contain &#39;view_documents&#39; role
      âœ” should contain &#39;view_communities&#39; role</code></pre></div></div></div></div></div><p>There we go! We now have working unit tests for our roles. Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub before continuing. Below are a couple of important discussions on unit test structure and design that are highly recommended before continuing.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Unit Tests Based on Seed Data</div><div class=box-content><p>In this application, we are heavily basing our unit tests on the seed data we created in the <code>seeds</code> directory. This is a <strong>design choice</strong>, and there are many different ways to approach this in practice:</p><ul><li>Seed data for unit tests could be included as a hook that runs before each unit test</li><li>Unit tests could assume the database is completely blank and manually insert data as needed as part of the test</li><li>Different seed data files could be used for testing and production</li><li>A sample database file or connection could be used for testing instead of seed data</li></ul><p>In this case, we believe it makes sense for the application we are testing to have a number of pre-defined roles and users that are populated via seed data when the application is tested and when it is deployed, so we chose to build our unit tests based on the assumption that the existing seed data will be used. However, other application designs may require different testing strategies, so it is always important to consider which method will work best for a given application!</p></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Duplicated Unit Test Code</div><div class=box-content><p>A keen-eyed observer may notice that the three unit test functions in the <code>test/api.js</code> file are nearly identical to the functions included in the <code>test/api/v1/roles.js</code> file. This is usually the case in unit testing - there is often a large amount of repeated code used to test different parts of an application, especially a RESTful API like this one.</p><p>This leads to two different design options:</p><ul><li>Refactor the code to reduce duplication across unit tests, adding some complexity and interdependence between tests</li><li>Keep duplicated code to make unit tests more readable and independent of each other</li></ul><p>For this application, we will follow the second approach. We feel that unit tests are much more useful if the large majority of the test can be easily seen and understood in a single file. This also means that a change in one test method will not impact other tests, both for good and for bad. So, it may mean modifying and updating the entire test suite is a bit more difficult, but updating individual tests should be much simpler.</p><p>Again, this is a <strong>design choice</strong> that we feel is best for this application, and other applications may be better off with other structures. It is always important to consider these implications when writing unit tests for an application!</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=retrieve-all>Retrieve All</h1><a href="https://www.youtube.com/watch?v=DkYVNrXEgn8">YouTube Video</a><h2 id=users-routes>Users Routes</h2><p>Now that we have written and tested the routes for the <code>Role</code> model, let&rsquo;s start working on the routes for the <code>User</code> model. These routes will be much more complex, because we want the ability to add, update, and delete users in our database.</p><p>To do this, we&rsquo;ll create several RESTful routes, which pair HTTP verbs and paths to the various CRUD operations that can be performed on the database. Here is a general list of the actions we want to perform on most models in a RESTful API, based on their associated CRUD operation:</p><ul><li>Create New (HTTP POST)</li><li>Retrieve All / Retrieve One (HTTP GET)</li><li>Update One (HTTP PUT)</li><li>Delete One (HTTP DELETE)</li></ul><p>As we build this new API router, we&rsquo;ll see each one of these in action.</p><h2 id=retrieve-all-route>Retrieve All Route</h2><p>The first operation we&rsquo;ll look at is the <strong>retrieve all</strong> operation, which is one we&rsquo;re already very familiar with. To begin, we should start by copying the existing file at <code>routes/users.js</code> to <code>routes/api/v1/users.js</code> and modifying it a bit to contain this content:</p><div class=tab-panel data-tab-group=31b12371998b5b22da9ee6f32829eb99><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("31b12371998b5b22da9ee6f32829eb99","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Users router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: users
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Users Routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>User</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import logger
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets the list of users
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class="line hl"><span class=cl><span class=cm> * /api/v1/users:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: users list page
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets the list of all users in the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: the list of users
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               type: array
</span></span></span><span class=line><span class=cl><span class=cm> *               items:
</span></span></span><span class=line><span class=cl><span class=cm> *                 $ref: &#39;#/components/schemas/User&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findAll</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>users</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class="line hl"><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This is very similar to the code we included in our <code>roles</code> route. The major difference is that the <code>users</code> route will also output the list of roles assigned to the user. There is a lot of great information in the <a href=https://sequelize.org/docs/v6/core-concepts/assocs/#basics-of-queries-involving-associations rel=external target=_blank>Sequelize Documentation</a> for how to properly query associated records.</p><p>We&rsquo;ll also need to remove the line from our <code>app.js</code> file that directly imports and uses that router:</p><div class=tab-panel data-tab-group=9921e377e099be1a40b48459eee6972e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9921e377e099be1a40b48459eee6972e","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/index.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/users.js&#34;</span><span class=p>;</span> <span class=c1>// delete this line
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>apiRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/api.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Use routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/users&#34;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span> <span class=c1>// delete this line
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/api&#34;</span><span class=p>,</span> <span class=nx>apiRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Instead, we can now import and link the new router in our <code>routes/api.js</code> file:</p><div class=tab-panel data-tab-group=867795878a066b1ad26aa6490c84d85d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("867795878a066b1ad26aa6490c84d85d","routesapijs")'>
<span class=tab-nav-text>routes/api.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import v1 routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>rolesRouter</span> <span class=nx>from</span> <span class=s2>&#34;./api/v1/roles.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>usersRouter</span> <span class=nx>from</span> <span class=s2>&#34;./api/v1/users.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use v1 routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/v1/roles&#34;</span><span class=p>,</span> <span class=nx>rolesRouter</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/v1/users&#34;</span><span class=p>,</span> <span class=nx>usersRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Before moving on, let&rsquo;s run our application and make sure that the <code>users</code> route is working correctly:</p><div class=tab-panel data-tab-group=048b6c2084db671bedb88b116a86d9c9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("048b6c2084db671bedb88b116a86d9c9","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once it loads, we can navigate to the <code>/api/v1/users</code> URL to see the output:</p><p><a href=#R-image-856c861ad50b3eb81f69271889c1ccb0 class=lightbox-link><img alt="Retrieve All Ouptut" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/retrieveall_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-856c861ad50b3eb81f69271889c1ccb0><img alt="Retrieve All Ouptut" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/retrieveall_1.png></a></p><h2 id=retrieve-all-unit-tests>Retrieve All Unit Tests</h2><p>As we write each of these routes, we&rsquo;ll also explore the related unit tests. The first three unit tests for this route are very similar to the ones we wrote for the <code>roles</code> routes earlier, so we won&rsquo;t go into too much detail on these. As expected, we&rsquo;ll place all of the unit tests for the <code>users</code> routes in the <code>test/api/v1/users.js</code> file:</p><div class=tab-panel data-tab-group=bd857f9bf83cf401072b2ed33fc04e37><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bd857f9bf83cf401072b2ed33fc04e37","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api/v1/users Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Ajv</span> <span class=nx>from</span> <span class=s2>&#34;ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>addFormats</span> <span class=nx>from</span> <span class=s2>&#34;ajv-formats&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../../../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Configure Chai and AJV
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>ajv</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Ajv</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nx>addFormats</span><span class=p>(</span><span class=nx>ajv</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiJsonSchemaAjv</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>ajv</span><span class=p>,</span> <span class=nx>verbose</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiShallowDeepEqual</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Modify Object.prototype for BDD style assertions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>should</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// User Schema
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>userSchema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>required</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>properties</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;number&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>createdAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;iso-date-time&#34;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>updatedAt</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=o>:</span> <span class=s2>&#34;iso-date-time&#34;</span> <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=nx>roles</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;array&#34;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>items</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;object&#39;</span><span class=p>,</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>required</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=s1>&#39;role&#39;</span><span class=p>],</span>
</span></span><span class="line hl"><span class=cl>          <span class=nx>properties</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>              <span class=nx>id</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;number&#39;</span> <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>              <span class=nx>role</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;string&#39;</span> <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>          <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>additionalProperties</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get all Users
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getAllUsers</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should list all users&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check JSON Schema of Users
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getUsersSchemaMatch</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;all users should match schema&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>schema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;array&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>items</span><span class=o>:</span> <span class=nx>userSchema</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>jsonSchema</span><span class=p>(</span><span class=nx>schema</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check User exists in list
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>findUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should contain &#39;&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39; user&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>foundUser</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>foundUser</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// List of all expected users in the application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;contributor&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;manager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getAllUsers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>getUsersSchemaMatch</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>findUser</span><span class=p>(</span><span class=nx>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>The major difference to note is in the highlighted section, where we have to add some additional schema information to account for the <code>roles</code> associated attribute that is part of the <code>users</code> object. It is pretty self-explanatory; each object in the array has a set of attributes that match what we used in the unit test for the <code>roles</code> routes.</p><p>We also moved the schema for the <code>User</code> response object out of that unit test so we can reuse it in other unit tests, as we&rsquo;ll see later in this example.</p><p>However, we also should add a couple of additional unit tests to confirm that each user has the correct roles assigned, since that is a major part of the security and authorization mechanism we&rsquo;ll be building for this application. While we could do that as part of the <code>findUser</code> test, let&rsquo;s go ahead and add separate tests for each of these, which is helpful in debugging anything that is broken or misconfigured.</p><div class=tab-panel data-tab-group=8cfaf58e5bf775db4d9db42ed9f8e4f4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8cfaf58e5bf775db4d9db42ed9f8e4f4","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /api/v1/users Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span><span class=p>,</span> <span class=nx>expect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Ajv</span> <span class=nx>from</span> <span class=s2>&#34;ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>addFormats</span> <span class=nx>from</span> <span class=s2>&#34;ajv-formats&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check that User has correct number of roles
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>findUserCountRoles</span> <span class=o>=</span> <span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>count</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;user &#39;&#34;</span> <span class=o>+</span> <span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39; should have &#34;</span> <span class=o>+</span> <span class=nx>count</span> <span class=o>+</span> <span class=s2>&#34; roles&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>foundUser</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>username</span> <span class=o>===</span> <span class=nx>username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>foundUser</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>foundUser</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=nx>count</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Check that User has specific role
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>findUserConfirmRole</span> <span class=o>=</span> <span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;user &#39;&#34;</span> <span class=o>+</span> <span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39; should have &#39;&#34;</span> <span class=o>+</span> <span class=nx>role</span> <span class=o>+</span> <span class=s2>&#34;&#39; role&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>foundUser</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>username</span> <span class=o>===</span> <span class=nx>username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>foundUser</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>role</span> <span class=o>===</span> <span class=nx>role</span><span class=p>)).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// List of all users and expected roles
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>user_roles</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;manage_users&#34;</span><span class=p>,</span> <span class=s2>&#34;manage_documents&#34;</span><span class=p>,</span> <span class=s2>&#34;manage_communities&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;contributor&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;add_documents&#34;</span><span class=p>,</span> <span class=s2>&#34;add_communities&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;manager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;manage_documents&#34;</span><span class=p>,</span> <span class=s2>&#34;manage_communities&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;view_documents&#34;</span><span class=p>,</span> <span class=s2>&#34;view_communities&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=nx>user_roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// Check that user has correct number of roles
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>findUserCountRoles</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nx>username</span><span class=p>,</span> <span class=nx>u</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>u</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Check that user has each expected role
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>findUserConfirmRole</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nx>username</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This code uses an additional assertion, <code>expect</code>, from the <code>chai</code> library, so we have to import it at the top on the highlighted line. These two tests will confirm that the user has the expected number of roles, and also explicitly confirm that each user has each of the expected roles.</p><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Testing Arrays for Containment</div><div class=box-content><p>When writing unit tests that deal with arrays, it is always important to not only check that the array contains the correct elements, but also that it <strong>ONLY</strong> contains those elements and no additional elements. A great way to do this is to explicitly check each element the array should contain is present, and then <strong>also</strong> check the size of the array so that it can only contain those listed elements. Of course, this assumes that each element is only present once in the array!</p><p>If we aren&rsquo;t careful about how these unit tests are constructed, it is possible for arrays to contain additional items. In this case, it might mean that a user is assigned to more roles than they should be, which would be very bad for our application&rsquo;s security!</p></div></div><p>With all of these tests in place, let&rsquo;s go ahead and run them to confirm everything is working properly. Thankfully, with the <code>mocha</code> test runner, we can even specify a single file to run, as shown below:</p><div class=tab-panel data-tab-group=1beaed9c0f3fdb7f70255236a87d89f8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1beaed9c0f3fdb7f70255236a87d89f8","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run <span class=nb>test</span> test/api/v1/users.js</span></span></code></pre></div></div></div></div></div><p>If everything is correct, we should see that this file has 19 tests that pass:</p><div class=tab-panel data-tab-group=52bee10437094b1d7fea3bb0f232b101><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("52bee10437094b1d7fea3bb0f232b101","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>  /api/v1/users
    GET /
      âœ” should list all users
      âœ” all users should match schema
      âœ” should contain &#39;admin&#39; user
      âœ” should contain &#39;contributor&#39; user
      âœ” should contain &#39;manager&#39; user
      âœ” should contain &#39;user&#39; user
      âœ” user &#39;admin&#39; should have 3 roles
      âœ” user &#39;admin&#39; should have &#39;manage_users&#39; role
      âœ” user &#39;admin&#39; should have &#39;manage_documents&#39; role
      âœ” user &#39;admin&#39; should have &#39;manage_communities&#39; role
      âœ” user &#39;contributor&#39; should have 2 roles
      âœ” user &#39;contributor&#39; should have &#39;add_documents&#39; role
      âœ” user &#39;contributor&#39; should have &#39;add_communities&#39; role
      âœ” user &#39;manager&#39; should have 2 roles
      âœ” user &#39;manager&#39; should have &#39;manage_documents&#39; role
      âœ” user &#39;manager&#39; should have &#39;manage_communities&#39; role
      âœ” user &#39;user&#39; should have 2 roles
      âœ” user &#39;user&#39; should have &#39;view_documents&#39; role
      âœ” user &#39;user&#39; should have &#39;view_communities&#39; role


  19 passing (1s)</code></pre></div></div></div></div></div><p>Great! Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub before continuing.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=retrieve-one>Retrieve One</h1><a href="https://www.youtube.com/watch?v=VihnaPGzBz8">YouTube Video</a><h2 id=retrieve-one-route>Retrieve One Route</h2><p>Many RESTful web APIs also include the ability to retrieve a single object from a collection by providing the ID as a parameter to the route. So, let&rsquo;s go ahead and build that route in our application as well.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Unused in Practice</div><div class=box-content><p>While this route is an important part of many RESTful web APIs, it can often go unused since most frontend web applications will simply use the <strong>retrieve all</strong> endpoint to get a list of items, and then it will just cache that result and filter the list to show a user a single entry. However, there are some use cases where this route is extremely useful, so we&rsquo;ll go ahead and include it in our backend code anyway.</p></div></div><p>In our <code>routes/api/v1/users.js</code> file, we can add a new route to retrieve a single user based on the user&rsquo;s ID number:</p><div class=tab-panel data-tab-group=abd3a099ad6767f948f6a5f7d2785318><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("abd3a099ad6767f948f6a5f7d2785318","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gets a single user by ID
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/v1/users/{id}:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: get single user
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Gets a single user from the application
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     parameters:
</span></span></span><span class=line><span class=cl><span class=cm> *       - in: path
</span></span></span><span class=line><span class=cl><span class=cm> *         name: id
</span></span></span><span class=line><span class=cl><span class=cm> *         required: true
</span></span></span><span class=line><span class=cl><span class=cm> *         schema:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *         description: user ID
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: a user
</span></span></span><span class=line><span class=cl><span class=cm> *         content:
</span></span></span><span class=line><span class=cl><span class=cm> *           application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *             schema:
</span></span></span><span class=line><span class=cl><span class=cm> *               $ref: &#39;#/components/schemas/User&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/:id&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findByPk</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=c1>// if the user is not found, return an HTTP 404 not found status code
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span> <span class=o>===</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>404</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this route, we have included a new route parameter <code>id</code> in the path for the route, and we also documented that route parameter in the Open API documentation comment. We then use that <code>id</code> parameter, which will be stored as <code>req.params.id</code> by Express, in the <code>findByPk</code> method available in <a href=https://sequelize.org/docs/v6/core-concepts/model-querying-finders/ rel=external target=_blank>Sequelize</a>. We can even confirm that our new method appears correctly in our documentation by visiting the <code>/docs</code> route in our application:</p><p><a href=#R-image-2e729c7dc7ba8b82ff0703d03e9ab5ea class=lightbox-link><img alt="Retrieve One Route" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/retrieve_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2e729c7dc7ba8b82ff0703d03e9ab5ea><img alt="Retrieve One Route" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/retrieve_1.png></a></p><p>When we visit that route, we&rsquo;ll need to include the ID of the user to request in the path, as in <code>/api/v1/users/1</code>. If it is working correctly, we should see data for a single user returned in the browser:</p><p><a href=#R-image-eb53cf1bf0f647023c24799798d6d338 class=lightbox-link><img alt="Retrieve One Route" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/retrieve_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-eb53cf1bf0f647023c24799798d6d338><img alt="Retrieve One Route" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/retrieve_2.png></a></p><h2 id=retrieve-one-unit-tests>Retrieve One Unit Tests</h2><p>The unit tests for the route to retrieve a single object are nearly identical to the ones use for the retrieve all route. Since we have already verified that each user exists and has the correct roles, we may not need to be as particular when developing these tests.</p><div class=tab-panel data-tab-group=a3d22db01ab69036d545c86f53114b8a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a3d22db01ab69036d545c86f53114b8a","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get single user
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getSingleUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should get user &#39;&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Get single user check schema
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getSingleUserSchemaMatch</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;user &#39;&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39; should match schema&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>jsonSchema</span><span class=p>(</span><span class=nx>userSchema</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>getSingleUser</span><span class=p>(</span><span class=nx>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>getSingleUserSchemaMatch</span><span class=p>(</span><span class=nx>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>For these unit tests, we are once again simply checking that we can retrieve each individual user by ID, and also that the response matches the expected <code>userSchema</code> object we used in earlier tests.</p><p>However, these unit tests are only checking for the users that we expect the database to contain. What if we receive an ID parameter for a user that does not exist? We should also test that particular situation as well.</p><div class=tab-panel data-tab-group=00d27305d0f7ab982b8840582ecf8f12><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("00d27305d0f7ab982b8840582ecf8f12","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Tries to get a user using an invalid id
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>getSingleUserBadId</span> <span class=o>=</span> <span class=p>(</span><span class=nx>invalidId</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should return 404 when requesting user with id &#39;&#34;</span> <span class=o>+</span> <span class=nx>invalidId</span> <span class=o>+</span> <span class=s2>&#34;&#39;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>invalidId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>404</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>getSingleUser</span><span class=p>(</span><span class=nx>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>getSingleUserSchemaMatch</span><span class=p>(</span><span class=nx>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>getSingleUserBadId</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>getSingleUserBadId</span><span class=p>(</span><span class=s2>&#34;test&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>getSingleUserBadId</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>getSingleUserBadId</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>With this unit test, we can easily check that our API properly returns HTTP status code 404 for a number of invalid ID values, including <code>0</code>, <code>-1</code>, <code>"test"</code>, <code>5</code>, and any others we can think of to try.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=create>Create</h1><a href="https://www.youtube.com/watch?v=QWP3aGro9_M">YouTube Video</a><h2 id=create-route>Create Route</h2><p>Now that we&rsquo;ve explored the routes we can use to read data from our RESTful API, let&rsquo;s look at the routes we can use to modify that data. The first one we&rsquo;ll cover is the <strong>create</strong> route, which allows us to add a new entry to the database. However, before we do that, let&rsquo;s create some helpful utility functions that we can reuse throughout our application as we develop more advanced routes.</p><h3 id=success-messages>Success Messages</h3><p>One thing we&rsquo;ll want to be able to do is send some well-formatted success messages to the user. While we could include this in each route, it is a good idea to abstract this into a utility function that we can write once and use throughout our application. By doing so, it makes it easier to restructure these messages as needed in the future.</p><p>So, let&rsquo;s create a new <code>utilities</code> folder inside of our <code>server</code> folder, and then a new <code>send-success.js</code> file with the following content:</p><div class=tab-panel data-tab-group=26f9e140bc4e14069baed7b0fc1b95c9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=utilitiessend-successjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("26f9e140bc4e14069baed7b0fc1b95c9","utilitiessend-successjs")'>
<span class=tab-nav-text>utilities/send-success.js</span></button></div><div class=tab-content-container><div data-tab-item=utilitiessend-successjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Sends JSON Success Messages
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports sendSuccess a function to send JSON Success Messages
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Send JSON Success Messages
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} message - the message to send
</span></span></span><span class=line><span class=cl><span class=cm> * @param {integer} status - the HTTP status to use
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   responses:
</span></span></span><span class=line><span class=cl><span class=cm> *     Success:
</span></span></span><span class=line><span class=cl><span class=cm> *       description: success
</span></span></span><span class=line><span class=cl><span class=cm> *       content:
</span></span></span><span class=line><span class=cl><span class=cm> *         application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *           schema:
</span></span></span><span class=line><span class=cl><span class=cm> *             type: object
</span></span></span><span class=line><span class=cl><span class=cm> *             required:
</span></span></span><span class=line><span class=cl><span class=cm> *               - message
</span></span></span><span class=line><span class=cl><span class=cm> *               - id
</span></span></span><span class=line><span class=cl><span class=cm> *             properties:
</span></span></span><span class=line><span class=cl><span class=cm> *               message:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                 description: the description of the successful operation
</span></span></span><span class=line><span class=cl><span class=cm> *               id:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *                 description: the id of the saved or created item
</span></span></span><span class=line><span class=cl><span class=cm> *             example:
</span></span></span><span class=line><span class=cl><span class=cm> *               message: User successfully saved!
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>sendSuccess</span><span class=p>(</span><span class=nx>message</span><span class=p>,</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>status</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=nx>status</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>message</span><span class=o>:</span> <span class=nx>message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>sendSuccess</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>In this file, we are defining a <strong>success</strong> message from our application as a JSON object with a <code>message</code> attribute, as well as the <code>id</code> of the object that was acted upon. The code itself is very straightforward, but we are including the appropriate Open API documentation as well, which we can reuse in our routes elsewhere.</p><p>To make the Open API library aware of these new files, we need to add it to our <code>configs/openapi.js</code> file:</p><div class=tab-panel data-tab-group=8b0976b13b6bbf71f8dd6d3a055e3453><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsopenapijs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8b0976b13b6bbf71f8dd6d3a055e3453","configsopenapijs")'>
<span class=tab-nav-text>configs/openapi.js</span></button></div><div class=tab-content-container><div data-tab-item=configsopenapijs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>definition</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>openapi</span><span class=o>:</span> <span class=s2>&#34;3.1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>info</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>title</span><span class=o>:</span> <span class=s2>&#34;Lost Communities&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span><span class=o>:</span> <span class=s2>&#34;0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>description</span><span class=o>:</span> <span class=s2>&#34;Kansas Lost Communities Project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>servers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>url</span><span class=o>:</span> <span class=nx>url</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>apis</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;./routes/*.js&#34;</span><span class=p>,</span> <span class=s2>&#34;./models/*.js&#34;</span><span class=p>,</span> <span class=s2>&#34;./routes/api/v1/*.js&#34;</span><span class=p>,</span> <span class=s2>&#34;./utilities/*.js&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div></div></div></div><h3 id=validation-error-messages>Validation Error Messages</h3><p>Likewise, we may also want to send a well-structured message anytime our database throws an error, or if any of our model validation steps fails. So, we can create another file <code>handle-validation-error.js</code> with the following content:</p><div class=tab-panel data-tab-group=a6dd2f092b59c92796bb8bd54eced4a8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=utilitieshandle-validation-errorjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a6dd2f092b59c92796bb8bd54eced4a8","utilitieshandle-validation-errorjs")'>
<span class=tab-nav-text>utilities/handle-validation-error.js</span></button></div><div class=tab-content-container><div data-tab-item=utilitieshandle-validation-errorjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Error handler for Sequelize Validation Errors
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports handleValidationError a handler for Sequelize validation errors
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Gracefully handle Sequelize Validation Errors
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {SequelizeValidationError} error - Sequelize Validation Error
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   responses:
</span></span></span><span class=line><span class=cl><span class=cm> *     Success:
</span></span></span><span class=line><span class=cl><span class=cm> *     ValidationError: 
</span></span></span><span class=line><span class=cl><span class=cm> *       description: model validation error
</span></span></span><span class=line><span class=cl><span class=cm> *       content:
</span></span></span><span class=line><span class=cl><span class=cm> *         application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *           schema:
</span></span></span><span class=line><span class=cl><span class=cm> *             type: object
</span></span></span><span class=line><span class=cl><span class=cm> *             required:
</span></span></span><span class=line><span class=cl><span class=cm> *               - error
</span></span></span><span class=line><span class=cl><span class=cm> *             properties:
</span></span></span><span class=line><span class=cl><span class=cm> *               error: 
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                 description: the description of the error
</span></span></span><span class=line><span class=cl><span class=cm> *               errors:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: array
</span></span></span><span class=line><span class=cl><span class=cm> *                 items:
</span></span></span><span class=line><span class=cl><span class=cm> *                    type: object
</span></span></span><span class=line><span class=cl><span class=cm> *                    required: 
</span></span></span><span class=line><span class=cl><span class=cm> *                      - attribute
</span></span></span><span class=line><span class=cl><span class=cm> *                      - message
</span></span></span><span class=line><span class=cl><span class=cm> *                    properties:
</span></span></span><span class=line><span class=cl><span class=cm> *                      attribute:
</span></span></span><span class=line><span class=cl><span class=cm> *                        type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                        description: the attribute that caused the error
</span></span></span><span class=line><span class=cl><span class=cm> *                      message:
</span></span></span><span class=line><span class=cl><span class=cm> *                        type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                        description: the error associated with that attribute
</span></span></span><span class=line><span class=cl><span class=cm> *             example:
</span></span></span><span class=line><span class=cl><span class=cm> *               error: Validation Error
</span></span></span><span class=line><span class=cl><span class=cm> *               errors:
</span></span></span><span class=line><span class=cl><span class=cm> *                 - attribute: username
</span></span></span><span class=line><span class=cl><span class=cm> *                   message: username must be unique
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>handleValidationError</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>errors</span><span class=o>?</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>errors</span> <span class=o>=</span> <span class=nx>error</span><span class=p>.</span><span class=nx>errors</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>map</span><span class=p>((</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{</span><span class=nx>attribute</span><span class=o>:</span> <span class=nx>e</span><span class=p>.</span><span class=nx>path</span><span class=p>,</span> <span class=nx>message</span><span class=o>:</span> <span class=nx>e</span><span class=p>.</span><span class=nx>message</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>422</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span> 
</span></span><span class=line><span class=cl>      <span class=nx>error</span><span class=o>:</span> <span class=s2>&#34;Validation Error&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>errors</span><span class=o>:</span> <span class=nx>errors</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>422</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>error</span><span class=o>:</span> <span class=nx>error</span><span class=p>.</span><span class=nx>parent</span><span class=p>.</span><span class=nx>message</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>handleValidationError</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>Again, the code for this is not too complex. It builds upon the structure in the <a href=https://sequelize.org/api/v7/classes/_sequelize_core.index.validationerror rel=external target=_blank>Sequelize ValidationError</a> class to create a helpful JSON object that includes both an <code>error</code> attribute as well as an optional <code>errors</code> array that lists each attribute with a validation error, if possible. We also include the appropriate Open API documentation for this response type.</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Trial & Error</div><div class=box-content><p>If we look at the code in the <code>handle-validation-error.js</code> file, it may seem like it came from nowhere, or it may be difficult to see how this was constructed based on what little is given in the Sequelize documentation.</p><p>In fact, this code was actually constructed using a trial and error process by iteratively submitting broken models and looking at the raw errors that were produced by Sequelize until a common structure was found. For the purposes of this example, we&rsquo;re leaving out some of these steps, but we encourage exploring the output to determine the best method for any given application.</p></div></div><h2 id=creating-a-new-user>Creating a New User</h2><p>Now that we have created helpers for our route, we can add the code to actually create that new user when an HTTP POST request is receive4d.</p><p>In our <code>routes/api/v1/users.js</code> file, let&rsquo;s add a new route we can use to create a new entry in the <code>users</code> table:</p><div class=tab-panel data-tab-group=06e05eacb0653a7c7ae36bf5286f44a4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("06e05eacb0653a7c7ae36bf5286f44a4","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ValidationError</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;sequelize&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../../../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import database
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s2>&#34;../../../configs/database.js&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import utilities
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>handleValidationError</span> <span class=nx>from</span> <span class=s2>&#34;../../../utilities/handle-validation-error.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>sendSuccess</span> <span class=nx>from</span> <span class=s2>&#34;../../../utilities/send-success.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Create a new user
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/v1/users:
</span></span></span><span class=line><span class=cl><span class=cm> *   post:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: create user
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     requestBody:
</span></span></span><span class=line><span class=cl><span class=cm> *       description: user
</span></span></span><span class=line><span class=cl><span class=cm> *       required: true
</span></span></span><span class=line><span class=cl><span class=cm> *       content:
</span></span></span><span class=line><span class=cl><span class=cm> *         application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *           schema:
</span></span></span><span class=line><span class=cl><span class=cm> *             $ref: &#39;#/components/schemas/User&#39;
</span></span></span><span class=line><span class=cl><span class=cm> *           example:
</span></span></span><span class=line><span class=cl><span class=cm> *             username: newuser
</span></span></span><span class=line><span class=cl><span class=cm> *             roles:
</span></span></span><span class=line><span class=cl><span class=cm> *               - id: 6
</span></span></span><span class=line><span class=cl><span class=cm> *               - id: 7
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       201:
</span></span></span><span class=line><span class=cl><span class=cm> *         $ref: &#39;#/components/responses/Success&#39;
</span></span></span><span class=line><span class=cl><span class=cm> *       422:
</span></span></span><span class=line><span class=cl><span class=cm> *         $ref: &#39;#/components/responses/ValidationError&#39;         
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Use a database transaction to roll back if any errors are thrown
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>await</span> <span class=nx>database</span><span class=p>.</span><span class=nx>transaction</span><span class=p>(</span><span class=kr>async</span> <span class=nx>t</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Build the user object using body attributes
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>username</span><span class=o>:</span> <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Assign to a database transaction
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>transaction</span><span class=o>:</span> <span class=nx>t</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=c1>// If roles are included in the body
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>roles</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find all roles listed
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=kr>await</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>map</span><span class=p>(({</span> <span class=nx>id</span><span class=p>,</span> <span class=p>...</span><span class=nx>next</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>Role</span><span class=p>.</span><span class=nx>findByPk</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// Attach roles to user
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>await</span> <span class=nx>user</span><span class=p>.</span><span class=nx>setRoles</span><span class=p>(</span><span class=nx>roles</span><span class=p>,</span> <span class=p>{</span> <span class=nx>transaction</span><span class=o>:</span> <span class=nx>t</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>      <span class=c1>// Send the success message
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>sendSuccess</span><span class=p>(</span><span class=s2>&#34;User saved!&#34;</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=mi>201</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>error</span> <span class=k>instanceof</span> <span class=nx>ValidationError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>handleValidationError</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>At the top of the file, we have added several additional import statements:</p><ul><li><code>ValidationError</code> - we import the <code>ValidationError</code> type from the Sequelize library</li><li><code>database</code> - we import our Sequelize instance from <code>configs/database.js</code> so we can create a transaction</li><li><code>handleValidationError</code> and <code>sendSuccess</code> - we import our two new utilities from the <code>utilities</code> folder</li></ul><p>This route itself is quite a bit more complex that our previous routes, so let&rsquo;s break down what it does piece by piece to see how it all works together.</p><ol><li>Start a database transaction</li></ol><div class=tab-panel data-tab-group=2d18bbc8141d55bbe94abf934127985e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2d18bbc8141d55bbe94abf934127985e","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>await</span> <span class=nx>database</span><span class=p>.</span><span class=nx>transaction</span><span class=p>(</span><span class=kr>async</span> <span class=nx>t</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// perform database operations here
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>First, since we will be updating the database using multiple steps, we should use a <a href=https://en.wikipedia.org/wiki/Database_transaction rel=external target=_blank>database transaction</a> to ensure that we only update the database if all operations will succeed. So, we use the <a href=https://sequelize.org/docs/v6/other-topics/transactions/ rel=external target=_blank>Sequelize Transactions</a> feature to create a new managed database transaction. If we successfully reach the end of the block of code contained in this statement, the database transaction will be <em>committed</em> to the database and the changes will be stored.</p><ol start=2><li>Create the <code>User</code> itself</li></ol><div class=tab-panel data-tab-group=8e07dae6b7a98f74a1074e234cf68ab4><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("8e07dae6b7a98f74a1074e234cf68ab4","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Build the user object using body attributes
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>username</span><span class=o>:</span> <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Assign to a database transaction
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>transaction</span><span class=o>:</span> <span class=nx>t</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Next, we use the <code>User</code> model to create a new instance of the user and store it in the database. The <a href=https://sequelize.org/docs/v6/core-concepts/model-instances/#a-very-useful-shortcut-the-create-method rel=external target=_blank>Sequelize Create</a> method will both build the new object in memory as well as save it to the database. This is an asynchronous process, so we must <code>await</code> the result before moving on. We also must give this method a reference to the current database transaction <code>t</code> in the second parameter.</p><ol start=3><li>Associate Roles</li></ol><div class=tab-panel data-tab-group=84f966bb310d9606dd13acd076b2e074><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("84f966bb310d9606dd13acd076b2e074","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// If roles are included in the body
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>roles</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find all roles listed
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=kr>await</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>map</span><span class=p>(({</span> <span class=nx>id</span><span class=p>,</span> <span class=p>...</span><span class=nx>next</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>Role</span><span class=p>.</span><span class=nx>findByPk</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}),</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// Attach roles to user
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>await</span> <span class=nx>user</span><span class=p>.</span><span class=nx>setRoles</span><span class=p>(</span><span class=nx>roles</span><span class=p>,</span> <span class=p>{</span> <span class=nx>transaction</span><span class=o>:</span> <span class=nx>t</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>After that, we check to see if the <code>roles</code> attribute was provided as part of the body of the HTTP POST method. If it was, we need to associate those roles with the new user. Here, we are assuming that the submission includes the ID for each role at a minimum, but it may also include other data such as the name of the role. So, before doing anything else, we must first find each <code>Role</code> model in the database by ID using the <code>findByPk</code> method. Once we have a list of roles, then we can add those roles to the <code>User</code> object using the special <code>setRoles</code> method that is created as part of the <code>Roles</code> association on that model. If any roles are null and can&rsquo;t be found, this will throw an error that we can catch later.</p><ol start=4><li>Send Success Messages</li></ol><div class=tab-panel data-tab-group=bc91bfa809117d9d781ccefa32597df7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bc91bfa809117d9d781ccefa32597df7","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl>      <span class=c1>// Send the success message
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>sendSuccess</span><span class=p>(</span><span class=s2>&#34;User saved!&#34;</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=mi>201</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span></span></span></code></pre></div></div></div></div></div><p>Finally, if everything is correct, we can send the success message back to the user using the <code>sendSuccess</code> utility method that we created earlier.</p><ol start=5><li>Handle Exceptions</li></ol><div class=tab-panel data-tab-group=bc21343538fe7e68c0e3a20ebd64e800><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("bc21343538fe7e68c0e3a20ebd64e800","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>error</span> <span class=k>instanceof</span> <span class=nx>ValidationError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>handleValidationError</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Finally, at the bottom of the file we have a <code>catch</code> block that will catch any exceptions thrown while trying to create our <code>User</code> and associate the correct <code>Role</code> objects. Notice that this <code>catch</code> block is <strong>outside</strong> the database transaction, so any database changes will not be saved if we reach this block of code.</p><p>Inside, we check to see if the error is an instance of the <code>ValidationError</code> class from Sequelize. If so, we can use our new <code>handleValidationError</code> method to process that error and send a well-structured JSON response back to the user about the error. If not, we&rsquo;ll simply log the error and send back a generic HTTP 500 response code.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=testing-create>Testing Create</h1><a href="https://www.youtube.com/watch?v=37eMKTRxQi4">YouTube Video</a><h2 id=manual-testing-with-open-api>Manual Testing with Open API</h2><p>Before we start unit testing this route, let&rsquo;s quickly do some manual testing using the Open API documentation site. It is truly a very handy way to work with our RESTful APIs as we are developing them, allowing us to test them quickly in isolation to make sure everything is working properly.</p><p>So, let&rsquo;s start our server:</p><div class=tab-panel data-tab-group=359eec29847a72987f48df0238f8443e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("359eec29847a72987f48df0238f8443e","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once it starts, we can navigate to the <code>/docs</code> URL, and we should see the Open API documentation for our site, including a new <code>POST</code> route for the <code>users</code> section:</p><p><a href=#R-image-03d9aeaf692a13a4beb4ff816e9443c9 class=lightbox-link><img alt="Create API Documentation" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/create_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-03d9aeaf692a13a4beb4ff816e9443c9><img alt="Create API Documentation" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/create_1.png></a></p><p>If we documented our route correctly, we can see that this documentation includes not only an example for what a new submission should look like, but also examples of the <strong>success</strong> and <strong>model validation error</strong> outputs should be. To test it, we can use the <strong>Try it out</strong> button on the page to try to create a new user.</p><p><a href=#R-image-23086ee2b970c503490fcd28a3a69a61 class=lightbox-link><img alt="Create Example" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/create_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-23086ee2b970c503490fcd28a3a69a61><img alt="Create Example" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/create_2.png></a></p><p>Let&rsquo;s go ahead and try to create the user that is suggested by our example input, which should look like this:</p><div class=tab-panel data-tab-group=7cfa46a1d93ac008d7550d9d1a2118be><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=input class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7cfa46a1d93ac008d7550d9d1a2118be","input")'>
<span class=tab-nav-text>input</span></button></div><div class=tab-content-container><div data-tab-item=input class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;newuser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;roles&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>This would create a user with the username <code>newuser</code> and assign them to the roles with IDs 6 (<code>view_documents</code>) and 7 (<code>view_communities</code>). So, we can click the <strong>Execute</strong> button to send that request to the server and see if it works.</p><p><a href=#R-image-fb8e4fe47c4d5953439ebd372a871a41 class=lightbox-link><img alt="Create Success" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/create_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fb8e4fe47c4d5953439ebd372a871a41><img alt="Create Success" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/create_3.png></a></p><p>Excellent! We can see that it worked correctly, and we received our expected success message as part of the response. We can also scroll up and try the <code>GET /api/v1/users</code> API endpoint to see if that user appears in our list of all users in the system with the correct roles assigned. If we do, we should see this in the output:</p><div class=tab-panel data-tab-group=b0d863917e0e26e1a51b38268206e51d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b0d863917e0e26e1a51b38268206e51d","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;newuser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;createdAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-21T18:34:54.725Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;updatedAt&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-02-21T18:34:54.725Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;roles&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;view_documents&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;view_communities&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>From here, we can try a couple of different scenarios to see if our server is working properly.</p><h3 id=duplicate-username>Duplicate Username</h3><p>First, what if we try and create a user with a duplicate username? To test this, we can simply resubmit the default example again and see what happens. This time, we get an HTTP 422 response code with a very detailed error message:</p><p><a href=#R-image-f9fb70e5b3acaf723f431727bcda1528 class=lightbox-link><img alt="Create Failure - Duplicate Username" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/create_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f9fb70e5b3acaf723f431727bcda1528><img alt="Create Failure - Duplicate Username" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/create_4.png></a></p><p>This is great! It tells us exactly what the error is. This is the output created by our <code>handleValidationError</code> utility function from the previous page.</p><h3 id=missing-attributes>Missing Attributes</h3><p>We can also try to submit a new user, but this time we can accidentally leave out some of the attributes, as in this example:</p><div class=tab-panel data-tab-group=da9348284def8247d5ee41520374e114><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=input class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("da9348284def8247d5ee41520374e114","input")'>
<span class=tab-nav-text>input</span></button></div><div class=tab-content-container><div data-tab-item=input class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;user&#34;</span><span class=p>:</span> <span class=s2>&#34;testuser&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>Here, we have mistakenly renamed the <code>username</code> attribute to just <code>user</code>, and we&rsquo;ve left off the <code>roles</code> list entirely. When we submit this, we also get a helpful error message:</p><p><a href=#R-image-56c6262dab629af33cd51fef856744ff class=lightbox-link><img alt="Create Failure - Username Null" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/create_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-56c6262dab629af33cd51fef856744ff><img alt="Create Failure - Username Null" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/create_5.png></a></p><p>Since the <code>username</code> attribute was not provided, it will be set to <code>null</code> and the database will not allow a <code>null</code> value for that attribute.</p><p>However, if we correct that, we do see that it will accept a new user without any listed roles! This is by design, since we may need to create users that don&rsquo;t have any roles assigned.</p><h3 id=invalid-roles>Invalid Roles</h3><p>Finally, what if we try to create a user with an invalid list of roles:</p><div class=tab-panel data-tab-group=6852f939488cf9d799d1d5745977c456><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=input class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6852f939488cf9d799d1d5745977c456","input")'>
<span class=tab-nav-text>input</span></button></div><div class=tab-content-container><div data-tab-item=input class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;baduser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;roles&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div></div></div></div><p>In this instance, we&rsquo;ll get another helpful error message:</p><p><a href=#R-image-6ddb03b315ce4eb1d1c4197f0e2dd08d class=lightbox-link><img alt="Create Failure - Role Null" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/03/create_6.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6ddb03b315ce4eb1d1c4197f0e2dd08d><img alt="Create Failure - Role Null" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/03/create_6.png></a></p><p>Since there is no role with ID 8 in the database, it finds a <code>null</code> value instead and tries to associate that with our user. This causes an SQL constraint error, which we can send back to our user.</p><p>Finally, we should also double-check that our user <code>baduser</code> was not created using <code>GET /api/v1/users</code> API endpoint above. This is because we don&rsquo;t want to create that user unless a list of valid roles are also provided.</p><h2 id=unit-testing>Unit Testing</h2><p>Now that we have a good handle on how this endpoint works in practice, let&rsquo;s write some unit tests to confirm that it works as expected in each of these cases. First, we should have a simple unit test that successfully creates a new user:</p><div class=tab-panel data-tab-group=e437ece968d587ce3fd18da53de665ee><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e437ece968d587ce3fd18da53de665ee","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Creates a user successfully
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>createUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should successfully create a user &#39;&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>201</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>created_id</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find user in list of all users
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>foundUser</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>created_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>foundUser</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// New user structure for creating users
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>new_user</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;test_user&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span><span class=o>:</span> <span class=mi>6</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span><span class=o>:</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;POST /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This first test is very straightforward since it just confirms that we can successfully create a new user in the system. It also confirms that the user now appears in the output from the <strong>get all</strong> route, which is helpful.</p><p>While this at least confirms that the route works as expected, we should write several more unit tests to confirm that the route works correctly even if the user provides invalid input.</p><h3 id=missing-attributes-1>Missing Attributes</h3><p>First, we should confirm that the user will be created even with the list of roles missing. We can do this just by creating a second <code>new_user</code> object that is missing the list of roles.</p><div class=tab-panel data-tab-group=e05c1c947ae7d0e5c3aafcc7c669aecf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e05c1c947ae7d0e5c3aafcc7c669aecf","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// New user structure for creating users without roles
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>new_user_no_roles</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;test_user_no_roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;POST /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user_no_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>We should also write a test to make sure the process will fail if any required attributes (in this case, just <code>username</code>) are missing. We can even check the output to make sure the missing attribute is listed:</p><div class=tab-panel data-tab-group=4de73f7a1697d31266765f8f5c175c5c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4de73f7a1697d31266765f8f5c175c5c","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Fails to create user with missing required attribute
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>createUserFailsOnMissingRequiredAttribute</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>attr</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should fail when required attribute &#39;&#34;</span> <span class=o>+</span> <span class=nx>attr</span> <span class=o>+</span> <span class=s2>&#34;&#39; is missing&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Create a copy of the user object and delete the given attribute
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>updated_user</span> <span class=o>=</span> <span class=p>{...</span> <span class=nx>user</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>delete</span> <span class=nx>updated_user</span><span class=p>[</span><span class=nx>attr</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>updated_user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>422</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;errors&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// the error should be related to the deleted attribute
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>e</span><span class=p>.</span><span class=nx>attribute</span> <span class=o>===</span> <span class=nx>attr</span><span class=p>)).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;POST /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user_no_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnMissingRequiredAttribute</span><span class=p>(</span><span class=nx>new_user</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><h3 id=duplicate-username-1>Duplicate Username</h3><p>We also should write a unit test that will make sure we cannot create a user with a duplicate username.</p><div class=tab-panel data-tab-group=0e23e28ce56e402ccc9327b022aeaf46><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0e23e28ce56e402ccc9327b022aeaf46","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Fails to create user with a duplicate username
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>createUserFailsOnDuplicateUsername</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should fail on duplicate username &#39;&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>201</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>created_id</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find user in list of all users
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>foundUser</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>created_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>foundUser</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Try to create same user again
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>422</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;errors&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>// the error should be related to the username attribute
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>expect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                  <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>e</span><span class=p>.</span><span class=nx>attribute</span> <span class=o>===</span> <span class=s2>&#34;username&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>              <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;POST /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user_no_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnMissingRequiredAttribute</span><span class=p>(</span><span class=nx>new_user</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnDuplicateUsername</span><span class=p>(</span><span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This test builds upon the previous <code>createUser</code> test by first creating the user, and then confirming that it appears in the output, before trying to create it again. This time, it should fail, so we can borrow some of the code from the <code>createUserFailsOnMissingRequiredAttribute</code> to confirm that it is failing because of a duplicate username.</p><h3 id=invalid-roles-1>Invalid Roles</h3><p>Finally, we should write a unit test that makes sure a user won&rsquo;t be created if any invalid role IDs are used, and also that the database transaction is properly rolled back so that the user itself isn&rsquo;t created.</p><div class=tab-panel data-tab-group=eeddcd21a54b84dcfcd8def225ae9cb0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("eeddcd21a54b84dcfcd8def225ae9cb0","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Fails to create user with bad role ID
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>createUserFailsOnInvalidRole</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>role_id</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should fail when invalid role id &#39;&#34;</span> <span class=o>+</span> <span class=nx>role_id</span> <span class=o>+</span> <span class=s2>&#34;&#39; is used&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Create a copy of the user object
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>updated_user</span> <span class=o>=</span> <span class=p>{</span> <span class=p>...</span><span class=nx>user</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Make a shallow copy of the roles array
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>updated_user</span><span class=p>.</span><span class=nx>roles</span> <span class=o>=</span> <span class=p>[...</span> <span class=nx>user</span><span class=p>.</span><span class=nx>roles</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Add invalid role ID to user object
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>updated_user</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span><span class=o>:</span> <span class=nx>role_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>updated_user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>422</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// User with invalid roles should not be created
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>username</span> <span class=o>===</span> <span class=nx>updated_user</span><span class=p>.</span><span class=nx>username</span><span class=p>)).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;POST /&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUser</span><span class=p>(</span><span class=nx>new_user_no_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnMissingRequiredAttribute</span><span class=p>(</span><span class=nx>new_user</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnDuplicateUsername</span><span class=p>(</span><span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnInvalidRole</span><span class=p>(</span><span class=nx>new_user</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnInvalidRole</span><span class=p>(</span><span class=nx>new_user</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnInvalidRole</span><span class=p>(</span><span class=nx>new_user</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUserFailsOnInvalidRole</span><span class=p>(</span><span class=nx>new_user</span><span class=p>,</span> <span class=s2>&#34;test&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This test will try to create a valid user, but it appends an invalid role ID to the list of roles to assign to the user. It also confirms that the user itself is not created by querying the get all endpoint and checking for a matching username.</p><p>There we go! We have a set of unit tests that cover most of the situations we can anticipate seeing with our route to create new users. If we run all of these tests at this point, they should all pass:</p><div class=tab-panel data-tab-group=6378814c83efb6486b25bc87c97762cc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6378814c83efb6486b25bc87c97762cc","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>    POST /
      âœ” should successfully create a user &#39;test_user&#39;
      âœ” should successfully create a user &#39;test_user_no_roles&#39;
      âœ” should fail when required attribute &#39;username&#39; is missing
      âœ” should fail on duplicate username &#39;test_user&#39;
      âœ” should fail when invalid role id &#39;0&#39; is used
      âœ” should fail when invalid role id &#39;-1&#39; is used
      âœ” should fail when invalid role id &#39;8&#39; is used
      âœ” should fail when invalid role id &#39;test&#39; is used</code></pre></div></div></div></div></div><p>Great! Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub before continuing.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=update>Update</h1><a href="https://www.youtube.com/watch?v=wH6SmYAGRLs">YouTube Video</a><h2 id=update-route>Update Route</h2><p>Next, let&rsquo;s look at adding an additional route in our application that allows us to update a <code>User</code> model. This route is very similar to the route used to create a user, but there are a few key differences as well.</p><div class=tab-panel data-tab-group=87a3b74d686470166808e6190e2ca1dd><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("87a3b74d686470166808e6190e2ca1dd","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Update a user
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/v1/users/{id}:
</span></span></span><span class=line><span class=cl><span class=cm> *   put:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: update user
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     parameters:
</span></span></span><span class=line><span class=cl><span class=cm> *       - in: path
</span></span></span><span class=line><span class=cl><span class=cm> *         name: id
</span></span></span><span class=line><span class=cl><span class=cm> *         required: true
</span></span></span><span class=line><span class=cl><span class=cm> *         schema:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *         description: user ID
</span></span></span><span class=line><span class=cl><span class=cm> *     requestBody:
</span></span></span><span class=line><span class=cl><span class=cm> *       description: user
</span></span></span><span class=line><span class=cl><span class=cm> *       required: true
</span></span></span><span class=line><span class=cl><span class=cm> *       content:
</span></span></span><span class=line><span class=cl><span class=cm> *         application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *           schema:
</span></span></span><span class=line><span class=cl><span class=cm> *             $ref: &#39;#/components/schemas/User&#39;
</span></span></span><span class=line><span class=cl><span class=cm> *           example:
</span></span></span><span class=line><span class=cl><span class=cm> *             username: updateduser
</span></span></span><span class=line><span class=cl><span class=cm> *             roles:
</span></span></span><span class=line><span class=cl><span class=cm> *               - id: 6
</span></span></span><span class=line><span class=cl><span class=cm> *               - id: 7
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       201:
</span></span></span><span class=line><span class=cl><span class=cm> *         $ref: &#39;#/components/responses/Success&#39;
</span></span></span><span class=line><span class=cl><span class=cm> *       422:
</span></span></span><span class=line><span class=cl><span class=cm> *         $ref: &#39;#/components/responses/ValidationError&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=s2>&#34;/:id&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findByPk</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// if the user is not found, return an HTTP 404 not found status code
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span> <span class=o>===</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>404</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>database</span><span class=p>.</span><span class=nx>transaction</span><span class=p>(</span><span class=kr>async</span> <span class=p>(</span><span class=nx>t</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>user</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Update the user object using body attributes
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>username</span><span class=o>:</span> <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Assign to a database transaction
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>transaction</span><span class=o>:</span> <span class=nx>t</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// If roles are included in the body
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>roles</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Find all roles listed
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=kr>await</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>all</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>map</span><span class=p>(({</span> <span class=nx>id</span><span class=p>,</span> <span class=p>...</span><span class=nx>next</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>return</span> <span class=nx>Role</span><span class=p>.</span><span class=nx>findByPk</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}),</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>          <span class=c1>// Attach roles to user
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=kr>await</span> <span class=nx>user</span><span class=p>.</span><span class=nx>setRoles</span><span class=p>(</span><span class=nx>roles</span><span class=p>,</span> <span class=p>{</span> <span class=nx>transaction</span><span class=o>:</span> <span class=nx>t</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// Remove all roles
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=kr>await</span> <span class=nx>user</span><span class=p>.</span><span class=nx>setRoles</span><span class=p>([],</span> <span class=p>{</span> <span class=nx>transaction</span><span class=o>:</span> <span class=nx>t</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>        <span class=c1>// Send the success message
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>sendSuccess</span><span class=p>(</span><span class=s2>&#34;User saved!&#34;</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=mi>201</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>error</span> <span class=k>instanceof</span> <span class=nx>ValidationError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>handleValidationError</span><span class=p>(</span><span class=nx>error</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>As we can see, overall this route is very similar to the create route. The only major difference is that we must first find the user we want to update based on the query parameter, and then we use the <code>update</code> database method to update the existing values in the database. The rest of the work updating the related <code>Roles</code> models is exactly the same. We can also reuse the utility functions we created for the previous route.</p><p>Just like we did earlier, we can test this route using the Open API documentation website to confirm that it is working correctly before we even move on to testing it.</p><h2 id=unit-testing-update-route>Unit Testing Update Route</h2><p>The unit tests for the route to update a user are very similar to the ones used for creating a user. First, we need a test that will confirm we can successfully update a user entry:</p><div class=tab-panel data-tab-group=b49481ffc87f4e3cae6deaa95150cb69><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b49481ffc87f4e3cae6deaa95150cb69","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Update a user successfully
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>updateUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should successfully update user ID &#39;&#34;</span> <span class=o>+</span> <span class=nx>id</span> <span class=o>+</span> <span class=s2>&#34;&#39; to &#39;&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>201</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>id</span><span class=p>).</span><span class=nx>equal</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find user in list of all users
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>foundUser</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>foundUser</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>shallowDeepEqual</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;PUT /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUser</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Next, we also want to check that any updated users have the correct roles attached, including instances where the roles were completely removed:</p><div class=tab-panel data-tab-group=fde750f276b77c97540a314d647ecf75><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fde750f276b77c97540a314d647ecf75","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Update a user and roles successfully
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>updateUserAndRoles</span> <span class=o>=</span> <span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should successfully update user ID &#39;&#34;</span> <span class=o>+</span> <span class=nx>id</span> <span class=o>+</span> <span class=s2>&#34;&#39; roles&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>201</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>id</span><span class=p>).</span><span class=nx>equal</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Find user in list of all users
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>foundUser</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Handle case where user has no roles assigned
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=nx>user</span><span class=p>.</span><span class=nx>roles</span> <span class=o>||</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=nx>foundUser</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>foundUser</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>lengthOf</span><span class=p>(</span><span class=nx>roles</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>expect</span><span class=p>(</span><span class=nx>foundUser</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>r</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>role</span><span class=p>.</span><span class=nx>id</span><span class=p>)).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;PUT /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUser</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=nx>new_user_no_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>We also should check that the username is unchanged if an update is sent with no username attribute, but the rest of the update will succeed. For this test, we can just create a new mock object with just roles and no username included.</p><div class=tab-panel data-tab-group=802edb77a49de3e44463a8d89a8c264b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("802edb77a49de3e44463a8d89a8c264b","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Update user structure with only roles
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>update_user_only_roles</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>roles</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span><span class=o>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span><span class=o>:</span> <span class=mi>7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;PUT /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUser</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=nx>new_user_no_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nx>update_user_only_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Finally, we should include a couple of tests to handle the situation where a duplicate username is provided, or where an invalid role is provided. These are nearly identical to the tests used in the create route earlier in this example:</p><div class=tab-panel data-tab-group=47c0840bea087b43ae299a94a31bbbc7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("47c0840bea087b43ae299a94a31bbbc7","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Fails to update user with a duplicate username
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>updateUserFailsOnDuplicateUsername</span> <span class=o>=</span> <span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should fail on duplicate username &#39;&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span> <span class=o>+</span> <span class=s2>&#34;&#39;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>422</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;errors&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;array&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// the error should be related to the username attribute
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>expect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>errors</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>e</span><span class=p>.</span><span class=nx>attribute</span> <span class=o>===</span> <span class=s2>&#34;username&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Fails to update user with bad role ID
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>updateUserFailsOnInvalidRole</span> <span class=o>=</span> <span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=nx>user</span><span class=p>,</span> <span class=nx>role_id</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should fail when invalid role id &#39;&#34;</span> <span class=o>+</span> <span class=nx>role_id</span> <span class=o>+</span> <span class=s2>&#34;&#39; is used&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Create a copy of the user object
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>updated_user</span> <span class=o>=</span> <span class=p>{</span> <span class=p>...</span><span class=nx>user</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Make a shallow copy of the roles array
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>updated_user</span><span class=p>.</span><span class=nx>roles</span> <span class=o>=</span> <span class=p>[...</span> <span class=nx>user</span><span class=p>.</span><span class=nx>roles</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Add invalid role ID to user object
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>updated_user</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span><span class=o>:</span> <span class=nx>role_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>put</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>updated_user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>422</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;error&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// User with invalid roles should not be updated
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>username</span> <span class=o>===</span> <span class=nx>updated_user</span><span class=p>.</span><span class=nx>username</span><span class=p>)).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Update user structure with duplicate username
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>update_user_duplicate_username</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>username</span><span class=o>:</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;PUT /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUser</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=nx>new_user_no_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserAndRoles</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nx>update_user_only_roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserFailsOnDuplicateUsername</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=nx>update_user_duplicate_username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserFailsOnInvalidRole</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserFailsOnInvalidRole</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserFailsOnInvalidRole</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>,</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateUserFailsOnInvalidRole</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=nx>new_user</span><span class=p>,</span> <span class=s2>&#34;test&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>There we go! We have a set of unit tests that cover most of the situations we can anticipate seeing with our route to update users. If we run all of these tests at this point, they should all pass:</p><div class=tab-panel data-tab-group=16df1aa61ddfba84f4e607f63c5f890d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("16df1aa61ddfba84f4e607f63c5f890d","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>    PUT /{id}
      âœ” should successfully update user ID &#39;3&#39; to &#39;test_user&#39;
      âœ” should successfully update user ID &#39;3&#39; roles
      âœ” should successfully update user ID &#39;2&#39; roles
      âœ” should successfully update user ID &#39;1&#39; roles
      âœ” should fail on duplicate username &#39;admin&#39;
      âœ” should fail when invalid role id &#39;0&#39; is used
      âœ” should fail when invalid role id &#39;-1&#39; is used
      âœ” should fail when invalid role id &#39;8&#39; is used
      âœ” should fail when invalid role id &#39;test&#39; is used</code></pre></div></div></div></div></div><p>Great! Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub before continuing.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=delete>Delete</h1><a href="https://www.youtube.com/watch?v=ujGaXQjq_z4">YouTube Video</a><h2 id=delete-route>Delete Route</h2><p>Finally, the last route we need to add to our <code>users</code> routes is the delete route. This route is very simple - it will remove a user based on the given user ID if it exists in the database:</p><div class=tab-panel data-tab-group=96a8ea22c3afaac7a451df60bf24201a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("96a8ea22c3afaac7a451df60bf24201a","routesapiv1usersjs")'>
<span class=tab-nav-text>routes/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=routesapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Delete a user
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /api/v1/users/{id}:
</span></span></span><span class=line><span class=cl><span class=cm> *   delete:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: delete user
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [users]
</span></span></span><span class=line><span class=cl><span class=cm> *     parameters:
</span></span></span><span class=line><span class=cl><span class=cm> *       - in: path
</span></span></span><span class=line><span class=cl><span class=cm> *         name: id
</span></span></span><span class=line><span class=cl><span class=cm> *         required: true
</span></span></span><span class=line><span class=cl><span class=cm> *         schema:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: integer
</span></span></span><span class=line><span class=cl><span class=cm> *         description: user ID
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         $ref: &#39;#/components/responses/Success&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=s2>&#34;/:id&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>user</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>User</span><span class=p>.</span><span class=nx>findByPk</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// if the user is not found, return an HTTP 404 not found status code
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span> <span class=o>===</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>404</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>user</span><span class=p>.</span><span class=nx>destroy</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// Send the success message
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>sendSuccess</span><span class=p>(</span><span class=s2>&#34;User deleted!&#34;</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=mi>200</span><span class=p>,</span> <span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>500</span><span class=p>).</span><span class=nx>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Once again, we can test this route using the Open API documentation website. Let&rsquo;s look at how we can quickly unit test it as well.</p><h2 id=unit-testing-delete-route>Unit Testing Delete Route</h2><p>The unit tests for this route are similarly very simple. We really only have two cases - the user is found and successfully deleted, or the user cannot be found and an HTTP 404 response is returned.</p><div class=tab-panel data-tab-group=564780db11230fa361b84d5b1fc8a884><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testapiv1usersjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("564780db11230fa361b84d5b1fc8a884","testapiv1usersjs")'>
<span class=tab-nav-text>test/api/v1/users.js</span></button></div><div class=tab-content-container><div data-tab-item=testapiv1usersjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Delete a user successfully
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>deleteUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>id</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should successfully delete user ID &#39;&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>id</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nb>String</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Ensure user is not found in list of users
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>expect</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>u</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>id</span> <span class=o>===</span> <span class=nx>id</span><span class=p>)).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Fail to delete a missing user
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>deleteUserFailsInvalidId</span><span class=o>=</span> <span class=p>(</span><span class=nx>id</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should fail to delete invalid user ID &#39;&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=s2>&#34;/api/v1/users/&#34;</span> <span class=o>+</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>404</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /api/v1/users route
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/api/v1/users&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;DELETE /{id}&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>deleteUser</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>deleteUserFailsInvalidId</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>deleteUserFailsInvalidId</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>deleteUserFailsInvalidId</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>deleteUserFailsInvalidId</span><span class=p>(</span><span class=s2>&#34;test&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>There we go! That will cover all of the unit tests for the <code>users</code> route. If we try to run all of our tests, we should see that they succeed!</p><div class=tab-panel data-tab-group=7cc1bb46a97bc0bb4119611c617fa9d9><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7cc1bb46a97bc0bb4119611c617fa9d9","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>DELETE /{id}
      âœ” should successfully delete user ID &#39;4
      âœ” should fail to delete invalid user ID &#39;0
      âœ” should fail to delete invalid user ID &#39;-1
      âœ” should fail to delete invalid user ID &#39;5
      âœ” should fail to delete invalid user ID &#39;test</code></pre></div></div></div></div></div><p>All told, we write just 5 API routes (retrieve all, retrieve one, create, update, and delete) but wrote 53 different unit tests to fully test those routes.</p><p>Now is a great time to <strong>lint, format, and then commit and push</strong> our work to GitHub.</p><p>In the next example, we&rsquo;ll explore how to add authentication to our RESTful API.</p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=authentication>Authentication</h1><p>This example project builds on the previous RESTful API project by adding user authentication. This will ensure users are identified within the system and are only able to perform operations according to the roles assigned to their user accounts.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li>An authentication system using <a href=https://www.passportjs.org/ rel=external target=_blank>Passport.js</a> and <a href=https://apereo.github.io/cas/7.1.x/index.html rel=external target=_blank>CAS</a></li><li>Valid JSON Web Tokens (JWTs) for authentication within the RESTful API</li><li>Proper middleware to verify users have the correct role for each operation in the API</li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Authentication</h1><article class=default><header class=headline></header><h1 id=bypass-auth>Bypass Auth</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=authentication-libraries>Authentication Libraries</h2><p>There are many different authentication libraries and methods available for Node.js and Express. For this project, we will use the <a href=https://www.passportjs.org/ rel=external target=_blank>Passport.js</a> library. It supports many different authentication strategy, and is a very common way that authentication is handled within JavaScript applications.</p><p>For our application, we&rsquo;ll end up using several strategies to authenticate our users:</p><ul><li><a href=https://www.passportjs.org/packages/passport-unique-token/ rel=external target=_blank>Unique Token</a> - used to bypass authentication for testing</li><li><a href=https://github.com/appdevdesigns/passport-cas rel=external target=_blank>CAS</a> - used to authenticate with <a href=https://apereo.github.io/cas/7.1.x/index.html rel=external target=_blank>Central Authentication Service (CAS)</a> servers such as those used at K-State</li><li><a href=https://www.passportjs.org/packages/passport-jwt-cookiecombo/ rel=external target=_blank>JSON Web Tokens (JWT)</a> - used to identify user requests to the API itself</li></ul><p>Let&rsquo;s first set up our unique token strategy, which allows us to test our authentication routes before setting up anything else.</p><h2 id=authentication-router>Authentication Router</h2><p>First, we&rsquo;ll need to create a new route file at <code>routes/auth.js</code> to contain our authentication routes. We&rsquo;ll start with this basic structure and work on filling in each method as we go.</p><div class=tab-panel data-tab-group=eb311e7ed08e87ef38189ce8de4e3091><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("eb311e7ed08e87ef38189ce8de4e3091","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Auth router
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports router an Express router
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * tags:
</span></span></span><span class=line><span class=cl><span class=cm> *   name: auth
</span></span></span><span class=line><span class=cl><span class=cm> *   description: Authentication Routes
</span></span></span><span class=line><span class=cl><span class=cm> * components:
</span></span></span><span class=line><span class=cl><span class=cm> *   responses:
</span></span></span><span class=line><span class=cl><span class=cm> *     AuthToken:
</span></span></span><span class=line><span class=cl><span class=cm> *       description: authentication success
</span></span></span><span class=line><span class=cl><span class=cm> *       content:
</span></span></span><span class=line><span class=cl><span class=cm> *         application/json:
</span></span></span><span class=line><span class=cl><span class=cm> *           schema:
</span></span></span><span class=line><span class=cl><span class=cm> *             type: object
</span></span></span><span class=line><span class=cl><span class=cm> *             required:
</span></span></span><span class=line><span class=cl><span class=cm> *               - token
</span></span></span><span class=line><span class=cl><span class=cm> *             properties:
</span></span></span><span class=line><span class=cl><span class=cm> *               token:
</span></span></span><span class=line><span class=cl><span class=cm> *                 type: string
</span></span></span><span class=line><span class=cl><span class=cm> *                 description: a JWT for the user
</span></span></span><span class=line><span class=cl><span class=cm> *             example:
</span></span></span><span class=line><span class=cl><span class=cm> *               token: abcdefg12345
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;../configs/auth.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create Express router
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>express</span><span class=p>.</span><span class=nx>Router</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Authentication Response Handler
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>authSuccess</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Bypass authentication for testing
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/bypass:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: bypass authentication for testing
</span></span></span><span class=line><span class=cl><span class=cm> *     description: Bypasses CAS authentication for testing purposes
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     parameters:
</span></span></span><span class=line><span class=cl><span class=cm> *       - in: query
</span></span></span><span class=line><span class=cl><span class=cm> *         name: token
</span></span></span><span class=line><span class=cl><span class=cm> *         required: true
</span></span></span><span class=line><span class=cl><span class=cm> *         schema:
</span></span></span><span class=line><span class=cl><span class=cm> *           type: string
</span></span></span><span class=line><span class=cl><span class=cm> *         description: username
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/bypass&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * CAS Authentication
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/cas:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: CAS authentication
</span></span></span><span class=line><span class=cl><span class=cm> *     description:  CAS authentication for deployment
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/cas&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Request JWT based on previous authentication
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/token:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: request JWT 
</span></span></span><span class=line><span class=cl><span class=cm> *     description: request JWT based on previous authentication
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         $ref: &#39;#/components/responses/AuthToken&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/token&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>router</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This file includes a few items to take note of:</p><ul><li>In the top-level Open API comment, we define a new <code>AuthToken</code> response that we&rsquo;ll send to the user when they request a token.</li><li>We create three routes. The first two, <code>/auth/bypass</code> and <code>/auth/cas</code>, for each of our authentication strategies. The last one, <code>/auth/token</code> will be used by our frontend to request a token to access the API.</li><li>Finally, we&rsquo;ll build a <code>authSuccess</code> function to handle actually sending the response to the user</li></ul><p>Before moving on, let&rsquo;s go ahead and add this router to our <code>app.js</code> file along with the other routers:</p><div class=tab-panel data-tab-group=b9d06f244f612b0172ba61534b19c56d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b9d06f244f612b0172ba61534b19c56d","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>indexRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/index.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>apiRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/api.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>authRouter</span> <span class=nx>from</span> <span class=s2>&#34;./routes/auth.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Use routers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nx>indexRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/api&#34;</span><span class=p>,</span> <span class=nx>apiRouter</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=nx>authRouter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll come back to this file once we are ready to link up our authentication strategies.</p><h2 id=unique-token-authentication>Unique Token Authentication</h2><p>Next, let&rsquo;s install both <code>passport</code> and the <code>passport-unique-token</code> authentication strategy:</p><div class=tab-panel data-tab-group=ef71f8b8c9bb66309efd44d1c1533838><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ef71f8b8c9bb66309efd44d1c1533838","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ passport passport-unique-token</span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll configure that strategy in a new <code>configs/auth.js</code> file with the following content:</p><div class=tab-panel data-tab-group=98ff01647c6e32ac843a7172d2043f02><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("98ff01647c6e32ac843a7172d2043f02","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration information for Passport.js Authentication
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UniqueTokenStrategy</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;passport-unique-token&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import models
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import logger
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Authenticate a user
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {string} username the username to authenticate
</span></span></span><span class=line><span class=cl><span class=cm> * @param {function} next the next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>authenticateUser</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Find user with the username
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span> 
</span></span><span class=line><span class=cl>    <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>username</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// User not found
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span> <span class=o>===</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Login failed for user: &#34;</span> <span class=o>+</span> <span class=nx>username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// User authenticated
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Login succeeded for user: &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Convert Sequelize object to plain JavaScript object
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>user</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>user</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Bypass Authentication via Token
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=k>new</span> <span class=nx>UniqueTokenStrategy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=c1>// verify callback function
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>authenticateUser</span><span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Default functions to serialize and deserialize a session
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>serializeUser</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>done</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>passport</span><span class=p>.</span><span class=nx>deserializeUser</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>done</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this file, we created an <code>authenticateUser</code> function that will look for a user based on a given username. If found, it will return that user by calling the <code>next</code> middleware function. Otherwise, it will call that function and provide <code>false</code>.</p><p>Below, we configure Passport.js using the <code>passport.use</code> function to define the various authentication strategies we want to use. In this case, we&rsquo;ll start with the <a href=https://www.passportjs.org/packages/passport-unique-token/ rel=external target=_blank>Unique Token Strategy</a>, which uses a token provided as part of a query to the web server.</p><p>In addition, we need to implement some default functions to handle serializing and deserializing a user from a session. These functions don&rsquo;t really have any content in our implementation; we just need to include the default code.</p><p>Finally, since Passport.js acts as a global object, we don&rsquo;t even have to export anything from this file!</p><h2 id=testing-authentication>Testing Authentication</h2><p>To test this authentication strategy, let&rsquo;s modify <code>routes/auth.js</code> to use this strategy. We&rsquo;ll update the <code>/auth/bypass</code> route and also add some temporary code to the <code>authSuccess</code> function:</p><div class=tab-panel data-tab-group=2420c369e3fc000e4108b44413e7c7aa><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2420c369e3fc000e4108b44413e7c7aa","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Import configurations
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;../configs/auth.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>authSuccess</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/bypass&#34;</span><span class=p>,</span> <span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>,</span> <span class=p>{</span><span class=nx>session</span><span class=o>:</span> <span class=kc>false</span><span class=p>}),</span> <span class=nx>authSuccess</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>In the <code>authSuccess</code> function, right now we are just sending the content of <code>req.user</code>, which is set by Passport.js on a successful authentication (it is the value we returned when calling the <code>next</code> function in our authentication strategy earlier). We&rsquo;ll come back to this later when we implement JSON Web Tokens (JWT) later in this tutorial.</p><p>The other major change is that now the <code>/auth/bypass</code> route calls the <code>passport.authenticate</code> method with the <code>'token'</code> strategy specified. It also uses <code>{session: false}</code> as one of the options provided to Passport.js since we aren&rsquo;t actually going to be using sessions. Finally, if that middleware is satisfied, it will call the <code>authSuccess</code> function to handle sending the response to the user. This takes advantage of the chaining that we can do in Express!</p><p>With all of that in place, we can test our server and see if it works:</p><div class=tab-panel data-tab-group=0f40985ce24038508d5f7c43bf2ef70d><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0f40985ce24038508d5f7c43bf2ef70d","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>Once the page loads, we want to navigate to the <code>/auth/bypass?token=admin</code> path to see if we can log in as the <code>admin</code> user. Notice that we are including a query parameter named <code>token</code> to include the username in the URL.</p><p><a href=#R-image-ff76d9e7c403b7c460cb837b911f56a5 class=lightbox-link><img alt="Successful Authentication" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_1.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ff76d9e7c403b7c460cb837b911f56a5><img alt="Successful Authentication" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_1.png></a></p><p>There we go! We see that it successfully finds our <code>admin</code> user and returns data about that user, including the roles assigned. This is what we want to see. We can also test this by providing other usernames to make sure it is working.</p><h2 id=securing-authentication>Securing Authentication</h2><p>Of course, we don&rsquo;t want to have this bypass authentication system available all the time in our application. In fact, we really only want to use it for testing and debugging; otherwise, our application will have a major security flaw! So, let&rsquo;s add a new environment variable <code>BYPASS_AUTH</code> to our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. We should set it to <code>TRUE</code> in the <code>.env.test</code> file, and for now we&rsquo;ll have it enabled in our <code>.env</code> file as well, but this option should <strong>NEVER</strong> be enabled in a production setting.</p><div class=tab-panel data-tab-group=39794ef8c3aaa3e338db652200c56e75><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("39794ef8c3aaa3e338db652200c56e75","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=nv>BYPASS_AUTH</span><span class=o>=</span>true</span></span></code></pre></div></div></div></div></div><p>With that setting in place, we can add it to our <code>configs/auth.js</code> file to only allow bypass authentication if that setting is enabled:</p><div class=tab-panel data-tab-group=1e480cc6eecbaaffe0e82e205c129622><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("1e480cc6eecbaaffe0e82e205c129622","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Bypass Authentication via Token
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=k>new</span> <span class=nx>UniqueTokenStrategy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=c1>// verify callback function
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Only allow token authentication when enabled
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>BYPASS_AUTH</span> <span class=o>===</span> <span class=s2>&#34;true&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>authenticateUser</span><span class=p>(</span><span class=nx>token</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>))</span></span></span></code></pre></div></div></div></div></div><p>Before moving on, we should make sure we test both enabling and disabling this setting <em>actually</em> disables bypass authentication. We want to be absolutely sure it works as intended!</p><p><a href=#R-image-aa8c6f64140d556511df36e818ab2dfe class=lightbox-link><img alt="Disabled Authentication" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_2.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-aa8c6f64140d556511df36e818ab2dfe><img alt="Disabled Authentication" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_2.png></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cookie-sessions>Cookie Sessions</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=cookie-sessions>Cookie Sessions</h2><p>One of the most common methods for keeping track of users after they are authenticated is by setting a cookie on their browser that is sent with each request. We&rsquo;ve already explored this method earlier in this course, so let&rsquo;s go ahead and configure cookie sessions for our application, storing them in our existing database.</p><p>We&rsquo;ll start by installing both the <a href=https://www.npmjs.com/package/express-session rel=external target=_blank>express-session</a> middleware and the <a href=https://www.npmjs.com/package/connect-session-sequelize rel=external target=_blank>connect-session-sequelize</a> library that we can use to store our sessions in a Sequelize database:</p><div class=tab-panel data-tab-group=4e15509f6e2ad9aaef44ab48b0c018c5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4e15509f6e2ad9aaef44ab48b0c018c5","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install express-session connect-session-sequelize</span></span></code></pre></div></div></div></div></div><p>Once those libraries are installed, we can create a configuration for sessions in a new <code>configs/sessions.js</code> file:</p><div class=tab-panel data-tab-group=80286a630d769eba1b564c9bdd16d95a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configssessionsjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("80286a630d769eba1b564c9bdd16d95a","configssessionsjs")'>
<span class=tab-nav-text>configs/sessions.js</span></button></div><div class=tab-content-container><div data-tab-item=configssessionsjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file Configuration for cookie sessions stored in Sequelize
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * @exports sequelizeSession a Session instance configured for Sequelize
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>session</span> <span class=nx>from</span> <span class=s1>&#39;express-session&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>connectSession</span> <span class=nx>from</span> <span class=s1>&#39;connect-session-sequelize&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=nx>from</span> <span class=s1>&#39;./database.js&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s1>&#39;./logger.js&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Initialize Store
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>sequelizeStore</span> <span class=o>=</span> <span class=nx>connectSession</span><span class=p>(</span><span class=nx>session</span><span class=p>.</span><span class=nx>Store</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>store</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>sequelizeStore</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=o>:</span> <span class=nx>database</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Create tables in Sequelize
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>store</span><span class=p>.</span><span class=nx>sync</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_SECRET</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s2>&#34;Cookie session secret not set! Set a SESSION_SECRET environment variable.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Session configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>sequelizeSession</span> <span class=o>=</span> <span class=nx>session</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_NAME</span> <span class=o>||</span> <span class=s1>&#39;connect.sid&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>secret</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_SECRET</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>store</span><span class=o>:</span> <span class=nx>store</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=nx>resave</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>proxy</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>saveUninitialized</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>sequelizeSession</span><span class=p>;</span></span></span></code></pre></div></div></div></div></div><p>This file loads our Sequelize database connection and initializes the Express session middleware and the Sequelize session store. We also have a quick sanity check that will ensure there is a <code>SESSION_SECRET</code> environment variable set, otherwise an error will be printed. Finally, we export that session configuration to our application.</p><p>So, we&rsquo;ll need to add a <code>SESSION_NAME</code> and <code>SESSION_SECRET</code> environment variable to our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. The <code>SESSION_NAME</code> is a unique name for our cookie, and the <code>SESSION_SECRET</code> is a secret key used to secure our cookies and prevent them from being modified.</p><p>There are many ways to generate a secret key, but one of the simplest is to just use the built in functions in Node.js itself. We can launch the Node.js <a href=https://nodejs.org/en/learn/command-line/how-to-use-the-nodejs-repl rel=external target=_blank>REPL</a> environment by just running the <code>node</code> command in the terminal:</p><div class=tab-panel data-tab-group=2937bfdbaa96a7a2f4bd62bddde8e4b1><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2937bfdbaa96a7a2f4bd62bddde8e4b1","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ node</span></span></code></pre></div></div></div></div></div><p>From there, we can use this line to get a random secret key:</p><div class=tab-panel data-tab-group=7d9b8b2301b44fe57038e9f54f5acdd7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=node class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7d9b8b2301b44fe57038e9f54f5acdd7","node")'>
<span class=tab-nav-text>node</span></button></div><div class=tab-content-container><div data-tab-item=node class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&gt;</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;crypto&#39;</span><span class=p>).</span><span class=nx>randomBytes</span><span class=p>(</span><span class=mi>64</span><span class=p>).</span><span class=nx>toString</span><span class=p>(</span><span class=s1>&#39;hex&#39;</span><span class=p>)</span></span></span></code></pre></div></div></div></div></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Documenting Terminal Commands</div><div class=box-content><p>Just like we use <code>$</code> as the prompt for Linux terminal commands, the Node.js REPL environment uses <code>></code> so we will include that in our documentation. You should not include that character in your command.</p></div></div><p>If done correctly, we&rsquo;ll get a random string that you can use as your secret key!</p><p><a href=#R-image-5f77f3bb2baf11c3991cd621e07675e0 class=lightbox-link><img alt="Secret Key" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_3.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5f77f3bb2baf11c3991cd621e07675e0><img alt="Secret Key" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_3.png></a></p><p>We can include that key in our <code>.env</code> file. To help remember how to do this in the future, we can even include the Node.js command as a comment above that line:</p><div class=tab-panel data-tab-group=401dc533bfff34b2b9da4bffd7c207c5><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("401dc533bfff34b2b9da4bffd7c207c5","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=nv>SESSION_NAME</span><span class=o>=</span>lostcommunities
</span></span><span class=line><span class=cl><span class=c1># require(&#39;crypto&#39;).randomBytes(64).toString(&#39;hex&#39;)</span>
</span></span><span class=line><span class=cl><span class=nv>SESSION_SECRET</span><span class=o>=</span>46a5fdfe16fa710867102d1f0dbd2329f2eae69be3ed56ca084d9e0ad....</span></span></code></pre></div></div></div></div></div><p>Finally, we can update our <code>app.js</code> file to use this session configuration:</p><div class=tab-panel data-tab-group=956aee13372bd5bffecff5d524f6fb4b><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=appjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("956aee13372bd5bffecff5d524f6fb4b","appjs")'>
<span class=tab-nav-text>app.js</span></button></div><div class=tab-content-container><div data-tab-item=appjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>compression</span> <span class=nx>from</span> <span class=s2>&#34;compression&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>cookieParser</span> <span class=nx>from</span> <span class=s2>&#34;cookie-parser&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>helmet</span> <span class=nx>from</span> <span class=s2>&#34;helmet&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>path</span> <span class=nx>from</span> <span class=s2>&#34;path&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>swaggerUi</span> <span class=nx>from</span> <span class=s2>&#34;swagger-ui-express&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;./configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>openapi</span> <span class=nx>from</span> <span class=s2>&#34;./configs/openapi.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>sessions</span> <span class=nx>from</span> <span class=s2>&#34;./configs/sessions.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Use libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>express</span><span class=p>.</span><span class=nx>urlencoded</span><span class=p>({</span> <span class=nx>extended</span><span class=o>:</span> <span class=kc>false</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>helmet</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>compression</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>cookieParser</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class="line hl"><span class=cl><span class=c1>// Use sessions
</span></span></span><span class="line hl"><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>sessions</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s1>&#39;session&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Use middlewares
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>requestLogger</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>There we go! Now we can enable cookie sessions in Passport.js by removing the <code>{session: false}</code> setting in our <code>/auth/bypass</code> route in the <code>routes/auth.js</code> file:</p><div class=tab-panel data-tab-group=7c5d92618ad6bf7617fd24e6a5c3b149><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("7c5d92618ad6bf7617fd24e6a5c3b149","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/bypass&#34;</span><span class=p>,</span> <span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>),</span> <span class=nx>authSuccess</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we navigate to that route and authenticate, we should see our application set a session cookie as part of the response.</p><p><a href=#R-image-68f9f7ff8fa9aef4e1b4c651c36dfa03 class=lightbox-link><img alt="Cookie Session" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_7.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-68f9f7ff8fa9aef4e1b4c651c36dfa03><img alt="Cookie Session" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_7.png></a></p><p>We can match the SID in the session cookie with the SID in the <code>Sessions</code> table in our database to confirm that it is working:</p><p><a href=#R-image-185985ad09f0e8c7a99524086f5fe12b class=lightbox-link><img alt="Cookie Session in Database" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_8.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-185985ad09f0e8c7a99524086f5fe12b><img alt="Cookie Session in Database" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_8.png></a></p><p>From here, we can use these sessions throughout our application to track users as they make additional requests.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=json-web-token>JSON Web Token</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=json-web-tokens-jwt>JSON Web Tokens (JWT)</h2><p>Now that we have a working authentication system, the next step is to configure a method to request a valid JSON Web Token, or JWT, that contains information about the authenticated user. We&rsquo;ve already learned a bit about JWTs in this course, so we won&rsquo;t cover too many of the details here.</p><p>To work with JWTs, we&rsquo;ll need to install the <a href=https://www.npmjs.com/package/jsonwebtoken rel=external target=_blank>jsonwebtoken</a> package from NPM:</p><div class=tab-panel data-tab-group=a9428d326f0921495c7bcc2ad4dbc9b3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a9428d326f0921495c7bcc2ad4dbc9b3","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install jsonwebtoken</span></span></code></pre></div></div></div></div></div><p>Next, we&rsquo;ll need to create a secret key that we can use to sign our tokens. We&rsquo;ll add this as the <code>JWT_SECRET_KEY</code> setting in our <code>.env</code>, <code>.env.test</code> and <code>.env.example</code> files. We can use the same method discussed on the previous page to generate a new random key:</p><div class=tab-panel data-tab-group=aa507fb41d82dbd306383837aeb4f69a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("aa507fb41d82dbd306383837aeb4f69a","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=c1># require(&#39;crypto&#39;).randomBytes(64).toString(&#39;hex&#39;)</span>
</span></span><span class=line><span class=cl><span class=nv>JWT_SECRET_KEY</span><span class=o>=</span><span class=s1>&#39;46a5fdfe16fa710867102d1f0dbd2329f2eae69be3ed56ca084d9e0ad....&#39;</span></span></span></code></pre></div></div></div></div></div><p>Once we have the library and a key, we can easily create and sign a JWT in the <code>/auth/token</code> route in the <code>routes/auth.js</code> file:</p><div class=tab-panel data-tab-group=a065dbed8af829b32f488c6bbecbb8ca><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a065dbed8af829b32f488c6bbecbb8ca","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>express</span> <span class=nx>from</span> <span class=s2>&#34;express&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>jsonwebtoken</span> <span class=nx>from</span> <span class=s2>&#34;jsonwebtoken&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/token&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// If user is logged in
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>req</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>JWT_SECRET_KEY</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>expiresIn</span><span class=o>:</span> <span class=s1>&#39;6h&#39;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>token</span><span class=o>:</span> <span class=nx>token</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Send unauthorized response
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>send</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Now, when we visit the <code>/auth/token</code> URL on our working website (after logging in through the <code>/auth/bypass</code> route), we should receive a JWT as a response:</p><p><a href=#R-image-bdbbc7e652d7a5fc1ff2d73f3bf2a0d2 class=lightbox-link><img alt="JWT Response" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_4.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-bdbbc7e652d7a5fc1ff2d73f3bf2a0d2><img alt="JWT Response" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_4.png></a></p><p>Of course, while that data may seem unreadable, we already know that JWTs are Base64 encoded, so we can easily view the content of the token. Thankfully, there are many great tools we can use to debug our tokens, such as <a href=https://token.dev/ rel=external target=_blank>Token.dev</a>, to confirm that they are working correctly.</p><p><a href=#R-image-a1f82a0436634295c0d9b8c33b534668 class=lightbox-link><img alt="JWT Debugger" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_5.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a1f82a0436634295c0d9b8c33b534668><img alt="JWT Debugger" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_5.png></a></p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Do Not Share Live Keys!</div><div class=box-content><p>While sites like this will also help you confirm that your JWTs are properly signed by asking for your secret key, you <strong>SHOULD NOT</strong> share a secret key for a live production application with these sites. There is always a chance it has been compromised!</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=auth-routing>Auth Routing</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=routing-after-authentication>Routing after Authentication</h2><p>The last step we should take in our authentication system is to properly route users back to the index page after a successful login attempt. Since we will eventually be building a single-page application in Vue.js as our frontend for this application, we only need to worry about directing users back to the index page, which will load our frontend.</p><p>So, in our <code>authSuccess</code> method in <code>routes/auth.js</code>, we can update the response to redirect our users back to the index page:</p><div class=tab-panel data-tab-group=fb11f43bb56268213f261f876c98b986><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=authroutesjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fb11f43bb56268213f261f876c98b986","authroutesjs")'>
<span class=tab-nav-text>auth/routes.js</span></button></div><div class=tab-content-container><div data-tab-item=authroutesjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>authSuccess</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>The <code>res.redirect</code> method will sent an HTTP 302 <code>Found</code> response back to the browser with a new location to navigate to. However, by that point, the authentication process will also send a cookie to the browser with the session ID, so the user will be logged in correctly:</p><p><a href=#R-image-312b12c8bc3aba9d4d726fadf8e964e3 class=lightbox-link><img alt="Session Login with Cookie Set" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_9.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-312b12c8bc3aba9d4d726fadf8e964e3><img alt="Session Login with Cookie Set" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_9.png></a></p><h2 id=logout-route>Logout Route</h2><p>Finally, we should also add a logout route. This route will end any sessions created through Passport.js by removing the session from the database and also telling the browser to delete the session cookie. It uses the special <code>req.logout()</code> method that is added to each request by Passport.js. We&rsquo;ll add our logout route to the bottom of the <code>routes/auth.js</code> file:</p><div class=tab-panel data-tab-group=a62ea6761b508d6115ad43a13a0d6975><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a62ea6761b508d6115ad43a13a0d6975","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import configurations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s2>&#34;../configs/auth.js&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=nx>logger</span> <span class=nx>from</span> <span class=s2>&#34;../configs/logger.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Logout of a Passport.js session
</span></span></span><span class=line><span class=cl><span class=cm> * 
</span></span></span><span class=line><span class=cl><span class=cm> * See https://www.initialapps.com/properly-logout-passportjs-express-session-for-single-page-app/
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/logout:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: logout current user
</span></span></span><span class=line><span class=cl><span class=cm> *     description:  logout current user and end session
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/logout&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>clearCookie</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_NAME</span> <span class=o>||</span> <span class=s1>&#39;connect.sid&#39;</span><span class=p>);</span>  <span class=c1>// clear the session cookie
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>req</span><span class=p>.</span><span class=nx>logout</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>       <span class=c1>// logout of passport
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>destroy</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// destroy the session
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we access this route with a valid session, we&rsquo;ll see that the user is properly logged out.</p><p>We&rsquo;ll also no longer be able to access the <code>/auth/token</code> route without logging in again.</p><p>However, this route <strong>WILL NOT</strong> invalidate any existing JWTs already issued to that user - they will still be valid until they expire. In our earlier example, we set the JWTs to have a 6 hour lifetime, so in theory a user could still access the application using a valid JWT up to 6 hours after logging out!</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Invalidating JWTs</div><div class=box-content><p>JSON Web Tokens (JWTs) are a very powerful authentication method for web APIs because they allow users to send requests without worrying about the need for a cookie session. In theory, a JWT issued by any instance of our API can be validated anywhere, making it much easier to horizontally scale this application in the future.</p><p>In addition, requests with a JWT generally don&rsquo;t require a database access with each request to validate the session. Our current cookie sessions store the session data in the database, so now each incoming request containing a session cookie requires a database lookup to get information about the user before any work can be done.</p><p>However, this means that any user with a valid JWT will be able to access our application even if they have logged out. This may present a security issue for some applications.</p><p>There are some strategies to mitigate this risk:</p><ol><li>Use JWTs with a short expiration - this means users may have to log in again and/or request new tokens more often, which could be frustrating.</li><li>Add a database session to each JWT - this would mean that each incoming request with a JWT would now result in a database lookup, which could slow things down. Alternatively, sessions could be stored in a faster cache mechanism such as <a href=https://redis.io/ rel=external target=_blank>Redis</a> or <a href=https://valkey.io/ rel=external target=_blank>Valkey</a>.</li><li>To permanently invalidate all existing JWT sessions (in case of a security compromise or other concern), simply change the key used to sign the JWTs to a new secure key. This is a method of last resort, but it is always important to know that it is available if needed.</li></ol></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cas-authentication>CAS Authentication</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=cas-authentication>CAS Authentication</h2><p>We&rsquo;ve already studied <a href=https://apereo.github.io/cas/7.1.x/index.html rel=external target=_blank>Central Authentication Service (CAS)</a> as one method for authenticating users through a third party service. In this case, CAS is the service commonly used at K-State for authentication, which is why we like to cover it in our examples. So, let&rsquo;s look at how to add CAS authentication to our application through Passport.</p><h2 id=installing-a-passport-strategy>Installing a Passport Strategy</h2><p>First, we&rsquo;ll need to install a new Passport.js strategy for dealing with CAS authentication. Thankfully, the ALT+CS lab at K-State maintains an updated library for this, which can be installed as shown below:</p><div class=tab-panel data-tab-group=9f91c3028d37bdb013169e8e4d133d7c><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("9f91c3028d37bdb013169e8e4d133d7c","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install https://github.com/alt-cs-lab/passport-cas</span></span></code></pre></div></div></div></div></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Finding a Good Strategy</div><div class=box-content><p>Unfortunately, it is very difficult to find an updated Passport.js strategy for CAS authentication. This is partially due to the fact the CAS is not commonly used, and partially because many existing strategies have been written once and then abandoned by the developers. For this class, we sought out the most updated strategy available, then did our best to fix any known/existing bugs.</p></div></div><h2 id=configuring-cas-strategy>Configuring CAS Strategy</h2><p>Next, we can configure our authentication strategy by adding a few items to the <code>configs/auth.js</code> file for our new CAS strategy:</p><div class=tab-panel data-tab-group=0e123df96f51f4f23ea43434bc05d8f3><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("0e123df96f51f4f23ea43434bc05d8f3","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Import libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>passport</span> <span class=nx>from</span> <span class=s2>&#34;passport&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UniqueTokenStrategy</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;passport-unique-token&#34;</span><span class=p>;</span>
</span></span><span class="line hl"><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Strategy</span> <span class=nx>as</span> <span class=nx>CasStrategy</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;@alt-cs-lab/passport-cas&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// CAS authentication
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>passport</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=k>new</span> <span class=nx>CasStrategy</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>version</span><span class=o>:</span> <span class=s1>&#39;CAS2.0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>ssoBaseURL</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_URL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>serverBaseURL</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_SERVICE_URL</span> <span class=o>+</span> <span class=s1>&#39;/auth/cas&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nx>profile</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>profile</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>authenticateUser</span><span class=p>(</span><span class=nx>profile</span><span class=p>.</span><span class=nx>user</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=s2>&#34;CAS authentication succeeded but no user returned: &#34;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>profile</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>In this file, we are importing our new CAS authentication strategy, then using <code>passport.use</code> to tell Passport.js to use this authentication strategy when requested. Inside, we set up the various settings for our strategy, as well as the callback function when a user successfully authenticates. In this case, the CAS server will give us a <code>profile</code> object that should contain the <code>user</code> attribute with the user&rsquo;s username, which we can send to our <code>authenticateUser</code> method we&rsquo;ve already created. Finally, we also include a short catch to log any errors where the user is able to log in but a username is not provided.</p><p>In our <code>.env</code> file, we&rsquo;ll need to add two more settings. The <code>CAS_URL</code> is the base URL for the CAS server itself, and the <code>CAS_SERVICE_URL</code> is the URL that users should be sent back to, along with a ticket, to complete the log in process. Since we are working in GitHub Codespaces, our <code>CAS_SERVICE_URL</code> will be the same as our <code>OPENAPI_HOST</code>.</p><div class=tab-panel data-tab-group=fb10adbe3a7a6cb873d245fd5d749b85><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=env class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fb10adbe3a7a6cb873d245fd5d749b85","env")'>
<span class=tab-nav-text>.env</span></button></div><div class=tab-content-container><div data-tab-item=env class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-env data-lang=env><span class=line><span class=cl><span class=c1># -=-=- other settings omitted here -=-=-</span>
</span></span><span class=line><span class=cl><span class=nv>CAS_URL</span><span class=o>=</span>https://testcas.cs.ksu.edu/
</span></span><span class=line><span class=cl><span class=nv>CAS_SERVICE_URL</span><span class=o>=</span>https://<span class=nv>$CODESPACE_NAME</span>-<span class=nv>$PORT</span>.<span class=nv>$GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN</span></span></span></code></pre></div></div></div></div></div><p>Notice that we already add the <code>/auth/cas</code> route to the end of the <code>CAS_SERVICE_URL</code> in the configuration above - since that path won&rsquo;t change, it makes sense to just include it there instead of having to remember to add it to the path in the <code>.env</code> file. We should also put sensible defaults in our <code>.env.example</code> and <code>.env.test</code> files as well.</p><p>Now, to use this authentication method, all we have to do is update our <code>/auth/cas</code> route in <code>routes/auth.js</code> to use this strategy:</p><div class=tab-panel data-tab-group=dc710706dc75ec5e1a0f5c0b0d5c86f2><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("dc710706dc75ec5e1a0f5c0b0d5c86f2","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * CAS Authentication
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} req - Express request object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Object} res - Express response object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {Function} next - Express next middleware function
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @swagger
</span></span></span><span class=line><span class=cl><span class=cm> * /auth/cas:
</span></span></span><span class=line><span class=cl><span class=cm> *   get:
</span></span></span><span class=line><span class=cl><span class=cm> *     summary: CAS authentication
</span></span></span><span class=line><span class=cl><span class=cm> *     description:  CAS authentication for deployment
</span></span></span><span class=line><span class=cl><span class=cm> *     tags: [auth]
</span></span></span><span class=line><span class=cl><span class=cm> *     responses:
</span></span></span><span class=line><span class=cl><span class=cm> *       200:
</span></span></span><span class=line><span class=cl><span class=cm> *         description: success
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class="line hl"><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/cas&#34;</span><span class=p>,</span> <span class=nx>passport</span><span class=p>.</span><span class=nx>authenticate</span><span class=p>(</span><span class=s1>&#39;cas&#39;</span><span class=p>),</span> <span class=nx>authSuccess</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>With that in place, we can start our application and test it by navigating to the <code>/auth/cas</code> route to see if our login attempt works:</p><div class=tab-panel data-tab-group=6bd9d05e431176239421f74ceaf23765><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("6bd9d05e431176239421f74ceaf23765","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm run dev</span></span></code></pre></div></div></div></div></div><p>If everything works correctly, we should be directed to our CAS server to authenticate, then we&rsquo;ll be sent back to our own server with a ticket to validate our authentication. Finally, once the ticket is validated, we&rsquo;ll be redirected back to our home page with a session cookie set:</p><p><a href=#R-image-fe6556f1f89accea7ad45a822779be89 class=lightbox-link><img alt="CAS Login with Cookie Set" class="border lazy lightbox noshadow figure-image" loading=lazy src=/cis526/images/examples/04/auth_9.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-fe6556f1f89accea7ad45a822779be89><img alt="CAS Login with Cookie Set" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=/cis526/images/examples/04/auth_9.png></a></p><h2 id=cas-logout>CAS Logout</h2><p>Finally, we&rsquo;ll need to add a bit more logic to our logout process to properly log users out of both our application and the CAS server they originally logged in through. So, let&rsquo;s update our <code>/auth/logout</code> route to include that:</p><div class=tab-panel data-tab-group=97d8c970b7aca9164294b54e7cc34981><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=routesauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("97d8c970b7aca9164294b54e7cc34981","routesauthjs")'>
<span class=tab-nav-text>routes/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=routesauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/logout&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>res</span><span class=p>.</span><span class=nx>clearCookie</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_NAME</span> <span class=o>||</span> <span class=s1>&#39;connect.sid&#39;</span><span class=p>);</span>  <span class=c1>// clear the session cookie
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>req</span><span class=p>.</span><span class=nx>logout</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>       <span class=c1>// logout of passport
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>destroy</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// destroy the session
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class="line hl"><span class=cl>      <span class=kr>const</span> <span class=nx>redirectURL</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_URL</span> <span class=o>+</span> <span class=s2>&#34;/logout?service=&#34;</span> <span class=o>+</span> <span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_SERVICE_URL</span><span class=p>)</span>
</span></span><span class="line hl"><span class=cl>      <span class=nx>res</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=nx>redirectURL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Most CAS servers will automatically redirect the user back to the <code>service</code> request parameter, but not all of them. However, this will ensure that the CAS server knows the user has logged out and will invalidate any tickets for that user.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=new-users>New Users</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=handling-new-users>Handling New Users</h2><p>What if a user logs in to our application through CAS, but we don&rsquo;t have them in our database of users? Do we want to deny them access to the application? Or should we somehow gracefully add them to the list of users and give them some basic access to our application?</p><p>Since we are building a website meant to be open to a number of users, let&rsquo;s go ahead and implement a strategy where a new user can be created in the event that a user logs on through one of our authentication strategies but isn&rsquo;t found in the database.</p><p>Thankfully, to do this is really simple - all we must do is add a few additional lines to our <code>authenticateUser</code> function in the <code>configs/auth.js</code> file:</p><div class=tab-panel data-tab-group=fbf59d292127ecff07617ad41ed236a8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=configsauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("fbf59d292127ecff07617ad41ed236a8","configsauthjs")'>
<span class=tab-nav-text>configs/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=configsauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>authenticateUser</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Find user with the username
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span> 
</span></span><span class=line><span class=cl>    <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>username</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>    <span class=c1>// User not found
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>user</span> <span class=o>===</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Create new user
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>User</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>username</span><span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>        <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;New user created via login: &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>        
</span></span><span class="line hl"><span class=cl>        <span class=c1>// Convert Sequelize object to plain JavaScript object
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>        <span class=nx>user</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>user</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>        <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>      <span class=p>})</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class="line hl"><span class=cl>      <span class=c1>// User authenticated
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>logger</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=s2>&#34;Login succeeded for user: &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>.</span><span class=nx>username</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>      
</span></span><span class="line hl"><span class=cl>      <span class=c1>// Convert Sequelize object to plain JavaScript object
</span></span></span><span class="line hl"><span class=cl><span class=c1></span>      <span class=nx>user</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>user</span><span class=p>))</span>
</span></span><span class="line hl"><span class=cl>      <span class=k>return</span> <span class=nx>next</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span>
</span></span><span class="line hl"><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>Now, when we try to log in using any username, we&rsquo;ll either be logged in as an existing user, or a new user will be created. We can see this in our log output:</p><div class=tab-panel data-tab-group=ed720bbe2dd51003b543cd312ed67c2a><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=output class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("ed720bbe2dd51003b543cd312ed67c2a","output")'>
<span class=tab-nav-text>output</span></button></div><div class=tab-content-container><div data-tab-item=output class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0><code>[2025-03-20 07:15:17.256 PM] http:      GET /auth/cas 302 0.697 ms - 0
[2025-03-20 07:15:23.525 PM] debug:     New user created via login: russfeld
[2025-03-20 07:15:23.564 PM] http:      GET /auth/cas?ticket=aac12881-9bea-449c-bf13-b981525cc8db 302 218.923 ms - 30
[2025-03-20 07:15:23.721 PM] http:      GET / 200 1.299 ms - -</code></pre></div></div></div></div></div><p>That&rsquo;s all there is to it! Of course, we can also configure this process to automatically assign roles to our newly created user, but for right now we won&rsquo;t worry about that.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=testing-authentication>Testing Authentication</h1><a href="https://www.youtube.com/watch?v=id">YouTube Video</a><h2 id=testing-authentication-routes>Testing Authentication Routes</h2><p>Now that we have our authentication system working for our application, let&rsquo;s write some unit tests to confirm that it works as expected in a variety of situations.</p><p>As part of these tests, we&rsquo;ll end up creating a <a href=https://en.wikipedia.org/wiki/Test_double rel=external target=_blank>test double</a> of one part of our authentication system to make it easier to test. To do this, we&rsquo;ll use the <a href=https://sinonjs.org/ rel=external target=_blank>Sinon</a> library, so let&rsquo;s start by installing it as a development dependency:</p><div class=tab-panel data-tab-group=a3791a61bb6c01195ab0602fd103eb9f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=terminal class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("a3791a61bb6c01195ab0602fd103eb9f","terminal")'>
<span class=tab-nav-text>terminal</span></button></div><div class=tab-content-container><div data-tab-item=terminal class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ npm install --save-dev sinon</span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll store these tests in the <code>test/auth.js</code> file, starting with this content including the libraries we&rsquo;ll need to use:</p><div class=tab-panel data-tab-group=66d93a2d948250523f77f65e21a98d8e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("66d93a2d948250523f77f65e21a98d8e","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @file /auth Route Tests
</span></span></span><span class=line><span class=cl><span class=cm> * @author Russell Feldhausen &lt;russfeld@ksu.edu&gt;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Load Libraries
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>request</span> <span class=nx>from</span> <span class=s2>&#34;supertest&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>use</span><span class=p>,</span> <span class=nx>should</span><span class=p>,</span> <span class=nx>expect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;chai&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiJsonSchemaAjv</span> <span class=nx>from</span> <span class=s2>&#34;chai-json-schema-ajv&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>chaiShallowDeepEqual</span> <span class=nx>from</span> <span class=s2>&#34;chai-shallow-deep-equal&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>sinon</span> <span class=nx>from</span> <span class=s2>&#34;sinon&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>jsonwebtoken</span> <span class=nx>from</span> <span class=s2>&#34;jsonwebtoken&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiJsonSchemaAjv</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span> <span class=nx>verbose</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=nx>use</span><span class=p>(</span><span class=nx>chaiShallowDeepEqual</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Express application
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>app</span> <span class=nx>from</span> <span class=s2>&#34;../app.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Import Database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>User</span><span class=p>,</span> <span class=nx>Role</span> <span class=p>}</span> <span class=nx>from</span> <span class=s2>&#34;../models/models.js&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Modify Object.prototype for BDD style assertions
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>should</span><span class=p>();</span></span></span></code></pre></div></div></div></div></div><p>We&rsquo;ll continue to build out tests below that content in the same file.</p><h3 id=testing-bypass-authentication>Testing Bypass Authentication</h3><p>First, let&rsquo;s look at some tests for the <code>/auth/bypass</code> route, since that is the simplest. The first test is a very simple one to confirm that bypass authentication works, and also that it sets the expected cookie in the browser when it redirects the user back to the home page:</p><div class=tab-panel data-tab-group=024dcfd6f3032566380cd3168f46c6cc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("024dcfd6f3032566380cd3168f46c6cc","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Regular expression to match the expected cookie
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>regex_valid</span> <span class=o>=</span> <span class=s2>&#34;^&#34;</span> <span class=o>+</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_NAME</span> <span class=o>+</span> <span class=s2>&#34;=\\S*; Path=/; HttpOnly$&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test Bypass authentication
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>bypassAuth</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should allow bypass login with user &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// List of existing users to be tested
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>users</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;admin&#34;</span><span class=p>,</span> <span class=s2>&#34;contributor&#34;</span><span class=p>,</span> <span class=s2>&#34;manager&#34;</span><span class=p>,</span> <span class=s2>&#34;user&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /bypass&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>bypassAuth</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Notice that we are using a <a href=https://en.wikipedia.org/wiki/Regular_expression rel=external target=_blank>regular expression</a> to help us verify that the cookie being sent to the user is using the correct name and has the expected content.</p><p>Next, we also should test to make sure that using bypass authentication with any unknown username will create that user:</p><div class=tab-panel data-tab-group=d60c2231dadb6759f3b76593208c8d40><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("d60c2231dadb6759f3b76593208c8d40","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test Bypass authentication creates user
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>bypassAuthCreatesUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should allow bypass login with new user &#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>          <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>user</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>found_user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>expect</span><span class=p>(</span><span class=nx>found_user</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>not</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>found_user</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;username&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>expect</span><span class=p>(</span><span class=nx>found_user</span><span class=p>.</span><span class=nx>username</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /bypass&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>bypassAuth</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>bypassAuthCreatesUser</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This test will first log the user in, then it will directly check the database to ensure that the user has been created successfully. Alternatively, we could also use the API, but we&rsquo;re trying to keep our tests independent, so in this case it makes the most sense to query the database directly in our test instead of any other method.</p><h3 id=testing-cas-authentication>Testing CAS Authentication</h3><p>Next, let&rsquo;s write the tests for our CAS authentication strategy. These are similar to the ones we&rsquo;ve already written, but they have some key differences as well.</p><p>First, we can write a simple test just to show that any user who visits the <code>/auth/cas</code> route will be properly redirected to the correct CAS server:</p><div class=tab-panel data-tab-group=899331b769112b7cbb51c2344e703b9f><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("899331b769112b7cbb51c2344e703b9f","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test CAS authentication redirect
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>casAuthRedirect</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should redirect users to CAS server&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>expectedURL</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_URL</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;/login?service=&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>      <span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_SERVICE_URL</span> <span class=o>+</span> <span class=s2>&#34;/auth/cas&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/cas&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=nx>expectedURL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /cas&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>casAuthRedirect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this test, we are building the URL that the user should be redirected to, based on the settings we have already set in our environment file. Then, we simply check that the returned response is an HTTP 302 Found response with the correct location indicated.</p><p>The next two tests are much more complex, because they require us to mock the step where our server confirms that the user is authenticated with the CAS server by sending a request with a ticket attached, and then getting a response for that ticket. We can do this using a bit of clever coding and the [Sinon] library.</p><p>First, we need to mock up a response object that mimics what the server would respond with. This is mocked just so it will be understood by our CAS authentication library and may not work in all cases:</p><div class=tab-panel data-tab-group=f0aa7fe3dddb002f993af5939533bd08><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("f0aa7fe3dddb002f993af5939533bd08","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Helper function to generate a valid mock CAS 2.0 Ticket
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>validTicket</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>ticket</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span><span class=o>:</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=sb>`&lt;cas:serviceResponse xmlns:cas=&#39;http://www.yale.edu/tp/cas&#39;&gt;
</span></span></span><span class=line><span class=cl><span class=sb>          &lt;cas:authenticationSuccess&gt;
</span></span></span><span class=line><span class=cl><span class=sb>              &lt;cas:user&gt;</span><span class=si>${</span><span class=nx>user</span><span class=si>}</span><span class=sb>&lt;/cas:user&gt;
</span></span></span><span class=line><span class=cl><span class=sb>              &lt;cas:ksuPersonWildcatID&gt;</span><span class=si>${</span><span class=mi>123456789</span><span class=si>}</span><span class=sb>&lt;/cas:ksuPersonWildcatID&gt;
</span></span></span><span class=line><span class=cl><span class=sb>              &lt;cas:proxyGrantingTicket&gt;</span><span class=si>${</span><span class=nx>ticket</span><span class=si>}</span><span class=sb>&lt;/cas:proxyGrantingTicket&gt;
</span></span></span><span class=line><span class=cl><span class=sb>          &lt;/cas:authenticationSuccess&gt;
</span></span></span><span class=line><span class=cl><span class=sb>        &lt;/cas:serviceResponse&gt;`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span></code></pre></div></div></div></div></div><p>This function creates an object with a single method <code>text()</code> that will return a valid XML ticket for the given user and random ticket ID.</p><p>Right below that, we can create a unit test that will mock the global <code>fetch</code> function used by our CAS authentication strategy to contact the CAS server to validate the ticket, and instead it will respond with our mock response object created above:</p><div class=tab-panel data-tab-group=13efd76204dabd8211ebbe7cb024c7bf><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("13efd76204dabd8211ebbe7cb024c7bf","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test CAS with valid ticket
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>casAuthValidTicket</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should log in user &#34;</span> <span class=o>+</span> <span class=nx>user</span> <span class=o>+</span> <span class=s2>&#34; via CAS&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ticket</span> <span class=o>=</span> <span class=s2>&#34;abc123&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>fetchStub</span> <span class=o>=</span> <span class=nx>sinon</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>stub</span><span class=p>(</span><span class=nx>global</span><span class=p>,</span> <span class=s2>&#34;fetch&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>resolves</span><span class=p>(</span><span class=nx>validTicket</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>ticket</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/cas?ticket=&#34;</span> <span class=o>+</span> <span class=nx>ticket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>sinon</span><span class=p>.</span><span class=nx>assert</span><span class=p>.</span><span class=nx>calledOnce</span><span class=p>(</span><span class=nx>fetchStub</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>fetchStub</span><span class=p>.</span><span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]).</span><span class=nx>to</span><span class=p>.</span><span class=nx>contain</span><span class=p>(</span><span class=s2>&#34;?ticket=&#34;</span> <span class=o>+</span> <span class=nx>ticket</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Restore sinon stubs after each test
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>afterEach</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>sinon</span><span class=p>.</span><span class=nx>restore</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /cas&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>casAuthRedirect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>casAuthValidTicket</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this test, we create a <code>fetchStub</code> object that is used by our CAS authentication strategy in place of <code>fetch</code>. It will confirm that the user has a valid ticket and can be authenticated, so we can perform the same steps as before and ensure that the cookie is properly set when the user is authenticated.</p><p>We also are checking that the <code>fetch</code> method we mocked was actually called once, and that it contained the ticket we provided as part of the URL. This is just a sanity check to make sure that we mocked up the correct part of our application!</p><p>We must also add a new <code>afterEach()</code> hook for Mocha, which will reset all functions and objects that are mocked by Sinon after each test. This ensures we are always working with a clean slate.</p><p>Finally, we also should confirm that logging in via CAS will create a new user if the username is not recognized. This test builds upon the previous CAS test in a way similar to the one used for bypass authentication above:</p><div class=tab-panel data-tab-group=119b45ef345f14c3aeebd5f70ea17739><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("119b45ef345f14c3aeebd5f70ea17739","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test CAS creates user
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>casAuthValidTicketCreatesUser</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should create new user &#34;</span> <span class=o>+</span> <span class=nx>user</span> <span class=o>+</span> <span class=s2>&#34; via CAS&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ticket</span> <span class=o>=</span> <span class=s2>&#34;abc123&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>fetchStub</span> <span class=o>=</span> <span class=nx>sinon</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>stub</span><span class=p>(</span><span class=nx>global</span><span class=p>,</span> <span class=s2>&#34;fetch&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>resolves</span><span class=p>(</span><span class=nx>validTicket</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>ticket</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/cas?ticket=&#34;</span> <span class=o>+</span> <span class=nx>ticket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>sinon</span><span class=p>.</span><span class=nx>assert</span><span class=p>.</span><span class=nx>calledOnce</span><span class=p>(</span><span class=nx>fetchStub</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>expect</span><span class=p>(</span><span class=nx>fetchStub</span><span class=p>.</span><span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]).</span><span class=nx>to</span><span class=p>.</span><span class=nx>contain</span><span class=p>(</span><span class=s2>&#34;?ticket=&#34;</span> <span class=o>+</span> <span class=nx>ticket</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>          <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>user</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>found_user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>expect</span><span class=p>(</span><span class=nx>found_user</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>not</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>found_user</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;username&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>expect</span><span class=p>(</span><span class=nx>found_user</span><span class=p>.</span><span class=nx>username</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /cas&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>casAuthRedirect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>casAuthValidTicket</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>casAuthValidTicketCreatesUser</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>As before, this will log a user in via CAS, confirm that it works, and then check in the database to make sure that the new user is properly created.</p><h3 id=testing-jwt>Testing JWT</h3><p>Now that we&rsquo;ve tested both ways to log into our application, we can write some tests to confirm that users can properly request a JWT to be used in our frontend later on. So, our first test simply checks to make sure a user with a valid session can request a token:</p><div class=tab-panel data-tab-group=584d676f4695c3f37e4bef4e27fac449><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("584d676f4695c3f37e4bef4e27fac449","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test user can request a valid token
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>userCanRequestToken</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should allow user &#34;</span> <span class=o>+</span> <span class=nx>user</span> <span class=o>+</span> <span class=s2>&#34; to request valid JWT&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>agent</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;token&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>decode</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>token</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>token</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;username&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>token</span><span class=p>.</span><span class=nx>username</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /token&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this test, we must use a persistent browser agent to make our requests. This will ensure that any cookies or other settings are saved between requests. Thankfully, the <a href=https://www.npmjs.com/package/supertest rel=external target=_blank>Supertest</a> library we are using already has that functionality, so all we have to do is create an <code>agent</code> for our testing as shown in the test above. Once we have successfully logged in, we can confirm that the <code>/auth/token</code> endpoint sends a valid JWT that contains information about the current user. For these tests, we are using bypass authentication for simplicity, but any authentication method could be used.</p><p>When we run the tests at the bottom of the file, notice that we are running this for all existing users, as well as a newly created user. Both types of users should be able to request a token for our application.</p><p>Next, let&rsquo;s confirm that all of a user&rsquo;s roles are listed in the JWT issued for that user. This is important because, later on in this example, we&rsquo;ll be using those roles to implement role-based authorization in our application, so it is vital to make sure our JWTs include the correct roles:</p><div class=tab-panel data-tab-group=e1b6526f2d0f1038f1a1fc2e5be86cf6><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e1b6526f2d0f1038f1a1fc2e5be86cf6","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test user roles are correctly listed in token
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>userRolesAreCorrectInToken</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should contain correct roles for user &#34;</span> <span class=o>+</span> <span class=nx>user</span> <span class=o>+</span> <span class=s2>&#34; in JWT&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>agent</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>be</span><span class=p>.</span><span class=nx>an</span><span class=p>(</span><span class=s2>&#34;object&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;token&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>jsonwebtoken</span><span class=p>.</span><span class=nx>decode</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>token</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>User</span><span class=p>.</span><span class=nx>findOne</span><span class=p>({</span>
</span></span><span class=line><span class=cl>              <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;username&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>              <span class=nx>include</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>model</span><span class=o>:</span> <span class=nx>Role</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>as</span><span class=o>:</span> <span class=s2>&#34;roles&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>attributes</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;role&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=nx>through</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nx>attributes</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>              <span class=p>},</span>
</span></span><span class=line><span class=cl>              <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>username</span><span class=o>:</span> <span class=nx>user</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>}).</span><span class=nx>then</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>if</span> <span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>length</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>token</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;roles&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>expect</span><span class=p>(</span><span class=nx>token</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>length</span><span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>user</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>expected_role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nx>expect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=nx>token</span><span class=p>.</span><span class=nx>roles</span><span class=p>.</span><span class=nx>some</span><span class=p>((</span><span class=nx>role</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>role</span><span class=p>.</span><span class=nx>id</span> <span class=o>==</span> <span class=nx>expected_role</span><span class=p>.</span><span class=nx>id</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                  <span class=p>).</span><span class=nx>to</span><span class=p>.</span><span class=nx>equal</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>});</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>token</span><span class=p>.</span><span class=nx>should</span><span class=p>.</span><span class=nx>not</span><span class=p>.</span><span class=nx>have</span><span class=p>.</span><span class=nx>property</span><span class=p>(</span><span class=s2>&#34;roles&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /token&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>userRolesAreCorrectInToken</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>userRolesAreCorrectInToken</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>This test may seem very long and verbose, but it is very straightforward. We first login and request a token for a user, and then we also look up that user in the database including all associated roles. Then, we simply assert that the number of roles in the token is the same as the number of them in the database, and if there are any roles that each role is found as expected.</p><p>Finally, we should write one additional test, that simply confirms that the application will not allow anyone to request a token if they are not currently logged in:</p><div class=tab-panel data-tab-group=e082dcab3e16e65e76954d5b33d43b35><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("e082dcab3e16e65e76954d5b33d43b35","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * User must have a valid session to request a token
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>mustBeLoggedInToRequestToken</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should not allow a user to request a token without logging in&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>(</span><span class=nx>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>401</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /token&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>users</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nx>userRolesAreCorrectInToken</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>userCanRequestToken</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>userRolesAreCorrectInToken</span><span class=p>(</span><span class=s2>&#34;testuser&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>mustBeLoggedInToRequestToken</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>For this test, we simply check that the application returns an HTTP 401 response if the user tries to request a token without first being logged in.</p><h3 id=testing-logout>Testing Logout</h3><p>Finally, we can write a few tests to make sure our logout process is also working as expected. The first test will confirm that the session cookie we are using is properly removed from the user&rsquo;s browser when they log out:</p><div class=tab-panel data-tab-group=b9a2069c8c87e3bf45b796d832f403d0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("b9a2069c8c87e3bf45b796d832f403d0","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Regular expression to match deleting the cookie
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>regex_destroy</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;^&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>  <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>SESSION_NAME</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT$&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Logout will remove the cookie
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>logoutDestroysCookie</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should remove the cookie on logout&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re_destroy</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_destroy</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>agent</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/logout&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re_destroy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /logout&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutDestroysCookie</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this test, we are looking for a second <code>set-cookie</code> header to be sent when the user logs out. This header will both contain an empty cookie, but also will set the cookie&rsquo;s expiration date to the earliest date possible. So, we can simply look for that header to confirm our cookie is being properly removed and expired from the user&rsquo;s browser when they log out. We only really have to test this for a single username, since the process is identical for all of them.</p><p>Next, we should also confirm that the logout process will redirect users to the CAS server as well and log them out of any existing CAS sessions.</p><div class=tab-panel data-tab-group=949f3d58ade0133590acb706378ef796><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("949f3d58ade0133590acb706378ef796","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Regular expression for redirecting to CAS
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>regex_redirect</span> <span class=o>=</span> <span class=s2>&#34;^&#34;</span> <span class=o>+</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>CAS_URL</span> <span class=o>+</span> <span class=s2>&#34;/logout\\?service=\\S*$&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Logout redirects to CAS
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>logoutRedirectsToCas</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should redirect to CAS on logout&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re_redirect</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_redirect</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>agent</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/logout&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=nx>re_redirect</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /logout&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutDestroysCookie</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutRedirectsToCas</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>Once again, we are simply checking the <code>Location</code> header of the HTTP 302 Found response received from our application. We are making use of regular expressions to ensure we are being properly redirected to the correct CAS server and the <code>logout</code> route on that server.</p><p>Finally, we should confirm that once a user has logged out, they are no longer able to request a new token from the application:</p><div class=tab-panel data-tab-group=4e5a6de0126a938142ad593377b22be7><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=testauthjs class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("4e5a6de0126a938142ad593377b22be7","testauthjs")'>
<span class=tab-nav-text>test/auth.js</span></button></div><div class=tab-content-container><div data-tab-item=testauthjs class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Logout prevents requesting a token
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>logoutPreventsToken</span> <span class=o>=</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>it</span><span class=p>(</span><span class=s2>&#34;should prevent access to token after logging out&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>re</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>RegExp</span><span class=p>(</span><span class=nx>regex_valid</span><span class=p>,</span> <span class=s2>&#34;gm&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>agent</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>agent</span><span class=p>(</span><span class=nx>app</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>agent</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/bypass?token=&#34;</span> <span class=o>+</span> <span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;Location&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=s2>&#34;set-cookie&#34;</span><span class=p>,</span> <span class=nx>re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>agent</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nx>agent</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/logout&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=nx>agent</span>
</span></span><span class=line><span class=cl>                  <span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;/auth/token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                  <span class=p>.</span><span class=nx>expect</span><span class=p>(</span><span class=mi>401</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                  <span class=p>.</span><span class=nx>end</span><span class=p>((</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>done</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=nx>done</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                  <span class=p>});</span>
</span></span><span class=line><span class=cl>              <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Test /auth/ routes
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;/auth&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// -=-=- other code omitted here -=-=-
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>describe</span><span class=p>(</span><span class=s2>&#34;GET /logout&#34;</span><span class=p>,</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutDestroysCookie</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutRedirectsToCas</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>logoutPreventsToken</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></div></div></div></div></div><p>In this test, we simply log in, request a token, then log out, and show that the application will no longer allow us to request a token, even though we are using the same user agent as before. This is a great way to confirm that our entire process is working!</p><p>Now is a great time to lint, format, and commit our code to GitHub before continuing!</p><footer class=footline></footer></article></section><article class=default><header class=headline></header><h1 id=vuejs-starter-project>Vue.js Starter Project</h1><p>This example project builds on the previous RESTful API project by scaffolding a frontend application using Vue.js. This will become the basis for a full frontend for the application over the next few projects.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li></li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=vuejs-crud-app>Vue.js CRUD App</h1><p>This example project builds on the previous Vue.js starter project by scaffolding a CRUD frontend for the basic users and roles tables.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li></li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=vuejs-components>Vue.js Components</h1><p>This example project builds on the previous Vue.js CRUD app by building a few custom components to view and update data in the application.</p><h2 id=project-deliverables>Project Deliverables</h2><p>At the end of this example, we will have a project with the following features:</p><ol><li></li></ol><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Prior Work</div><div class=box-content><p>This project picks up right where the last one left off, so if you haven&rsquo;t completed that one yet, go back and do that before starting this one.</p></div></div><p>Let&rsquo;s get started!</p><footer class=footline></footer></article></section></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/eab4787eeb0b013f81af1812b804dc69fe85d9bd>Mar 3, 2025</a></p></div></div><script src=/cis526/js/clipboard.min.js?1742510271 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1742510271 defer></script><script src=/cis526/js/theme.js?1742510271 defer></script></body></html>
<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="Perhaps the simplest persistent storage mechanism we can adopt is to use a combination of an in-memory variable and a file. For example, we could set up a simple database mechanism as a Node module:
const fs = require('fs'); /** @module database * A simple in-memory database implementation, * providing a mechanism for getting and saving * a database object */ module.exports = { get, set }; // We retrieve and deserialize the database from // a file named data."><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Data Serialization :: CIS 526 Textbook"><meta name=twitter:description content="Perhaps the simplest persistent storage mechanism we can adopt is to use a combination of an in-memory variable and a file. For example, we could set up a simple database mechanism as a Node module:
const fs = require('fs'); /** @module database * A simple in-memory database implementation, * providing a mechanism for getting and saving * a database object */ module.exports = { get, set }; // We retrieve and deserialize the database from // a file named data."><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/07-persistent-storage/02-data-serialization/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Data Serialization :: CIS 526 Textbook"><meta property="og:description" content="Perhaps the simplest persistent storage mechanism we can adopt is to use a combination of an in-memory variable and a file. For example, we could set up a simple database mechanism as a Node module:
const fs = require('fs'); /** @module database * A simple in-memory database implementation, * providing a mechanism for getting and saving * a database object */ module.exports = { get, set }; // We retrieve and deserialize the database from // a file named data."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="Persistent Storage"><meta property="article:published_time" content="2018-08-24T10:53:26-05:00"><meta property="article:modified_time" content="2021-07-01T15:48:20-05:00"><meta itemprop=name content="Data Serialization :: CIS 526 Textbook"><meta itemprop=description content="Perhaps the simplest persistent storage mechanism we can adopt is to use a combination of an in-memory variable and a file. For example, we could set up a simple database mechanism as a Node module:
const fs = require('fs'); /** @module database * A simple in-memory database implementation, * providing a mechanism for getting and saving * a database object */ module.exports = { get, set }; // We retrieve and deserialize the database from // a file named data."><meta itemprop=datePublished content="2018-08-24T10:53:26-05:00"><meta itemprop=dateModified content="2021-07-01T15:48:20-05:00"><meta itemprop=wordCount content="946"><title>Data Serialization :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/07-persistent-storage/02-data-serialization/ rel=canonical type=text/html title="Data Serialization :: CIS 526 Textbook"><link href=/cis526/07-persistent-storage/02-data-serialization/index.xml rel=alternate type=application/rss+xml title="Data Serialization :: CIS 526 Textbook"><link href=/cis526/07-persistent-storage/02-data-serialization/index.print.html rel=alternate type=text/html title="Data Serialization :: CIS 526 Textbook"><link href=/cis526/07-persistent-storage/02-data-serialization/embed.html rel=alternate type=text/html title="Data Serialization :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1738695571 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1738695571 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1738695571 rel=stylesheet><link href=/cis526/css/auto-complete.css?1738695571 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1738695571 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1738695571 rel=stylesheet><link href=/cis526/css/fonts.css?1738695571 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1738695571 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1738695571 rel=stylesheet><link href=/cis526/css/theme-auto.css?1738695571 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1738695571 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1738695571 rel=stylesheet><link href=/cis526/css/print.css?1738695571 rel=stylesheet media=print><script src=/cis526/js/variant.js?1738695571></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../..",window.relearn.relBaseUri="../../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1738695571 rel=stylesheet></head><body class="mobile-support tele disableInlineCopyToClipboard" data-url=/cis526/07-persistent-storage/02-data-serialization/><div id=tele class="tele mirror"><div id=R-body class=default-animation><div id=R-body-overlay></div><div id=R-main-overlay></div><main id=R-body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=data-serialization>Data Serialization</h1><p>Perhaps the simplest persistent storage mechanism we can adopt is to use a combination of an in-memory variable and a file. For example, we could set up a simple database mechanism as a Node module:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** @module database 
</span></span></span><span class=line><span class=cl><span class=cm> * A simple in-memory database implementation, 
</span></span></span><span class=line><span class=cl><span class=cm> * providing a mechanism for getting and saving 
</span></span></span><span class=line><span class=cl><span class=cm> * a database object
</span></span></span><span class=line><span class=cl><span class=cm> */</span> 
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>get</span><span class=p>,</span> <span class=nx>set</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// We retrieve and deserialize the database from 
</span></span></span><span class=line><span class=cl><span class=c1>// a file named data.json.  We deliberately don&#39;t 
</span></span></span><span class=line><span class=cl><span class=c1>// catch errors, as if this process fails, we want 
</span></span></span><span class=line><span class=cl><span class=c1>// to stop the server loading process
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>fileData</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;data.json&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>fileData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** @function get()
</span></span></span><span class=line><span class=cl><span class=cm> * Returns the database object 
</span></span></span><span class=line><span class=cl><span class=cm> * @returns {object} data - the data object
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>get</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** @function set()
</span></span></span><span class=line><span class=cl><span class=cm> * Saves the provided object as the database data, 
</span></span></span><span class=line><span class=cl><span class=cm> * overwriting the current object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {object} newData - the object to save 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {function} callback - triggered after save 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>set</span><span class=p>(</span><span class=nx>newData</span><span class=p>,</span> <span class=nx>callback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Here we don&#39;t want the server to crash on 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// an error, so we do wrap it in a try/catch
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>fileData</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>newData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>fs</span><span class=p>.</span><span class=nx>writeFile</span><span class=p>(</span><span class=s2>&#34;data.json&#34;</span><span class=p>,</span> <span class=nx>fileData</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// If there was an error writing the data, we pass it 
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// forward in the callback and don&#39;t save the changes
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// to the data object
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>callback</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// If there was no error, we save the changes to the 
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// module&#39;s data object (the variable data declared above)
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>data</span> <span class=o>=</span> <span class=nx>newData</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Then we invoke the callback to notify of success by sending 
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// a value of null for the error
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>callback</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If we catch an error in the JSON stringification process,
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// we&#39;ll pass it through the callback 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>callback</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>In this module, we exploit a feature of Node&rsquo;s <a href=https://nodejs.org/en/knowledge/getting-started/what-is-require/ rel=external target=_blank>require</a>, in that it <em>caches</em> the value returned by the <code>require()</code> function for each unique argument. So the first time we use <code>require('./database')</code>, we process the above code. Node internally stores the result (an object with the <code>get()</code> and <code>set()</code> method) in its module cache, and the next time we use <code>require('./database')</code> in our program, this object is what is required. Effectively, you end up using the same <code>data</code> variable every time you <code>require('./database')</code>. This is an application of the <a href=https://en.wikipedia.org/wiki/Singleton_pattern rel=external target=_blank>Singleton Pattern</a> in a form unique to Node.</p><h2 id=refactoring-for-better-error-prevention>Refactoring for Better Error Prevention</h2><p>While this module can work well, it does suffer from a number of limitations. Perhaps the most important to recognize is that the <code>get()</code> method returns a reference to our aforementioned <code>data</code> variable - so if you change the value of the variable, you change it for all future <code>get()</code> function calls, while sidestepping the persistent file write embodied in our <code>set()</code>. Instead of providing a reference, we could instead provide a copy. A simple trick to do so in JavaScript is to serialize and then deserialize the object (turning it into a JSON string and then back into an object). The refactored <code>get()</code> would then look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/** @function get()
</span></span></span><span class=line><span class=cl><span class=cm> * Returns A COPY OF the database object 
</span></span></span><span class=line><span class=cl><span class=cm> * @returns {object} data - A COPY OF the data object
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>get</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Note that there is a possibility this process can fail, so it really should be wrapped in a <code>try/catch</code> and refactored to use a callback to pass on this possible error and the data object:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/** @function get()
</span></span></span><span class=line><span class=cl><span class=cm> * Provides a copy of the data object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {function} callback - Provides as the first parameter any errors, 
</span></span></span><span class=line><span class=cl><span class=cm> * and as the second a copy of the data object.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>get</span><span class=p>(</span><span class=nx>callback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>dataCopy</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nx>callback</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>dataCopy</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>callback</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Notice that with this refactoring, we are using the same pattern common to the Node modules we&rsquo;ve been working with. There is a second benefit here is that if we needed to convert our <code>get()</code> from a synchronous to asynchronous implementation, our function definition won&rsquo;t change (the <code>set()</code> is already asynchronous, as we use the asynchronous <code>fs.writeFile()</code>).</p><h2 id=other-limitations>Other Limitations</h2><p>This database implementation is still pretty basic - we retrieve an entire object rather than just the portion of the database we need, and we write the entire database on every change as well. If our database gets to be very large, this will become an expensive operation.</p><p>There is also a lot of missed opportunity for optimizing how we get the specific data we need. As you have learned in your algorithms and data structures course, the right search algorithm, coupled with the right data structure, can vastly improve how quickly your program can run. If we think about the work that a webserver does, the retrieval of data for building dynamic HTML based on it is easily one of the most time-consuming aspects, so optimizing here can make each page creation move much faster. Faster page creation means shorter response times, and more users served per minute with less processing power. That, in turn means less electricity, less bandwidth, and less hardware is required to run your website. In heavily utilized websites, this can equate to a lot of savings! And for websites hosted on elastic hosting services (those that only charge for the resources you use), it can also result in significant savings.</p><p>Thus, we might want to spend more time developing a robust database program that would offer these kinds of optimizations. Or, we could do what most full-stack developers do, and use an already existing database program that was designed with these kinds of optimizations in mind. We&rsquo;ll take a look at that approach next.</p><footer class=footline></footer></article></div></main></div></div><script src=/cis526/js/clipboard.min.js?1738695571 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1738695571 defer></script><script src=/cis526/js/theme.js?1738695571 defer></script><script src=/cis526/js/tele-scroll.js?1738695571 defer></script></body></html>
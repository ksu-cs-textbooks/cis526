<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=generator content="Relearn 6.0.0"><meta name=description content="Tupperware for the Web"><meta name=author content="Nathan Bean"><meta name=twitter:card content="summary"><meta name=twitter:title content="Persistent Storage :: CIS 526 Textbook"><meta name=twitter:description content="Tupperware for the Web"><meta property="og:url" content="https://textbooks.cs.ksu.edu/cis526/07-persistent-storage/"><meta property="og:site_name" content="CIS 526 Textbook"><meta property="og:title" content="Persistent Storage :: CIS 526 Textbook"><meta property="og:description" content="Tupperware for the Web"><meta property="og:locale" content="en-us"><meta property="og:type" content="website"><meta itemprop=name content="Persistent Storage :: CIS 526 Textbook"><meta itemprop=description content="Tupperware for the Web"><meta itemprop=datePublished content="2018-08-24T10:53:05-05:00"><meta itemprop=dateModified content="2023-08-10T16:48:12-05:00"><meta itemprop=wordCount content="4"><title>Persistent Storage :: CIS 526 Textbook</title>
<link href=https://textbooks.cs.ksu.edu/cis526/07-persistent-storage/ rel=canonical type=text/html title="Persistent Storage :: CIS 526 Textbook"><link href=/cis526/07-persistent-storage/index.xml rel=alternate type=application/rss+xml title="Persistent Storage :: CIS 526 Textbook"><link href=/cis526/07-persistent-storage/tele.html rel=alternate type=text/html title="Persistent Storage :: CIS 526 Textbook"><link href=/cis526/07-persistent-storage/embed.html rel=alternate type=text/html title="Persistent Storage :: CIS 526 Textbook"><link href=/cis526/css/fontawesome-all.min.css?1741019922 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fontawesome-all.min.css?1741019922 rel=stylesheet></noscript><link href=/cis526/css/nucleus.css?1741019922 rel=stylesheet><link href=/cis526/css/auto-complete.css?1741019922 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/auto-complete.css?1741019922 rel=stylesheet></noscript><link href=/cis526/css/perfect-scrollbar.min.css?1741019922 rel=stylesheet><link href=/cis526/css/fonts.css?1741019922 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/cis526/css/fonts.css?1741019922 rel=stylesheet></noscript><link href=/cis526/css/theme.css?1741019922 rel=stylesheet><link href=/cis526/css/theme-auto.css?1741019922 rel=stylesheet id=R-variant-style><link href=/cis526/css/chroma-auto.css?1741019922 rel=stylesheet id=R-variant-chroma-style><link href=/cis526/css/variant.css?1741019922 rel=stylesheet><link href=/cis526/css/print.css?1741019922 rel=stylesheet media=print><link href=/cis526/css/format-print.css?1741019922 rel=stylesheet><script src=/cis526/js/variant.js?1741019922></script><script>window.relearn=window.relearn||{},window.relearn.relBasePath="..",window.relearn.relBaseUri="../..",window.relearn.absBaseUri="https://textbooks.cs.ksu.edu/cis526",window.index_js_url="/cis526/index.search.js",window.variants&&variants.init(["auto","light-theme","dark-theme"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link href=/cis526/css/custom.css?1741019922 rel=stylesheet></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/cis526/07-persistent-storage/><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Persistent Storage</span><meta itemprop=position content="1"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/06-dynamic-web-servers/13-summary/ title="Summary (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/cis526/07-persistent-storage/01-introduction/ title="Introduction (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable chapter narrow" tabindex=-1><div class=flex-block-wrapper><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 7</div><h1 id=persistent-storage>Persistent Storage</h1><p>Tupperware for the Web</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Persistent Storage</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><p>Of course, what made dynamic web servers interesting was that they could provide content built <em>dynamically</em>. In this approach, the HTML the server sends as a response does not need to be stored on the server as a HTML file, rather it can be constructed when a request is made.</p><p>That said, most web applications still need a persistent storage mechanism to use in dynamically creating those pages. If we&rsquo;re dealing with a forum, we need to store the text for the posts. If we&rsquo;re running an e-commerce site, we aren&rsquo;t making up products, we&rsquo;re selling those already in our inventory.</p><p>Thus, we need some kind of storage mechanism to hold the information we need to create our dynamic pages. We could use a variable and hold those values in memory, but we&rsquo;d also need a mechanism to <em>persist</em> those values when our server restarts (as the contents of volatile memory are lost when power is no longer supplied to RAM).</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=data-serialization>Data Serialization</h1><p>Perhaps the simplest persistent storage mechanism we can adopt is to use a combination of an in-memory variable and a file. For example, we could set up a simple database mechanism as a Node module:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** @module database 
</span></span></span><span class=line><span class=cl><span class=cm> * A simple in-memory database implementation, 
</span></span></span><span class=line><span class=cl><span class=cm> * providing a mechanism for getting and saving 
</span></span></span><span class=line><span class=cl><span class=cm> * a database object
</span></span></span><span class=line><span class=cl><span class=cm> */</span> 
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>get</span><span class=p>,</span> <span class=nx>set</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// We retrieve and deserialize the database from 
</span></span></span><span class=line><span class=cl><span class=c1>// a file named data.json.  We deliberately don&#39;t 
</span></span></span><span class=line><span class=cl><span class=c1>// catch errors, as if this process fails, we want 
</span></span></span><span class=line><span class=cl><span class=c1>// to stop the server loading process
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>fileData</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;data.json&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>fileData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** @function get()
</span></span></span><span class=line><span class=cl><span class=cm> * Returns the database object 
</span></span></span><span class=line><span class=cl><span class=cm> * @returns {object} data - the data object
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>get</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/** @function set()
</span></span></span><span class=line><span class=cl><span class=cm> * Saves the provided object as the database data, 
</span></span></span><span class=line><span class=cl><span class=cm> * overwriting the current object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {object} newData - the object to save 
</span></span></span><span class=line><span class=cl><span class=cm> * @param {function} callback - triggered after save 
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>set</span><span class=p>(</span><span class=nx>newData</span><span class=p>,</span> <span class=nx>callback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Here we don&#39;t want the server to crash on 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// an error, so we do wrap it in a try/catch
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>fileData</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>newData</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>fs</span><span class=p>.</span><span class=nx>writeFile</span><span class=p>(</span><span class=s2>&#34;data.json&#34;</span><span class=p>,</span> <span class=nx>fileData</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// If there was an error writing the data, we pass it 
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// forward in the callback and don&#39;t save the changes
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// to the data object
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=k>return</span> <span class=nx>callback</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// If there was no error, we save the changes to the 
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// module&#39;s data object (the variable data declared above)
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>data</span> <span class=o>=</span> <span class=nx>newData</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Then we invoke the callback to notify of success by sending 
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// a value of null for the error
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>callback</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// If we catch an error in the JSON stringification process,
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// we&#39;ll pass it through the callback 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>callback</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>In this module, we exploit a feature of Node&rsquo;s <a href=https://nodejs.org/en/knowledge/getting-started/what-is-require/ rel=external target=_blank>require</a>, in that it <em>caches</em> the value returned by the <code>require()</code> function for each unique argument. So the first time we use <code>require('./database')</code>, we process the above code. Node internally stores the result (an object with the <code>get()</code> and <code>set()</code> method) in its module cache, and the next time we use <code>require('./database')</code> in our program, this object is what is required. Effectively, you end up using the same <code>data</code> variable every time you <code>require('./database')</code>. This is an application of the <a href=https://en.wikipedia.org/wiki/Singleton_pattern rel=external target=_blank>Singleton Pattern</a> in a form unique to Node.</p><h2 id=refactoring-for-better-error-prevention>Refactoring for Better Error Prevention</h2><p>While this module can work well, it does suffer from a number of limitations. Perhaps the most important to recognize is that the <code>get()</code> method returns a reference to our aforementioned <code>data</code> variable - so if you change the value of the variable, you change it for all future <code>get()</code> function calls, while sidestepping the persistent file write embodied in our <code>set()</code>. Instead of providing a reference, we could instead provide a copy. A simple trick to do so in JavaScript is to serialize and then deserialize the object (turning it into a JSON string and then back into an object). The refactored <code>get()</code> would then look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/** @function get()
</span></span></span><span class=line><span class=cl><span class=cm> * Returns A COPY OF the database object 
</span></span></span><span class=line><span class=cl><span class=cm> * @returns {object} data - A COPY OF the data object
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>get</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Note that there is a possibility this process can fail, so it really should be wrapped in a <code>try/catch</code> and refactored to use a callback to pass on this possible error and the data object:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=cm>/** @function get()
</span></span></span><span class=line><span class=cl><span class=cm> * Provides a copy of the data object
</span></span></span><span class=line><span class=cl><span class=cm> * @param {function} callback - Provides as the first parameter any errors, 
</span></span></span><span class=line><span class=cl><span class=cm> * and as the second a copy of the data object.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>get</span><span class=p>(</span><span class=nx>callback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>dataCopy</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>data</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nx>callback</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>dataCopy</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>callback</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Notice that with this refactoring, we are using the same pattern common to the Node modules we&rsquo;ve been working with. There is a second benefit here is that if we needed to convert our <code>get()</code> from a synchronous to asynchronous implementation, our function definition won&rsquo;t change (the <code>set()</code> is already asynchronous, as we use the asynchronous <code>fs.writeFile()</code>).</p><h2 id=other-limitations>Other Limitations</h2><p>This database implementation is still pretty basic - we retrieve an entire object rather than just the portion of the database we need, and we write the entire database on every change as well. If our database gets to be very large, this will become an expensive operation.</p><p>There is also a lot of missed opportunity for optimizing how we get the specific data we need. As you have learned in your algorithms and data structures course, the right search algorithm, coupled with the right data structure, can vastly improve how quickly your program can run. If we think about the work that a webserver does, the retrieval of data for building dynamic HTML based on it is easily one of the most time-consuming aspects, so optimizing here can make each page creation move much faster. Faster page creation means shorter response times, and more users served per minute with less processing power. That, in turn means less electricity, less bandwidth, and less hardware is required to run your website. In heavily utilized websites, this can equate to a lot of savings! And for websites hosted on elastic hosting services (those that only charge for the resources you use), it can also result in significant savings.</p><p>Thus, we might want to spend more time developing a robust database program that would offer these kinds of optimizations. Or, we could do what most full-stack developers do, and use an already existing database program that was designed with these kinds of optimizations in mind. We&rsquo;ll take a look at that approach next.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=databases>Databases</h1><p>As we suggested in the previous section, using an already existing database application is a very common strategy for full-stack web development. Doing so has clear benefits - such programs are typically stable, secure, and optimized for data storage and retrieval. They are well beyond what we can achieve ourselves without a significant investment of time, and avoids the necessity of &ldquo;reinventing the wheel&rdquo;.</p><p>That said, making effective use of a third-party database system <em>does</em> require you to develop familiarity with how the database operates and is organized. Gaining the benefits of a database&rsquo;s optimizations requires structuring your data in the way its developers anticipated, and likewise retrieving it in such a manner. The exact details involved vary between database systems and are beyond the scope of this course, which is why you have a database course in your required curriculum. Here I will just introduce the details of how to integrate the use of a database into your web development efforts, and I&rsquo;ll leave the learning of how to best optimize your database structure and queries for that course.</p><p>In the web development world, we primarily work with two kinds of databases, which have a very different conceptual starting point that determines their structure. These are <a href=https://en.wikipedia.org/wiki/Relational_database rel=external target=_blank>Relational Databases</a> and <a href=https://en.wikipedia.org/wiki/Document-oriented_database rel=external target=_blank>Document-oriented Databases</a> (sometimes called No-SQL databases). There is a third category, <a href=https://en.wikipedia.org/wiki/Object_database rel=external target=_blank>Object-oriented Databases</a> that are not widely adopted, and a slew of less-well known and utilized technologies. There are also cloud services that take over the role traditionally filled by databases, which we&rsquo;ll save for a later chapter. For now, we&rsquo;ll focus on the first two, as these are the most commonly adopted in the web development industry.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=relational-databases>Relational Databases</h1><p>Relational databases (also called SQL databases) provide a highly-structured storage mechanism. Data is organized into <em>tables</em>, with each column representing a single value and data type, and each row representing one entry. Conceptually, this organization is similar to tables you have seen in Excel and on the web. An example <em>persons</em> table is listed below:</p><table><thead><tr><th>id</th><th>First</th><th>Last</th></tr></thead><tbody><tr><td>0</td><td>Lisa</td><td>Merkowsky</td></tr><tr><td>1</td><td>Frank</td><td>Stiles</td></tr><tr><td>3</td><td>Mary</td><td>Cotts</td></tr></tbody></table><p>Relational databases are often called SQL databases as we use <em>Structured Query Language (SQL)</em> to communicate with them. This is a domain-specific language similar to the LINQ you may have learned about in CIS 400 (actually, LINQ derives much of its syntax from SQL). Queries are streamed to a relational database across a socket or other connection, much like HTTP requests and responses are. The response is received also as text which must be parsed to be used.</p><p>SQL is used to construct the structure of the database. For example, we could create the above table with the SQL command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>persons</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>Last</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>First</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span></span></span></code></pre></div><p>SQL is also used to <em>query</em> the database. For example, to find all people with the last name &ldquo;Smith&rdquo;, we would use the query:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>persons</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=k>last</span><span class=o>=</span><span class=s1>&#39;Smith&#39;</span><span class=p>;</span></span></span></code></pre></div><p>You will learn more about writing SQL queries in the CIS 560 or CC 520 course. You can also find an excellent guide on <a href=https://www.w3schools.com/sql/ rel=external target=_blank>W3C schools</a>, with interactive tutorials. We&rsquo;ll briefly cover some of the most important aspects of relational databases for web developers here, but you would be wise to seek out additional learning opportunities. Understanding relational databases well can make a great deal of difference in how performant your web applications are.</p><p>The key to performance in relational databases is the use of <em>keys</em> and <em>indices</em>. A key is a column whose values are unique (not allowed to be repeated). For example, the <code>id</code> column in the table above is a key. Specifically, it is a sequential primary key - for each row we add to the table it increases, and its value is determined by the database. Note the jump from <code>1</code> to <code>3</code> - there is no guarantee the keys will always be exactly one more than the previous one (though it commonly is), and if we delete rows from a table, the keys remain the same.</p><h3 id=indices>Indices</h3><p>An index is a specialized data structure that makes searching for data faster. Consider the above table. If we wanted to find all people with the last name &ldquo;Smith&rdquo;, we&rsquo;d need to iterate over each row, looking for &ldquo;Smith&rdquo;. That is a linear $O(n)$ complexity. It would work quickly in our example, but when our table has thousands or millions of rows (not uncommon for large web apps), it would be painfully slow.</p><p>Remember learning about dictionaries or hash tables in your data structures course? The lookup time for one of those structures is constant $O(1)$. Indices work like this - we create a specialized data structure that can provide the index we are looking for, i.e. an index built on the <code>Last</code> column would map <code>last => id</code>. Then we could retrieve all &ldquo;Smith&rdquo; last names from this structure in constant time $O(1)$. Since we know the primary key is unique and ordered, we can use some kind of divide-and-conquer search strategy to find all rows with a primary key in our set of matches, with a complexity of $O(log(n))$. Thus, the complete lookup would be $O(log(n)) + O(1)$, which we would simplify to $O(log(n))$, much faster for a large $n$ than $O(n)$.</p><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>In truth, most SQL databases use <a href=https://en.wikipedia.org/wiki/B-tree rel=external target=_blank>Balanced Trees (B-Trees)</a> for their indices; but the exact data structure is unimportant to us as web developers, as long as retrieval is efficient.</p></div></div><p>We can create an index using SQL. For example, to create an index on the column <code>last</code> in our example, we would use:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>last_index</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>persons</span><span class=w> </span><span class=p>(</span><span class=k>last</span><span class=p>);</span></span></span></code></pre></div><p>An index can involve more than one row - for example, if we expected to search by both first and last name, we&rsquo;d probably create an index that used both as the key. The SQL to do so for both first and last names would be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>both_names</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>persons</span><span class=w> </span><span class=p>(</span><span class=k>last</span><span class=p>,</span><span class=w> </span><span class=k>first</span><span class=p>);</span></span></span></code></pre></div><p>Each index effectively creates a new data structure consuming additional memory, so you should consider which indices are really necessary. Any column or column you frequently look up values by (i.e. are part of the WHERE clause of a query) should be indexed. Columns that are only rarely or never used this way should not be included in indices.</p><h3 id=relationships>Relationships</h3><p>The second important idea behind a relational database is that we can define relationships <em>between</em> tables. Let&rsquo;s add a second table to our example, <em>addresses</em>:</p><table><thead><tr><th>id</th><th>person_id</th><th>street</th><th>city</th><th>state</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>Anderson Ave.</td><td>Manhattan</td><td>KS</td></tr><tr><td>1</td><td>1</td><td>Sesame St.</td><td>Baltimore</td><td>ML</td></tr><tr><td>2</td><td>1</td><td>Moholland Dr.</td><td>Hollywood</td><td>CA</td></tr><tr><td>3</td><td>3</td><td>Cooper Street</td><td>Silver City</td><td>NM</td></tr></tbody></table><p>Here <code>person_id</code> is a <em>foreign key</em>, and corresponds to the <code>id</code> in the <em>persons</em> table. Thus, we can look up the address of Lisa Merkowsky by her <code>id</code> of 0. The row in the <em>addresses</em> table with the value of 0 for <code>person_id</code> is &ldquo;Anderson Ave., Manhattan KS&rdquo;.</p><p>Note too that it is possible for one row in one table to correspond to more than one row in another - in this example Frank Styles has <em>two</em> addresses, one in Baltimore and one in Hollywood.</p><p>If one row in one table corresponds to a single row in another table, we often call this a <em>one-to-one</em> relationship. If one row corresponds to more than one row in another table, we call this a <em>one-to-many</em> relationship. We retrieve these values using a query with a JOIN clause, i.e. to get each person with their addresses, we might use:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=k>last</span><span class=p>,</span><span class=w> </span><span class=k>first</span><span class=p>,</span><span class=w> </span><span class=n>street</span><span class=p>,</span><span class=w> </span><span class=n>city</span><span class=p>,</span><span class=w> </span><span class=k>state</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>persons</span><span class=w> </span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>addresses</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>persons</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addresses</span><span class=p>.</span><span class=n>person_id</span><span class=p>;</span></span></span></code></pre></div><p>The result will also be structured as a table with columns <code>last</code>, <code>first</code>, <code>street</code>, <code>city</code>, and <code>state</code> containing a row for each person. Actually, there will be <em>two</em> rows for Frank, one containing each of his two addresses.</p><p>Finally, it is possible to have a <em>many-to-many</em> relationship, which requires a special table to sit in between the two called a <em>join</em> table. Consider if we had a <em>jobs</em> table:</p><table><thead><tr><th>id</th><th>name</th><th>description</th></tr></thead><tbody><tr><td>0</td><td>Doctor</td><td>A qualified practitioner of medicine; a physician.</td></tr><tr><td>1</td><td>Lawyer</td><td>A person who practices or studies law; an attorney or a counselor.</td></tr><tr><td>2</td><td>Producer</td><td>A person responsible for the financial and managerial aspects of making of a movie or broadcast or for staging a play, opera, etc.</td></tr><tr><td>3</td><td>Detective</td><td>A person, especially a police officer, whose occupation is to investigate and solve crimes.</td></tr></tbody></table>(definitions provided by Oxford Languages)<p>Because more than one person can have the same job, and we might want to look up people by their jobs, or a list of jobs that a specific person has, we would need a join table to connect the two. This could be named <em>persons_jobs</em> and would have a foreign key to both:</p><table><thead><tr><th>id</th><th>person_id</th><th>job_id</th></tr></thead><tbody><tr><td>0</td><td>1</td><td>1</td></tr><tr><td>1</td><td>2</td><td>2</td></tr><tr><td>2</td><td>3</td><td>1</td></tr><tr><td>3</td><td>3</td><td>3</td></tr></tbody></table><p>Thus Lisa is a doctor, Frank a producer, and Mary is both a doctor and detective! We could query for every doctor using a SQL statement with two joins, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=k>first</span><span class=p>,</span><span class=w> </span><span class=k>last</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>jobs</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>persons_jobs</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>jobs</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>persons_jobs</span><span class=p>.</span><span class=n>job_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>persons</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>jobs_persons</span><span class=p>.</span><span class=n>person_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>person</span><span class=p>.</span><span class=n>id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>jobs</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Doctor&#39;</span><span class=p>;</span></span></span></code></pre></div><p>As suggested before, this is just scraping the surface of relational databases. You&rsquo;ll definitely want to spend more time studying them, as they remain the most common form of persistent storage used on the web and in other industries as well.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=sql-injection>SQL Injection</h1><p>Along with the use of relational databases and SQL comes one very important attack to be aware of - SQL injection. This attack takes advantage of the way many developers write SQL queries within their programs. Consider the simple relational database we laid out earlier. Let&rsquo;s assume our web application lets us search for people by their last names. To find Mary Cotts, we would then need a SQL query like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>people</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=k>last</span><span class=o>=</span><span class=s1>&#39;Cotts&#39;</span><span class=p>;</span></span></span></code></pre></div><p>Since we want our <em>users</em> to be able to specify who to look for, we&rsquo;d probably give them a search form in our HTML, something like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>label</span> <span class=na>for</span><span class=o>=</span><span class=s>&#34;last&#34;</span><span class=p>&gt;</span>Last Name:<span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;last&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;Search&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span></span></span></code></pre></div><p>And in our code, extract the <code>name</code> value from the query string and use it to construct the SQL query using string concatenation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>querystring</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;querystring&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>url</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=s2>&#34;http://localhost&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>qs</span> <span class=o>=</span> <span class=nx>querystring</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>url</span><span class=p>.</span><span class=nx>search</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>qs</span><span class=p>.</span><span class=nx>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>query</span> <span class=o>=</span> <span class=sb>`SELECT * FROM people WHERE last=&#39;</span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb>&#39;;`</span><span class=p>;</span></span></span></code></pre></div><p>The problem with this approach is a savvy adversary could submit a &ldquo;name&rdquo; that completes the SQL command and begins a new one, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>bob&#39;; UPDATE users SET admin=true WHERE username=&#39;saavyhacker</span></span></code></pre></div><p>Our naive concatenation approach then creates <em>two</em> SQL commands:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>people</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=k>last</span><span class=o>=</span><span class=s1>&#39;bob&#39;</span><span class=p>;</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=k>admin</span><span class=o>=</span><span class=k>true</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>username</span><span class=o>=</span><span class=s1>&#39;saavyhacker&#39;</span><span class=p>;</span></span></span></code></pre></div><p>When we run this query, our savvy hacker just made themselves an admin on our site (assuming our database has a users table with an admin column we use to determine their role)!</p><p>This is just the tip of the iceberg for SQL injection attacks - there are many, many variations on the theme.</p><h2 id=preventing-sql-injection>Preventing SQL Injection</h2><p>Every database driver provides the ability to build parameterized queries, i.e. a preformatted query that has &ldquo;slots&rdquo; where you assign values to. The exact mechanism to use these depends on the driver you are using to connect to the database. For example, if we were using the <a href=/cis526/07-persistent-storage/05-sql-injection/>node-sqlite3</a> driver to connect our Node application to a SQLite database, we would use:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>querystring</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;querystring&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>url</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span> <span class=s2>&#34;http://localhost&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>qs</span> <span class=o>=</span> <span class=nx>querystring</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>url</span><span class=p>.</span><span class=nx>search</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>qs</span><span class=p>.</span><span class=nx>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>query</span> <span class=o>=</span> <span class=sb>`SELECT * FROM people WHERE last=?;`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// assuming a variable db is declared 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>db</span><span class=p>.</span><span class=nx>run</span><span class=p>(</span><span class=nx>query</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>result</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// do something with result...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span></span></span></code></pre></div><p>Because the slot corresponds to a specific column, the database engine converts the supplied argument to that type before applying it In this case, if our canny hacker uses his string, it would be interpreted as the literal last name &ldquo;bob&rsquo;; UPDATE users SET admin=true WHERE username=&lsquo;saavyhacker&rdquo;. Which probably wouldn&rsquo;t exist in our database, because what kind of parent would saddle a child with such a name?</p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p><a href=#R-image-c8bee4e8ca4e429a70696c59fbb62556 class=lightbox-link><img alt="XKCD&rsquo;s Exploits of a Mom" class="border lazy lightbox noshadow figure-image" loading=lazy src=https://imgs.xkcd.com/comics/exploits_of_a_mom.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c8bee4e8ca4e429a70696c59fbb62556><img alt="XKCD&rsquo;s Exploits of a Mom" class="border lazy lightbox noshadow lightbox-image" loading=lazy src=https://imgs.xkcd.com/comics/exploits_of_a_mom.png></a>
<a href=https://xkcd.com/327/ rel=external target=_blank>XKCD&rsquo;s Exploits of a Mom</a></p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=object-relational-mapping>Object-Relational Mapping</h1><p>If you think learning and writing SQL looks challenging, you&rsquo;re not alone. Early full-stack developers did as well. In addition, there was the additional need to convert the responses from the relational database from text into objects the program could use. It shouldn&rsquo;t be surprising that libraries quickly were adopted to manage this process. The most basic of these are <em>drivers</em>, simple programs which manage the connection between the database and the program using it, sending SQL queries to the database and parsing the results into data types native to the language (usually an array of arrays or an array of dictionaries - the outer array for the rows, and the inner array or dictionary for the column values within the row).</p><p>However, the use of drivers was soon supplanted by <a href=https://en.wikipedia.org/wiki/Object-relational_mapping rel=external target=_blank>Object Relational Mapping (ORM)</a>, a software layer that sits between the database and the dynamic web server program. But unlike a driver, ORM libraries provide additional conversion logic. Most will convert function calls to SQL statements and execute them on the server, and all will convert the results of a query into an object in the language of the server.</p><p>Let&rsquo;s look at a few ORMs in practice.</p><h2 id=activerecord>ActiveRecord</h2><p>The <a href=https://guides.rubyonrails.org/active_record_basics.html rel=external target=_blank>ActiveRecord</a> ORM is part of the <a href=https://guides.rubyonrails.org/ rel=external target=_blank>Ruby on Rails</a> framework. It takes advantage of the Ruby programming language&rsquo;s dynamic nature to vastly simplify the code a developer must write to use a database. If we use our previous example of the database containing <em>persons</em>, <em>addresses</em>, and <em>jobs</em> tables, we would write classes to represent each table that inherit from the <code>ActiveRecord</code> base class:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># persons.rb</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Person</span> <span class=o>&lt;</span> <span class=no>ApplicationRecord</span> 
</span></span><span class=line><span class=cl>  <span class=n>has_many</span> <span class=ss>:addresses</span>
</span></span><span class=line><span class=cl>  <span class=n>has_and_belongs_to_many</span> <span class=ss>:jobs</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># addresses.rb </span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Address</span> <span class=o>&lt;</span> <span class=no>ApplicationRecord</span> 
</span></span><span class=line><span class=cl>  <span class=n>belongs_to</span> <span class=ss>:person</span> 
</span></span><span class=line><span class=cl><span class=k>end</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># jobs.rb </span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Job</span> <span class=o>&lt;</span> <span class=no>ApplicationRecord</span> 
</span></span><span class=line><span class=cl>    <span class=n>has_and_belongs_to</span> <span class=ss>:person</span>
</span></span><span class=line><span class=cl><span class=k>end</span></span></span></code></pre></div><p>Then, to retrieve all people we would use a query method of the <code>Job</code> class::</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>allPeople</span> <span class=o>=</span> <span class=no>Person</span><span class=o>.</span><span class=n>all</span><span class=p>()</span></span></span></code></pre></div><p>Or to retrieve all doctors, we would use a query method of the <code>Job</code> class:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>allDoctors</span> <span class=o>=</span> <span class=no>Person</span><span class=o>.</span><span class=n>includes</span><span class=p>(</span><span class=ss>:jobs</span><span class=p>)</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=ss>jobs</span><span class=p>:</span> <span class=p>{</span><span class=nb>name</span><span class=p>:</span> <span class=s2>&#34;Doctor&#34;</span><span class=p>})</span></span></span></code></pre></div><p>While we haven&rsquo;t been working in the Ruby language, I show this to help you understand just how far from SQL some ORMs go. For a Ruby programmer, this is far more comfortable syntax than SQL, much like LINQ&rsquo;s method syntax is often more comfortable to C# programmers.</p><p>That said, there are always some queries - especially when we&rsquo;re trying to squeeze out the most efficiency possible or working with a convoluted database - that are beyond the simple conversion abilities of an ORM to manage. So most ORMs offer a way to run a SQL query directly on the database as well.</p><p>Finally, you should understand that any ORM that provides a functional interface for constructing SQL queries is effectively a domain-specific language that duplicates the functionality of SQL. The SQL generated by these libraries can be far less efficient than a hand-written SQL query written by a knowledgeable programmer. While it can be more comfortable to program in, it may be more valuable to spend the effort developing a solid understanding of SQL and how relational databases work.</p><h2 id=entity-framework>Entity Framework</h2><p>The .NET platform has its own ORM similar to ActiveRecord, the <a href=https://docs.microsoft.com/en-us/ef/ rel=external target=_blank>Entity Framework</a>. Like ActiveRecord, you can create the entire database by defining model objects, and then generating migration scripts that will create the database to match (this is called <em>code first migrations</em> in entity framework lingo). As with ActiveRecord, you must define the relationships between tables. To set up the objects (and tables) we saw in the ActiveRecord example, we would write:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>Person</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=n>ID</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>LastName</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>FirstName</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>Address</span> <span class=n>Address</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>ICollection</span><span class=p>&lt;</span><span class=n>Job</span><span class=p>&gt;</span> <span class=n>Jobs</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>Address</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=n>ID</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>Line1</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>Line2</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>City</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>State</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=n>Zip</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>ICollection</span><span class=p>&lt;</span><span class=n>People</span><span class=p>&gt;</span> <span class=n>People</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>Job</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>int</span> <span class=n>ID</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>Name</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=kt>string</span> <span class=n>ICollection</span><span class=p>&lt;</span><span class=n>Person</span><span class=p>&gt;</span> <span class=n>People</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Note that this is a lot more verbose; the Entity Framework approach doesn&rsquo;t rely on the database telling it what the available, columns are, rather the model classes are used to determine what the database should be. We also have to set up the relationships, which are done using a class that extends <a href="https://docs.microsoft.com/en-us/dotnet/api/system.data.entity.dbcontext?view=entity-framework-6.2.0" rel=external target=_blank><code>DbContext</code></a>, i.e.:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>ExampleContext</span> <span class=p>:</span> <span class=n>DbContext</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>DbSet</span><span class=p>&lt;</span><span class=n>Person</span><span class=p>&gt;</span> <span class=n>Persons</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>DbSet</span><span class=p>&lt;</span><span class=n>Address</span><span class=p>&gt;</span> <span class=n>Addresses</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>public</span> <span class=n>DbSet</span><span class=p>&lt;</span><span class=n>Job</span><span class=p>&gt;</span> <span class=n>Jobs</span> <span class=p>{</span><span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>protected</span> <span class=kd>override</span> <span class=k>void</span> <span class=n>OnModelCreating</span><span class=p>(</span><span class=n>ModelBuilder</span> <span class=n>modelBuilder</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>modelBuilder</span><span class=p>.</span><span class=n>Entity</span><span class=p>&lt;</span><span class=n>Person</span><span class=p>&gt;().</span><span class=n>ToTable</span><span class=p>(</span><span class=s>&#34;People&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>modelBuilder</span><span class=p>.</span><span class=n>Entity</span><span class=p>&lt;</span><span class=n>Address</span><span class=p>&gt;().</span><span class=n>ToTable</span><span class=p>(</span><span class=s>&#34;Addresses&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>modelBuilder</span><span class=p>.</span><span class=n>Entity</span><span class=p>&lt;</span><span class=n>Job</span><span class=p>&gt;().</span><span class=n>ToTable</span><span class=p>(</span><span class=s>&#34;Jobs&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>modelBuilder</span><span class=p>.</span><span class=n>Entity</span><span class=p>&lt;</span><span class=n>JobPerson</span><span class=p>&gt;().</span><span class=n>ToTable</span><span class=p>(</span><span class=s>&#34;JobsPersons&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>modelBuilder</span><span class=p>.</span><span class=n>Entity</span><span class=p>&lt;</span><span class=n>Person</span><span class=p>&gt;()</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>HasOne</span><span class=p>(</span><span class=n>a</span> <span class=p>=&gt;</span> <span class=n>a</span><span class=p>.</span><span class=n>Address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>WithMany</span><span class=p>(</span><span class=n>b</span> <span class=p>=&gt;</span> <span class=n>b</span><span class=p>.</span><span class=n>Persons</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>modelBuilder</span><span class=p>.</span><span class=n>Entity</span><span class=p>&lt;</span><span class=n>Person</span><span class=p>&gt;().</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>HasMany</span><span class=p>(</span><span class=n>a</span> <span class=p>=&gt;</span> <span class=n>a</span><span class=p>.</span><span class=n>Jobs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=n>WithMany</span><span class=p>(</span><span class=n>b</span> <span class=p>=&gt;</span> <span class=n>b</span><span class=p>.</span><span class=n>Persons</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Note the use of the <code>.HasOne()</code> and <code>.HasMany()</code> methods to set up the relationships between the tables. With this established, we can run queries using an instance of the <code>ExampleContext</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kt>var</span> <span class=n>context</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ExampleContext</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get all people</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>allPeople</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>Person</span><span class=p>.</span><span class=n>All</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Get all doctors</span>
</span></span><span class=line><span class=cl><span class=kt>var</span> <span class=n>allDoctors</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>Person</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>Include</span><span class=p>(</span><span class=n>p</span> <span class=p>=&gt;</span> <span class=n>p</span><span class=p>.</span><span class=n>Jobs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>Where</span><span class=p>(</span><span class=n>p</span> <span class=p>=&gt;</span> <span class=n>p</span><span class=p>.</span><span class=n>Jobs</span><span class=p>.</span><span class=n>Includes</span><span class=p>(</span><span class=n>j</span> <span class=p>=&gt;</span> <span class=n>j</span><span class=p>.</span><span class=n>Name</span> <span class=p>==</span> <span class=s>&#34;Doctor&#34;</span><span class=p>));</span></span></span></code></pre></div><h2 id=massive>Massive</h2><p>For Node applications, I&rsquo;ve really come to prefer <a href=https://massivejs.org/ rel=external target=_blank>MassiveJS</a>, an ORM for the Postgres relational database. Like other ORMs, it converts query results into a JavaScript object or array of objects, with the column names as keys and values as values, converted to the appropriate type.</p><p>It does provide a slew of functions for generating queries programmatically, like other ORMs. But it also allows you to specify a folder in your project where you can place SQL files that are automatically converted to JavaScript functions that correspond to parameterized queries in the sql files. For example, to do our &ldquo;All doctors&rdquo; query, we would write a file <em>scripts/allDoctors.sql</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>persons</span><span class=w> </span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>jobs_persons</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>persons</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jobs_persons</span><span class=p>.</span><span class=n>person_id</span><span class=w> </span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>jobs</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>jobs</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jobs_persons</span><span class=p>.</span><span class=n>job</span><span class=p>.</span><span class=n>id</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>jobs</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&#34;Doctor&#34;</span><span class=p>;</span></span></span></code></pre></div><p>While this may seem less convenient than the ActiveRecord or Entity Framework approaches, it is immediately clear to a seasoned SQL programmer what the tables involved are and how they are related. Moreover, a good SQL programmer can often write a more efficient query than an ORM library can generate.</p><footer class=footline></footer></article></section></div></main><div class=git-footer><p class=theme-version-footer>6.0.0</p><p>Last modified by:
<i class='fas fa-user'></i> Russell Feldhausen
<i class='fas fa-calendar'></i> <a href=https://github.com/ksu-cs-textbooks/cis526/commit/41163dc548a00400a9f1d4962b4227b9a8ee4d20>Aug 10, 2023</a></p></div></div><script src=/cis526/js/clipboard.min.js?1741019922 defer></script><script src=/cis526/js/perfect-scrollbar.min.js?1741019922 defer></script><script src=/cis526/js/theme.js?1741019922 defer></script></body></html>